<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=feed.cnblogs.com%2Fblog%2Fsitehome%2Frss&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://feed.cnblogs.com/blog/sitehome/rss" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>博客园_首页</title>
<link></link>
<description>代码改变世界</description>
<item>
<title>并发思考-actor和thread那个好点？ - 舆</title>
<link>http://www.cnblogs.com/gnool/p/8414673.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/gnool/p/8414673.html</guid>
<description>&lt;p&gt;&lt;strong&gt;&lt;span&gt;实验课题：&lt;/span&gt;&lt;/strong&gt;测试actor和thread那个好？&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;实验方法：&lt;/span&gt;&lt;/strong&gt;利用数据库连接池创建连接，交由线程去工作，在回收，看看程序运行状况。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;实验步骤：&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;1.创建数据连接工具类：&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;38&quot;&gt;
&lt;pre class=&quot;brush:scala;gutter:true;&quot;&gt;
import java.sql.{Connection, DriverManager}
import java.util.concurrent.LinkedBlockingQueue

import com.scala.spark.commen.util.StreamingConfigure


object DBUtil{
  private val dbConnectionPool = new LinkedBlockingQueue[Connection]()
  private var current_num = 0 //当前连接数


  private def before(){
    if (current_num &amp;gt; StreamingConfigure.executor_max_mysql_connection.toInt &amp;amp;&amp;amp; dbConnectionPool.isEmpty()) {
      print(&quot;&quot;&quot;
              |☆☆☆■■■■■■☆☆☆☆☆☆☆■■■■■■■
            &quot;&quot;&quot;.stripMargin)
      Thread.sleep(2000)
      before()
    }else{
      Class.forName(StreamingConfigure.driver)
    }
  }

  private def initConn(): Connection = {
    val conn = DriverManager.getConnection(StreamingConfigure.url, StreamingConfigure.username, StreamingConfigure.password)
    conn
  }

  private def initConnectionPool(): LinkedBlockingQueue[Connection] = {
    AnyRef.synchronized({
      if (dbConnectionPool.isEmpty()) {
        before()
        for (i &amp;lt;- 1 to StreamingConfigure.executor_num_mysql_connection.toInt) {
          dbConnectionPool.put(initConn)
          current_num += 1
        }
      }
      dbConnectionPool
    })
  }

  def getInstance():Connection={
    var conn = dbConnectionPool.poll()
    if(conn==null){
      initConnectionPool()
      conn = dbConnectionPool.poll()
    }
    return conn
  }

  def releaseCon(con:Connection){
    dbConnectionPool.put(con)
  }

  def get_current_num()={
    current_num
  }
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt; 2.创建thread访问数据库连接池&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;36&quot;&gt;
&lt;pre readability=&quot;7&quot;&gt;
object DBUtilTest extends App{&lt;br/&gt;for (i &amp;lt;- 1 to 10000){&lt;br/&gt;ConnThread(i).start()&lt;br/&gt;}&lt;br/&gt;}&lt;p&gt;case  class ConnThread(name:Int) extends Thread{&lt;br/&gt;override def run(): Unit = {&lt;br/&gt;val conn = DBUtil.getInstance()&lt;br/&gt;DBUtil.releaseCon(conn)&lt;br/&gt;println(s&quot;$conn conn is $name，current_num is ${DBUtil.get_current_num()}&quot;)&lt;br/&gt;}&lt;br/&gt;}
&lt;/p&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt; 3.创建Actor访问数据连接池&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;36&quot;&gt;
&lt;pre class=&quot;brush:scala;gutter:true;&quot;&gt;
class DBActor extends Actor{
  var count  = 0
  override def receive: Receive = {
    case &quot;create&quot; =&amp;gt;
      val conn = DBUtil.getInstance()
      count += 1
      println(s&quot;$conn conn is $count&quot;)
      DBUtil.releaseCon(conn)
  }
}

object AkkaClient extends App{

  val system = ActorSystem(&quot;DBUtil&quot;)

  val dBActor = system.actorOf(Props[DBActor],&quot;dBActor&quot;)

  for (i &amp;lt;- 1 to 10000) dBActor ! &quot;create&quot;

  println(&quot;&amp;gt;&amp;gt;&amp;gt; Press ENTER to exit &amp;lt;&amp;lt;&amp;lt;&quot;)
  try StdIn.readLine()
  finally system.terminate()
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;实验结果&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;：运行两种访问，查看结果。&lt;/p&gt;
&lt;p&gt;thread&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;91&quot;&gt;
&lt;p&gt;&lt;br/&gt;objc[10258]: Class JavaLaunchHelper is implemented in both /Library/Java/JavaVirtualMachines/jdk1.8.0_121.jdk/Contents/Home/bin/java (0x10782a4c0) and /Library/Java/JavaVirtualMachines/jdk1.8.0_121.jdk/Contents/Home/jre/lib/libinstrument.dylib (0x1079044e0). One of the two will be used. Which one is undefined.&lt;br/&gt;Sun Feb 04 22:32:06 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2291，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2280，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2295，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2293，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2299，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2287，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2286，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2298，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2292，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2289，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2300，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2301，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2302，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2290，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2297，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2303，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2283，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2304，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2296，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2281，current_num is 1&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2288，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2284，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2305，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2294，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2282，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2285，current_num is 1&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2306，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2307，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2308，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2309，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2310，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2311，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2312，current_num is 2&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2313，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2314，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2315，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2316，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2317，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2318，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2319，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2320，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2321，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2322，current_num is 3&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2323，current_num is 3&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2324，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2325，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2326，current_num is 4&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2327，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2328，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2329，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2330，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2331，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2332，current_num is 4&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2333，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2334，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2335，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2336，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2337，current_num is 5&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2338，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2339，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2340，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2341，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2342，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2343，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2344，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2345，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2346，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2347，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2348，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2349，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2350，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2351，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2352，current_num is 5&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2353，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2354，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2355，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2356，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2357，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2358，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2359，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2360，current_num is 6&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2361，current_num is 6&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2362，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2363，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2364，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2365，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2366，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2367，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2368，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2369，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2370，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2371，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2372，current_num is 7&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2373，current_num is 8&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2374，current_num is 8&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2375，current_num is 8&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2376，current_num is 8&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2377，current_num is 8&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2378，current_num is 8&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2379，current_num is 8&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2380，current_num is 8&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2381，current_num is 8&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2382，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2383，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2385，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2384，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2386，current_num is 9&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2388，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2387，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2389，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2390，current_num is 9&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2391，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 1，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2279，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2392，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2278，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2277，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2276，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2275，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2393，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2274，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2273，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2272，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2271，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2394，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2269，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2270，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2395，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2267，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2266，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2268，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2396，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2265，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2264，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2397，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2263，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2262，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2261，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2398，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2260，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2399，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2259，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2258，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2256，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2257，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2255，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2400，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2254，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2401，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2253，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2252，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 21，current_num is 10&lt;br/&gt;Exception in thread &quot;Thread-2243&quot; java.lang.NullPointerException&lt;br/&gt;at java.util.concurrent.LinkedBlockingQueue.put(LinkedBlockingQueue.java:332)&lt;br/&gt;at com.scala.spark.commen.pool.DBUtil$.releaseCon(DBUtil.scala:54)&lt;br/&gt;at com.scala.spark.commen.pool.ConnThread.run(DBUtilTest.scala:15)&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2251，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2245，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2246，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2247，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2404，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2249，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2248，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2250，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2403，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2402，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2419，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2420，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2421，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2422，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2423，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2424，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2425，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2426，current_num is 11&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2427，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2428，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2429，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2430，current_num is 11&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2431，current_num is 12&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2432，current_num is 12&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2433，current_num is 12&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2434，current_num is 12&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2418，current_num is 12&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2435，current_num is 12&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2436，current_num is 12&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2437，current_num is 13&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2438，current_num is 13&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2439，current_num is 13&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2440，current_num is 13&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2441，current_num is 13&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2442，current_num is 13&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2443，current_num is 13&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2444，current_num is 14&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2445，current_num is 14&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2446，current_num is 14&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2447，current_num is 14&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2448，current_num is 14&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2449，current_num is 14&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2450，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2451，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2452，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2453，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2454，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2455，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2456，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2457，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2458，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2459，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2460，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2461，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2462，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2463，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2464，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2465，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2466，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2467，current_num is 15&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2468，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2469，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2470，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2471，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2472，current_num is 15&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2473，current_num is 16&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2474，current_num is 16&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2475，current_num is 16&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2476，current_num is 16&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2477，current_num is 16&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2478，current_num is 16&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2479，current_num is 16&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2480，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2481，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2482，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2483，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2484，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2485，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2486，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2487，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 2488，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2489，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2490，current_num is 17&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2491，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2492，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2493，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2494，current_num is 17&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2495，current_num is 18&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 2496，current_num is 18&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2497，current_num is 18&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2498，current_num is 18&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2499，current_num is 18&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2500，current_num is 18&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2501，current_num is 19&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2502，current_num is 19&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2503，current_num is 19&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2504，current_num is 19&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 2505，current_num is 19&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2506，current_num is 19&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2405，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2243，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2242，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2241，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2240，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 2239，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2238，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2236，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 2237，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2235，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2234，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2233，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@526b99ab conn is 2232，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2229，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2231，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2230，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2507，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2227，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5a27184d conn is 2226，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 2228，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2225，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2224，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2223，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2222，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2219，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2221，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 2218，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 2220，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2217，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2216，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2508，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2215，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@526b99ab conn is 2214，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2213，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2212，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2211，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2210，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 2209，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2191，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2192，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2194，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@526b99ab conn is 2195，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2193，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2197，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2509，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2198，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2196，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 2199，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2200，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 2201，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2202，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2204，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2205，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2206，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5a27184d conn is 2208，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2207，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2203，current_num is 20&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 2528，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2527，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2529，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2530，current_num is 20&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2531，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@526b99ab conn is 2532，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2534，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2533，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2535，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2536，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 2537，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2538，current_num is 21&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 2539，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2540，current_num is 21&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2541，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2542，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2543，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2544，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5a27184d conn is 2545，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2546，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 2547，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2548，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2549，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2550，current_num is 22&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@613be7fa conn is 2551，current_num is 23&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2552，current_num is 23&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@526b99ab conn is 2553，current_num is 23&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2554，current_num is 23&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2555，current_num is 23&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2556，current_num is 24&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2557，current_num is 24&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 2558，current_num is 24&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2559，current_num is 24&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 2560，current_num is 24&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 2561，current_num is 24&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7ce6c879 conn is 2562，current_num is 25&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 2563，current_num is 25&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 2564，current_num is 25&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 2565，current_num is 25&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 2566，current_num is 25&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5a27184d conn is 2567，current_num is 25&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 2568，current_num is 26&lt;br/&gt;Sun Feb 04 22:32:07 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 2569，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 2570，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 2571，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 2572，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@23034a33 conn is 2573，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@613be7fa conn is 2574，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 2575，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@526b99ab conn is 2576，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 2577，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 2578，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6b6acc14 conn is 2579，current_num is 26&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 2580，current_num is 27&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 2581，current_num is 27&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 2582，current_num is 27&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 2583，current_num is 27&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 2584，current_num is 27&lt;br/&gt;............&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@45208681 conn is 9894，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@23034a33 conn is 9895，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@77ead0db conn is 9896，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2a8b9fed conn is 9897，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27114133 conn is 9898，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@68f70c3e conn is 9899，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@29f3309a conn is 9900，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@531759a9 conn is 9901，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7ce6c879 conn is 9902，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5ad0659d conn is 9903，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@e62bd9b conn is 9904，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 9905，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 9906，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@42126bd2 conn is 9907，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 9908，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1977e2 conn is 9909，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@73de9c32 conn is 9910，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5327a66d conn is 9911，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 9912，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 9913，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5840919c conn is 9914，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@13b6f892 conn is 9915，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@48e38207 conn is 9916，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6d95f874 conn is 9917，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 9918，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@322b021f conn is 9919，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@76d84c1 conn is 9920，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7079a300 conn is 9921，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@28cef164 conn is 9922，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@36039ec conn is 9923，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4b92531e conn is 9924，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@3cb85f84 conn is 9925，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2c3a40e6 conn is 9926，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@18540478 conn is 9927，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1b106c29 conn is 9928，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58d60bd6 conn is 9929，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2f78bc01 conn is 9930，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58f46dea conn is 9931，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@3ee71dd0 conn is 9932，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4d7d0ba2 conn is 9933，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@662d24b7 conn is 9934，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27d1933f conn is 9935，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2df0647c conn is 9936，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@336f8f02 conn is 9937，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@673bebd0 conn is 9938，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@43b65c0c conn is 9939，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7f2fecf3 conn is 9940，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@22532f08 conn is 9941，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12266960 conn is 9942，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@45621f3c conn is 9943，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1c8126de conn is 9944，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@613be7fa conn is 9945，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2cf9c34b conn is 9946，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2ebb6f9e conn is 9947，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@259e4407 conn is 9948，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5a27184d conn is 9949，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2762a670 conn is 9950，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6d982ab9 conn is 9951，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@12303cee conn is 9952，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@70ce732e conn is 9953，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1bcda716 conn is 9954，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@3e66caa3 conn is 9955，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c4c85bd conn is 9956，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f1e34bd conn is 9957，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@172149a8 conn is 9958，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@48b0856b conn is 9959，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@51d7f778 conn is 9960，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@738af3c0 conn is 9961，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6b6acc14 conn is 9962，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@8b52a5e conn is 9963，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1dcfdbea conn is 9964，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5dc890c5 conn is 9965，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4797fbe9 conn is 9966，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@145449bd conn is 9967，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@11cbcb1c conn is 9968，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@526b99ab conn is 9969，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@e84f4e8 conn is 9970，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@35a9df35 conn is 9971，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5ef1451f conn is 9972，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5e5c34ce conn is 9973，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@45208681 conn is 9974，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@23034a33 conn is 9975，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@77ead0db conn is 9976，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2a8b9fed conn is 9977，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@27114133 conn is 9978，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@68f70c3e conn is 9979，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@29f3309a conn is 9980，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@531759a9 conn is 9981，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7ce6c879 conn is 9982，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5ad0659d conn is 9983，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@e62bd9b conn is 9984，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7af6a47 conn is 9985，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@4c1a4732 conn is 9986，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@42126bd2 conn is 9987，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@38a4ed22 conn is 9988，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1977e2 conn is 9989，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@73de9c32 conn is 9990，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5327a66d conn is 9991，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1edcf564 conn is 9992，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6c8a3ac2 conn is 9993，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5840919c conn is 9994，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@13b6f892 conn is 9995，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@48e38207 conn is 9996，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6d95f874 conn is 9997，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@58010e0b conn is 9998，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@322b021f conn is 9999，current_num is 80&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@76d84c1 conn is 10000，current_num is 80&lt;/p&gt;
&lt;p&gt;Process finished with exit code 0&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt; actor运行结果：&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;60&quot;&gt;
&lt;p&gt;&lt;br/&gt;&amp;gt;&amp;gt;&amp;gt; Press ENTER to exit &amp;lt;&amp;lt;&amp;lt;&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;Sun Feb 04 22:36:48 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@75d54ea4 conn is 1，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@26861a90 conn is 2，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@594629ee conn is 3，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d4fcba6 conn is 4，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2300ec5 conn is 5，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1474d689 conn is 6，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1594b0 conn is 7，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f24626f conn is 8，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d601968 conn is 9，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6f925cd3 conn is 10，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@75d54ea4 conn is 11，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@26861a90 conn is 12，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@594629ee conn is 13，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d4fcba6 conn is 14，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2300ec5 conn is 15，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1474d689 conn is 16，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1594b0 conn is 17，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f24626f conn is 18，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d601968 conn is 19，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6f925cd3 conn is 20，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@75d54ea4 conn is 21，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@26861a90 conn is 22，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@594629ee conn is 23，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d4fcba6 conn is 24，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2300ec5 conn is 25，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1474d689 conn is 26，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1594b0 conn is 27，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f24626f conn is 28，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d601968 conn is 29，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6f925cd3 conn is 30，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@75d54ea4 conn is 31，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@26861a90 conn is 32，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@594629ee conn is 33，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d4fcba6 conn is 34，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2300ec5 conn is 35，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1474d689 conn is 36，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1594b0 conn is 37，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f24626f conn is 38，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d601968 conn is 39，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6f925cd3 conn is 40，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@75d54ea4 conn is 41，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@26861a90 conn is 42，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@594629ee conn is 43，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d4fcba6 conn is 44，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2300ec5 conn is 45，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1474d689 conn is 46，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1594b0 conn is 47，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f24626f conn is 48，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d601968 conn is 49，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6f925cd3 conn is 50，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@75d54ea4 conn is 51，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@26861a90 conn is 52，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@594629ee conn is 53，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d4fcba6 conn is 54，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2300ec5 conn is 55，current_num is 10&lt;/p&gt;
&lt;p&gt;......&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6f925cd3 conn is 9990，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@75d54ea4 conn is 9991，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@26861a90 conn is 9992，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@594629ee conn is 9993，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d4fcba6 conn is 9994，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@2300ec5 conn is 9995，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@1474d689 conn is 9996，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@7c1594b0 conn is 9997，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5f24626f conn is 9998，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@5d601968 conn is 9999，current_num is 10&lt;br/&gt;com.mysql.jdbc.JDBC4Connection@6f925cd3 conn is 10000，current_num is 10&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Thread2300～2400运行效果：&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;55&quot;&gt;
&lt;pre class=&quot;brush:scala;gutter:true;&quot;&gt;
Sun Feb 04 22:50:27 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2284，current_num is 1
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2277，current_num is 1
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2290，current_num is 2
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2287，current_num is 2
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2283，current_num is 1
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2279，current_num is 1
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2289，current_num is 2
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2280，current_num is 1
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2278，current_num is 1
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2276，current_num is 1
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2282，current_num is 1
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2288，current_num is 2
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2285，current_num is 2
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2291，current_num is 3
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2286，current_num is 2
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2293，current_num is 3
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2294，current_num is 3
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2292，current_num is 3
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2295，current_num is 3
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2296，current_num is 3
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2297，current_num is 3
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2298，current_num is 3
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2299，current_num is 3
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2300，current_num is 3
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2301，current_num is 3
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2302，current_num is 3
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2303，current_num is 4
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2304，current_num is 4
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2305，current_num is 4
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2306，current_num is 4
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2307，current_num is 4
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2308，current_num is 4
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2309，current_num is 4
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2310，current_num is 4
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2311，current_num is 4
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2312，current_num is 5
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2313，current_num is 5
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2314，current_num is 5
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2315，current_num is 5
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2316，current_num is 5
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2317，current_num is 5
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2318，current_num is 5
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2319，current_num is 5
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2320，current_num is 5
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2321，current_num is 5
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2322，current_num is 5
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2323，current_num is 5
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2324，current_num is 5
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2325，current_num is 5
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2326，current_num is 5
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2327，current_num is 5
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2328，current_num is 5
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2329，current_num is 5
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2330，current_num is 5
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2331，current_num is 5
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2332，current_num is 5
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2333，current_num is 5
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2334，current_num is 5
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2335，current_num is 6
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2336，current_num is 6
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2337，current_num is 6
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2338，current_num is 6
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2339，current_num is 6
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 2340，current_num is 6
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2341，current_num is 6
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2342，current_num is 6
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2343，current_num is 7
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2344，current_num is 7
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2345，current_num is 7
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 2346，current_num is 7
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2347，current_num is 7
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2348，current_num is 7
com.mysql.jdbc.JDBC4Connection@7acc608 conn is 2349，current_num is 7
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2350，current_num is 7
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2351，current_num is 8
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2352，current_num is 8
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 2353，current_num is 8
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2354，current_num is 8
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2355，current_num is 8
com.mysql.jdbc.JDBC4Connection@7acc608 conn is 2356，current_num is 8
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2357，current_num is 8
com.mysql.jdbc.JDBC4Connection@803a18f conn is 2358，current_num is 8
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2359，current_num is 9
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2360，current_num is 9
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 2361，current_num is 9
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2362，current_num is 9
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2363，current_num is 9
com.mysql.jdbc.JDBC4Connection@7acc608 conn is 2364，current_num is 9
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2365，current_num is 9
com.mysql.jdbc.JDBC4Connection@803a18f conn is 2366，current_num is 9
Sun Feb 04 22:50:28 CST 2018 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
com.mysql.jdbc.JDBC4Connection@5afe8b7d conn is 2367，current_num is 9
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2369，current_num is 10
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 1，current_num is 10
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2281，current_num is 10
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2368，current_num is 9
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2274，current_num is 10
com.mysql.jdbc.JDBC4Connection@803a18f conn is 2273，current_num is 10
com.mysql.jdbc.JDBC4Connection@5afe8b7d conn is 2272，current_num is 10
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2269，current_num is 10
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 2270，current_num is 10
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2271，current_num is 10
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2268，current_num is 10
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2371，current_num is 10
com.mysql.jdbc.JDBC4Connection@7acc608 conn is 2373，current_num is 10
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2370，current_num is 10
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2265，current_num is 10
com.mysql.jdbc.JDBC4Connection@5780190e conn is 2372，current_num is 10
com.mysql.jdbc.JDBC4Connection@803a18f conn is 2267，current_num is 10
com.mysql.jdbc.JDBC4Connection@5afe8b7d conn is 2374，current_num is 10
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2266，current_num is 10
com.mysql.jdbc.JDBC4Connection@5780190e conn is 2264，current_num is 10
com.mysql.jdbc.JDBC4Connection@7acc608 conn is 2275，current_num is 10
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2263，current_num is 10
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 2261，current_num is 10
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2375，current_num is 10
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2262，current_num is 10
com.mysql.jdbc.JDBC4Connection@7acc608 conn is 2260，current_num is 10
com.mysql.jdbc.JDBC4Connection@6c7e8e89 conn is 2259，current_num is 10
com.mysql.jdbc.JDBC4Connection@5afe8b7d conn is 2257，current_num is 10
com.mysql.jdbc.JDBC4Connection@5780190e conn is 2256，current_num is 10
com.mysql.jdbc.JDBC4Connection@803a18f conn is 2258，current_num is 10
com.mysql.jdbc.JDBC4Connection@70e0ec40 conn is 2376，current_num is 10
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 2255，current_num is 10
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 2254，current_num is 10
com.mysql.jdbc.JDBC4Connection@7984dcf6 conn is 2253，current_num is 10
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 2377，current_num is 10
com.mysql.jdbc.JDBC4Connection@7acc608 conn is 2378，current_num is 10
....
com.mysql.jdbc.JDBC4Connection@5afe8b7d conn is 144，current_num is 20
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 145，current_num is 20
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 146，current_num is 20
com.mysql.jdbc.JDBC4Connection@78cc3e0f conn is 147，current_num is 20
com.mysql.jdbc.JDBC4Connection@803a18f conn is 148，current_num is 20
com.mysql.jdbc.JDBC4Connection@8a92dd0 conn is 149，current_num is 20
com.mysql.jdbc.JDBC4Connection@4b2bdb5e conn is 152，current_num is 20
com.mysql.jdbc.JDBC4Connection@55f825fa conn is 154，current_num is 20
com.mysql.jdbc.JDBC4Connection@207e87e conn is 155，current_num is 20
com.mysql.jdbc.JDBC4Connection@5521b93a conn is 159，current_num is 20
com.mysql.jdbc.JDBC4Connection@2ec303b conn is 165，current_num is 20
com.mysql.jdbc.JDBC4Connection@6d8646b5 conn is 166，current_num is 20
com.mysql.jdbc.JDBC4Connection@78cc3e0f conn is 167，current_num is 20

Process finished with exit code 0
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt; actor在40000000级上数据运行情况&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;35&quot;&gt;
&lt;pre class=&quot;brush:scala;gutter:true;&quot;&gt;
com.mysql.jdbc.JDBC4Connection@2d02c2a4 conn is 39999985，current_num is 10
com.mysql.jdbc.JDBC4Connection@792b0c3a conn is 39999986，current_num is 10
com.mysql.jdbc.JDBC4Connection@9444bb7 conn is 39999987，current_num is 10
com.mysql.jdbc.JDBC4Connection@7cc94733 conn is 39999988，current_num is 10
com.mysql.jdbc.JDBC4Connection@47e5adec conn is 39999989，current_num is 10
com.mysql.jdbc.JDBC4Connection@660e23f6 conn is 39999990，current_num is 10
com.mysql.jdbc.JDBC4Connection@557601c1 conn is 39999991，current_num is 10
com.mysql.jdbc.JDBC4Connection@3f4d7608 conn is 39999992，current_num is 10
com.mysql.jdbc.JDBC4Connection@5564bf6f conn is 39999993，current_num is 10
com.mysql.jdbc.JDBC4Connection@4096bdd9 conn is 39999994，current_num is 10
com.mysql.jdbc.JDBC4Connection@2d02c2a4 conn is 39999995，current_num is 10
com.mysql.jdbc.JDBC4Connection@792b0c3a conn is 39999996，current_num is 10
com.mysql.jdbc.JDBC4Connection@9444bb7 conn is 39999997，current_num is 10
com.mysql.jdbc.JDBC4Connection@7cc94733 conn is 39999998，current_num is 10
com.mysql.jdbc.JDBC4Connection@47e5adec conn is 39999999，current_num is 10
com.mysql.jdbc.JDBC4Connection@660e23f6 conn is 40000000，current_num is 10
&lt;/pre&gt;&lt;/div&gt;

&lt;pre&gt;
&lt;span&gt;&lt;strong&gt;&lt;span&gt;实验结论：&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt; 由上面运行效果得出：actor模型几乎运行10000次点用即时结束，thread模型确实慢了好久，整体感觉有一秒，大家可以试着运行感觉一下；当中thread在运行时（为了页面加载没有粘出所有数据太多）&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;线程中不存在连接的查询使用，只是打印对象地址，thread在2300 - 2400 之间就存在当前连接数的增加，即表明在线程调用时，连接不能及时回收，导致了联接的创建。而actor模型在10000级连接数不变，则说明在并发稳定上，actor支持更高的并发和稳定性。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;actor模型在40000000级别连接数依然是10，这说明的不言而喻。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;上面的结论如果有异议的话，可以讨论。&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;

</description>
<pubDate>Sun, 04 Feb 2018 15:31:00 +0000</pubDate>
<dc:creator>舆</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/gnool/p/8414673.html</dc:identifier>
</item>
<item>
<title>NetCloud——一个网易云音乐评论抓取和分析的Python库 - lyrichu</title>
<link>http://www.cnblogs.com/lyrichu/p/8414434.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/lyrichu/p/8414434.html</guid>
<description>&lt;h3 id=&quot;在17的四月份我曾经写了一篇关于网易云音乐爬虫的文章还写了一篇关于评论数据可视化的文章在这大半年的时间里有时会有一些朋友给我发私信询问一些关于代码方面的问题所以我最近抽空干脆将原来的代码整理了一下做成了一个python模块netcloud放在pypi上了目前只是对原来的代码做了一些整理与重构功能还很不完善后续打算抽空继续完善如果有人用的话可能会长期维护下去&quot;&gt;  在17的四月份，我曾经写了一篇关于网易云音乐爬虫的文章，还写了一篇关于评论数据可视化的文章。在这大半年的时间里，有时会有一些朋友给我发私信询问一些关于代码方面的问题。所以我最近抽空干脆将原来的代码整理了一下，做成了一个Python模块&lt;em&gt;NetCloud&lt;/em&gt;放在Pypi上了。目前只是对原来的代码做了一些整理与重构，功能还很不完善，后续打算抽空继续完善，如果有人用的话可能会长期维护下去。&lt;/h3&gt;
&lt;h3 id=&quot;目前只需要使用命令pip-install-netcloud-即可以完成模块的安装支持windows与linux系统以前代码是基于python2的现在支持python3我简单测试了一下python3.6应该也没问题了python2下运行应该也基本没问题但是考虑到编码问题以及python社区即将在2020年不再支持2.x的版本所以强烈建议使用python3.x运行模块代码github的地址是netcloud&quot;&gt;  目前只需要使用命令pip install NetCloud 即可以完成模块的安装，支持Windows与Linux系统，以前代码是基于python2的，现在支持Python3(我简单测试了一下python3.6应该也没问题了),python2下运行应该也基本没问题,但是考虑到编码问题，以及Python社区即将在2020年不再支持2.x的版本，所以强烈建议使用Python3.x运行模块。代码github的地址是&lt;a href=&quot;https://www.github.com/Lyrichu/NetCloud&quot;&gt;Netcloud&lt;/a&gt;&lt;/h3&gt;
&lt;h2 id=&quot;关于实现功能以及一些主要接口的说明&quot;&gt;  关于实现功能以及一些主要接口的说明:&lt;/h2&gt;
&lt;h3 id=&quot;主要实现了&quot;&gt;1.主要实现了:&lt;/h3&gt;
&lt;h4 id=&quot;对于一首歌曲全部评论的抓取保存为csv文件格式&quot;&gt;- 对于一首歌曲全部评论的抓取,保存为csv文件格式&lt;/h4&gt;
&lt;h4 id=&quot;对于一个歌手全部热门评论的抓取存为csv文件&quot;&gt;- 对于一个歌手全部热门评论的抓取，存为csv文件&lt;/h4&gt;
&lt;h4 id=&quot;对于一首歌曲下全部评论用户基本信息的抓取包括用户主页url用户年龄听歌次数动态次数用户所在地区用户动态总数等这些信息也存为csv文件格式&quot;&gt;- 对于一首歌曲下全部评论用户基本信息的抓取，包括:用户主页url,用户年龄,听歌次数,动态次数,用户所在地区,用户动态总数等，这些信息也存为csv文件格式&lt;/h4&gt;
&lt;h4 id=&quot;利用全部评论以及热门评论分词生成词云统计关键词的频率&quot;&gt;- 利用全部评论以及热门评论分词生成词云，统计关键词的频率&lt;/h4&gt;
&lt;h4 id=&quot;利用一首歌曲全部评论用户的信息基于pyecharts可视化包括用户所在地区分布使用geo表示地图用户年龄的分布用户听歌数目的分布用户动态的数目分布歌曲评论数量关于时间的分布等等以前是基于matplotlib来做的但是只能生成静态的图片而pyecharts可以产生基于网页的交互式的显示效果我感觉效果可能会更好一点&quot;&gt;- 利用一首歌曲全部评论用户的信息，基于&lt;strong&gt;pyecharts&lt;/strong&gt;可视化，包括：用户所在地区分布使用geo表示(地图),用户年龄的分布，用户听歌数目的分布，用户动态的数目分布，歌曲评论数量关于时间的分布等等。以前是基于matplotlib来做的，但是只能生成静态的图片，而pyecharts可以产生基于网页的交互式的显示效果，我感觉效果可能会更好一点。&lt;/h4&gt;
&lt;h4 id=&quot;以前抓取是单线程的效率较低现在支持多线程了可以极大地提高抓取效率&quot;&gt;- 以前抓取是单线程的，效率较低，现在支持多线程了，可以极大地提高抓取效率&lt;/h4&gt;
&lt;h3 id=&quot;还需要去完善的todolist&quot;&gt;2.还需要去完善的(Todolist)&lt;/h3&gt;
&lt;h4 id=&quot;如何很好的应对反爬我实验发现在开启多线程的情况下抓取一段时间服务器可能会限制抓取封ip目前应对的措施主要是开启代理ip不过如何找到较高质量的代理ip地址就只能自己去想办法了&quot;&gt;- 如何很好的应对反爬。我实验发现，在开启多线程的情况下，抓取一段时间服务器可能会限制抓取(封ip),目前应对的措施主要是开启代理ip，不过如何找到较高质量的代理ip地址，就只能自己去想办法了&lt;/h4&gt;
&lt;h4 id=&quot;目前还不支持模拟登录网易云音乐查看个人信息听歌记录等不过python里应该已经有其他模块做到了这一点而且这个应该也不是特别难后面有空会加上&quot;&gt;-目前还不支持模拟登录网易云音乐，查看个人信息，听歌记录等，不过Python里应该已经有其他模块做到了这一点，而且这个应该也不是特别难，后面有空会加上。&lt;/h4&gt;
&lt;h4 id=&quot;目前还不支持对于歌单的批量抓取以及获取用户听歌的详细记录后续考虑增加如果有这部分数据可以深挖更多东西比如预测用户听歌风格对用户按听歌洗喜好分类以及做推荐等等&quot;&gt;-目前还不支持对于歌单的批量抓取，以及获取用户听歌的详细记录，后续考虑增加。如果有这部分数据，可以深挖更多东西，比如预测用户听歌风格，对用户按听歌洗喜好分类，以及做推荐等等。&lt;/h4&gt;
&lt;h4 id=&quot;目前的分析仅限于简单的分析统计等等后续考虑加入更深入的nlp分析&quot;&gt;-目前的分析仅限于简单的分析统计等等，后续考虑加入更深入的NLP分析。&lt;/h4&gt;
&lt;h3 id=&quot;安装以及主要的函数接口&quot;&gt;3.安装以及主要的函数接口&lt;/h3&gt;
&lt;h4 id=&quot;安装很简单只需要-pip-install-netcloud因为模块以来于一些第三方库所以在安装这些第三方库的时候可能会出现问题可以参考4的说明&quot;&gt;- 安装很简单，只需要 pip install NetCloud，因为模块以来于一些第三方库，所以在安装这些第三方库的时候可能会出现问题，可以参考4的说明&lt;/h4&gt;
&lt;h4 id=&quot;快速使用一个简单的例子如下&quot;&gt;- 快速使用，一个简单的例子如下：&lt;/h4&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;16&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; NetCloud.NetCloudCrawler &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; NetCloudCrawl
&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; NetCloud.NetCloudAnalyse &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; NetCloudAnalyse

&lt;span class=&quot;cf&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;va&quot;&gt;__name__&lt;/span&gt; &lt;span class=&quot;op&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;'__main__'&lt;/span&gt;:
    song_name &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&quot;敢爱&quot;&lt;/span&gt;
    song_id &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;186888&lt;/span&gt;
    singer_name &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&quot;张国荣&quot;&lt;/span&gt;
    singer_id &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;6457&lt;/span&gt;
    crawler &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; NetCloudCrawl(song_name,song_id,singer_name,singer_id)
    crawler.generate_all_necessary_files(threads&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;10&lt;/span&gt;)
    analyse &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; NetCloudAnalyse(song_name,singer_name,song_id,singer_id)
    analyse.generate_all_analyse_files(threads&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;20&lt;/span&gt;)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;上面的10行左右的代码就完成了对于张国荣的敢爱这首歌的全部评论的抓取张国荣歌曲热门评论的抓取以及歌曲用户基本信息的抓取并生成了相应的词云图片以及一些基本的可视化分析产生的文件结构如下图所示&quot;&gt;3.1 上面的10行左右的代码就完成了对于张国荣的《敢爱》这首歌的全部评论的抓取，张国荣歌曲热门评论的抓取，以及歌曲用户基本信息的抓取，并生成了相应的词云图片，以及一些基本的可视化分析。产生的文件结构如下图所示：&lt;/h4&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/976328/201802/976328-20180204221514326-726635814.jpg&quot;/&gt;&lt;br/&gt;首先生成文件全部都会在songs这个文件夹下，然后对于每一首歌曲会产生以歌手名字命名的文件夹，然后是歌曲名字的文件夹，最后是相应的抓取文件，比如敢爱.csv就是《敢爱》的全部评论文件，敢爱.jpg就是歌曲评论的词云图片,hot_comments.csv是歌手的热门评论文件，最后所有的可视化结果都存放在plots文件夹下，可视化文件为html文件需要在浏览器打开查看可视化结果。&lt;/p&gt;
&lt;h4 id=&quot;模块主要是两个类一个是netcloudcrawl用于数据抓取另一个是-netcloudanalyse用于数据的分析netcloudcrawl-的-generate_all_necessary_files函数会生成必要的全部评论文件热门评论文件支持多线程默认是开启10个线程抓取netcloudanalyse的-generate_all_analyse_files-顾名思义会产生全部的可视化文件首先它会抓取用户的全部信息存入文件然后产生一系列的可视化分析文件html格式最后会产生评论的词云文件基本上调用这两个函数就可以轻松使用netcloud的主要功能了&quot;&gt;3.2 模块主要是两个类，一个是NetCloudCrawl，用于数据抓取；另一个是 NetCloudAnalyse用于数据的分析。NetCloudCrawl 的 generate_all_necessary_files函数会生成必要的全部评论文件，热门评论文件，支持多线程，默认是开启10个线程抓取。NetCloudAnalyse的 generate_all_analyse_files 顾名思义会产生全部的可视化文件，首先它会抓取用户的全部信息存入文件，然后产生一系列的可视化分析文件(html格式)，最后会产生评论的词云文件。基本上调用这两个函数就可以轻松使用NetCloud的主要功能了。&lt;/h4&gt;
&lt;h4 id=&quot;如果你想自定义抓取或者不想使用提供的可视化函数接口也可以使用模块的其他基本函数完成抓取和分析模块的主要函数接口调用格式说明如下&quot;&gt;3.3 如果你想自定义抓取，或者不想使用提供的可视化函数接口，也可以使用模块的其他基本函数完成抓取和分析，模块的主要函数接口调用格式说明如下：&lt;/h4&gt;
&lt;h4 id=&quot;netcloudcrawl类&quot;&gt;&lt;strong&gt;NetCloudCrawl类&lt;/strong&gt;&lt;/h4&gt;
&lt;h4 id=&quot;aes_encrypttextkeyiv-这个函数用于网易云api的解密基本用不到不用管&quot;&gt;- AES_encrypt(text,key,iv) 这个函数用于网易云API的解密，基本用不到，不用管&lt;/h4&gt;
&lt;h4 id=&quot;get_paramspage-获得必要的解密参数&quot;&gt;- get_params(page) 获得必要的解密参数&lt;/h4&gt;


&lt;h4 id=&quot;get_jsonurlparams-encseckey-获取网易api-json文件&quot;&gt;- get_json(url,params, encSecKey) 获取网易API json文件&lt;/h4&gt;




&lt;h4 id=&quot;get_singer_hot_songs_idssinger_url-得到歌手全部热门歌曲id列表singer_url为歌手信息页url&quot;&gt;- get_singer_hot_songs_ids(singer_url) 得到歌手全部热门歌曲id列表,singer_url为歌手信息页url&lt;/h4&gt;

&lt;h4 id=&quot;generate_all_necessary_filesthreads-10-生成全部必要的文件包括歌手的全部热门评论文件以及歌曲的全部评论文件&quot;&gt;- generate_all_necessary_files(threads = 10) 生成全部必要的文件，包括歌手的全部热门评论文件，以及歌曲的全部评论文件&lt;/h4&gt;
&lt;h4 id=&quot;test-开头的均为测试函数请不要调用&quot;&gt;- _test 开头的均为测试函数，请不要调用&lt;/h4&gt;
&lt;h4 id=&quot;netcloudanalyse类&quot;&gt;&lt;strong&gt;NetCloudAnalyse类&lt;/strong&gt;&lt;/h4&gt;
&lt;h4 id=&quot;load_comments_csv-加载全部评论文件为dataframe格式pandas&quot;&gt;- load_comments_csv() 加载全部评论文件为dataframe格式(pandas)&lt;/h4&gt;
&lt;h4 id=&quot;save_users_info_to_file-保存歌曲评论下全部用户已去重的信息到文件单线程&quot;&gt;- save_users_info_to_file() 保存歌曲评论下全部用户(已去重)的信息到文件(单线程)&lt;/h4&gt;
&lt;h4 id=&quot;threading_save_users_info_to_filethreads-10-采用多线程保存用户信息到文件默认是10个线程&quot;&gt;- threading_save_users_info_to_file(threads = 10) 采用多线程保存用户信息到文件,默认是10个线程&lt;/h4&gt;
&lt;h4 id=&quot;save_users_infousers_urltotal-供-threading_save_users_info_to_file调用的中间函数不用管&quot;&gt;- save_users_info(users_url,total) 供 threading_save_users_info_to_file调用的中间函数，不用管&lt;/h4&gt;

&lt;h4 id=&quot;from_timestamp_to_datetime_stampformat-y-m-d-hms-将时间戳转日期的函数默认格式是-年-月-日-时分秒&quot;&gt;- from_timestamp_to_date(time_stamp,format = &quot;%Y-%m-%d %H:%M:%S&quot;) 将时间戳转日期的函数,默认格式是: 年-月-日 时:分:秒&lt;/h4&gt;
&lt;h4 id=&quot;load_users_url-返回全部评论用户主页url列表用于后续用户信息抓取&quot;&gt;- load_users_url() 返回全部评论用户主页url列表，用于后续用户信息抓取&lt;/h4&gt;
&lt;h4 id=&quot;load_users_info_csv-从用户信息csv文件加载用户信息dataframe&quot;&gt;- load_users_info_csv() 从用户信息csv文件加载用户信息dataframe&lt;/h4&gt;

&lt;h4 id=&quot;core_visual_analyse-核心的对于评论用户信息的可视化分析产生的html文件有12个说明如下&quot;&gt;- core_visual_analyse() 核心的对于评论用户信息的可视化分析，产生的html文件有12个，说明如下：&lt;/h4&gt;
&lt;h5 id=&quot;age_count_bar.html-年龄分布bar-为-柱状图表示下同&quot;&gt;1. age_count_bar.html 年龄分布(bar 为 柱状图表示，下同)&lt;/h5&gt;
&lt;h5 id=&quot;agree_count_bar.html-赞同数分布&quot;&gt;2. agree_count_bar.html 赞同数分布&lt;/h5&gt;



&lt;h5 id=&quot;description_keywords_bar.html-用户简介关键词分布&quot;&gt;6. description_keywords_bar.html 用户简介关键词分布&lt;/h5&gt;
&lt;h5 id=&quot;events_count_bar.html-用户动态数目分布&quot;&gt;7. events_count_bar.html 用户动态数目分布&lt;/h5&gt;
&lt;h5 id=&quot;fans_count_bar.html-用户粉丝数量分布&quot;&gt;8. fans_count_bar.html 用户粉丝数量分布&lt;/h5&gt;
&lt;h5 id=&quot;follow_count_bar.html-用户关注者数量分布&quot;&gt;9. follow_count_bar.html 用户关注者数量分布&lt;/h5&gt;
&lt;h5 id=&quot;listening_songs_count_bar.html-用户听歌数量分布&quot;&gt;10. listening_songs_count_bar.html 用户听歌数量分布&lt;/h5&gt;
&lt;h5 id=&quot;users_city_geo.html-用户所在地区分布使用地图可视化表示&quot;&gt;11. users_city_geo.html 用户所在地区分布，使用地图可视化表示&lt;/h5&gt;
&lt;h5 id=&quot;users_location_bar.html-用户所在地区分布使用柱状图表示&quot;&gt;12. users_location_bar.html 用户所在地区分布，使用柱状图表示&lt;/h5&gt;
&lt;p&gt;一些可视化实际的效果图如下：&lt;br/&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/976328/201802/976328-20180204230940264-1322428576.png&quot;/&gt;&lt;br/&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/976328/201802/976328-20180204230952623-1241804961.png&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;load_stopwords-加载停用词列表&quot;&gt;- load_stopwords() 加载停用词列表&lt;/h4&gt;
&lt;h4 id=&quot;load_all_cities-加载中国全部城市名称列表&quot;&gt;- load_all_cities() 加载中国全部城市名称列表&lt;/h4&gt;
&lt;h4 id=&quot;generate_all_analyse_filesthreads-10-生成全部的分析文件包括评论关键字词云以及评论用户信息的可视化默认线程数为10&quot;&gt;- generate_all_analyse_files(threads = 10) 生成全部的分析文件，包括评论关键字词云以及评论用户信息的可视化，默认线程数为10&lt;/h4&gt;
&lt;h4 id=&quot;test-开头的为测试文件请不要调用&quot;&gt;- _test 开头的为测试文件，请不要调用&lt;/h4&gt;
&lt;h3 id=&quot;一些可能会出现的问题&quot;&gt;4. 一些可能会出现的问题&lt;/h3&gt;
&lt;h4 id=&quot;在pip-install-netcloud-的过程中如果是在windows下wordcloud-以及-pycrypto-模块也许会安装失败此时可以去python非官方第三方库下载下载对应pyhton版本的预编译wheel文件然后手动pip安装即可另外numpy-需要-numpymkl形式的库也可以在这个网站下载&quot;&gt;4.1 在pip install NetCloud 的过程中，如果是在Windows下，wordcloud 以及 pycrypto 模块也许会安装失败，此时可以去&lt;a href=&quot;https://www.lfd.uci.edu/~gohlke/pythonlibs/&quot;&gt;python非官方第三方库下载&lt;/a&gt;下载对应pyhton版本的预编译wheel文件，然后手动pip安装即可。另外,numpy 需要 numpy+mkl形式的库，也可以在这个网站下载。&lt;/h4&gt;
&lt;h4 id=&quot;由于我没有测试完全而且代码水平有限因此代码肯定存在一些意想不到的bug如果您对这个模块感兴趣在使用的过程中出现任何问题或者有任何建议欢迎给我留言当然最好的方式是去github提issue地址是netcloud同时欢迎star-和fork谢谢支持&quot;&gt;4.2 由于我没有测试完全，而且代码水平有限，因此代码肯定存在一些意想不到的bug，如果您对这个模块感兴趣，在使用的过程中出现任何问题或者有任何建议，欢迎给我留言，当然最好的方式是去github提issue,地址是&lt;a href=&quot;https://www.github.com/Lyrichu/NetCloud&quot;&gt;NetCloud&lt;/a&gt;，同时欢迎star 和fork，谢谢支持。&lt;/h4&gt;
</description>
<pubDate>Sun, 04 Feb 2018 15:28:00 +0000</pubDate>
<dc:creator>lyrichu</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/lyrichu/p/8414434.html</dc:identifier>
</item>
<item>
<title>网络编程 - 春生</title>
<link>http://www.cnblogs.com/jiangchunsheng/p/8414771.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/jiangchunsheng/p/8414771.html</guid>
<description>&lt;p&gt;你现在已经学会了写python代码，假如你写了两个python文件a.py和b.py，分别去运行，你就会发现，这两个python的文件分别运行的很好。但是如果这两个程序之间想要传递一个数据，你要怎么做呢？&lt;/p&gt;
&lt;p&gt;这个问题以你现在的知识就可以解决了，我们可以创建一个文件，把a.py想要传递的内容写到文件中，然后b.py从这个文件中读取内容就可以了。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201711/827651-20171101180819451-341987165.png&quot; alt=&quot;&quot; width=&quot;352&quot; height=&quot;98&quot;/&gt;&lt;/p&gt;

&lt;p&gt;但是当你的a.py和b.py分别在不同电脑上的时候，你要怎么办呢？&lt;/p&gt;
&lt;p&gt;类似的机制有计算机网盘，qq等等。我们可以在我们的电脑上和别人聊天，可以在自己的电脑上向网盘中上传、下载内容。这些都是两个程序在通信。&lt;/p&gt;



&lt;p&gt;我们了解的涉及到两个程序之间通讯的应用大致可以分为两种：&lt;/p&gt;
&lt;p&gt;第一种是应用类：qq、微信、网盘、优酷这一类是属于需要安装的桌面应用&lt;/p&gt;
&lt;p&gt;第二种是web类：比如百度、知乎、博客园等使用浏览器访问就可以直接使用的应用&lt;/p&gt;
&lt;p&gt;这些应用的本质其实都是两个程序之间的通讯。而这两个分类又对应了两个软件开发的架构～&lt;/p&gt;
&lt;h2&gt;1.C/S架构&lt;/h2&gt;
&lt;p&gt;C/S即：Client与Server ，中文意思：客户端与服务器端架构，这种架构也是从用户层面（也可以是物理层面）来划分的。&lt;/p&gt;
&lt;p&gt;这里的客户端一般泛指客户端应用程序EXE，程序需要先安装后，才能运行在用户的电脑上，对用户的电脑操作系统环境依赖较大。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201711/827651-20171102180740138-1487379531.png&quot; alt=&quot;&quot; width=&quot;410&quot; height=&quot;228&quot;/&gt;&lt;/p&gt;


&lt;h2&gt;2.B/S架构&lt;/h2&gt;
&lt;p&gt;B/S即：Browser与Server,中文意思：浏览器端与服务器端架构，这种架构是从用户层面来划分的。&lt;/p&gt;
&lt;p&gt;Browser浏览器，其实也是一种Client客户端，只是这个客户端不需要大家去安装什么应用程序，只需在浏览器上通过HTTP请求服务器端相关的资源（网页资源），客户端Browser浏览器就能进行增删改查。&lt;/p&gt;
&lt;p&gt; &lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201711/827651-20171102182619326-272756889.png&quot; alt=&quot;&quot; width=&quot;426&quot; height=&quot;286&quot;/&gt;&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;http://www.cnblogs.com/Eva-J/articles/8066842.html&quot; target=&quot;_blank&quot;&gt;网络基础&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;1.一个程序如何在网络上找到另一个程序？&lt;/h2&gt;
&lt;p&gt;首先，程序必须要启动，其次，必须有这台机器的地址，我们都知道我们人的地址大概就是国家\省\市\区\街道\楼\门牌号这样字。那么每一台联网的机器在网络上也有自己的地址，它的地址是怎么表示的呢？&lt;/p&gt;
&lt;p&gt;就是使用一串数字来表示的，例如：100.4.5.6&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;&lt;img id=&quot;code_img_opened_e00659f0-eb38-4a15-91dc-941e9bdc9cb9&quot; class=&quot;code_img_opened&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_e00659f0-eb38-4a15-91dc-941e9bdc9cb9&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;63&quot;&gt;
&lt;pre&gt;
IP地址是指互联网协议地址（英语：Internet Protocol Address，又译为网际协议地址），是IP Address的缩写。IP地址是IP协议提供的一种统一的地址格式，它为互联网上的每一个网络和每一台主机分配一个逻辑地址，以此来屏蔽物理地址的差异。

IP地址是一个32位的二进制数，通常被分割为4个“8位二进制数”（也就是4个字节）。IP地址通常用“点分十进制”表示成（a.b.c.d）的形式，其中，a,b,c,d都是0~255之间的十进制整数。例：点分十进IP地址（100.4.5.6），实际上是32位二进制数（01100100.00000100.00000101.00000110）。
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;31&quot;&gt;&lt;img id=&quot;code_img_opened_e6540743-f3af-4441-a0fa-0988567321b4&quot; class=&quot;code_img_opened&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_e6540743-f3af-4441-a0fa-0988567321b4&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;57&quot;&gt;
&lt;pre&gt;
&quot;端口&quot;是英文port的意译，可以认为是设备与外界通讯交流的出口。
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;因此ip地址精确到具体的一台电脑，而端口精确到具体的程序。&lt;/p&gt;
&lt;h2&gt;2.osi七层模型&lt;/h2&gt;
&lt;h3&gt;&lt;strong&gt;引子&lt;/strong&gt;&lt;/h3&gt;
&lt;p&gt;须知一个完整的计算机系统是由硬件、操作系统、应用软件三者组成,具备了这三个条件，一台计算机系统就可以自己跟自己玩了（打个单机游戏，玩个扫雷啥的）&lt;/p&gt;
&lt;p&gt;如果你要跟别人一起玩，那你就需要上网了，什么是互联网？&lt;/p&gt;
&lt;p&gt;互联网的核心就是由一堆协议组成，协议就是标准，比如全世界人通信的标准是英语，如果把计算机比作人，互联网协议就是计算机界的英语。所有的计算机都学会了互联网协议，那所有的计算机都就可以按照统一的标准去收发信息从而完成通信了。&lt;/p&gt;
&lt;h3&gt;osi七层模型&lt;/h3&gt;
&lt;p&gt;人们按照分工不同把互联网协议从逻辑上划分了层级：&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107205950456-843487109.png&quot; alt=&quot;&quot;/&gt;&lt;/em&gt;&lt;/p&gt;


&lt;h2&gt;3.socket概念&lt;/h2&gt;
&lt;h3&gt;socket层&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107205809034-380661986.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;h3&gt;理解socket&lt;/h3&gt;
&lt;p&gt;Socket是应用层与&lt;span lang=&quot;EN-US&quot;&gt;TCP/IP协议族通信的中间软件抽象层，它是一组接口。在设计模式中，&lt;span lang=&quot;EN-US&quot;&gt;Socket其实就是一个门面模式，它把复杂的&lt;span lang=&quot;EN-US&quot;&gt;TCP/IP协议族隐藏在&lt;span lang=&quot;EN-US&quot;&gt;Socket接口后面，对用户来说，一组简单的接口就是全部，让&lt;span lang=&quot;EN-US&quot;&gt;Socket去组织数据，以符合指定的协议。&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_b7aabd40-4e23-4836-83c1-f588233e723f&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;站在你的角度上看socket&lt;/span&gt;&lt;/div&gt;
&lt;h2&gt;3.套接字（socket）的发展史&lt;/h2&gt;
&lt;p&gt;套接字起源于 20 世纪 70 年代加利福尼亚大学伯克利分校版本的 Unix,即人们所说的 BSD Unix。 因此,有时人们也把套接字称为“伯克利套接字”或“BSD 套接字”。一开始,套接字被设计用在同 一台主机上多个应用程序之间的通讯。这也被称进程间通讯,或 IPC。套接字有两种（或者称为有两个种族）,分别是基于文件型的和基于网络型的。 &lt;/p&gt;
&lt;h3&gt;&lt;em&gt;基于文件类型的套接字家族&lt;/em&gt;&lt;/h3&gt;
&lt;p&gt;套接字家族的名字：AF_UNIX&lt;/p&gt;
&lt;p&gt;unix一切皆文件，基于文件的套接字调用的就是底层的文件系统来取数据，两个套接字进程运行在同一机器，可以通过访问同一个文件系统间接完成通信&lt;/p&gt;
&lt;h3&gt;&lt;em&gt;基于网络类型的套接字家族&lt;/em&gt;&lt;/h3&gt;
&lt;p&gt;套接字家族的名字：AF_INET&lt;/p&gt;
&lt;p&gt;(还有AF_INET6被用于ipv6，还有一些其他的地址家族，不过，他们要么是只用于某个平台，要么就是已经被废弃，或者是很少被使用，或者是根本没有实现，所有地址家族中，AF_INET是使用最广泛的一个，python支持很多种地址家族，但是由于我们只关心网络编程，所以大部分时候我么只使用AF_INET)&lt;/p&gt;

&lt;h2&gt;4.tcp协议和udp协议&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;TCP&lt;/strong&gt;（Transmission Control Protocol）可靠的、面向连接的协议（eg:打电话）、传输效率低全双工通信（发送缓存&amp;amp;接收缓存）、面向字节流。使用TCP的应用：Web浏览器；电子邮件、文件传输程序。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;UDP&lt;/strong&gt;（User Datagram Protocol）不可靠的、无连接的服务，传输效率高（发送前时延小），一对一、一对多、多对一、多对多、面向报文，尽最大努力服务，无拥塞控制。使用UDP的应用：域名系统 (DNS)；视频流；IP语音(VoIP)。&lt;/p&gt;
&lt;p&gt;我知道说这些你们也不懂，直接上图。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201710/827651-20171027102242789-2142796570.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;


&lt;h2&gt;基于TCP协议的socket&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;tcp是基于链接的，必须先启动服务端，然后再启动客户端去链接服务端&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;server端&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;pre&gt;
import socket
sk = socket.socket()
sk.bind(('127.0.0.1',8898))  #把地址绑定到套接字
sk.listen()          #监听链接
conn,addr = sk.accept() #接受客户端链接
ret = conn.recv(1024)  #接收客户端信息
print(ret)       #打印客户端信息
conn.send(b'hi')        #向客户端发送信息
conn.close()       #关闭客户端套接字
sk.close()        #关闭服务器套接字(可选)
&lt;/pre&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h3&gt;client端&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;pre&gt;
import socket
sk = socket.socket()           # 创建客户套接字
sk.connect(('127.0.0.1',8898))    # 尝试连接服务器
sk.send(b'hello!')
ret = sk.recv(1024)         # 对话(发送/接收)
print(ret)
sk.close()            # 关闭客户套接字
&lt;/pre&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;h3&gt;问题：在重启服务端时可能会遇到&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201711/827651-20171109174833325-1552312354.png&quot; alt=&quot;&quot; width=&quot;488&quot; height=&quot;102&quot;/&gt;&lt;/p&gt;
&lt;p&gt;解决方法：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;pre&gt;
#加入一条socket配置，重用ip和端口
import socket
from socket import SOL_SOCKET,SO_REUSEADDR
sk = socket.socket()
sk.setsockopt(SOL_SOCKET,SO_REUSEADDR,1) #就是它，在bind前加
sk.bind(('127.0.0.1',8898))  #把地址绑定到套接字
sk.listen()          #监听链接
conn,addr = sk.accept() #接受客户端链接
ret = conn.recv(1024)   #接收客户端信息
print(ret)              #打印客户端信息
conn.send(b'hi')        #向客户端发送信息
conn.close()       #关闭客户端套接字
sk.close()        #关闭服务器套接字(可选)
&lt;/pre&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;h2&gt;基于UDP协议的socket&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;udp是无链接的，先启动哪一端都不会报错&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;简单使用&lt;/h3&gt;
&lt;h4&gt;server端&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;pre&gt;
import socket
udp_sk = socket.socket(type=socket.SOCK_DGRAM)   #创建一个服务器的套接字
udp_sk.bind(('127.0.0.1',9000))        #绑定服务器套接字
msg,addr = udp_sk.recvfrom(1024)
print(msg)
udp_sk.sendto(b'hi',addr)                 # 对话(接收与发送)
udp_sk.close()                         # 关闭服务器套接字
&lt;/pre&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4&gt;client端&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
import socket
ip_port=('127.0.0.1',9000)
udp_sk=socket.socket(type=socket.SOCK_DGRAM)
udp_sk.sendto(b'hello',ip_port)
back_msg,addr=udp_sk.recvfrom(1024)
print(back_msg.decode('utf-8'),addr)
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt; qq聊天&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_e9cdbf60-ff97-4c5e-804b-dddac9a4ebc7&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;server&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_65973f04-4ba1-4646-8caa-384b1b20cfed&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;client&lt;/span&gt;&lt;/div&gt;
&lt;h3&gt;时间服务器&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_0fba0b42-f8f7-4271-b7c9-24970d3c4268&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;server&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_d27bf3ee-2e57-494d-a327-37066d60a765&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;client&lt;/span&gt;&lt;/div&gt;
&lt;h2&gt;socket参数的详解&lt;/h2&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
socket.socket(family=AF_INET,type=SOCK_STREAM,proto=0,fileno=None)
&lt;/pre&gt;&lt;/div&gt;
&lt;pre data-source-line=&quot;11&quot;&gt;
&lt;code class=&quot;hljs&quot;&gt;&lt;span class=&quot;hljs-selector-tag&quot;&gt;&lt;strong&gt;创建socket对象的参数说明：&lt;br/&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;table border=&quot;0&quot;&gt;&lt;tbody readability=&quot;13.5&quot;&gt;&lt;tr readability=&quot;6&quot;&gt;&lt;td width=&quot;60&quot;&gt;&lt;strong&gt;family&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;地址系列应为AF_INET(默认值),AF_INET6,AF_UNIX,AF_CAN或AF_RDS。&lt;br/&gt;（AF_UNIX 域实际上是使用本地 socket 文件来通信）&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;7&quot;&gt;&lt;td width=&quot;60&quot;&gt;&lt;strong&gt;type&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;套接字类型应为SOCK_STREAM(默认值),SOCK_DGRAM,SOCK_RAW或其他SOCK_常量之一。&lt;br/&gt;&lt;strong&gt;SOCK_STREAM&lt;/strong&gt; 是基于TCP的，有保障的（即能保证数据正确传送到对方）面向连接的SOCKET，多用于资料传送。&lt;br/&gt;&lt;strong&gt;SOCK_DGRAM&lt;/strong&gt; 是基于UDP的，无保障的面向消息的socket，多用于在网络上发广播信息。&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;6&quot;&gt;&lt;td width=&quot;60&quot;&gt;&lt;strong&gt;proto&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;协议号通常为零,可以省略,或者在地址族为AF_CAN的情况下,协议应为CAN_RAW或CAN_BCM之一。&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;8&quot;&gt;&lt;td width=&quot;60&quot;&gt;&lt;strong&gt;fileno&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;如果指定了fileno,则其他参数将被忽略,导致带有指定文件描述符的套接字返回。&lt;br/&gt;与socket.fromfd()不同,fileno将返回相同的套接字,而不是重复的。&lt;br/&gt;这可能有助于使用socket.close()关闭一个独立的插座。&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;pre data-source-line=&quot;11&quot;&gt;
&lt;/pre&gt;


&lt;h2&gt;黏包现象&lt;/h2&gt;
&lt;p&gt;让我们基于tcp先制作一个远程执行命令的程序（命令ls -l ; lllllll ; pwd）&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_5c6673d2-1767-471a-94bb-fb63b00ebfb9&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;注意&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;同时执行多条命令之后，得到的结果很可能只有一部分，在执行其他命令的时候又接收到之前执行的另外一部分结果，这种显现就是黏包。&lt;/p&gt;
&lt;h3&gt;基于tcp协议实现的黏包&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_f330f827-9c79-46a5-b1b2-b488fef3ed3f&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;tcp - server&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_7bccb6ac-bc49-4ae8-9b48-ea70787d0c49&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;tcp - client&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;注意：只有TCP有粘包现象，UDP永远不会粘包&lt;/strong&gt;&lt;/p&gt;
&lt;h3&gt;基于udp协议实现的黏包&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_f53f5cc7-2673-425d-9544-60d971bd28c0&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;udp - server&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_cf53ff83-fcaa-48ff-96ee-b31238af5f1f&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;udp - client&lt;/span&gt;&lt;/div&gt;
&lt;h2&gt;黏包成因&lt;/h2&gt;
&lt;h3&gt;&lt;strong&gt;为什么会出现黏包现象？ &lt;/strong&gt;&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107212834471-1015282383.png&quot; alt=&quot;&quot;/&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107212854393-1243611115.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107213012565-1511102109.png&quot; alt=&quot;&quot; width=&quot;329&quot; height=&quot;206&quot;/&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_9736b3af-9edb-489b-a49f-74569515c2cc&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;socket数据传输过程中的用户态与内核态说明&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;例如基于tcp的套接字客户端往服务端上传文件，发送时文件内容是按照一段一段的字节流发送的，在接收方看了，根本不知道该文件的字节流从何处开始，在何处结束&lt;/p&gt;
&lt;p id=&quot;所谓粘包问题主要还是因为接收方不知道消息之间的界限不知道一次性提取多少字节的数据所造成的&quot;&gt;&lt;strong&gt;所谓粘包问题——主要还是因为接收方不知道消息之间的界限，不知道一次性提取多少字节的数据所造成的。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;此外，发送方引起的粘包是由TCP协议本身造成的，TCP为提高传输效率，发送方往往要收集到足够多的数据后才发送一个TCP段。若连续几次需要send的数据都很少，通常TCP会根据优化&lt;a class=&quot;replace_word&quot; title=&quot;算法与数据结构知识库&quot; href=&quot;http://lib.csdn.net/base/datastructure&quot; target=&quot;_blank&quot;&gt;算法&lt;/a&gt;把这些数据合成一个TCP段后一次发送出去，这样接收方就收到了粘包数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107212839706-127829859.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_cefa91b3-a0e7-404f-9b6c-8c1fa6750d49&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;面向流通信的tcp协议与面向消息通信的udp&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;补充说明：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_6314af6c-f0a7-463b-b699-e9d8a4e9f846&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;tcp协议的拆包&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_973d7ba4-c8e7-4e02-b88f-e49a05ca02c8&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;为何tcp是可靠传输，udp是不可靠传输&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_8247a3bb-c0a8-44ee-8d2b-a966959182ff&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;补充问题二：send(字节流)和recv(1024)及sendall&lt;/span&gt;&lt;/div&gt;
&lt;h3&gt;会发生黏包的两种情况&lt;/h3&gt;
&lt;h4&gt;情况一 发送方的缓存机制&lt;/h4&gt;
&lt;p&gt;发送端需要等缓冲区满才发送出去，造成粘包（发送数据时间间隔很短，数据了很小，会合到一起，产生粘包）&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_3db977b6-5afa-4d7d-b71b-13a57e2036d6&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;服务端&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_11835a63-df46-4e90-a907-9593f7e9eed7&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端&lt;/span&gt;&lt;/div&gt;
&lt;h4&gt;情况二 接收方的缓存机制&lt;/h4&gt;
&lt;p&gt;接收方不及时接收缓冲区的包，造成多个包接收（客户端发送了一段数据，服务端只收了一小部分，服务端下次再收的时候还是从缓冲区拿上次遗留的数据，产生粘包） &lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_5bf2b1b5-00eb-4c57-b1c1-38a18ef32aaa&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;服务端&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_9081db8d-1baf-46ea-a7e9-58af2a9d4674&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;黏包的解决方案&lt;/p&gt;
&lt;h3&gt;解决方案一&lt;/h3&gt;
&lt;p&gt;问题的根源在于，接收端不知道发送端将要传送的字节流的长度，所以解决粘包的方法就是围绕，如何让发送端在发送数据前，把自己将要发送的字节流总大小让接收端知晓，然后接收端来一个死循环接收完所有数据。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107211210612-35513522.png&quot; alt=&quot;&quot; width=&quot;399&quot; height=&quot;241&quot;/&gt;&lt;/p&gt;

&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_e6a34007-6cd4-4dfb-b926-a8cbd4cb9c02&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;服务端&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_c0b4c2f9-d90f-49fa-becf-e2d688a6c884&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
存在的问题：
程序的运行速度远快于网络传输速度，所以在发送一段字节前，先用send去发送该字节流长度，这种方式会放大网络延迟带来的性能损耗
&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;解决方案进阶&lt;/h3&gt;
&lt;p&gt;刚刚的方法，问题在于我们我们在发送&lt;/p&gt;
&lt;p&gt;我们可以借助一个模块，这个模块可以把要发送的数据长度转换成固定长度的字节。这样客户端每次接收消息之前只要先接受这个固定长度字节的内容看一看接下来要接收的信息大小，那么最终接受的数据只要达到这个值就停止，就能刚好不多不少的接收完整的数据了。&lt;/p&gt;
&lt;h4&gt;struct模块&lt;/h4&gt;
&lt;p&gt;该模块可以把一个类型，如数字，转成固定长度的bytes&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&amp;gt;&amp;gt;&amp;gt; struct.pack('i',1111111111111)

struct.error: 'i' format requires -2147483648 &amp;lt;= number &amp;lt;= 2147483647 #这个是范围
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/827651/201801/827651-20180107202942674-547846208.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;51&quot;&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;pre&gt;
import json,struct
#假设通过客户端上传1T:1073741824000的文件a.txt

#为避免粘包,必须自定制报头
header={'file_size':1073741824000,'file_name':'/a/b/c/d/e/a.txt','md5':'8f6fbf8347faa4924a76856701edb0f3'} #1T数据,文件路径和md5值

#为了该报头能传送,需要序列化并且转为bytes
head_bytes=bytes(json.dumps(header),encoding='utf-8') #序列化并转成bytes,用于传输

#为了让客户端知道报头的长度,用struck将报头长度这个数字转成固定长度:4个字节
head_len_bytes=struct.pack('i',len(head_bytes)) #这4个字节里只包含了一个数字,该数字是报头的长度

#客户端开始发送
conn.send(head_len_bytes) #先发报头的长度,4个bytes
conn.send(head_bytes) #再发报头的字节格式
conn.sendall(文件内容) #然后发真实内容的字节格式

#服务端开始接收
head_len_bytes=s.recv(4) #先收报头4个bytes,得到报头长度的字节格式
x=struct.unpack('i',head_len_bytes)[0] #提取报头的长度

head_bytes=s.recv(x) #按照报头长度x,收取报头的bytes格式
header=json.loads(json.dumps(header)) #提取报头

#最后根据报头的内容提取真实的数据,比如
real_data_len=s.recv(header['file_size'])
s.recv(real_data_len)
&lt;/pre&gt;
&lt;div class=&quot;cnblogs_code_toolbar&quot;&gt;&lt;span class=&quot;cnblogs_code_copy&quot;&gt;&lt;a title=&quot;复制代码&quot;&gt;&lt;img src=&quot;https://common.cnblogs.com/images/copycode.gif&quot; alt=&quot;复制代码&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_3db1d818-d341-4843-abd3-42ce22f01a40&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;关于struct的详细用法&lt;/span&gt;&lt;/div&gt;
&lt;h4&gt;使用struct解决黏包 &lt;/h4&gt;
&lt;p&gt;借助struct模块，我们知道长度数字可以被转换成一个标准大小的4字节数字。因此可以利用这个特点来预先发送数据长度。&lt;/p&gt;
&lt;table border=&quot;0&quot;&gt;&lt;tbody readability=&quot;3&quot;&gt;&lt;tr&gt;&lt;td&gt;发送时&lt;/td&gt;
&lt;td&gt;接收时&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;4&quot;&gt;&lt;td&gt;先发送struct转换好的数据长度4字节&lt;/td&gt;
&lt;td&gt;先接受4个字节使用struct转换成数字来获取要接收的数据长度&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;再发送数据&lt;/td&gt;
&lt;td&gt;再按照长度接收数据&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_b824da64-44fa-4b5e-b63f-2f9f5b6cebc9&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;服务端（自定制报头）&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_4d9d4813-fdbc-4a04-bc88-667d6561e2eb&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端（自定制报头）&lt;/span&gt;&lt;/div&gt;

&lt;p&gt;我们还可以把报头做成字典，字典里包含将要发送的真实数据的详细信息，然后json序列化，然后用struck将序列化后的数据长度打包成4个字节（4个自己足够用了）&lt;/p&gt;
&lt;table border=&quot;0&quot;&gt;&lt;tbody readability=&quot;4&quot;&gt;&lt;tr&gt;&lt;td&gt;发送时&lt;/td&gt;
&lt;td&gt;接收时&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;
&lt;p&gt;先发报头长度&lt;/p&gt;
&lt;/td&gt;
&lt;td&gt;先收报头长度，用struct取出来&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;4&quot;&gt;&lt;td&gt;再编码报头内容然后发送&lt;/td&gt;
&lt;td&gt;根据取出的长度收取报头内容，然后解码，反序列化&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;最后发真实内容&lt;/td&gt;
&lt;td&gt;从反序列化的结果中取出待取数据的详细信息，然后去取真实的数据内容&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_5005e121-455c-480b-bae0-530bf62f65b9&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;服务端：定制稍微复杂一点的报头&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_de6461c9-82e4-4729-acf8-d0b23e87c5c0&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端&lt;/span&gt;&lt;/div&gt;

&lt;h4&gt;&lt;strong&gt;FTP作业：上传下载文件&lt;/strong&gt;&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_7a398f80-f466-414e-9446-0221a247fbe8&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;服务端&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_c6fc720b-e1ac-47da-b1f2-17fa8aee3b41&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端&lt;/span&gt;&lt;/div&gt;


&lt;p&gt;如果你想在分布式系统中实现一个简单的客户端链接认证功能，又不像SSL那么复杂，那么利用hmac+加盐的方式来实现&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_fe4bf164-a800-48b9-bd16-939452273835&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;服务端&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_a736a4af-369d-47fe-8ac2-f0e61fc3b325&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端(合法)&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_a40d42ef-9630-4859-b110-98830d83e73e&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端(非法:不知道加密方式)&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_9cf00629-622c-4a28-801c-6aac4f034dd1&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;客户端(非法:不知道secret_key) &lt;/span&gt;&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;http://www.cnblogs.com/Eva-J/p/5081851.html&quot; target=&quot;_blank&quot;&gt;解读socketserver源码 —— http://www.cnblogs.com/Eva-J/p/5081851.html &lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_32d41c04-f4e3-4de2-b338-8190e0dd28c9&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;server端&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;&lt;img id=&quot;code_img_closed_d04509e1-dd0f-4a77-9744-a45bf41f080e&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt; &lt;span class=&quot;cnblogs_code_collapse&quot;&gt;client&lt;/span&gt;&lt;/div&gt;



</description>
<pubDate>Sun, 04 Feb 2018 15:12:00 +0000</pubDate>
<dc:creator>春生</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/jiangchunsheng/p/8414771.html</dc:identifier>
</item>
<item>
<title>[UWP]新控件ColorPicker - dino.c</title>
<link>http://www.cnblogs.com/dino623/p/ColorPicker.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/dino623/p/ColorPicker.html</guid>
<description>&lt;h2 id=&quot;前言&quot;&gt;1. 前言&lt;/h2&gt;
&lt;p&gt;Fall Creators Update中提供了一个新得ColorPicker控件，解决了以前选择颜色只能用Combo Box的窘境。&lt;/p&gt;
&lt;h2 id=&quot;一个简单的例子&quot;&gt;2. 一个简单的例子&lt;/h2&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;sourceCode xml&quot;&gt;
&lt;code class=&quot;sourceCode xml&quot;&gt;&lt;span class=&quot;kw&quot;&gt;&amp;lt;ColorPicker&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;ColorPicker&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;             Margin=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;5&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Margin=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;5&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid.Background&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;&amp;lt;SolidColorBrush&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Color=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{x:Bind ColorPicker.Color, Mode=OneWay}&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid.Background&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;TextBlock&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Text=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{x:Bind ColorPicker.Color}&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid&amp;gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/38937/201802/38937-20180202234039781-298674565.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;如上所示，ColorPiker可以通过在光谱或色轮上拖动滑块，或者在RGB/HSV及十六进制的TextBox中直接输入颜色的数值改变Color属性。&lt;/p&gt;
&lt;h2 id=&quot;定制colorpicker&quot;&gt;3. 定制ColorPicker&lt;/h2&gt;
&lt;p&gt;ColorPicker提供了很多属性以设置它的外观，下面介绍一些常用的属性。&lt;/p&gt;
&lt;h3 id=&quot;colorspectrumshape&quot;&gt;3.1 ColorSpectrumShape&lt;/h3&gt;
&lt;p&gt;ColorSpectrumShape是定义ColorPicker外观的主要属性。当设置为&lt;code&gt;ColorSpectrumShape.Box&lt;/code&gt;时显示正方形的光谱，设置为&lt;code&gt;ColorSpectrumShape.Ring&lt;/code&gt;时显示为圆型的HSV色轮。&lt;/p&gt;
&lt;h3 id=&quot;最简化显示&quot;&gt;3.2 最简化显示&lt;/h3&gt;
&lt;p&gt;完整的ColorPicker实在太占空间，而且整个控件左边高右边低，很不平衡。使用以下设置可以隐藏ColorPreview及其它Text Box以最简化ColorPicker的显示，使它勉强正常一点。&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode xml&quot;&gt;
&lt;code class=&quot;sourceCode xml&quot;&gt;&lt;span class=&quot;kw&quot;&gt;&amp;lt;ColorPicker&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;ColorPicker&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;             ColorSpectrumShape=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Ring&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;             IsColorPreviewVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;False&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;             IsColorChannelTextInputVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;False&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;             IsHexInputVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;False&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/38937/201802/38937-20180202234059093-212983387.png&quot;/&gt;&lt;/p&gt;
&lt;h3 id=&quot;其它属性&quot;&gt;3.3 其它属性&lt;/h3&gt;
&lt;p&gt;使用如下XAML基本可以将所有元素显示出来：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode xml&quot;&gt;
&lt;code class=&quot;sourceCode xml&quot;&gt;&lt;span class=&quot;kw&quot;&gt;&amp;lt;ColorPicker&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;ColorPicker&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;         IsColorPreviewVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;True&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;         IsAlphaEnabled=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;True&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;         IsMoreButtonVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;True&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/38937/201802/38937-20180202234922140-319033664.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;下面列表列出了各元素对应的属性。&lt;br/&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/38937/201802/38937-20180202234108640-159224652.png&quot;/&gt;&lt;/p&gt;
&lt;h2 id=&quot;封装colorpicker&quot;&gt;4. 封装ColorPicker&lt;/h2&gt;
&lt;p&gt;ColorPicker难用的地方在于它是个大块头，而且没有Header，摆在表单里面格格不入。官方文档里面还介绍了怎么把ColorPicker放在Button的Flyout里使用，都做到这样了还不如直接提供这个弹出控件。&lt;/p&gt;
&lt;p&gt;为了使它更好用我把它简单地封装到一个弹出控件中。由于Picker控件通常都是指点击按钮弹出一个Popup或Flyout通过鼠标点击选择值的控件，例如DatePicker、TimePicker或者Extended WPF Toolkit 中的ColorPicker，UWP中的ColorPicker这个名称让我很为难，只好把自己封装的控件命名为ColorSelector。详细代码请见文章最后给出的Fluent Design System Sample源码。&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;22&quot;&gt;
&lt;pre class=&quot;sourceCode xml&quot;&gt;
&lt;code class=&quot;sourceCode xml&quot;&gt;&lt;span class=&quot;kw&quot;&gt;&amp;lt;Style&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; TargetType=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;local:ColorSelector&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Property=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;IsTabStop&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;            Value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;False&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Property=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;FontFamily&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;            Value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{ThemeResource ContentControlThemeFontFamily}&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Property=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;FontSize&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;            Value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{ThemeResource ControlContentThemeFontSize}&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Property=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Template&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter.Value&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;kw&quot;&gt;&amp;lt;ControlTemplate&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; TargetType=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;local:ColorSelector&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;kw&quot;&gt;&amp;lt;StackPanel&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;LayoutRoot&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                            Margin=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding Padding}&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;VisualStateManager.VisualStateGroups&amp;gt;&lt;/span&gt;
                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;VisualStateGroup&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;CommonStates&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;VisualState&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Normal&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;VisualState&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Disabled&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;Storyboard&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;ObjectAnimationUsingKeyFrames&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Storyboard.TargetName=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;HeaderContentPresenter&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                   Storyboard.TargetProperty=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Foreground&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;DiscreteObjectKeyFrame&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; KeyTime=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;0&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                Value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{ThemeResource DatePickerHeaderForegroundDisabled}&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/ObjectAnimationUsingKeyFrames&amp;gt;&lt;/span&gt;
                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Storyboard&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;/VisualState&amp;gt;&lt;/span&gt;
                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/VisualStateGroup&amp;gt;&lt;/span&gt;
                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;VisualStateGroup&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;PopupStates&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;VisualState&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;PopupOpened&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;VisualState&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;PopupClosed&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/VisualStateGroup&amp;gt;&lt;/span&gt;
                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/VisualStateManager.VisualStateGroups&amp;gt;&lt;/span&gt;
                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;local:HeaderedContentControl&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Header=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding Header}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                  HeaderTemplate=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding HeaderTemplate}&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;ToggleButton&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;DateButton&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                      DataContext=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{Binding RelativeSource={RelativeSource Mode=TemplatedParent},Path=Color}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                      IsEnabled=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding IsEnabled}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                      IsChecked=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{Binding RelativeSource={RelativeSource Mode=TemplatedParent}, Path=IsDropDownOpen,Mode=TwoWay}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                      HorizontalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Stretch&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                      HorizontalContentAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Stretch&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;ToggleButton.Content&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid.ColumnDefinitions&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;ColumnDefinition&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Width=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Auto&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;ColumnDefinition&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid.ColumnDefinitions&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;TextBlock&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Text=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Select A Color:&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;Rectangle&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Grid.Column=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;1&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                   Margin=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;5,0,0,0&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Rectangle.Fill&amp;gt;&lt;/span&gt;
                                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;SolidColorBrush&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Color=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{Binding}&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Rectangle.Fill&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Rectangle&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid&amp;gt;&lt;/span&gt;
                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;/ToggleButton.Content&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;FlyoutBase.AttachedFlyout&amp;gt;&lt;/span&gt;
                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;Flyout&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Placement=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Bottom&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                        x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Flyout&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Flyout.FlyoutPresenterStyle&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;Style&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; TargetType=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;FlyoutPresenter&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Property=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Padding&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;0&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Property=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;BorderThickness&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Value=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;0&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Property=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Template&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;Setter.Value&amp;gt;&lt;/span&gt;
                                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;ControlTemplate&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; TargetType=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;FlyoutPresenter&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;ContentPresenter&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Background=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding Background}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          BorderBrush=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding BorderBrush}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          BorderThickness=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding BorderThickness}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          Content=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding Content}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          ContentTemplate=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding ContentTemplate}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          ContentTransitions=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding ContentTransitions}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          Margin=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding Padding}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          HorizontalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding HorizontalContentAlignment}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                                          VerticalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding VerticalContentAlignment}&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/ControlTemplate&amp;gt;&lt;/span&gt;
                                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Setter.Value&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Setter&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Style&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Flyout.FlyoutPresenterStyle&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid.RowDefinitions&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;RowDefinition&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;RowDefinition&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Height=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Auto&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid.RowDefinitions&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;ColorPicker&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;ColorPicker&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                     Style=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{TemplateBinding ColorPickerStyle}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                     IsColorPreviewVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;False&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                     IsColorChannelTextInputVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;False&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                     IsHexInputVisible=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;False&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Grid.Row=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;1&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                              Height=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;45&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                              x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;AcceptDismissHostGrid&quot;&lt;/span&gt;&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Grid.ColumnDefinitions&amp;gt;&lt;/span&gt;
                                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;ColumnDefinition&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Width=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;*&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;ColumnDefinition&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Width=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;*&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid.ColumnDefinitions&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Rectangle&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; Height=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;2&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                       VerticalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Top&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                       Fill=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{ThemeResource DatePickerFlyoutPresenterSpacerFill}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                       Grid.ColumnSpan=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;2&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Button&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;AcceptButton&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Grid.Column=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;0&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Content=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;&amp;amp;#xE8FB;&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    FontFamily=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{ThemeResource SymbolThemeFontFamily}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    FontSize=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;16&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    HorizontalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Stretch&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    VerticalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Stretch&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Style=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{StaticResource DateTimePickerFlyoutButtonStyle}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Margin=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;0,2,0,0&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;Button&lt;/span&gt;&lt;span class=&quot;ot&quot;&gt; x:Name=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;DismissButton&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Grid.Column=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;1&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Content=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;&amp;amp;#xE711;&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    FontFamily=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{ThemeResource SymbolThemeFontFamily}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    FontSize=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;16&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    HorizontalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Stretch&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    VerticalAlignment=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;Stretch&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Style=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;{StaticResource DateTimePickerFlyoutButtonStyle}&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;                                                    Margin=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;0,2,0,0&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;
                                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid&amp;gt;&lt;/span&gt;
                                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Grid&amp;gt;&lt;/span&gt;
                                &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Flyout&amp;gt;&lt;/span&gt;
                            &lt;span class=&quot;kw&quot;&gt;&amp;lt;/FlyoutBase.AttachedFlyout&amp;gt;&lt;/span&gt;
                        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/ToggleButton&amp;gt;&lt;/span&gt;
                    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/local:HeaderedContentControl&amp;gt;&lt;/span&gt;
                &lt;span class=&quot;kw&quot;&gt;&amp;lt;/StackPanel&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;kw&quot;&gt;&amp;lt;/ControlTemplate&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Setter.Value&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;&amp;lt;/Setter&amp;gt;&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;&amp;lt;/Style&amp;gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/38937/201802/38937-20180202234137390-962600241.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;（也许是Flyout没有添加阴影或边框的原因，看起来丑丑的。）&lt;/p&gt;
&lt;h2 id=&quot;结语&quot;&gt;5. 结语&lt;/h2&gt;
&lt;p&gt;Winform中有ColorDialog：&lt;br/&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/38937/201802/38937-20180202234142437-1987691689.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;WPF有Extended WPF Toolkit 中的ColorPicker：&lt;br/&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/38937/201802/38937-20180202234147296-1428590824.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;而UWP拖到现在才终于肯提供一个ColorPicker。每次更新技术都扔掉一些常用控件，导致开发者只能选择第三方控件或自己实现，连TreeView都是拖了几年才搞出来。这难道是微软对我们的考验吗？&lt;/p&gt;
&lt;h2 id=&quot;参考&quot;&gt;5. 参考&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://docs.microsoft.com/en-us/windows/uwp/design/controls-and-patterns/color-picker&quot;&gt;Color Picker&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://docs.microsoft.com/zh-cn/uwp/api/windows.ui.xaml.controls.colorpicker&quot;&gt;ColorPicker Class&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;源码&quot;&gt;6. 源码&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/DinoChan/Fluent-Design-System-Sample&quot;&gt;Fluent Design System Sample&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/XamlUIBasics&quot;&gt;XamlUIBasics&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Sun, 04 Feb 2018 14:50:00 +0000</pubDate>
<dc:creator>dino.c</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/dino623/p/ColorPicker.html</dc:identifier>
</item>
<item>
<title>MySQL--如何快速对比数据 - 笑东风</title>
<link>http://www.cnblogs.com/TeyGao/p/8414657.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/TeyGao/p/8414657.html</guid>
<description>&lt;p&gt;在MySQL运维中，研发同事想对比下两个不同实例上的数据并找出差异，除主键外还需要对比每一个字段，如何做呢？&lt;/p&gt;
&lt;p&gt;第一种方案，写程序将两个实例上的每一行数据取出来进行对比，理论可行，但是对比时间较长。&lt;/p&gt;
&lt;p&gt;第二种方案，对每一行数据所有字段合并起来，取checksum值，再按照checksum值对比，看着可行，尝试下。&lt;/p&gt;
&lt;p&gt;首先要合并所有字段的值，选用MySQL提供的CONCAT函数，如果CONCAT函数中包含NULL值，会导致最终结果为NULL，因此需要使用IFNULL函数来替换NULL值，如:&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
CONCAT(IFNULL(C1,&lt;span&gt;''&lt;/span&gt;),IFNULL(C2,&lt;span&gt;''&lt;/span&gt;))
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;加入表有很多行，手动拼个脚本比较累，别急，可以使用information_schema.COLUMNS来处理：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;## 获取列名的拼接串
SELECT
GROUP_CONCAT(&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;IFNULL(&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,COLUMN_NAME,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;&lt;span&gt;''''&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
FROM information_schema.COLUMNS 
WHERE TABLE_NAME&lt;/span&gt;=&lt;span&gt;'&lt;/span&gt;&lt;span&gt;table_name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;假设我们有测试表：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;CREATE&lt;/span&gt; &lt;span&gt;TABLE&lt;/span&gt;&lt;span&gt; t_test01
(
    id &lt;/span&gt;&lt;span&gt;INT&lt;/span&gt; AUTO_INCREMENT &lt;span&gt;PRIMARY&lt;/span&gt; &lt;span&gt;KEY&lt;/span&gt;&lt;span&gt;,
    C1 &lt;/span&gt;&lt;span&gt;INT&lt;/span&gt;&lt;span&gt;,
    C2 &lt;/span&gt;&lt;span&gt;INT&lt;/span&gt;&lt;span&gt;
)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;我们便可以拼接出下面的SQL:&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
&lt;span&gt;SELECT&lt;/span&gt;&lt;span&gt;
id,
MD5(CONCAT(
IFNULL(id,&lt;/span&gt;&lt;span&gt;''&lt;/span&gt;&lt;span&gt;),
IFNULL(c1,&lt;/span&gt;&lt;span&gt;''&lt;/span&gt;&lt;span&gt;),
IFNULL(c2,&lt;/span&gt;&lt;span&gt;''&lt;/span&gt;&lt;span&gt;),
)) &lt;/span&gt;&lt;span&gt;AS&lt;/span&gt;&lt;span&gt; md5_value
&lt;/span&gt;&lt;span&gt;FROM&lt;/span&gt; t_test01
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在两个实例上执行下，然后把结果使用beyond compare对比下，就很容易找出不相同的行以及主键ID&lt;/p&gt;
&lt;p&gt;对于数据量较大的表，执行出来的结果集也很大，对比起来比较费劲，那就先尝试缩小结果集，可以将多行记录的md5值合并起来求MD5值，如果最后MD5值相同，则这些行相同，如果不同，则证明存在差异，再按照这些行进行逐行对比。&lt;/p&gt;
&lt;p&gt;假设我们按照1000行一组来进行对比，如果需要将分组后的结果合并，需要使用GROUP_CONCAT函数，注意在GROUP_CONCAT函数中添加排序保证合并数据的顺序， SQL如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;43&quot;&gt;
&lt;pre&gt;
&lt;span&gt;SELECT&lt;/span&gt;
&lt;span&gt;min&lt;/span&gt;(id) &lt;span&gt;as&lt;/span&gt;&lt;span&gt; min_id,
&lt;/span&gt;&lt;span&gt;max&lt;/span&gt;(id) &lt;span&gt;as&lt;/span&gt;&lt;span&gt; max_id,
&lt;/span&gt;&lt;span&gt;count&lt;/span&gt;(&lt;span&gt;1&lt;/span&gt;) &lt;span&gt;as&lt;/span&gt;&lt;span&gt; row_count,
MD5(GROUP_CONCAT(
MD5(CONCAT(
IFNULL(id,&lt;/span&gt;&lt;span&gt;''&lt;/span&gt;&lt;span&gt;),
IFNULL(c1,&lt;/span&gt;&lt;span&gt;''&lt;/span&gt;&lt;span&gt;),
IFNULL(c2,&lt;/span&gt;&lt;span&gt;''&lt;/span&gt;&lt;span&gt;),
)) &lt;/span&gt;&lt;span&gt;ORDER&lt;/span&gt; &lt;span&gt;BY&lt;/span&gt;&lt;span&gt; id
))&lt;/span&gt;&lt;span&gt;AS&lt;/span&gt;&lt;span&gt; md5_value
&lt;/span&gt;&lt;span&gt;FROM&lt;/span&gt;&lt;span&gt; t_test01
&lt;/span&gt;&lt;span&gt;GROUP&lt;/span&gt; &lt;span&gt;BY&lt;/span&gt; (id div &lt;span&gt;1000&lt;/span&gt;)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;执行结果为：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;min_id    max_id    row_count    md5_value
&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;        &lt;span&gt;999&lt;/span&gt;        &lt;span&gt;1000&lt;/span&gt;&lt;span&gt;         7d49def23611f610849ef559677fec0c
&lt;/span&gt;&lt;span&gt;1000&lt;/span&gt;     &lt;span&gt;1999&lt;/span&gt;       &lt;span&gt;1000&lt;/span&gt;&lt;span&gt;         95d61931aa5d3b48f1e38b3550daee08
&lt;/span&gt;&lt;span&gt;2000&lt;/span&gt;     &lt;span&gt;2999&lt;/span&gt;       &lt;span&gt;1000&lt;/span&gt;&lt;span&gt;         b02612548fae8a4455418365b3ae611a
&lt;/span&gt;&lt;span&gt;3000&lt;/span&gt;     &lt;span&gt;3999&lt;/span&gt;       &lt;span&gt;1000&lt;/span&gt;         fe798602ab9dd1c69b36a0da568b6dbb 
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;当差异数据较少时，即使需要对比上千万数据，我们可以轻松根据根据min_id和max_id来快速定位到哪1000条数据里存在差异，再进行逐行MD5值对比，最终找到差异行。&lt;/p&gt;
&lt;p&gt;最终对比图：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/174228/201802/174228-20180204222348264-500089810.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;##=====================================================================##&lt;/p&gt;
&lt;p&gt;PS:&lt;/p&gt;
&lt;p&gt;在使用GROUP_CONCAT时，需要配置MySQL变量&lt;a class=&quot;link&quot; href=&quot;https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_group_concat_max_len&quot;&gt;&lt;code class=&quot;literal&quot;&gt;group_concat_max_len&lt;/code&gt;&lt;/a&gt;，默认值为1024，超出部分会被阶段。&lt;/p&gt;
&lt;p&gt;参考链接：https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html&lt;/p&gt;
&lt;p&gt;##=====================================================================##&lt;/p&gt;
&lt;p&gt;提前祝各位春节快乐&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/174228/201802/174228-20180204223210357-1863163964.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

</description>
<pubDate>Sun, 04 Feb 2018 14:33:00 +0000</pubDate>
<dc:creator>笑东风</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/TeyGao/p/8414657.html</dc:identifier>
</item>
<item>
<title>Databricks缓存提升Spark性能--为什么NVMe固态硬盘能够提升10倍缓存性能（原创翻译） - shishanyuan</title>
<link>http://www.cnblogs.com/shishanyuan/p/8414582.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/shishanyuan/p/8414582.html</guid>
<description>&lt;p&gt;&lt;span&gt;我们兴奋的宣布Databricks缓存的通用可用性，作为统一分析平台一部分的 Databricks 运行时特性，它可以将Spark工作负载的扫描速度提升10倍，并且这种改变无需任何代码修改。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1、在本博客中，我们将介绍这个新特性的两个主要特点：易用性和性能。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2、不同于Spark显示缓存，Databricks缓存能够自动地为用户缓存热输入数据，并且在集群中负载均衡。&lt;/span&gt;&lt;span&gt;利用NVMe SSD硬件的先进性能和最先进的压缩技术，它能够将交互式和报告工作的负载性能提升10倍。更重要的是它缓存的数据量是Spark的缓存数量的30多倍。&lt;/span&gt;&lt;/p&gt;
&lt;div readability=&quot;33.283515169631&quot;&gt;

&lt;p&gt;&lt;span&gt;Spark中一个关键特性是显式缓存。它是一个多功能的工具，因为它可以用于存放任意计算结果（包括输入和中间结果），以便它们可以重复使用。例如，迭代机器学习算法的实现可以选择缓存特征化数据，并且每次迭代将从内存中读取这些数据。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;一种特别重要和广泛使用的方式就是缓存扫描操作的结果。通过这种方式可以避免用户低速率地读取远程数据。因此，许多打算重复运行相同或类似工作量的用户决定花费额外的开发时间来手动优化他们的应用程序，通过指示Spark确切缓存什么文件以及何时进行缓存，从而实现“显式缓存”。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;对于Spark缓存有如上功能，它还有一些缺点。首先，把数据保存在主内存中时，它需要占用内存空间，而这些空间能够更好用于其他用途，例如，用于Shuffle或者哈希表。其次，当数据缓存在磁盘，读取需要反序列化--该过程太慢以至于无法充分利用NVMe SSD通常所提供的高读取带宽。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;最后&lt;/span&gt;&lt;span&gt;，由于需要提前并详细指定需要缓存的数据，这个对于那些想交互地导出数据或者创建报告是一个挑战。虽然Spark缓存提供数据工程师所有调优开关，数据科学经常发现推断这些内存太困难了，特别是在多租户的设置中，工程师仍然需要尽快返回结果以保证迭代时间更短。&lt;/span&gt;&lt;/p&gt;
&lt;div readability=&quot;35.515023923445&quot;&gt;

&lt;p&gt;&lt;span&gt;固态硬盘或者SSD已经成为标准存储技术。尽管最初以其随机搜索低延迟闻名，但在过去的几年中，SSD也大幅度提供了读写吞吐量。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;NVMe接口创建用于克服SATA和ARCI设计的极限，并且允许最大可能使用现代SSD所提供出色的性能。这包括利用基于闪存存储设置的内部并行性和极低读延迟的能力。NVMe使用多种长命令队列以及其他增强功能，允许驱动器高效处理海量并发请求。这种面向并行的架构完美地补充了现代多核CPU和如Spark数据处理系统的并行线。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;通过NVMe接口，SSD比低速磁盘驱动器在属性和性能上更加接近主内存。因此它们是存储缓存数据的理想地方。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;然而为完全利用NVMe SSD的潜力，仅仅把远程数据复制到本地存储是远远不够。我们在AWS i3实例所进行的实验表明当从本地SSD读取常用文件格式时，它只是使用一部分可用的I/O带宽。&lt;/span&gt;&lt;/p&gt;
&lt;div&gt;&lt;span&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/107289/201802/107289-20180204221548435-280862096.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;上图显示了在Spark针对EC2 i3实例类型的本地NVMe SSD的I/O带宽利用率。根据图示，现有数据格式不能充分利用I/O带宽，CPU密集解码速度无法跟上SSD的速度。&lt;/span&gt;&lt;/p&gt;
&lt;div readability=&quot;36.669811320755&quot;&gt;

&lt;p&gt;&lt;span&gt;当设计Databricks缓存时，我们不仅关注于实现优化的读性能，并且关注于创建一种“自适应运行”的方案，该方案无需用户任何参与。该缓存考虑到：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1、自动选择数据缓存----无论何时访问远程文件时，该数据转码副本会立即存放到缓存中&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2、替换长时间未使用的数据----当磁盘空间不足时，缓存自动删除最近最少使用的数据&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;3、负载均衡----缓存的数据均匀地分发到集群的所有节点上，并且自动扩展和/或调整不同节点不均匀使用情况&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;4、数据安全----在缓存数据通过同样的方式与临时文件保持加密，例如Shuffle文件&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;5、数据更新----缓存能够自动发现在远程地方文件的增加和删除，并且显示数据最新的状态&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;从Databricks运行时3.3以来，在AWS i3实例类型中所有集群都预置并默认启用Databricks内存。由于这种实例类型具有较高的写入吞吐量，数据能够转码并保存在缓存中，而无需降低读取远程数据的查询性能。喜欢选择其他类型工作节点的用户可以使用Spark配置来启用缓存（请参考文档以了解更多细节）。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;对于那些需预先缓存所需要数据的用户，我们实现了CACHE SELECT命令。它将提供选择部分数据装载到缓存中。用户可以指定垂直（如：选择列）或者水平（如：满足查询条件的行）切片数据保存在缓存中。&lt;/span&gt;&lt;/p&gt;
&lt;div readability=&quot;19.840188014101&quot;&gt;

&lt;p&gt;&lt;span&gt;为了充分利用NVMe SSD，不是采取直接缓存输入的“原始数据”，而是新功能会自动将数据转换为高度优化新的临时磁盘缓存格式，该功能提供了出色的解码速度，从而获得了更佳的I/O带宽利用率。这种转码是异步操作，从而把数据加载到缓存的查询开销降低到最小。&lt;/span&gt;&lt;/p&gt;
&lt;div&gt;&lt;span&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/107289/201802/107289-20180204221649248-1168506361.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;增强读取性能（在前面所提到的通常在访问远程数据避免高延迟的能力）导致了各种查询速度取得了显著的提升。例如，在如下TPC-DS查询的子集，相对于从AWS S3读取Parquet数据，我们看到在每个简单查询都取得了持续的改进，并且在查询53中速度有5.7倍的提升。&lt;/span&gt;&lt;/p&gt;
&lt;div&gt;&lt;span&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/107289/201802/107289-20180204221719779-1006628323.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;来自于我们私人测试程序的一些客户工作中，我们看到性能有10倍的提升。&lt;/span&gt;&lt;/p&gt;
&lt;div readability=&quot;11.954363947519&quot;&gt;

&lt;p&gt;&lt;span&gt;Spark缓存和Databricks缓存可以搭配使用，事实上，它们之间相得益彰：Spark缓存提供存储任意中间计算结果数据的能力，而Databricks缓存提供了对输入数据提供自动和出色的性能。&lt;/span&gt;&lt;/p&gt;
&lt;div&gt;&lt;span&gt;&lt;img src=&quot;http://images2017.cnblogs.com/blog/107289/201802/107289-20180204221738842-526806647.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;在我们的实验中，Databricks缓存相对于Spark缓存的DISK_ONLY读模式达到了4倍的速度。对比MEMORY_ONLY模式，Databricks缓存仍然提供了3倍的加速，而且还保持了较小的内存占用。&lt;/span&gt;&lt;/p&gt;
&lt;div readability=&quot;7.1061806656101&quot;&gt;

&lt;div readability=&quot;13.73607748184&quot;&gt;
&lt;p&gt;&lt;span&gt;对于运行Databricks运行时3.3+版本的所欲AWS i3实例类型，对于所有Parquet文件缓存选择默认开启，并且缓存功能也可以与Databricks delta无缝协作。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;要在其他Azure或AWS实例类型中使用新缓存，在集群配置中需要设置如下配置参数：&lt;/span&gt;&lt;/p&gt;
&lt;div readability=&quot;7&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;1&lt;/span&gt; spark.databricks.io.cache.enabled &lt;span&gt;true&lt;/span&gt; 
&lt;span&gt;2&lt;/span&gt; spark.databricks.io.cache.maxDiskUsage &quot;{DISK SPACE PER NODE RESERVED FOR CACHED DATA}&quot; 
&lt;span&gt;3&lt;/span&gt; spark.databricks.io.cache.maxMetaDataCache &quot;{DISK SPACE PER NODE RESERVED FOR CACHED METADATA}&quot;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;结论&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div readability=&quot;11.219718309859&quot;&gt;
&lt;p&gt;&lt;span&gt;Databricks缓存为Databricks用户提供了大量好处--无论是易用性还是查询性能。它可以与Spark缓存进行混合搭配结合，使用最优的工具来完成任务。随着即将更进一步的性能提升和对其他数据格式的支持，Databricks缓存将成为各种工作负载的主要工具。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;将来，我们讲发布更多性能提升和扩展支持其他文件格式的功能。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;要尝试此新功能，请立即在我们统一分析平台选择一个i3实例类型的集群。&lt;/span&gt;&lt;/p&gt;



&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</description>
<pubDate>Sun, 04 Feb 2018 14:28:00 +0000</pubDate>
<dc:creator>shishanyuan</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/shishanyuan/p/8414582.html</dc:identifier>
</item>
<item>
<title>关系类型字段 -- Django从入门到精通系列教程 - 刘江liujiangblog.com</title>
<link>http://www.cnblogs.com/feixuelove1009/p/8414643.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/feixuelove1009/p/8414643.html</guid>
<description>&lt;h3 id=&quot;该系列教程系个人原创并完整发布在个人官网刘江的博客和教程&quot;&gt;该系列教程系个人原创，并完整发布在个人官网&lt;a href=&quot;http://www.liujiangblog.com&quot;&gt;刘江的博客和教程&lt;/a&gt;&lt;/h3&gt;
&lt;h3 id=&quot;所有转载本文者需在顶部显著位置注明原作者及www.liujiangblog.com官网地址&quot;&gt;所有转载本文者，需在顶部显著位置注明原作者及www.liujiangblog.com官网地址。&lt;/h3&gt;
&lt;h3 id=&quot;python及django学习qq群453131687&quot;&gt;Python及Django学习QQ群：453131687&lt;/h3&gt;
&lt;hr/&gt;&lt;p&gt;除了我们前面说过的普通类型字段，Django还定义了一组关系类型字段，用来表示模型与模型之间的关系。&lt;/p&gt;
&lt;h2 id=&quot;一多对一foreignkey&quot;&gt;一、多对一（ForeignKey）&lt;/h2&gt;
&lt;p&gt;多对一的关系，通常被称为外键。外键字段类的定义如下：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class ForeignKey(to, on_delete, **options)[source]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;外键需要两个位置参数，一个是关联的模型，另一个是&lt;code&gt;on_delete&lt;/code&gt;选项。实际上，在目前版本中，&lt;code&gt;on_delete&lt;/code&gt;选项也可以不设置，但Django极力反对如此，因此在Django2.0版本后，该选项会设置为必填。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;外键要定义在‘多’的一方！&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.db &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; models

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Car(models.Model):
    manufacturer &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
        &lt;span class=&quot;st&quot;&gt;'Manufacturer'&lt;/span&gt;,
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
    )
    &lt;span class=&quot;co&quot;&gt;# ...&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Manufacturer(models.Model):
    &lt;span class=&quot;co&quot;&gt;# ...&lt;/span&gt;
    &lt;span class=&quot;cf&quot;&gt;pass&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面的例子中，每辆车都会有一个生产工厂，一个工厂可以生产N辆车，于是用一个外键字段manufacturer表示，并放在Car模型中。注意，此manufacturer非彼Manufacturer模型类，它是一个字段的名称。在Django的模型定义中，经常出现类似的英文单词大小写不同，一定要注意区分！&lt;/p&gt;
&lt;p&gt;如果要关联的对象在另外一个app中，可以显式的指出。下例假设Manufacturer模型存在于production这个app中，则Car模型的定义如下：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Car(models.Model):
    manufacturer &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
        &lt;span class=&quot;st&quot;&gt;'production.Manufacturer'&lt;/span&gt;,      &lt;span class=&quot;co&quot;&gt;# 关键在这里！！&lt;/span&gt;
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
    )&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果要创建一个递归的外键，也就是自己关联自己的的外键，使用下面的方法：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;models.ForeignKey('self', on_delete=models.CASCADE)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;核心在于‘self’这个引用。什么时候需要自己引用自己的外键呢？典型的例子就是评论系统！一条评论可以被很多人继续评论，如下所示：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Comment(models.Model):
    title &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.CharField(max_length&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;128&lt;/span&gt;)
    text &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.TextField()
    parent_comment &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(&lt;span class=&quot;st&quot;&gt;'self'&lt;/span&gt;, on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE)
    &lt;span class=&quot;co&quot;&gt;# .....&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;注意上面的外键字段定义的是父评论，而不是子评论。为什么呢？因为外键要放在‘多’的一方！&lt;/p&gt;
&lt;p&gt;在实际的数据库后台，Django会为每一个外键添加&lt;code&gt;_id&lt;/code&gt;后缀，并以此创建数据表里的一列。在上面的工厂与车的例子中，Car模型对应的数据表中，会有一列叫做&lt;code&gt;manufacturer_id&lt;/code&gt;。但实际上，在Django代码中你不需要使用这个列名，除非你书写原生的SQL语句，一般我们都直接使用字段名&lt;code&gt;manufacturer&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;关系字段的定义还有个小坑。在后面我们会讲到的&lt;code&gt;verbose_name&lt;/code&gt;参数用于设置字段的别名。很多情况下，为了方便，我们都会设置这么个值，并且作为字段的第一位置参数。但是对于关系字段，其第一位置参数永远是关系对象，不能是&lt;code&gt;verbose_name&lt;/code&gt;，一定要注意！&lt;/p&gt;
&lt;h3 id=&quot;参数说明&quot;&gt;参数说明：&lt;/h3&gt;
&lt;p&gt;外键还有一些重要的参数，说明如下：&lt;/p&gt;
&lt;h3 id=&quot;on_delete&quot;&gt;on_delete&lt;/h3&gt;
&lt;p&gt;当一个被外键关联的对象被删除时，Django将模仿&lt;code&gt;on_delete&lt;/code&gt;参数定义的SQL约束执行相应操作。比如，你有一个可为空的外键，并且你想让它在关联的对象被删除时，自动设为null，可以如下定义：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;11&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;user &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
    User,
    models.SET_NULL,
    blank&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;True&lt;/span&gt;,
    null&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;va&quot;&gt;True&lt;/span&gt;,
)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;该参数可选的值都内置在&lt;code&gt;django.db.models&lt;/code&gt;中，包括：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;CASCADE：模拟SQL语言中的&lt;code&gt;ON DELETE CASCADE&lt;/code&gt;约束，将定义有外键的模型对象同时删除！（该操作为当前Django版本的默认操作！）&lt;/li&gt;
&lt;li&gt;PROTECT:阻止上面的删除操作，但是弹出&lt;code&gt;ProtectedError&lt;/code&gt;异常&lt;/li&gt;
&lt;li&gt;SET_NULL：将外键字段设为null，只有当字段设置了&lt;code&gt;null=True&lt;/code&gt;时，方可使用该值。&lt;/li&gt;
&lt;li&gt;SET_DEFAULT:将外键字段设为默认值。只有当字段设置了default参数时，方可使用。&lt;/li&gt;
&lt;li&gt;DO_NOTHING：什么也不做。&lt;/li&gt;
&lt;li&gt;SET()：设置为一个传递给SET()的值或者一个回调函数的返回值。注意大小写。&lt;/li&gt;
&lt;/ul&gt;&lt;div class=&quot;sourceCode&quot; readability=&quot;12&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.conf &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; settings
&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.contrib.auth &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; get_user_model
&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.db &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; models

&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; get_sentinel_user():
    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; get_user_model().objects.get_or_create(username&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;'deleted'&lt;/span&gt;)[&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;]

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; MyModel(models.Model):
    user &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.SET(get_sentinel_user),
    )&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;limit_choices_to&quot;&gt;limit_choices_to&lt;/h3&gt;
&lt;p&gt;该参数用于限制外键所能关联的对象，只能用于Django的ModelForm（Django的表单模块）和admin后台，对其它场合无限制功能。其值可以是一个字典、Q对象或者一个返回字典或Q对象的函数调用，如下例所示：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;11&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;staff_member &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
    User,
    on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
    limit_choices_to&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;{&lt;span class=&quot;st&quot;&gt;'is_staff'&lt;/span&gt;: &lt;span class=&quot;va&quot;&gt;True&lt;/span&gt;},
)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样定义，则ModelForm的&lt;code&gt;staff_member&lt;/code&gt;字段列表中，只会出现那些&lt;code&gt;is_staff=True&lt;/code&gt;的Users对象，这一功能对于admin后台非常有用。&lt;/p&gt;
&lt;p&gt;可以参考下面的方式，使用函数调用：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;kw&quot;&gt;def&lt;/span&gt; limit_pub_date_choices():
    &lt;span class=&quot;cf&quot;&gt;return&lt;/span&gt; {&lt;span class=&quot;st&quot;&gt;'pub_date__lte'&lt;/span&gt;: datetime.date.utcnow()}

&lt;span class=&quot;co&quot;&gt;# ...&lt;/span&gt;
limit_choices_to &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; limit_pub_date_choices
&lt;span class=&quot;co&quot;&gt;# ...&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;related_name&quot;&gt;related_name&lt;/h3&gt;
&lt;p&gt;用于关联对象反向引用模型的名称。以前面车和工厂的例子解释，就是从工厂反向关联到车的关系名称。&lt;/p&gt;
&lt;p&gt;通常情况下，这个参数我们可以不设置，Django会默认以模型的小写作为反向关联名，比如对于工厂就是&lt;code&gt;car&lt;/code&gt;，如果你觉得&lt;code&gt;car&lt;/code&gt;还不够直观，可以如下定义：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;11&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Car(models.Model):
    manufacturer &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
        &lt;span class=&quot;st&quot;&gt;'production.Manufacturer'&lt;/span&gt;,      
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
        related_name&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;'car_producted_by_this_manufacturer'&lt;/span&gt;,  &lt;span class=&quot;co&quot;&gt;# 看这里！！&lt;/span&gt;
    )&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;也许我定义了一个蹩脚的词，但表达的意思很清楚。以后从工厂对象反向关联到它所生产的汽车，就可以使用&lt;code&gt;maufacturer.car_producted_by_this_manufacturer&lt;/code&gt;了。&lt;/p&gt;
&lt;p&gt;如果你不想为外键设置一个反向关联名称，可以将这个参数设置为“+”或者以“+”结尾，如下所示：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;user &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
    User,
    on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
    related_name&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;'+'&lt;/span&gt;,
)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;related_query_name&quot;&gt;related_query_name&lt;/h3&gt;
&lt;p&gt;反向关联查询名。用于从目标模型反向过滤模型对象的名称。（过滤和查询在后续章节会介绍）&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;13&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Tag(models.Model):
    article &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
        Article,
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
        related_name&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;tags&quot;&lt;/span&gt;,
        related_query_name&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;tag&quot;&lt;/span&gt;,       &lt;span class=&quot;co&quot;&gt;# 注意这一行&lt;/span&gt;
    )
    name &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.CharField(max_length&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;255&lt;/span&gt;)

&lt;span class=&quot;co&quot;&gt;# 现在可以使用‘tag’作为查询名了&lt;/span&gt;
Article.objects.&lt;span class=&quot;bu&quot;&gt;filter&lt;/span&gt;(tag__name&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;important&quot;&lt;/span&gt;)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;to_field&quot;&gt;to_field&lt;/h3&gt;
&lt;p&gt;默认情况下，外键都是关联到被关联对象的主键上（一般为id）。如果指定这个参数，可以关联到指定的字段上，但是该字段必须具有&lt;code&gt;unique=True&lt;/code&gt;属性，也就是具有唯一属性。&lt;/p&gt;
&lt;h3 id=&quot;db_constraint&quot;&gt;db_constraint&lt;/h3&gt;
&lt;p&gt;默认情况下，这个参数被设为True，表示遵循数据库约束，这也是大多数情况下你的选择。如果设为False，那么将无法保证数据的完整性和合法性。在下面的场景中，你可能需要将它设置为False：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;有历史遗留的不合法数据，没办法的选择&lt;/li&gt;
&lt;li&gt;你正在分割数据表&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;当它为False，并且你试图访问一个不存在的关系对象时，会抛出DoesNotExist 异常。&lt;/p&gt;
&lt;h3 id=&quot;swappable&quot;&gt;swappable&lt;/h3&gt;
&lt;p&gt;控制迁移框架的动作，如果当前外键指向一个可交换的模型。使用场景非常稀少，通常请将该参数保持默认的True。&lt;/p&gt;
&lt;h2 id=&quot;二多对多manytomanyfield&quot;&gt;二、多对多（ManyToManyField）&lt;/h2&gt;
&lt;p&gt;多对多关系在数据库中也是非常常见的关系类型。比如一本书可以有好几个作者，一个作者也可以写好几本书。多对多的字段可以定义在任何的一方，请尽量定义在符合人们思维习惯的一方，但不要同时都定义。&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class ManyToManyField(to, **options)[source]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;多对多关系需要一个位置参数：关联的对象模型。它的用法和外键多对一基本类似。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;在数据库后台，Django实际上会额外创建一张用于体现多对多关系的中间表&lt;/strong&gt;。默认情况下，该表的名称是“多对多字段名+关联对象模型名+一个独一无二的哈希码”，例如‘author_books_9cdf4’，当然你也可以通过&lt;code&gt;db_table&lt;/code&gt;选项，自定义表名。&lt;/p&gt;
&lt;h3 id=&quot;参数说明-1&quot;&gt;参数说明：&lt;/h3&gt;
&lt;h3 id=&quot;related_name-1&quot;&gt;related_name&lt;/h3&gt;
&lt;p&gt;参考外键的相同参数。&lt;/p&gt;
&lt;h3 id=&quot;related_query_name-1&quot;&gt;related_query_name&lt;/h3&gt;
&lt;p&gt;参考外键的相同参数。&lt;/p&gt;
&lt;h3 id=&quot;limit_choices_to-1&quot;&gt;limit_choices_to&lt;/h3&gt;
&lt;p&gt;参考外键的相同参数。但是对于使用&lt;code&gt;through&lt;/code&gt;参数自定义中间表的多对多字段无效。&lt;/p&gt;
&lt;h3 id=&quot;symmetrical&quot;&gt;symmetrical&lt;/h3&gt;
&lt;p&gt;默认情况下，Django中的多对多关系是对称的。看下面的例子：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.db &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; models

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Person(models.Model):
    friends &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ManyToManyField(&lt;span class=&quot;st&quot;&gt;&quot;self&quot;&lt;/span&gt;)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Django认为，如果我是你的朋友，那么你也是我的朋友，这是一种对称关系，Django不会为Person模型添加&lt;code&gt;person_set&lt;/code&gt;属性用于反向关联。如果你不想使用这种对称关系，可以将symmetrical设置为False，这将强制Django为反向关联添加描述符。&lt;/p&gt;
&lt;h3 id=&quot;through&quot;&gt;through&lt;/h3&gt;
&lt;h3 id=&quot;定义中间表&quot;&gt;（定义中间表）&lt;/h3&gt;
&lt;p&gt;如果你想自定义多对多关系的那张额外的关联表，可以使用这个参数！参数的值为一个中间模型。&lt;/p&gt;
&lt;p&gt;最常见的使用场景是你需要为多对多关系添加额外的数据，比如两个人建立QQ好友的时间。&lt;/p&gt;
&lt;p&gt;通常情况下，这张表在数据库内的结构是这个样子的：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;中间表的id列....模型对象的id列.....被关联对象的id列
# 各行数据&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;如果自定义中间表并添加时间字段，则在数据库内的表结构如下：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;中间表的id列....模型对象的id列.....被关联对象的id列.....时间对象列
# 各行数据&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;看下面的例子：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;19&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.db &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; models

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Person(models.Model):
    name &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.CharField(max_length&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;50&lt;/span&gt;)

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Group(models.Model):
    name &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.CharField(max_length&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;128&lt;/span&gt;)
    members &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ManyToManyField(
        Person,
        through&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;'Membership'&lt;/span&gt;,       &lt;span class=&quot;co&quot;&gt;## 自定义中间表&lt;/span&gt;
        through_fields&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;'group'&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;'person'&lt;/span&gt;),
    )

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; Membership(models.Model):  &lt;span class=&quot;co&quot;&gt;# 这就是具体的中间表模型&lt;/span&gt;
    group &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(Group, on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE)
    person &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(Person, on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE)
    inviter &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.ForeignKey(
        Person,
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
        related_name&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;membership_invites&quot;&lt;/span&gt;,
    )
    invite_reason &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.CharField(max_length&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;dv&quot;&gt;64&lt;/span&gt;)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;上面的代码中，通过&lt;code&gt;class Membership(models.Model)&lt;/code&gt;定义了一个新的模型，用来保存Person和Group模型的多对多关系，并且同时增加了‘邀请人’和‘邀请时间’的字段。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;through参数在某些使用场景中是必须的，至关重要，请务必掌握！&lt;/strong&gt;&lt;/p&gt;
&lt;h3 id=&quot;through_fields&quot;&gt;through_fields&lt;/h3&gt;
&lt;p&gt;接着上面的例子。Membership模型中包含两个关联Person的外键，Django无法确定到底使用哪个作为和Group关联的对象。所以，在这个例子中，必须显式的指定&lt;code&gt;through_fields&lt;/code&gt;参数，用于定义关系。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;through_fields&lt;/code&gt;参数接收一个二元元组('field1', 'field2')，field1是指向定义有多对多关系的模型的外键字段的名称，这里是Membership中的‘group’字段（注意大小写），另外一个则是指向目标模型的外键字段的名称，这里是Membership中的‘person’，而不是‘inviter’。&lt;/p&gt;
&lt;p&gt;再通俗的说，就是&lt;code&gt;through_fields&lt;/code&gt;参数指定从中间表模型Membership中选择哪两个字段，作为关系连接字段。&lt;/p&gt;
&lt;h3 id=&quot;db_table&quot;&gt;db_table&lt;/h3&gt;
&lt;p&gt;设置中间表的名称。不指定的话，则使用默认值。&lt;/p&gt;
&lt;h3 id=&quot;db_constraint-1&quot;&gt;db_constraint&lt;/h3&gt;
&lt;p&gt;参考外键的相同参数。&lt;/p&gt;
&lt;h3 id=&quot;swappable-1&quot;&gt;swappable&lt;/h3&gt;
&lt;p&gt;参考外键的相同参数。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ManyToManyField多对多字段不支持Django内置的validators验证功能。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;null参数对ManyToManyField多对多字段无效！设置null=True毫无意义&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;三一对一onetoonefield&quot;&gt;三、一对一（OneToOneField）&lt;/h2&gt;
&lt;p&gt;一对一关系类型的定义如下：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class OneToOneField(to, on_delete, parent_link=False, **options)[source]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;从概念上讲，一对一关系非常类似具有&lt;code&gt;unique=True&lt;/code&gt;属性的外键关系，但是反向关联对象只有一个。这种关系类型多数用于当一个模型需要从别的模型扩展而来的情况。比如，Django自带auth模块的User用户表，如果你想在自己的项目里创建用户模型，又想方便的使用Django的认证功能，那么一个比较好的方案就是在你的用户模型里，使用一对一关系，添加一个与auth模块User模型的关联字段。&lt;/p&gt;
&lt;p&gt;该关系的第一位置参数为关联的模型，其用法和前面的多对一外键一样。&lt;/p&gt;
&lt;p&gt;如果你没有给一对一关系设置&lt;code&gt;related_name&lt;/code&gt;参数，Django将使用当前模型的小写名作为默认值。&lt;/p&gt;
&lt;p&gt;看下面的例子：&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;15&quot;&gt;
&lt;pre class=&quot;sourceCode python&quot;&gt;
&lt;code class=&quot;sourceCode python&quot;&gt;&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.conf &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; settings
&lt;span class=&quot;im&quot;&gt;from&lt;/span&gt; django.db &lt;span class=&quot;im&quot;&gt;import&lt;/span&gt; models

&lt;span class=&quot;co&quot;&gt;# 两个字段都使用一对一关联到了Django内置的auth模块中的User模型&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; MySpecialUser(models.Model):
    user &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
    )
    supervisor &lt;span class=&quot;op&quot;&gt;=&lt;/span&gt; models.OneToOneField(
        settings.AUTH_USER_MODEL,
        on_delete&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;models.CASCADE,
        related_name&lt;span class=&quot;op&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;'supervisor_of'&lt;/span&gt;,
    )&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这样下来，你的User模型将拥有下面的属性：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;gt;&amp;gt;&amp;gt; user = User.objects.get(pk=1)
&amp;gt;&amp;gt;&amp;gt; hasattr(user, 'myspecialuser')
True
&amp;gt;&amp;gt;&amp;gt; hasattr(user, 'supervisor_of')
True&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;OneToOneField一对一关系拥有和多对一外键关系一样的额外可选参数，只是多了一个parent_link参数。&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;跨模块的模型：&lt;/p&gt;
&lt;p&gt;有时候，我们关联的模型并不在当前模型的文件内，没关系，就像我们导入第三方库一样的从别的模块内导入进来就好，如下例所示：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;from django.db import models
from geography.models import ZipCode

class Restaurant(models.Model):
    # ...
    zip_code = models.ForeignKey(
        ZipCode,
        on_delete=models.SET_NULL,
        blank=True,
        null=True,
    )&lt;/code&gt;
&lt;/pre&gt;</description>
<pubDate>Sun, 04 Feb 2018 14:27:00 +0000</pubDate>
<dc:creator>刘江liujiangblog.com</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/feixuelove1009/p/8414643.html</dc:identifier>
</item>
<item>
<title>Mysql Innodb 锁机制 - magicsoar</title>
<link>http://www.cnblogs.com/magicsoar/p/8414638.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/magicsoar/p/8414638.html</guid>
<description>&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;latch 可以认为是应用程序中的锁，可以称为闩锁(轻量级的锁) 因为其要求锁定的时间必须要非常短，若持续时间长，则会导致应用性能非常差，在InnoDB存储引擎中，latch又可以分为mutex(互斥锁)和rwlock(读写锁)，其目的用来保证并发线程操作临界资源的正确性，并且没有死锁检测的机制&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p4&quot;&gt; &lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;在InnoDB存储引擎中的latch，可以通过命令SHOW ENGINE INNODB MUTEX 来进行查看&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;mysql &amp;gt; SHOW ENGINE INNODB MUTEX;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p5&quot;&gt; &lt;/p&gt;
&lt;p class=&quot;p6&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;img title=&quot;NewImage.png&quot; src=&quot;https://images2017.cnblogs.com/blog/412433/201801/412433-20180131172637609-1410694331.png&quot; alt=&quot;NewImage&quot; width=&quot;600&quot; height=&quot;518&quot; border=&quot;0&quot;/&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p4&quot;&gt; &lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;lock可以认为是数据库提供的锁，用来锁定的是数据库中的数据。并且一般lock对象仅在事务commit或rollback后进行释放(不同事务隔离级别释放的时间可能不同)，lock是有死锁机制的。&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;在InnoDB存储引擎中的lock 可以通过show engine innodb status，information_schema.INNODB_LOCKS，INNODB_TRX,INNODB_LOCK_WATIS信息来查看&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p4&quot;&gt;&lt;img title=&quot;NewImage.png&quot; src=&quot;https://images2017.cnblogs.com/blog/412433/201801/412433-20180131172648218-448544097.png&quot; alt=&quot;NewImage&quot; width=&quot;600&quot; height=&quot;66&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;线程获取lock的流程:&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;在对数据加lock的时候会先对数据所在的页面添加latch,然后再对数据添加lock,添加完lock后再释放页面的Latch。&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;这种机制主要是为了保证线程获取的行数据的一致性和完整性.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;如果lock被其他的线程占有,线程先释放页面latch,等待lock,待获取lock后会再次对页面添加latch,查看页面数据是否有改动,然后尝试再次获取对应的lock&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;

&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;innodb储存引擎提供了如下两种标准的行级锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;共享锁(S)&lt;/strong&gt; 允许一个事务去读一行&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;排他锁(X)&lt;/strong&gt; 允许获得排他锁的事务更新或删除数据&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;同时innodb储存引擎支持多粒度锁定，为了支持在不同的粒度上进行加锁操作，innodb支持另一种额外的锁方式，称之为意向锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p4&quot;&gt; &lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;意向共享锁(IS)  &lt;/strong&gt;事务想要获得一张表中某几行的共享锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;意向排他锁(IX）&lt;/strong&gt;事务想要获得一张表中某几行的排他锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;在行锁的实现上&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;mysql提供了三种的行锁的算法&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;分别是&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;Record Lock&lt;/strong&gt; 记录锁，单个记录上的锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;Gap Lock&lt;/strong&gt; 间隙锁，锁定一个范围，但不包含记录本身&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;Next-key Lock&lt;/strong&gt; Gap Lock + Record Lock 锁定一个范围，并且锁定记录本身&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;

&lt;p class=&quot;p7&quot;&gt;&lt;strong&gt;非特殊注明 默认在RR隔离级别下进行讨论&lt;/strong&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;InnoDb的行锁是对索引加锁的，对扫描的行边扫描边加锁，如果走的是二级索引(非聚簇索引)除了需要对二级索引加锁外，还需要根据二级索引里面的主键信息扫描主键的聚簇索引，对主键加锁,&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;加锁的数据行数会受到Mysql是否支持Index Condition PushDown而影响（Mysql 5.6支持ICP），加锁的数量可能远远大于满足条件的记录数量&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;这里需要加两次锁的原因是&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;如果&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;语句A 使用二级索引对记录X进行更新操作，&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;语句B使用聚簇索引对记录X进行更新操作，&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;如果A仅对二级索引进行加锁，那么并发的语句B将感受不到语句A的存在，违背了同一条记录上的更新/删除必须串行执行的约束&lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;mysqlinnodb锁机制--孙高飞-select*fromtablewhere?&quot; class=&quot;p8&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;select * from table where?&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;RC级别下 ： 无需加锁，一致性非锁定读，使用快照读，读取被锁定行的最新一份数据，因此会出现前后读取数据不一致的情况&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;RR级别下：无需加锁，一致性非锁定读，使用快照读，读取事务开始时的行数据版本，因此前后读到的数据是一样的&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;Serializable级别下：使用当前读，需要加锁，innodb内部将select语句转换为了select … lock in share mode&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;mysqlinnodb锁机制--孙高飞-insert?&quot; class=&quot;p2&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;insert?&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert会对插入成功的行加上记录锁，不会阻止其他并发的事务往这条记录之前插入记录。在插入之前，会先在插入记录所在的间隙加上一个插入意向意向锁（并发的事务可以对同一个间隙加插入意向锁锁)。如果insert 的事务出现了duplicate-key error ，事务会对duplicate index record的记录加共享锁。这个共享锁在并发的情况下是会产生死锁的，比如有两个并发的insert都对要对同一条记录加共享锁，而此时这条记录又被其他事务加上了排它锁，排它锁的事务将这条记录删除后，两个并发的insert操作会发生死锁。&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p9&quot;&gt; &lt;/p&gt;
&lt;h2 id=&quot;mysqlinnodb锁机制--孙高飞-delete?&quot; class=&quot;p2&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;delete?&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;delete操作仅是将主键列中对对应的记录delete flag设置为1，记录并没有被删除，还是存在于B+树中&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;真正的删除操作被延迟了，最终在purge操作中完成&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;延迟到purge操作的原因是的innodb支持mvcc多版本控制，所以记录不能在事务提交时立即进行删除，只有当对应的行记录不被任何其他事务引用的时候，才可以由purge进行真正的删除&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;delete操作过程中：&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p10&quot;&gt;&lt;span class=&quot;s1&quot;&gt;找到满足条件的记录，并且记录有效&lt;/span&gt;&lt;span class=&quot;s3&quot;&gt;，则对记录加X锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s4&quot;&gt;找到满足条件的记录，但是记录无效&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;(标识为删除)，则对记录加next key锁、;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s4&quot;&gt;未找到满足条件的记录&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;，则对第一个不满足条件的记录加Gap锁，保证没有满足条件的记录插入；&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;mysqlinnodb锁机制--孙高飞-update?&quot; class=&quot;p2&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;update?&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;对满足条件的记录next-key锁，如果是等值匹配并且使用唯一索引或是聚簇索引，那么可以只添加记录锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p11&quot;&gt;&lt;span class=&quot;s1&quot;&gt;唯一索引中含NULL值的记录，将不会添加记录锁，转而为next-key锁 因为NULL不等于NULL，NULL和任何值比较均返回NULL，包括NULL本身，但是 NULL is NULL&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p12&quot;&gt; &lt;/p&gt;

&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;create table `deadlocktest`&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;(&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;`id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;`a` bigint(20) unsigned NOT NULL,&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;`b` bigint(20) unsigned NOT NULL,&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;`c` bigint(20) unsigned NOT NULL,&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;`d` bigint(20) unsigned NOT NULL,&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;`e` bigint(20) unsigned NOT NULL,&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;PRIMARY KEY(`id`),&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;UNIQUE KEY `I_a`(`a`),&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;KEY `I_b` (`b`),&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;KEY `I_c` (`c`)&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;)ENGINE=InnoDb ;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(1,999,3,4,5);&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(2,998,4,5,6);&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(3,997,4,5,6);&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(4,996,3,4,5);&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;...&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(1000,1,3,4,5);&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;mysqlinnodb锁机制--孙高飞-3个insert的死锁&quot; class=&quot;p13&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;3个insert的死锁&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;table-wrap&quot;&gt;
&lt;table class=&quot;confluenceTable&quot;&gt;&lt;tbody readability=&quot;16&quot;&gt;&lt;tr&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p14&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;事务A&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p14&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;事务B&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p14&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;事务C&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;begin;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;begin;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;begin;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;15&quot;&gt;&lt;td class=&quot;confluenceTd&quot; readability=&quot;13&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(4,996,3,4,5);&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;15&quot;&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; readability=&quot;13&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(4,996,3,4,5);&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;15&quot;&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; readability=&quot;13&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;insert into deadlocktest (a,b,c,d,e)values(4,996,3,4,5);&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;rollback;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;1 row affected&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; readability=&quot;5&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;Deadlock found when trying to get lock; try restarting transaction&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;

&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;事务A 获得排他锁，插入数据成功&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;事务B 事务C，因为记录duplicate-key error转而持有行的共享锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p3&quot;&gt;&lt;span class=&quot;s1&quot;&gt;事务A回滚，释放了持有的排他锁，事务B和事务C需要获得该行的排他锁，但是由于互相都持有对应行的共享锁，互相等待，造成死锁&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;h2 id=&quot;mysqlinnodb锁机制--孙高飞-2个update的死锁&quot; class=&quot;p13&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;2个update的死锁&lt;/strong&gt;&lt;/span&gt;&lt;/h2&gt;
&lt;div class=&quot;table-wrap&quot;&gt;
&lt;table class=&quot;confluenceTable&quot;&gt;&lt;tbody readability=&quot;4&quot;&gt;&lt;tr&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p14&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;事务A&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p14&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;事务B&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;begin;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;begin;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td class=&quot;confluenceTd&quot; readability=&quot;5&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;update deadlocktest force index(I_b) set e = sleep(5) where b&amp;gt;0;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; readability=&quot;5&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;update deadlocktest force index(I_c) set e = sleep(5) where c&amp;gt;2;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;6&quot;&gt;&lt;td class=&quot;confluenceTd&quot; readability=&quot;5&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;Deadlock found when trying to get lock; try restarting transaction&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; readability=&quot;5&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;Rows matched: 4  Changed: 4  Warnings: 0&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;两个update事务，加锁顺序不一样导致的死锁&lt;/p&gt;
&lt;p&gt;InnoDb的行锁是对索引加锁的，对扫描的行边扫描边加锁，如果走的是二级索引(非聚簇索引)除了需要对二级索引加锁外，还需要根据二级索引里面的主键信息扫描主键的聚簇索引，对主键加锁&lt;/p&gt;
&lt;h2 id=&quot;mysqlinnodb锁机制--孙高飞-3个以上delete的死锁&quot; class=&quot;p13&quot;&gt;&lt;strong&gt;3个以上delete的死锁&lt;/strong&gt;&lt;/h2&gt;
&lt;div class=&quot;table-wrap&quot;&gt;
&lt;table class=&quot;confluenceTable&quot;&gt;&lt;tbody readability=&quot;4&quot;&gt;&lt;tr&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p14&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;事务A&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p14&quot;&gt;&lt;span class=&quot;s1&quot;&gt;&lt;strong&gt;事务B&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot;&gt;&lt;strong&gt;事务B&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;begin;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt;begin;&lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot;&gt; begin&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td class=&quot;confluenceTd&quot; readability=&quot;5&quot;&gt;
&lt;p&gt;delete from deadlocktest where a=550&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot;&gt; &lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; readability=&quot;5&quot;&gt;
&lt;p&gt;delete from deadlocktest where a=550&lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot;&gt; &lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td class=&quot;confluenceTd&quot;&gt; &lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot;&gt;
&lt;p class=&quot;p7&quot;&gt; &lt;/p&gt;
&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot; readability=&quot;5&quot;&gt; 
&lt;p&gt;delete from deadlocktest where a=550&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot;&gt;commit；&lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot;&gt;0 rows affected &lt;/td&gt;
&lt;td class=&quot;confluenceTd&quot; colspan=&quot;1&quot;&gt;Deadlock found when trying to get lock; try restarting transaction&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;
&lt;p&gt;delete操作仅是将主键列中对对应的记录delete flag设置为1，实际的删除延迟到purge中&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;s4&quot;&gt;delete删除时如果找到满足条件的记录，但是记录无效&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;(标识为删除)，则对记录加next key锁、;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;死锁日志&lt;/p&gt;
&lt;p&gt;&lt;img title=&quot;NewImage.png&quot; src=&quot;https://images2017.cnblogs.com/blog/412433/201801/412433-20180131172711937-552729379.png&quot; alt=&quot;NewImage&quot; width=&quot;600&quot; height=&quot;286&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;
&lt;p&gt;3个delete的死锁比较难以复现，我是利用如下脚本完成的&lt;/p&gt;
&lt;p&gt;MY_DB=&quot;mysql -hxxx -Pxxx -uxxx -pxxx&quot;&lt;/p&gt;
&lt;p&gt;while :&lt;br/&gt;do&lt;br/&gt;echo &quot;use test;begin; delete from deadlocktest where a=499;rollback;&quot; | $MY_DB&lt;br/&gt;done&lt;/p&gt;
&lt;p&gt;该类delete死锁的出现条件&lt;/p&gt;
&lt;p&gt;1、针对唯一索引上等值查询的删除&lt;/p&gt;
&lt;p&gt;2、有3个以上并发删除操作&lt;/p&gt;
&lt;p&gt;3、事务的隔离级别是RR&lt;/p&gt;
&lt;p&gt;4、INNODB储存引擎&lt;/p&gt;


&lt;p class=&quot;p16&quot;&gt;&lt;span class=&quot;s5&quot;&gt;&lt;a class=&quot;external-link&quot; href=&quot;https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html&quot; rel=&quot;nofollow&quot;&gt;https://dev.mysql.com/doc/refman/5.7/en/innodb-locks-set.html&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p16&quot;&gt;&lt;span class=&quot;s5&quot;&gt;&lt;a class=&quot;external-link&quot; href=&quot;http://hedengcheng.com/?p=771#_Toc374698320&quot; rel=&quot;nofollow&quot;&gt;http://hedengcheng.com/?p=771#_Toc374698320&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p16&quot;&gt;&lt;span class=&quot;s5&quot;&gt;&lt;a class=&quot;external-link&quot; href=&quot;http://hedengcheng.com/?p=844&quot; rel=&quot;nofollow&quot;&gt;http://hedengcheng.com/?p=844&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;p1&quot;&gt;&lt;span class=&quot;s1&quot;&gt; &lt;/span&gt;&lt;/p&gt;
</description>
<pubDate>Sun, 04 Feb 2018 14:24:00 +0000</pubDate>
<dc:creator>magicsoar</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/magicsoar/p/8414638.html</dc:identifier>
</item>
<item>
<title>Android webView包装WebAPP - Grewer</title>
<link>http://www.cnblogs.com/Grewer/p/8414629.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/Grewer/p/8414629.html</guid>
<description>&lt;blockquote readability=&quot;16&quot;&gt;
&lt;p&gt;前言 Android webView 兼容体验真的差到了极点!!&lt;br/&gt;前一阵子,老板要将 WebAPP 放到 Android 和 iOS 里面,而我因为以前做过安卓,所以这方面就由我来打包,&lt;br/&gt;原理是很简单的,就是打开 APP 的时候用 webView 加载网站的网址,这样服务器一次更新,就能更新微信版, iOS 版和 Android 版;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;首先我要说一句,如果你的 WebAPP 里面有文件上传,并且想要完全兼容,那么就别用原生的 WebAPP, 后面我会写一个关于 crossWalk 的博客,不过在此之前,我先记录下我所经历的一些坑,我的工具使用的是 Android studio;&lt;/p&gt;
&lt;p&gt;创建一个项目,这个我就不说了,网上很多教程;&lt;/p&gt;
&lt;p&gt;首先在 app/src/main/AndroidManifest.xml 里添加权限:&lt;br/&gt;&lt;strong&gt;注意本文代码中的&quot;...&quot;都代表省略的代码&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode java&quot;&gt;
&lt;code class=&quot;sourceCode java&quot;&gt;&amp;lt;manifest ...&amp;gt;
    &amp;lt;uses-permission android:name=&lt;span class=&quot;st&quot;&gt;&quot;android.permission.INTERNET&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;uses-permission android:name=&lt;span class=&quot;st&quot;&gt;&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;uses-permission android:name=&lt;span class=&quot;st&quot;&gt;&quot;android.permission.READ_EXTERNAL_STORAGE&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;application
           ...
    &amp;lt;/application&amp;gt;
&amp;lt;/manifest&amp;gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;第一个是允许访问网络连接;&lt;/li&gt;
&lt;li&gt;第二个是允许程序写入外部存储，如SD卡上写文件;&lt;/li&gt;
&lt;li&gt;第三个是允许应用程序从外部存储读取;&lt;/li&gt;
&lt;/ul&gt;&lt;hr/&gt;&lt;p&gt;再是 app/src/main/res/layout/activity_main.xml 添加:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode xml&quot;&gt;
&lt;code class=&quot;sourceCode xml&quot;&gt; &lt;span class=&quot;kw&quot;&gt;&amp;lt;WebView&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        android:id=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;@+id/local_webview&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        android:layout_width=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;match_parent&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        android:layout_height=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;match_parent&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        android:visibility=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;gone&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;MainActivety.java:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;25&quot;&gt;
&lt;pre class=&quot;sourceCode java&quot;&gt;
&lt;code class=&quot;sourceCode java&quot;&gt;&lt;span class=&quot;kw&quot;&gt;private&lt;/span&gt; WebView webview;
&lt;span class=&quot;co&quot;&gt;//...&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;onCreate&lt;/span&gt;(Bundle savedInstanceState) {
    &lt;span class=&quot;kw&quot;&gt;super&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;onCreate&lt;/span&gt;(savedInstanceState);
    &lt;span class=&quot;fu&quot;&gt;setContentView&lt;/span&gt;(R.&lt;span class=&quot;fu&quot;&gt;layout&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;activity_main&lt;/span&gt;);
    &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (Build.&lt;span class=&quot;fu&quot;&gt;VERSION&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;SDK_INT&lt;/span&gt; &amp;gt;= Build.&lt;span class=&quot;fu&quot;&gt;VERSION_CODES&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;KITKAT&lt;/span&gt;) {
        WebView.&lt;span class=&quot;fu&quot;&gt;setWebContentsDebuggingEnabled&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);
    }

    webview = &lt;span class=&quot;fu&quot;&gt;findViewById&lt;/span&gt;(R.&lt;span class=&quot;fu&quot;&gt;id&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;local_webview&lt;/span&gt;);

    WebSettings settings = webview.&lt;span class=&quot;fu&quot;&gt;getSettings&lt;/span&gt;();

    loading = &lt;span class=&quot;fu&quot;&gt;findViewById&lt;/span&gt;(R.&lt;span class=&quot;fu&quot;&gt;id&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;loadView&lt;/span&gt;);

    settings.&lt;span class=&quot;fu&quot;&gt;setJavaScriptEnabled&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//必须&lt;/span&gt;

    settings.&lt;span class=&quot;fu&quot;&gt;setCacheMode&lt;/span&gt;(WebSettings.&lt;span class=&quot;fu&quot;&gt;LOAD_DEFAULT&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//关闭webview中缓存&lt;/span&gt;
    settings.&lt;span class=&quot;fu&quot;&gt;setRenderPriority&lt;/span&gt;(WebSettings.&lt;span class=&quot;fu&quot;&gt;RenderPriority&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;HIGH&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//提高渲染的优先级&lt;/span&gt;
    settings.&lt;span class=&quot;fu&quot;&gt;setUseWideViewPort&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//WebView是否支持HTML的“viewport”标签或者使用wide viewport。&lt;/span&gt;
    settings.&lt;span class=&quot;fu&quot;&gt;setAllowContentAccess&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//是否允许在WebView中访问内容URL&lt;/span&gt;
    settings.&lt;span class=&quot;fu&quot;&gt;setBuiltInZoomControls&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//是否使用其内置的变焦机制&lt;/span&gt;
    settings.&lt;span class=&quot;fu&quot;&gt;setJavaScriptCanOpenWindowsAutomatically&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//是否允许自动打开弹窗&lt;/span&gt;
    settings.&lt;span class=&quot;fu&quot;&gt;setDomStorageEnabled&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);&lt;span class=&quot;co&quot;&gt;//是否开启DOM存储API权限&lt;/span&gt;

    webview.&lt;span class=&quot;fu&quot;&gt;loadUrl&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;http://www.baidu.com&quot;&lt;/span&gt;);

    webview.&lt;span class=&quot;fu&quot;&gt;setWebChromeClient&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;WebChromeClient&lt;/span&gt;() {
        &lt;span class=&quot;fu&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;onProgressChanged&lt;/span&gt;(WebView view, &lt;span class=&quot;dt&quot;&gt;int&lt;/span&gt; newProgress) {
            Log.&lt;span class=&quot;fu&quot;&gt;d&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;加载&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;on page progress changed and progress is &quot;&lt;/span&gt; + newProgress);
            &lt;span class=&quot;co&quot;&gt;//...&lt;/span&gt;
        }

    }
    
    webview.&lt;span class=&quot;fu&quot;&gt;setWebViewClient&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;WebViewClient&lt;/span&gt;() {
        &lt;span class=&quot;fu&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;onReceivedError&lt;/span&gt;(WebView view, &lt;span class=&quot;dt&quot;&gt;int&lt;/span&gt; errorCode, String description, String failingUrl) {
            &lt;span class=&quot;kw&quot;&gt;super&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;onReceivedError&lt;/span&gt;(view, errorCode, description, failingUrl);
                    &lt;span class=&quot;co&quot;&gt;// 加载网页失败时处理  如：&lt;/span&gt;
            view.&lt;span class=&quot;fu&quot;&gt;loadDataWithBaseURL&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;,
                &lt;span class=&quot;st&quot;&gt;&quot;&amp;lt;span&amp;gt;页面加载失败,请确认网络是否连接&amp;lt;/span&amp;gt;&quot;&lt;/span&gt;,
                &lt;span class=&quot;st&quot;&gt;&quot;text/html&quot;&lt;/span&gt;,
                &lt;span class=&quot;st&quot;&gt;&quot;utf-8&quot;&lt;/span&gt;,
                &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;);
        }

        &lt;span class=&quot;fu&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;onPageFinished&lt;/span&gt;(WebView view, String url) {
            &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (!webview.&lt;span class=&quot;fu&quot;&gt;getSettings&lt;/span&gt;().&lt;span class=&quot;fu&quot;&gt;getLoadsImagesAutomatically&lt;/span&gt;()) {
                webview.&lt;span class=&quot;fu&quot;&gt;getSettings&lt;/span&gt;().&lt;span class=&quot;fu&quot;&gt;setLoadsImagesAutomatically&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;);
            }
            Log.&lt;span class=&quot;fu&quot;&gt;d&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;加载&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;end &quot;&lt;/span&gt;);
        }

    });

}&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这是一个比较简单的 webView 例子,这里有几点需要说下:&lt;/p&gt;
&lt;ol readability=&quot;14&quot;&gt;&lt;li readability=&quot;7&quot;&gt;
&lt;p&gt;关于WebSettings:&lt;br/&gt;1.1 需要运行 js 的网页都需要此设置:&lt;code&gt;setJavaScriptEnabled&lt;/code&gt;&lt;br/&gt;1.2 关于&lt;code&gt;setCacheMode&lt;/code&gt;,尽量不要设置 &lt;code&gt;LOAD_CACHE_ONLY&lt;/code&gt; 该值,设置这个值会在 webkit 类型浏览器对短时间内的 ajax 访问产生&lt;code&gt;Provisional headers are shown&lt;/code&gt;问题;&lt;br/&gt;1.3 关于 &lt;code&gt;AllowFileAccess&lt;/code&gt; 一般默认值就好,都开了会有安全上的问题;&lt;br/&gt;1.4 WebSettings 的设置内容很多,如果想看更多的话可以进行搜索;&lt;br/&gt;1.5 暂未发现其他问题,待定;&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;11&quot;&gt;
&lt;p&gt;setWebChromeClient 和 setWebViewClient:&lt;br/&gt;2.1 这2个都是 webView 的配置属性,不过在功能上有所区分:&lt;br/&gt;&lt;strong&gt;WebViewClient帮助WebView处理各种通知、请求事件的&lt;/strong&gt;&lt;br/&gt;&lt;strong&gt;WebChromeClient是辅助WebView处理Javascript的对话框，网站图标，网站title，加载进度等;&lt;/strong&gt;&lt;br/&gt;js 里面使用 alert 和 confirm 需要在WebChromeClient里面进行修改,提供对话框;&lt;br/&gt;2.2 关于onPageFinished:&lt;br/&gt;如果你的路由里面是异步加载的,如&lt;code&gt;resolve =&amp;gt; require(['./routers/XXX'], resolve)&lt;/code&gt;,那么就要注意,在每进入异步加载的页面后,都会触发此函数,所以如果你需要在页面加载后只执行一次的代码的话,就放在 setWebChromeClient 的 onProgressChanged 里进行判断进度是否为100时再执行;&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;7&quot;&gt;
&lt;p&gt;webview.loadUrl():&lt;br/&gt;3.1 这里的加载地址可以有2种,1是 &lt;code&gt;webview.loadUrl(&quot;file:///android_asset/index.html&quot;);&lt;/code&gt; 访问本地文件,2是&lt;code&gt;webview.loadUrl(&quot;http://www.baidu.com&quot;);&lt;/code&gt;访问网络文件;&lt;br/&gt;各有其优点:若访问网络文件,更新服务器内容即可使用最新的功能;而访问本地资源的话,加载的速度会快一点,而且即使断网也可以看到默认的东西;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;&lt;hr/&gt;&lt;p&gt;刚刚有说到,进入 APP 的快慢问题,这里我是调用了一个加载的动画来完成的:&lt;br/&gt;我这边选择的动画时这个:&lt;a href=&quot;https://github.com/zzz40500/android-shapeLoadingView&quot; target=&quot;_blank&quot;&gt;点击查看&lt;/a&gt;&lt;br/&gt;而在 Android studio 里调用插件的方式十分简单:&lt;/p&gt;
&lt;ol readability=&quot;2.5&quot;&gt;&lt;li readability=&quot;1&quot;&gt;
&lt;p&gt;打开根目录下的 build.gradle,在 allprojects 的 repositories 里添加:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;kw&quot;&gt;maven&lt;/span&gt; {
  &lt;span class=&quot;kw&quot;&gt;url&lt;/span&gt; &lt;span class=&quot;st&quot;&gt;&quot;https://jitpack.io&quot;&lt;/span&gt;
}&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;然后打开 app/build.gradle,在 dependencies 里添加:&lt;code&gt;compile 'com.github.zzz40500:android-shapeLoadingView:1.0.3.2'&lt;/code&gt;&lt;/li&gt;
&lt;li readability=&quot;7&quot;&gt;
&lt;p&gt;这时候&lt;strong&gt;先 build 项目&lt;/strong&gt;,再在 src/main/res/layout/activity_main.xml 里添加代码:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode xml&quot;&gt;
&lt;code class=&quot;sourceCode xml&quot;&gt;&lt;span class=&quot;kw&quot;&gt;&amp;lt;android.support.constraint.ConstraintLayout&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;

    &lt;span class=&quot;kw&quot;&gt;&amp;lt;com.mingle.widget.LoadingView&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        android:id=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;@+id/loadView&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        android:layout_width=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;fill_parent&quot;&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        android:layout_height=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt;&quot;fill_parent&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;/&amp;gt;&lt;/span&gt;

   ...

&lt;span class=&quot;kw&quot;&gt;&amp;lt;/android.support.constraint.ConstraintLayout&amp;gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这时候可以,这样 loading 动画就添加好了,后面只需要在 Java 代码里显示和隐藏就行了;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;&lt;hr/&gt;&lt;p&gt;最关键的html:&lt;code&gt;input[type=&quot;file&quot;]&lt;/code&gt;问题,这个问题才是最大的问题,先说好&lt;br/&gt;&lt;strong&gt;如果你的webApp不需要上传文件或者不在意Android 4.2-4.4 版本的话,可以用该方法&lt;/strong&gt;&lt;br/&gt;MainActivity.java:&lt;br/&gt;先创建变量:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode java&quot;&gt;
&lt;code class=&quot;sourceCode java&quot;&gt;    &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;int&lt;/span&gt; INPUT_FILE_REQUEST_CODE = &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;;
    &lt;span class=&quot;kw&quot;&gt;private&lt;/span&gt; ValueCallback&amp;lt;Uri&amp;gt; mUploadMessage;
    &lt;span class=&quot;kw&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;int&lt;/span&gt; FILECHOOSER_RESULTCODE = &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;;
    &lt;span class=&quot;kw&quot;&gt;private&lt;/span&gt; ValueCallback&amp;lt;Uri[]&amp;gt; mFilePathCallback;
    &lt;span class=&quot;kw&quot;&gt;private&lt;/span&gt; String mCameraPhotoPath;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在&lt;code&gt;setWebChromeClient&lt;/code&gt;里添加代码:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;34&quot;&gt;
&lt;pre class=&quot;sourceCode java&quot;&gt;
&lt;code class=&quot;sourceCode java&quot;&gt;            &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;openFileChooser&lt;/span&gt;(ValueCallback uploadMsg, String acceptType) {
                Log.&lt;span class=&quot;fu&quot;&gt;d&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;选择&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;3.0+&quot;&lt;/span&gt;);
                mUploadMessage = uploadMsg;
                Intent i = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Intent&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;ACTION_GET_CONTENT&lt;/span&gt;);
                i.&lt;span class=&quot;fu&quot;&gt;addCategory&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;CATEGORY_OPENABLE&lt;/span&gt;);
                i.&lt;span class=&quot;fu&quot;&gt;setType&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;image/*&quot;&lt;/span&gt;);
                MainActivity.&lt;span class=&quot;fu&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;startActivityForResult&lt;/span&gt;(
                        Intent.&lt;span class=&quot;fu&quot;&gt;createChooser&lt;/span&gt;(i, &lt;span class=&quot;st&quot;&gt;&quot;Image Chooser&quot;&lt;/span&gt;),
                        FILECHOOSER_RESULTCODE);
            }


            &lt;span class=&quot;co&quot;&gt;//Android 5.0&lt;/span&gt;
            &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;boolean&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;onShowFileChooser&lt;/span&gt;(
                    WebView webView, ValueCallback&amp;lt;Uri[]&amp;gt; filePathCallback,
                    WebChromeClient.&lt;span class=&quot;fu&quot;&gt;FileChooserParams&lt;/span&gt; fileChooserParams) {
                Log.&lt;span class=&quot;fu&quot;&gt;d&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;选择&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;5.0+&quot;&lt;/span&gt;);
                &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (mFilePathCallback != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                    mFilePathCallback.&lt;span class=&quot;fu&quot;&gt;onReceiveValue&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;);
                }


                mFilePathCallback = filePathCallback;


                Intent takePictureIntent = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Intent&lt;/span&gt;(MediaStore.&lt;span class=&quot;fu&quot;&gt;ACTION_IMAGE_CAPTURE&lt;/span&gt;);
                &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (takePictureIntent.&lt;span class=&quot;fu&quot;&gt;resolveActivity&lt;/span&gt;(&lt;span class=&quot;fu&quot;&gt;getPackageManager&lt;/span&gt;()) != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                    &lt;span class=&quot;co&quot;&gt;// Create the File where the photo should go&lt;/span&gt;
                    File photoFile = &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;;
                    &lt;span class=&quot;kw&quot;&gt;try&lt;/span&gt; {
                        &lt;span class=&quot;co&quot;&gt;//设置MediaStore.EXTRA_OUTPUT路径,相机拍照写入的全路径&lt;/span&gt;
                        photoFile = &lt;span class=&quot;fu&quot;&gt;createImageFile&lt;/span&gt;();
                        takePictureIntent.&lt;span class=&quot;fu&quot;&gt;putExtra&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;PhotoPath&quot;&lt;/span&gt;, mCameraPhotoPath);
                    } &lt;span class=&quot;kw&quot;&gt;catch&lt;/span&gt; (Exception ex) {
                        &lt;span class=&quot;co&quot;&gt;// Error occurred while creating the File&lt;/span&gt;
                        Log.&lt;span class=&quot;fu&quot;&gt;e&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;WebViewSetting&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;Unable to create Image File&quot;&lt;/span&gt;, ex);
                    }

                    &lt;span class=&quot;co&quot;&gt;// Continue only if the File was successfully created&lt;/span&gt;
                    &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (photoFile != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                        mCameraPhotoPath = &lt;span class=&quot;st&quot;&gt;&quot;file:&quot;&lt;/span&gt; + photoFile.&lt;span class=&quot;fu&quot;&gt;getAbsolutePath&lt;/span&gt;();
                        takePictureIntent.&lt;span class=&quot;fu&quot;&gt;putExtra&lt;/span&gt;(MediaStore.&lt;span class=&quot;fu&quot;&gt;EXTRA_OUTPUT&lt;/span&gt;,
                                Uri.&lt;span class=&quot;fu&quot;&gt;fromFile&lt;/span&gt;(photoFile));
                        System.&lt;span class=&quot;fu&quot;&gt;out&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;println&lt;/span&gt;(mCameraPhotoPath);
                    } &lt;span class=&quot;kw&quot;&gt;else&lt;/span&gt; {
                        takePictureIntent = &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;;
                    }
                }

                Intent contentSelectionIntent = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Intent&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;ACTION_GET_CONTENT&lt;/span&gt;);
                contentSelectionIntent.&lt;span class=&quot;fu&quot;&gt;addCategory&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;CATEGORY_OPENABLE&lt;/span&gt;);
                contentSelectionIntent.&lt;span class=&quot;fu&quot;&gt;setType&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;image/*&quot;&lt;/span&gt;);
                Intent[] intentArray;
                &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (takePictureIntent != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                    intentArray = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; Intent[]{takePictureIntent};
                    System.&lt;span class=&quot;fu&quot;&gt;out&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;println&lt;/span&gt;(takePictureIntent);
                } &lt;span class=&quot;kw&quot;&gt;else&lt;/span&gt; {
                    intentArray = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; Intent[&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;];
                }

                Intent chooserIntent = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Intent&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;ACTION_CHOOSER&lt;/span&gt;);
                chooserIntent.&lt;span class=&quot;fu&quot;&gt;putExtra&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;EXTRA_INTENT&lt;/span&gt;, contentSelectionIntent);
                chooserIntent.&lt;span class=&quot;fu&quot;&gt;putExtra&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;EXTRA_TITLE&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;Image Chooser&quot;&lt;/span&gt;);
                chooserIntent.&lt;span class=&quot;fu&quot;&gt;putExtra&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;EXTRA_INITIAL_INTENTS&lt;/span&gt;, intentArray);

                &lt;span class=&quot;fu&quot;&gt;startActivityForResult&lt;/span&gt;(chooserIntent, INPUT_FILE_REQUEST_CODE);

                &lt;span class=&quot;kw&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;true&lt;/span&gt;;
            }
            &lt;span class=&quot;co&quot;&gt;// For Android 3.0+&lt;/span&gt;
            &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;openFileChooser&lt;/span&gt;(ValueCallback&amp;lt;Uri&amp;gt; uploadMsg) {
                Log.&lt;span class=&quot;fu&quot;&gt;d&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;选择&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;3.0+&quot;&lt;/span&gt;);

                mUploadMessage = uploadMsg;
                Intent i = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Intent&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;ACTION_GET_CONTENT&lt;/span&gt;);
                i.&lt;span class=&quot;fu&quot;&gt;addCategory&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;CATEGORY_OPENABLE&lt;/span&gt;);
                i.&lt;span class=&quot;fu&quot;&gt;setType&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;image/*&quot;&lt;/span&gt;);
                MainActivity.&lt;span class=&quot;fu&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;startActivityForResult&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;createChooser&lt;/span&gt;(i, &lt;span class=&quot;st&quot;&gt;&quot;Image Chooser&quot;&lt;/span&gt;), FILECHOOSER_RESULTCODE);

            }



            &lt;span class=&quot;co&quot;&gt;//For Android 4.1&lt;/span&gt;
            &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;openFileChooser&lt;/span&gt;(ValueCallback&amp;lt;Uri&amp;gt; uploadMsg, String acceptType, String capture) {
                Log.&lt;span class=&quot;fu&quot;&gt;d&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;选择&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;4+&quot;&lt;/span&gt;);
                mUploadMessage = uploadMsg;
                Intent i = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;Intent&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;ACTION_GET_CONTENT&lt;/span&gt;);
                i.&lt;span class=&quot;fu&quot;&gt;addCategory&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;CATEGORY_OPENABLE&lt;/span&gt;);
                i.&lt;span class=&quot;fu&quot;&gt;setType&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;image/*&quot;&lt;/span&gt;);
                MainActivity.&lt;span class=&quot;fu&quot;&gt;this&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;startActivityForResult&lt;/span&gt;(Intent.&lt;span class=&quot;fu&quot;&gt;createChooser&lt;/span&gt;(i, &lt;span class=&quot;st&quot;&gt;&quot;Image Chooser&quot;&lt;/span&gt;), MainActivity.&lt;span class=&quot;fu&quot;&gt;FILECHOOSER_RESULTCODE&lt;/span&gt;);

            }&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在主类中添加:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;18&quot;&gt;
&lt;pre class=&quot;sourceCode java&quot;&gt;
&lt;code class=&quot;sourceCode java&quot;&gt;    &lt;span class=&quot;fu&quot;&gt;@SuppressLint&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;SdCardPath&quot;&lt;/span&gt;)
    &lt;span class=&quot;kw&quot;&gt;private&lt;/span&gt; File &lt;span class=&quot;fu&quot;&gt;createImageFile&lt;/span&gt;() {
        File file=&lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; File(Environment.&lt;span class=&quot;fu&quot;&gt;getExternalStorageDirectory&lt;/span&gt;()+&lt;span class=&quot;st&quot;&gt;&quot;/&quot;&lt;/span&gt;,&lt;span class=&quot;st&quot;&gt;&quot;tmp.png&quot;&lt;/span&gt;);
        mCameraPhotoPath=file.&lt;span class=&quot;fu&quot;&gt;getAbsolutePath&lt;/span&gt;();
        &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt;(!file.&lt;span class=&quot;fu&quot;&gt;exists&lt;/span&gt;())
        {
            &lt;span class=&quot;kw&quot;&gt;try&lt;/span&gt; {
                file.&lt;span class=&quot;fu&quot;&gt;createNewFile&lt;/span&gt;();
            } &lt;span class=&quot;kw&quot;&gt;catch&lt;/span&gt; (IOException e) {
                e.&lt;span class=&quot;fu&quot;&gt;printStackTrace&lt;/span&gt;();
            }
        }
        &lt;span class=&quot;kw&quot;&gt;return&lt;/span&gt; file;
    }
     &lt;span class=&quot;fu&quot;&gt;@Override&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;onActivityResult&lt;/span&gt;(&lt;span class=&quot;dt&quot;&gt;int&lt;/span&gt; requestCode, &lt;span class=&quot;dt&quot;&gt;int&lt;/span&gt; resultCode, Intent data) {
            Log.&lt;span class=&quot;fu&quot;&gt;d&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;result&quot;&lt;/span&gt;, &lt;span class=&quot;st&quot;&gt;&quot;show&quot;&lt;/span&gt;);
            &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (requestCode == FILECHOOSER_RESULTCODE) {
                &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt; == mUploadMessage) &lt;span class=&quot;kw&quot;&gt;return&lt;/span&gt;;
                Uri result = data == &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt; || resultCode != RESULT_OK ? &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;
                        : data.&lt;span class=&quot;fu&quot;&gt;getData&lt;/span&gt;();
                &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (result != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                    String imagePath = ImageFilePath.&lt;span class=&quot;fu&quot;&gt;getPath&lt;/span&gt;(&lt;span class=&quot;kw&quot;&gt;this&lt;/span&gt;, result);
                    &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (!TextUtils.&lt;span class=&quot;fu&quot;&gt;isEmpty&lt;/span&gt;(imagePath)) {
                        result = Uri.&lt;span class=&quot;fu&quot;&gt;parse&lt;/span&gt;(&lt;span class=&quot;st&quot;&gt;&quot;file:///&quot;&lt;/span&gt; + imagePath);
                    }
                }
                mUploadMessage.&lt;span class=&quot;fu&quot;&gt;onReceiveValue&lt;/span&gt;(result);
                mUploadMessage = &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;;
            } &lt;span class=&quot;kw&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (requestCode == INPUT_FILE_REQUEST_CODE &amp;amp;&amp;amp; mFilePathCallback != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                &lt;span class=&quot;co&quot;&gt;// 5.0的回调&lt;/span&gt;
                Uri[] results = &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;;
    
                &lt;span class=&quot;co&quot;&gt;// Check that the response is a good one&lt;/span&gt;
                &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (resultCode == Activity.&lt;span class=&quot;fu&quot;&gt;RESULT_OK&lt;/span&gt;) {
                    &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (data == &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; !TextUtils.&lt;span class=&quot;fu&quot;&gt;isEmpty&lt;/span&gt;(data.&lt;span class=&quot;fu&quot;&gt;getDataString&lt;/span&gt;())) {
                        &lt;span class=&quot;co&quot;&gt;// If there is not data, then we may have taken a photo&lt;/span&gt;
                        &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (mCameraPhotoPath != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                            results = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; Uri[]{Uri.&lt;span class=&quot;fu&quot;&gt;parse&lt;/span&gt;(mCameraPhotoPath)};
                        }
                    } &lt;span class=&quot;kw&quot;&gt;else&lt;/span&gt; {
                        String dataString = data.&lt;span class=&quot;fu&quot;&gt;getDataString&lt;/span&gt;();
                        &lt;span class=&quot;kw&quot;&gt;if&lt;/span&gt; (dataString != &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;) {
                            results = &lt;span class=&quot;kw&quot;&gt;new&lt;/span&gt; Uri[]{Uri.&lt;span class=&quot;fu&quot;&gt;parse&lt;/span&gt;(dataString)};
                        }
                    }
                }
    
    
                mFilePathCallback.&lt;span class=&quot;fu&quot;&gt;onReceiveValue&lt;/span&gt;(results);
                mFilePathCallback = &lt;span class=&quot;kw&quot;&gt;null&lt;/span&gt;;
            } &lt;span class=&quot;kw&quot;&gt;else&lt;/span&gt; {
                &lt;span class=&quot;kw&quot;&gt;super&lt;/span&gt;.&lt;span class=&quot;fu&quot;&gt;onActivityResult&lt;/span&gt;(requestCode, resultCode, data);
                &lt;span class=&quot;kw&quot;&gt;return&lt;/span&gt;;
            }
        }&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这里还需要一个 ImageFilePath 类文件,我将他放在 GitHub 里面了,后面我会附上链接:&lt;br/&gt;解决方法来源:&lt;a href=&quot;http://blog.csdn.net/earbao/article/details/50716747&quot; target=&quot;_blank&quot;&gt;点击查看&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;至于 Android 4.2-4.4 会有问题是因为这个:&lt;a href=&quot;https://issuetracker.google.com/issues/36983532&quot; target=&quot;_blank&quot;&gt;点击查看&lt;/a&gt;&lt;br/&gt;ps:&lt;strong&gt;需要FQ&lt;/strong&gt;&lt;br/&gt;而如果你是 native 开发者的话也比较容易解决,就是在点击时直接用 js 调用 Java 就行了,如果不是的话,一般都需要其他框架或者插件的支持;&lt;/p&gt;
&lt;p&gt;我所碰到的问题基本就是这些,如果有错误和疏漏之处还请指出,谢谢;&lt;br/&gt;GitHub:&lt;a href=&quot;https://github.com/Grewer/android-casing-webapp&quot; target=&quot;_blank&quot;&gt;点击查看&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;完;&lt;/p&gt;
</description>
<pubDate>Sun, 04 Feb 2018 14:23:00 +0000</pubDate>
<dc:creator>Grewer</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/Grewer/p/8414629.html</dc:identifier>
</item>
<item>
<title>Spring Cache For Redis - JMCui</title>
<link>http://www.cnblogs.com/jmcui/p/8410560.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/jmcui/p/8410560.html</guid>
<description>&lt;h2&gt;一、概述&lt;/h2&gt;
&lt;p&gt;     &lt;strong&gt;缓存&lt;/strong&gt;（Caching）可以存储经常会用到的信息，这样每次需要的时候，这些信息都是立即可用的。&lt;/p&gt;
&lt;p&gt;     常用的缓存数据库：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Redis   &lt;/strong&gt;使用内存存储（in-memory）的非关系数据库，字符串、列表、集合、散列表、有序集合，每种数据类型都有自己的专属命令。另外还有批量操作（bulk operation）和不完全（partial）的事务支持 、发布与订阅、主从复制（master/slave replication）、持久化、脚本（存储过程，stored procedure）。 效率比ehcache低，比数据库要快很多，处理集群和分布式缓存方便，有成熟的方案。如果是大型系统，存在缓存共享、分布式部署、缓存内容很大的，建议用redis。&lt;br/&gt;&lt;strong&gt;memcached   &lt;/strong&gt;使用内存存储的键值缓存，键值之间的映射、创建命令、读取命令、更新命令、删除命令以及其他几个命令。为提升性能而设的多线程服务器。memcache在客户端中实现分布式缓存，通过分布式算法指定目标数据的节点。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ehcache    &lt;/strong&gt;纯java实现，缓存在内存中，可持久化到硬盘，效率高于memcache；但是缓存共享麻烦，集群分布式应用不方便。如果是单个应用或者对缓存访问要求很高的应用，用ehcache。ehcache也有缓存共享方案，不过是通过RMI或者Jgroup多播方式进行广播缓存通知更新，缓存共享复杂，维护不方便；简单的共享可以，但是涉及到缓存恢复，大数据缓存，则不合适。&lt;/p&gt;
&lt;h2&gt;二、Spring Cache&lt;/h2&gt;
&lt;p&gt;    Spring 缓存的实现是通过创建一个切面（aspect）并触发Spring缓存注解的切点（pointcut）。根据所使用的注解以及缓存的状态，这个切面会从缓存中获取数据，将数据添加到缓存之中或者从缓存中移除某个值。Spring 能都与多个流行的缓存实现进行集成，实现步骤如下：&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;1、启用对缓存的支持&lt;/strong&gt;&lt;/h4&gt;
&lt;ul&gt;&lt;li&gt;Java 配置 注解驱动缓存&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;----@EnableCaching&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;XML 声明的缓存&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;----&amp;lt;cache:annotation-driven&amp;gt;&lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;2、缓存管理器&lt;/strong&gt;&lt;/h4&gt;
&lt;p&gt;缓存管理器是Spring缓存抽象的核心，它能够与多个流行的缓存实现进行集成。Spring3.1配置了五个缓存管理器实现：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;SimpleCacheManager&lt;/li&gt;
&lt;li&gt;NoOpCacheManager&lt;/li&gt;
&lt;li&gt;ConcurrentMapCacheManager（它的缓存存储是基于内存的，所以它的生命周期是与应用关联的，对于生产级别的大型企业级应用程序，这可能并不是理想的选择）&lt;/li&gt;
&lt;li&gt;CompositeCacheManager（系统同时使用多个缓存管理器集成）&lt;/li&gt;
&lt;li&gt;EhCacheCacheManager&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;除了核心的Spring框架，Spring Data又提供了两个缓存管理器：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;RedisCacheManager&lt;/li&gt;
&lt;li&gt;GemfireCacheManager&lt;/li&gt;
&lt;/ul&gt;&lt;h4&gt;&lt;strong&gt;3、为方法添加注解以支持缓存&lt;/strong&gt;&lt;/h4&gt;
&lt;p&gt;Spring 提供的四个注解来声明缓存规则：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180203191711484-512594555.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;@Cacheable会条件性地触发对方法的调用，这取决于缓存中是不是已经有了所需要的值。&lt;br/&gt;@CachePut采用了一种更为直接的流程。带有@CachePut注解的方法始终都会被调用，而且它的返回值也会放到缓存中。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;@Cacheable 和 @CachePut 一些共有的属性：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180203192216578-743365762.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt; value：value属性是必须指定的，其表示当前方法的返回值是会被缓存在哪个Cache上的，对应Cache的名称。主要作用是给 cache 取个名称！个人觉得，主要是为了在Spring 容器中可以更好的管理缓存对象。&lt;/p&gt;
&lt;p&gt; condition：调用方法前：如果SPEL表达式的值为false的话，将不会去走缓存。&lt;/p&gt;
&lt;p&gt;                    调用方法后：如果SPEL表达式的值为false的话，将不会将返回值放在缓存中。。&lt;/p&gt;
&lt;p&gt;unless：调用方法前：不管SPEL的值是 true 还是 false，都会去缓存中寻找对应的值，如果找到了就返回对应的值。没有找到的话才执行方法。&lt;/p&gt;
&lt;p&gt;              调用方法后：如果SPEL表达式的值是true的话，将不会将返回值放在缓存中。&lt;/p&gt;
&lt;p&gt;key：指定的key的值就是我们要保存到缓存数据库中的key的值，但是这个key的指定有自己的一套方式，如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180204200501967-291897862.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180204200537060-1786832174.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180204201527514-1405232444.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;另外，需要说明的是 #result 不能用在@Cacheable 上是因为 #result 表示的是 方法调用的缓存值。但是@Cacheable 可能不走方法，可能不会有返回值。所以就不太适用了。但是！但是！#result 可以用在@Cacheable的 unless 属性上，因为 unless 是在方法返回的时候再判断的，所以一定会有返回值！&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;@CacheEvict 的一些属性，指定了哪些缓存数目应该被移除：&lt;/strong&gt; &lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180204202510810-1766807881.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;@CacheEvict 主要用在要移除一个数据条目的时候，同时移除这个数据条目在缓存中的 key 和 value。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;@Cacheing&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;@Caching注解可以让我们在一个方法或者类上同时指定多个Spring Cache相关注解，其中拥有属性：cacheable、put、evict。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
@Caching(cacheable=@Cacheable(&quot;users&quot;),evict={@CacheEvict(&quot;cache2&quot;),@CacheEvict(value=&quot;cache3&quot;,allEntries=&lt;span&gt;true&lt;/span&gt;)})
&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;三、Spring Data Redis&lt;/h2&gt;
&lt;p&gt; Spring Data Redis包含了多个模板实现，用来完成Redis数据库的数据存取功能。&lt;/p&gt;
&lt;h4&gt;1、添加依赖&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; onclick=&quot;cnblogs_code_show('7efb903d-0ed3-4e3d-a0d9-1fd8f1309f72')&quot; readability=&quot;32&quot;&gt;&lt;img id=&quot;code_img_closed_7efb903d-0ed3-4e3d-a0d9-1fd8f1309f72&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_7efb903d-0ed3-4e3d-a0d9-1fd8f1309f72&quot; class=&quot;code_img_opened&quot; onclick=&quot;cnblogs_code_hide('7efb903d-0ed3-4e3d-a0d9-1fd8f1309f72',event)&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_7efb903d-0ed3-4e3d-a0d9-1fd8f1309f72&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;59&quot;&gt;
&lt;pre&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.data&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-data-redis&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;1.8.7.RELEASE&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;redis.clients&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;jedis&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
      &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;2.9.0&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;View Code&lt;/span&gt;&lt;/div&gt;
&lt;h4&gt; 2、&lt;span class=&quot;fontstyle0&quot;&gt;Redis&lt;span class=&quot;fontstyle1&quot;&gt;连接工厂&lt;br/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;&lt;span class=&quot;fontstyle0&quot;&gt;&lt;span class=&quot;fontstyle1&quot;&gt;为了创建Spring Data Redis的模板，我们首先需要有一个Redis连接工厂。Spring Data Redis提供了四个连接工厂供我们选择（这些连接工厂在适用上都是相同的）：&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;JedisConnectionFactory&lt;/li&gt;
&lt;li&gt;JredisConnectionFactory&lt;/li&gt;
&lt;li&gt;LettuceConnectionFactory&lt;/li&gt;
&lt;li&gt;SrpConnectionFactory&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;strong&gt;3、&lt;/strong&gt;&lt;span class=&quot;fontstyle0&quot;&gt;&lt;strong&gt;RedisTemplate 和 &lt;/strong&gt;&lt;span class=&quot;fontstyle0&quot;&gt;&lt;strong&gt;StringRedisTemplate&lt;/strong&gt;&lt;/span&gt;       &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;fontstyle0&quot;&gt;与其他的Spring Data项目类似，Spring Data Redis以模板的形式提供了较高等级的数据访问方案。Spring Data Redis提供了两个模板：&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;RedisTemplate&lt;/li&gt;
&lt;li&gt;StringRedisTemplate&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;RedisTemplate 支持 Object类型 的key 和 Object类型 的value。而StringRedisTemplate则采用更简单粗暴的方式，只支持 String类型 的key 和String类型 的value。 &lt;/p&gt;
&lt;h4&gt;&lt;strong&gt;4、缓存管理器&lt;/strong&gt;&lt;/h4&gt;
&lt;p&gt;上面提到，缓存管理器是Spring Cache 的核心。Spring Data Redis 有着自己的缓存管理器 RedisCacheManager，下面给出两种Spring Data Redis 配置的方式：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; onclick=&quot;cnblogs_code_show('4d5f8ae6-57ae-4c56-870b-fe63362d287a')&quot; readability=&quot;34.5&quot;&gt;&lt;img id=&quot;code_img_closed_4d5f8ae6-57ae-4c56-870b-fe63362d287a&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_4d5f8ae6-57ae-4c56-870b-fe63362d287a&quot; class=&quot;code_img_opened&quot; onclick=&quot;cnblogs_code_hide('4d5f8ae6-57ae-4c56-870b-fe63362d287a',event)&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_4d5f8ae6-57ae-4c56-870b-fe63362d287a&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;64&quot;&gt;
&lt;pre&gt;
&lt;span&gt;@Configuration
@EnableCaching
@ComponentScan(basePackageClasses &lt;/span&gt;= {RedisCacheService.&lt;span&gt;class&lt;/span&gt;, CacheDao.&lt;span&gt;class&lt;/span&gt;&lt;span&gt;})
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Config {

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;Redis 连接工厂&lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    @Bean(name &lt;/span&gt;= &quot;redisConnectionFactory&quot;&lt;span&gt;)
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; JedisConnectionFactory jedisConnectionFactory() {
        JedisConnectionFactory jedisConnectionFactory &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; JedisConnectionFactory();
        jedisConnectionFactory.setHostName(&lt;/span&gt;&quot;127.0.0.1&quot;&lt;span&gt;);
        jedisConnectionFactory.setPort(&lt;/span&gt;6379&lt;span&gt;);
        jedisConnectionFactory.setPassword(&lt;/span&gt;&quot;foobared&quot;&lt;span&gt;);
        jedisConnectionFactory.afterPropertiesSet();
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; jedisConnectionFactory;
    }

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;RedisTemplate &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    @Bean(name &lt;/span&gt;= &quot;redisTemplate&quot;&lt;span&gt;)
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; RedisTemplate&amp;lt;String, Object&amp;gt;&lt;span&gt; redisTemplate(RedisConnectionFactory redisConnectionFactory) {
        RedisTemplate&lt;/span&gt;&amp;lt;String, Object&amp;gt; redisTemplate = &lt;span&gt;new&lt;/span&gt; RedisTemplate&amp;lt;String, Object&amp;gt;&lt;span&gt;();
        redisTemplate.setConnectionFactory(redisConnectionFactory);
        redisTemplate.afterPropertiesSet();
        redisTemplate.setKeySerializer(&lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; StringRedisSerializer());
        redisTemplate.setValueSerializer(&lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; JdkSerializationRedisSerializer());
        redisTemplate.setHashKeySerializer(&lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; StringRedisSerializer());
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; redisTemplate;
    }

    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt;Redis 缓存管理器&lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    @Bean(name &lt;/span&gt;= &quot;cacheManager&quot;&lt;span&gt;)
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; CacheManager cacheManager(RedisTemplate redisTemplate) {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt;&lt;span&gt; RedisCacheManager(redisTemplate);
    }

}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;基于Java配置类&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; onclick=&quot;cnblogs_code_show('f906e420-5ed5-4390-8bbc-d0328a703726')&quot; readability=&quot;32.5&quot;&gt;&lt;img id=&quot;code_img_closed_f906e420-5ed5-4390-8bbc-d0328a703726&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_f906e420-5ed5-4390-8bbc-d0328a703726&quot; class=&quot;code_img_opened&quot; onclick=&quot;cnblogs_code_hide('f906e420-5ed5-4390-8bbc-d0328a703726',event)&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_f906e420-5ed5-4390-8bbc-d0328a703726&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;60&quot;&gt;
&lt;pre&gt;
    &lt;span&gt;&amp;lt;!--&lt;/span&gt;&lt;span&gt;连接工厂&lt;/span&gt;&lt;span&gt;--&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;bean &lt;/span&gt;&lt;span&gt;id&lt;/span&gt;&lt;span&gt;=&quot;redisConnectionFactory&quot;&lt;/span&gt;&lt;span&gt; class&lt;/span&gt;&lt;span&gt;=&quot;org.springframework.data.redis.connection.jedis.JedisConnectionFactory&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;property &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;hostName&quot;&lt;/span&gt;&lt;span&gt; value&lt;/span&gt;&lt;span&gt;=&quot;${redis.hostName}&quot;&lt;/span&gt;&lt;span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;property &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;port&quot;&lt;/span&gt;&lt;span&gt; value&lt;/span&gt;&lt;span&gt;=&quot;${redis.port}&quot;&lt;/span&gt;&lt;span&gt;/&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;property &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;password&quot;&lt;/span&gt;&lt;span&gt; value&lt;/span&gt;&lt;span&gt;=&quot;${redis.password}&quot;&lt;/span&gt;&lt;span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;bean&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;!--&lt;/span&gt;&lt;span&gt;redisTemplate&lt;/span&gt;&lt;span&gt;--&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;bean &lt;/span&gt;&lt;span&gt;id&lt;/span&gt;&lt;span&gt;=&quot;redisTemplate&quot;&lt;/span&gt;&lt;span&gt; class&lt;/span&gt;&lt;span&gt;=&quot;org.springframework.data.redis.core.RedisTemplate&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
       &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;property &lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;=&quot;connectionFactory&quot;&lt;/span&gt;&lt;span&gt; ref&lt;/span&gt;&lt;span&gt;=&quot;redisConnectionFactory&quot;&lt;/span&gt;&lt;span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;bean&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;!--&lt;/span&gt;&lt;span&gt;cacheManager&lt;/span&gt;&lt;span&gt;--&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;bean &lt;/span&gt;&lt;span&gt;id&lt;/span&gt;&lt;span&gt;=&quot;cacheManager&quot;&lt;/span&gt;&lt;span&gt; class&lt;/span&gt;&lt;span&gt;=&quot;org.springframework.data.redis.cache.RedisCacheManager&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;constructor-arg &lt;/span&gt;&lt;span&gt;ref&lt;/span&gt;&lt;span&gt;=&quot;redisTemplate&quot;&lt;/span&gt;&lt;span&gt;/&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;bean&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;基于applicationContext.xml&lt;/span&gt;&lt;/div&gt;
&lt;h4&gt;5、key 和 value 的序列化器&lt;/h4&gt;
&lt;p&gt;当某个条目保存到Redis key-value存储的时候，key和value都会使用Redis的序列化器（serializer）进行序列化。Spring Data Redis提供了多个这样的序列化器，包括：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;GenericToStringSerializer：使用Spring转换服务进行序列化；&lt;/li&gt;
&lt;li&gt;JacksonJsonRedisSerializer：使用Jackson 1，将对象序列化为JSON；&lt;/li&gt;
&lt;li&gt;Jackson2JsonRedisSerializer：使用Jackson 2，将对象序列化为JSON；&lt;/li&gt;
&lt;li&gt;JdkSerializationRedisSerializer：使用Java序列化；&lt;/li&gt;
&lt;li&gt;OxmSerializer：使用Spring O/X映射的编排器和解排器（marshaler和unmarshaler）实现序列化用于XML序列化；&lt;/li&gt;
&lt;li&gt;StringRedisSerializer：序列化String类型的key和value。&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;RedisTemplate会使用JdkSerializationRedisSerializer，这意味着key和value都会通过Java进行序列化。StringRedisTemplate默认会使用StringRedisSerializer。&lt;/p&gt;
&lt;p&gt;RedisTemplate 的 key 和 value 经过序列化存储可能会让你觉得奇怪，类似如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180204210716717-683361815.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;这是正常的，因为使用的是 java 的序列化，如果想要看起来比较舒服的，可以用 StringRedisSerializer 序列成字符串的样子。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;6、API &lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Spring Data Redis 提供了一套API 友好的操作Redis，如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180204211146810-1303978969.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2017.cnblogs.com/blog/1153954/201802/1153954-20180204211226014-126505705.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;对 Redis 的操作就不就不细讲了，具体的可以看我学习这方面内容时做的相关的练习，也包括前面内容的一些补充。写的还算详细吧！&lt;span&gt;&lt;a href=&quot;https://github.com/JMCuixy/SpringRedisData&quot; target=&quot;_blank&quot;&gt;&lt;span&gt;https://github.com/JMCuixy/SpringRedisData&lt;/span&gt;&lt;/a&gt;&lt;span&gt;&lt;br/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;四、结语&lt;/h2&gt;
&lt;p&gt;冬天好冷啊！还没有暖气 ~~&lt;/p&gt;
</description>
<pubDate>Sun, 04 Feb 2018 13:28:00 +0000</pubDate>
<dc:creator>JMCui</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/jmcui/p/8410560.html</dc:identifier>
</item>
</channel>
</rss>