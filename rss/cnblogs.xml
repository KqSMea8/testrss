<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=feed.cnblogs.com%2Fblog%2Fsitehome%2Frss&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://feed.cnblogs.com/blog/sitehome/rss" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>博客园_首页</title>
<link></link>
<description>代码改变世界</description>
<item>
<title>Iptables防火墙（SNAT和DNAT） - L宝宝聊IT</title>
<link>http://www.cnblogs.com/L2366/p/9411246.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/L2366/p/9411246.html</guid>
<description>&lt;p&gt;&lt;span&gt;&lt;strong&gt; 1、SNAT：源地址转换&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;实现内网访问外网，修改IP地址，使用POSTROUTING&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;命令：&lt;span&gt;iptables  -t  nat  -A POSTROUTING  -s  192.168.1.10/24  -j SNAT  --to-source  202.1.1.1&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;2、MASQUERADE：地址伪装&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;适用于外网ip地址非固定的情况&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;将SNAT规则改为MASQUERADE即可&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;命令：&lt;span&gt;iptables  -t  nat  -A POSTROUTING  -s  192.168.1.0/24  -j MASQUERADE&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;3、DNAT：目标地址转换&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;实现发布公司内部服务器，修改目标地址，使用PREROUTING&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;命令：&lt;span&gt;iptables  -t nat  -A  PREROUTING -d  202.1.1.1  -p tcp  --dport  8080 -j  DNAT  -to 192.168.1.100:80&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;4、备份和还原规则：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;备份：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1）iptables-save  &amp;gt;  文件&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     导出到指定文件&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2）service  iptables save&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;    导出到/etc/sysconfig/iptables&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;    重启自动加载&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;还原：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1）iptables-restore  &amp;lt;  文件名&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2）service  iptables restart&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;    从默认文件/etc/sysconfig/iptables还原&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;5、iptables脚本编写&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1）定义变量&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2）加载必要的模块&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;modprobe   ip_nat_ftp     ftp地址转换模块&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;modprobe   ip_conntrack_ftp     ftp连接状态跟踪&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;lsmod        查看已加载的模块&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;3）调整内核参数：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;启用内核转发功能：有三种方式（详见第十章笔记的第8点）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;4）编写防火墙的规则&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;6、防火墙的类型：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;主机型防火墙：针对本机进行保护，使用filter表中的INPUT、OUTPUT链&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;网络型防火墙：对内、外网转发进行保护，使用filter表中FORWARD链&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;&lt;span&gt;&lt;strong&gt;实验拓扑图：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064409248-1398449763.png&quot; alt=&quot;&quot;/&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;实验要求：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1、  如图所示，将网络连通，注意在外部服务器上不用配置默认网关。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064433966-1439723553.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064444314-879861045.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064454481-787805774.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2、分别在内部和外部服务器上搭建web服务，修改网页，如&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;内部web服务器的网页内容：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;echo   “192.168.1.10”  &amp;gt;  /var/www/html/index.html &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在本机访问网页，测试能否成功访问。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;步骤：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在网站服务器启动httpd服务&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;Service  httpd  start&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在访问主页写入内容&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;echo  192.168.1.10  &amp;gt;  /var/www/html/index.html&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在本机测试如下图：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064527650-1842755110.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;外网主机同上，测试结果如下图：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064553483-1835183220.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;3、分别启动网站服务器和网关服务器的SSh，并把网关ssh服务端口改为2345。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;步骤：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;启动sshd服务:  service sshd  restart&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;进入网关服务器的ssh主配置文件vim /etc/ssh/sshd_confing&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064621712-2014972878.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;4、清空三台服务器的防火墙默认配置：&lt;span&gt;service  iptables    stop&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;5、  SNAT（源地址转换）：要求内部主机192.168.1.10能访问外部服务器的网站。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;验证：在外部服务器通过查看web的访问日志。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;步骤：&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;SNAT源地址转换命令如下：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064649579-20819129.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;到网站服务器访问外网&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064707978-1625739314.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;查看外网的Web访问日志，是否是200.0.0.1访问&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064732862-1671484078.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;6、 DNAT（目标地址转换）：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1）外部主机通过http://200.0.0.1能够访问到内部服务器的网站。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在网关服务器上配置DANT&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064823957-1331846313.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;验证可以访问&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064846863-1827765810.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2）外部主机使用ssh  –p 2345  200.0.0.1 能够远程管理网关服务器。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064907296-1225660757.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;3）外部主机使用ssh  -p 2222  200.0.0.1 能够远程管理内部192.168.1.10服务器。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在网关服务器配置DNAT&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064926548-768136772.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;到外网验证可以登录远程登录&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803064948910-997226243.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;7、在网关服务器上对防火墙进行保存和备份。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;保存防火墙规则：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803065009439-1574766638.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;备份防火墙规则：iptables -save&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803065041793-1456908060.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;8、在网关服务器上写一个防火墙的脚本。实现上面的功能。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;   脚本提示：路由转发，清空所有防火墙规则，SNAT，DNAT。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;   设置防火墙开机自动关闭，设置脚本开启自动执行。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;脚本如下：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803065105579-2038603610.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;设置脚本开机自启动只需将脚本路径写入/etc/rc.local&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1302526/201808/1302526-20180803065126535-1377324787.png&quot; alt=&quot;&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;文章参考微信公众号：L宝宝聊IT&lt;/p&gt;
</description>
<pubDate>Thu, 02 Aug 2018 22:52:00 +0000</pubDate>
<dc:creator>L宝宝聊IT</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/L2366/p/9411246.html</dc:identifier>
</item>
<item>
<title>依赖注入[8]: .NET Core DI框架[服务消费] - Artech</title>
<link>http://www.cnblogs.com/artech/p/net-core-di-08.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/artech/p/net-core-di-08.html</guid>
<description>&lt;p&gt;包含服务注册信息的IServiceCollection对象最终被用来创建作为DI容器的IServiceProvider对象。当需要消费某个服务实例的时候，我们只需要指定服务类型调用IServiceProvider的GetService方法，IServiceProvider就会根据对应的服务注册提供所需的服务实例。&lt;/p&gt;
&lt;blockquote readability=&quot;6&quot;&gt;
&lt;p&gt;目录&lt;br/&gt;一、IServiceProvider&lt;br/&gt;二、构造函数的选择&lt;br/&gt;三、服务范围&lt;br/&gt;四、三种生命周期模式&lt;br/&gt;五、ASP.NET Core应用下的生命周期&lt;br/&gt;六、服务范围检验&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;如下面的代码片段所示，IServiceProvider接口定义了唯一的方法GetService方法根据指定的服务类型来提供对应的服务实例。当我们在利用包含服务注册的IServiceCollection对象创建对作为DI容器的IServiceProvider对象之后，我们只需要将服务注册的服务类型（对应于ServiceDescriptor的ServiceType属性）作为参数调用GetService方法，后者就能根据服务注册信息为我们提供对应的服务实例。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;public&lt;/span&gt; &lt;span&gt;interface&lt;/span&gt;&lt;span&gt; IServiceProvider
{
    &lt;/span&gt;&lt;span&gt;object&lt;/span&gt;&lt;span&gt; GetService(Type serviceType);
}

&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; ServiceCollectionContainerBuilderExtensions
{
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; ServiceProvider BuildServiceProvider(&lt;span&gt;this&lt;/span&gt;&lt;span&gt; IServiceCollection services);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;默认情况下调用IServiceCollection的BuildServiceProvider方法返回的一个ServiceProvider对象，但是我并不打算详细介绍这个类型，这是因为实现在该类型中针对服务实例的提供机制一直在不断的变化，而且这个变化趋势在未来版本更替过程中还将继续。除此之外，ServiceProvider涉及到一系列内部类型和接口，所以我们不打算涉及具体的细节，只讲总体设计。&lt;/p&gt;
&lt;p&gt;除了定义在IServiceProvider的这个GetService方法，DI框架为了该接口定了如下这些扩展方法。&lt;strong&gt;GetService&amp;lt;T&amp;gt;&lt;/strong&gt;方法会泛型参数的形式指定了服务类型，返回的服务实例也会作对应的类型转换。如果指定服务类型的服务注册不存在，GetService方法会返回Null，如果调用&lt;strong&gt;GetRequiredService&lt;/strong&gt;或者&lt;strong&gt;GetRequiredService&amp;lt;T&amp;gt;&lt;/strong&gt;方法则会抛出一个InvalidOperationException类型的异常。如果所需的服务实例是必需的，我们一般会调用者两个扩展方法。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; ServiceProviderServiceExtensions
{
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; T GetService&amp;lt;T&amp;gt;(&lt;span&gt;this&lt;/span&gt;&lt;span&gt; IServiceProvider provider);

    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; T GetRequiredService&amp;lt;T&amp;gt;(&lt;span&gt;this&lt;/span&gt;&lt;span&gt; IServiceProvider provider);
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;object&lt;/span&gt; GetRequiredService(&lt;span&gt;this&lt;/span&gt;&lt;span&gt; IServiceProvider provider, Type serviceType);
    
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; IEnumerable&amp;lt;T&amp;gt; GetServices&amp;lt;T&amp;gt;(&lt;span&gt;this&lt;/span&gt;&lt;span&gt; IServiceProvider provider);
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; IEnumerable&amp;lt;&lt;span&gt;object&lt;/span&gt;&amp;gt; GetServices(&lt;span&gt;this&lt;/span&gt;&lt;span&gt; IServiceProvider provider, Type serviceType);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;如果针对某个类型注册了多个服务，那么GetService方法总是会采用最新添加的服务注册来提供服务实例。如果希望利用所有的服务注册来创建一组服务实例列表，我们可以调用&lt;strong&gt;GetServices&lt;/strong&gt;或者&lt;strong&gt;GetServices&amp;lt;T&amp;gt;&lt;/strong&gt;方法。&lt;/p&gt;

&lt;p&gt;对于通过调用IServiceCollection的BuildServiceProvider方法创建的IServiceProvider来说，当我们通过指定服务类型调用其GetService方法以获取对应的服务实例的时候，它总是会根据提供的服务类型从服务注册列表中找到对应的&lt;strong&gt;ServiceDescriptor&lt;/strong&gt;对象，并根据后者提供所需的服务实例。&lt;/p&gt;
&lt;p&gt;ServiceDescriptor具有三个不同的构造函数，分别对应着服务实例最初的三种创建方式，我们可以提供一个Func&amp;lt;IServiceProvider, object&amp;gt;对象作为工厂来创建对应的服务实例，也可以直接提供一个创建好的服务实例。如果我们提供的是服务的实现类型，那么最终提供的服务实例将通过调用该类型的某个构造函数来创建，那么构造函数时通过怎样的策略被选择出来的呢？&lt;/p&gt;
&lt;p&gt;如果IServiceProvider对象试图通过调用构造函数的方式来创建服务实例，传入构造函数的所有参数必须先被初始化，最终被选择出来的构造函数必须具备一个基本的条件：&lt;strong&gt;IServiceProvider能够提供构造函数的所有参数&lt;/strong&gt;。为了让读者朋友能够更加真切地理解IServiceProvider在构造函数选择过程中采用的策略，我们不让也采用实例演示的方式来进行讲解。&lt;/p&gt;
&lt;p&gt;我们在一个控制台应用中定义了四个服务接口（IFoo、IBar、IBaz和IGux）以及实现它们的四个服务类（Foo、Bar、Baz和Gux）。如下面的代码片段所示，我们为Gux定义了三个构造函数，参数均为我们定义了服务接口类型。为了确定IServiceProvider最终选择哪个构造函数来创建目标服务实例，我们在构造函数执行时在控制台上输出相应的指示性文字。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
&lt;span&gt;public&lt;/span&gt; &lt;span&gt;interface&lt;/span&gt;&lt;span&gt; IFoo {}
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;interface&lt;/span&gt;&lt;span&gt; IBar {}
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;interface&lt;/span&gt;&lt;span&gt; IBaz {}
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;interface&lt;/span&gt;&lt;span&gt; IGux {}

&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Foo : IFoo {}
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Bar : IBar {}
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Baz : IBaz {}
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Gux : IGux
{
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; Gux(IFoo foo) =&amp;gt; Console.WriteLine(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Selected constructor: Gux(IFoo)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;);
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; Gux(IFoo foo, IBar bar) =&amp;gt; Console.WriteLine(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Selected constructor: Gux(IFoo, IBar)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;);
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; Gux(IFoo foo, IBar bar, IBaz baz) =&amp;gt; Console.WriteLine(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Selected constructor: Gux(IFoo, IBar, IBaz)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;在如下这段演示程序中我们创建了一个ServiceCollection对象并在其中添加针对IFoo、IBar以及IGux这三个服务接口的服务注册，针对服务接口IBaz的注册并未被添加。我们利用由它创建的IServiceProvider来提供针对服务接口IGux的实例，究竟能否得到一个Gux对象呢？如果可以，它又是通过执行哪个构造函数创建的呢？&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;class&lt;/span&gt;&lt;span&gt; Program
{
    &lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Main(&lt;span&gt;string&lt;/span&gt;&lt;span&gt;[] args)
    {       
        &lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; ServiceCollection()
            .AddTransient&lt;/span&gt;&amp;lt;IFoo, Foo&amp;gt;&lt;span&gt;()
            .AddTransient&lt;/span&gt;&amp;lt;IBar, Bar&amp;gt;&lt;span&gt;()
            .AddTransient&lt;/span&gt;&amp;lt;IGux, Gux&amp;gt;&lt;span&gt;()
            .BuildServiceProvider()
            .GetServices&lt;/span&gt;&amp;lt;IGux&amp;gt;&lt;span&gt;();
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对于定义在Gux中的三个构造函数来说，由于创建IServiceProvider提供的IServiceCollection集合包含针对接口IFoo和IBar的服务注册，所以它能够提供前面两个构造函数的所有参数。由于第三个构造函数具有一个类型为IBaz的参数，这无法通过IServiceProvider来提供。根据我们上面介绍的第一个原则（&lt;strong&gt;IServiceProvider能够提供构造函数的所有参数&lt;/strong&gt;），Gux的前两个构造函数会成为合法的候选构造函数，那么IServiceProvider最终会选择哪一个呢？&lt;/p&gt;
&lt;p&gt;在所有合法的候选构造函数列表中，最终被选择出来的构造函数具有这么一个特征：&lt;strong&gt;每一个候选构造函数的参数类型集合都是这个构造函数参数类型集合的子集&lt;/strong&gt;。如果这样的构造函数并不存在，一个类型为InvalidOperationException的异常会被抛出来。根据这个原则，Gux的第二个构造函数的参数类型包括IFoo和IBar，而第一个构造函数仅仅具有一个类型为IFoo的参数，最终被选择出来的会是Gux的第二个构造函数，所有运行我们的实例程序将会在控制台上产生如图1所示的输出结果。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==&quot; alt=&quot;&quot;/&gt;&lt;a href=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061015733-1472249044.png&quot;&gt;&lt;img width=&quot;389&quot; height=&quot;126&quot; title=&quot;4-5&quot; alt=&quot;4-5&quot; src=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061015975-1673205605.png&quot; border=&quot;0&quot;/&gt;&lt;/a&gt;&lt;br/&gt;图1构造函数的选择策略&lt;/p&gt;
&lt;p&gt;接下来我们对实例程序略加改动。如下面的代码片段所示，我们只为Gux定义两个构造函数，它们都具有两个参数，参数类型分别为IFoo&amp;amp;IBar和IBar&amp;amp;IBaz。我们将针对IBaz/Baz的服务注册添加到创建的ServiceCollection对象上。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
&lt;span&gt;class&lt;/span&gt;&lt;span&gt; Program
{
    &lt;/span&gt;&lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Main(&lt;span&gt;string&lt;/span&gt;&lt;span&gt;[] args)
    {       
        &lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; ServiceCollection()
            .AddTransient&lt;/span&gt;&amp;lt;IFoo, Foo&amp;gt;&lt;span&gt;()
            .AddTransient&lt;/span&gt;&amp;lt;IBar, Bar&amp;gt;&lt;span&gt;()
            .AddTransient&lt;/span&gt;&amp;lt;IBaz, Baz&amp;gt;&lt;span&gt;()
            .AddTransient&lt;/span&gt;&amp;lt;IGux, Gux&amp;gt;&lt;span&gt;()
            .BuildServiceProvider()
            .GetServices&lt;/span&gt;&amp;lt;IGux&amp;gt;&lt;span&gt;();
    }
}

&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Gux : IGux
{
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; Gux(IFoo foo, IBar bar) {}
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; Gux(IBar bar, IBaz baz) {}
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;对于Gux的两个构造函数，虽然它们的参数均能够由IServiceProvider来提供，但是&lt;strong&gt;并没有一个构造函数的参数类型集合能够成为所有有效构造函数参数类型集合的超集&lt;/strong&gt;，所以ServiceProvider无法选择出一个最佳的构造函数。运行该程序后会抛出如图2所示的InvalidOperationException异常，并提示无法从两个候选的构造函数中选择出一个最优的来创建服务实例。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==&quot; alt=&quot;&quot;/&gt;&lt;a href=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061016165-1089118442.png&quot;&gt;&lt;img width=&quot;502&quot; height=&quot;215&quot; title=&quot;4-6&quot; alt=&quot;4-6&quot; src=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061016439-1011470760.png&quot; border=&quot;0&quot;/&gt;&lt;/a&gt;&lt;br/&gt;图2 构造函数的选择策略&lt;/p&gt;
&lt;p&gt;接下来我们着重介绍服务生命周期的话题。生命周期决定了IServiceProvider采用怎样的方式提供和释放服务实例。虽然不同版本的DI框架在针对服务实例生命周期管理采用了不同的实现，但总的来说，实现原理还是类似的。在我们提供的DI框架&lt;a href=&quot;http://mp.weixin.qq.com/s?__biz=MzIwOTM1MjgzMA==&amp;amp;mid=2247484139&amp;amp;idx=1&amp;amp;sn=800aefd616775399f31788666d681478&amp;amp;chksm=977463faa003eaec679907cd53f924d9b13009b9349b91ed9aaa01652229ce188b26cf386901&amp;amp;scene=21#wechat_redirect&quot;&gt;Cat&lt;/a&gt;中，我们已经模拟了三种生命周期模式的实现原理，接下来我们结合服务范围的概念来对这个话题做进一步讲解。&lt;/p&gt;

&lt;p&gt;对于DI框架体用的三种生命周期（Singleton、Scoped和Transient）来说，Singleton和Transient都具有明确的语义，但是Scoped代表一种怎样的生命周期模式，很多初学者往往搞不清楚。这里所谓的Scope指的是由&lt;strong&gt;IServiceScope&lt;/strong&gt;接口表示的“服务范围”，该范围由&lt;strong&gt;IServiceScopeFactory&lt;/strong&gt;接口表示的“服务范围工厂”来创建。如下面的代码片段所示，IServiceProvider的扩展方法&lt;strong&gt;CreateScope&lt;/strong&gt;正是利用提供的IServiceScopeFactory服务实例来创建作为服务范围的IServiceScope对象。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;public&lt;/span&gt; &lt;span&gt;interface&lt;/span&gt;&lt;span&gt; IServiceScope : IDisposable
{
    IServiceProvider ServiceProvider { &lt;/span&gt;&lt;span&gt;get&lt;/span&gt;&lt;span&gt;; }
}

&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;interface&lt;/span&gt;&lt;span&gt; IServiceScopeFactory
{
    IServiceScope CreateScope();
}

&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; ServiceProviderServiceExtensions
{
   &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; IServiceScope CreateScope(&lt;span&gt;this&lt;/span&gt; IServiceProvider provider) =&amp;gt; provider.GetRequiredService&amp;lt;IServiceScopeFactory&amp;gt;&lt;span&gt;().CreateScope();
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;任何一个IServiceProvider对象都可以利用其注册的IServiceScopeFactory服务创建一个代表服务范围的IServiceScope对象，后者代表的“范围”内具有一个新创建的IServiceProvider对象（对应着接口IServiceScope的ServiceProvider属性），后者同样具有提供服务实例的能力，它与当前IServiceProvider具在逻辑上具有如图3所示的“&lt;strong&gt;父子关系&lt;/strong&gt;”。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==&quot; alt=&quot;&quot;/&gt;&lt;a href=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061016687-1943345103.png&quot;&gt;&lt;img width=&quot;300&quot; height=&quot;180&quot; title=&quot;4-7&quot; alt=&quot;4-7&quot; src=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061016942-390826614.png&quot; border=&quot;0&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;图3 IServiceScope与IServiceProvider（逻辑结构）&lt;/p&gt;
&lt;p&gt;如图3所示的树形层次结构只是一种逻辑结构，从对象引用层面来开，通过某个IServiceScope包裹的IServiceProvider对象不需要知道自己的“父亲”是谁，它只关心作为&lt;strong&gt;根节点&lt;/strong&gt;的IServiceProvider在哪里就可以了。图4从物理层面揭示了IServiceScope/IServiceProvider对象之间的关系，任何一个IServiceProvider对象都具有针对根容器的引用。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==&quot; alt=&quot;&quot;/&gt;&lt;a href=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061017209-441958286.png&quot;&gt;&lt;img width=&quot;241&quot; height=&quot;292&quot; title=&quot;4-8&quot; alt=&quot;4-8&quot; src=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061017808-972473987.png&quot; border=&quot;0&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;图4 IServiceScope与IServiceProvider（物理结构）&lt;/p&gt;

&lt;p&gt;只有在充分了解IServiceScope的创建过程以及它与IServiceProvider之间的关系之后，我们才会对三种生命周期管理模式（Singleton、Scope和Transient）具有深刻的认识。就服务实例的提供方式来说，它们之间具有如下的差异：&lt;/p&gt;
&lt;ul readability=&quot;2&quot;&gt;&lt;li readability=&quot;1&quot;&gt;
&lt;p&gt;Singleton：IServiceProvider创建的服务实例保存在作为&lt;strong&gt;根容器的IServiceProvider上&lt;/strong&gt;，所有多个同根的IServiceProvider对象提供的针对同一类型的服务实例都是同一个对象。&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;Scoped：IServiceProvider创建的服务实例由&lt;strong&gt;自己&lt;/strong&gt;保存，所以同一个IServiceProvider对象提供的针对同一类型的服务实例均是同一个对象。&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;Transient：针对每一次服务提供请求，IServiceProvider总是创建一个新的服务实例。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;IServiceProvider除了为我们提供所需的服务实例之外，对于由它提供的服务实例，它还肩负起&lt;strong&gt;回收释放&lt;/strong&gt;之责。这里所说的回收释放与.NET Core自身的垃圾回收机制无关，仅仅针对于自身类型实现了&lt;strong&gt;IDisposable&lt;/strong&gt;接口的服务实例（下面简称为Disposable服务实例），针对服务实例的释放体现为调用它们的Dispose方法。IServiceProvider针对服务实例采用的回收释放策略取决于对应服务注册的生命周期模式，具体服务回收策略主要体现为如下两点：&lt;/p&gt;
&lt;ul readability=&quot;0&quot;&gt;&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;Singleton：提供Disposable服务实例保存在作为根容器的IServiceProvider对象上，只有后者被释放的时候这些Disposable服务实例才能被释放。&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;Scoped和Transient：IServiceProvider对象会保存由它提供的Disposable服务实例，当自己被释放的时候，这些Disposable会被释放。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;综上所述，每个作为DI容器的IServiceProvider对象都具有如图5所示两个列表来存放服务实例，我们将它们分别命名为“&lt;strong&gt;Realized Services&lt;/strong&gt;”和“&lt;strong&gt;Disposable Services&lt;/strong&gt;”，对于一个作为非根容器的IServiceProvider对象来说，由它提供的Scoped服务保存在自身的Realized Services列表中，Singleton服务实例则会保存在根容器的Realized Services列表。如果服务实现类型实现了IDisposable接口，Scoped和Singleton服务实例会被保存到自身的Disposable Services列表中，而Singleton服务实例则会保存到根容器的Disposable Services列表。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061018120-1354774749.png&quot;&gt;&lt;img width=&quot;439&quot; height=&quot;344&quot; title=&quot;4-9&quot; alt=&quot;4-9&quot; src=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061018385-84671889.png&quot; border=&quot;0&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;图5 生命周期管理&lt;/p&gt;
&lt;p&gt;对于作为容器的IServiceProvider对象来说，Singleton和Scope模式对它来说是两种等效的生命周期模式，由它提供的Singleton和Scoped服务实例会被被存放到自身的Realized Services列表，而所有需要被释放的服务实例则被存放到Disposable Services列表。&lt;/p&gt;
&lt;p&gt;当某个IServiceProvider被用于提供针对指定类型的服务实例时，它会根据服务类型提取出表示服务注册的ServiceDescriptor对象并根据后者得到对应的生命周期模式。如果生命周期模式为Singleton，并且作为根容器的Realized Services列表中包含对应的服务实例，后者将作为最终提供的服务实例。如果这样的服务实例尚未创建，那么新的服务将会被创建出来并作为提供的服务实例。在返回之后该对象会被添加到根容器的Realized Services列表中，如果实例类型实现了IDisposable接口，创建的服务实例会被添加到根容器的Disposable Services列表中。&lt;/p&gt;
&lt;p&gt;如果生命周期为Scoped，那么IServiceProvider会先确定自身的Realized Services列表中是否存在对应的服务实例，存在的服务实例将作为最终返回的服务实例。如果Realized Services列表不存在对应的服务实例，那么新的服务实例会被创建出来。在作为最终的服务实例被返回之前，创建的服务实例会被添加的自身的Realized Services列表中，如果实例类型实现了IDisposable接口，创建的服务实例会被添加到自身的Disposable Services列表中。&lt;/p&gt;
&lt;p&gt;如果提供服务的生命周期为Transient，那么IServiceProvider会直接创建一个新的服务实例。在作为最终的服务实例被返回之前，创建的服务实例会被添加的自身的Realized Services列表中，如果实例类型实现了IDisposable接口，创建的服务实例会被添加到自身的Disposable Services列表中。&lt;/p&gt;
&lt;p&gt;对于非根容器的IServiceProvider对象来说，它的生命周期是由“包裹”着它的IServiceScope对象控制的。从上面给出的定义可以看出IServiceScope实现了IDisposable接口，Dispose方法的执行不仅标志着当前服务范围的终结，也意味着对应IServiceProvider对象生命周期的结束。&lt;/p&gt;
&lt;p&gt;当代表服务范围的IServiceScope对象的Dispose方法被调用的时候，它会调用对应IServiceProvider的Dispose方法。一旦IServiceProvider因自身Dispose方法的调用而被释放的时候，它会从自身的Disposable Services列表中提取出所有需要被释放的服务实例，并调用它们的Dispose方法。在这之后，Disposable Services和Realized Services列表会被清空，列表中的服务实例和IServiceProvider对象自身会成为垃圾对象被GC回收。&lt;/p&gt;

&lt;p&gt;DI框架所谓的服务范围在ASP.NET Core应用中具有明确的边界，指的是针对每个&lt;strong&gt;HTTP请求&lt;/strong&gt;的上下文，也就是服务范围的生命周期与每个请求上下文绑定在一起。如图6所示，ASP.NET Core应用中用于提供服务实例的IServiceProvider对象分为两种类型，一种是作为根容器并与应用具有相同生命周期的IServiceProvider，另一个类则是根据请求及时创建和释放的IServiceProvider，我们可以将它们分别称为&lt;strong&gt;Application ServiceProvider&lt;/strong&gt;和&lt;strong&gt;Request ServiceProvider&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061018608-938202887.png&quot;&gt;&lt;img width=&quot;602&quot; height=&quot;404&quot; title=&quot;4-10&quot; alt=&quot;4-10&quot; src=&quot;https://images2018.cnblogs.com/blog/19327/201808/19327-20180803061018911-1334068319.png&quot; border=&quot;0&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;图6 生命周期管理&lt;/p&gt;
&lt;p&gt;在ASP.NET Core应用初始化过程中，即请求管道构建过程中使用的服务实例都是由&lt;strong&gt;Application ServiceProvider&lt;/strong&gt;提供的。在具体处理每个请求时，ASP.NET Core框架会利用注册的一个中间件来针对当前请求创建一个服务范围，该服务范围提供的&lt;strong&gt;Request ServiceProvider&lt;/strong&gt;用来提供当前请求处理过程中所需的服务实例。一旦服务请求处理完成，上述的这个中间件会主动释放掉由它创建的服务范围。&lt;/p&gt;

&lt;p&gt;如果我们在一个ASP.NET Core应用中将一个服务的生命周期注册为Scoped，实际上是&lt;strong&gt;希望服务实例采用基于请求的生命周期&lt;/strong&gt;。举个简单的例子，如果我们在一个ASP.NET Core应用中采用Entity Framework Core来访问数据库，我们一般会将对应的DbContext类型（姑且命名为FoobarDbContext）注册为一个Scoped服务，这样既可以保证在FoobarDbContext能够自同一个请求上下文中被重用，也可以确保FoobarDbContext在请求结束之后能够及时将数据库链接释放掉。&lt;/p&gt;
&lt;p&gt;但是如果我们使用作为根容器的&lt;strong&gt;Application ServiceProvider&lt;/strong&gt;来提供这个DbContext对象，意味着提供的DbContext将被保存在Application ServiceProvider的Realized Services列表中，知道应用关闭时才能被释放。即使提供该FoobarDbContext是针对请求的Request ServiceProvider，如果另一个&lt;strong&gt;Singleton&lt;/strong&gt;服务（姑且命名为Foobar）具有针对它的依赖，意味着提供服务实例Foobar将会具有针对FoobarDbContext对象的引用。由于Foobar是一个Singleton服务实例，所以被它引用的FoobarDbContext也只能在应用关闭的时候才能被释放。&lt;/p&gt;
&lt;p&gt;为了解决这个问题，我们可以让IServiceProvider在提供Scoped服务实例的时候进行针对性的检验。针对服务范围验证的开关由ServiceProviderOptions的ValidateScopes属性来控制，默认情况下是关闭的。如果希望开启针对服务范围的验证，我们可以在调用IServiceCollect接口的BuildServiceProvider方法的时候指定一个ServiceProviderOptions对象作为参数，或者直接调用另一个扩展方法并将传入的参数validateScopes设置为True。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; ServiceProviderOptions
{
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;bool&lt;/span&gt; ValidateScopes { &lt;span&gt;get&lt;/span&gt;; &lt;span&gt;set&lt;/span&gt;&lt;span&gt;; }
}

&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; ServiceCollectionContainerBuilderExtensions
{
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; ServiceProvider BuildServiceProvider(&lt;span&gt;this&lt;/span&gt;&lt;span&gt; IServiceCollection services, ServiceProviderOptions options);
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; ServiceProvider BuildServiceProvider(&lt;span&gt;this&lt;/span&gt; IServiceCollection services, &lt;span&gt;bool&lt;/span&gt;&lt;span&gt; validateScopes);
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;针对服务范围的验证对于IServiceProvider来说是一项额外附加的操作，会对性能带来或多或少的影响，所以一般情况下这个开关只会在开发（Development）环境被开启，对于产品（Production）或者预发（Staging）环境下最好将其关闭。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-01.html&quot;&gt;依赖注入[1]: 控制反转&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-02.html&quot;&gt;依赖注入[2]: 基于IoC的设计模式&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-03.html&quot;&gt;依赖注入[3]: 依赖注入模式&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-04.html&quot;&gt;依赖注入[4]: 创建一个简易版的DI框架[上篇]&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-05.html&quot;&gt;依赖注入[5]: 创建一个简易版的DI框架[下篇]&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-06.html&quot;&gt;依赖注入[6]: .NET Core DI框架[编程体验]&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-07.html&quot;&gt;依赖注入[7]: .NET Core DI框架[服务注册]&lt;/a&gt;&lt;br/&gt;&lt;a href=&quot;https://www.cnblogs.com/artech/p/net-core-di-08html&quot;&gt;依赖注入[8]: .NET Core DI框架[服务消费]&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Thu, 02 Aug 2018 22:10:00 +0000</pubDate>
<dc:creator>Artech</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/artech/p/net-core-di-08.html</dc:identifier>
</item>
<item>
<title>21天打造分布式爬虫-多线程下载表情包（五） - zhang_derek</title>
<link>http://www.cnblogs.com/derek1184405959/p/9411073.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/derek1184405959/p/9411073.html</guid>
<description>&lt;h3&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;5.1.threading模块&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;简单使用&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; threading,time

&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; coding():
    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(3&lt;span&gt;):
        &lt;/span&gt;&lt;span&gt;print&lt;/span&gt;(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;正在写代码%s&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;%&lt;span&gt;x)
        time.sleep(&lt;/span&gt;2&lt;span&gt;)

&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; drawing():
    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(3&lt;span&gt;):
        &lt;/span&gt;&lt;span&gt;print&lt;/span&gt;(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;正在画画%s&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;%&lt;span&gt;x)
        time.sleep(&lt;/span&gt;2&lt;span&gt;)

&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; main():
    t1 &lt;/span&gt;= threading.Thread(target=&lt;span&gt;coding)
    t2 &lt;/span&gt;= threading.Thread(target=&lt;span&gt;drawing)
    t1.start()
    t2.start()

&lt;/span&gt;&lt;span&gt;if&lt;/span&gt; &lt;span&gt;__name__&lt;/span&gt; == &lt;span&gt;'&lt;/span&gt;&lt;span&gt;__main__&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;:
    main()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;5.2.生产者和消费者&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;Lock模式的生产者和消费者&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;44&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; threading
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; random,time

gMoney &lt;/span&gt;= 1000&lt;span&gt;
gLock &lt;/span&gt;=&lt;span&gt; threading.Lock()
gTotalTimes &lt;/span&gt;= 10&lt;span&gt;
gTimes &lt;/span&gt;=&lt;span&gt; 0


&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt; Producer(threading.Thread):
    &lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; run(self):
        &lt;/span&gt;&lt;span&gt;global&lt;/span&gt;&lt;span&gt; gMoney
        &lt;/span&gt;&lt;span&gt;global&lt;/span&gt;&lt;span&gt; gTimes
        &lt;/span&gt;&lt;span&gt;while&lt;/span&gt;&lt;span&gt; True:
            money &lt;/span&gt;= random.randint(100,1000&lt;span&gt;)
            gLock.acquire()
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;只生产10次，超过就停止，必须把锁给释放掉，否则产生死锁&lt;/span&gt;
            &lt;span&gt;if&lt;/span&gt; gTimes &amp;gt;=&lt;span&gt; gTotalTimes:
                gLock.release()
                &lt;/span&gt;&lt;span&gt;break&lt;/span&gt;&lt;span&gt;
            gMoney &lt;/span&gt;+=&lt;span&gt; money
            &lt;/span&gt;&lt;span&gt;print&lt;/span&gt;(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;%s生产了%d元钱,剩余%d元钱&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; %&lt;span&gt; (threading.current_thread(), money, gMoney))
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;生产一次，次数加1，总共10次&lt;/span&gt;
            gTimes += 1&lt;span&gt;
            gLock.release()
            time.sleep(&lt;/span&gt;0.5&lt;span&gt;)


&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt; Consumer(threading.Thread):
    &lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; run(self):
        &lt;/span&gt;&lt;span&gt;global&lt;/span&gt;&lt;span&gt; gMoney
        &lt;/span&gt;&lt;span&gt;while&lt;/span&gt;&lt;span&gt; True:
            money &lt;/span&gt;= random.randint(100,1000&lt;span&gt;)
            gLock.acquire()
            &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; gMoney &amp;gt;=&lt;span&gt; money:
                gMoney &lt;/span&gt;-=&lt;span&gt; money
                &lt;/span&gt;&lt;span&gt;print&lt;/span&gt;(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;%s消费了%d元钱,剩余%d元钱&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; %&lt;span&gt; (threading.current_thread(), money,gMoney))
            &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt;:
                &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; gTimes &amp;gt;=&lt;span&gt; gTotalTimes:
                    gLock.release()
                    &lt;/span&gt;&lt;span&gt;break&lt;/span&gt;&lt;span&gt;
            gLock.release()
            time.sleep(&lt;/span&gt;0.5&lt;span&gt;)


&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; main():
    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(5&lt;span&gt;):
        t1 &lt;/span&gt;=&lt;span&gt; Producer()
        t1.start()

    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(2&lt;span&gt;):
        t2 &lt;/span&gt;=&lt;span&gt; Consumer()
        t2.start()

&lt;/span&gt;&lt;span&gt;if&lt;/span&gt; &lt;span&gt;__name__&lt;/span&gt; == &lt;span&gt;'&lt;/span&gt;&lt;span&gt;__main__&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;:
    main()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;&lt;span&gt;&lt;strong&gt;&lt;span&gt;5.3.下载表情包&lt;/span&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;网址：http://www.doutula.com/photo/list/?page=1&lt;/p&gt;
&lt;p&gt;解析：xpath&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;不用多线程，速度相对会很慢&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;42&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; requests
&lt;/span&gt;&lt;span&gt;from&lt;/span&gt; lxml &lt;span&gt;import&lt;/span&gt;&lt;span&gt; etree
&lt;/span&gt;&lt;span&gt;from&lt;/span&gt; urllib &lt;span&gt;import&lt;/span&gt;&lt;span&gt; request
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; os
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; re

&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; parse_page(url):
    headers &lt;/span&gt;=&lt;span&gt; {
        &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;User-Agent&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;Referer&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://movie.douban.com/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
    }
    response &lt;/span&gt;= requests.get(url,headers=&lt;span&gt;headers)
    text &lt;/span&gt;=&lt;span&gt; response.text
    html &lt;/span&gt;=&lt;span&gt; etree.HTML(text)
    imgs &lt;/span&gt;= html.xpath(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;//div[@class='page-content text-center']//img[@class!='gif']&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)
    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; img &lt;span&gt;in&lt;/span&gt;&lt;span&gt; imgs:
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; print(etree.tostring(img))&lt;/span&gt;
        &lt;span&gt;#&lt;/span&gt;&lt;span&gt;图片地址&lt;/span&gt;
        img_url = img.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;data-original&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;图片名字&lt;/span&gt;
        alt = img.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;alt&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;替换掉名字里面的特殊字符&lt;/span&gt;
        alt = re.sub(r&lt;span&gt;'&lt;/span&gt;&lt;span&gt;[\?？\.，。！!\*]&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;,alt)
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;获取图片的后缀名（.gif .jpg）&lt;/span&gt;
        suffix = os.path.splitext(img_url)[1&lt;span&gt;]
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;保存的时候完整的图片名字&lt;/span&gt;
        filename = alt +&lt;span&gt; suffix
        request.urlretrieve(img_url,&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;C:/Users/Administrator/Desktop/images/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;+&lt;span&gt;filename)

&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; main():
    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(1,10&lt;span&gt;):
        url &lt;/span&gt;= &lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://www.doutula.com/photo/list/?page=%d&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;%&lt;span&gt;x
        parse_page(url)

&lt;/span&gt;&lt;span&gt;if&lt;/span&gt; &lt;span&gt;__name__&lt;/span&gt; == &lt;span&gt;'&lt;/span&gt;&lt;span&gt;__main__&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;:
    main()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;利用多线程&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt; main()&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;定义两个队列，和创建多线程&lt;/li&gt;
&lt;li&gt;page_queue()：存放每一页的url&lt;/li&gt;
&lt;li&gt;img_queue()：存放每一页里面所有的表情的url&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Producer()&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;从page_queue()队列中去每一页的url，直到队列为空则break&lt;/li&gt;
&lt;li&gt;用xpath提取出每一页的所有图片的url&lt;/li&gt;
&lt;li&gt;把每个图片的url和名字存放到img_queue()队列里面&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Consumer()&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;从img_queue()队列中取出图片的url和名字&lt;/li&gt;
&lt;li&gt;下载保存&lt;/li&gt;
&lt;li&gt;直到page_queue()和img_queue()两个队列都为空则break&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;代码&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;59&quot;&gt;
&lt;pre&gt;
&lt;span&gt;import&lt;/span&gt;&lt;span&gt; requests
&lt;/span&gt;&lt;span&gt;from&lt;/span&gt; lxml &lt;span&gt;import&lt;/span&gt;&lt;span&gt; etree
&lt;/span&gt;&lt;span&gt;from&lt;/span&gt; urllib &lt;span&gt;import&lt;/span&gt;&lt;span&gt; request
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; os
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; re
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; threading
&lt;/span&gt;&lt;span&gt;from&lt;/span&gt; queue &lt;span&gt;import&lt;/span&gt;&lt;span&gt; Queue

&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt; Producer(threading.Thread):
    headers &lt;/span&gt;=&lt;span&gt; {
        &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;User-Agent&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;Referer&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://movie.douban.com/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
    }

    &lt;/span&gt;&lt;span&gt;def&lt;/span&gt; &lt;span&gt;__init__&lt;/span&gt;(self, page_queue, img_queue, *args, **&lt;span&gt;kwargs):
        super(Producer, self).&lt;/span&gt;&lt;span&gt;__init__&lt;/span&gt;(*args, **&lt;span&gt;kwargs)
        self.page_queue &lt;/span&gt;=&lt;span&gt; page_queue
        self.img_queue &lt;/span&gt;=&lt;span&gt; img_queue

    &lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; run(self):
        &lt;/span&gt;&lt;span&gt;while&lt;/span&gt;&lt;span&gt; True:
            &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; self.page_queue.empty():
                &lt;/span&gt;&lt;span&gt;break&lt;/span&gt;&lt;span&gt;
            url &lt;/span&gt;=&lt;span&gt; self.page_queue.get()
            self.parse_page(url)

    &lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; parse_page(self,url):
        response &lt;/span&gt;= requests.get(url,headers=&lt;span&gt;self.headers)
        text &lt;/span&gt;=&lt;span&gt; response.text
        html &lt;/span&gt;=&lt;span&gt; etree.HTML(text)
        imgs &lt;/span&gt;= html.xpath(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;//div[@class='page-content text-center']//img[@class!='gif']&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)
        &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; img &lt;span&gt;in&lt;/span&gt;&lt;span&gt; imgs:
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; print(etree.tostring(img))&lt;/span&gt;
            &lt;span&gt;#&lt;/span&gt;&lt;span&gt;图片地址&lt;/span&gt;
            img_url = img.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;data-original&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;图片名字&lt;/span&gt;
            alt = img.get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;alt&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;替换掉名字里面的特殊字符&lt;/span&gt;
            alt = re.sub(r&lt;span&gt;'&lt;/span&gt;&lt;span&gt;[\?？\.，。！!\*]&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;,alt)
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;获取图片的后缀名（.gif .jpg）&lt;/span&gt;
            suffix = os.path.splitext(img_url)[1&lt;span&gt;]
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt;保存的时候完整的图片名字&lt;/span&gt;
            filename = alt +&lt;span&gt; suffix
            self.img_queue.put((img_url,filename))


&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt; Consumer(threading.Thread):
    &lt;/span&gt;&lt;span&gt;def&lt;/span&gt; &lt;span&gt;__init__&lt;/span&gt;(self,page_queue,img_queue,*args,**&lt;span&gt;kwargs):
        super(Consumer, self).&lt;/span&gt;&lt;span&gt;__init__&lt;/span&gt;(*args,**&lt;span&gt;kwargs)
        self.page_queue &lt;/span&gt;=&lt;span&gt; page_queue
        self.img_queue &lt;/span&gt;=&lt;span&gt; img_queue

    &lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; run(self):
        &lt;/span&gt;&lt;span&gt;while&lt;/span&gt;&lt;span&gt; True:
            &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; self.img_queue.empty() &lt;span&gt;and&lt;/span&gt;&lt;span&gt; self.page_queue.empty():
                &lt;/span&gt;&lt;span&gt;break&lt;/span&gt;&lt;span&gt;
            img_url,filename &lt;/span&gt;=&lt;span&gt; self.img_queue.get()
            request.urlretrieve(img_url, &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;C:/Users/Administrator/Desktop/images/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; +&lt;span&gt; filename)
            &lt;/span&gt;&lt;span&gt;print&lt;/span&gt;(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;已下载完一张图片&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)


&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; main():
    page_queue &lt;/span&gt;= Queue(1000&lt;span&gt;)
    img_queue &lt;/span&gt;= Queue(10000&lt;span&gt;)

    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(1,1758&lt;span&gt;):
        url &lt;/span&gt;= &lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://www.doutula.com/photo/list/?page=%d&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;%&lt;span&gt;x
        page_queue.put(url)

    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(10&lt;span&gt;):
        t &lt;/span&gt;=&lt;span&gt; Producer(page_queue,img_queue)
        t.start()

    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; x &lt;span&gt;in&lt;/span&gt; range(10&lt;span&gt;):
        t &lt;/span&gt;=&lt;span&gt; Consumer(page_queue,img_queue)
        t.start()

&lt;/span&gt;&lt;span&gt;if&lt;/span&gt; &lt;span&gt;__name__&lt;/span&gt; == &lt;span&gt;'&lt;/span&gt;&lt;span&gt;__main__&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;:
    main()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;结果：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1299879/201808/1299879-20180803015734263-793089055.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

</description>
<pubDate>Thu, 02 Aug 2018 17:58:00 +0000</pubDate>
<dc:creator>zhang_derek</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/derek1184405959/p/9411073.html</dc:identifier>
</item>
<item>
<title>基于SpringBoot的Environment源码理解实现分散配置 - throwable</title>
<link>http://www.cnblogs.com/throwable/p/9411100.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/throwable/p/9411100.html</guid>
<description>&lt;p&gt;org.springframework.core.env.Environment是当前应用运行环境的公开接口，主要包括应用程序运行环境的两个关键方面：配置文件(profiles)和属性。Environment继承自接口PropertyResolver，而PropertyResolver提供了属性访问的相关方法。这篇文章从源码的角度分析Environment的存储容器和加载流程，然后基于源码的理解给出一个生产级别的扩展。&lt;/p&gt;
&lt;p&gt;本文较长，请用一个舒服的姿势阅读。&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://pazkqls86.bkt.clouddn.com/spe-1.png&quot; alt=&quot;spe-1&quot;/&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;PropertyResolver：提供属性访问功能。&lt;/li&gt;
&lt;li&gt;ConfigurablePropertyResolver：继承自PropertyResolver，主要提供属性类型转换(基于org.springframework.core.convert.ConversionService)功能。&lt;/li&gt;
&lt;li&gt;Environment：继承自PropertyResolver，提供访问和判断profiles的功能。&lt;/li&gt;
&lt;li&gt;ConfigurableEnvironment：继承自ConfigurablePropertyResolver和Environment，并且提供设置激活的profile和默认的profile的功能。&lt;/li&gt;
&lt;li&gt;ConfigurableWebEnvironment：继承自ConfigurableEnvironment，并且提供配置Servlet上下文和Servlet参数的功能。&lt;/li&gt;
&lt;li&gt;AbstractEnvironment：实现了ConfigurableEnvironment接口，默认属性和存储容器的定义，并且实现了ConfigurableEnvironment种的方法，并且为子类预留可覆盖了扩展方法。&lt;/li&gt;
&lt;li&gt;StandardEnvironment：继承自AbstractEnvironment，非Servlet(Web)环境下的标准Environment实现。&lt;/li&gt;
&lt;li&gt;StandardServletEnvironment：继承自StandardEnvironment，Servlet(Web)环境下的标准Environment实现。&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;reactive相关的暂时不研究。&lt;/p&gt;

&lt;p&gt;一般情况下，我们在SpringMVC项目中启用到的是StandardServletEnvironment，它的父接口问ConfigurableWebEnvironment，我们可以查看此接口提供的方法：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://pazkqls86.bkt.clouddn.com/spe-2.png&quot; alt=&quot;spe-2&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Environment的静态属性和存储容器都是在AbstractEnvironment中定义的，ConfigurableWebEnvironment接口提供的&lt;code&gt;getPropertySources()&lt;/code&gt;方法可以获取到返回的MutablePropertySources实例，然后添加额外的PropertySource。实际上，Environment的存储容器就是org.springframework.core.env.PropertySource的子类集合，AbstractEnvironment中使用的实例是org.springframework.core.env.MutablePropertySources，下面看下PropertySource的源码：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public abstract class PropertySource&amp;lt;T&amp;gt; {

    protected final Log logger = LogFactory.getLog(getClass());

    protected final String name;

    protected final T source;

    public PropertySource(String name, T source) {
        Assert.hasText(name, &quot;Property source name must contain at least one character&quot;);
        Assert.notNull(source, &quot;Property source must not be null&quot;);
        this.name = name;
        this.source = source;
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public PropertySource(String name) {
        this(name, (T) new Object());
    }

    public String getName() {
        return this.name;
    }

    public T getSource() {
        return this.source;
    } 

    public boolean containsProperty(String name) {
        return (getProperty(name) != null);
    } 

    @Nullable
    public abstract Object getProperty(String name);     

    @Override
    public boolean equals(Object obj) {
        return (this == obj || (obj instanceof PropertySource &amp;amp;&amp;amp;
                ObjectUtils.nullSafeEquals(this.name, ((PropertySource&amp;lt;?&amp;gt;) obj).name)));
    }  

    @Override
    public int hashCode() {
        return ObjectUtils.nullSafeHashCode(this.name);
    }  
//省略其他方法和内部类的源码            
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;源码相对简单，预留了一个&lt;code&gt;getProperty&lt;/code&gt;抽象方法给子类实现，&lt;strong&gt;重点需要关注的是覆写了的&lt;code&gt;equals&lt;/code&gt;和&lt;code&gt;hashCode&lt;/code&gt;方法，实际上只和&lt;code&gt;name&lt;/code&gt;属性相关，这一点很重要，说明一个PropertySource实例绑定到一个唯一的name，这个name有点像HashMap里面的key&lt;/strong&gt;，部分移除、判断方法都是基于name属性。PropertySource的最常用子类是MapPropertySource、PropertiesPropertySource、ResourcePropertySource、StubPropertySource、ComparisonPropertySource：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;MapPropertySource：source指定为Map实例的PropertySource实现。&lt;/li&gt;
&lt;li&gt;PropertiesPropertySource：source指定为Map实例的PropertySource实现，内部的Map实例由Properties实例转换而来。&lt;/li&gt;
&lt;li&gt;ResourcePropertySource：继承自PropertiesPropertySource，source指定为通过Resource实例转化为Properties再转换为Map实例。&lt;/li&gt;
&lt;li&gt;StubPropertySource：PropertySource的一个内部类，source设置为null，实际上就是空实现。&lt;/li&gt;
&lt;li&gt;ComparisonPropertySource：继承自ComparisonPropertySource，所有属性访问方法强制抛出异常，作用就是一个不可访问属性的空实现。&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;AbstractEnvironment中的属性定义：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public static final String IGNORE_GETENV_PROPERTY_NAME = &quot;spring.getenv.ignore&quot;;
public static final String ACTIVE_PROFILES_PROPERTY_NAME = &quot;spring.profiles.active&quot;;
public static final String DEFAULT_PROFILES_PROPERTY_NAME = &quot;spring.profiles.default&quot;;
protected static final String RESERVED_DEFAULT_PROFILE_NAME = &quot;default&quot;;

private final Set&amp;lt;String&amp;gt; activeProfiles = new LinkedHashSet&amp;lt;&amp;gt;();

private final Set&amp;lt;String&amp;gt; defaultProfiles = new LinkedHashSet&amp;lt;&amp;gt;(getReservedDefaultProfiles());

private final MutablePropertySources propertySources = new MutablePropertySources(this.logger);

private final ConfigurablePropertyResolver propertyResolver = new PropertySourcesPropertyResolver(this.propertySources);&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;上面的propertySources(MutablePropertySources类型)属性就是用来存放PropertySource列表的，PropertySourcesPropertyResolver是ConfigurablePropertyResolver的实现，默认的profile就是字符串default。MutablePropertySources的内部属性如下：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;private final List&amp;lt;PropertySource&amp;lt;?&amp;gt;&amp;gt; propertySourceList = new CopyOnWriteArrayList&amp;lt;&amp;gt;();&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;没错，这个就是最底层的存储容器，也就是环境属性都是存放在一个CopyOnWriteArrayList&amp;lt;PropertySource&amp;lt;?&amp;gt;&amp;gt;实例中。MutablePropertySources是PropertySources的子类，它提供了&lt;code&gt;get(String name)&lt;/code&gt;、&lt;code&gt;addFirst&lt;/code&gt;、&lt;code&gt;addLast&lt;/code&gt;、&lt;code&gt;addBefore&lt;/code&gt;、&lt;code&gt;addAfter&lt;/code&gt;、&lt;code&gt;remove&lt;/code&gt;、&lt;code&gt;replace&lt;/code&gt;等便捷方法，方便操作propertySourceList集合的元素，这里挑选&lt;code&gt;addBefore&lt;/code&gt;的源码分析：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public void addBefore(String relativePropertySourceName, PropertySource&amp;lt;?&amp;gt; propertySource) {
    if (logger.isDebugEnabled()) {
        logger.debug(&quot;Adding PropertySource '&quot; + propertySource.getName() +
                    &quot;' with search precedence immediately higher than '&quot; + relativePropertySourceName + &quot;'&quot;);
    }
    //前一个PropertySource的name指定为relativePropertySourceName时候必须和添加的PropertySource的name属性不相同
    assertLegalRelativeAddition(relativePropertySourceName, propertySource);
    //尝试移除同名的PropertySource
    removeIfPresent(propertySource);
    //获取前一个PropertySource在CopyOnWriteArrayList中的索引
    int index = assertPresentAndGetIndex(relativePropertySourceName);
    //添加当前传入的PropertySource到指定前一个PropertySource的索引，相当于relativePropertySourceName对应的PropertySource后移到原来索引值+1的位置
    addAtIndex(index, propertySource);
}

protected void assertLegalRelativeAddition(String relativePropertySourceName, PropertySource&amp;lt;?&amp;gt; propertySource) {
    String newPropertySourceName = propertySource.getName();
    if (relativePropertySourceName.equals(newPropertySourceName)) {
        throw new IllegalArgumentException(
                    &quot;PropertySource named '&quot; + newPropertySourceName + &quot;' cannot be added relative to itself&quot;);
    }
}

protected void removeIfPresent(PropertySource&amp;lt;?&amp;gt; propertySource) {
    this.propertySourceList.remove(propertySource);
}

private int assertPresentAndGetIndex(String name) {
    int index = this.propertySourceList.indexOf(PropertySource.named(name));
    if (index == -1) {
        throw new IllegalArgumentException(&quot;PropertySource named '&quot; + name + &quot;' does not exist&quot;);
    }
    return index;
}

private void addAtIndex(int index, PropertySource&amp;lt;?&amp;gt; propertySource) {
    //注意，这里会再次尝试移除同名的PropertySource
    removeIfPresent(propertySource);
    this.propertySourceList.add(index, propertySource);
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;大多数PropertySource子类的修饰符都是public，可以直接使用，这里写个小demo：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;MutablePropertySources mutablePropertySources = new MutablePropertySources();
Map&amp;lt;String, Object&amp;gt; map = new HashMap&amp;lt;&amp;gt;(8);
map.put(&quot;name&quot;, &quot;throwable&quot;);
map.put(&quot;age&quot;, 25);
MapPropertySource mapPropertySource = new MapPropertySource(&quot;map&quot;, map);
mutablePropertySources.addLast(mapPropertySource);
Properties properties = new Properties();
PropertiesPropertySource propertiesPropertySource = new PropertiesPropertySource(&quot;prop&quot;, properties);
properties.put(&quot;name&quot;, &quot;doge&quot;);
properties.put(&quot;gourp&quot;, &quot;group-a&quot;);
mutablePropertySources.addBefore(&quot;map&quot;, propertiesPropertySource);
System.out.println(mutablePropertySources);&lt;/code&gt;
&lt;/pre&gt;

&lt;p&gt;Environment加载的源码位于&lt;code&gt;SpringApplication#prepareEnvironment&lt;/code&gt;：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;    private ConfigurableEnvironment prepareEnvironment(
            SpringApplicationRunListeners listeners,
            ApplicationArguments applicationArguments) {
        // Create and configure the environment
        //创建ConfigurableEnvironment实例
        ConfigurableEnvironment environment = getOrCreateEnvironment();
        //启动参数绑定到ConfigurableEnvironment中
        configureEnvironment(environment, applicationArguments.getSourceArgs());
        //发布ConfigurableEnvironment准备完毕事件
        listeners.environmentPrepared(environment);
        //绑定ConfigurableEnvironment到当前的SpringApplication实例中
        bindToSpringApplication(environment);
        //这一步是非SpringMVC项目的处理，暂时忽略
        if (this.webApplicationType == WebApplicationType.NONE) {
            environment = new EnvironmentConverter(getClassLoader())
                    .convertToStandardEnvironmentIfNecessary(environment);
        }
        //绑定ConfigurationPropertySourcesPropertySource到ConfigurableEnvironment中，name为configurationProperties，实例是SpringConfigurationPropertySources，属性实际是ConfigurableEnvironment中的MutablePropertySources
        ConfigurationPropertySources.attach(environment);
        return environment;
    }&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;这里重点看下&lt;code&gt;getOrCreateEnvironment&lt;/code&gt;方法：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;private ConfigurableEnvironment getOrCreateEnvironment() {
    if (this.environment != null) {
        return this.environment;
    }
    //在SpringMVC项目，ConfigurableEnvironment接口的实例就是新建的StandardServletEnvironment实例
    if (this.webApplicationType == WebApplicationType.SERVLET) {
        return new StandardServletEnvironment();
    }
    return new StandardEnvironment();
}
//REACTIVE_WEB_ENVIRONMENT_CLASS=org.springframework.web.reactive.DispatcherHandler
//MVC_WEB_ENVIRONMENT_CLASS=org.springframework.web.servlet.DispatcherServlet
//MVC_WEB_ENVIRONMENT_CLASS={&quot;javax.servlet.Servlet&quot;,&quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot;}
//这里，默认就是WebApplicationType.SERVLET
private WebApplicationType deduceWebApplicationType() {
    if (ClassUtils.isPresent(REACTIVE_WEB_ENVIRONMENT_CLASS, null)
        &amp;amp;&amp;amp; !ClassUtils.isPresent(MVC_WEB_ENVIRONMENT_CLASS, null)) {
        return WebApplicationType.REACTIVE;
    }
    for (String className : WEB_ENVIRONMENT_CLASSES) {
        if (!ClassUtils.isPresent(className, null)) {
            return WebApplicationType.NONE;
        }
    }
    return WebApplicationType.SERVLET;
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;还有一个地方要重点关注：发布ConfigurableEnvironment准备完毕事件&lt;code&gt;listeners.environmentPrepared(environment)&lt;/code&gt;，实际上这里用到了同步的EventBus，事件的监听者是ConfigFileApplicationListener，具体处理逻辑是&lt;code&gt;onApplicationEnvironmentPreparedEvent&lt;/code&gt;方法：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;private void onApplicationEnvironmentPreparedEvent(
            ApplicationEnvironmentPreparedEvent event) {
    List&amp;lt;EnvironmentPostProcessor&amp;gt; postProcessors = loadPostProcessors();
    postProcessors.add(this);
    AnnotationAwareOrderComparator.sort(postProcessors);
    //遍历所有的EnvironmentPostProcessor对Environment实例进行处理
    for (EnvironmentPostProcessor postProcessor : postProcessors) {
        postProcessor.postProcessEnvironment(event.getEnvironment(),
                    event.getSpringApplication());
    }
}

//从spring.factories文件中加载，一共有四个实例
//ConfigFileApplicationListener
//CloudFoundryVcapEnvironmentPostProcessor
//SpringApplicationJsonEnvironmentPostProcessor
//SystemEnvironmentPropertySourceEnvironmentPostProcessor
List&amp;lt;EnvironmentPostProcessor&amp;gt; loadPostProcessors() {
    return SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor.class,
                getClass().getClassLoader());
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;实际上，处理工作大部分都在ConfigFileApplicationListener中，见它的&lt;code&gt;postProcessEnvironment&lt;/code&gt;方法：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public void postProcessEnvironment(ConfigurableEnvironment environment,
            SpringApplication application) {
    addPropertySources(environment, application.getResourceLoader());
}

protected void addPropertySources(ConfigurableEnvironment environment,
            ResourceLoader resourceLoader) {
    RandomValuePropertySource.addToEnvironment(environment);
    new Loader(environment, resourceLoader).load();
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;主要的配置环境加载逻辑在内部类Loader，Loader会匹配多个路径下的文件把属性加载到ConfigurableEnvironment中，加载器主要是PropertySourceLoader的实例，例如我们用到application-${profile}.yaml文件做应用主配置文件，使用的是YamlPropertySourceLoader，这个时候activeProfiles也会被设置到ConfigurableEnvironment中。加载完毕之后，ConfigurableEnvironment中基本包含了所有需要加载的属性(activeProfiles是这个时候被写入ConfigurableEnvironment)。值得注意的是，几乎所有属性都是key-value形式存储，如xxx.yyyy.zzzzz=value、xxx.yyyy[0].zzzzz=value-1、xxx.yyyy[1].zzzzz=value-2。&lt;code&gt;Loader&lt;/code&gt;中的逻辑相对复杂，有比较多的遍历和过滤条件，这里不做展开。&lt;/p&gt;

&lt;p&gt;上文提到过，都是委托到PropertySourcesPropertyResolver，先看它的构造函数：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;@Nullable
private final PropertySources propertySources;

public PropertySourcesPropertyResolver(@Nullable PropertySources propertySources) {
        this.propertySources = propertySources;
    }&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;只依赖于一个PropertySources实例，在SpringBoot的SpringMVC项目中就是MutablePropertySources的实例。重点分析一下最复杂的一个方法：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;protected &amp;lt;T&amp;gt; T getProperty(String key, Class&amp;lt;T&amp;gt; targetValueType, boolean resolveNestedPlaceholders) {
    if (this.propertySources != null) {
        //遍历所有的PropertySource
        for (PropertySource&amp;lt;?&amp;gt; propertySource : this.propertySources) {
            if (logger.isTraceEnabled()) {
                logger.trace(&quot;Searching for key '&quot; + key + &quot;' in PropertySource '&quot; +
                            propertySource.getName() + &quot;'&quot;);
            }
            Object value = propertySource.getProperty(key);
            //选用第一个不为null的匹配key的属性值
            if (value != null) {
                if (resolveNestedPlaceholders &amp;amp;&amp;amp; value instanceof String) {
                    //处理属性占位符，如${server.port}，底层委托到PropertyPlaceholderHelper完成
                    value = resolveNestedPlaceholders((String) value);
                }
                logKeyFound(key, propertySource, value);
                //如果需要的话，进行一次类型转换，底层委托到DefaultConversionService完成
                return convertValueIfNecessary(value, targetValueType);
            }
        }
    }
    if (logger.isDebugEnabled()) {
        logger.debug(&quot;Could not find key '&quot; + key + &quot;' in any property source&quot;);
    }
    return null;
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;这里的源码告诉我们，如果出现多个PropertySource中存在同名的key，返回的是第一个PropertySource对应key的属性值的处理结果，因此我们如果需要自定义一些环境属性，需要十分清楚各个PropertySource的顺序。&lt;/p&gt;

&lt;p&gt;在不使用SpringCloud配置中心的情况下，一般的SpringBoot项目的配置文件如下：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;- src
 - main
  - resources
   - application-prod.yaml
   - application-dev.yaml
   - application-test.yaml&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;随着项目发展，配置项越来越多，导致了application-${profile}.yaml迅速膨胀，大的配置文件甚至超过一千行，为了简化和划分不同功能的配置，可以考虑把配置文件拆分如下：&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;- src
 - main
  - resources
   - profiles
     - dev
       - business.yaml
       - mq.json
       - datasource.properties
     - prod
       - business.yaml
       - mq.json
       - datasource.properties
     - test  
       - business.yaml
       - mq.json  
       - datasource.properties
   - application-prod.yaml
   - application-dev.yaml
   - application-test.yaml&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;外层的application-${profile}.yaml只留下项目的核心配置如server.port等，其他配置打散放在/profiles/${profile}/各自的配置文件中。实现方式是：依据当前配置的spring.profiles.active属性，读取类路径中指定文件夹下的配置文件中，加载到Environment中，需要注意这一个加载步骤必须在Spring刷新上下文方法最后一步&lt;code&gt;finishRefresh&lt;/code&gt;之前完成(这一点原因可以参考之前在&lt;a href=&quot;http://throwable.club&quot;&gt;个人博客&lt;/a&gt;写过的SpringBoot刷新上下文源码的分析)，否则有可能会影响到占位符属性的自动装配(例如使用了@Value(&quot;${filed}&quot;))。&lt;/p&gt;
&lt;p&gt;先定义一个属性探索者接口：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public interface PropertySourceDetector {

    /**
     * 获取支持的文件后缀数组
     *
     * @return String[]
     */
    String[] getFileExtensions();

    /**
     * 加载目标文件属性到环境中
     *
     * @param environment environment
     * @param name        name
     * @param resource    resource
     * @throws IOException IOException
     */
    void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException;
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;然后需要一个抽象属性探索者把Resource转换为字符串，额外提供Map的缩进、添加PropertySource到Environment等方法：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public abstract class AbstractPropertySourceDetector implements PropertySourceDetector {

    private static final String SERVLET_ENVIRONMENT_CLASS = &quot;org.springframework.web.&quot;
            + &quot;context.support.StandardServletEnvironment&quot;;

    public boolean support(String fileExtension) {
        String[] fileExtensions = getFileExtensions();
        return null != fileExtensions &amp;amp;&amp;amp;
                Arrays.stream(fileExtensions).anyMatch(extension -&amp;gt; extension.equals(fileExtension));
    }

    private String findPropertySource(MutablePropertySources sources) {
        if (ClassUtils.isPresent(SERVLET_ENVIRONMENT_CLASS, null) &amp;amp;&amp;amp; sources
                .contains(StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME)) {
            return StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME;
        }
        return StandardEnvironment.SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME;
    }

    protected void addPropertySource(ConfigurableEnvironment environment, PropertySource&amp;lt;?&amp;gt; source) {
        MutablePropertySources sources = environment.getPropertySources();
        String name = findPropertySource(sources);
        if (sources.contains(name)) {
            sources.addBefore(name, source);
        } else {
            sources.addFirst(source);
        }
    }

    protected Map&amp;lt;String, Object&amp;gt; flatten(Map&amp;lt;String, Object&amp;gt; map) {
        Map&amp;lt;String, Object&amp;gt; result = new LinkedHashMap&amp;lt;&amp;gt;();
        flatten(null, result, map);
        return result;
    }

    private void flatten(String prefix, Map&amp;lt;String, Object&amp;gt; result, Map&amp;lt;String, Object&amp;gt; map) {
        String namePrefix = (prefix != null ? prefix + &quot;.&quot; : &quot;&quot;);
        map.forEach((key, value) -&amp;gt; extract(namePrefix + key, result, value));
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private void extract(String name, Map&amp;lt;String, Object&amp;gt; result, Object value) {
        if (value instanceof Map) {
            flatten(name, result, (Map&amp;lt;String, Object&amp;gt;) value);
        } else if (value instanceof Collection) {
            int index = 0;
            for (Object object : (Collection&amp;lt;Object&amp;gt;) value) {
                extract(name + &quot;[&quot; + index + &quot;]&quot;, result, object);
                index++;
            }
        } else {
            result.put(name, value);
        }
    }

    protected String getContentStringFromResource(Resource resource) throws IOException {
        return StreamUtils.copyToString(resource.getInputStream(), Charset.forName(&quot;UTF-8&quot;));
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;上面的方法参考SpringApplicationJsonEnvironmentPostProcessor，然后编写各种类型配置属性探索者的实现：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;//Json
@Slf4j
public class JsonPropertySourceDetector extends AbstractPropertySourceDetector {

    private static final JsonParser JSON_PARSER = JsonParserFactory.getJsonParser();

    @Override
    public String[] getFileExtensions() {
        return new String[]{&quot;json&quot;};
    }

    @Override
    public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException {
        try {
            Map&amp;lt;String, Object&amp;gt; map = JSON_PARSER.parseMap(getContentStringFromResource(resource));
            Map&amp;lt;String, Object&amp;gt; target = flatten(map);
            addPropertySource(environment, new MapPropertySource(name, target));
        } catch (Exception e) {
            log.warn(&quot;加载Json文件属性到环境变量失败,name = {},resource = {}&quot;, name, resource);
        }
    }
}
//Properties
public class PropertiesPropertySourceDetector extends AbstractPropertySourceDetector {

    @Override
    public String[] getFileExtensions() {
        return new String[]{&quot;properties&quot;, &quot;conf&quot;};
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException {
        Map map = PropertiesLoaderUtils.loadProperties(resource);
        addPropertySource(environment, new MapPropertySource(name, map));
    }
}
//Yaml
@Slf4j
public class YamlPropertySourceDetector extends AbstractPropertySourceDetector {

    private static final JsonParser YAML_PARSER = new YamlJsonParser();

    @Override
    public String[] getFileExtensions() {
        return new String[]{&quot;yaml&quot;, &quot;yml&quot;};
    }

    @Override
    public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException {
        try {
            Map&amp;lt;String, Object&amp;gt; map = YAML_PARSER.parseMap(getContentStringFromResource(resource));
            Map&amp;lt;String, Object&amp;gt; target = flatten(map);
            addPropertySource(environment, new MapPropertySource(name, target));
        } catch (Exception e) {
            log.warn(&quot;加载Yaml文件属性到环境变量失败,name = {},resource = {}&quot;, name, resource);
        }
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;子类的全部PropertySource都是MapPropertySource，name为文件的名称，所有PropertySource都用&lt;code&gt;addBefore&lt;/code&gt;方法插入到&lt;code&gt;systemProperties&lt;/code&gt;的前面，主要是为了提高匹配属性的优先级。接着需要定义一个属性探索者的合成类用来装载所有的子类：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public class PropertySourceDetectorComposite implements PropertySourceDetector {

    private static final String DEFAULT_SUFFIX = &quot;properties&quot;;
    private final List&amp;lt;AbstractPropertySourceDetector&amp;gt; propertySourceDetectors = new ArrayList&amp;lt;&amp;gt;();

    public void addPropertySourceDetector(AbstractPropertySourceDetector sourceDetector) {
        propertySourceDetectors.add(sourceDetector);
    }

    public void addPropertySourceDetectors(List&amp;lt;AbstractPropertySourceDetector&amp;gt; sourceDetectors) {
        propertySourceDetectors.addAll(sourceDetectors);
    }

    public List&amp;lt;AbstractPropertySourceDetector&amp;gt; getPropertySourceDetectors() {
        return Collections.unmodifiableList(propertySourceDetectors);
    }

    @Override
    public String[] getFileExtensions() {
        List&amp;lt;String&amp;gt; fileExtensions = new ArrayList&amp;lt;&amp;gt;(8);
        for (AbstractPropertySourceDetector propertySourceDetector : propertySourceDetectors) {
            fileExtensions.addAll(Arrays.asList(propertySourceDetector.getFileExtensions()));
        }
        return fileExtensions.toArray(new String[0]);
    }

    @Override
    public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException {
        if (resource.isFile()) {
            String fileName = resource.getFile().getName();
            int index = fileName.lastIndexOf(&quot;.&quot;);
            String suffix;
            if (-1 == index) {
                //如果文件没有后缀,当作properties处理
                suffix = DEFAULT_SUFFIX;
            } else {
                suffix = fileName.substring(index + 1);
            }
            for (AbstractPropertySourceDetector propertySourceDetector : propertySourceDetectors) {
                if (propertySourceDetector.support(suffix)) {
                    propertySourceDetector.load(environment, name, resource);
                    return;
                }
            }
        }
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;最后添加一个配置类作为入口：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;public class PropertySourceDetectorConfiguration implements ImportBeanDefinitionRegistrar {

    private static final String PATH_PREFIX = &quot;profiles&quot;;

    @Override
    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) {
        DefaultListableBeanFactory beanFactory = (DefaultListableBeanFactory) registry;
        ConfigurableEnvironment environment = beanFactory.getBean(ConfigurableEnvironment.class);
        List&amp;lt;AbstractPropertySourceDetector&amp;gt; propertySourceDetectors = new ArrayList&amp;lt;&amp;gt;();
        configurePropertySourceDetectors(propertySourceDetectors, beanFactory);
        PropertySourceDetectorComposite propertySourceDetectorComposite = new PropertySourceDetectorComposite();
        propertySourceDetectorComposite.addPropertySourceDetectors(propertySourceDetectors);
        String[] activeProfiles = environment.getActiveProfiles();
        ResourcePatternResolver resourcePatternResolver = new PathMatchingResourcePatternResolver();
        try {
            for (String profile : activeProfiles) {
                String location = PATH_PREFIX + File.separator + profile + File.separator + &quot;*&quot;;
                Resource[] resources = resourcePatternResolver.getResources(location);
                for (Resource resource : resources) {
                    propertySourceDetectorComposite.load(environment, resource.getFilename(), resource);
                }
            }
        } catch (IOException e) {
            throw new IllegalStateException(e);
        }
    }

    private void configurePropertySourceDetectors(List&amp;lt;AbstractPropertySourceDetector&amp;gt; propertySourceDetectors,
                                                  DefaultListableBeanFactory beanFactory) {
        Map&amp;lt;String, AbstractPropertySourceDetector&amp;gt; beansOfType = beanFactory.getBeansOfType(AbstractPropertySourceDetector.class);
        for (Map.Entry&amp;lt;String, AbstractPropertySourceDetector&amp;gt; entry : beansOfType.entrySet()) {
            propertySourceDetectors.add(entry.getValue());
        }
        propertySourceDetectors.add(new JsonPropertySourceDetector());
        propertySourceDetectors.add(new YamlPropertySourceDetector());
        propertySourceDetectors.add(new PropertiesPropertySourceDetector());
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;准备就绪，在/resources/profiles/dev下面添加两个文件app.json和conf：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;//app.json
{
  &quot;app&quot;: {
    &quot;name&quot;: &quot;throwable&quot;,
    &quot;age&quot;: 25
  }
}
//conf
name=doge&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;项目的application.yaml添加属性spring.profiles.active: dev，最后添加一个CommandLineRunner的实现用来观察数据：&lt;/p&gt;
&lt;pre class=&quot;java&quot;&gt;
&lt;code&gt;@Slf4j
@Component
public class CustomCommandLineRunner implements CommandLineRunner {

    @Value(&quot;${app.name}&quot;)
    String name;
    @Value(&quot;${app.age}&quot;)
    Integer age;
    @Autowired
    ConfigurableEnvironment configurableEnvironment;

    @Override
    public void run(String... args) throws Exception {
        log.info(&quot;name = {},age = {}&quot;, name, age);
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;http://pazkqls86.bkt.clouddn.com/spe-3.png&quot; alt=&quot;spe-3&quot;/&gt;&lt;/p&gt;
&lt;p&gt;自动装配的属性值和Environment实例中的属性和预期一样，改造是成功的。&lt;/p&gt;

&lt;p&gt;Spring中的环境属性管理的源码个人认为是最清晰和简单的：从文件中读取数据转化为key-value结构，key-value结构存放在一个PropertySource实例中，然后得到的多个PropertySource实例存放在一个CopyOnWriteArrayList中，属性访问的时候总是遍历CopyOnWriteArrayList中的PropertySource进行匹配。可能相对复杂的就是占位符的解析和参数类型的转换，后者牵连到Converter体系，这些不在本文的讨论范围内。&lt;/p&gt;
&lt;p&gt;参考资料：&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;spring-boot-starter-web:2.0.3.RELEASE源码。&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;（本文完）&lt;/p&gt;
</description>
<pubDate>Thu, 02 Aug 2018 17:02:00 +0000</pubDate>
<dc:creator>throwable</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/throwable/p/9411100.html</dc:identifier>
</item>
<item>
<title>.NET Core2.1获取自定义配置文件信息 - 潇十一郎</title>
<link>http://www.cnblogs.com/zhangxiaoyong/p/9411036.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/zhangxiaoyong/p/9411036.html</guid>
<description>&lt;h4&gt;前言&lt;/h4&gt;
&lt;p&gt;  .net core来势已不可阻挡。既然挡不了，那我们就顺应它。了解它并学习它。今天我们就来看看和之前.net版本的配置文件读取方式有何异同，这里不在赘述.NET Core 基础知识。&lt;/p&gt;
&lt;h4&gt;实现&lt;/h4&gt;
&lt;p&gt;&lt;span&gt;注：需要NuGet引入：Microsoft.Extensions.Options.ConfigurationExtensions&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;①我们再配置文件appsettings.json中 新增自定义API Json如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;{
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Logging&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;: {
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;IncludeScopes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;false&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;LogLevel&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;: {
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Default&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Warning&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    }
  },
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;API&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;: {
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;Url&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://localhost:8080/&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;getclub&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;api/club&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  } 
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;②然后我们定义一个静态类，再类中申明一个IConfigurationSection 类型变量&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;private&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; IConfigurationSection _appSection = &lt;span&gt;null&lt;/span&gt;;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;③写一个AppSetting静态方法获取到配置的Value项，代码如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
       &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;string&lt;/span&gt; AppSetting(&lt;span&gt;string&lt;/span&gt;&lt;span&gt; key)
        {
            &lt;/span&gt;&lt;span&gt;string&lt;/span&gt; str = &lt;span&gt;string&lt;/span&gt;&lt;span&gt;.Empty;
            &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (_appSection.GetSection(key) != &lt;span&gt;null&lt;/span&gt;&lt;span&gt;)
            {
                str &lt;/span&gt;=&lt;span&gt; _appSection.GetSection(key).Value;
            }
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; str;
        }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;④需要设置IConfigurationSection初始值，如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;       public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; SetAppSetting(IConfigurationSection section)
        {
            _appSection &lt;/span&gt;=&lt;span&gt; section;
        }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;⑤然后写一个根据不同Json项读取出对应的值即可：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
  &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;string&lt;/span&gt; GetSite(&lt;span&gt;string&lt;/span&gt;&lt;span&gt; apiName)
  {
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; AppSetting(apiName);
  }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;⑥有了以上几个步骤，基本上读取代码已经全部写完，剩下最后一个最重要的步骤，将要读取的Json文件配置到Startup.cs的Configure方法中，如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/762349/201808/762349-20180803001952538-155049273.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;这样，我们就可以很轻松的获取到我们想要的配置项了，整段CS代码如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
    &lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;summary&amp;gt;&lt;/span&gt;
    &lt;span&gt;///&lt;/span&gt;&lt;span&gt; 配置信息读取模型
    &lt;/span&gt;&lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;/summary&amp;gt;&lt;/span&gt;
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; SiteConfig
    {
        &lt;/span&gt;&lt;span&gt;private&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; IConfigurationSection _appSection = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;

        &lt;/span&gt;&lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;summary&amp;gt;&lt;/span&gt;
        &lt;span&gt;///&lt;/span&gt;&lt;span&gt; API域名地址
        &lt;/span&gt;&lt;span&gt;///&lt;/span&gt; &lt;span&gt;&amp;lt;/summary&amp;gt;&lt;/span&gt;
        &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;string&lt;/span&gt; AppSetting(&lt;span&gt;string&lt;/span&gt;&lt;span&gt; key)
        {
            &lt;/span&gt;&lt;span&gt;string&lt;/span&gt; str = &lt;span&gt;string&lt;/span&gt;&lt;span&gt;.Empty;
            &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (_appSection.GetSection(key) != &lt;span&gt;null&lt;/span&gt;&lt;span&gt;)
            {
                str &lt;/span&gt;=&lt;span&gt; _appSection.GetSection(key).Value;
            }
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; str;
        }

        &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; SetAppSetting(IConfigurationSection section)
        {
            _appSection &lt;/span&gt;=&lt;span&gt; section;
        }

        &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;string&lt;/span&gt; GetSite(&lt;span&gt;string&lt;/span&gt;&lt;span&gt; apiName)
        {
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; AppSetting(apiName);
        }
    }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;最后 ，我们来跑一下演示效果如下：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/762349/201808/762349-20180803002911829-1916273417.gif&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
</description>
<pubDate>Thu, 02 Aug 2018 16:30:00 +0000</pubDate>
<dc:creator>潇十一郎</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/zhangxiaoyong/p/9411036.html</dc:identifier>
</item>
<item>
<title>我的第一个python web开发框架（27）——定制ORM（三） - AllEmpty</title>
<link>http://www.cnblogs.com/EmptyFS/p/9410998.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/EmptyFS/p/9410998.html</guid>
<description>&lt;p&gt;&lt;span&gt;　　在上一章中，我们已经创建好ORM的基类了，接下来要做的就是将基类的常用方法一一实现。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　首先我们来看看之前项目中，最常见的获取指定主键的记录实体&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
@get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/api/product/&amp;lt;id:int&amp;gt;/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; callback(id):
    &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;
    获取指定id的产品记录实体
    &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;
    sql &lt;/span&gt;= &lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;select * from product where id = %s&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt; %&lt;span&gt; (id,)
    &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 读取记录&lt;/span&gt;
    result =&lt;span&gt; db_helper.read(sql)
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; result:
&lt;/span&gt;        &lt;span&gt;return&lt;/span&gt; web_helper.return_msg(0, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;成功&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;, result[0])
    &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt;:
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; web_helper.return_msg(-1, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;查询失败&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　从代码中可以看到，我们需要执行select * from product where id = xx从数据表中查询到我们想要的数据。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　要封装成ORM的方法，我需要需要注意下面几项事情：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　1.方法名必须是简单易懂的&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　2.方法需要接收指定的主键值&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　3.sql需要在方法中进行组装&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　根据这些要求，我们可以很容易写出这个方法&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
    &lt;span&gt;def&lt;/span&gt;&lt;span&gt; get_model_for_pk(self, pk):
        &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;通过主键值获取数据库记录实体&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;
        &lt;span&gt;if&lt;/span&gt; &lt;span&gt;not&lt;/span&gt;&lt;span&gt; pk:
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; {}
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 组装查询条件&lt;/span&gt;
        wheres = &lt;span&gt;'&lt;/span&gt;&lt;span&gt;%s = %s&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; % (self.&lt;span&gt;__pk_name&lt;/span&gt;&lt;span&gt;, str(pk))
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 合成sql语句&lt;/span&gt;
        sql = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;select %(column_name_list)s from %(table_name)s where %(wheres)s&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; %&lt;span&gt; \
              {&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;column_name_list&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: self.&lt;span&gt;__column_name_list&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;table_name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: self.&lt;span&gt;__table_name&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;wheres&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;: wheres}
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 初化化数据库链接&lt;/span&gt;
        with db_helper.PgHelper(self.&lt;span&gt;__db&lt;/span&gt;, self.&lt;span&gt;__is_output_sql&lt;/span&gt;&lt;span&gt;) as db:
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 执行sql语句&lt;/span&gt;
            _result =&lt;span&gt; db.execute(sql)
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 对返回的内容进行处理&lt;/span&gt;
            &lt;span&gt;if&lt;/span&gt;&lt;span&gt; _result:
                result &lt;/span&gt;=&lt;span&gt; _result[0]
            &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt;:
                result &lt;/span&gt;=&lt;span&gt; {}
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; result
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　我们通过方法名（get_model_for_pk）应当可以知道，我们是通过主键来获取指定的记录实体内容。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　该方法需要传入的参数值是主键值pk&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　在接收到主健值以后，我们需要对它进行简单的判断处理，如果它为空则直接返回空字典。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　在组合sql前，我们需要选对查询条件进行组装，这里我们直接使用self.__pk_name，在上一章初始化时定义好的默认项，在这里不直接使用id做为条件字段，是为了当出现主键名称为其他字符时，可以灵活处理。比如订单表使用code为主键时，就可以直接绑定code而不是自增id了。比如self.__pk_name初始值是id，主键pk值是1，那么组装后的查询条件为 id=1&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　然后直接调用默认项查询字段名称self.__column_name_list和表名称self.__table_name来合成sql语句。例如self.__column_name_list初始值为*，self.__table_name初始值为product，那么合成的sql语句为：select * from product where id=1&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　最后调用数据库操作类db_helper来执行sql语句（这里使用widh方法来初始化数据库操作类），将执行后的结果返回主程序&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;　　针对上面这个读取产品记录实体的功能，我们像上一章一样，先创建好一个产品管理的逻辑类，继承ORM基类&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;38&quot;&gt;
&lt;pre&gt;
&lt;span&gt;#&lt;/span&gt;&lt;span&gt;!/usr/bin/env python&lt;/span&gt;&lt;span&gt;
#&lt;/span&gt;&lt;span&gt; coding=utf-8&lt;/span&gt;

&lt;span&gt;from&lt;/span&gt; logic &lt;span&gt;import&lt;/span&gt;&lt;span&gt; _logic_base
&lt;/span&gt;&lt;span&gt;from&lt;/span&gt; config &lt;span&gt;import&lt;/span&gt;&lt;span&gt; db_config


&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt; ProductLogic(_logic_base.LogicBase):
    &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;产品管理表逻辑类&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;

    &lt;span&gt;def&lt;/span&gt; &lt;span&gt;__init__&lt;/span&gt;&lt;span&gt;(self):
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 表名称&lt;/span&gt;
        &lt;span&gt;__table_name&lt;/span&gt; = &lt;span&gt;'&lt;/span&gt;&lt;span&gt;product&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;
        &lt;span&gt;#&lt;/span&gt;&lt;span&gt; 初始化&lt;/span&gt;
        _logic_base.LogicBase.&lt;span&gt;__init__&lt;/span&gt;(self, db_config.DB, db_config.IS_OUTPUT_SQL, &lt;span&gt;__table_name&lt;/span&gt;)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　我们就可以直接改造前面的接口调用代码了&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;38&quot;&gt;
&lt;pre&gt;
@get(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/api/product/&amp;lt;id:int&amp;gt;/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
&lt;/span&gt;&lt;span&gt;def&lt;/span&gt;&lt;span&gt; callback(id):
    &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;
    获取指定记录
    &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;
    &lt;span&gt;#&lt;/span&gt;&lt;span&gt; 实例化product表操作类ProductLogic&lt;/span&gt;
    _product_logic =&lt;span&gt; product_logic.ProductLogic()
    &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 执行get_model_for_pk()方法，获取记录实体&lt;/span&gt;
    model =&lt;span&gt; _product_logic.get_model_for_pk(id)
    &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; model:
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; web_helper.return_msg(0, &lt;span&gt;'查询&lt;/span&gt;&lt;span&gt;成功&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;, model)
    &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt;:
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; web_helper.return_msg(-1, &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;查询失败&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　和前面的代码比较，代码看起来简单多了&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　直接上单元测试看看执行效果&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;#&lt;/span&gt;&lt;span&gt;!/usr/bin/evn python&lt;/span&gt;
&lt;span&gt; 2&lt;/span&gt; &lt;span&gt;#&lt;/span&gt;&lt;span&gt; coding=utf-8&lt;/span&gt;
&lt;span&gt; 3&lt;/span&gt; 
&lt;span&gt; 4&lt;/span&gt; &lt;span&gt;import&lt;/span&gt;&lt;span&gt; unittest
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt; &lt;span&gt;from&lt;/span&gt; logic &lt;span&gt;import&lt;/span&gt;&lt;span&gt; product_logic
&lt;/span&gt;&lt;span&gt; 6&lt;/span&gt; 
&lt;span&gt; 7&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; DbHelperTest(unittest.TestCase):
&lt;/span&gt;&lt;span&gt; 8&lt;/span&gt;     &lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;数据库操作包测试类&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;
&lt;span&gt; 9&lt;/span&gt; 
&lt;span&gt;10&lt;/span&gt;     &lt;span&gt;def&lt;/span&gt;&lt;span&gt; setUp(self):
&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;         &lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;初始化测试环境&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;
&lt;span&gt;12&lt;/span&gt;         &lt;span&gt;print&lt;/span&gt;(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;------ini------&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt; 
&lt;span&gt;14&lt;/span&gt;     &lt;span&gt;def&lt;/span&gt;&lt;span&gt; tearDown(self):
&lt;/span&gt;&lt;span&gt;15&lt;/span&gt;         &lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;清理测试环境&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;
&lt;span&gt;16&lt;/span&gt;         &lt;span&gt;print&lt;/span&gt;(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;------clear------&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
&lt;/span&gt;&lt;span&gt;17&lt;/span&gt; 
&lt;span&gt;18&lt;/span&gt;     &lt;span&gt;def&lt;/span&gt;&lt;span&gt; test(self):
&lt;/span&gt;&lt;span&gt;19&lt;/span&gt;         &lt;span&gt;#&lt;/span&gt;&lt;span&gt;#############################################&lt;/span&gt;
&lt;span&gt;20&lt;/span&gt;         &lt;span&gt;#&lt;/span&gt;&lt;span&gt; 只需要看这里，其他代码是测试用例的模板代码 #&lt;/span&gt;
&lt;span&gt;21&lt;/span&gt;         &lt;span&gt;#&lt;/span&gt;&lt;span&gt;#############################################&lt;/span&gt;
&lt;span&gt;22&lt;/span&gt;         &lt;span&gt;#&lt;/span&gt;&lt;span&gt; 实例化product表操作类ProductLogic&lt;/span&gt;
&lt;span&gt;23&lt;/span&gt;         _product_logic =&lt;span&gt; product_logic.ProductLogic()
&lt;/span&gt;&lt;span&gt;24&lt;/span&gt;         &lt;span&gt;#&lt;/span&gt;&lt;span&gt; 执行get_model_for_pk()方法，获取记录实体&lt;/span&gt;
&lt;span&gt;25&lt;/span&gt;         model = _product_logic.get_model_for_pk(2&lt;span&gt;)
&lt;/span&gt;&lt;span&gt;26&lt;/span&gt;         &lt;span&gt;print&lt;/span&gt;&lt;span&gt;(model)
&lt;/span&gt;&lt;span&gt;27&lt;/span&gt; 
&lt;span&gt;28&lt;/span&gt;         &lt;span&gt;#&lt;/span&gt;&lt;span&gt;#############################################&lt;/span&gt;
&lt;span&gt;29&lt;/span&gt; 
&lt;span&gt;30&lt;/span&gt; &lt;span&gt;if&lt;/span&gt; &lt;span&gt;__name__&lt;/span&gt; == &lt;span&gt;'&lt;/span&gt;&lt;span&gt;__main__&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;:
&lt;/span&gt;&lt;span&gt;31&lt;/span&gt;     unittest.main()
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　输出结果：&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;50&quot;&gt;
&lt;pre&gt;
------ini------&lt;span&gt;
{&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;product_class_id&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: 1, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;place_of_origin&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;广东广州&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;饼干&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;id&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: 2, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;standard&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;500g&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;is_enable&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: 1, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;add_time&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: datetime.datetime(2018, 7, 25, 23, 10, 4), &lt;span&gt;'&lt;/span&gt;&lt;span&gt;quality_guarantee_period&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;2018年12月&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;code&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;20180212321211&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;content&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;产品描述&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;front_cover_img&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: &lt;span&gt;'&lt;/span&gt;&lt;span&gt;http://xxx.com/xxx.jpg&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;}
&lt;/span&gt;------clear------
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;span&gt;　　做到这一步，一个简单的通过主键值读取数据表记录实体的ORM方法就完成了。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　为了让这个读取记录实体的功能能应用的更加广泛，我们还需要对它进行改造与加工。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　在开始之前，大家再继续思考一下，我们获取记录实体，通过主键查询只是众多方法中的其中一个，我们还会经常使用各种条件的组合来进行查询，读取记录实体，所以这里我们可以实现自定义条件查询的方法&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
    &lt;span&gt;def&lt;/span&gt;&lt;span&gt; get_model(self, wheres):
        &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;通过条件获取一条记录&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;
        &lt;span&gt;#&lt;/span&gt;&lt;span&gt; 如果有条件，则自动添加where&lt;/span&gt;
        &lt;span&gt;if&lt;/span&gt;&lt;span&gt; wheres:
            wheres &lt;/span&gt;= &lt;span&gt;'&lt;/span&gt;&lt;span&gt; where &lt;/span&gt;&lt;span&gt;'&lt;/span&gt; +&lt;span&gt; wheres

        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 合成sql语句&lt;/span&gt;
        sql = &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;select %(column_name_list)s from %(table_name)s %(wheres)s&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; %&lt;span&gt; \
              {&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;column_name_list&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: self.&lt;span&gt;__column_name_list&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;table_name&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;: self.&lt;span&gt;__table_name&lt;/span&gt;, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;wheres&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;: wheres}
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 初化化数据库链接&lt;/span&gt;
        with db_helper.PgHelper(self.&lt;span&gt;__db&lt;/span&gt;, self.&lt;span&gt;__is_output_sql&lt;/span&gt;&lt;span&gt;) as db:
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 执行sql语句&lt;/span&gt;
            _result =&lt;span&gt; db.execute(sql)
            &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 对返回的内容进行处理&lt;/span&gt;
            &lt;span&gt;if&lt;/span&gt;&lt;span&gt; _result:
                result &lt;/span&gt;=&lt;span&gt; _result[0]
            &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt;:
                result &lt;/span&gt;=&lt;span&gt; {}
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; result
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　代码看起来与前面的get_model_for_pk()方法差不多，只不过将pk参数改为条件参数wheres，不需要再组合主键查询条件而已。由于两个函数部分代码一样，所以我们需要对get_model_for_pk()方法进行重构，直接将组装好的查询条件提交给get_model()方法来执行就可以了，将它返回的内容直接返回给主程序。&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
    &lt;span&gt;def&lt;/span&gt; get_model_for_pk(self, pk, wheres=&lt;span&gt;''&lt;/span&gt;&lt;span&gt;):
        &lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;&lt;span&gt;通过主键值获取数据库记录实体&lt;/span&gt;&lt;span&gt;&quot;&quot;&quot;&lt;/span&gt;
        &lt;span&gt;if&lt;/span&gt; &lt;span&gt;not&lt;/span&gt;&lt;span&gt; pk:
            &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; {}
        &lt;/span&gt;&lt;span&gt;#&lt;/span&gt;&lt;span&gt; 组装查询条件&lt;/span&gt;
        wheres = &lt;span&gt;'&lt;/span&gt;&lt;span&gt;%s = %s&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; % (self.&lt;span&gt;__pk_name&lt;/span&gt;&lt;span&gt;, str(pk))

        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; self.get_model(wheres)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　改造完成后，使用前面的单元测试跑一下，可以看到返回结果一样。增加了get_model()方法以后，我们就可以灵活的自定义任意的查询条件来读取记录了。这里要注意的是，使用get_model()方法查询时，有可能在查询时会返回多条记录，这个方法它只返回第一条记录。需要返回多条记录时，可以使用我们后续封装的其他ORM方法。&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;　　&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;　　&lt;strong&gt;&lt;a href=&quot;https://pan.baidu.com/s/1sY-ulHZlOuBgFymsy7d6jQ&quot; target=&quot;_blank&quot;&gt;本文对应的源码下载&lt;/a&gt; （为了方便大家理解，源码包只放了这两章所用到的一些代码）&lt;br/&gt;&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;版权声明：本文原创发表于 &lt;a href=&quot;http://www.cnblogs.com/&quot; target=&quot;_blank&quot;&gt;&lt;span&gt;博客园&lt;/span&gt;&lt;/a&gt;，作者为 &lt;strong&gt;&lt;a href=&quot;http://www.cnblogs.com/EmptyFS/&quot; target=&quot;_blank&quot;&gt;&lt;span&gt;AllEmpty&lt;/span&gt;&lt;/a&gt; &lt;/strong&gt;本文欢迎转载，但未经作者同意必须保留此段声明，且在文章页面明显位置给出原文连接，否则视为侵权。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;python开发QQ群：669058475    作者博客：http://www.cnblogs.com/EmptyFS/&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;

</description>
<pubDate>Thu, 02 Aug 2018 16:15:00 +0000</pubDate>
<dc:creator>AllEmpty</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/EmptyFS/p/9410998.html</dc:identifier>
</item>
<item>
<title>MySQL优化(2)--------常用优化 - JJian</title>
<link>http://www.cnblogs.com/jian0110/p/9410981.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/jian0110/p/9410981.html</guid>
<description>&lt;h2&gt;前言&lt;/h2&gt;
&lt;blockquote readability=&quot;12&quot;&gt;
&lt;p&gt;　　之前已经简单介绍了MySQL的优化步骤，那么接下来自然而是就是常用的SQL优化，比如inseer、group by等常用SQL的优化，会涉及SQL语句内部细节（这正是我缺乏的）。最后希望自己能记录完成的一套MySQL优化博文！&lt;/p&gt;
&lt;p&gt;　&lt;strong&gt;　注：其中部分我并没有全部实验（并不代表是错的），这里只相当于记录下，接下来会慢慢补充！&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;　　&lt;strong&gt;参考资料：《深入浅出MySQL》&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr/&gt;
&lt;h2&gt;1、大批量插入数据优化&lt;/h2&gt;
&lt;p&gt;（1）对于&lt;span&gt;&lt;span&gt;MyISAM&lt;/span&gt;存储引擎的表，可以使用：DISABLE KEYS 和 ENABLE KEYS 用来打开或者关闭 MyISAM 表非唯一索引的更新&lt;/span&gt;。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;ALTER&lt;/span&gt; &lt;span&gt;TABLE&lt;/span&gt;&lt;span&gt; tbl_name DISABLE KEYS;
loading the data
&lt;/span&gt;&lt;span&gt;ALTER&lt;/span&gt; &lt;span&gt;TABLE&lt;/span&gt; tbl_name ENABLE KEYS;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;（2）对于InnoDB引擎，有以下几种优化措施：&lt;/p&gt;
&lt;p&gt;　　① &lt;span&gt;导入的数据按照主键的顺序保存&lt;/span&gt;：这是因为InnoDB引擎表示按照主键顺序保存的，如果能将插入的数据提前按照排序好自然能省去很多时间。&lt;/p&gt;
&lt;p&gt;　　比如bulk_insert.txt文件是以表user主键的顺序存储的，导入的时间为15.23秒&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
mysql&lt;span&gt;&amp;gt;&lt;/span&gt; &lt;span&gt;load&lt;/span&gt; data infile &lt;span&gt;'&lt;/span&gt;&lt;span&gt;mysql/bulk_insert.txt&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;table&lt;/span&gt;&lt;span&gt; user;
Query OK, &lt;/span&gt;&lt;span&gt;126732&lt;/span&gt; rows affected (&lt;span&gt;15.23&lt;/span&gt;&lt;span&gt; sec)
Records: &lt;/span&gt;&lt;span&gt;126732&lt;/span&gt; Deleted: &lt;span&gt;0&lt;/span&gt; Skipped: &lt;span&gt;0&lt;/span&gt; Warnings: &lt;span&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　没有按照主键排序的话，时间为：26.54秒&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
mysql&lt;span&gt;&amp;gt;&lt;/span&gt; &lt;span&gt;load&lt;/span&gt; data infile &lt;span&gt;'&lt;/span&gt;&lt;span&gt;mysql/bulk_insert.txt&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;table&lt;/span&gt; &lt;span&gt;user&lt;/span&gt;&lt;span&gt;;
Query OK, &lt;/span&gt;&lt;span&gt;126732&lt;/span&gt; rows affected (&lt;span&gt;26.54&lt;/span&gt;&lt;span&gt; sec)
Records: &lt;/span&gt;&lt;span&gt;126732&lt;/span&gt; Deleted: &lt;span&gt;0&lt;/span&gt; Skipped: &lt;span&gt;0&lt;/span&gt; Warnings: &lt;span&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　② &lt;span&gt;导入数据前执行SET UNIQUE_CHECKS=0，关闭唯一性校验，带导入之后再打开设置为1&lt;/span&gt;：校验会消耗时间，在数据量大的情况下需要考虑。&lt;/p&gt;
&lt;p&gt;　　③&lt;span&gt; &lt;/span&gt;&lt;span&gt;导入前设置SET AUTOCOMMIT=0，关闭自动提交，导入后结束再设置为1：&lt;/span&gt;这是因为自动提交会消耗部分时间与资源，虽然消耗不是很大，但是在数据量大的情况下还是得考虑。&lt;/p&gt;
&lt;h2&gt;2、INSERT的优化&lt;/h2&gt;
&lt;p&gt;（1）&lt;span&gt;尽量使用多个值表的 INSERT 语句，这种方式将大大缩减客户端与数据库之间的连接、关闭等消耗。&lt;/span&gt;（同一客户的情况下），即：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
　&lt;span&gt;INSERT&lt;/span&gt; &lt;span&gt;INTO&lt;/span&gt; tablename &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;1&lt;/span&gt;,&lt;span&gt;2&lt;/span&gt;),(&lt;span&gt;1&lt;/span&gt;,&lt;span&gt;3&lt;/span&gt;),(&lt;span&gt;1&lt;/span&gt;,&lt;span&gt;4&lt;/span&gt;)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;实验：插入8条数据到user表中（使用navicat客户端工具）&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;67&quot;&gt;
&lt;pre&gt;
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;1&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;2&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;3&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;4&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;5&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;6&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;7&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;8&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;));
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;得到反馈：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;67&quot;&gt;
&lt;pre&gt;
&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; &lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;1&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;.033s
&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; 
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;2&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;.034s
&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; 
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;3&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;.056s
&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; 
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;4&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;.008s
&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; 
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;5&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;.008s
&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; 
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;6&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;.024s
&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; 
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;7&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;.004s
&lt;/span&gt;&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; 
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;(&lt;span&gt;8&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;1&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;.004s
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;总共的时间为0.171秒，接下来使用多值表形式：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;74&quot;&gt;
&lt;pre&gt;
&lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;&lt;span&gt;
(&lt;/span&gt;&lt;span&gt;9&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;10&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;12&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;13&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;14&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;15&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;16&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;));
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;得到反馈：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;74&quot;&gt;
&lt;pre&gt;
&lt;span&gt;[&lt;/span&gt;&lt;span&gt;SQL&lt;/span&gt;&lt;span&gt;]&lt;/span&gt; &lt;span&gt;insert&lt;/span&gt; &lt;span&gt;into&lt;/span&gt; &lt;span&gt;user&lt;/span&gt; &lt;span&gt;values&lt;/span&gt;&lt;span&gt;
(&lt;/span&gt;&lt;span&gt;9&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;10&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;12&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;13&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;14&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;15&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;)),
(&lt;/span&gt;&lt;span&gt;16&lt;/span&gt;,&lt;span&gt;'&lt;/span&gt;&lt;span&gt;test&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;replace&lt;/span&gt;(uuid(),&lt;span&gt;'&lt;/span&gt;&lt;span&gt;-&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,&lt;span&gt;''&lt;/span&gt;&lt;span&gt;));
受影响的行: &lt;/span&gt;&lt;span&gt;8&lt;/span&gt;&lt;span&gt;
时间: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;.038s
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;得到时间为0.038，这样一来可以很明显节约时间优化SQL&lt;/p&gt;
&lt;p&gt;（2）如果在不同客户端插入很多行，&lt;span&gt;可使用INSERT DELAYED语句得到更高的速度，DELLAYED含义是让INSERT语句马上执行&lt;/span&gt;，&lt;span&gt;其实数据都被放在内存的队列中。并没有真正写入磁盘&lt;/span&gt;。LOW_PRIORITY刚好相反。&lt;/p&gt;
&lt;p&gt;（3）&lt;span&gt;将索引文件和数据文件分在不同的磁盘上存放&lt;/span&gt;（&lt;span&gt;InnoDB引擎是在同一个表空间的&lt;/span&gt;）。&lt;/p&gt;
&lt;p&gt;（4）如果&lt;span&gt;批量插入，则可以增加bluk_insert_buffer_size变量值提供速度&lt;/span&gt;（&lt;span&gt;只对MyISAM有用&lt;/span&gt;）&lt;/p&gt;
&lt;p&gt;（5）&lt;span&gt;当从一个文本文件装载一个表时，使用LOAD DATA INFILE，通常比INSERT语句快20倍&lt;/span&gt;。&lt;/p&gt;
&lt;h2&gt;3、GROUP BY的优化&lt;/h2&gt;
&lt;p align=&quot;justify&quot;&gt;&lt;span&gt;　　在默认情况下，&lt;span&gt;MySQL中的GROUP BY语句会对其后出现的字段进行默认排序（非主键情况）&lt;/span&gt;，就好比我们使用ORDER BY col1,col2,col3...所以我们在后面跟上具有相同列（与GROUP BY后出现的col1,col2,col3...相同）ORDER BY子句并没有影响该SQL的实际执行性能。&lt;/span&gt;&lt;/p&gt;
&lt;p align=&quot;justify&quot;&gt;&lt;span&gt;　　那么就会有这样的情况出现，我们对查询到的结果是否已经排序不在乎时，&lt;span&gt;可以使用ORDER BY NULL禁止排序达到优化目的&lt;/span&gt;。下面使用EXPLAIN命令分析SQL。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;　　在user_1中执行select id, sum(money) form user_1 group by name时，会默认排序（&lt;span&gt;注意group by后的column是非index才会体现group by的排序，如果是primary key，那之前说过了InnoDB默认是按照主键index排好序的&lt;/span&gt;）&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
mysql&lt;span&gt;&amp;gt;&lt;/span&gt; &lt;span&gt;select&lt;/span&gt;&lt;span&gt;*&lt;/span&gt;&lt;span&gt;from&lt;/span&gt;&lt;span&gt; user_1;
&lt;/span&gt;&lt;span&gt;+&lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;--+----------+-------+&lt;/span&gt;
&lt;span&gt;|&lt;/span&gt; id &lt;span&gt;|&lt;/span&gt; name     &lt;span&gt;|&lt;/span&gt; &lt;span&gt;money&lt;/span&gt; &lt;span&gt;|&lt;/span&gt;
&lt;span&gt;+&lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;--+----------+-------+&lt;/span&gt;
&lt;span&gt;|&lt;/span&gt;  &lt;span&gt;1&lt;/span&gt; &lt;span&gt;|&lt;/span&gt; Zhangsan &lt;span&gt;|&lt;/span&gt;    &lt;span&gt;32&lt;/span&gt; &lt;span&gt;|&lt;/span&gt;
&lt;span&gt;|&lt;/span&gt;  &lt;span&gt;2&lt;/span&gt; &lt;span&gt;|&lt;/span&gt; Lisi     &lt;span&gt;|&lt;/span&gt;    &lt;span&gt;65&lt;/span&gt; &lt;span&gt;|&lt;/span&gt;
&lt;span&gt;|&lt;/span&gt;  &lt;span&gt;3&lt;/span&gt; &lt;span&gt;|&lt;/span&gt; Wangwu   &lt;span&gt;|&lt;/span&gt;    &lt;span&gt;44&lt;/span&gt; &lt;span&gt;|&lt;/span&gt;
&lt;span&gt;|&lt;/span&gt;  &lt;span&gt;4&lt;/span&gt; &lt;span&gt;|&lt;/span&gt; Lijian   &lt;span&gt;|&lt;/span&gt;   &lt;span&gt;100&lt;/span&gt; &lt;span&gt;|&lt;/span&gt;
&lt;span&gt;+&lt;/span&gt;&lt;span&gt;--&lt;/span&gt;&lt;span&gt;--+----------+-------+&lt;/span&gt;
&lt;span&gt;4&lt;/span&gt; rows &lt;span&gt;in&lt;/span&gt; &lt;span&gt;set&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;不禁止排序，即不使用ORDER BY NULL时：有明显的Using filesort。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;data:image/png;base64,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&quot; alt=&quot;&quot; width=&quot;624&quot; height=&quot;258&quot;/&gt;　　&lt;/p&gt;
&lt;p&gt;当使用ORDER BY NULL禁止排序后，Using filesort不存在&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAnsAAAD0CAYAAADjTeCzAAAWn0lEQVR4nO3dW7LktnkA4O5TZ2F68gq8A1UlqaTy4kqe7JmR9HBWcHZwNqJ9xJEdP8bXSiq+anyiLg1HEAQQIAne0N9XpdJMgwR/guzmPwBJXP/wp7+//uu//+zy8vx0AQCgLw97BwAAwHokewAAHXu8XvcO4Ttffvnl9/7+ySefJMvjz4+iFP/Ueo62n632b22l9gv346z7cEQtYj7DsTm6WxveW9s5b9rZoy3PcPxq85Nc+RYxjHm4vLYNZolb4GPBD2XxDh9FKf6z22L/tji2Rz9GZ0z0bpZ+P+P9Pur3/Mjutc3O9l05sj3a8gzHryY/afUP3bHycDtTvu8PlwP17NW4hwtB70ljTqtjeub2O2uiN2j1/TzzMdzDrb17/k2Ee5D7DtdeF4bfgVQ9j6WNhJXn/uWd+4Ef6+a8lc29sA3rTh2uGIsvFUv4WerP8fJLtl8b39j6a25/7frDsq3ad6op509tL1XpHMxte2z9mrLUdmrbL7eP4Xpzvp9jan47pu5/vEzN9sf2vdX5P+e3sUWSPRZDq/YvfT+W/L7m9qM2hto6c7EtPf/W/P2dc/xa119rj+O3pO5Wpv5uTo3tBw9oDBVM/fEIGye1bly+tDFbxxd/FscXlufqqIl5bN2wrFTH1G1PPT5b1x/ud9xOtcbWSW1/iqXtE8YY/n9qHbn1a+Nb6/gvFcdSe+Gbs//h/1vtY8vzP1Xv2kq/z63aP6fF72tY11rncM3v95zzb+3f3znHr2X9U+x1/I5gaWxj187HVqO4ww9E/GVdS/xjNHW9lHAf5tS9ZNtrqz0+S2OsXX/t86O1rc/vvex1jqYSjJzhGBzpx7rl9+uI+xc6enx7adEeW7TpkuPXw/l7dPFvSUpNoh17LC9SL85K17ogLql/r4t0HPMeX4Sa47O0fXpNgm7WPr9rvuRra7Hdtb//ce/IUbT6fh11/wZHj28PrX7ft2jTJcevh/P3DErXglwyPZYEPkwNYKgwdXJvkdC0upCE8ebq7ulfJlOPT6p95m5vjfK1DNtNnRtbnB9HOfdSbTD2XQ/XS33eu62/X62ljm1vas7fozj6cdgjvjMdvxbC/W1xXbj+z5/fv/7Lv725fPrjH31vA2HFqQZNleUuDrny0vrxMksP8Fh8Y/sz1tBz4h8+q704jC07pS2mHp+a45eKaW798TJTj/PS9i9tf8r+xfXXnF+pusaOd+n8qVl2yvd3LL7cZ7Vanzs1sU2Nd+r3d8o+TGn7UmxL6onrq923mmXm/P5NPTZhvWPrzz32td+fOd//1ufA1PNryfndKvajHr+4PFRbPteXhWQv9z2LP7/+7zfJ3j9/k+xNmRt3yY96yzq2dsaYqef41tFO28tdSAYtLihhPXsc46226fw9N8cvb6xtqpO9pZn7WnVt5YwxQyvO//7teYzX3rbz99wcv+Vm9ewBAHAODyebQAMAgAlON10aAAD1Jr16BQCAczGMCwDQMT17cDCl12wAwBSSPTgQiR4ArT1ert8N5JZerOnv/u7v8/8+5h6SvL3b39/9vee/w5jr//31/es//eS79+zFF534RFKuXPn88pK1fsDDuG51p7YzFvvY8lNi3bv9lSvvuRxyrn/8Jtn7x598Nzcu0F7tj/Ka/1oP6y4lf6W/T401vkgB7Uj6KHkc/hD/qMefD5QrVz6//AhuMcYJ35z1p/D7olz5ffy+cEwP4V/Cf6mnfpyVK1c+v/wohtjCOLewd/srV95zOYz5OIxrblzYX/iDPlY+tsycuuOy1LLhZ6U4ATgOL1WGA7glT/G/4lv+qz3VQxAKkzyJHEBfrn/66/vXf9CzBwDQpYfyIgAAnNU3yZ6BXACAXj3I9QAA+vXw97+/7h0DAAArefjj17r2AAB69fCXr/XsAQD06kGqt73SO9SG8rXeju6t6wBwP7x65YDWfJmtRA8A7svjRdfe5pYkc3Ony5LkAcB9etw7gHsSJ1xxsrZmQmbibAC4T5K9DY0lXLmJ6HN1AADUcM8eAEDH9OydzNx79gCA++TVKwAAHbv+6g/vX3/6szeXl+envWPpXuk+vLjXLr6Pb81tAwB9kuwBAHTMAxoAAB2T7AEAdEyyBwDQMckeAEDHJHsAAB2T7AEAdOxQM2jE74LzDri2Su07Vp5651/42ZR3CNZse2xZAKDeoXr2bhf1tS/sY0nFFuvvJUzMahKw3HEY1imtG2+jVHdqfUkeACz3eLmj+dJ6SPSOMDfulu0g4QOAZZoO4y4ZJly7/rBsTsJUs37ci5Ua5oyHPHMxToltjjMkUbf2OEOcAHBkzYZxS8OENcOIa9a/dJiw1fpDAhPHWNs+c4c4wzqX9MwN9YxtP9zGnGRtaYwAwHea9ewNPVZxMhPbaij1rD1CayY5ccI3t41K602pNxXHnH8MAABpTYdxx27Kj5dZuo1elfZv7j17cc/h0oSvhVIy1/uxBoAtNB3Gzd2zVlp+6fbWKJ+z/dRQ6dyExVDmt7QBACxz/dXv37/+9M2by8vz0+LKljxAkSqPl1taf7zM3PvJatZPJXu5e/By5a17tpa039j+DD2FU+qOly2VAwDzNE32zqzlkGKuV29pbx8AwFSHmkFjT0sTsCk9W3vfKwcA3A/JXiMtn1AFAGjl4Y4m0AAAuDuHmhsXAIC2JHsAAB2T7AEAdMwDGo3UvH9v7ffo9cLTygDQjp69yNwZG2qSk7E5g/mWGTMAoC09e4EzJBpLZwA5qjO0PQCckWTvg/ilx4M505nNTcjWHObNzVs8Zf9qplMbPp86W0jNfMoAwHSGcT8Ik5JhuDVOVOLPx+bynZq8hMnR2Lq52JYqbb9UXnufIgCwLT17E2yRuOyVHA29ccPDEUuSt6EOiR4A7E+yVyk3DNpaqcduzXv2xoZ4p2xzWKanewoB4KwM42YMvVz3sv1wezUJ7d7tAwDUuf7X79+//uzNm8vL89PesRzCWM/Z2EMIqT/HdYzd45cqX+u+vKHuUnI39wGN1LpTYltSDwDwfZI9NlHqBZTUAcA63LPHJiRzALAP9+wBAHRMsgcA0DHJHgBAxyR7AAAdk+wBAHTsLp/GHZshYov195CKOfeewNTyS97BBwDsp7uevaWzOpgVIi1M3krTqEn0AOA4Hl9fX/eOoZnaRC2XjCxdfwtL58a9rS8ZA4D7sdkw7pzpxHJlpam+ltY/Z/0p9c9ZvyUJHwDcj82GccOk7PbnVJI2fJ4rS0ndixbXE38+Ft/c9cM4cve5jZVPXX9psma4GgDuw6Hu2bslIMN/peV665lKPRixxj62rrPmWAEA+3k8yh17pac/Q8My95DwxZbeszes1yIJk+gBwPE9XDp6QCNU00O45vpLtleT8C7VW6IMAKRdv/rt317fvXt3eXl+Wn1jpYcUxh7CqH14YaznK5c8jcUwZf2aBzTGeu/WfEBjbHtT4k8p9RRKLAFgP9evfvNNsvfZtsmeiz8AwDYeLpdthnFzrzYBAGA9m71nT28eAMD2DvXqFQAA2nroabo0AAC+T88eAEDHJHsAAB17fN3oaVyOIff6m9I7/tZ8ByAAsJ4Hud40Z35tzNjrb8LkLZXIlcoBgGMyjDvBERK9YVq1qbGEPXpbTMcGABzDZu/ZO7tcr1jtlGi5qd+2mi4NALhPD0Zx68TDmGEP2ZT1bwldqnettudtzrYBgPtlGPdg5gzRrll/aVlDwQBwbIZxD6bUY5cbAp5af02SJtEDgPPTszdTqocsTKRyrzhZUj8AwFR69iYYHq4YS+Rqes5SvXNx3aX6Wxt7LUtNOQBwTNf/+O8/v37xxReXl+envWPpRunFxR6uAAC2omevkSkzUAxP5AIArE2y10gpeZPcAQB78IAGAEDHJHsAAB17uO4dAQAAq9GzBwDQsUM+oJF6RUnNzBGlJ2JbxNS63j20eOHzYI+2KMW/d3wAcCSn6dmruWjfllnr4i5p+M7R2+Lo8QHAlg7Zs+dindei1+rs7Xv2+AFgS4+XD09ohENjuYRiyouD1yhPLTflwt96mDceTqzdv3j52vWXGqs/NQVa6fjMqb/02dz6a+KbUndN/aX2Ky0jaQVgCx+HccOEIxwOHS5Q4YU5lZwsLY/LxozVkVOz/SnGErc59deuP5TPSRRq1pty/EKl+MfOpxbxl+Kbs43c+Vk6PuH/a78/ALCWZsO4n3zoEYyTxdryrbS4wI4lKnPrP0r7LDW2/+E+Dn8/k5bnDgBspek9e6lerinlW2ixzTgxa1V/TfukesuO5IgxtVAacq/Va/sAcFzNnsZN9djEw4CtLpgthPHMUdqHVP3hOqm2OFL7LJXa/572b6ml5x8A1Lr+/Nd/fv388y8uL89Po/cg3eSSl7XKw+XCRCHXuzW2fs32x4zdfzan/lTv3ZL4atS2b018Y+uEy8Trlj6bG39NfDV1z93/mv1b+/gCQEoy2bvHi1Cpl6Vlm9xzO+es3f5bHl8AOJKPyd6nP/7R9wpc/NrSqwMA7OHjAxqSj3VpXwBgD80e0AAA4HgkewAAHZPsAQB0TLIHANCxpjNo3LOjz2xReg9c6T1zS9+hCADsQ89eI70nN+H+pfa1VA4A7OObZO+6dwxMMEyzNXeqLVN0AcB9MYy7orlDoWNTdrWKS+8bANwHyd5Kau6Bm5N0tUrS9PABwH1wz94KxnrklgzBtrBGL+GScgBgXXr2VjA83ZrquVuabLV46jd8+rZVLHPKAYD16dlbSe4+vUGqhy8e4g0/Wys+AKBvevYaKfVihb194Wep5cbqWzP5G4sv/DwVW6kcANjH9ee//svr559/fnl5fto7Fj5Yu1cPALgfevYOwgwUAMAaJHsHIbkDANbgAQ0AgI49mCwNAKBfevYAADom2QMA6Fg3D2i0mFmiZQx7xpGSep1L+FnNXL6heN+OvO8AcM8eLpc+7to7QnJxi+EIcawh3K+xl0HnygGAfRjGPZlhlou5s1SY3QIA7ks3w7gpc4cic0OZreJJbT+VhK3VQ3bblt43ALgP3fbsjSVupfln145nbPu15UuTNT18AHAfukz2xnrklgyBtrD39lv36JX2RVIJAPvqchh3eLo0NVy59/Blyx65uXWFT9+2imVOOQCwvi579m5KQ7WpHrZwndb369Vsf0t7J70AwDa66dkrJU5hb1/4WWq5mvpqYojv06vZfslaSVopvvDzVNuUygGAfVz/8zd/ff3ss88uL89Pe8dyGGMvIM7RUwYAHNFjH69UXq70WhbJHABwRt0M4y4lmQMAetTtAxoAAEj2AAC6JtkDAOiYZA8AoGOPl4vncY+kxQwZY/WmXicTzqiRmks4jisVW6kcANiHnr0DKSVYewqTt7GXUefKAYB9ePXKQeUSpqU9f6n5ggGAfkn2GomTsJpZOPZKuiR8AHA/DOM2UuqJi+fJDT9L/Tk3hDusvzRZO9IQMQCwHsneCsZ6znKJXHzP21o9b63rLSWNkkoA2Nejh3HbGxKq0oMMc7R4WjccZm4Vy5xyAGB9evZ2MjZUuwX37AHAffCARiPxPXdxMjX0puV65krrp9ZpaWp8sVI5ALCP61e//dvru3fvLi/PT3vHAgBAY4ZxAQA6JtkDAOiYZA8AoGOSPQCAjkn2AAA6JtkDAOiYZO9O7f1SZwBgG5K9OyTJA4D7YQaNk1k6N65EDwDui2SvUpxkDX/PTSmWKxv7bGz9FsLtSfoA4D4Yxq2US7yGpClMpHLJ25ja9YfyqYlgKtkEAPon2ZvhljgtSZpySVxYNiehq912uH09fADQN8O4MwxJWOtkLJXwxebesxcvq6cPAO6Dnr2NhIlc6p6/sMdtzjAwAECKZK9SaehzLGmrUbv+3Hv2QoZxAeB+XL/67d9e3717d3l5fto7FgAAGtOzBwDQMckeAEDHJHsAAB17uO4dAQAAq3m4XKV7AAC9MowLANCx082gUTODRO49dfE75Y46e8TcWTKm1F+anSO1/VJ5zXbXrB8A+KFT9ewtnWGi5mXER3jJ8JoJTm7/4jl54zYulddud636AYC00/XsDcYSornJ0hkSi7m9flP3rbT80rZau34A4FunTfZSlgzT5qYQGxtmzJWl5r6tiW/NBGdKT5lEDwD6cZph3DgZy93fNbdXL1wvNf9sPMwYx1S6f7C0fqo8F+fSuXFrlOpfuv216wcAvnWanr1cb9nWanvGwninrr8nvXoA0JfTJHtHUZNoDsukll2aqK79pG5NvXr1AOA8JHsZpV7Epb2MR+ilTFmaiJWSUYkeAGzr+ovfff369u3by8vz096xjKp5+CI3BFh6OGHsQYvaGObEN1Z/62Hrqfs+pzxepuYBlKn1AwDTnCbZAwBgutM8jQsAwHSSPQCAjkn2AAA6JtkDAOiYZA8AoGOSPQCAjnmp8gdj03T18K63+J19S97hd9QXQgMAP6Rn74Mwcbn9efhvKnO7rkv7AsA0evYKpiR8WyQiW8yNW7LXdiV6ADCdZG/ELbkYG/YMPwsTkVRCVjMVWs2Ua2uaMp1bXD5nKrUpw8Gl9p0TX7hM7ljOqX/O8Z2yfouheADuh2HchNtFNHdhHj6PL7SlYeDcBTm+yIfr5RKouUPMY8L9yW2/Zru59eP6pyYqpfatiT+sJ5cwDQn+2PHOJfAptce3Zn0AmEOyl5BLalr1qIQ9hvHnqURzC6l9O2OP0V7tF8ew5Pjm1geAOQzjjljrgpvqDcwN0cVqeoOWxnXm4cEjxLzk+ObWB4C59OwV5IYi47LUenv3ME0Rxluzf1OFdbaot1TP2dq/RqoNJYQAlFx/8buvX9++fXt5eX7aO5ZdlXpaam6Yj+vJfR6X5dZtfUEvxTC1PFwulyiW7kWbum9jPZtj8dccv7F7/Grrz8UWLxO3Wc36qbokewCUXH/5u/evb96+uftkj3VNTQb3cMSYUs4SJwDH4J49NjH0Xq15z+ES8XD9kWK7mdrzBwADyR6bOXKCcuTYbo4eHwDH5QENAICOSfYAADom2QMA6JhkDwCgY8kHNI74NOIU9/5qCsdvnRhK7+GrrTO3/tL613aE4wLAdD/o2ett1oGjWbt9Hb/lSi9gHv4LP59SZ2r9pfVv4YgxAVD2sWevpx/wo/Y8rNnGjl8btb1XS9u7tP5Rj2f4vsSjfs8A+L6Pyd7Sf7XXTPW1dDqrKTGUtj2l3pr6p2x/jRcLtzp+U6YTy+1f6vjXtP/S41dzDo45e6K35PysKQ8/l/ABnEezBzRyP/q5Yarws5YxlC4+c7dfir9UHsYVD9WdxdgQY+n4x3WUykoxxOvH7T810Ztqab01+znF0vNzi+8nAPtY5Wncpf/iP+JFJr4A5hKTocfjzHLxD/tW0zN1tkS21lF79Vqfn2f8xwgAaatMlzZcJHq7WKQuqLllelMzLDs46/GvHZ48Wq9evN7a5+favaYAtHWY9+yFF6othuGmCntEahKeUg9Krry296y1o7d/SRj/krYrHdtSe5SO31qJ3pbn55I4Adje9Ze/f//65s2by6c//lFygdof9dT9V1OXCS8kcy4qYxfY3IVwSf25+HPl8TJzymtjW1JHrv3j2FLL57Zb0/4tj9/SpKQ2vrFzoHR+zKl/zNLzc+oxBOAcPiZ7L89Pe8dy91xM52uRzANAj1a5Z495JCbzhffbhZ8BwL2T7NENyR0A/NBhHtAAAKA9yR4AQMckewAAHZPsAQB0TLIHANCx/wdwiwa4WGTQNQAAAABJRU5ErkJgggA=&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;hr/&gt;&lt;p&gt;未完待续....................................&lt;/p&gt;

</description>
<pubDate>Thu, 02 Aug 2018 16:10:00 +0000</pubDate>
<dc:creator>JJian</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/jian0110/p/9410981.html</dc:identifier>
</item>
<item>
<title>malloc、calloc、realloc函数说明 - 沈七</title>
<link>http://www.cnblogs.com/shenlinken/p/9410962.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/shenlinken/p/9410962.html</guid>
<description>&lt;h2 id=&quot;malloc-函数&quot;&gt;malloc 函数&lt;/h2&gt;
&lt;pre class=&quot;cpp&quot;&gt;
&lt;code&gt;#include &amp;lt;stdlib.h&amp;gt;
void* malloc(int n);&lt;/code&gt;
&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;n为要分配的字节数，如果成功，返回获得空间的首地址，如果分配失败，则返回NULL，malloc分配的内存是未初始化过的，所以必须用memset初始化&lt;/li&gt;
&lt;/ul&gt;&lt;pre class=&quot;cpp&quot;&gt;
&lt;code&gt;#include &amp;lt;string.h&amp;gt;
void *memset(void *s, int ch, size_t n);&lt;/code&gt;
&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;在s指向的的地址，填充n个ch&lt;br/&gt;malloc分配的是堆上的内存，显式调用free来释放&lt;/li&gt;
&lt;/ul&gt;&lt;pre class=&quot;cpp&quot;&gt;
&lt;code&gt;#include &amp;lt;stdlib.h&amp;gt;
void free(void *p);&lt;/code&gt;
&lt;/pre&gt;
&lt;h2 id=&quot;calloc-函数&quot;&gt;calloc 函数&lt;/h2&gt;
&lt;p&gt;calloc函数和malloc类似，都是从堆上分配内存，函数声明如下&lt;/p&gt;
&lt;pre class=&quot;cpp&quot;&gt;
&lt;code&gt;#include &amp;lt;stdlib.h&amp;gt;
void *calloc(int n,int size);&lt;/code&gt;
&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;如果执行成功，获得大小为n的空间，并返回空间的首地址，如果失败，函数返回NULL。&lt;/li&gt;
&lt;li&gt;和malloc不同的是，calloc分配的都是经过初始化的，内容为0。&lt;/li&gt;
&lt;li&gt;calloc函数适合为数组申请空间，n为数组个数，size设置为数组大小。&lt;/li&gt;
&lt;li&gt;使用free释放空间&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;realloc-函数&quot;&gt;realloc 函数&lt;/h2&gt;
&lt;p&gt;realloc函数可以实现内存分配和内存释放的功能，函数声明如下：&lt;/p&gt;
&lt;pre class=&quot;cpp&quot;&gt;
&lt;code&gt;#include &amp;lt;stdlib.h&amp;gt;
void* realloc(void * p,int n);&lt;/code&gt;
&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;p必须为指向堆内存空间的指针，即由malloc函数、calloc函数或realloc函数分配空间的指针。realloc函数将指针p指向的内存块的大小改变为n字节。&lt;/li&gt;
&lt;li&gt;如果n小于或等于p之前指向的空间大小，保持原有状态不变。如果n大于原来p之前指向的空间大小，则系统将重新为p从堆上分配一块大小为n的内存空间，同时，将原来指向空间的内容依次复制到新的内存空间上，p之前指向的空间被释放。&lt;/li&gt;
&lt;li&gt;realloc函数分配的空间也是未初始化的。&lt;/li&gt;
&lt;li&gt;realloc分配的空间，须有free释放&lt;/li&gt;
&lt;/ul&gt;</description>
<pubDate>Thu, 02 Aug 2018 16:02:00 +0000</pubDate>
<dc:creator>沈七</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/shenlinken/p/9410962.html</dc:identifier>
</item>
<item>
<title>在 ubuntu 中愉快的安装 Jenkins - 易墨</title>
<link>http://www.cnblogs.com/morang/p/ubuntu-jenkins-java-install.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/morang/p/ubuntu-jenkins-java-install.html</guid>
<description>&lt;blockquote readability=&quot;8&quot;&gt;
&lt;p&gt;这篇文章详细的记录了在 ubuntu 中安装 Jenkins 的一步又一步，因为找了很多 Linux 下安装 Jenkins 的教程，不是很满意&lt;br/&gt;所以决定自己写一篇以备后用(终于让我找到了Java 不用去官网下载的方法了~haha)&lt;br/&gt;为了写文章，狠心把我的 Windows 服务器重装了，允悲。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;安装前的准备&quot;&gt;安装前的准备&lt;/h2&gt;
&lt;blockquote readability=&quot;5&quot;&gt;
&lt;p&gt;如果你恰好是腾讯云的 Ubuntu，默认用户名为：ubuntu&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;ubuntu-开启-root-的相关设置&quot;&gt;ubuntu 开启 root 的相关设置&lt;/h3&gt;
&lt;blockquote readability=&quot;9&quot;&gt;
&lt;p&gt;若要使用 root 登录，第一次激活需要设置 root 用户的密码:&lt;code&gt;sudo passwd&lt;/code&gt;,&lt;br/&gt;两次密码设置后即可通过 &lt;code&gt;su root&lt;/code&gt; 切换用户&lt;br/&gt;现在可以使用 root 但是无法远程连接，还需要设置&lt;code&gt;/etc/ssh/sshd_config&lt;/code&gt;中 &lt;code&gt;PermitRootLogin&lt;/code&gt; 的值为 &lt;code&gt;yes&lt;/code&gt;&lt;br/&gt;设置后记得重启 ssh 服务:&lt;code&gt;sudo service ssh restart&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;刚接触-linux-时很希望有人能告诉我的一些基本姿势&quot;&gt;刚接触 linux 时很希望有人能告诉我的一些基本姿势&lt;/h3&gt;
&lt;blockquote readability=&quot;5&quot;&gt;
&lt;p&gt;命令很多很多，且用且搜。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul readability=&quot;-0.47744360902256&quot;&gt;&lt;li&gt;切换用户：&lt;code&gt;su root&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;权限问题：非 root 账户在执行命令时加上 sudo 等于超级管理员执行&lt;/li&gt;
&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;常用命令：&lt;br/&gt;&lt;code&gt;ls -a&lt;/code&gt;:显示所有文件及目录&lt;br/&gt;&lt;code&gt;pwd&lt;/code&gt;:查看当前路径&lt;br/&gt;&lt;code&gt;lsb_release -a&lt;/code&gt;:查看系统版本&lt;br/&gt;&lt;code&gt;ifconfig&lt;/code&gt;:查看 IP 等信息&lt;br/&gt;&lt;code&gt;ps&lt;/code&gt;:显示正在运行中的进程的信息&lt;br/&gt;&lt;a href=&quot;http://www.runoob.com/w3cnote/linux-useful-command.html&quot;&gt;学习更多&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;vim 常用的几个命令：&lt;br/&gt;&lt;code&gt;i&lt;/code&gt;:输入模式(使用 vim 打开文件后先按一些 i，然后再移动光标输入字符~)，&lt;br/&gt;&lt;code&gt;w&lt;/code&gt;:保存，&lt;br/&gt;&lt;code&gt;q&lt;/code&gt;:退出，&lt;br/&gt;&lt;code&gt;wq&lt;/code&gt;:保存并退出，&lt;br/&gt;&lt;code&gt;q!&lt;/code&gt;：退出保存&lt;br/&gt;&lt;a href=&quot;http://www.runoob.com/linux/linux-vim.html&quot;&gt;学习更多&lt;/a&gt;&lt;/li&gt;
&lt;li readability=&quot;-1&quot;&gt;
&lt;p&gt;下载软件：搜 &lt;code&gt;wget xxx&lt;/code&gt;，&lt;code&gt;curl xxx&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;strong&gt;一切准备就绪，LINK START&lt;/strong&gt;&lt;/p&gt;
&lt;h2 id=&quot;安装-jenkins&quot;&gt;安装 Jenkins&lt;/h2&gt;
&lt;p&gt;第一次安装的可以稍微看下&lt;a href=&quot;https://jenkins.io/doc/book/installing/#debian-ubuntu&quot;&gt;jenkins 的安装文档&lt;/a&gt;&lt;br/&gt;总之，如果没有安装 Java 需要安装一下。&lt;/p&gt;
&lt;p&gt;下面是目前找到的在 ubuntu 下安装 Java 最简单的方法&lt;/p&gt;
&lt;h3 id=&quot;java-安装&quot;&gt;Java 安装&lt;/h3&gt;
&lt;p&gt;参考：&lt;a href=&quot;https://blog.csdn.net/geekun/article/details/51325525&quot; class=&quot;uri&quot;&gt;https://blog.csdn.net/geekun/article/details/51325525&lt;/a&gt;&lt;/p&gt;
&lt;pre class=&quot;sh&quot;&gt;
&lt;code&gt;sudo add-apt-repository ppa:openjdk-r/ppa
# 需要回车一下
sudo apt-get update
echo y|sudo apt-get install openjdk-8-jdk&lt;/code&gt;
&lt;/pre&gt;
&lt;h3 id=&quot;jenkins的安装&quot;&gt;Jenkins的安装&lt;/h3&gt;
&lt;pre class=&quot;sh&quot;&gt;
&lt;code&gt;wget -q -O - https://pkg.jenkins.io/debian/jenkins.io.key | sudo apt-key add -
sudo sh -c 'echo deb http://pkg.jenkins.io/debian-stable binary/ &amp;gt; /etc/apt/sources.list.d/jenkins.list'
sudo apt-get update
echo y|sudo apt-get install jenkins&lt;/code&gt;
&lt;/pre&gt;
&lt;h3 id=&quot;jenkins的运行&quot;&gt;Jenkins的运行&lt;/h3&gt;
&lt;p&gt;Jenkins 是以服务的形式运行的,故可使用如下民两个管理服务，默认使用 8080 端口&lt;/p&gt;
&lt;p&gt;启动服务：&lt;code&gt;sudo service jenkins start&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;相关服务命令:&lt;code&gt;sudo service jenkins start|stop|restart&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;防火墙问题&quot;&gt;防火墙问题&lt;/h3&gt;
&lt;p&gt;如果因为防火墙的问题可以使用：&lt;code&gt;sudo ufw allow 8080&lt;/code&gt; 开放指定端口&lt;br/&gt;ps:在腾讯云的主机中默认防火墙是关闭的(&lt;code&gt;sudo ufw status&lt;/code&gt;查看)&lt;/p&gt;
&lt;h2 id=&quot;jenkins的配置&quot;&gt;Jenkins的配置&lt;/h2&gt;
&lt;p&gt;至此，可以通过 &lt;a href=&quot;http://ip:8080&quot; class=&quot;uri&quot;&gt;http://ip:8080&lt;/a&gt; 访问 Jenkins 了，然后就是初始化和使用了&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;使用&lt;code&gt;cat /var/lib/jenkins/secrets/initialAdminPassword&lt;/code&gt;查看初始密码并在浏览器中登录&lt;/li&gt;
&lt;li&gt;安装推荐或自选插件(第一次使用推荐就好，后面可以根据自己需要做调整)&lt;/li&gt;
&lt;li&gt;创建第一个管理员用户 略~&lt;/li&gt;
&lt;li&gt;设置 Jenkins 网址..&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;正式开启 Jenkins 之旅&lt;/p&gt;
&lt;h3 id=&quot;踩过的坑&quot;&gt;踩过的坑&lt;/h3&gt;
&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;
&lt;p&gt;在使用过程中，还有很多需要记录的，后续再逐步总结。&lt;br/&gt;有个想法就是最终可以构建一个自己的Jenkins镜像，往里面添加几个自己的技术栈的发布模板，应该挺爽的，多尝试，多总结。&lt;br/&gt;最近十分不容易的用Jenkins+Docker把项目部署到服务器了，在找资料的过程中，发现很难一下就找到自己想要的，果然，还是得自己动手总结了。&lt;br/&gt;以后也会用到，趁现在总结一二，以后就不要到处找文章了，哈哈。&lt;/p&gt;
&lt;h2 id=&quot;参考文章&quot;&gt;参考文章&lt;/h2&gt;
</description>
<pubDate>Thu, 02 Aug 2018 15:55:00 +0000</pubDate>
<dc:creator>易墨</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/morang/p/ubuntu-jenkins-java-install.html</dc:identifier>
</item>
<item>
<title>【React自制全家桶】八、React动画以及react-transition-group动画库的使用 - 漂泊的雾</title>
<link>http://www.cnblogs.com/piaobodewu/p/9410912.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/piaobodewu/p/9410912.html</guid>
<description>&lt;p&gt;&lt;span&gt;React动画通常有三种方法实现从易到难为：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1、transition（CSS3自带）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;2、animation（CSS3自带）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;3、react-transition-group动画库（需要引入插件）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;一、transition（CSS3自带）&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1、用法示例：&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;32&quot;&gt;
&lt;pre class=&quot;brush:html;gutter:true;&quot;&gt;
&lt;span&gt;.hide{
  /*过渡动画效果*/&lt;/span&gt;&lt;br/&gt;&lt;span&gt;　opacity: 1;
  transition: all 1s ease-in;
}
&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　含义：透明度在1s内从0渐变为1&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;2、transition其他参数&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;建议参考（http://www.runoob.com/cssref/css3-pr-transition.html）详细学习&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;3、区别transform&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;transform 属性向元素应用 2D 或 3D 转换。该属性允许我们对元素进行旋转、缩放、移动或倾斜。所以，transform属性只对元素进行变换，不会产生过渡效果。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;建议参考（http://www.runoob.com/cssref/css3-pr-transform.html）详细学习&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;span&gt; &lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;span&gt;二、animation（CSS3自带）&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1、用法示例：&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;34&quot;&gt;
&lt;pre class=&quot;brush:html;gutter:true;&quot;&gt;
&lt;span&gt;.hide{
  /*过渡动画效果*/
  animation: animation-name 2s ease-in forwards;
}
@keyframes animation-name {
  0% {
    opacity: 1;
    color: red;
  }
  50% {
    opacity: 0.5;
    color: blue;
  }
  100%{
    opacity: 0;
    color: yellow;
  }
}
&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　animation相对于transition的好处是可以一帧一帧的控制动画，自由度更高。&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;&lt;strong&gt;&lt;span&gt;三、react-transition-group动画库（需要引入插件）&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;1、为什么要用react-transition-group？&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;因为有一些动画用animation和transition很难实现甚至不能实现，这时react-transition-group就非常必要啦&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;2、安装react-transition-group库&lt;/span&gt;&lt;/p&gt;

&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;32&quot;&gt;
&lt;pre class=&quot;brush:html;gutter:true;&quot;&gt;
&lt;span&gt;yarn add react-transition-group&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;span&gt;3、官方文档地址：http://reactcommunity.org/react-transition-group/（强烈建议一定要先打开这个文档再继续向下阅读哦）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; react-transition-group库有三个可使用的组件：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;（1）主要使用CSSTransition（单标签的动画）和TransitionGroup（多标签的动画）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;（2）Transition是更接近底层的动画，当时用CSSTransition和TransitionGroup都不能实现需要的动画时可以考虑使用Transition&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;4、React使用示例：（核心部分均标蓝）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; js部分：&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;40&quot;&gt;
&lt;pre class=&quot;brush:html;gutter:true;&quot;&gt;
&lt;span&gt;import React,{ Component , Fragment} from 'react';
&lt;span&gt;// 引入react-transition-group动画组件
import { CSSTransition,TransitionGroup } from 'react-transition-group';&lt;/span&gt;
class AppTra extends Component{
    constructor(props){
        super(props);
        this.state = {
            list:[]
        };
        this.handleAddItem = this.handleAddItem.bind(this);
    }

    handleAddItem(){
        this.setState((prevState)=&amp;gt;{
            return{
                list: [...prevState.list,'666']
            }
        })
    }


    render(){
        return (
            // Fragment是占位符
            &amp;lt;Fragment&amp;gt;
               &lt;span&gt; &amp;lt;TransitionGroup&amp;gt;
                {

                        this.state.list.map((item,index)=&amp;gt;{
                            return(
                                &amp;lt;CSSTransition
                                    in={this.state.show}
                                    //动画时间
                                    timeout={1000}
                                    // 前缀名注意S
                                    classNames='fade'
                                    unmountOnExit
                                    onEntered={(el)=&amp;gt;{
                                    el.style.color='blue'
                                    }}
                                    // 入场第一帧
                                    appear={true}

                                    key={index}
                                &amp;gt;
                                    &amp;lt;div&amp;gt;{item}&amp;lt;/div&amp;gt;
                                &amp;lt;/CSSTransition&amp;gt;
                            )
                        })
                }
                &amp;lt;button onClick={this.handleAddItem}&amp;gt;toggle&amp;lt;/button&amp;gt;
                &amp;lt;/TransitionGroup&amp;gt;&lt;/span&gt;
            &amp;lt;/Fragment&amp;gt;
        )
    }
}

// 导出组件
export default AppTra
&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　　css部分：&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_Highlighter&quot; readability=&quot;37&quot;&gt;
&lt;pre class=&quot;brush:html;gutter:true;&quot;&gt;
&lt;span&gt;/*入场动画*/
.fade-enter, .fade-appear{
    /*入场动画执行的第一个时刻*/
    opacity: 0;
}

.fade-enter-active, .fade-appear-active{
    /*入场动画执行的第二个瞬间一直到执行完成的时刻*/
    opacity: 1;
    transition: opacity 1s ease-in;
}

.fade-enter-done{
    /*入场动画执行完成之后*/
    opacity: 1;
    color: red;
}


/*出场动画*/
.fade-exit{
    opacity: 1;
}

.fade-exit-active{
    opacity: 0;
    transition: opacity 1s ease-in;
}

.fade-exit-done{
    opacity: 0;
}
&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;　大家动手试试吧&lt;/span&gt;&lt;/p&gt;
</description>
<pubDate>Thu, 02 Aug 2018 15:45:00 +0000</pubDate>
<dc:creator>漂泊的雾</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/piaobodewu/p/9410912.html</dc:identifier>
</item>
</channel>
</rss>