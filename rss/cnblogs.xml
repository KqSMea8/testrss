<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=feed.cnblogs.com%2Fblog%2Fsitehome%2Frss&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://feed.cnblogs.com/blog/sitehome/rss" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dfeed.cnblogs.com%252Fblog%252Fsitehome%252Frss%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>博客园_首页</title>
<link></link>
<description>代码改变世界</description>
<item>
<title>mongodb集群故障转移实践 - 单曲荨环</title>
<link>http://www.cnblogs.com/zhoujie/p/mongo2.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/zhoujie/p/mongo2.html</guid>
<description>&lt;p&gt;NOSQL有这些优势：&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;大数据量，可以通过廉价服务器存储大量的数据，轻松摆脱传统mysql单表存储量级限制。&lt;/li&gt;
&lt;li&gt;高扩展性，Nosql去掉了关系数据库的关系型特性，很容易横向扩展，摆脱了以往老是纵向扩展的诟病。&lt;/li&gt;
&lt;li&gt;高性能，Nosql通过简单的key-value方式获取数据，非常快速。还有NoSQL的Cache是记录级的，是一种细粒度的Cache，所以NoSQL在这个层面上来说就要性能高很多。&lt;/li&gt;
&lt;li&gt;灵活的数据模型，&lt;span&gt;&lt;strong&gt;NoSQL无需事先为要存储的数据建立字段&lt;/strong&gt;，随时可以存储自定义的数据格式。而在关系数据库里，增删字段是一件非常麻烦的事情&lt;/span&gt;。如果是非常大数据量的表，增加字段简直就是一个噩梦。&lt;/li&gt;
&lt;li&gt;高可用，NoSQL在不太影响性能的情况，就可以方便的实现高可用的架构。比如mongodb通过mongos、mongo分片就可以快速配置出高可用配置。&lt;/li&gt;
&lt;li&gt;支持查询、聚合、完全索引，包含内部对象&lt;/li&gt;
&lt;li&gt;支持复制和故障转移、自动恢复&lt;/li&gt;
&lt;li&gt;易扩展&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;在nosql数据库里，大部分的查询都是键值对（key、value）的方式。MongoDB是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中最像关系数据库的。支持类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。所以这个非常方便，我们可以用sql操作MongoDB，从关系型数据库迁移过来，开发人员学习成本会大大减少。如果再对底层的sql API做一层封装，开发基本可以感觉不到mongodb和关系型数据库的区别。&lt;/p&gt;
&lt;p&gt;　　MongoDB是一个基于分布式文件存储的数据库。由C++语言编写；旨在为WEB应用提供可扩展的高性能数据存储解决方案。&lt;/p&gt;

&lt;h3&gt;安装环境&lt;/h3&gt;
&lt;p&gt;操作系统：Centos7.2&lt;/p&gt;
&lt;p&gt;mongodb版本： v3.6.1&lt;/p&gt;
&lt;h3&gt;下载安装&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;wget&lt;/span&gt; http:&lt;span&gt;//&lt;/span&gt;&lt;span&gt;fastdl.mongodb.org/linux/mongodb-linux-x86_64-amazon-3.6.1.tgz&lt;/span&gt;
&lt;span&gt;tar&lt;/span&gt; zxvf mongodb-linux-x86_64-amazon-&lt;span&gt;3.6&lt;/span&gt;.&lt;span&gt;1&lt;/span&gt;&lt;span&gt;.tgz 
&lt;/span&gt;&lt;span&gt;mv&lt;/span&gt;  /root/mongodb-linux-x86_64-amazon-&lt;span&gt;3.6&lt;/span&gt;.&lt;span&gt;1&lt;/span&gt; /usr/local/mongodb/
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;创建数据/日志目录&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;mkdir&lt;/span&gt; -p /data/mongodb/&lt;span&gt;{data, logs}

&lt;/span&gt;&lt;span&gt;mkdir&lt;/span&gt; /data/mongodb/data/&lt;span&gt;mongod
&lt;/span&gt;&lt;span&gt;touch&lt;/span&gt; /data/mongodb/logs/mongo.logs
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;创建配置文件&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;mkdir&lt;/span&gt; /usr/local/mongodb/&lt;span&gt;config
cd  &lt;/span&gt;/usr/local/mongodb/config &amp;amp;&amp;amp; &lt;span&gt;touch&lt;/span&gt; mongo.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;配置文件&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;1. 普通配置文件示例&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
dbpath=/data/mongodb/data/&lt;span&gt;mongod
logpath&lt;/span&gt;=/data/mongodb/logs/&lt;span&gt;mongo.log
logappend&lt;/span&gt;=&lt;span&gt;true&lt;/span&gt;&lt;span&gt;
replSet&lt;/span&gt;=mongo-&lt;span&gt;rs
bind_ip&lt;/span&gt;=&lt;span&gt;0.0&lt;/span&gt;.&lt;span&gt;0.0&lt;/span&gt;&lt;span&gt;
port&lt;/span&gt;=&lt;span&gt;27017&lt;/span&gt;&lt;span&gt;
fork&lt;/span&gt;=&lt;span&gt;true&lt;/span&gt;&lt;span&gt;
journal&lt;/span&gt;=&lt;span&gt;true&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;mongodb3.x版本后就是要yaml语法格式的配置文件，下面是yaml配置文件格式如下：&lt;br/&gt;官方yaml配置文件选项参考：&lt;a href=&quot;https://docs.mongodb.org/manual/reference/configuration-options/#configuration-file&quot; target=&quot;_blank&quot;&gt;https://docs.mongodb.org/manual/reference/configuration-options/#configuration-file&lt;/a&gt;&lt;br/&gt;&lt;span&gt;注意：&lt;/span&gt;只能使用空格，不支持tab键&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2.yaml格式配置文件示例&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;storage:
    dbPath: /data/mongodb/data/mongod
    journal:
        enabled: true
systemLog:
    destination: file
    path: /data/mongodb/logs/mongo.log
    logAppend: true
    logRotate: rename
net:
    bindIp: 0.0.0.0
    port: 27017
processManagement:
    pidFilePath: /var/run/pid/mongodb.pid
    fork: true
replication:
    oplogSizeMB: 20480
    replSetName: mongo-rs&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;配置文件参数说明&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;1.基本参数&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
--&lt;span&gt;quiet     # 安静输出
&lt;/span&gt;--&lt;span&gt;port arg  # 指定服务端口号，默认端口27017
&lt;/span&gt;--bind_ip arg   # 绑定服务IP，若绑定127.&lt;span&gt;0.0&lt;/span&gt;.&lt;span&gt;1&lt;/span&gt;&lt;span&gt;，则只能本机访问，不指定默认本地所有IP
&lt;/span&gt;--&lt;span&gt;logpath arg   # 指定MongoDB日志文件，注意是指定文件不是目录
&lt;/span&gt;--&lt;span&gt;logappend     # 使用追加的方式写日志
&lt;/span&gt;--&lt;span&gt;pidfilepath arg   # PID File 的完整路径，如果没有设置，则没有PID文件
&lt;/span&gt;--&lt;span&gt;keyFile arg   # 集群的私钥的完整路径，只对于Replica Set 架构有效
&lt;/span&gt;--unixSocketPrefix arg  # UNIX域套接字替代目录,(默认为 /&lt;span&gt;tmp)
&lt;/span&gt;--&lt;span&gt;fork  # 以守护进程的方式运行MongoDB，创建服务器进程
&lt;/span&gt;--&lt;span&gt;auth  # 启用验证
&lt;/span&gt;--&lt;span&gt;cpu   # 定期显示CPU的CPU利用率和iowait
&lt;/span&gt;--&lt;span&gt;dbpath arg    # 指定数据库路径
&lt;/span&gt;--diaglog arg   # diaglog选项 &lt;span&gt;0&lt;/span&gt;=off &lt;span&gt;1&lt;/span&gt;=W &lt;span&gt;2&lt;/span&gt;=R &lt;span&gt;3&lt;/span&gt;=both &lt;span&gt;7&lt;/span&gt;=W+&lt;span&gt;some reads
&lt;/span&gt;--&lt;span&gt;directoryperdb    # 设置每个数据库将被保存在一个单独的目录
&lt;/span&gt;--&lt;span&gt;journal   # 启用日志选项，MongoDB的数据操作将会写入到journal文件夹的文件里
&lt;/span&gt;--&lt;span&gt;journalOptions arg    # 启用日志诊断选项
&lt;/span&gt;--&lt;span&gt;ipv6  # 启用IPv6选项
&lt;/span&gt;--&lt;span&gt;jsonp     # 允许JSONP形式通过HTTP访问（有安全影响）
&lt;/span&gt;--&lt;span&gt;maxConns arg  # 最大同时连接数 默认2000
&lt;/span&gt;--&lt;span&gt;noauth    # 不启用验证
&lt;/span&gt;--&lt;span&gt;nohttpinterface   # 关闭http接口，默认关闭27018端口访问
&lt;/span&gt;--&lt;span&gt;noprealloc    # 禁用数据文件预分配(往往影响性能)
&lt;/span&gt;--&lt;span&gt;noscripting   # 禁用脚本引擎
&lt;/span&gt;--&lt;span&gt;notablescan   # 不允许表扫描
&lt;/span&gt;--&lt;span&gt;nounixsocket  # 禁用Unix套接字监听
&lt;/span&gt;--nssize arg (=&lt;span&gt;16&lt;/span&gt;&lt;span&gt;)  # 设置信数据库.ns文件大小(MB)
&lt;/span&gt;--&lt;span&gt;objcheck  # 在收到客户数据,检查的有效性，
&lt;/span&gt;--profile arg   # 档案参数 &lt;span&gt;0&lt;/span&gt;=off &lt;span&gt;1&lt;/span&gt;=slow, &lt;span&gt;2&lt;/span&gt;=&lt;span&gt;all
&lt;/span&gt;--&lt;span&gt;quota     # 限制每个数据库的文件数，设置默认为8
&lt;/span&gt;--quotaFiles arg    # number of files allower per db, requires --&lt;span&gt;quota
&lt;/span&gt;--&lt;span&gt;rest  # 开启简单的rest API
&lt;/span&gt;--&lt;span&gt;repair    # 修复所有数据库run repair on all dbs
&lt;/span&gt;--&lt;span&gt;repairpath arg    # 修复库生成的文件的目录,默认为目录名称dbpath
&lt;/span&gt;--slowms arg (=&lt;span&gt;100&lt;/span&gt;)     # value of slow &lt;span&gt;for&lt;/span&gt;&lt;span&gt; profile and console log
&lt;/span&gt;--&lt;span&gt;smallfiles    # 使用较小的默认文件
&lt;/span&gt;--syncdelay arg (=&lt;span&gt;60&lt;/span&gt;)   # 数据写入磁盘的时间秒数(&lt;span&gt;0&lt;/span&gt;=&lt;span&gt;never,不推荐)
&lt;/span&gt;--&lt;span&gt;sysinfo   # 打印一些诊断系统信息
&lt;/span&gt;--upgrade   # 如果需要升级数据库
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;2.Replicaton 参数&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
--&lt;span&gt;fastsync  # 从一个dbpath里启用从库复制服务，该dbpath的数据库是主库的快照，可用于快速启用同步
&lt;/span&gt;--&lt;span&gt;autoresync    # 如果从库与主库同步数据差得多，自动重新同步，
&lt;/span&gt;--oplogSize arg     # 设置oplog的大小(MB)
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;3.主/从参数&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
--&lt;span&gt;master    # 主库模式
&lt;/span&gt;--&lt;span&gt;slave     # 从库模式
&lt;/span&gt;--&lt;span&gt;source arg    # 从库 端口号
&lt;/span&gt;--&lt;span&gt;only arg  # 指定单一的数据库复制
&lt;/span&gt;--slavedelay arg    # 设置从库同步主库的延迟时间
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;4.Replica set(副本集)选项&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
--&lt;span&gt;replSet arg   # 设置副本集名称 

Sharding(分片)选项
&lt;/span&gt;--configsvr     # 声明这是一个集群的config服务,默认端口27019，默认目录/data/&lt;span&gt;configdb
&lt;/span&gt;--&lt;span&gt;shardsvr  # 声明这是一个集群的分片,默认端口27018
&lt;/span&gt;--noMoveParanoia    # 关闭偏执为moveChunk数据保存
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;启动&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
mongod --quiet -f /usr/local/mongodb/config/mongo.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;配置文件里设置里fork:true,所以会在后台启动，值得注意的是，用到了”–fork”参数就必须启用”–logpath”参数，如不指定配置文件启动，如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
mongod --dbpath=/data/mongodb/data/mongod --fork --logpath=/data/mongodb/logs/mongo.logs
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;官方不建议再使用主从集群模式，推荐的集群方式是Replica Set（副本集），主从模式其实就是一个单副本的应用，没有很好的扩展性和容错性。而副本集具有多个副本保证了容错性，就算一个副本挂掉了还有很多副本存在，并且解决了上面第一个问题“主节点挂掉了，整个集群内会自动切换”。&lt;/p&gt;
&lt;h3&gt;副本集的设计结构&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/476931/201806/476931-20180626223913462-277774397.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;由图可以看到客户端连接到整个副本集，不关心具体哪一台机器是否挂掉。主服务器负责整个副本集的读写，副本集定期同步数据备份，一但主节点挂掉，副本节点就会选举一个新的主服务器，这一切对于应用服务器不需要关心。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/476931/201806/476931-20180626224154677-10595180.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;注意&lt;/span&gt;：&lt;/p&gt;
&lt;p&gt;仲裁节点是一种特殊的节点，它本身并不存储数据，主要的作用是决定哪一个备节点在主节点挂掉之后提升为主节点，所以客户端不需要连接此节点。这里虽然只有一个备节点，但是仍然需要一个仲裁节点来提升备节点级别。&lt;/p&gt;
&lt;p&gt;必须要有仲裁节点，没仲裁节点的话，主节点挂了备节点还是备节点。&lt;/p&gt;
&lt;h3&gt;配置步骤&lt;/h3&gt;
&lt;p&gt;准备三台机器&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;172.29&lt;/span&gt;.&lt;span&gt;142.17&lt;/span&gt;&lt;span&gt;  主
&lt;/span&gt;&lt;span&gt;172.29&lt;/span&gt;.&lt;span&gt;142.18&lt;/span&gt;&lt;span&gt;  备
&lt;/span&gt;&lt;span&gt;172.28&lt;/span&gt;.&lt;span&gt;226.199&lt;/span&gt; 仲裁
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;按照第二步安装依次在三台机器上安装并启动&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
/usr/local/mongodb/bin/mongod --quiet -f /usr/local/mongodb/config/mongo.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;初始化集群配置&lt;/h3&gt;
&lt;p&gt;三台服务启动并不能表示他们在一个集群，因此需要将集群初始化。连接任意一个节点（不要是仲裁点），执行如下：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;43&quot;&gt;
&lt;pre&gt;
&lt;span&gt;rs.initiate({
 _id:&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mongo-rs&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;, #集群名称 
 members:[ {_id:&lt;/span&gt;&lt;span&gt;0&lt;/span&gt;,host:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;172.29.142.18:27017&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,priority:&lt;span&gt;2&lt;/span&gt;&lt;span&gt;}, #主
 {_id:&lt;/span&gt;&lt;span&gt;1&lt;/span&gt;,host:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;172.29.142.17:27017&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,priority:&lt;span&gt;1&lt;/span&gt;&lt;span&gt;}, #备
 {_id:&lt;/span&gt;&lt;span&gt;2&lt;/span&gt;,host:&lt;span&gt;'&lt;/span&gt;&lt;span&gt;172.28.226.199:27017&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;,arbiterOnly:&lt;span&gt;true&lt;/span&gt;&lt;span&gt;}]  #仲裁节点
}) &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;成功上面会返回OK，然后查看集群状态，下面是在备节点上执行的&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;
&lt;pre&gt;
rs.status()
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;返回集群的名称和members信息，如：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;62&quot;&gt;&lt;img id=&quot;code_img_closed_81518906-1cac-45cf-9199-0ab8ebf40d83&quot; class=&quot;code_img_closed&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif&quot; alt=&quot;&quot;/&gt;&lt;img id=&quot;code_img_opened_81518906-1cac-45cf-9199-0ab8ebf40d83&quot; class=&quot;code_img_opened&quot; src=&quot;https://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif&quot; alt=&quot;&quot;/&gt;&lt;div id=&quot;cnblogs_code_open_81518906-1cac-45cf-9199-0ab8ebf40d83&quot; class=&quot;cnblogs_code_hide&quot; readability=&quot;119&quot;&gt;
&lt;pre&gt;
&lt;span&gt;{
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;set&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;mongo-rs&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;date&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:56:08.032Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;myState&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;term&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2&lt;/span&gt;&lt;span&gt;),
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;syncingTo&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;172.29.142.18:27017&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;heartbeatIntervalMillis&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2000&lt;/span&gt;&lt;span&gt;),
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;optimes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : {
        &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;lastCommittedOpTime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : {
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ts&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : Timestamp(&lt;span&gt;1530024958&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;t&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2&lt;/span&gt;&lt;span&gt;)
        },
        &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;appliedOpTime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : {
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ts&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : Timestamp(&lt;span&gt;1530024958&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;t&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2&lt;/span&gt;&lt;span&gt;)
        },
        &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;durableOpTime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : {
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ts&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : Timestamp(&lt;span&gt;1530024958&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;t&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2&lt;/span&gt;&lt;span&gt;)
        }
    },
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;members&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : [ 
        {
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;_id&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;0&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;172.29.142.18:27017&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;health&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;state&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;stateStr&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;PRIMARY&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;uptime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;382251&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;optime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : {
                &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ts&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : Timestamp(&lt;span&gt;1530024958&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;),
                &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;t&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2&lt;/span&gt;&lt;span&gt;)
            },
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;optimeDurable&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : {
                &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ts&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : Timestamp(&lt;span&gt;1530024958&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;),
                &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;t&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2&lt;/span&gt;&lt;span&gt;)
            },
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;optimeDate&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:55:58.000Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;optimeDurableDate&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:55:58.000Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;lastHeartbeat&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:56:07.329Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;lastHeartbeatRecv&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:56:06.453Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;pingMs&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;0&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;electionTime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : Timestamp(&lt;span&gt;1529642739&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;electionDate&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-22T04:45:39.000Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;configVersion&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1&lt;/span&gt;&lt;span&gt;
        }, 
        {
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;_id&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;172.29.142.17:27017&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;health&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;state&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;stateStr&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;SECONDARY&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;uptime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;382552&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;optime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt; : {
                &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ts&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : Timestamp(&lt;span&gt;1530024958&lt;/span&gt;, &lt;span&gt;1&lt;/span&gt;&lt;span&gt;),
                &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;t&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;2&lt;/span&gt;&lt;span&gt;)
            },
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;optimeDate&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:55:58.000Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;syncingTo&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;172.29.142.18:27017&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;configVersion&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;self&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;true&lt;/span&gt;&lt;span&gt;
        }, 
        {
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;_id&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;2&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;172.28.226.199:27017&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;health&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;state&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;7&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;stateStr&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ARBITER&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;uptime&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;168617&lt;/span&gt;&lt;span&gt;,
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;lastHeartbeat&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:56:06.895Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;lastHeartbeatRecv&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : ISODate(&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;2018-06-26T14:56:04.092Z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;pingMs&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : NumberLong(&lt;span&gt;35&lt;/span&gt;&lt;span&gt;),
            &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;configVersion&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1&lt;/span&gt;&lt;span&gt;
        }
    ],
    &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;ok&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; : &lt;span&gt;1.0&lt;/span&gt;&lt;span&gt;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;span class=&quot;cnblogs_code_collapse&quot;&gt;View Code&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;返回参数说明&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;“health” : 1, #代表机器正常 &lt;br/&gt;“stteStr” : “PRIMARY”, #代表是主节点，可读写，其中有以下几下状态:&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;STARTUP：刚加入到复制集中，配置还未加载
STARTUP2：配置已加载完，初始化状态
RECOVERING：正在恢复，不适用读
ARBITER: 仲裁者
DOWN：节点不可到达
UNKNOWN：未获取其他节点状态而不知是什么状态，一般发生在只有两个成员的架构，脑裂
REMOVED：移除复制集
ROLLBACK：数据回滚，在回滚结束时，转移到RECOVERING或SECONDARY状态
FATAL：出错。查看日志grep “replSet FATAL”找出错原因，重新做同步
PRIMARY：主节点
SECONDARY：备份节点&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;测试副本集数据复制&lt;/h3&gt;
&lt;p&gt;&lt;span&gt;注意&lt;/span&gt;：mongodb默认是从主节点读写数据的，副本节点上不允许读，需要设置副本节点可以读：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
repset:SECONDARY&amp;gt; db.getMongo().setSlaveOk();
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这个很好测试，直接在主节点插入一条数据，在备节点查询即可&lt;/p&gt;
&lt;p&gt;或者可以使用客户端以集群模式连接mongo集群：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/476931/201806/476931-20180626230615051-641750005.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;点Test 测试连接：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/476931/201806/476931-20180626230701724-1163508092.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;三个节点的数据是同步的。&lt;/p&gt;
&lt;h3&gt;测试副本集故障转移功能&lt;/h3&gt;
&lt;p&gt;1.查看集群当前状态，如上返回&lt;/p&gt;
&lt;p&gt;当前172.29.142.18是Primary, 172.29.142.17是Secondary&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/476931/201806/476931-20180626231338039-1220554405.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;2.停掉主节点172.29.142.18，查看另两台的选票结果&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/476931/201806/476931-20180626231813835-1226610177.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;此时17变成了主节点，原先的仲裁节点不变，重新启动第一次的Primary,则主节点又发生变化，不再截图，整个过程业务是不中断的。只要有一台可用即可。&lt;/p&gt;

&lt;p&gt;这里强烈不推荐连接单台mongo服务，因为如果一个mongo节点挂掉，业务就挂了，连接集群的话有一台可用就行。&lt;/p&gt;
&lt;p&gt;下面举了个nodejs连接mongo集群的示例：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;48&quot;&gt;
&lt;pre&gt;
const mongoose = require('mongoose'&lt;span&gt;);
let url &lt;/span&gt;= &quot;mongodb://172.29.142.17:27017/testdb,mongodb://172.29.142.18:27017/testdb,mongodb://172.28.226.199:27017/testdb&quot;&lt;span&gt;;
let options &lt;/span&gt;=&lt;span&gt; {
  &lt;/span&gt;&quot;replset&quot;&lt;span&gt;: {
    &lt;/span&gt;&quot;ha&quot;: &lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&quot;haInterval&quot;: 1000&lt;span&gt;,
    &lt;/span&gt;&quot;replicaSet&quot;: &quot;mongo-rs&quot;&lt;span&gt;,
    &lt;/span&gt;&quot;connectWithNoPrimary&quot;: &lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&quot;auto_reconnect&quot;: &lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
    &lt;/span&gt;&quot;socketOptions&quot;&lt;span&gt;: {
      &lt;/span&gt;&quot;keepAlive&quot;: 120&lt;span&gt;,
      connectTimeoutMS: &lt;/span&gt;30000&lt;span&gt;
    }
  }
}
 
 
mongoose.connect(url, options).connection
  .on(&lt;/span&gt;'error', &lt;span&gt;function&lt;/span&gt;&lt;span&gt; (error) {
    console.log(&lt;/span&gt;'mongo 连接错误'&lt;span&gt;, error)
  }).on(&lt;/span&gt;'disconnected', mongoConnect).once('open', &lt;span&gt;function&lt;/span&gt;&lt;span&gt; () {
    console.log(&lt;/span&gt;'mongo 连接成功'&lt;span&gt;);
  })&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;reference:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.csdn.net/luonanqin/article/details/8497860&quot; target=&quot;_blank&quot;&gt;https://blog.csdn.net/luonanqin/article/details/8497860&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://blog.csdn.net/wangshuang1631/article/details/53857319&quot; target=&quot;_blank&quot;&gt;https://blog.csdn.net/wangshuang1631/article/details/53857319&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Tue, 26 Jun 2018 15:25:00 +0000</pubDate>
<dc:creator>单曲荨环</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/zhoujie/p/mongo2.html</dc:identifier>
</item>
<item>
<title>使用vue全家桶制作博客网站 - 小火柴的蓝色理想</title>
<link>http://www.cnblogs.com/xiaohuochai/p/9228543.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/xiaohuochai/p/9228543.html</guid>
<description>&lt;h2&gt;前面的话&lt;/h2&gt;
&lt;p&gt;　　笔者在做一个完整的博客上线项目，包括&lt;a href=&quot;https://xiaohuochai.cc&quot; target=&quot;_blank&quot;&gt;前台&lt;/a&gt;、&lt;a href=&quot;https://admin.xiaohuochai.cc&quot; target=&quot;_blank&quot;&gt;后台&lt;/a&gt;、&lt;a href=&quot;https://api.xiaohuochai.cc&quot; target=&quot;_blank&quot;&gt;后端接口&lt;/a&gt;和服务器配置。本文将详细介绍使用vue全家桶制作的博客网站&lt;/p&gt;

&lt;h3&gt;概述&lt;/h3&gt;
&lt;p&gt;　　该项目是基于vue全家桶（vue、vue-router、vuex、vue SSR）开发的一套博客前台页面，主要功能包括首页显示、认证系统、文章管理、评论管理和点赞管理&lt;/p&gt;
&lt;p&gt;【访问地址】&lt;/p&gt;
&lt;p&gt;　　域名：&lt;a href=&quot;https://xiaohuochai.cc&quot; target=&quot;_blank&quot;&gt;https://xiaohuochai.cc&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;　　Github: &lt;a href=&quot;https://github.com/littlematch0123/blog-client&quot; target=&quot;_blank&quot;&gt;https://github.com/littlematch0123/blog-client&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;　　或者可以直接扫描二维码访问&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626120704941-161966102.png&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;【项目介绍】&lt;/p&gt;
&lt;p&gt;　　该项目的内容以笔者自学前端的过程中写的600多篇博客为基础，对于同样学习前端的同学可能会有所帮助。许多博客都有直接可以操作的DEMO，对知识的理解可能会更直观&lt;/p&gt;
&lt;p&gt;　　采用移动优先的响应式布局，移动端、桌面端均可适配；字体大小使用em单位，桌面端的文字相应变大；移动端可使用滑屏操作，桌面端通过光标设置、自定义滚动条、回车确定等，提升交互体验&lt;/p&gt;
&lt;p&gt;　　全站采用服务器端渲染SSR的方式，有利于SEO，减少了首屏渲染时间；使用service worker和manifest实现了PWA方案的离线缓存和添加到桌面的功能&lt;/p&gt;
&lt;p&gt;　　根据HTML标签内容模型，使用语义化标签，尽量减少标签层级，尽量减少无语义的div标签&lt;/p&gt;
&lt;p&gt;　　CSS大量使用类选择器，尽量减少选择器层级，在vue组件中使用CSS module和postCSS，使用styleLint规范CSS代码，按照布局类属性、盒模型属性、文本类属性、修饰类属性的顺序编写代码，并使用order插件进行校验&lt;/p&gt;
&lt;p&gt;　　使用esLint规范JS代码，代码风格参照airbnb规范，所有命名采用驼峰写法，公共组件以Base为前缀，事件函数以on为前缀，异步函数以async为后缀，布尔值基本以do或is为前缀&lt;/p&gt;
&lt;p&gt;　　没有引用第三方组件库，如bootstrap或element组件，而是自己开发了项目中所需的公共组件。在common目录下，封装了头像、全屏、loading、遮罩、搜索框、联动选择等组件，方便开发&lt;/p&gt;
&lt;p&gt;　　使用配置数据，实现了数据和应用分离，以常量的形式存储在constants目录下&lt;/p&gt;
&lt;p&gt;　　使用了阿里云的短信模块，实现了短信验证功能&lt;/p&gt;
&lt;p&gt;　　该项目有两个隐藏彩蛋，一个是摇一摇功能，可以直接摇到后台页面，另一个是陀螺仪功能，上下晃动手机时，头像会进行旋转&lt;/p&gt;
&lt;p&gt;　　项目进行了代码优化，最终优化评分如下所示&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626123143123-539363477.png&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;

&lt;h3&gt;功能演示&lt;/h3&gt;
&lt;p&gt;　　主要功能包括首页显示、认证系统、文章管理、评论管理和点赞管理&lt;/p&gt;
&lt;p&gt;【首页显示】&lt;/p&gt;
&lt;p&gt;　　首页包括可拖拽轮播图、专题推荐、文章推荐和类别推荐&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626124358985-249322724.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;【认证系统】&lt;/p&gt;
&lt;p&gt; 　　认证系统包括用户注册、用户登录、短信验证&lt;/p&gt;
&lt;p&gt;　　1、用户处于未登录态时，可以阅读文章，但不能点赞和评论，否则会弹出登录框&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626125037421-130556510.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;　　2、用户注册&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626181521125-879691695.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;　　3、用户登录&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626181652148-910834951.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;【文章管理】&lt;/p&gt;
&lt;p&gt;　　文章管理包括浏览推荐文章、按类别筛选、文章搜索、按目录查看&lt;/p&gt;
&lt;p&gt;　　1、浏览推荐文章&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626202352432-1677495072.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;　　2、文章筛选&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626202450702-1058268844.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;　　3、文章搜索&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626202943250-2031156894.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;　　4、按目录查看&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626203401441-1593672855.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;【点赞管理】&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626204215423-1449393234.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;p&gt;【评论管理】&lt;/p&gt;
&lt;p&gt;　　评论管理包括查看评论、添加评论、修改评论和删除评论&lt;/p&gt;
&lt;div&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/740839/201806/740839-20180626204442471-154123917.gif&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;

&lt;h3&gt;目录结构&lt;/h3&gt;
&lt;p&gt;　　src目录下，包括assets(静态资源)、common(公共组件)、components(功能组件)、constants(常量配置)、router(路由)、store(vuex)和utils(工具方法)这7个目录&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
- assets &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放静态资源，主要是图片&lt;/span&gt;
    -&lt;span&gt;imgs
    　　css.png &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; CSS文章背景图&lt;/span&gt;
&lt;span&gt;　　　　 ...
&lt;/span&gt;- common &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放公共组件&lt;/span&gt;
    -SVG &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放VUE图标组件&lt;/span&gt;
        SVGAdd.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; &quot;添加到&quot;按钮&lt;/span&gt;
        SVGBack.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; &quot;返回&quot;按钮&lt;/span&gt;
&lt;span&gt;        ...
    BaseArticle.vue &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文章组件&lt;/span&gt;
    BaseAvatar.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 头像组件&lt;/span&gt;
&lt;span&gt;    ...
&lt;/span&gt;- components &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放功能组件&lt;/span&gt;
    -Post &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文章组件      &lt;/span&gt;
      module.js &lt;span&gt;//&lt;/span&gt;&lt;span&gt;文章状态管理    &lt;/span&gt;
      Post.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文章显示组件&lt;/span&gt;
      PostContent.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文章目录组件&lt;/span&gt;
      PostList.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文章列表组件&lt;/span&gt;
      SearchPost.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 搜索文章组件&lt;/span&gt;
&lt;span&gt;      ...
&lt;/span&gt;- constants &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放常量配置&lt;/span&gt;
    API.js &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放API调用地址&lt;/span&gt;
- router &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放路由&lt;/span&gt;
&lt;span&gt;    index.js 
&lt;/span&gt;- store &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放vuex&lt;/span&gt;
&lt;span&gt;    index.js
&lt;/span&gt;- utils &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 存放工具方法&lt;/span&gt;
    &lt;span&gt;async&lt;/span&gt;.js &lt;span&gt;//&lt;/span&gt;&lt;span&gt; axios方法&lt;/span&gt;
    fnVarificate.js &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 表单验证方法&lt;/span&gt;
    util.js &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 其他工具方法&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【公共组件】&lt;/p&gt;
&lt;p&gt;　　没有引用第三方组件库，如bootstrap或element组件，而是自己开发了项目中所需的公共组件&lt;/p&gt;
&lt;p&gt;　　封装了文章组件、头像组件、返回组件、按钮组件、卡片组件、全屏组件、输入框组件、loading组件、遮罩组件、搜索框组件、多行输入框组件、标题组件、面包屑组件、按钮组组件、反色按钮组件、密码框组件、包含检测的输入框组件和联动选择组件&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
BaseAdd.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; &quot;添加到&quot;组件&lt;/span&gt;
BaseArticle.vue  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 文章组件&lt;/span&gt;
BaseAvatar.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 头像组件&lt;/span&gt;
BaseBack.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 返回组件&lt;/span&gt;
BaseButton.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 按钮组件&lt;/span&gt;
BaseCard.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 卡片组件&lt;/span&gt;
BaseFullScreen.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 全屏组件&lt;/span&gt;
BaseInput.vue  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 输入框组件&lt;/span&gt;
BaseLoading.vue  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; loading组件&lt;/span&gt;
BaseMask.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 遮罩组件&lt;/span&gt;
BaseSearchBox.vue  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 搜索框组件&lt;/span&gt;
BaseTextArea.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 多行输入框组件&lt;/span&gt;
BaseTitle.vue  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 标题组件&lt;/span&gt;
BreadCrumb.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 面包屑组件&lt;/span&gt;
ButtonBox.vue  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 按钮组组件&lt;/span&gt;
ButtonInverted.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 反色按钮组件&lt;/span&gt;
InputPassword.vue  &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 密码框组件&lt;/span&gt;
InputWithTest.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 包含检测的输入框组件&lt;/span&gt;
LinkageSelector.vue &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 联动选择组件&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【功能组件】&lt;/p&gt;
&lt;p&gt;　　按照功能来设置目录，如下所示&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;弹出框(Alert)
类别管理(Category)
评论管理(Comment)
主页(Home)
点赞管理(Like)
文章管理(Post)
页面尺寸(Size)&lt;br/&gt;公共头部(TheHeader)
用户管理(User)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;整体思路&lt;/h3&gt;
&lt;p&gt;【全屏布局】&lt;/p&gt;
&lt;p&gt;　　使用设置高度的全屏布局方式，主要通过calc来实现&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&amp;lt;&lt;span&gt;div
  id&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;root&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  :&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.wrap&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  :style&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;{height:wrapHeight+'px'}&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
&amp;gt;&lt;span&gt;
  ...
  &lt;/span&gt;&amp;lt;TheHeader :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.header&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;/&amp;gt;
  &amp;lt;main :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.main&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;transition :name=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;transitionName&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;router-view :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.router&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;/transition&amp;gt;
  &amp;lt;/main&amp;gt;
&amp;lt;/div&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;.header {
  height: 40px;
}
.main {
  position: relative;
  height: calc(&lt;/span&gt;&lt;span&gt;100&lt;/span&gt;% -&lt;span&gt; 40px);
  overflow: auto;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【层级管理】&lt;/p&gt;
&lt;p&gt;　　项目的层级z-index，只使用0-3&lt;/p&gt;
&lt;p&gt;　　全屏的弹出框优化级最高，设置为3；侧边栏设置为2；页面元素默认为0，如有需要，要设置为1&lt;/p&gt;
&lt;p&gt;【全局弹出层】&lt;/p&gt;
&lt;p&gt;　　在入口文件App.vue中设置全局的弹出层和loading，所有组件都可以共用&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; App.vue&lt;/span&gt;
&amp;lt;template&amp;gt;
  &amp;lt;&lt;span&gt;div
    id&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;root&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    :&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.wrap&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    :style&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;{height:wrapHeight+'px'}&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
  &amp;gt;
    &amp;lt;AlertWithLoading v-show=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;doShowLoading&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
    &amp;lt;&lt;span&gt;AlertWithText
      v&lt;/span&gt;-show=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;alertText !== ''&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
      :text&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;alertText&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
      :onClick&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;() =&amp;gt; {$store.commit(HIDE_ALERTTEXT)}&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
    /&amp;gt;
    &amp;lt;TheHeader :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.header&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;main :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.main&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
      &amp;lt;transition :name=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;transitionName&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
        &amp;lt;router-view :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.router&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
      &amp;lt;/transition&amp;gt;
    &amp;lt;/main&amp;gt;
  &amp;lt;/div&amp;gt;
&amp;lt;/template&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【路由管理】&lt;/p&gt;
&lt;p&gt;　　vue-router使用静态路由表的形式对路由进行管理，虽然没有react-router-dom灵活，但方便寻找，一目了然&lt;/p&gt;
&lt;p&gt;　　按路由设置按需加载组件，并设置滚动行为&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;85&quot;&gt;
&lt;pre&gt;
import Vue &lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;vue&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import Router &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;vue-router&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;

Vue.use(Router)
export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt; function createRouter() {
  &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt;&lt;span&gt; Router({
    mode: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;history&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
    routes: [
      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'home' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Home/Home&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;home&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        meta: { index: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt; }
      },
      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/posts&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'post' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Post/PostList&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;postlist&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/posts/search&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'post' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Post/SearchPost&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;searchpost&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/posts/:postid&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'post' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Post/Post&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;post&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        children: [
          {
            path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;comments&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
            name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;commentlist&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
            component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'comment' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Comment/CommentList&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
            children: [
              {
                path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;add&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
                name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;addcomment&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
                component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'comment' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Comment/AddComment&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
              },
              {
                path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;:commentid/update&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
                name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;updatecomment&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
                component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'comment' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Comment/UpdateComment&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
              },
              {
                path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;:commentid/delete&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
                name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;deletecomment&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
                component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'comment' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Comment/DeleteComment&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
              }
            ]
          }
        ]
      },
      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/categories&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'category' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Category/CategoryList&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;categorylist&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/categories/:number&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'category' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Category/Category&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;category&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/topics/:number&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'category' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Category/CategoryTopic&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;topic&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 注册&lt;/span&gt;
&lt;span&gt;      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/signup&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'user' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/User/AuthSignup&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;signup&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 按手机号登录&lt;/span&gt;
&lt;span&gt;      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/signin_by_phonenumber&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'user' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/User/AuthSigninByPhoneNumber&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;signin_by_phonenumber&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 按用户名登录&lt;/span&gt;
&lt;span&gt;      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/signin_by_username&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'user' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/User/AuthSigninByUsername&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;signin_by_username&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 用户页面&lt;/span&gt;
&lt;span&gt;      {
        path: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/users/:userid&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        component: () &lt;/span&gt;=&amp;gt; import(&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; webpackChunkName:'user' &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/User/UserDesk&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
        name: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;user&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      }
    ],
    scrollBehavior(to, &lt;/span&gt;&lt;span&gt;from&lt;/span&gt;&lt;span&gt;, savedPosition) {
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (savedPosition) {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; savedPosition
      }
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; { x: &lt;span&gt;0&lt;/span&gt;, y: &lt;span&gt;0&lt;/span&gt;&lt;span&gt; }
    }
  })
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【状态管理】&lt;/p&gt;
&lt;p&gt;　　每个组件的状态管理命名为module.js，保存在当前组件目录下&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
import Vue &lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;vue&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import Vuex &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;vuex&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import auth &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/User/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import alert &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Alert/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import post &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Post/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import category &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Category/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import like &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Like/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import size &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Size/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import comment &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Comment/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;

Vue.use(Vuex)
export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt; function createStore() {
  &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt;&lt;span&gt; Vuex.Store({
    modules: {
      auth,
      alert,
      post,
      category,
      like,
      size,
      comment
    }
  })
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　每个组件的状态包括state、getters、actions和mutations字段，以Category组件为例&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;56&quot;&gt;
&lt;pre&gt;
import { BASE_CATEGORY_URL } &lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/constants/API&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import { getNumberWithoutPostPositiveZero, getCategoryNumbers } &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/utils/util&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;

export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; LOAD_CATEGORIES = &lt;span&gt;'&lt;/span&gt;&lt;span&gt;LOAD_CATEGORIES&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; LOAD_CATEGORIES_ASYNC = &lt;span&gt;'&lt;/span&gt;&lt;span&gt;LOAD_CATEGORIES_ASYNC&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;
&lt;span&gt;const&lt;/span&gt; category =&lt;span&gt; {
  state: {
    docs: []
  },
  getters: {
    categoryCount: state &lt;/span&gt;=&amp;gt;&lt;span&gt; state.docs.length,
    getCategoriesByNumber: state &lt;/span&gt;=&amp;gt; state.docs.reduce((obj, t) =&amp;gt;&lt;span&gt; {
      obj[t.number] &lt;/span&gt;=&lt;span&gt; t
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; obj
    }, {}),
    getCategoryByNumber: state &lt;/span&gt;=&amp;gt; number =&amp;gt; state.docs.find(doc =&amp;gt; doc.number ===&lt;span&gt; number),
    getPosterityCategories: (state, getters) &lt;/span&gt;=&amp;gt; number =&amp;gt;&lt;span&gt; {
      &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; reg = &lt;span&gt;new&lt;/span&gt; RegExp(`^&lt;span&gt;${getNumberWithoutPostPositiveZero(number)}`)
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; state.docs.filter(doc =&amp;gt;&lt;span&gt; {
        doc.titleDatas &lt;/span&gt;= getCategoryNumbers(doc.number).map(t =&amp;gt;&lt;span&gt; getters.getCategoriesByNumber[t].name)
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; String(doc.number).match(reg) &amp;amp;&amp;amp;&lt;span&gt; (doc.posts.length)
      })
    },
    getChildrenCategoryies: state &lt;/span&gt;=&amp;gt; number =&amp;gt;&lt;span&gt; {
      &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; reference =&lt;span&gt; String(getNumberWithoutPostPositiveZero(number))
      &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; len =&lt;span&gt; reference.length
      &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; regExp = &lt;span&gt;new&lt;/span&gt; RegExp(`^${reference}(&lt;span&gt;0&lt;/span&gt;[&lt;span&gt;1&lt;/span&gt;-&lt;span&gt;9&lt;/span&gt;]|[&lt;span&gt;1&lt;/span&gt;-&lt;span&gt;9&lt;/span&gt;][&lt;span&gt;0&lt;/span&gt;-&lt;span&gt;9&lt;/span&gt;])(&lt;span&gt;0&lt;/span&gt;){${&lt;span&gt;8&lt;/span&gt; -&lt;span&gt; len}}`)
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; state.docs.filter(doc =&amp;gt;&lt;span&gt; String(doc.number).match(regExp))
    },
    getCategoryRootDatas: state &lt;/span&gt;=&amp;gt; state.docs.filter(doc =&amp;gt; Number(String(doc.number).slice(&lt;span&gt;2&lt;/span&gt;)) === &lt;span&gt;0&lt;/span&gt;&lt;span&gt;),
    getRecommendedCategories: state &lt;/span&gt;=&amp;gt; state.docs.filter(t =&amp;gt; t.recommend).sort((a, b) =&amp;gt; a.index -&lt;span&gt; b.index)
  },
  actions: {
    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; 获取全部类别信息 &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    [LOAD_CATEGORIES_ASYNC]({ commit }) {
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; Promise((resolve, reject) =&amp;gt;&lt;span&gt; {
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;._vm.$axios({
          commit,
          url: BASE_CATEGORY_URL,
          doHideAlert: &lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
          success(result) {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 保存类别&lt;/span&gt;
&lt;span&gt;            commit(LOAD_CATEGORIES, result.docs)
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 向前端通知操作成功&lt;/span&gt;
&lt;span&gt;            resolve(result.docs)
          },
          fail(err) {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 向前端通知操作失败&lt;/span&gt;
&lt;span&gt;            reject(err)
          }
        })
      })
    }
  },
  mutations: {
    &lt;/span&gt;&lt;span&gt;/*&lt;/span&gt;&lt;span&gt; 保存类别信息 &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;&lt;span&gt;
    [LOAD_CATEGORIES](state, payload) {
      state.docs &lt;/span&gt;=&lt;span&gt; payload
    }
  }
}
export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt; category
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【数据传递】&lt;/p&gt;
&lt;p&gt;　　组件间的数据传递方式一般有三种，一种是使用vue中的props和自定义事件，另一种是使用路由的params属性，还有一种是通过vuex&lt;/p&gt;
&lt;p&gt;　　1、props和自定义事件&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;38&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; BaseInput&lt;/span&gt;
&amp;lt;template&amp;gt;
  &amp;lt;&lt;span&gt;input
    :&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.input&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    :value&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;value&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    autocomplete&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;off&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    autocapitalize&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;off&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    @input&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$emit('input', $event.target.value)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
  &amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;&lt;span&gt;
export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt; {
  props: {
    value: { type: String, &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;: &lt;span&gt;''&lt;/span&gt;&lt;span&gt; }
  }
}
&lt;/span&gt;&amp;lt;/script&amp;gt;

&lt;span&gt;//&lt;/span&gt;&lt;span&gt; InputPassword&lt;/span&gt;
&amp;lt;&lt;span&gt;input
  :&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.input&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  :placeholder&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;placeholder&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  :value&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;value&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  autocomplete&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;off&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  autocapitalize&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;off&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  type&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;password&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
  @input&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$emit('input',$event.target.value)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　2、路由的params属性&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; Post.vue&lt;/span&gt;
 &amp;lt;BaseBack @click.native=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$router.push($route.params.parentPath || '/')&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;返回&amp;lt;/BaseBack&amp;gt;

&lt;span&gt;//&lt;/span&gt;&lt;span&gt;AuthSign.vue&lt;/span&gt;
&amp;lt;template&amp;gt;
    &amp;lt;router-&lt;span&gt;link
        :active&lt;/span&gt;-&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.active&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
        :to&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;{ name: 'signin', params: { parentPath } }&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
    &amp;gt;登&amp;amp;nbsp;录&amp;lt;/router-link&amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;&lt;span&gt;
export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt; {
  computed: {
    parentPath() {
      &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; temp = &lt;span&gt;this&lt;/span&gt;.$route.&lt;span&gt;params&lt;/span&gt;&lt;span&gt;.parentPath
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (temp) {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; temp
      }
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;''&lt;/span&gt;&lt;span&gt;
    }
  }
}
&lt;/span&gt;&amp;lt;/script&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;　　3、使用vuex&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; Category.vue&lt;/span&gt;
&amp;lt;template&amp;gt;
  &amp;lt;article v-&lt;span&gt;if&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;category&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.box&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;BaseBack @click.native=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$router.push('/categories')&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;类别列表&amp;lt;/BaseBack&amp;gt;
    &amp;lt;BaseTitle&amp;gt;{{ category.name }}知识体系&amp;lt;/BaseTitle&amp;gt;&lt;span&gt;
    ...
  &lt;/span&gt;&amp;lt;/article&amp;gt;
&amp;lt;/template&amp;gt;
&amp;lt;script&amp;gt;&lt;span&gt;
export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt;&lt;span&gt; {
  computed: {
    category() {
      &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;this&lt;/span&gt;.$store.getters.getCategoryByNumber(Number(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.paramsNumber))
    }
    ...
  }
}
&lt;/span&gt;&amp;lt;/script&amp;gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;项目优化&lt;/h3&gt;
&lt;p&gt;【离线缓存】&lt;/p&gt;
&lt;p&gt;　　通过service worker实现离线缓存效果&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;47&quot;&gt;
&lt;pre&gt;
&lt;span&gt;const&lt;/span&gt; SWPrecacheWebpackPlugin = require(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;sw-precache-webpack-plugin&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)

plugins: [
  &lt;/span&gt;&lt;span&gt;new&lt;/span&gt;&lt;span&gt; SWPrecacheWebpackPlugin({
    dontCacheBustUrlsMatching: &lt;/span&gt;/\.\w{&lt;span&gt;8&lt;/span&gt;}\./&lt;span&gt;,
    filename: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;service-worker.js&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
    logger(message) {
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (message.indexOf(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;Total precache size is&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;) === &lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt;;
      }
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (message.indexOf(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;Skipping static resource&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;) === &lt;span&gt;0&lt;/span&gt;&lt;span&gt;) {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt;;
      }
      console.log(message);
    },
    navigateFallback: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://www.xiaohuochai.cc&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
    minify: &lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
    navigateFallbackWhitelist: [&lt;/span&gt;/^(?!\/__).*/&lt;span&gt;],
    dontCacheBustUrlsMatching: &lt;/span&gt;/./&lt;span&gt;,
    staticFileGlobsIgnorePatterns: [&lt;/span&gt;/\.map$/, /\.json$/&lt;span&gt;],
    runtimeCaching: [{
        urlPattern: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;,
        handler: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;networkFirst&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      },
      {
        urlPattern: &lt;/span&gt;/\/(posts|categories|users|likes|comments)/&lt;span&gt;,
        handler: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;networkFirst&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      }
    ]
  })
]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【添加到桌面】&lt;/p&gt;
&lt;p&gt;　　andriod下，通过设置manifest.json文件添加到桌面，而IOS则需要设置meta标签&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;59&quot;&gt;
&lt;pre&gt;
&amp;lt;meta name=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;theme-color&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; content=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;#fff&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;/&amp;gt;
&amp;lt;meta name=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;apple-mobile-web-app-capable&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; content=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;yes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
&amp;lt;meta name=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;apple-mobile-web-app-status-bar-style&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; content=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;black&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
&amp;lt;meta name=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;apple-mobile-web-app-title&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; content=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;前端小站&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
&amp;lt;link rel=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;apple-touch-icon&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; href=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;/logo/logo_256.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
&amp;lt;link rel=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;shortcut icon&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; href=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;/logo/favicon.ico&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
&amp;lt;link rel=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;manifest&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; href=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;/manifest.json&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;

&lt;span&gt;//&lt;/span&gt;&lt;span&gt; manifest.json&lt;/span&gt;
&lt;span&gt;{
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;小火柴的前端小站&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;short_name&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;前端小站&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;start_url&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;display&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;standalone&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;description&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&quot;&lt;/span&gt;&lt;span&gt;,
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;theme_color&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;#fff&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;background_color&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;#d8d8d8&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
  &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;icons&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;: [{
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;src&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;./logo/logo_32.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;sizes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;32x32&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;image/png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    },
    {
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;src&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;./logo/logo_48.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;sizes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;48x48&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;image/png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    },
    {
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;src&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;./logo/logo_96.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;sizes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;96x96&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;image/png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    },
    {
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;src&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;./logo/logo_144.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;sizes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;144x144&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;image/png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    },
    {
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;src&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;./logo/logo_192.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;sizes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;192x192&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;image/png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    },
    {
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;src&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;./logo/logo_256.png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;sizes&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;256x256&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;,
      &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;type&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;: &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;image/png&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    }
  ]
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【子页面刷新】&lt;/p&gt;
&lt;p&gt;　　子页面刷新时，可能会出现得不到从父级传递过来的数据的情况，笔者的处理是跳转到父级页面&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;mounted() {
  &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!&lt;span&gt;this&lt;/span&gt;.comment &amp;amp;&amp;amp; &lt;span&gt;this&lt;/span&gt;.operate === &lt;span&gt;'&lt;/span&gt;&lt;span&gt;update&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;) {
    &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.$router.push(`/posts/${&lt;span&gt;this&lt;/span&gt;.postId}/&lt;span&gt;comments`)
  } &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
    &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.setTextAreaValue()
  }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【promise】&lt;/p&gt;
&lt;p&gt;　　为actions添加Promise，方便状态改变后的处理&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;43&quot;&gt;
&lt;pre&gt;
&lt;span&gt;[LOAD_COMMENTS_ASYNC]({ commit }, payload) {
  &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt; Promise((resolve, reject) =&amp;gt;&lt;span&gt; {
    &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;&lt;span&gt;._vm.$axios({
      commit,
      data: payload,
      url: BASE_COMMENT_URL,
      doHideAlert: &lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;,
      success(result) {
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 保存类别&lt;/span&gt;
&lt;span&gt;        commit(LOAD_COMMENTS, result.docs)
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 向前端通知操作成功&lt;/span&gt;
&lt;span&gt;        resolve(result.docs)
      },
      fail(err) {
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 向前端通知操作失败&lt;/span&gt;
&lt;span&gt;        reject(err)
      }
    })
  })
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【组件共用】&lt;/p&gt;
&lt;p&gt;　　由于编辑和新建组件用到的元素是一样的，只不过，新建组件时内容为空，编辑组件时需要添加内容，这时就可以复用组件&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; AddComment.vue&lt;/span&gt;
&amp;lt;CommentForm operate=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;add&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;

&lt;span&gt;//&lt;/span&gt;&lt;span&gt;UpdateComment.vue&lt;/span&gt;
&amp;lt;CommentForm operate=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;update&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【清理环境】&lt;/p&gt;
&lt;p&gt;　　如果使用addEventListener绑定了事件处理函数，在组件销毁的时候，要及时清理环境&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;mounted() {
  window.addEventListener(&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;devicemotion&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, throttle(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.testShake))
}
beforeDestroy() {
  window.removeEventListener(&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;devicemotion&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, throttle(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.testShake))
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【应用和数据分离】&lt;/p&gt;
&lt;p&gt;　　使用配置数据，实现数据和应用分离，配置数据主要是API调用地址，以常量的形式存储在constants目录下&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; API.js&lt;/span&gt;
&lt;span&gt;let API_HOSTNAME
&lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (process.env.NODE_ENV === &lt;span&gt;'&lt;/span&gt;&lt;span&gt;production&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;) {
  API_HOSTNAME &lt;/span&gt;= &lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://api.xiaohuochai.cc&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
} &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
  API_HOSTNAME &lt;/span&gt;= &lt;span&gt;'&lt;/span&gt;&lt;span&gt;/api&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
}
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; SIGNUP_URL = `${API_HOSTNAME}/auth/&lt;span&gt;signup`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; SIGNIN_BYUSERNAME_URL = `${API_HOSTNAME}/auth/&lt;span&gt;signin_by_username`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; SIGNIN_BYPHONENUMBER_URL = `${API_HOSTNAME}/auth/&lt;span&gt;signin_by_phonenumber`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; VERIFICATE_URL = `${API_HOSTNAME}/auth/&lt;span&gt;verificate`

export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; BASE_USER_URL = `${API_HOSTNAME}/&lt;span&gt;users`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; BASE_POST_URL = `${API_HOSTNAME}/&lt;span&gt;posts`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; BASE_TOPIC_URL = `${API_HOSTNAME}/&lt;span&gt;topics`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; BASE_CATEGORY_URL = `${API_HOSTNAME}/&lt;span&gt;categories`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; BASE_LIKE_URL = `${API_HOSTNAME}/&lt;span&gt;likes`
export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; BASE_COMMENT_URL = `${API_HOSTNAME}/&lt;span&gt;comments`

export &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; ADMIN_URL = &lt;span&gt;'&lt;/span&gt;&lt;span&gt;https://admin.xiaohuochai.cc&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【函数节流】&lt;/p&gt;
&lt;p&gt;　　为触发频率较高的函数使用函数节流&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
/**
 * 函数节流
 * @param {fn} function test(){}
 * @return {fn} function test(){}
 */&lt;span&gt;
export const throttle = (fn, wait = 100) =&amp;gt;&lt;span&gt; function func(...args) {
  if (fn.timer) return&lt;span&gt;
  fn.timer = setTimeout(() =&amp;gt;&lt;span&gt; {
    fn.apply(this&lt;span&gt;, args)
    fn.timer = null&lt;span&gt;
  }, wait)
}&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【DNS预解析】&lt;/p&gt;
&lt;p&gt;　　DNS预解析通过设置meta标签实现&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&amp;lt;link rel=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;dns-prefetch&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; href=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;//api.xiaohuochai.cc&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
&amp;lt;link rel=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;dns-prefetch&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; href=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;//static.xiaohuochai.site&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
&amp;lt;link rel=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;dns-prefetch&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; href=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;//demo.xiaohuochai.site&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
&amp;lt;link rel=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;dns-prefetch&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; href=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;//pic.xiaohuochai.site&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; /&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【图片懒加载和webp】&lt;/p&gt;
&lt;p&gt;　　通过vue-lazyload插件实现图片懒加载和andriod系统下图片转换成webp格式&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;38&quot;&gt;
&lt;pre&gt;
&lt;span&gt;Vue.use(VueLazyload, {
  loading: require(&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;./assets/imgs/loading.gif&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;),
  listenEvents: [&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;scroll&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;],
  filter: {
    webp(listener, options) {
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (!options.supportWebp) &lt;span&gt;return&lt;/span&gt;
      &lt;span&gt;const&lt;/span&gt; isCDN = /xiaohuochai.site/
      &lt;span&gt;if&lt;/span&gt;&lt;span&gt; (isCDN.test(listener.src)) {
        listener.src &lt;/span&gt;+= &lt;span&gt;'&lt;/span&gt;&lt;span&gt;?imageView2/2/format/webp&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
      }
    }
  }
})&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;功能实现&lt;/h3&gt;
&lt;p&gt;【摇一摇效果】&lt;/p&gt;
&lt;p&gt;　　摇一摇效果主要通过监测devicemotion事件实现&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;43&quot;&gt;
&lt;pre&gt;
&lt;span&gt;  mounted() {
    window.addEventListener(&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;devicemotion&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, throttle(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.testShake))
  },
  beforeDestroy() {
    window.removeEventListener(&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;devicemotion&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, throttle(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.testShake))
  },
  methods: {
    testShake(e) {
      &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; { x, y, z } =&lt;span&gt; e.accelerationIncludingGravity
      &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; { lastX, lastY, lastZ } = &lt;span&gt;this&lt;/span&gt;
      &lt;span&gt;const&lt;/span&gt; nowRange = Math.abs(lastX - x) + Math.abs(lastY - y) + Math.abs(lastZ -&lt;span&gt; z)
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (nowRange &amp;gt; &lt;span&gt;80&lt;/span&gt;&lt;span&gt;) {
        window.location.href &lt;/span&gt;=&lt;span&gt; ADMIN_URL
      }
      &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.lastX =&lt;span&gt; x
      &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.lastY =&lt;span&gt; y
      &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.lastZ =&lt;span&gt; z
    }
  }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【陀螺仪效果】&lt;/p&gt;
&lt;p&gt;　　陀螺仪效果主要通过监测deviceorientation事件实现&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;39&quot;&gt;
&lt;pre&gt;
&lt;span&gt;  mounted() {
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 监测陀螺仪&lt;/span&gt;
    window.addEventListener(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;deviceorientation&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, throttle(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.changeBeta))
  },
  beforeDestroy() {
    &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 取消监测&lt;/span&gt;
    window.removeEventListener(&lt;span&gt;'&lt;/span&gt;&lt;span&gt;deviceorientation&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;, throttle(&lt;span&gt;this&lt;/span&gt;&lt;span&gt;.changeBeta))
  },
  methods: {
    changeBeta(e) {
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (&lt;span&gt;this&lt;/span&gt;.beta !==&lt;span&gt; Math.round(e.beta)) {
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.beta =&lt;span&gt; Math.round(e.beta)
      }
    }
  }&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【缓动弹出层】&lt;/p&gt;
&lt;p&gt;　　过渡弹出层有两种实现方式，包括transition和animation，该项目使用animation的方式实现&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&amp;lt;UserMenuList v-&lt;span&gt;if&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;doShowMenuList&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; :onExit=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;() =&amp;gt; {doShowMenuList = false}&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;/&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;@keyframes move {
  &lt;/span&gt;&lt;span&gt;100&lt;/span&gt;% { transform: translateY(&lt;span&gt;0&lt;/span&gt;&lt;span&gt;); }
}
@keyframes opacity {
  &lt;/span&gt;&lt;span&gt;100&lt;/span&gt;% { opacity: &lt;span&gt;1&lt;/span&gt;&lt;span&gt;; }
}
.mask {
  opacity: &lt;/span&gt;&lt;span&gt;0&lt;/span&gt;&lt;span&gt;;
  animation: opacity linear both .2s;
}
.list {
  transform: translateY(&lt;/span&gt;-&lt;span&gt;100&lt;/span&gt;%&lt;span&gt;);
  animation: move forwards .2s;
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【图标管理】&lt;/p&gt;
&lt;p&gt;　　所有的图标都使用SVG格式，存储在common/SVG目录下&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;//&lt;/span&gt;&lt;span&gt; SVGAdd.vue&lt;/span&gt;
&amp;lt;template&amp;gt;
  &amp;lt;svg fill=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;#000000&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; height=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;24&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; viewBox=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;0 0 24 24&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; width=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;24&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; xmlns=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;http://www.w3.org/2000/svg&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
    &amp;lt;path d=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;/&amp;gt;
    &amp;lt;path d=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;M0 0h24v24H0z&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; fill=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;none&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;/&amp;gt;
  &amp;lt;/svg&amp;gt;
&amp;lt;/template&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【axios函数封装】&lt;/p&gt;
&lt;p&gt;　　封装axios函数到utils目录下的async.js文件中，将loading组件、alert组件整合到axios函数的整个数据获取过程中&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;56&quot;&gt;
&lt;pre&gt;
import { SHOW_LOADING, HIDE_LOADING, SHOW_ALERTTEXT, HIDE_ALERTTEXT } &lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/Alert/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import { SIGNOUT } &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;@/components/User/module&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
import axios &lt;/span&gt;&lt;span&gt;from&lt;/span&gt; &lt;span&gt;'&lt;/span&gt;&lt;span&gt;axios&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;

&lt;span&gt;const&lt;/span&gt; &lt;span&gt;async&lt;/span&gt; =&lt;span&gt; {
  install(Vue) {
    Vue.prototype.$axios &lt;/span&gt;= ({ commit, url, method, data, headers, success, fail, doHideAlert }) =&amp;gt;&lt;span&gt; {
      &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 显示loading&lt;/span&gt;
&lt;span&gt;      commit(SHOW_LOADING)
      let axiosObj &lt;/span&gt;=&lt;span&gt; url
      &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (method) {
        axiosObj &lt;/span&gt;=&lt;span&gt; { method, url, data, headers }
      }
      axios(axiosObj)
        .then(res &lt;/span&gt;=&amp;gt;&lt;span&gt; {
          &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; { message, result } =&lt;span&gt; res.data
          &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 关闭loading&lt;/span&gt;
&lt;span&gt;          commit(HIDE_LOADING)
          &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 显示成功提示&lt;/span&gt;
          !doHideAlert &amp;amp;&amp;amp;&lt;span&gt; commit(SHOW_ALERTTEXT, message)
          &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 1秒后自动关闭提示&lt;/span&gt;
          setTimeout(() =&amp;gt; { commit(HIDE_ALERTTEXT) }, &lt;span&gt;1000&lt;/span&gt;&lt;span&gt;)
          &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 成功后的回调函数&lt;/span&gt;
          success &amp;amp;&amp;amp;&lt;span&gt; success(result)
        })
        .&lt;/span&gt;&lt;span&gt;catch&lt;/span&gt;(err =&amp;gt;&lt;span&gt; {
          &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 关闭loading&lt;/span&gt;
&lt;span&gt;          commit(HIDE_LOADING)
          &lt;/span&gt;&lt;span&gt;if&lt;/span&gt;&lt;span&gt; (err.response) {
            &lt;/span&gt;&lt;span&gt;const&lt;/span&gt; { data } =&lt;span&gt; err.response
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 自定义错误&lt;/span&gt;
            &lt;span&gt;if&lt;/span&gt; (data.code === &lt;span&gt;1&lt;/span&gt;&lt;span&gt;) {
              commit(SHOW_ALERTTEXT, data.message)
              &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 系统错误&lt;/span&gt;
            } &lt;span&gt;else&lt;/span&gt; &lt;span&gt;if&lt;/span&gt; (data.code === &lt;span&gt;2&lt;/span&gt;&lt;span&gt;) {
              commit(SHOW_ALERTTEXT, data.message)
              fail &lt;/span&gt;&amp;amp;&amp;amp;&lt;span&gt; fail(err)
              &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 认证错误&lt;/span&gt;
            } &lt;span&gt;else&lt;/span&gt; &lt;span&gt;if&lt;/span&gt; (data.code === &lt;span&gt;3&lt;/span&gt;&lt;span&gt;) {
              commit(SHOW_ALERTTEXT, data.message)
              commit(SIGNOUT)
              window.location.href &lt;/span&gt;= &lt;span&gt;'&lt;/span&gt;&lt;span&gt;/signin_by_username&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;
            } &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
              &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 显示错误提示&lt;/span&gt;
              commit(SHOW_ALERTTEXT, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;服务器故障&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
              &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 失败后的回调函数&lt;/span&gt;
              fail &amp;amp;&amp;amp;&lt;span&gt; fail(err)
            }
          } &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 显示错误提示&lt;/span&gt;
            commit(SHOW_ALERTTEXT, &lt;span&gt;'&lt;/span&gt;&lt;span&gt;服务器故障&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;)
            &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 失败后的回调函数&lt;/span&gt;
            fail &amp;amp;&amp;amp;&lt;span&gt; fail(err)
          }
        })
    }
  }
}

export &lt;/span&gt;&lt;span&gt;default&lt;/span&gt; &lt;span&gt;async&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【目录跳转】&lt;/p&gt;
&lt;p&gt;　　使用scrollIntoView()方法，点击目录时，文章跳转到相关部分，且不改变URL&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&amp;lt;ul :&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.list&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&amp;gt;
  &amp;lt;&lt;span&gt;li
    v&lt;/span&gt;-&lt;span&gt;for&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;(item, index) in titles&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    :key&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;item&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    :&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$style.item&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
    @click&lt;/span&gt;=&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;onChangeAnchor(`anchor${index+1}`)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
  &amp;gt;&lt;span&gt;
    {{ index &lt;/span&gt;+ &lt;span&gt;1&lt;/span&gt;&lt;span&gt; }}、{{ item }}
  &lt;/span&gt;&amp;lt;/li&amp;gt;
&amp;lt;/ul&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;methods: {
  onChangeAnchor(id) {
    document.getElementById(id).scrollIntoView({ behavior: &lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt;smooth&lt;/span&gt;&lt;span&gt;'&lt;/span&gt;&lt;span&gt; })
  }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;h3&gt;兼容处理&lt;/h3&gt;
&lt;p&gt;【锚点】&lt;/p&gt;
&lt;p&gt;　　使用锚点进行页面内跳转时，URL发生改变，页面刷新，其他浏览器没有问题。但是，ISO下的PWA桌面图标会跳转到safari浏览器中&lt;/p&gt;
&lt;p&gt;　　使用scrollIntoView()方法来替代锚点#，页面内只跳转不刷新。andriod下支持给scrollIntoView设置平滑滚动behavior: 'smooth'，但IOS不支持&lt;/p&gt;
&lt;p&gt;【页面放大】&lt;/p&gt;
&lt;p&gt;　　IOS下，input获取焦点时会放大，meta设置user-scalable=no，可取消放大效果&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&amp;lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, user-scalable=no, shrink-to-fit=no&quot;&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【圆角】&lt;/p&gt;
&lt;p&gt;　　IOS下，input域只显示底边框时，会出现底边圆角效果，设置border-radius:0即可&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;
&lt;pre&gt;
border-radius:0
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【轮廓outline】&lt;/p&gt;
&lt;p&gt;　　android浏览器下，input域处于焦点状态时，默认会有一圈淡黄色的轮廓outline效果&lt;/p&gt;
&lt;p&gt;　　通过设置outline:none可将其去除&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot;&gt;
&lt;pre&gt;
outline: none
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【点击背景】&lt;/p&gt;
&lt;p&gt;　　在移动端，点击可点击元素时，android下会出现淡蓝色背景，IOS下会出现灰色背景&lt;/p&gt;
&lt;p&gt;　　可以通过-webkt-tap-hightlight-color属性的设置，取消点击时出现的背景效果&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
* {
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【局部不滚动】&lt;/p&gt;
&lt;p&gt;　　IOS下，可能会出现局部滚动不流畅，甚至局部不滚动的bug&lt;/p&gt;
&lt;p&gt;　　通过在该元素上设置overflow-scrolling属性为touch即可解决&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
div {
  -webkit-overflow-scrolling: touch;
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;【锚点】&lt;/p&gt;
&lt;p&gt;　　使用锚点进行页面内跳转时，URL发生改变，页面刷新，其他浏览器没有问题。但是，ISO下的PWA桌面图标会跳转到safari浏览器中&lt;/p&gt;
&lt;p&gt;　　使用scrollIntoView()方法来替代锚点#，页面内只跳转不刷新。andriod下支持给scrollIntoView设置平滑滚动behavior: 'smooth'，但IOS不支持&lt;/p&gt;

</description>
<pubDate>Tue, 26 Jun 2018 14:08:00 +0000</pubDate>
<dc:creator>小火柴的蓝色理想</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/xiaohuochai/p/9228543.html</dc:identifier>
</item>
<item>
<title>[Docker] 写 Dockerfile 的最佳实践理论 - farwish</title>
<link>http://www.cnblogs.com/farwish/p/9231228.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/farwish/p/9231228.html</guid>
<description>&lt;div readability=&quot;8&quot;&gt;

&lt;div&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;指导方针&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;创建短暂的容器&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;　　意思是 container 可以停止和销毁，接着以最小化启动和配置进行重新构建和替换。&lt;/p&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;理解构建的上下文&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;　　使用 docker build ，当前工作环境称为 构建的上下文，默认 Dockerfile 是在同级目录找，可通过 -f 指定 Dockerfile。&lt;/p&gt;

&lt;p&gt;　　无论 Dockerfile 实际在哪里，当前目录的所有递归的文件和目录的内容被发送到 docker daemon 作为构建的上下文。&lt;/p&gt;

&lt;p&gt;　　（无意中包含的不必要文件会增加 image 大小，增加 build/pull/push 时间和 container 运行时大小）&lt;/p&gt;

&lt;p&gt;　　上下文内容支持本地 PATH 和远程 URL，docker build [OPTIONS] PATH | URL | -&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;17.05开始支持用 stdin 管道化 Dockerfile 的内容&lt;/strong&gt;&lt;/p&gt;

&lt;div readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
docker build -t foo:v1  .  -f-&amp;lt;&amp;lt;&amp;lt;&lt;span&gt;EOF
FROM ubuntu:&lt;/span&gt;&lt;span&gt;16.04&lt;/span&gt;&lt;span&gt;
RUN &lt;/span&gt;&lt;span&gt;echo&lt;/span&gt; &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;hello&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;
COPY  .  &lt;/span&gt;/copy-&lt;span&gt;files
EOF&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;strong&gt;使用 .dockerignore 排除内容进入构建上下文&lt;/strong&gt;&lt;/p&gt;



&lt;p&gt;&lt;strong&gt;使用多级构建&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;　　不需要努力去减少中间层数量和文件，从变化少的层到经常变化的层来排序（这样可以保证复用到构建历史缓存）&lt;/p&gt;

&lt;p&gt;　　不同层的顺序安排：安装工具 -&amp;gt; 安装库依赖 -&amp;gt; 生成应用&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;不安装不必要的包&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;解耦应用&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;　　每一个 container 应该只关心一件事。解耦应用到多个容器可以让水平扩展更容易和重复使用容器。比如 web 技术栈的分为 应用/数据库/缓存 三个不同的容器。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;最小化层的数量&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;　　在 17.05 及更高版本中，通过 multi-stage 多级构建减少了这个限制。&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;给多行参数排序&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;　　帮助避免包重复和更容易修改，更易读。&lt;/p&gt;

&lt;div readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;Run apt-get update &amp;amp;&amp;amp; apt-get install -y \
    bzr \
    cvs \
    git \
    mercurial&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;利用构建缓存&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;　　如果不想在构建中使用缓存的，给 docker build 命令加 --no-cache=true 选项。&lt;/p&gt;


&lt;div&gt;
&lt;ul&gt;&lt;li&gt;&lt;span&gt;Dockerfile 指令&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;









&lt;p&gt;               把 update 和 install 放在一行，保证 Dockerfile 安装最近的包版本，如下：&lt;/p&gt;

&lt;div readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;RUN&lt;/span&gt;&lt;span&gt; apt-get update &amp;amp;&amp;amp; apt-get install -y \
                        package-foo \
                        package-bar&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;    &lt;strong&gt;APT-GET&lt;/strong&gt; - 在 apt-get 应用中可能是最常使用的用于 RUN 的命令。因为它可以安装包，RUN apt-get 有几个陷阱需要提防。&lt;/p&gt;

&lt;p&gt;                       不要使用 RUN apt-get dist-upgrade 和 dist-upgrade。因为许多来自父级 image 的基础的包不能在没有权限的 container 中升级。&lt;/p&gt;

&lt;p&gt;                       如果父级 image 中的一个 package 过时了，联系它的维护者。&lt;/p&gt;

&lt;p&gt;                       如果你知道有一个特定的包 foo 需要升级，使用 apt-get install -y foo 来自动更新。&lt;/p&gt;

&lt;p&gt;                       总是把 RUN apt-get update 和 apt-get install 合并为一条 RUN 语句，确保无干涉的安装最新的包版本。&lt;/p&gt;

&lt;div readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;RUN&lt;/span&gt;&lt;span&gt; apt-get update &amp;amp;&amp;amp; apt-get install -y \
                                  package-foo \
                                  package-bar \
                                  package-baz=&lt;/span&gt;1.3&lt;span&gt;.*
                              &amp;amp;&amp;amp; rm -rf /var/lib/apt/lists&lt;/span&gt;/*          # 通过移除 apt cache 减小 image 尺寸
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;                      单独在一行 RUN 语句中使用 apt-get update 会引起缓存问题，随后的 apt-get install 指令失败，这叫做’ cache busting ’，同样可以通过指定包版本获取 cache-busting，这叫做版本固定，这可以避免由包变化而引起的意外失败。&lt;/p&gt;

&lt;p&gt;                      官方 debian 和 ubuntu 的 image 会自动运行 *apt-get clean*，所以明确调用不是必需的。&lt;/p&gt;


&lt;p&gt;    &lt;strong&gt;使用管道&lt;/strong&gt; - 如果想让管道连接的命令在任何阶段遇到错误时就失败，在命令前追加  set -o pipefail &amp;amp;&amp;amp;  来保证遇到未期的错误时阻止构建。&lt;/p&gt;

&lt;p&gt;                      例如：RUN set -o pipefail &amp;amp;&amp;amp; wget -O - https://some.site | wc -l &amp;gt; /number&lt;/p&gt;

&lt;p&gt;                      不是所有的 shell 都支持 -o pipefail , 基于 debian 的 image 需要指定 bash&lt;/p&gt;

&lt;p&gt;                      例如：RUN [ “/bin/bash”, “-c”, “set -o pipefail &amp;amp;&amp;amp; wget -O - https://some.site | wc -l &amp;gt; /number&quot; ]&lt;/p&gt;




&lt;p&gt;                格式形式为 CMD [&quot;command&quot;, &quot;param1&quot;, &quot;param2&quot;]，这个形式的指令推荐用在任何基于服务的 image。&lt;/p&gt;

&lt;p&gt;                在大多数其他案例中，CMD 应该给一个交互式的shell，比如 CMD [&quot;php&quot;, &quot;-a&quot;]，意味着执行 docker run -it php，你会有一个可用的shell。&lt;/p&gt;

&lt;p&gt;                CMD 很少以 CMD [&quot;param&quot;, &quot;param&quot;] 的方式与 ENTRYPOINT 协同，除非你和用户已经非常熟悉 ENTRYPOINT 是如何工作的。&lt;/p&gt;




&lt;p&gt;                      因此，应该使用常见传统的端口用于应用软件。例如 包含 Apache 的 image 将使用 EXPOSE 80，而包含 MongoDB 的 image 将使用 EXPOSE 27017 等等。&lt;/p&gt;

&lt;p&gt;                      用于外部访问，使用者可以执行 docker run 带上一个标记来标识映射指定端口到他们选择的端口。&lt;/p&gt;

&lt;p&gt;                      对于容器连接，Docker 为从接收容器返回到源的路径提供环境变量。（如，MYSQL_PORT_3306_TCP）&lt;/p&gt;




&lt;p&gt;               例如：ENV PATH /usr/local/nginx/bin:$PATH 保证 CMD [&quot;nginx&quot;] 能运行。&lt;/p&gt;

&lt;p&gt;               ENV 指令 在 为你希望容器化的服务提供所需的环境变量 上同样有用，例如 Postgres 的 PGDATA。&lt;/p&gt;

&lt;p&gt;               每个 ENV 行创建一个新的中间层，就像 RUN 命令。这意味着即使在之后的层 unset 这个环境变量，它仍然存在于这个层，并且它的值可以被打印。测试如下：&lt;/p&gt;
&lt;div readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;FROM&lt;/span&gt;&lt;span&gt; alpine
&lt;/span&gt;&lt;span&gt;ENV&lt;/span&gt; ADMIN_USER=&quot;mark&quot;
&lt;span&gt;RUN&lt;/span&gt;&lt;span&gt; echo $ADMIN_USER &amp;gt; ./mark
&lt;/span&gt;&lt;span&gt;RUN&lt;/span&gt;&lt;span&gt; unset ADMIN_USER
&lt;/span&gt;&lt;span&gt;CMD&lt;/span&gt;&lt;span&gt; sh
$ docker run --rm -it test sh echo $ADMIN_USER&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;                要阻止这种情况，真正 unset 环境变量，使用 RUN 指令运行 shell 命令，在一个独立的层中 set, use, unset 变量。&lt;/p&gt;

&lt;p&gt;                使用 ; 或 &amp;amp;&amp;amp; 来分割命令，使用 &amp;amp;&amp;amp; 只要一个命令失败，docker build 也失败。&lt;/p&gt;
&lt;div readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;FROM&lt;/span&gt;&lt;span&gt; alpine
&lt;/span&gt;&lt;span&gt;ENV&lt;/span&gt; export ADMIN_USER=&quot;mark&quot;&lt;span&gt; \
       &amp;amp;&amp;amp; echo $ADMIN_USER &amp;gt; ./mark \
       &amp;amp;&amp;amp; unset ADMIN_USER
&lt;/span&gt;&lt;span&gt;CMD&lt;/span&gt;&lt;span&gt; sh

$ docker run --rm -it test sh echo $ADMIN_USER&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;/div&gt;


&lt;p&gt;                              因为 COPY 比 ADD 更易懂。COPY 只支持从本地文件到 container 的基本拷贝，而 ADD 有一些不明显的特性（如，本地 tar包 自动解压和支持远程 URL）&lt;/p&gt;

&lt;p&gt;                              因此 ADD 的最佳使用是本地 tar 文件在 image 中的自动解压，如，ADD rootfs.tar.xz / .&lt;/p&gt;

&lt;p&gt;                              如果 Dockerfile 有多个步骤使用了上下文中的不同文件，单独的拷贝它们，而不是一次拷贝所有。这确保每一步的构建缓存在文件发生改变时是失效的，如：                           &lt;/p&gt;
&lt;div readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;COPY&lt;/span&gt;&lt;span&gt; requirements.txt /tmp
&lt;/span&gt;&lt;span&gt;RUN&lt;/span&gt;&lt;span&gt; pip install --requirement /tmp/requirements.txt
&lt;/span&gt;&lt;span&gt;COPY&lt;/span&gt; . /tmp/
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;                              要让 RUN 步骤导致更少的缓存失效，那么把 COPY . /tmp/ 放到其前面。&lt;/p&gt;

&lt;p&gt;                              因为 image 大小问题，使用 ADD 从远程地址拉取包是极不鼓励的；你应该使用 curl 或 wget 代替。这种方式你可以在解压后把不需要的文件删除，不需要把其它层加到你的 image 中。&lt;/p&gt;

&lt;p&gt;                              避免做的是：&lt;/p&gt;
&lt;div readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;ADD&lt;/span&gt; http://example.com/big.tar.xz /usr/src/things/
&lt;span&gt;RUN&lt;/span&gt;&lt;span&gt; tar -zJf /usr/src/things/big.tar.xz -C /usr/src/things
&lt;/span&gt;&lt;span&gt;RUN&lt;/span&gt; make -C /usr/src/things all
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;                              代替的做法是：&lt;/p&gt;
&lt;div readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
&lt;span&gt;RUN&lt;/span&gt;&lt;span&gt; mkdir -p /usr/src/things \
      &amp;amp;&amp;amp; curl -SL http:&lt;/span&gt;//example.com/big.tar.xz \
&lt;span&gt;       |  tar -xJC /usr/src/things \
      &amp;amp;&amp;amp; make -C /usr/src/things all&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;                              对于不需要 ADD 自动解压能力的文件和目录，你应该总是使用 COPY。&lt;/p&gt;



&lt;div readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;ENTRYPOINT&lt;/span&gt; [&quot;s3cmd&quot;&lt;span&gt;]
&lt;/span&gt;&lt;span&gt;CMD&lt;/span&gt; [&quot;--help&quot;]
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;                             现在 image 可以像这样显示命令的帮助信息：$ docker run s3cmd&lt;/p&gt;

&lt;p&gt;                             或者使用正确的参数来执行一个命令：$ docker run s3cmd ls s3://mybucket&lt;/p&gt;

&lt;p&gt;                             这是有用的，因为 image 名称可以两次作为到如上命令二进制的引用。&lt;/p&gt;

&lt;p&gt;                             ENTRYPOINT 指令同样可以用来和一个帮助脚本结合，允许它做和命令方式一样的事，尽管需要多进行一步 - 写脚本，以下是 Postgres 官方 image 的 ENTRYPOINT 使用的脚本：&lt;/p&gt;
&lt;div readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
#!/bin/&lt;span&gt;bash
set &lt;/span&gt;-&lt;span&gt;e
&lt;/span&gt;&lt;span&gt;if&lt;/span&gt; [ &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$1&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; = &lt;span&gt;'&lt;/span&gt;&lt;span&gt;postgres&lt;/span&gt;&lt;span&gt;'&lt;/span&gt; ]; &lt;span&gt;then&lt;/span&gt;
  &lt;span&gt;chown&lt;/span&gt; -R postgres &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$PGDATA&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
  &lt;span&gt;if&lt;/span&gt; [ -z &lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$(ls -A &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;$PGDATA&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;)&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt; ]; &lt;span&gt;then&lt;/span&gt;&lt;span&gt;
    gosu postgres initdb
  &lt;/span&gt;&lt;span&gt;fi&lt;/span&gt;
&lt;span&gt;fi&lt;/span&gt;&lt;span&gt;
exec &lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;&lt;span&gt;$@&lt;/span&gt;&lt;span&gt;&quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;                             把帮助脚本拷贝到 container 中，并在 container 启动时通过 ENTRYPOINT 运行：          &lt;/p&gt;
&lt;div readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;COPY&lt;/span&gt;&lt;span&gt; ./docker-entrypoint.sh /
&lt;/span&gt;&lt;span&gt;ENTRYPOINT&lt;/span&gt; [&quot;/docker-entrypoint.sh&quot;&lt;span&gt;]
&lt;/span&gt;&lt;span&gt;CMD&lt;/span&gt; [&quot;postgres&quot;]
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;p&gt;                             帮助脚本允许命令有多个参数可以交互，比如：&lt;/p&gt;
&lt;div readability=&quot;6&quot;&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;32&quot;&gt;
&lt;pre&gt;
&lt;span&gt;$ docker run postgres
$ docker run postgres postgres &lt;/span&gt;--&lt;span&gt;help
$ docker run &lt;/span&gt;--&lt;span&gt;rm&lt;/span&gt; -it postgres bash
&lt;/pre&gt;&lt;/div&gt;

&lt;/div&gt;


&lt;p&gt;                       强烈建议你使用 VOLUMN 在 image 中易变的或用户维护的部分。&lt;/p&gt;




&lt;p&gt;                 通过在 Dockerfile 中创建用户和组开始开始：RUN groupadd -r postgres &amp;amp;&amp;amp; useradd --no-log-init -r -g postgres postgres&lt;/p&gt;

&lt;p&gt;                 image 中的用户和组被分配一个非确定的 UID/GID，下次 image 重建时重新分配。所以如果 UID/GID 至关重要，你应该分配一个准确的。&lt;/p&gt;

&lt;p&gt;                （由于Go archive/tar 包中未解决的bug，在docker 容器中创建相当长的UID会耗尽磁盘，因为容器层中的 /var/log/faillog 填充了NULL字符，权宜措施是传递 --no-log-init 给 useradd）&lt;/p&gt;

&lt;div readability=&quot;6.9189189189189&quot;&gt;                 避免使用 sudo，如果你确实需要像 sudo 一样的功能，例如像 root 一样初始化守护进程但以非 root 用户运行，考虑使用 gosu。&lt;a href=&quot;https://github.com/tianon/gosu&quot;&gt;https://github.com/tianon/gosu&lt;/a&gt;&lt;/div&gt;

&lt;p&gt;                 为了减少层次和复杂性，避免频繁的切换用户。&lt;/p&gt;




&lt;p&gt;                         同样，你应该使用 WORKDIR 而不是 RUN cd ... &amp;amp;&amp;amp; do-something ，更难度阅读、排除问题和维护。&lt;/p&gt;




&lt;p&gt;                        ONBUILD 在当前 FROM image 派生的任何子 image 中执行。可以认为 ONBUILD 命令是父 Dockerfile 给子 Dockerfile 的指令。&lt;/p&gt;

&lt;p&gt;                        Docker 构建在任何子 Dockerfile 中的命令前执行 ONBUILD。&lt;/p&gt;

&lt;p&gt;                        ONBUILD 对于从给定的 image 构建 image 时有用。例如，你想为一个语言栈的 包含该语言写的任意用户软件到 Dockerfile 中的 image 使用 ONBUILD。&lt;/p&gt;

&lt;p&gt;                        从 ONBUILD 构建的 image 应该有一个分割 tag，例如，ruby:1.9-onbuild 或 ruby-2.0-onbuild&lt;/p&gt;

&lt;p&gt;                        当把 ADD 或 COPY 放到 ONBUILD 时要小心。如果新构建的上下文缺少被添加的资源，onbuild 构建 image 会灾难性失败。通过如上添加分割的 tag 来减轻这种影响。&lt;/p&gt;




</description>
<pubDate>Tue, 26 Jun 2018 13:15:00 +0000</pubDate>
<dc:creator>farwish</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/farwish/p/9231228.html</dc:identifier>
</item>
<item>
<title>仿9GAG制作过程（五） - 懒星人</title>
<link>http://www.cnblogs.com/lanxingren/p/9231243.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/lanxingren/p/9231243.html</guid>
<description>&lt;h2&gt;有话要说：&lt;/h2&gt;
&lt;p&gt;在做完了数据展示功能之后，就想着完善整个APP。发现现在后台非常的混乱，有好多点都不具备，比方说：图片应该有略缩图和原图，段子、评论、点赞应该联动起来，段子应该有创建时间等。&lt;/p&gt;
&lt;p&gt;于是就重新设计了数据库，重新爬取了数据，重新设计了后台接口。&lt;/p&gt;
&lt;p&gt;这次主要讲这次重构的主要内容。&lt;/p&gt;
&lt;h2&gt;数据库设计：&lt;/h2&gt;
&lt;p&gt; &lt;img src=&quot;https://images2018.cnblogs.com/blog/1410837/201806/1410837-20180626203400820-616467289.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;一共设计了六张表，分别为&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;段子表，主要存放每一个段子的图片等信息&lt;/li&gt;
&lt;li&gt;评论表，主要存放评论信息，评论可以上传图片&lt;/li&gt;
&lt;li&gt;用户表&lt;/li&gt;
&lt;li&gt;标签表，每条段子发表之前会自定义标签，该表存放的就是这些标签&lt;/li&gt;
&lt;li&gt;点赞记录表，因为用户点赞与段子之间是多对多的关系，因此要加一张表用来存放点赞记录&lt;/li&gt;
&lt;li&gt;段子标签关联表，因为段子和标签是多对多的，因此需要多一张表存放关联关系&lt;/li&gt;
&lt;/ol&gt;&lt;h2&gt;接口设计：&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1410837/201806/1410837-20180626204107484-1839010145.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;橙色的为表，咖啡色为接口。&lt;/p&gt;
&lt;p&gt;目前设计了十四个接口，上图写明了各接口和相关的表之间的关系。&lt;/p&gt;
&lt;h2&gt;后台结构：&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1410837/201806/1410837-20180626204420371-395058690.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;bean包下为基本实体类；&lt;/p&gt;
&lt;p&gt;implement包下为消息实体类的子类；&lt;/p&gt;
&lt;p&gt;dao包为涉及到数据库的具体实现类；&lt;/p&gt;
&lt;p&gt;servlet为接口类；&lt;/p&gt;
&lt;p&gt;util为过程中用到的工具类。&lt;/p&gt;
&lt;h2&gt;具体例子：&lt;/h2&gt;
&lt;p&gt;下面以查询段子接口为例，介绍具体的结构。&lt;/p&gt;
&lt;h3&gt;bean类：&lt;/h3&gt;
&lt;h4&gt;消息实体类：&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; MessageEntity {
&lt;/span&gt;&lt;span&gt; 2&lt;/span&gt; 
&lt;span&gt; 3&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 返回信息描述&lt;/span&gt;
&lt;span&gt; 4&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt;&lt;span&gt; String reason;
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 返回码&lt;/span&gt;
&lt;span&gt; 6&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; errorCode;
&lt;/span&gt;&lt;span&gt; 7&lt;/span&gt; 
&lt;span&gt; 8&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt;&lt;span&gt; String getReason() {
&lt;/span&gt;&lt;span&gt; 9&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; reason;
&lt;/span&gt;&lt;span&gt;10&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;11&lt;/span&gt; 
&lt;span&gt;12&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; setReason(String reason) {
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.reason =&lt;span&gt; reason;
&lt;/span&gt;&lt;span&gt;14&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;15&lt;/span&gt; 
&lt;span&gt;16&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; getErrorCode() {
&lt;/span&gt;&lt;span&gt;17&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; errorCode;
&lt;/span&gt;&lt;span&gt;18&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;19&lt;/span&gt; 
&lt;span&gt;20&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setErrorCode(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; errorCode) {
&lt;/span&gt;&lt;span&gt;21&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.errorCode =&lt;span&gt; errorCode;
&lt;/span&gt;&lt;span&gt;22&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;23&lt;/span&gt; 
&lt;span&gt;24&lt;/span&gt; }
&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt;段子消息实体类：&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; TopicMessageEntity &lt;span&gt;extends&lt;/span&gt;&lt;span&gt; MessageEntity {
&lt;/span&gt;&lt;span&gt; 2&lt;/span&gt; 
&lt;span&gt; 3&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 获取段子的结果&lt;/span&gt;
&lt;span&gt; 4&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; List&amp;lt;TopicEntity&amp;gt;&lt;span&gt; result;
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt; 
&lt;span&gt; 6&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; List&amp;lt;TopicEntity&amp;gt;&lt;span&gt; getResult() {
&lt;/span&gt;&lt;span&gt; 7&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; result;
&lt;/span&gt;&lt;span&gt; 8&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt; 9&lt;/span&gt; 
&lt;span&gt;10&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setResult(List&amp;lt;TopicEntity&amp;gt;&lt;span&gt; result) {
&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.result =&lt;span&gt; result;
&lt;/span&gt;&lt;span&gt;12&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt; 
&lt;span&gt;14&lt;/span&gt; }
&lt;/pre&gt;&lt;/div&gt;

&lt;h4&gt; 段子实体类：&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; TopicEntity {
&lt;/span&gt;&lt;span&gt; 2&lt;/span&gt; 
&lt;span&gt; 3&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子标识&lt;/span&gt;
&lt;span&gt; 4&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; id;
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子作者&lt;/span&gt;
&lt;span&gt; 6&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; String author = &quot;&quot;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 7&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子标题&lt;/span&gt;
&lt;span&gt; 8&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; String title = &quot;&quot;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 9&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子点赞数&lt;/span&gt;
&lt;span&gt;10&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; upvote;
&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子评论数&lt;/span&gt;
&lt;span&gt;12&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; commentCount;
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子略缩图地址&lt;/span&gt;
&lt;span&gt;14&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; String thumbNail = &quot;&quot;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt;15&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子原图地址&lt;/span&gt;
&lt;span&gt;16&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; String orgPicture = &quot;&quot;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt;17&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 段子发表时间&lt;/span&gt;
&lt;span&gt;18&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; String postTime = &quot;&quot;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt;19&lt;/span&gt;     
&lt;span&gt;20&lt;/span&gt;     &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 点的是赞还是踩,0代表没点，1代表赞，-1代表踩&lt;/span&gt;
&lt;span&gt;21&lt;/span&gt;     &lt;span&gt;private&lt;/span&gt; &lt;span&gt;int&lt;/span&gt; like = 0&lt;span&gt;;
&lt;/span&gt;&lt;span&gt;22&lt;/span&gt; 
&lt;span&gt;23&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; getId() {
&lt;/span&gt;&lt;span&gt;24&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; id;
&lt;/span&gt;&lt;span&gt;25&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;26&lt;/span&gt; 
&lt;span&gt;27&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setId(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; id) {
&lt;/span&gt;&lt;span&gt;28&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.id =&lt;span&gt; id;
&lt;/span&gt;&lt;span&gt;29&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;30&lt;/span&gt; 
&lt;span&gt;31&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt;&lt;span&gt; String getAuthor() {
&lt;/span&gt;&lt;span&gt;32&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; author;
&lt;/span&gt;&lt;span&gt;33&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;34&lt;/span&gt; 
&lt;span&gt;35&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; setAuthor(String author) {
&lt;/span&gt;&lt;span&gt;36&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.author =&lt;span&gt; author;
&lt;/span&gt;&lt;span&gt;37&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;38&lt;/span&gt; 
&lt;span&gt;39&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt;&lt;span&gt; String getTitle() {
&lt;/span&gt;&lt;span&gt;40&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; title;
&lt;/span&gt;&lt;span&gt;41&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;42&lt;/span&gt; 
&lt;span&gt;43&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; setTitle(String title) {
&lt;/span&gt;&lt;span&gt;44&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.title =&lt;span&gt; title;
&lt;/span&gt;&lt;span&gt;45&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;46&lt;/span&gt; 
&lt;span&gt;47&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; getUpvote() {
&lt;/span&gt;&lt;span&gt;48&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; upvote;
&lt;/span&gt;&lt;span&gt;49&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;50&lt;/span&gt; 
&lt;span&gt;51&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setUpvote(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; upvote) {
&lt;/span&gt;&lt;span&gt;52&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.upvote =&lt;span&gt; upvote;
&lt;/span&gt;&lt;span&gt;53&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;54&lt;/span&gt; 
&lt;span&gt;55&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; getCommentCount() {
&lt;/span&gt;&lt;span&gt;56&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; commentCount;
&lt;/span&gt;&lt;span&gt;57&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;58&lt;/span&gt; 
&lt;span&gt;59&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setCommentCount(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; commentCount) {
&lt;/span&gt;&lt;span&gt;60&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.commentCount =&lt;span&gt; commentCount;
&lt;/span&gt;&lt;span&gt;61&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;62&lt;/span&gt; 
&lt;span&gt;63&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt;&lt;span&gt; String getThumbNail() {
&lt;/span&gt;&lt;span&gt;64&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; thumbNail;
&lt;/span&gt;&lt;span&gt;65&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;66&lt;/span&gt; 
&lt;span&gt;67&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; setThumbNail(String thumbNail) {
&lt;/span&gt;&lt;span&gt;68&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.thumbNail =&lt;span&gt; thumbNail;
&lt;/span&gt;&lt;span&gt;69&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;70&lt;/span&gt; 
&lt;span&gt;71&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt;&lt;span&gt; String getOrgPicture() {
&lt;/span&gt;&lt;span&gt;72&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; orgPicture;
&lt;/span&gt;&lt;span&gt;73&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;74&lt;/span&gt; 
&lt;span&gt;75&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; setOrgPicture(String orgPicture) {
&lt;/span&gt;&lt;span&gt;76&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.orgPicture =&lt;span&gt; orgPicture;
&lt;/span&gt;&lt;span&gt;77&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;78&lt;/span&gt; 
&lt;span&gt;79&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt;&lt;span&gt; String getPostTime() {
&lt;/span&gt;&lt;span&gt;80&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; postTime;
&lt;/span&gt;&lt;span&gt;81&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;82&lt;/span&gt; 
&lt;span&gt;83&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; setPostTime(String postTime) {
&lt;/span&gt;&lt;span&gt;84&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.postTime =&lt;span&gt; postTime;
&lt;/span&gt;&lt;span&gt;85&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;86&lt;/span&gt; 
&lt;span&gt;87&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; getLike() {
&lt;/span&gt;&lt;span&gt;88&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; like;
&lt;/span&gt;&lt;span&gt;89&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;90&lt;/span&gt; 
&lt;span&gt;91&lt;/span&gt;     &lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setLike(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; like) {
&lt;/span&gt;&lt;span&gt;92&lt;/span&gt;         &lt;span&gt;this&lt;/span&gt;.like =&lt;span&gt; like;
&lt;/span&gt;&lt;span&gt;93&lt;/span&gt; &lt;span&gt;    }
&lt;/span&gt;&lt;span&gt;94&lt;/span&gt; 
&lt;span&gt;95&lt;/span&gt; }
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;这里和数据库表略有不同，主要是like字段。&lt;/p&gt;
&lt;p&gt;like字段代表的是当前获取数据的人对该段子是否点了赞。&lt;/p&gt;
&lt;h3&gt;dao层：&lt;/h3&gt;
&lt;h4&gt;查询段子方法：&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;public&lt;/span&gt; List&amp;lt;TopicEntity&amp;gt; query(&lt;span&gt;int&lt;/span&gt; topicId, &lt;span&gt;int&lt;/span&gt; count, &lt;span&gt;boolean&lt;/span&gt;&lt;span&gt; after) {
&lt;/span&gt;&lt;span&gt; 2&lt;/span&gt;         List&amp;lt;TopicEntity&amp;gt; topicList = &lt;span&gt;new&lt;/span&gt; ArrayList&amp;lt;TopicEntity&amp;gt;&lt;span&gt;();
&lt;/span&gt;&lt;span&gt; 3&lt;/span&gt; 
&lt;span&gt; 4&lt;/span&gt;         &lt;span&gt;if&lt;/span&gt; (topicId &amp;lt;= 0&lt;span&gt;) {
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt;             topicId = 0&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 6&lt;/span&gt; &lt;span&gt;        }
&lt;/span&gt;&lt;span&gt; 7&lt;/span&gt; 
&lt;span&gt; 8&lt;/span&gt;         &lt;span&gt;if&lt;/span&gt; (count &amp;lt;= 0&lt;span&gt;) {
&lt;/span&gt;&lt;span&gt; 9&lt;/span&gt;             count = 10&lt;span&gt;;
&lt;/span&gt;&lt;span&gt;10&lt;/span&gt; &lt;span&gt;        }
&lt;/span&gt;&lt;span&gt;11&lt;/span&gt; 
&lt;span&gt;12&lt;/span&gt;         &lt;span&gt;if&lt;/span&gt;&lt;span&gt; (after) {
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt; &lt;span&gt;            queryAfter(topicId, count, topicList);
&lt;/span&gt;&lt;span&gt;14&lt;/span&gt;         } &lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
&lt;/span&gt;&lt;span&gt;15&lt;/span&gt; &lt;span&gt;            queryBefore(topicId, count, topicList);
&lt;/span&gt;&lt;span&gt;16&lt;/span&gt; &lt;span&gt;        }
&lt;/span&gt;&lt;span&gt;17&lt;/span&gt; 
&lt;span&gt;18&lt;/span&gt;         &lt;span&gt;return&lt;/span&gt;&lt;span&gt; topicList;
&lt;/span&gt;&lt;span&gt;19&lt;/span&gt;     }
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;private&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; queryAfter(&lt;span&gt;int&lt;/span&gt; topicId, &lt;span&gt;int&lt;/span&gt; count, List&amp;lt;TopicEntity&amp;gt;&lt;span&gt; topicList) {
&lt;/span&gt;&lt;span&gt; 2&lt;/span&gt;         String queryAfter = &quot;SELECT * FROM 9gag_topics WHERE id &amp;gt; ? LIMIT ?&quot;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 3&lt;/span&gt; 
&lt;span&gt; 4&lt;/span&gt;         Connection conn =&lt;span&gt; DatabaseUtil.getConnection();
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt;         PreparedStatement pstmt = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 6&lt;/span&gt;         ResultSet rs = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 7&lt;/span&gt; 
&lt;span&gt; 8&lt;/span&gt;         &lt;span&gt;try&lt;/span&gt;&lt;span&gt; {
&lt;/span&gt;&lt;span&gt; 9&lt;/span&gt;             pstmt =&lt;span&gt; conn.prepareStatement(queryAfter);
&lt;/span&gt;&lt;span&gt;10&lt;/span&gt;             pstmt.setInt(1&lt;span&gt;, topicId);
&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;             pstmt.setInt(2&lt;span&gt;, count);
&lt;/span&gt;&lt;span&gt;12&lt;/span&gt;             rs =&lt;span&gt; pstmt.executeQuery();
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt; 
&lt;span&gt;14&lt;/span&gt;             &lt;span&gt;while&lt;/span&gt;&lt;span&gt; (rs.next()) {
&lt;/span&gt;&lt;span&gt;15&lt;/span&gt;                 TopicEntity topicEntity = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; TopicEntity();
&lt;/span&gt;&lt;span&gt;16&lt;/span&gt;                 topicEntity.setId(rs.getInt(&quot;id&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;17&lt;/span&gt;                 topicEntity.setAuthor(rs.getString(&quot;author&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;18&lt;/span&gt;                 topicEntity.setTitle(rs.getString(&quot;title&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;19&lt;/span&gt;                 topicEntity.setUpvote(rs.getInt(&quot;upvote&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;20&lt;/span&gt;                 topicEntity.setCommentCount(rs.getInt(&quot;commentcount&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;21&lt;/span&gt;                 topicEntity.setThumbNail(rs.getString(&quot;thumbnail&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;22&lt;/span&gt;                 topicEntity.setOrgPicture(rs.getString(&quot;orgpicture&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;23&lt;/span&gt;                 topicEntity.setPostTime(rs.getString(&quot;posttime&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;24&lt;/span&gt; &lt;span&gt;                topicList.add(topicEntity);
&lt;/span&gt;&lt;span&gt;25&lt;/span&gt; &lt;span&gt;            }
&lt;/span&gt;&lt;span&gt;26&lt;/span&gt;         } &lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (SQLException e) {
&lt;/span&gt;&lt;span&gt;27&lt;/span&gt; &lt;span&gt;            e.printStackTrace();
&lt;/span&gt;&lt;span&gt;28&lt;/span&gt;         } &lt;span&gt;finally&lt;/span&gt;&lt;span&gt; {
&lt;/span&gt;&lt;span&gt;29&lt;/span&gt; &lt;span&gt;            DatabaseUtil.close(conn, pstmt, rs);
&lt;/span&gt;&lt;span&gt;30&lt;/span&gt; &lt;span&gt;        }
&lt;/span&gt;&lt;span&gt;31&lt;/span&gt;     }
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;41&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;private&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; queryBefore(&lt;span&gt;int&lt;/span&gt; topicId, &lt;span&gt;int&lt;/span&gt; count, List&amp;lt;TopicEntity&amp;gt;&lt;span&gt; topicList) {
&lt;/span&gt;&lt;span&gt; 2&lt;/span&gt;         String queryBefore = &quot;SELECT * FROM 9gag_topics WHERE id &amp;lt; ? ORDER BY id DESC LIMIT ?&quot;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 3&lt;/span&gt; 
&lt;span&gt; 4&lt;/span&gt;         Connection conn =&lt;span&gt; DatabaseUtil.getConnection();
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt;         PreparedStatement pstmt = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 6&lt;/span&gt;         ResultSet rs = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt; 7&lt;/span&gt; 
&lt;span&gt; 8&lt;/span&gt;         &lt;span&gt;try&lt;/span&gt;&lt;span&gt; {
&lt;/span&gt;&lt;span&gt; 9&lt;/span&gt;             pstmt =&lt;span&gt; conn.prepareStatement(queryBefore);
&lt;/span&gt;&lt;span&gt;10&lt;/span&gt;             pstmt.setInt(1&lt;span&gt;, topicId);
&lt;/span&gt;&lt;span&gt;11&lt;/span&gt;             pstmt.setInt(2&lt;span&gt;, count);
&lt;/span&gt;&lt;span&gt;12&lt;/span&gt;             rs =&lt;span&gt; pstmt.executeQuery();
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt; 
&lt;span&gt;14&lt;/span&gt;             &lt;span&gt;while&lt;/span&gt;&lt;span&gt; (rs.next()) {
&lt;/span&gt;&lt;span&gt;15&lt;/span&gt;                 TopicEntity topicEntity = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; TopicEntity();
&lt;/span&gt;&lt;span&gt;16&lt;/span&gt;                 topicEntity.setId(rs.getInt(&quot;id&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;17&lt;/span&gt;                 topicEntity.setAuthor(rs.getString(&quot;author&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;18&lt;/span&gt;                 topicEntity.setTitle(rs.getString(&quot;title&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;19&lt;/span&gt;                 topicEntity.setUpvote(rs.getInt(&quot;upvote&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;20&lt;/span&gt;                 topicEntity.setCommentCount(rs.getInt(&quot;commentcount&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;21&lt;/span&gt;                 topicEntity.setThumbNail(rs.getString(&quot;thumbnail&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;22&lt;/span&gt;                 topicEntity.setOrgPicture(rs.getString(&quot;orgpicture&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;23&lt;/span&gt;                 topicEntity.setPostTime(rs.getString(&quot;posttime&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;24&lt;/span&gt; &lt;span&gt;                topicList.add(topicEntity);
&lt;/span&gt;&lt;span&gt;25&lt;/span&gt; &lt;span&gt;            }
&lt;/span&gt;&lt;span&gt;26&lt;/span&gt;         } &lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (SQLException e) {
&lt;/span&gt;&lt;span&gt;27&lt;/span&gt; &lt;span&gt;            e.printStackTrace();
&lt;/span&gt;&lt;span&gt;28&lt;/span&gt;         } &lt;span&gt;finally&lt;/span&gt;&lt;span&gt; {
&lt;/span&gt;&lt;span&gt;29&lt;/span&gt; &lt;span&gt;            DatabaseUtil.close(conn, pstmt, rs);
&lt;/span&gt;&lt;span&gt;30&lt;/span&gt; &lt;span&gt;        }
&lt;/span&gt;&lt;span&gt;31&lt;/span&gt; 
&lt;span&gt;32&lt;/span&gt;         &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 获取完数据之后逆序，因为查找的时候是逆序&lt;/span&gt;
&lt;span&gt;33&lt;/span&gt; &lt;span&gt;        Collections.reverse(topicList);
&lt;/span&gt;&lt;span&gt;34&lt;/span&gt;     }
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;这三个方法实现了查询指定段子前（或者后）count条记录。&lt;/p&gt;
&lt;h3&gt; servlet层：&lt;/h3&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;40&quot;&gt;
&lt;pre&gt;
&lt;span&gt; 1&lt;/span&gt; &lt;span&gt;protected&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; doPost(HttpServletRequest request, HttpServletResponse response)
&lt;/span&gt;&lt;span&gt; 2&lt;/span&gt;             &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; ServletException, IOException {
&lt;/span&gt;&lt;span&gt; 3&lt;/span&gt;         response.setContentType(&quot;text/json; charset=utf-8&quot;&lt;span&gt;);
&lt;/span&gt;&lt;span&gt; 4&lt;/span&gt;         PrintWriter out =&lt;span&gt; response.getWriter();
&lt;/span&gt;&lt;span&gt; 5&lt;/span&gt; 
&lt;span&gt; 6&lt;/span&gt;         TopicMessageEntity message = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; TopicMessageEntity();
&lt;/span&gt;&lt;span&gt; 7&lt;/span&gt;         TopicDAO topicDao = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; TopicDAO();
&lt;/span&gt;&lt;span&gt; 8&lt;/span&gt;         UpvoteDAO upvoteDao = &lt;span&gt;new&lt;/span&gt;&lt;span&gt; UpvoteDAO();
&lt;/span&gt;&lt;span&gt; 9&lt;/span&gt;         Gson gson =&lt;span&gt; GsonUtil.getGson();
&lt;/span&gt;&lt;span&gt;10&lt;/span&gt; 
&lt;span&gt;11&lt;/span&gt;         request.setCharacterEncoding(&quot;utf-8&quot;&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;12&lt;/span&gt;         response.setCharacterEncoding(&quot;utf-8&quot;&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;13&lt;/span&gt; 
&lt;span&gt;14&lt;/span&gt;         &lt;span&gt;int&lt;/span&gt; topicId = Integer.parseInt(request.getParameter(&quot;topicId&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;15&lt;/span&gt;         &lt;span&gt;int&lt;/span&gt; count = Integer.parseInt(request.getParameter(&quot;count&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;16&lt;/span&gt;         &lt;span&gt;boolean&lt;/span&gt; after = Boolean.parseBoolean(request.getParameter(&quot;after&quot;&lt;span&gt;));
&lt;/span&gt;&lt;span&gt;17&lt;/span&gt;         String author = request.getParameter(&quot;author&quot;&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;18&lt;/span&gt; 
&lt;span&gt;19&lt;/span&gt;         &lt;span&gt;if&lt;/span&gt; (count &amp;lt;= 0&lt;span&gt;) {
&lt;/span&gt;&lt;span&gt;20&lt;/span&gt;             message.setErrorCode(-1&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;21&lt;/span&gt;             message.setReason(&quot;count值不能为负数！&quot;&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;22&lt;/span&gt; &lt;span&gt;            out.print(gson.toJson(message));
&lt;/span&gt;&lt;span&gt;23&lt;/span&gt;             &lt;span&gt;return&lt;/span&gt;&lt;span&gt;;
&lt;/span&gt;&lt;span&gt;24&lt;/span&gt; &lt;span&gt;        }
&lt;/span&gt;&lt;span&gt;25&lt;/span&gt; 
&lt;span&gt;26&lt;/span&gt;         &lt;span&gt;try&lt;/span&gt;&lt;span&gt; {
&lt;/span&gt;&lt;span&gt;27&lt;/span&gt;             List&amp;lt;TopicEntity&amp;gt; topics =&lt;span&gt; topicDao.query(topicId, count, after);
&lt;/span&gt;&lt;span&gt;28&lt;/span&gt;             
&lt;span&gt;29&lt;/span&gt;             &lt;span&gt;//&lt;/span&gt;&lt;span&gt; 判断作者是否点过赞&lt;/span&gt;
&lt;span&gt;30&lt;/span&gt;             &lt;span&gt;if&lt;/span&gt; (author != &lt;span&gt;null&lt;/span&gt;&lt;span&gt;) {
&lt;/span&gt;&lt;span&gt;31&lt;/span&gt;                 List&amp;lt;UpvoteEntity&amp;gt; upvoteList = upvoteDao.findUpvoteByAuthor(author, &lt;span&gt;true&lt;/span&gt;&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;32&lt;/span&gt;                 &lt;span&gt;if&lt;/span&gt; (upvoteList != &lt;span&gt;null&lt;/span&gt;&lt;span&gt;) {
&lt;/span&gt;&lt;span&gt;33&lt;/span&gt;                     &lt;span&gt;for&lt;/span&gt;&lt;span&gt; (TopicEntity topic : topics) {
&lt;/span&gt;&lt;span&gt;34&lt;/span&gt;                         &lt;span&gt;for&lt;/span&gt;&lt;span&gt; (UpvoteEntity upvote : upvoteList) {
&lt;/span&gt;&lt;span&gt;35&lt;/span&gt;                             &lt;span&gt;if&lt;/span&gt; (upvote.getLikedId() ==&lt;span&gt; topic.getId()) {
&lt;/span&gt;&lt;span&gt;36&lt;/span&gt;                                 &lt;span&gt;int&lt;/span&gt; like = upvote.isLiked() ? 1 : -1&lt;span&gt;;
&lt;/span&gt;&lt;span&gt;37&lt;/span&gt; &lt;span&gt;                                topic.setLike(like);
&lt;/span&gt;&lt;span&gt;38&lt;/span&gt; &lt;span&gt;                            }
&lt;/span&gt;&lt;span&gt;39&lt;/span&gt; &lt;span&gt;                        }
&lt;/span&gt;&lt;span&gt;40&lt;/span&gt; &lt;span&gt;                    }                    
&lt;/span&gt;&lt;span&gt;41&lt;/span&gt; &lt;span&gt;                }
&lt;/span&gt;&lt;span&gt;42&lt;/span&gt; &lt;span&gt;            }
&lt;/span&gt;&lt;span&gt;43&lt;/span&gt;             
&lt;span&gt;44&lt;/span&gt; &lt;span&gt;            Collections.reverse(topics);
&lt;/span&gt;&lt;span&gt;45&lt;/span&gt;             message.setErrorCode(0&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;46&lt;/span&gt;             message.setReason(&quot;success&quot;&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;47&lt;/span&gt; &lt;span&gt;            message.setResult(topics);
&lt;/span&gt;&lt;span&gt;48&lt;/span&gt;         } &lt;span&gt;catch&lt;/span&gt;&lt;span&gt; (Exception e) {
&lt;/span&gt;&lt;span&gt;49&lt;/span&gt;             message.setErrorCode(-1&lt;span&gt;);
&lt;/span&gt;&lt;span&gt;50&lt;/span&gt; &lt;span&gt;            message.setReason(e.getMessage());
&lt;/span&gt;&lt;span&gt;51&lt;/span&gt;         } &lt;span&gt;finally&lt;/span&gt;&lt;span&gt; {
&lt;/span&gt;&lt;span&gt;52&lt;/span&gt; &lt;span&gt;            out.print(gson.toJson(message));
&lt;/span&gt;&lt;span&gt;53&lt;/span&gt; &lt;span&gt;        }
&lt;/span&gt;&lt;span&gt;54&lt;/span&gt; 
&lt;span&gt;55&lt;/span&gt;     }
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;主要逻辑：查找到需要的段子→遍历段子→如果段子被点过赞或者踩，就把段子相应字段更改为赞或者踩→由于查出来的数据时顺序的，要改为逆序展示。&lt;/p&gt;
&lt;h2&gt;反思：&lt;/h2&gt;
&lt;p&gt;这次主要重构了后台的设计逻辑，其实还有好多不完备的地方。&lt;/p&gt;
&lt;p&gt;通过这次重构，明白了一个要点。要做一件事情首先要规划好，首先是设计，把一切的流程，框架设计好之后按部就班的做。这样做出来的东西才会比较好。&lt;/p&gt;
&lt;p&gt;否则在过程中会很混乱，严重影响效率。&lt;/p&gt;
&lt;h2&gt;预告：&lt;/h2&gt;
&lt;p&gt;下一章准备讲述点赞的逻辑，因为点赞的逻辑比较复杂。&lt;/p&gt;

&lt;p&gt;大家如果有什么疑问或者建议可以通过评论或者&lt;a href=&quot;mailto:he_jhua@foxmail.com&quot; target=&quot;_blank&quot;&gt;邮件&lt;/a&gt;的方式联系我，欢迎大家的评论~&lt;/p&gt;
</description>
<pubDate>Tue, 26 Jun 2018 13:05:00 +0000</pubDate>
<dc:creator>懒星人</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/lanxingren/p/9231243.html</dc:identifier>
</item>
<item>
<title>计算机系统中与存储有关的那些事 - 信号君</title>
<link>http://www.cnblogs.com/ncdxlxk/p/9231200.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/ncdxlxk/p/9231200.html</guid>
<description>&lt;p&gt;&lt;span&gt;最近工作中，经历了很多项目问题的调试，把这些问题归总起来，其中和存储有关的，独占一半。而存储对计算机系统造成的影响又可分为两块：一是系统功能的稳健性；二是程序的执行效率。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;存储器结构&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;1.1 存储器层次结构&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;由于访问速度、成本、功耗等指标的制约，计算机系统中的存储往往不是作为一个单一的大块存在，而是被设置成一个多级的层次结构。作为一个程序员，需要理解存储器层次结构，因为它对应用程序的性能有着巨大的影响。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;图1中展示了一个典型 计算机系统的存储层级结构。和金字塔模型很像，越靠近金字塔顶端的存储器，离CPU越近，访问更便利且访问速度快，但同时它们的容量也越来越小；反之越靠近底层，存储容量越大，访问速度却越来越慢。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;最高层的L0，是CPU寄存器，CPU可以在一个时钟周期内访问他们；接下来是一个或多个小型到中型的基于SRAM的高速缓存存储器，可以在几个CPU时钟周期内访问它们；然后是一个大的基于DRAM的主存，可以在几十到几百个时钟周期内访问它们；接下来是慢速但容量很大的本地磁盘；最后，甚至有些系统会通过网络访问其远程服务器上的磁盘。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;br/&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/746315/201806/746315-20180626204837397-509986800.png&quot; alt=&quot;&quot; width=&quot;567&quot; height=&quot;338&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;图1 存储器层次结构&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;高速缓存可以存在一级或多级，甚至不存在于一些低性能的单片机中。TI C64X架构中设计有2级的高速缓存，其数据和代码的存取机制在本订阅号之前的文章“TI C6000 数据存储处理与性能优化”中有过描述。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;1.2 存储器的访问&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;一个编写良好的计算机程序常常具有良好的&lt;strong&gt;局部性（locality）&lt;/strong&gt;。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;局部性通常有两种不同的形式：时间局部性和空间局部性。&lt;/span&gt;&lt;/p&gt;
&lt;ul class=&quot;list-paddingleft-2&quot; readability=&quot;0&quot;&gt;&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;&lt;span&gt;时间局部性：在一个具有良好时间局部性的程序中，被访问过一次的内存位置很可能在不远的将来再被多次访问 。&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;&lt;span&gt;空间局部性：在一个具有良好空间局部性的程序中，如果一个内存位置被访问 了一次，那么程序很可能在不远的将来访问 附近的一个内存位置。&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;span&gt;例如对一个二维数组求和：&lt;/span&gt;&lt;/p&gt;
&lt;blockquote readability=&quot;7&quot;&gt;
&lt;p&gt;&lt;span&gt;for (i=0; i&amp;lt;M; i++)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     for(j=0; j&amp;lt;N; j++)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;          sum += data_tab[i][j];&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;其中，sum在循环迭代中被多次访问，它具有良好的时间局部性，但因其为标量，因此没有空间局部性。对二维数组data_tab而言，其元素在存储中顺序存储，因此有好的空间局部性，但由于其每个元素只访问一次，因此时间局部性很差。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;另外，假设把上面第三行替换成：&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span&gt;sum += data_tab[j][i];&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;由于二维数组是按行依次存储，则每次循环对内存访问的步长由1变为N，空间局部性变差。像这样看上去对程序很小的改动对它的局部性有很大的影响。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;存储类型&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;2.1 随机访问存储器（RAM）&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;上电使用，掉电存储内容丢失。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;静态RAM（SRAM）：&lt;/strong&gt;存储单元具有双稳态特性，上电就能保持它的值，对光和电噪声等干扰不敏感。它使用晶体管多，因而密集度低，更贵，功耗更大。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;动态RAM（DRAM）：&lt;/strong&gt;对每个位存储为对一个电容的充电，因漏电的原因需要不断刷新来保持存储值。&lt;/span&gt;&lt;/p&gt;
&lt;ul class=&quot;list-paddingleft-2&quot; readability=&quot;0.5&quot;&gt;&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;&lt;span&gt;SDRAM（Synchronous DRAM）：用与驱动内存控制器相同的外部时钟信号的上升沿，来作为控制信号。&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;1&quot;&gt;
&lt;p&gt;&lt;span&gt;DDR SDRAM（Double Data-Rate Synchronous DRAM）：通过使用两个时钟沿作为控制信号，从而使DRAM的速度翻倍。它是用提高有效带宽的很小的预缓冲区的大小来划分的，如DDR（2位）、DDR2（4位）、DDR3（8位）。&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;span&gt;表1 SRAM与DRAM性能比较&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img class=&quot;img_loading&quot; src=&quot;data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==&quot; alt=&quot;&quot; data-s=&quot;300,640&quot; data-type=&quot;png&quot; data-src=&quot;http://mmbiz.qpic.cn/mmbiz_png/Bb5XxBw8KNVl9STeNECQO8PniceJaXrHRnbfWNKBA7hmWNJOqtIng8erctlp9eBKQhWnExNIPRmzgr64x3Ka62w/0?wx_fmt=png&quot; data-ratio=&quot;0.11464968152866242&quot; data-w=&quot;1099&quot;/&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/746315/201806/746315-20180626204938987-92524782.png&quot; alt=&quot;&quot; width=&quot;654&quot; height=&quot;75&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;2.2 非易失性存储器&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;非易失性存储器，即使在关电后仍能保存着它们的信息。由于历史的原因，它们也被整体成称为ROM（Read Only Memory），但很多ROM类型是即可以读也可以写的。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;PROM（Programble ROM）：&lt;/strong&gt;只能被编程一次，PROM的每个存储器单元有一种熔丝，只能用高电流熔断一次。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;EPROM（Erasable Programble ROM）：&lt;/strong&gt;可擦写可编程，对它的编程是通过一种把1写入EPROM的特殊设备来完成的。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;EEPROM（Electrically Erasable Programble ROM）：&lt;/strong&gt;电子可擦除，不需要一个物理上独立的编程设备，因此可以直接在芯片上编程，能被编程的次数可以达到10e5次。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;闪存（flash）：&lt;/strong&gt;基于EEPROM的一类非易失性存储器。对它写数据必须先将芯片中对应的内容清空，然后再写入，也就是通常说的“先擦后写 ”。&lt;/span&gt;&lt;/p&gt;
&lt;ul class=&quot;list-paddingleft-2&quot; readability=&quot;0&quot;&gt;&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;&lt;span&gt;NAND flash：对它的操作以“块 ”为基本单位，因此要修改一个字节，必须重写整个数据块。它的容量大，适合做大量数据的存储。&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;0&quot;&gt;
&lt;p&gt;&lt;span&gt;NOR flash：对它的操作以“字 ”为基本单位。它的容量相对较小，成本大，一般用来存储程序。&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;2.3 磁盘&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;磁盘由盘片构成，它是广为应用的保存大量数据的存储设备。不过从磁盘上读信息的时间为毫秒级，比从DRAM读慢了10万倍，比从SRAM读慢了100万倍。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;栈和堆&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;3.1 栈（stack）&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;栈是一个“后进先出”的存储空间，程序运行中，代码“过程 ”涉及到的返回地址、过程参数、需要保存的寄存器信息都被压入栈中，过程中声明的临时变量也是在栈中开辟存储。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;过程的形式多样：函数、方法、子例程、中断处理函数等。当过程需要的存储空间超出寄存器能够存放的大小时，就会在栈上分配空间，这部分空间称为过程的栈帧。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;通常，栈底位于高地址，随着数据的压入，栈向低地址方向增长，而栈指针指向栈顶。将栈指针减少一个适当的量，可以为没有指定初始值的数据，在栈上分配空间；类似的，可以通过增加栈指针来释放空间。因为栈的位置取决于.stack段分配在什么地方，所以栈的实际地址是在连接时决定的。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;假设过程P调用过程Q时，相关的控制和数据信息添加到栈尾，当Q返回时，这些信息会释放掉。如果存在多级调用（包括递归调用），较早的栈帧也会累积下来，直到它对应的过程结束。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/746315/201806/746315-20180626205025532-1025140339.png&quot; alt=&quot;&quot; width=&quot;278&quot; height=&quot;443&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;图2 通用的栈帧结构&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;栈空间的大小可以在链接命令文件中，使用-stack选项进行设定。在对TI C64X架构芯片进行编程时，如果用户没有自己设定，系统默认栈的尺寸为1KB。注意：编译器在编译期间和运行期间都不进行对栈溢出的检查，因此对栈空间的管理上需格外小心。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;3.2 堆（heap）&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;堆是用于动态内存分配的一个存储区域，动态分配的对象不是可直接寻址的，它们总是用指针来访问。动态内存分配器将堆视为一组不同大小的块的集合来维护。每个块就是一个连续的虚拟内存片，要么是已分配的，要么是空闲的。一个已分配的块保持已分配状态，直到他被释放，这种释放要么是应用程序显式执行的，要么是内存分配器自身隐式执行的。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;C标准库提供一个称为malloc程序包的显式分配器，程序通过调用malloc函数来从堆中分配块。malloc函数返回一个指针，指向大小至少为size字节的内存块，这个块会为可能包含在这个块内的任何数据对象类型做对齐。与malloc相对应的是free程序包，用于释放已分配的内存块。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;下图直接截取深入理解计算机系统这本书中，用一个16字的小堆来展示的malloc和free是如何管理堆空间的：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;img class=&quot;img_loading&quot; src=&quot;data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==&quot; alt=&quot;&quot; data-s=&quot;300,640&quot; data-type=&quot;png&quot; data-src=&quot;http://mmbiz.qpic.cn/mmbiz_png/Bb5XxBw8KNVl9STeNECQO8PniceJaXrHRp3BsMAuHbRJjRSQuFkkI1gyGWcf3MruC2wffR0wrf7iaoqbMhyjQR3g/0?wx_fmt=png&quot; data-ratio=&quot;0.8917910447761194&quot; data-w=&quot;804&quot;/&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/746315/201806/746315-20180626205115701-1250529788.png&quot; alt=&quot;&quot; width=&quot;728&quot; height=&quot;649&quot;/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;程序使用动态内存分配的最重要原因是，经常直到程序实际运行时才知道某些数据结构的大小。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;堆位于段.sysmem中，可分配动态存储池的大小，仅仅受限于系统中实际的存储容量。 堆空间的大小可以在链接命令文件中，使用-heap选项进行设定。在对TI C64X架构芯片进行编程时，如果用户没有自己设定，系统默认堆的尺寸为1KB。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;C编程中常见的与内存有关的错误&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在我们项目的调试中，死机现象被认为是最让人头疼的问题，因为这类问题往往很难复现，而即便是找到了复现的规律，也很难通过跟踪调试来断定问题所属的区域。由软件造成死机的因素，可大致分为两类：内存操作错误和线程阻塞。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;线程阻塞也有很多表现方式，如高优先级线程堆积、程序陷入异常处理流程、死循环等等。所幸的是，线程阻塞要么很好复现，要么被追踪到一次就能立马找出症结所在，可面对内存错误造成的死机就不那么容易解决了。《深入理解计算机系统》这本书中也讲到：与内存有关的错误，属于那些最令人惊恐的错误，因为他们在时间和空间上，经常在举措无缘一段距离之后才表现出来，将错误的数据选择错误的位置，你的程序可能在最终失败之前运行了好几个小时，其实程序终止的位置距离处的位置已经很远了。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;内存操作错误为什么会造成死机？举个简单的类比：一套性能完整的代码就好比是一幢设计建造完好的房子，而内存操作错误就像是突然拆除或篡改了支撑房屋结构或运转的关键部位，这一突发错误完全超出设计意料之外，引发一连串的恶果也就在所难免。下面是一些常见的内存错误操作的例子（真实的情况远不止这些，更多情况可参考《深入理解计算机系统》这本书）：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;4.1 数组越界&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span&gt;int data_tab[100];&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;int i;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;for(i=0; i&amp;lt;=100; i++)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;{&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     data_tab[i] = i;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;}&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;这个例子中data_tab占100个int型长度，但循环却进行了101次。C对于数组应用不进行任何边界检查，而且局部变量和状态信息（例如保存的寄存器值和返回地址）存放在栈中，这两种情况结合到一起就能导致严重的程序错误，对越界数组元素的写操作，会破坏存储在栈中的状态信息。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;另一种情况是data_tab[]是全局数组，这样的越界将引起对数组尾部其它存储内容的修改，倘若被篡改的存储区域刚好涉及到代码的关键流程判断，意味着异常流程的出现。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;4.2 间接引用坏指针&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span&gt;scanf(&quot;%d&quot;, &amp;amp;val);&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;错误写成：&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span&gt;scanf(&quot;%d&quot;, val);&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;在这种情况下，scanf将val的内容解释为一个地址，并试图将一个字节写到这个位置。在最好的情况下，程序立即异常终止，在最糟糕的情况下，val的内容对应于内存的某个合法的读写区域，于是我们就覆盖了这块内存，就通常会在相当长的一段时间以后，造成灾难性的令人困惑的后果。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;4.3 误解指针运算&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote readability=&quot;10&quot;&gt;
&lt;p&gt;&lt;span&gt;int *search(int *p, int val)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;{&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     while(*p &amp;amp;&amp;amp; *p != val)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     p += sizeof(int)  // should be p++&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     return p;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;}&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;这种错误是忘记了指针的算术操作是以它指向的对象的大小为单位来进行的。假设这里int占四个字节，原本扫描每个int变成了每四个int扫描一次。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;4.4 引用不存在的变量&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span&gt;int *stackref()&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;{&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     int val;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     int *p;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     p = &amp;amp;val;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     return p;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;}&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;这个函数返回一个指针，指向栈里的一个局部变量。尽管p仍指向一个合法的内存地址，是它已经不再指向一个合法的变量了。要知道，局部变量val在函数返回时，将会被释掉。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;4.5 引用空闲堆块中的数据&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote readability=&quot;5&quot;&gt;
&lt;p&gt;&lt;span&gt;int *heapref()&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;{&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     int *x, *y;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     x = (int *)malloc(sizeof(int));&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     ...&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     free(x);&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     y = x;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     ...&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     return y;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;}&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;这里y错误的引用已经被释放的堆块的数据和指针x。申请的堆块一旦被释放，虽然之前指向该堆块的指针x并没有变化，但它指向的区域数据已经不再有效了。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;4.6 引起内存泄漏&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote readability=&quot;5&quot;&gt;
&lt;p&gt;&lt;span&gt;void leak(int n)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;{&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     x = (int *)malloc(n*sizeof(int));&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;     return;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;}&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;这个函数中分配了一个堆块，但没释放就返回。如果经常调用leak，那么渐渐的堆里就会充满了垃圾，最糟糕的情况下会占用整个内存地址空间。内存泄漏是缓慢、隐性的杀手。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;参考文献&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;【1】BRYANT R E, O’HALLARON D R. Computer Systems: A Programmer’s Perspective[M]. 3 edition. Boston: Pearson, 2015.（译名：深入理解计算机系统）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;【2】田黎育,何佩琨,朱梦宇. TMS320C6000系列DSP编程工具与指南[M].北京:清华大学出版社 2006.&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;【3】TMS320C6000 Assembly Language Tools v7.4--SPRU186W,2012&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;【4】嵌入式开发之NorFlash 和NandFlash-tiger-john的CSDN博客&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt; &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;·END·&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;想进一步跟踪本博客动态，欢迎关注我的个人微信订阅号：&lt;strong&gt;信号君&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;strong data-brushtype=&quot;text&quot;&gt;信号君：寻求简单之道&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;技术成长 | 读书笔记 | 认知升级&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/746315/201806/746315-20180624104439302-493786623.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;扫描二维码关注信号君&lt;/p&gt;


</description>
<pubDate>Tue, 26 Jun 2018 12:54:00 +0000</pubDate>
<dc:creator>信号君</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/ncdxlxk/p/9231200.html</dc:identifier>
</item>
<item>
<title>设计模式（十六）—— 解释器模式 - Answer.Geng</title>
<link>http://www.cnblogs.com/Answer-Geng/p/9231042.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/Answer-Geng/p/9231042.html</guid>
<description>&lt;h2 id=&quot;模式简介&quot;&gt;模式简介&lt;/h2&gt;
&lt;hr/&gt;&lt;blockquote readability=&quot;6&quot;&gt;
&lt;p&gt;给定一个语言，定义它的文法的一种表示，并定义一个解释器，这个解释器使用该表示来解释语言中的句子。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;顾名思义，解释器模式就是定义一种语法，并提供一个解释器，客户端可以使用该解释器来解释这个语句来解决问题。例如写文档常用的Markdown语法，可以用-来表示无序列表，用---来表示下划线。通过解释器模式对这种经常使用到的事物，将其定义为一个简单的标识，以便于我们使用。&lt;/p&gt;
&lt;h2 id=&quot;结构分析&quot;&gt;结构分析&lt;/h2&gt;
&lt;hr/&gt;&lt;h3 id=&quot;uml类图&quot;&gt;UML类图&lt;/h3&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/971601/201806/971601-20180626185859210-2032902535.png&quot;/&gt;&lt;/p&gt;
&lt;h3 id=&quot;角色说明&quot;&gt;角色说明&lt;/h3&gt;
&lt;ul&gt;&lt;li&gt;AbstractExpression&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;抽象表达式类，包含一个抽象的解释操作，这个接口为抽象语法树中所有的节点所共享。&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;TerminalExpression&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;末端表达式类，实现与在语法中终结符相关联的解释操作，在语句中每个终结符都需要这个实例。&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;NonterminalExpression&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;非末端表达式类，实现在语法中非末端表达式的解释操作。通常递归的自我调用。&lt;/p&gt;
&lt;p&gt;上下文，包含解释器之外的一些全局信息。&lt;/p&gt;
&lt;h3 id=&quot;结构代码&quot;&gt;结构代码&lt;/h3&gt;
&lt;pre&gt;
&lt;code&gt;//上下文类
public class Context
{
    
}

//抽象表达式类
abstract class AbstractExpression
{
    public abstract void Interpret(Context context);
}

//末端表达式类
class TerminalExpression : AbstractExpression
{
    public override void Interpret(Context context)
    {
        Console.WriteLine(&quot;Called Terminal.Interpret()&quot;);
    }
}

//非末端表达式类
class NonterminalExpression : AbstractExpression
{
    public override void Interpret(Context context)
    {
        Console.WriteLine(&quot;Called Nonterminal.Interpret()&quot;);
    }
}

//客户端调用
class Program
{
    static void Main(string[] args)
    {
        Context context = new Context();
        var list = new List&amp;lt;AbstractExpression&amp;gt;();
        list.Add(new TerminalExpression());
        list.Add(new NonterminalExpression());
        list.Add(new TerminalExpression());
        list.Add(new TerminalExpression());

        foreach (var exp in list)
        {
            exp.Interpret(context);
        }

        Console.ReadLine();
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/971601/201806/971601-20180626190051905-1776561601.png&quot;/&gt;&lt;/p&gt;
&lt;h2 id=&quot;示例分析&quot;&gt;示例分析&lt;/h2&gt;
&lt;hr/&gt;&lt;p&gt;本节我们通过解释器模式实现一个简易的Markdown语法，在控制台中输出解释后的内容。首先创建上下文类Context，包含一个Content成员。&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class Context
{
    public string Content { get; set; }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;定义IExpression接口，并通过UnOrderedListExpression和UnderlineExpression子类分别实现无序列表解释器以及下划线解释器。&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;interface IExpression
{
    void Interpret(Context context);
}

class UnOrderedListExpression : IExpression
{
    public void Interpret(Context context)
    {
        if (context.Content.Contains(&quot;- &quot;))
        {
            context.Content = context.Content.Replace(&quot;- &quot;, &quot;·&quot;);
        }
    }
}

class UnderlineExpression : IExpression
{
    public void Interpret(Context context)
    {
        if (context.Content.Contains(&quot;---&quot;))
        {
            context.Content = context.Content.Replace(&quot;---&quot;, &quot;__________________________&quot;);
        }
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;客户端调用，先向上下文实例的content属性给定内容，并使用UnOrderedListExpression和UnderlineExpression解释器分别对其进行解释，最后输出结果。&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class Program
{
    static void Main(string[] args)
    {
        Context context = new Context();
        context.Content = &quot;- apple\r\n&quot;;
        context.Content += &quot;- orange\r\n&quot;;
        context.Content += &quot;- banana\r\n&quot;;
        context.Content += &quot;---&quot;;

        List&amp;lt;IExpression&amp;gt; tree = new List&amp;lt;IExpression&amp;gt;();
        tree.Add(new UnOrderedListExpression());
        tree.Add(new UnderlineExpression());

        foreach (var exp in tree)
        {
            exp.Interpret(context);
        }

        Console.WriteLine(context.Content);
        Console.ReadLine();
    }
}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;程序输出：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/971601/201806/971601-20180626200646549-1569378697.png&quot;/&gt;&lt;/p&gt;
&lt;h2 id=&quot;使用场景&quot;&gt;使用场景&lt;/h2&gt;
&lt;hr/&gt;&lt;h2 id=&quot;优点和不足&quot;&gt;优点和不足&lt;/h2&gt;
&lt;hr/&gt;&lt;h3 id=&quot;优点&quot;&gt;优点&lt;/h3&gt;
&lt;ul&gt;&lt;li&gt;易于改变和扩展语法&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;因为使用类来声明表达式，可以使用继承来修改或改变该表达式的行为。&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;易于实现新的解释表达式方法&lt;/li&gt;
&lt;/ul&gt;&lt;h3 id=&quot;不足&quot;&gt;不足&lt;/h3&gt;
&lt;ul&gt;&lt;li&gt;容易引起类“爆炸”&lt;/li&gt;
&lt;li&gt;对于复杂的语法较难维护&lt;/li&gt;
&lt;/ul&gt;</description>
<pubDate>Tue, 26 Jun 2018 12:31:00 +0000</pubDate>
<dc:creator>Answer.Geng</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/Answer-Geng/p/9231042.html</dc:identifier>
</item>
<item>
<title>OAuth 2.0 授权码请求 - 不要乱摸</title>
<link>http://www.cnblogs.com/cjsblog/p/9230990.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/cjsblog/p/9230990.html</guid>
<description>&lt;p&gt;&lt;span&gt;关于OAuth 2.0，请参见下面这两篇文章（墙裂推荐）：&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;《&lt;a href=&quot;https://www.cnblogs.com/cjsblog/p/9174797.html&quot; target=&quot;_blank&quot;&gt;OAuth 2.0&lt;/a&gt;》&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;《&lt;a href=&quot;https://www.cnblogs.com/cjsblog/p/9184173.html&quot; target=&quot;_blank&quot;&gt;Spring Security OAuth 2.0&lt;/a&gt;》&lt;/span&gt;&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;&lt;span&gt;纸上得来终觉浅，绝知此事要躬行。理论知识了解以后，最终还是要动手实践，不亲自做一遍永远不知道里面有多少坑。本节的重点是用Spring Security实现授权码模式。&lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;1. maven依赖&lt;/h2&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
&lt;span&gt;&amp;lt;?&lt;/span&gt;&lt;span&gt;xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;&lt;/span&gt;&lt;span&gt;?&amp;gt;&lt;/span&gt;
&lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;project &lt;/span&gt;&lt;span&gt;xmlns&lt;/span&gt;&lt;span&gt;=&quot;http://maven.apache.org/POM/4.0.0&quot;&lt;/span&gt;&lt;span&gt; xmlns:xsi&lt;/span&gt;&lt;span&gt;=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&lt;/span&gt;&lt;span&gt;
    xsi:schemaLocation&lt;/span&gt;&lt;span&gt;=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;modelVersion&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;4.0.0&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;modelVersion&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;com.cjs.example&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;cjs-oauth2-code-server&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;0.0.1-SNAPSHOT&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;packaging&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;jar&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;packaging&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;cjs-oauth2-code-server&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;name&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;description&lt;/span&gt;&lt;span&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;description&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;parent&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-parent&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;2.0.2.RELEASE&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;relativePath&lt;/span&gt;&lt;span&gt;/&amp;gt;&lt;/span&gt; &lt;span&gt;&amp;lt;!--&lt;/span&gt;&lt;span&gt; lookup parent from repository &lt;/span&gt;&lt;span&gt;--&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;parent&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;properties&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;project.build.sourceEncoding&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;UTF-8&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;project.build.sourceEncoding&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;project.reporting.outputEncoding&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;UTF-8&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;project.reporting.outputEncoding&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;java.version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;1.8&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;java.version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;properties&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependencies&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-security&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-thymeleaf&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-web&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.security.oauth&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-security-oauth2&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;2.3.3.RELEASE&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;version&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.projectlombok&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;lombok&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;optional&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;true&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;optional&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-boot-starter-test&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;scope&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;test&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;scope&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.security&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-security-test&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;scope&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;test&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;scope&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependency&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;dependencies&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;

    &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;build&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;plugins&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;plugin&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
                &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;org.springframework.boot&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;groupId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
                &lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;spring-boot-maven-plugin&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;artifactId&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
            &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;plugin&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
        &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;plugins&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
    &lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;build&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;


&lt;span&gt;&amp;lt;/&lt;/span&gt;&lt;span&gt;project&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;2. 配置Security&lt;/h2&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;package&lt;/span&gt;&lt;span&gt; com.cjs.example.config;

&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.context.annotation.Bean;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.context.annotation.Configuration;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.config.annotation.web.builders.HttpSecurity;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.config.annotation.web.builders.WebSecurity;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.core.userdetails.User;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.core.userdetails.UserDetails;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.core.userdetails.UserDetailsService;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.crypto.password.PasswordEncoder;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.provisioning.InMemoryUserDetailsManager;

@Configuration
@EnableWebSecurity
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; WebSecurityConfig &lt;span&gt;extends&lt;/span&gt;&lt;span&gt; WebSecurityConfigurerAdapter {

    @Override
    &lt;/span&gt;&lt;span&gt;protected&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; configure(AuthenticationManagerBuilder auth) &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception {
        &lt;/span&gt;&lt;span&gt;super&lt;/span&gt;&lt;span&gt;.configure(auth);
&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;        auth.inMemoryAuthentication().withUser(&quot;zhangsan&quot;).password(&quot;$2a$10$qsJ/Oy1RmUxFA.YtDT8RJ.Y2kU3U4z0jvd35YmiMOAPpD.nZUIRMC&quot;).roles(&quot;USER&quot;);&lt;/span&gt;
&lt;span&gt;
    }

    @Override
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; configure(WebSecurity web) &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception {
        &lt;/span&gt;&lt;span&gt;super&lt;/span&gt;&lt;span&gt;.configure(web);
    }

    @Override
    &lt;/span&gt;&lt;span&gt;protected&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; configure(HttpSecurity http) &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception {
        &lt;/span&gt;&lt;span&gt;super&lt;/span&gt;&lt;span&gt;.configure(http);
    }


    @Bean
    @Override
    &lt;/span&gt;&lt;span&gt;protected&lt;/span&gt;&lt;span&gt; UserDetailsService userDetailsService() {
        User.UserBuilder builder &lt;/span&gt;=&lt;span&gt; User.builder();
        UserDetails user &lt;/span&gt;= builder.username(&quot;zhangsan&quot;).password(&quot;$2a$10$GStfEJEyoSHiSxnoP3SbD.R8XRowP1QKOdi.N6/iFEwEJWTQqlSba&quot;).roles(&quot;USER&quot;&lt;span&gt;).build();
        UserDetails admin &lt;/span&gt;= builder.username(&quot;lisi&quot;).password(&quot;$2a$10$GStfEJEyoSHiSxnoP3SbD.R8XRowP1QKOdi.N6/iFEwEJWTQqlSba&quot;).roles(&quot;USER&quot;, &quot;ADMIN&quot;&lt;span&gt;).build();
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt;&lt;span&gt; InMemoryUserDetailsManager(user, admin);
    }

    @Bean
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; PasswordEncoder passwordEncoder() {
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt; &lt;span&gt;new&lt;/span&gt;&lt;span&gt; BCryptPasswordEncoder();
    }


    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; main(String[] args) {
        BCryptPasswordEncoder bCryptPasswordEncoder &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; BCryptPasswordEncoder();
        System.out.println(bCryptPasswordEncoder.encode(&lt;/span&gt;&quot;123456&quot;&lt;span&gt;));
        System.out.println(bCryptPasswordEncoder.encode(&lt;/span&gt;&quot;12345678&quot;&lt;span&gt;));
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;3. 配置授权服务器&lt;/h2&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;package&lt;/span&gt;&lt;span&gt; com.cjs.example.config;

&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.context.annotation.Configuration;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurerAdapter;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;


@Configuration
@EnableAuthorizationServer
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt; AuthorizationServerConfig &lt;span&gt;extends&lt;/span&gt;&lt;span&gt; AuthorizationServerConfigurerAdapter {

    @Override
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; configure(AuthorizationServerSecurityConfigurer security) &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception {
        &lt;/span&gt;&lt;span&gt;super&lt;/span&gt;&lt;span&gt;.configure(security);
    }

    @Override
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; configure(ClientDetailsServiceConfigurer clients) &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception {
        clients.inMemory()
                .withClient(&lt;/span&gt;&quot;my-client-1&quot;&lt;span&gt;)
                .secret(&lt;/span&gt;&quot;$2a$10$0jyHr4rGRdQw.X9mrLkVROdQI8.qnWJ1Sl8ly.yzK0bp06aaAkL9W&quot;&lt;span&gt;)
                .authorizedGrantTypes(&lt;/span&gt;&quot;authorization_code&quot;, &quot;refresh_token&quot;&lt;span&gt;)
                .scopes(&lt;/span&gt;&quot;all&quot;&lt;span&gt;)
                .redirectUris(&lt;/span&gt;&quot;http://www.baidu.com&quot;&lt;span&gt;);
    }

    @Override
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; configure(AuthorizationServerEndpointsConfigurer endpoints) &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception {
        &lt;/span&gt;&lt;span&gt;super&lt;/span&gt;&lt;span&gt;.configure(endpoints);
    }

    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; main(String[] args) {
        System.out.println(&lt;/span&gt;&lt;span&gt;new&lt;/span&gt; org.apache.tomcat.util.codec.binary.Base64().encodeAsString(&quot;my-client-1:12345678&quot;&lt;span&gt;.getBytes()));
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;这里客户端的secret是12345678，存储的是加密后的值&lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;4. 启动类&lt;/h2&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
&lt;span&gt;package&lt;/span&gt;&lt;span&gt; com.cjs.example;

&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.boot.SpringApplication;
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; CjsOauth2CodeServerApplication {

    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; main(String[] args) {
        SpringApplication.run(CjsOauth2CodeServerApplication.&lt;/span&gt;&lt;span&gt;class&lt;/span&gt;&lt;span&gt;, args);
    }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;到目前为止，好像我们就做了两件事情：一、配置用户；二、注册客户端&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;现在，我们有两个用户（zhangsan和lisi）以及一个已注册的客户端（my-client-1）&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;接下来，用postman模拟客户端请求获取access_token&lt;/span&gt;&lt;/p&gt;
&lt;h2&gt;5. 协议端点&lt;/h2&gt;
&lt;p&gt;&lt;span&gt;我们知道，在获取access_token之前需要用户授权，然后返回一个code，最后用code换access_token&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;在这个过程中涉及到三个服务器端点：授权端点、重定向端点、令牌端点&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;通过控制台看看启动日志可能会加深理解：&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;74&quot;&gt;
&lt;pre&gt;
  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::        (v2.0.3.RELEASE)

2018-06-26 09:44:09.575  INFO 6528 --- [           main] c.c.e.CjsOauth2CodeServerApplication     : Starting CjsOauth2CodeServerApplication on USER-20170302XK with PID 6528 (E:\cjsworkspace\cjs-oauth2-example\cjs-oauth2-code-server\target\classes started by Administrator in E:\cjsworkspace\cjs-oauth2-example\cjs-oauth2-code-server)
2018-06-26 09:44:09.597  INFO 6528 --- [           main] c.c.e.CjsOauth2CodeServerApplication     : No active profile set, falling back to default profiles: default
2018-06-26 09:44:09.762  INFO 6528 --- [           main] ConfigServletWebServerApplicationContext : Refreshing org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@22635ba0: startup date [Tue Jun 26 09:44:09 CST 2018]; root of context hierarchy
2018-06-26 09:44:12.931  INFO 6528 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
2018-06-26 09:44:12.997  INFO 6528 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
2018-06-26 09:44:12.998  INFO 6528 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet Engine: Apache Tomcat/8.5.31
2018-06-26 09:44:13.039  INFO 6528 --- [ost-startStop-1] o.a.catalina.core.AprLifecycleListener   : The APR based Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: [C:\Program Files\Java\jdk1.8.0_152\bin;C:\Windows\Sun\Java\bin;C:\Windows\system32;C:\Windows;C:\ProgramData\Oracle\Java\javapath;C:\Windows\system32;C:\Windows;C:\Windows\System32\Wbem;C:\Windows\System32\WindowsPowerShell\v1.0\;C:\Program Files\Java\jdk1.8.0_152\bin;C:\Program Files\Java\jdk1.8.0_152\jre\bin;D:\apache\apache-maven-3.5.3\bin;C:\Program Files\Git\cmd;.]
2018-06-26 09:44:13.200  INFO 6528 --- [ost-startStop-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
2018-06-26 09:44:13.200  INFO 6528 --- [ost-startStop-1] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 3448 ms
2018-06-26 09:44:13.379  INFO 6528 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'characterEncodingFilter' to: [/*]
2018-06-26 09:44:13.379  INFO 6528 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'hiddenHttpMethodFilter' to: [/*]
2018-06-26 09:44:13.379  INFO 6528 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'httpPutFormContentFilter' to: [/*]
2018-06-26 09:44:13.379  INFO 6528 --- [ost-startStop-1] o.s.b.w.servlet.FilterRegistrationBean   : Mapping filter: 'requestContextFilter' to: [/*]
2018-06-26 09:44:13.379  INFO 6528 --- [ost-startStop-1] .s.DelegatingFilterProxyRegistrationBean : Mapping filter: 'springSecurityFilterChain' to: [/*]
2018-06-26 09:44:13.380  INFO 6528 --- [ost-startStop-1] o.s.b.w.servlet.ServletRegistrationBean  : Servlet dispatcherServlet mapped to [/]
2018-06-26 09:44:13.529  INFO 6528 --- [           main] .s.o.p.e.FrameworkEndpointHandlerMapping : Mapped &quot;{[/oauth/authorize]}&quot; onto public org.springframework.web.servlet.ModelAndView org.springframework.security.oauth2.provider.endpoint.AuthorizationEndpoint.authorize(java.util.Map&amp;lt;java.lang.String, java.lang.Object&amp;gt;,java.util.Map&amp;lt;java.lang.String, java.lang.String&amp;gt;,org.springframework.web.bind.support.SessionStatus,java.security.Principal)
2018-06-26 09:44:13.530  INFO 6528 --- [           main] .s.o.p.e.FrameworkEndpointHandlerMapping : Mapped &quot;{[/oauth/authorize],methods=[POST],params=[user_oauth_approval]}&quot; onto public org.springframework.web.servlet.View org.springframework.security.oauth2.provider.endpoint.AuthorizationEndpoint.approveOrDeny(java.util.Map&amp;lt;java.lang.String, java.lang.String&amp;gt;,java.util.Map&amp;lt;java.lang.String, ?&amp;gt;,org.springframework.web.bind.support.SessionStatus,java.security.Principal)
2018-06-26 09:44:13.530  INFO 6528 --- [           main] .s.o.p.e.FrameworkEndpointHandlerMapping : Mapped &quot;{[/oauth/token],methods=[POST]}&quot; onto public org.springframework.http.ResponseEntity&amp;lt;org.springframework.security.oauth2.common.OAuth2AccessToken&amp;gt; org.springframework.security.oauth2.provider.endpoint.TokenEndpoint.postAccessToken(java.security.Principal,java.util.Map&amp;lt;java.lang.String, java.lang.String&amp;gt;) throws org.springframework.web.HttpRequestMethodNotSupportedException
2018-06-26 09:44:13.531  INFO 6528 --- [           main] .s.o.p.e.FrameworkEndpointHandlerMapping : Mapped &quot;{[/oauth/token],methods=[GET]}&quot; onto public org.springframework.http.ResponseEntity&amp;lt;org.springframework.security.oauth2.common.OAuth2AccessToken&amp;gt; org.springframework.security.oauth2.provider.endpoint.TokenEndpoint.getAccessToken(java.security.Principal,java.util.Map&amp;lt;java.lang.String, java.lang.String&amp;gt;) throws org.springframework.web.HttpRequestMethodNotSupportedException
2018-06-26 09:44:13.531  INFO 6528 --- [           main] .s.o.p.e.FrameworkEndpointHandlerMapping : Mapped &quot;{[/oauth/check_token]}&quot; onto public java.util.Map&amp;lt;java.lang.String, ?&amp;gt; org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint.checkToken(java.lang.String)
2018-06-26 09:44:13.531  INFO 6528 --- [           main] .s.o.p.e.FrameworkEndpointHandlerMapping : Mapped &quot;{[/oauth/confirm_access]}&quot; onto public org.springframework.web.servlet.ModelAndView org.springframework.security.oauth2.provider.endpoint.WhitelabelApprovalEndpoint.getAccessConfirmation(java.util.Map&amp;lt;java.lang.String, java.lang.Object&amp;gt;,javax.servlet.http.HttpServletRequest) throws java.lang.Exception
2018-06-26 09:44:13.531  INFO 6528 --- [           main] .s.o.p.e.FrameworkEndpointHandlerMapping : Mapped &quot;{[/oauth/error]}&quot; onto public org.springframework.web.servlet.ModelAndView org.springframework.security.oauth2.provider.endpoint.WhitelabelErrorEndpoint.handleError(javax.servlet.http.HttpServletRequest)
2018-06-26 09:44:13.760  INFO 6528 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**/favicon.ico] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-26 09:44:14.019  INFO 6528 --- [           main] s.w.s.m.m.a.RequestMappingHandlerAdapter : Looking for @ControllerAdvice: org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext@22635ba0: startup date [Tue Jun 26 09:44:09 CST 2018]; root of context hierarchy
2018-06-26 09:44:14.049  INFO 6528 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;{[/error]}&quot; onto public org.springframework.http.ResponseEntity&amp;lt;java.util.Map&amp;lt;java.lang.String, java.lang.Object&amp;gt;&amp;gt; org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController.error(javax.servlet.http.HttpServletRequest)
2018-06-26 09:44:14.049  INFO 6528 --- [           main] s.w.s.m.m.a.RequestMappingHandlerMapping : Mapped &quot;{[/error],produces=[text/html]}&quot; onto public org.springframework.web.servlet.ModelAndView org.springframework.boot.autoconfigure.web.servlet.error.BasicErrorController.errorHtml(javax.servlet.http.HttpServletRequest,javax.servlet.http.HttpServletResponse)
2018-06-26 09:44:14.062  INFO 6528 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/webjars/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-26 09:44:14.063  INFO 6528 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2018-06-26 09:44:14.103  WARN 6528 --- [           main] ion$DefaultTemplateResolverConfiguration : Cannot find template location: classpath:/templates/ (please add some templates or check your Thymeleaf configuration)
2018-06-26 09:44:14.806  INFO 6528 --- [           main] o.s.s.web.DefaultSecurityFilterChain     : Creating filter chain: OrRequestMatcher [requestMatchers=[Ant [pattern='/oauth/token'], Ant [pattern='/oauth/token_key'], Ant [pattern='/oauth/check_token']]], [org.springframework.security.web.context.request.async.WebAsyncManagerIntegrationFilter@5aae8eb5, org.springframework.security.web.context.SecurityContextPersistenceFilter@1473b8c0, org.springframework.security.web.header.HeaderWriterFilter@4e38d975, org.springframework.security.web.authentication.logout.LogoutFilter@5dc3fcb7, org.springframework.security.web.authentication.www.BasicAuthenticationFilter@7a639ec5, org.springframework.security.web.savedrequest.RequestCacheAwareFilter@749f539e, org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter@7a18e8d, org.springframework.security.web.authentication.AnonymousAuthenticationFilter@76954a33, org.springframework.security.web.session.SessionManagementFilter@5972d253, org.springframework.security.web.access.ExceptionTranslationFilter@2d195ee4, org.springframework.security.web.access.intercept.FilterSecurityInterceptor@6fca2a8f]
2018-06-26 09:44:14.865  INFO 6528 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup
2018-06-26 09:44:14.901  INFO 6528 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
2018-06-26 09:44:14.904  INFO 6528 --- [           main] c.c.e.CjsOauth2CodeServerApplication     : Started CjsOauth2CodeServerApplication in 6.298 seconds (JVM running for 8.287)
&lt;/pre&gt;&lt;/div&gt;
&lt;h3&gt;&lt;span&gt;5.1. 授权端点&lt;/span&gt;&lt;/h3&gt;
&lt;h4&gt;&lt;span&gt;请求&lt;/span&gt;&lt;/h4&gt;
&lt;table border=&quot;2&quot; align=&quot;left&quot;&gt;&lt;tbody readability=&quot;6.5&quot;&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;&lt;strong&gt;参数名称&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;&lt;strong&gt;描述&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;&lt;span&gt;response_type&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;必填。将其值设置为code表示如果成功的话将收到一个授权码。&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;&lt;span&gt;client_id&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;必填。客户端标识。&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td&gt;&lt;span&gt;redirect_uri&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;可选。重定向URI虽然不是必须的，但是你的服务应该会需要它。而且，这个URL必须和授权服务端注册的redirect_id一致。&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td&gt;&lt;span&gt;scope&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;可选。请求可能会有一个或多个scope值。授权服务器会把客户端请求的范围(scope)展示给用户看。&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td&gt;&lt;span&gt;state&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;推荐。state参数用于应用存储特定的请求数据的可以防止CSRF攻击。授权服务器必须原封不动地将这个值返回给应用。&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;







&lt;h4&gt;例如：&lt;/h4&gt;
&lt;p&gt;&lt;span&gt;http://localhost:8080/oauth/authorize?response_type=code&amp;amp;client_id=my-client-1&amp;amp;redirect_uri=http://www.baidu.com&amp;amp;scope=all&lt;/span&gt;&lt;/p&gt;
&lt;h4&gt;响应&lt;/h4&gt;
&lt;table border=&quot;4&quot; align=&quot;left&quot;&gt;&lt;tbody readability=&quot;2&quot;&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;&lt;strong&gt;参数名称&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;&lt;strong&gt;描述&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;&lt;span&gt;code&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;授权码，稍后用此授权码交换访问令牌&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;&lt;span&gt;state&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;请求时带的state参数&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;


&lt;h4&gt;例如：&lt;/h4&gt;
&lt;p&gt;&lt;span&gt;https://www.baidu.com/?code=7Zudn6&lt;/span&gt;&lt;/p&gt;
&lt;h3&gt;5.2. 令牌端点&lt;/h3&gt;
&lt;h4&gt;请求&lt;/h4&gt;
&lt;table border=&quot;2&quot; align=&quot;left&quot;&gt;&lt;tbody readability=&quot;4.5&quot;&gt;&lt;tr&gt;&lt;td&gt;&lt;span&gt;&lt;strong&gt;参数名称&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;&lt;strong&gt;描述&lt;/strong&gt;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;&lt;span&gt;grant_type&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;必填。参数值必须是&quot;authorization_code&quot;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;&lt;span&gt;code&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;必填。之前收到的授权码&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;3&quot;&gt;&lt;td&gt;&lt;span&gt;redirect_uri&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;可能是必填的。如果授权请求的时候有redirect_uri，那么token请求的时候也必须带上这个参数，二者的值必须是一样的。&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr readability=&quot;2&quot;&gt;&lt;td&gt;&lt;span&gt;client_id&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;&lt;span&gt;客户端标识，如果没有其它的客户端认证存在的话这个参数是必须的。&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;





&lt;p&gt;&lt;span&gt;关于客户端认证补充一点&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626195901410-1181591765.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;span&gt;授权服务器可以通过HTTP Basic Auth方式对客户端进行认证，也可以通过在请求中加一个client_secret参数来对客户端进行认证。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;不建议将客户端的secret直接作为参数放到client_secret中，而且这种方式下client_id和client_secret都是必填参数。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;strong&gt;特别注意，用户（资源所有者）的用户名和密码跟客户端的用户名和密码（client_id、client_secret）不是一套，它们是两个东西。&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;那么，通过HTTP Basic Auth如何对客户端进行认证呢？客户端需要怎样传参呢？&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;需要在请求header中设置Authorization，它的值是Basic + 空格 + Base64加密后的client_id:secret&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;至于为什么，那是协议要求的，具体可以参考https://tools.ietf.org/html/rfc2617#page-5，格式如下：&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626194354705-389166527.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;例如：&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;36&quot;&gt;
&lt;pre&gt;
POST /oauth/token HTTP/1.1
Content-Type: application/x-www-form-urlencoded
Authorization: Basic bXktY2xpZW50LTE6MTIzNDU2Nzg=
cache-control: no-cache
Postman-Token: baf729b9-f030-41c1-b6fb-d740b0c5c573
User-Agent: PostmanRuntime/7.1.1
Accept: */*
Host: localhost:8080
cookie: JSESSIONID=45EAF00C9829B9F569579DB08533D850; UISESSION=2A65FF6FC8C6BE415DE3C043E3EDAAA4
accept-encoding: gzip, deflate
content-length: 103
Connection: keep-alive

grant_type=authorization_code&amp;amp;code=7Zudn6&amp;amp;redirect_uri=http%3A%2F%2Fwww.baidu.com&amp;amp;client_id=my-client-1
&lt;/pre&gt;&lt;/div&gt;
&lt;h2&gt;6. 客户端请求&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626195036968-778099369.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;直接在浏览器中输入以下地址，然后会跳到登录授权页面&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;http://localhost:8080/oauth/authorize?response_type=code&amp;amp;client_id=my-client-1&amp;amp;redirect_uri=http://www.baidu.com&amp;amp;scope=all&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626194836904-494038780.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626194848667-333367895.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;上面这两个页面都是默认自带的&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;授权成功以后重定向&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626194939745-1256937004.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;有了授权码以后就可以换取access_token了&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626195017178-413826483.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/874963/201806/874963-20180626195023145-171223093.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;这个请求中唯一需要注意的一个参数就是Authorization，这是用于认证客户端的，本例中它是这样算出来的&lt;/span&gt;&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
&lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; main(String[] args) {
    System.out.println(&lt;/span&gt;&lt;span&gt;new&lt;/span&gt; org.apache.tomcat.util.codec.binary.Base64().encodeAsString(&quot;my-client-1:12345678&quot;&lt;span&gt;.getBytes()));
    System.out.println(java.util.Base64.getEncoder().encodeToString(&lt;/span&gt;&quot;my-client-1:12345678&quot;&lt;span&gt;.getBytes()));
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span&gt;所以，最终是Basic bXktY2xpZW50LTE6MTIzNDU2Nzg=&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;到此为止，我们只是获得了access_token，下一节将讲解如何配置资源服务器，以及客户端访问受保护的资源。&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;&lt;span&gt;另外，本例中关于令牌的存储，以及客户端注册都是在内存中，实际生产过程中肯定是要存储到数据库中的，这一部分以后有时间再写吧！&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;

</description>
<pubDate>Tue, 26 Jun 2018 12:05:00 +0000</pubDate>
<dc:creator>不要乱摸</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/cjsblog/p/9230990.html</dc:identifier>
</item>
<item>
<title>ZooKeeper: 简介, 配置及运维指南 - 张浮生</title>
<link>http://www.cnblogs.com/neooelric/p/9230967.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/neooelric/p/9230967.html</guid>
<description>&lt;p&gt;ZooKeeper是一个供其它分布式应用程序使用的软件, 它为其它分布式应用程序提供所谓的&lt;code&gt;协调&lt;/code&gt;服务. 所谓的&lt;code&gt;协调&lt;/code&gt;服务, 是指ZooKeeper的如下能力&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;naming 命名&lt;/li&gt;
&lt;li&gt;configuration management 配置管理&lt;/li&gt;
&lt;li&gt;synchronization 同步&lt;/li&gt;
&lt;li&gt;group service 分组服务&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;上面四个功能可能现在不太好说清, 但大致上目前你需要明白ZooKeeper就是为其它分布式应用程序提供一些基础功能的程序就好了. 我们以其中的&lt;code&gt;配置管理&lt;/code&gt;为例. 假设你在写一个可横向扩容的集群应用程序, 在你的预想里, 你的应用程序最终将部署到成千上万台机器上去, 那么, 这成千上万台机器上的成千上万个实例如何保持配置文件的一致性呢? 简单: 你的分布式应用程序不要自己处理配置管理的问题, 而是把配置管理交给ZooKeeper去做, 如果某个实例需要取配置文件, 去访问ZooKeeper就好了, ZooKeeper向你保证一致性.&lt;/p&gt;
&lt;p&gt;并且用上面说到的四种功能, 还能组合实现出其它高级玩法, 比如:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;implement consensus. 在需要一致性的时候, 由ZooKeeper实现一致性&lt;/li&gt;
&lt;li&gt;group management. 分组管理&lt;/li&gt;
&lt;li&gt;leader election. 集群选爹或组内选爹&lt;/li&gt;
&lt;li&gt;presence protocols. 探测集群中各个实例的死活&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;下面各个章节将详细叙述相关内容.&lt;/p&gt;
&lt;p&gt;需要说明的是, ZooKeeper本身的官方文档虽然质量上乘(Apache产品的一贯风格), 但内容上并不完整, 我的这篇译文也有两个缺陷: 一是可能错译, 由于我本身对ZooKeeper的理解出现了偏差导致的. 二是可能有废话, 我并不是照章一字一句翻译的. 总之请作为参考来阅读, 不要作为标准来阅读.&lt;/p&gt;
&lt;h2 id=&quot;简介&quot;&gt;1.1 简介&lt;/h2&gt;
&lt;h3 id=&quot;一个为分布式应用程序提供服务的-分布式协调服务&quot;&gt;1.1.1 一个为分布式应用程序提供服务的 分布式协调服务&lt;/h3&gt;
&lt;p&gt;ZooKeeper是:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;开源的&lt;/li&gt;
&lt;li&gt;为其它分布式应用程序提供服务的&lt;/li&gt;
&lt;li&gt;它本身也是分布式的&lt;/li&gt;
&lt;li&gt;向其它创面式应用程序提供&lt;code&gt;协调&lt;/code&gt;功能&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;ZooKeeper对外提供了一系列的&lt;code&gt;原语(primitives)&lt;/code&gt;, 其它分布式应用程序利用这些原语, 可以很方便的实现一些高级抽象功能, 比如: 同步, 配置管理维护, 分组, 命名等. ZooKeeper的设计宗旨就有两条:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;简单易用, 使用时的编码难度低.&lt;/li&gt;
&lt;li&gt;使用树型逻辑结构组织数据.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;ZooKeeper是用Java写的, 其对外的API有Java版本的, 也有C的binding版.&lt;/p&gt;
&lt;h3 id=&quot;zookeeper的设计原则&quot;&gt;1.1.2 ZooKeeper的设计原则&lt;/h3&gt;
&lt;h4 id=&quot;zookeeper是简单易用的&quot;&gt;ZooKeeper是简单易用的&lt;/h4&gt;
&lt;p&gt;如果将使用ZooKeeper的分布式应用程序看做是千千万万个独立的进程实例, ZooKeeper则是构建了一个&lt;code&gt;共享的, 层级式的名称空间(shared hierarchal namespace)&lt;/code&gt;以供这千千万万个进程实例去访问. 这个所谓的&lt;code&gt;层级式的名称空间&lt;/code&gt;逻辑上和*nix中的文件系统很像. &lt;code&gt;名称空间&lt;/code&gt;由&lt;code&gt;数据寄存器(data register)&lt;/code&gt;构成, &lt;code&gt;数据寄存器&lt;/code&gt;也被称谓&lt;code&gt;节点(node)&lt;/code&gt;, 类比于文件系统的话, 节点相当于文件系统中的文件, 或目录. 不过与文件系统不同的是: 文件系统是在持久化存储设备上抽象数据存储的一层, 但ZooKeeper是把所有数据都放在内存中的.&lt;/p&gt;
&lt;h4 id=&quot;zookeeper是既快又稳的&quot;&gt;ZooKeeper是既快又稳的&lt;/h4&gt;
&lt;p&gt;数据全扔在内存里, 保证的ZooKeeper很快, 性能很好. ZooKeeper的设计实现中, 除了简单易用, 还把以下三点列进了宗旨里:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;性能要高. 要快, 所以数据扔内存里.&lt;/li&gt;
&lt;li&gt;要高可用. 要稳, 所以ZooKeeper本身是分布式的, 并且挂掉一小半实例都不影响服务.&lt;/li&gt;
&lt;li&gt;严格有序的访问. 保证客户端使用原语可以实现可靠的同步服务.&lt;/li&gt;
&lt;/ol&gt;&lt;h4 id=&quot;zookeeper本身是分布式的&quot;&gt;ZooKeeper本身是分布式的&lt;/h4&gt;
&lt;p&gt;ZooKeeper本身是分布式的. 我们把ZooKeeper寄生的多台机器集合称为一个&lt;code&gt;ensemble&lt;/code&gt;, 这个词不是很好翻译, 干脆不翻译了, 这个单词的意思和&lt;code&gt;集群&lt;/code&gt;差不多.&lt;/p&gt;
&lt;p&gt;在下图中, 每个Server是一个ZooKeeper实例进程, 每个Client是一个使用ZooKeeper服务的客户端, 这个客户端一般是另外一个分布式程序的一个实例. 一个有效的ZooKeeper服务是由多个Server构成的(实际上并没有限定每个Server独占一台机器). 每个ZooKeeper服务中的Server都必须知道其它所有Server的位置. 每个Server都在内存中保存了一些数据(in-memory image of state), 并且在磁盘上保存着&lt;code&gt;事务日志(transaction logs)&lt;/code&gt;与&lt;code&gt;快照(snapshot)&lt;/code&gt;. 只要整个ZooKeeper服务中的大多数Server正常工作着, 那么整个Server就能正常的向外提供服务.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/668722/201806/668722-20180626195615635-1771898198.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;而对于ZooKeeper的使用者, 也就是图中的Client来说, 也就是另外一个分布式应用程序(中的一个实例), 要使用ZooKeeper的服务, 只需要通过TCP连接到ZooKeeper服务中的一个Server上即可, 将这个连接置为长连接, 由Client负责TCP连接的维护, 并通过这个TCP连接向Server发送请求, 接收回应, 发送心跳, 获取监控事件等. 当Server不幸挂掉的时候, Client需要&lt;em&gt;自己来将连接切换到另外一个Server上去&lt;/em&gt;.&lt;/p&gt;
&lt;h4 id=&quot;zookeeper是严格有序的&quot;&gt;ZooKeeper是严格有序的&lt;/h4&gt;
&lt;p&gt;ZooKeeper对每次内部变更都有一个版本戳一样的机制, 这也就是简单的事务机制. 它保证了ZooKeeper整个服务对外提供的原语是原子性的, 并且是严格有序的.&lt;/p&gt;
&lt;h4 id=&quot;zookeeper很快&quot;&gt;ZooKeeper很快&lt;/h4&gt;
&lt;p&gt;当读写比例超过10:1的时候, ZooKeeper的性能表现很好. 低于这个比例的话, 可能就不是很适合使用ZooKeeper了.&lt;/p&gt;
&lt;h3 id=&quot;zookeeper中的数据模型与层级式名称空间&quot;&gt;1.1.3 ZooKeeper中的数据模型与层级式名称空间&lt;/h3&gt;
&lt;p&gt;ZooKeeper中的层级式名称空间和文件系统很类似, 每个节点都有独一无二的一个&lt;code&gt;路径&lt;/code&gt;, 和文件系统一样, 如下图所示:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/668722/201806/668722-20180626195632671-2015217586.png&quot;/&gt;&lt;/p&gt;
&lt;h4 id=&quot;长期节点与短期节点&quot;&gt;长期节点与短期节点&lt;/h4&gt;
&lt;p&gt;和文件系统不同, 每个ZooKeeper节点都有自己的数据, 而文件系统中, &lt;code&gt;目录&lt;/code&gt;是不存储数据的. ZooKeeper中的节点也被简称为&lt;code&gt;znode&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;znode本身除了数据之外, 还存储着:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;数据变更的版本号&lt;/li&gt;
&lt;li&gt;ACL变更的版本号&lt;/li&gt;
&lt;li&gt;时间戳&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;每次znode中的数据有变更, 版本号都会递增, 并且, Client向znode获取数据时, 实际上不光获取了数据本身, 还获取了数据的版本号.&lt;/p&gt;
&lt;p&gt;znode中数据的读写是原子性的, 读, 会读到整个znode中的所有数据, 写, 会替换掉znode中的所有数据. 每个znode还额外有一个ACL(访问控制表. Access Control List)来限定读写的.&lt;/p&gt;
&lt;p&gt;普通的znode是持久性的, 这意味着只要ZooKeeper服务健在, 那么这个znode就存在着. 但有一种znode不是这样的: 它随着某个创建znode的会话的开始, 被创建, 而一旦这个会话被撤除掉, 这个znode就会自动被ZooKeeper删除. 这个特性在某些场合特别有用.&lt;/p&gt;
&lt;h4 id=&quot;监控&quot;&gt;监控&lt;/h4&gt;
&lt;p&gt;ZooKeeper支持一个叫&lt;code&gt;监控(watches)&lt;/code&gt;的概念: Client可以对某个znode设置&lt;code&gt;监控&lt;/code&gt;, 当这个znode有变更的时候, 就会产生&lt;code&gt;监控事件&lt;/code&gt;, 这个事件会由ZooKeeper通知至Client, 即是Client会收到来自Server的通知.&lt;/p&gt;
&lt;p&gt;另外如果在监控过程中, Client和Server之间的连接挂掉了, 那么Client会收到一个连接挂掉的通知.&lt;/p&gt;
&lt;h3 id=&quot;zookeeper对使用者的承诺&quot;&gt;1.1.4 ZooKeeper对使用者的承诺&lt;/h3&gt;
&lt;ol&gt;&lt;li&gt;Sequential Consistency 顺序一致性. 同一个Client发送的多个请求, 会按请求发送的顺序被应用到Server上&lt;/li&gt;
&lt;li&gt;Atomicity 原子性. 请求要么成功, 要么失败, 没有中间状态&lt;/li&gt;
&lt;li&gt;Single System Image 单系统镜像. 无论Client接的是哪个Server, ZooKeeper保证Client获得的服务是完全相同的.&lt;/li&gt;
&lt;li&gt;Reliability 可靠性. 一旦一个更新操作被ZooKeeper接受且应用实施, 那么直至某个Client再次更新之前, ZooKeeper会保持住这个状态.&lt;/li&gt;
&lt;li&gt;Timeliness 及时性. ZooKeeper保证Client看到的都是及时更新的数据.&lt;/li&gt;
&lt;/ol&gt;&lt;h3 id=&quot;zookeeper的api&quot;&gt;1.1.5 ZooKeeper的API&lt;/h3&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;4&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td&gt;create&lt;/td&gt;
&lt;td&gt;在名称空间树中的指定位置创建一个节点&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td&gt;delete&lt;/td&gt;
&lt;td&gt;删除一个指定节点&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td&gt;exists&lt;/td&gt;
&lt;td&gt;查询指定节点是否存在&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;2&quot;&gt;&lt;td&gt;get data&lt;/td&gt;
&lt;td&gt;获取指定节点上的数据&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td&gt;set data&lt;/td&gt;
&lt;td&gt;向指定节点写数据&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;2&quot;&gt;&lt;td&gt;get children&lt;/td&gt;
&lt;td&gt;获取一个指定节点的所有子节点&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td&gt;sync&lt;/td&gt;
&lt;td&gt;等待数据传播完成&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h3 id=&quot;zookeeper的实现&quot;&gt;1.1.5 ZooKeeper的实现&lt;/h3&gt;
&lt;p&gt;下图是ZooKeeper的组件图: ZooKeeper是由下面图中的几个组件(component)构成的, 除了图中的&lt;code&gt;request processor(请求接收器)&lt;/code&gt;组件之外, ZooKeeper的每个Server都有着其它组件的单独实例.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/668722/201806/668722-20180626195648047-1354990106.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;code&gt;replicated database(数据库)&lt;/code&gt;, 这里的replicated是指, 这个数据库在每个Server中都有一个独立的实例. 并且每个Server中的数据库都存储着整个名称空间树, 另外注意这个数据库是内存数据库. 每当数据树要更新的时候, 都会向磁盘写入日志(为了故障恢复使用), 并且对数据树的写操作, 是先将数据序列化后写入磁盘, 再写入数据库的.&lt;/p&gt;
&lt;p&gt;每个ZooKeeper Server都对外向多个Client提供服务, 而Client只能接一个Server来收发请求回应. 当Client发出读请求的时候, 数据是直接从本地数据库返回的, 而如果Client发送的是一个写请求, 那就有点麻烦了, 这个写请求的处理要经过一个&lt;code&gt;协商协议(agreement protocol)&lt;/code&gt;的处理. 这个逻辑很自然, 因为写操作是要维持多个Server之间数据的一致性的.&lt;/p&gt;
&lt;p&gt;那么核心问题就是, 这个所谓的&lt;code&gt;agreement protocol&lt;/code&gt;是如何保证写操作全局一致的呢? 它有两个策略:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;ZooKeeper中的所有Server, 有一个是爹(leader), 其它都是儿子(follower)&lt;/li&gt;
&lt;li&gt;爹向儿子传达什么信息, 儿子毫不迟疑的执行.&lt;/li&gt;
&lt;li&gt;ZooKeeper内部有一个选爹机制, 保证在爹出现意外(进程挂死, 机器断网)的情况下, 选出一个新爹&lt;/li&gt;
&lt;li&gt;儿子接收到写请求时, 先将写请求交给爹. 之后爹再将写请求广播给所有儿子.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;ZooKeeper在消息通信上使用了一个自定义的原子消息协议, 消息协议的原子性保证了ZooKeeper中每个Server, 无论是爹还是儿子, 数据库中存储的数据都是实时的. 当爹收到由儿子递交的一个写请求后, 会做如下事情:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;对比数据库中的当前状态, 预计写操作执行后的预期状态, 把两个状态之间的差额做成一个事务请求&lt;/li&gt;
&lt;li&gt;将这个事务请求分发给所有儿子&lt;/li&gt;
&lt;/ol&gt;&lt;h3 id=&quot;zookeeper的用法&quot;&gt;1.1.6 ZooKeeper的用法&lt;/h3&gt;
&lt;p&gt;ZooKeeper的编程接口十分简单, 这部分内容会在后续章节涉及到. 简单意味着API数量少, 容易被理解, 但也有一点坏处, 就是接口能实现的功能十分基本基础, 要实现高级一点的功能, 你需要自己写逻辑, 当然这也不会十分困难.&lt;/p&gt;
&lt;h3 id=&quot;zookeeper的性能&quot;&gt;1.1.7 ZooKeeper的性能&lt;/h3&gt;
&lt;p&gt;前面吹了那么多ZooKeeper的好处, 是时候用一些证据来支撑前面吹的逼了. ZooKeeper的实际性能到底有多少? 我相信很多传统的C/C++后台开发人员在看到ZooKeeper是跑在JVM上的Java程序的时候都在内心默默的鄙视了一下ZooKeeper.&lt;/p&gt;
&lt;p&gt;但反直觉的是, 根据雅虎的ZooKeeper研发团队报告, ZooKeeper的性能确实十分强劲, 但性能强劲是有前提条件的: 那就是对数据的读取操作量远大于数据写入操作量. 当然作为一个供其它应用程序使用的协调服务, 读量大于写量应该是一个典型现象.&lt;/p&gt;
&lt;p&gt;下图是ZooKeeper的性能图表, 其中横轴是指请求量中读操作的占比, 纵轴是每秒能处理的请求量. 颜色不同的线代表ZooKeeper的实例个数(显然每个实例独占一台机器). 可以直观的看到, 在读操作占比超过80%后, ZooKeeper的吞吐量就起飞了. 并且5个实例构成的ensemble在性能的提升上对比3个实例构成的ensemble有显著提升, 但超过5之后, 增加实例个数对ZooKeeper的整体性能提升就不是很明显了. 当然这只是一个参考图表, 应用实施的时候, 各家都有各家的特殊国情, 还需要自行探究.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/668722/201806/668722-20180626195705763-2027477700.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;上面这边图的测试现场大致是这样的:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;用的ZooKeeper版本为3.2&lt;/li&gt;
&lt;li&gt;每个ZooKeeper实例独占一台机器, 每台机器双核心2GHz Xeon处理器, 磁盘两块, 磁盘的性能规格是 SATA 盘. 15K RPM. 其中一块硬盘专用于存放ZooKeeper的日志, 另一块磁盘专用于存储快照.&lt;/li&gt;
&lt;li&gt;读写的数据量均是1k字节. 模块client的机器大约有30台.&lt;/li&gt;
&lt;li&gt;ensemble被设置为爹不允许直连client.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;这大致能解释为什么ensemble中实例的数量从3到5的时候, 性能有一个飞跃: 因为3个实例组成的ensemble中, 干活的只有两个, 另外一个是爹. 变成5个实例组成的ensemble后, 干活的就有四个了, 提升了一倍.&lt;/p&gt;
&lt;h3 id=&quot;zookeeper的可靠性&quot;&gt;1.1.8 ZooKeeper的可靠性&lt;/h3&gt;
&lt;p&gt;除开吞吐量外, 使用者另外关心的一个指标就是可靠性, 下面这张图依然出自雅虎团队, 搭建了一个7个实例组成的ensemble, 然后用910个client去疯狂怼这个ZooKeeper集群, 怼ZooKeeper时其它参数和上面的性能测试一致, 不同的是写操作的比例为30%, 读操作为70%. 在怼的过程中, 依次手动模块了如下情况:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;一个儿子挂了, 被恢复&lt;/li&gt;
&lt;li&gt;另外一个儿子挂了, 被恢复&lt;/li&gt;
&lt;li&gt;爹挂了, 被恢复&lt;/li&gt;
&lt;li&gt;两个儿子挂了, 被恢复&lt;/li&gt;
&lt;li&gt;另外一个爹挂了, 被恢复&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;图中橫轴是时间, 单位是秒, 纵轴是吞吐量. 图中带圆圈的数字分别代表了有上面对应的错误发生.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/668722/201806/668722-20180626195721929-799353776.png&quot;/&gt;&lt;/p&gt;
&lt;p&gt;client共有910个, 所以比起上一张图来说, 吞吐图下降了不少. 从图中可以看出:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;单个儿子实例有异常波动基本不影响ZooKeeper的性能, 对使用者来讲, 基本感觉不到.&lt;/li&gt;
&lt;li&gt;爹挂的时候会影响ZooKeeper的性能, 但很快就能恢复. ZooKeeper在爹挂了之后重新选举一个爹的时间大致在200ms左右.&lt;/li&gt;
&lt;/ol&gt;&lt;h3 id=&quot;zookeeper的应用前景&quot;&gt;1.1.9 ZooKeeper的应用前景&lt;/h3&gt;
&lt;p&gt;ZooKeeper的版本号, 直至我翻译这个文档的时候, 稳定版已经到3.4.12了, beta版已经到3.5.4了. 能迭代到这个程序说明Apache对这个项目的态度已经显然不止于玩票了. 实际上ZooKeeper已经成功的应用在许多业界的产品上了. 雅虎用ZooKeeper做Message Broker的协调和错误恢复服务, 这应当是ZooKeeper能傍上的最粗的大腿了.雅虎的这个消息队列是一个很基础的发布-订阅消息系统, 规模很大. 受这个成功案例的影响, 雅虎里的一标广告系统在在用ZooKeeper做可靠性服务.&lt;/p&gt;
&lt;h2 id=&quot;快速上手指南&quot;&gt;1.2 快速上手指南&lt;/h2&gt;
&lt;p&gt;这一小节主要是面向开发者的, 大致阅读本小节的内容, 能让你快速上手, 在你的代码中使用上ZooKeeper的功能, 并且为了配合自测, 这一小节大致会简单的讲一下如何搭建一个由单个实例组成的ZooKeeper ensemble(仅供开发调试使用的部署模式), 并且讲几个小命令用以检测你的ZooKeeper是否搭建成功, 再附上一些代码片断帮助你直观的理解ZooKeeper接口的用法.&lt;/p&gt;
&lt;p&gt;这一节不会涉及生产环境中多Server模式的部署方法, 也不会涉及部署中的详细配置参数等. 这一节只是一个快速上手指南: 并且是面向开发人员的快速上手指南.&lt;/p&gt;
&lt;h3 id=&quot;系统要求&quot;&gt;1.2.1 系统要求&lt;/h3&gt;
&lt;p&gt;请参考第四章&lt;/p&gt;
&lt;h3 id=&quot;下载zookeeper&quot;&gt;1.2.2 下载ZooKeeper&lt;/h3&gt;
&lt;p&gt;从&lt;a href=&quot;http://zookeeper.apache.org/releases.html&quot;&gt;这里&lt;/a&gt;下载ZooKeeper的最新的稳定版.&lt;/p&gt;
&lt;h3 id=&quot;单实例模式&quot;&gt;1.2.3 单实例模式&lt;/h3&gt;
&lt;p&gt;搭一个单实例模式的ZooKeeper很简单,&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;下载ZooKeeper的安装包, 解压&lt;/li&gt;
&lt;li&gt;写一个配置文件, 建议把这个配置文件放在&lt;code&gt;zookeeper/conf/zoo.cfg&lt;/code&gt;这个位置, 配置文件是一个文本文件, 鉴于现在搭的是一个开发环境, 所以配置文件里简单的写下面这三行就可以了&lt;/li&gt;
&lt;/ol&gt;&lt;pre class=&quot;conf&quot;&gt;
&lt;code&gt;tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181&lt;/code&gt;
&lt;/pre&gt;
&lt;ol&gt;&lt;li&gt;来稍微解释一下这个配置文件中的配置项, 总共有三个
&lt;ol&gt;&lt;li&gt;&lt;code&gt;tickTime&lt;/code&gt;: 这是一个基本的时间单位, 后面的值的单位是毫秒, 比如上面我们设置为2000, 意思是一个&lt;code&gt;tickTime&lt;/code&gt;代表了2000毫秒. tickTime主要用于发送心跳, 以及默认的最小会话超时时间是两个tickTime&lt;/li&gt;
&lt;li&gt;&lt;code&gt;dataDir&lt;/code&gt;: 这个目录是用于存储内存数据库的快照的, 并且默认情况下除非特别指定, 事务日志也会存在这里&lt;/li&gt;
&lt;li&gt;&lt;code&gt;clientPort&lt;/code&gt;: 这是开发给client用于连接的端口号&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;在写完配置文件, 并且把配置文件放在&lt;code&gt;zookeeper/conf/zoo.cfg&lt;/code&gt;后, 运行&lt;code&gt;zookeeper/bin/zkServer.sh&lt;/code&gt;这个脚本就会启动一个单实例ZooKeeper服务.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;另外需要注意的还有以下几点:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;ZooKeeper用&lt;code&gt;log4j&lt;/code&gt;接口来输出运行日志. 注意这里说的是&lt;code&gt;运行日志&lt;/code&gt;, 而不是前面提到的&lt;code&gt;事务日志&lt;/code&gt;. 更多的细节在第二章会涉及. 默认情况下日志会输出至控制台, 如果你希望把日志写进一个文件里, 需要自行配置&lt;code&gt;log4j&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;注意按上面步骤搭的是一个单实例ZooKeeper服务, 没有什么可靠性可言, 生产环境中千万不要这么干, 这只是给使用ZooKeeper接口写程序的开发人员用的一个本地测试环境, 而且由于是单实例, 一旦这个唯一的ZooKeeper server进程挂了, 整个ZooKeeper服务就不可用了.&lt;/li&gt;
&lt;/ol&gt;&lt;h3 id=&quot;管理zookeeper的存储&quot;&gt;1.2.4 管理ZooKeeper的存储&lt;/h3&gt;
&lt;p&gt;ZooKeeper有两个地方使用到了本地磁盘存储, 如果你仔细阅读了之前的章节的话, 会知道这两个点分别是:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;事务日志&lt;/li&gt;
&lt;li&gt;内存数据库快照&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;生产环境建议这两个东西分开存储, 并且最好是物理上分开存储: 分别使用一块独立的硬盘. 但具体细节这一章节就不说了, 后续在运维相关的章节会讲到.&lt;/p&gt;
&lt;h3 id=&quot;连接至zookeeper服务&quot;&gt;1.2.5 连接至ZooKeeper服务&lt;/h3&gt;
&lt;p&gt;执行安装包里的这个脚本可以连接至上面搭建好的ZooKeeper本地单实例服务上去:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;$ &lt;span class=&quot;kw&quot;&gt;zookeeper/bin/zkCli.sh&lt;/span&gt; -server 127.0.0.1:2181&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;这打开了一个交互式命令行程序, 连接成功后, 大致会有类似于以下的输出:&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;Connecting to localhost:2181
log4j:WARN No appenders could be found for logger (org.apache.zookeeper.ZooKeeper).
log4j:WARN Please initialize the log4j system properly.
Welcome to ZooKeeper!
JLine support is enabled
[zkshell: 0]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;在这个命令行程序内部, 键入&lt;code&gt;help&lt;/code&gt;获取一些基本命令的用法, 比如这样:&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 0] help
ZooKeeper host:port cmd args
        get path [watch]
        ls path [watch]
        set path data [version]
        delquota [-n|-b] path
        quit
        printwatches on|off
        createpath data acl
        stat path [watch]
        listquota path
        history
        setAcl path acl
        getAcl path
        sync path
        redo cmdno
        addauth scheme auth
        delete path [version]
        setquota -n|-b val path&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;类似于mysql的命令行工具, 你可以在这个命令行工具里向ZooKeeper服务发出一些指令, 比如你想查看目前ZooKeeper的层级名称空间里都存储了些啥玩意, 你可以使用&lt;code&gt;ls&lt;/code&gt;命令&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 8] ls /
[zookeeper]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;初始状态下, 层级名称空间里啥都没有, 根&lt;code&gt;/&lt;/code&gt;下只有一个名为&lt;code&gt;zookeeper&lt;/code&gt;的节点, 也就是znode. 你可以使用命令&lt;code&gt;create&lt;/code&gt;来创建一个节点, 也就是&lt;code&gt;znode&lt;/code&gt;, 像下面这样&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 9] create /zk_test my_data
Created /zk_test&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;上面这个命令创建了一个znode, 这个znode的路径是&lt;code&gt;/zk_text&lt;/code&gt;, 并且把一个字符串&lt;code&gt;&quot;my_data&quot;&lt;/code&gt;存在了这个znode中. 现在再用&lt;code&gt;ls&lt;/code&gt;查看节点, 输出会类似如下:&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 11] ls /
[zookeeper, zk_test]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;现在根名称空间&lt;code&gt;/&lt;/code&gt;下有两个节点, 一个是默认存在的&lt;code&gt;zookeeper&lt;/code&gt;, 一个是我们刚才创建好的&lt;code&gt;zk_text&lt;/code&gt;节点.&lt;/p&gt;
&lt;p&gt;如果你想取出znode中的数据, 可以使用&lt;code&gt;get&lt;/code&gt;命令来获取, 如下:&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 12] get /zk_test
my_data
cZxid = 5
ctime = Fri Jun 05 13:57:06 PDT 2009
mZxid = 5
mtime = Fri Jun 05 13:57:06 PDT 2009
pZxid = 5
cversion = 0
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0
dataLength = 7
numChildren = 0&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;输出了不少东西, 正如我们在简介里提到的那样, 当你向znode写入数据时, znode不光会保存数据本身, 还会保存一些其它玩意, 比如数据的创建时间, 数据的版本号之类的, 上面的输出很丰富, 第一行当然是我们在创建&lt;code&gt;/zk_text&lt;/code&gt;节点时写入的字符串&lt;code&gt;&quot;my_data&quot;&lt;/code&gt;, 余下的行则是与这个数据有关的其它信息. 详细细节这里先略过.&lt;/p&gt;
&lt;p&gt;当你想修改一个znode下的数据的时候, 你可以使用&lt;code&gt;set&lt;/code&gt;命令, 就像下面这样, 我们把上面&lt;code&gt;/zk_text&lt;/code&gt;节点里的数据, 从原先的&lt;code&gt;&quot;my_data&quot;&lt;/code&gt;字符串, 修改为新字符串&lt;code&gt;&quot;junk&quot;&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 14] set /zk_test junk
cZxid = 5
ctime = Fri Jun 05 13:57:06 PDT 2009
mZxid = 6
mtime = Fri Jun 05 14:01:52 PDT 2009
pZxid = 5
cversion = 0
dataVersion = 1
aclVersion = 0
ephemeralOwner = 0
dataLength = 4
numChildren = 0&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;修改数据也会输出节点的额外信息, 接下来再用&lt;code&gt;get&lt;/code&gt;命令查看一下刚才的修改效果:&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 15] get /zk_test
junk
cZxid = 5
ctime = Fri Jun 05 13:57:06 PDT 2009
mZxid = 6
mtime = Fri Jun 05 14:01:52 PDT 2009
pZxid = 5
cversion = 0
dataVersion = 1
aclVersion = 0
ephemeralOwner = 0
dataLength = 4
numChildren = 0&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;可以看到, 数据已经被修改了.&lt;/p&gt;
&lt;p&gt;当你想删除一个znode的时候, 你可以使用&lt;code&gt;delete&lt;/code&gt;命令, 就像下面这样, 我们删除上面我们创建的&lt;code&gt;/zk_text&lt;/code&gt;节点, 在删除后再用&lt;code&gt;ls&lt;/code&gt;命令查看一下删除效果&lt;/p&gt;
&lt;pre class=&quot;text&quot;&gt;
&lt;code&gt;[zkshell: 16] delete /zk_test
[zkshell: 17] ls /
[zookeeper]
[zkshell: 18]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;你看, 这样是不是就很直观, 简介里说了一大堆, 比不上你自己动手感受一下. 在这个交互式命令行程序里的各个命令, 其它都对应着ZooKeeper API里的各个接口, 有了上面的直观认识, 再参照着编程手册使用ZooKeeper就很容易理解了.&lt;/p&gt;
&lt;h3 id=&quot;在代码中使用zookeeper&quot;&gt;1.2.6 在代码中使用ZooKeeper&lt;/h3&gt;
&lt;p&gt;ZooKeeper对外提供的API有Java版和C语言两个版本, 功能上是完全一样的. C语言的API还有两个子版本: 一个用于在单线程环境中使用, 一个用于在多线程环境中使用. 更多的具体信息请参考后续章节.&lt;/p&gt;
&lt;h3 id=&quot;搭建多实例的zookeeper-ensemble&quot;&gt;1.2.7 搭建多实例的ZooKeeper ensemble&lt;/h3&gt;
&lt;p&gt;生产环境中显然不能使用单实例的ZooKeeper, 这里简单提一下如何搭建多实例构成的ZooKeeper ensemble. 多个实例构成的ensemble中, 每个ZooKeeper server进程都有自己的内存数据库, 但所有实例的内存数据库里的内容是一毛一样的, 这也是为什么官方文档里把多实例模式的ZooKeeper ensemble称为&lt;code&gt;Replicated ZooKeeper&lt;/code&gt;的原因. 有一点小蛋疼的地方是, 每个ZooKeeper server进程在启动时都需要一个配置文件, 在多实例ZooKeeper ensemble中, 这多个实例使用的配置文件必须一毛一样, 多个实例正常情况下应当分布在多个不同的机器上, 所以这个配置文件的一致性嘛, 就需要运维部署人员手工维护了.&lt;/p&gt;
&lt;p&gt;在这篇翻译的文档里, 我始终坚持把这种多个ZooKeeper server进程构成的ZooKeeper服务称为&lt;code&gt;多实例模式ZooKeeper&lt;/code&gt;, 而不叫&lt;code&gt;集群&lt;/code&gt;, 原因是: ZooKeeper并没有严格限制你, 必须每个ZooKeeper server独占一台机器. 虽然从逻辑上讲, 多实例模式下应当为每个ZooKeeper server分配一台独立的机器, 但你非要在一台机器上启动100个ZooKeeper server, 这是完全行得通的.&lt;/p&gt;
&lt;p&gt;在多实例模式下, 实例的数量是有最低要求的: 最少要有3个实例. 并且强烈建议你, 实例的数目设定为奇数: 我们在简介中提到过, ZooKeeper服务运行时, 如果有少量实例挂掉了, 整个ZooKeeper服务还会正常运转. 这里对于&lt;code&gt;少量&lt;/code&gt;的定义, 其实就是看挂掉的实例数量有没有达到二分之一. 奇数数目的实例, 比较容易判定&lt;code&gt;二分之一&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;多实例模式下的配置文件, 依然建议放在&lt;code&gt;zookeeper/conf/zoo.cfg&lt;/code&gt;中, 内容与单实例模式稍有不同&lt;/p&gt;
&lt;pre class=&quot;conf&quot;&gt;
&lt;code&gt;tickTime=2000
dataDir=/var/lib/zookeeper
clientPort=2181
initLimit=5
syncLimit=2
server.1=zoo1:2888:3888
server.2=zoo2:2888:3888
server.3=zoo3:2888:3888&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;其中&lt;code&gt;tickTime&lt;/code&gt;, &lt;code&gt;dataDir&lt;/code&gt;, &lt;code&gt;clientPort&lt;/code&gt;三个配置项的含义这里不再重复, 新增的字段的含义如下:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;code&gt;initLimit&lt;/code&gt;: 这是一个超时时间, 它的单位是&lt;code&gt;tickTime&lt;/code&gt;, 它限制了ZooKeeper中儿子与爹建立连接的超时时间. 比如上面设置为5, 且&lt;code&gt;tickTime&lt;/code&gt;的值设置为2000毫秒, 意思是: 儿子与爹建立连接必须在10秒内完成, 超过10秒, 就会认为这个儿子废掉了.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;syncLimit&lt;/code&gt;: 这也是一个超时时间, 单位依然是&lt;code&gt;tickTime&lt;/code&gt;. 上面设置为2, 意思是指, 当儿子执行数据同步的时候, 在4秒内必须完成, 超过4秒, 就会认为这个儿子废掉了.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;server.X&lt;/code&gt;: 配置文件里共有三行这种配置, 每一行描述了当前多实例ZooKeeper服务内的一个实例. 当每个ZooKeeper server实例进程启动的时候, 它先去 &lt;code&gt;dataDir&lt;/code&gt; 目录下找一个名为&lt;code&gt;myid&lt;/code&gt;的文本文件, 这个文件里写着一个数字, 这个数字为1, 就代表当前启动的server 进程是配置文件里的&lt;code&gt;server.1&lt;/code&gt;. 然后进程就会读取配置文件里&lt;code&gt;server.1&lt;/code&gt;的值, 这里值为&lt;code&gt;zoo1:2888:3888&lt;/code&gt;, 2888是用于儿子和爹建立连接使用的端口, 3888是用于选举爹的时候使用的端口号. 注意, 如果你在一台机器上启动多个ZooKeeper server实例, 那么注意多个实例间不能使用相同的端口号.&lt;/li&gt;
&lt;/ol&gt;&lt;h3 id=&quot;简单的优化建议&quot;&gt;1.2.8 简单的优化建议&lt;/h3&gt;
&lt;p&gt;为了获取更好的性能, 建议在配置文件中额外配置一个配置项, 名为&lt;code&gt;dataLogDir&lt;/code&gt;, 值为一个目录地址. 配置该配置项之后, 会导致当前实例会将事务日志写向对应地址. 否则会直接写向&lt;code&gt;dataDir&lt;/code&gt;中去.&lt;/p&gt;
&lt;p&gt;更多的优化建议, 与更细节的多实例ZooKeeper部署指导会在后续运维章节仔细说明.&lt;/p&gt;

&lt;p&gt;// TODO&lt;/p&gt;

&lt;p&gt;// TODO&lt;/p&gt;

&lt;h2 id=&quot;系统管理员指南&quot;&gt;4.1 系统管理员指南&lt;/h2&gt;
&lt;h3 id=&quot;部署&quot;&gt;4.1.1 部署&lt;/h3&gt;
&lt;h4 id=&quot;系统要求-1&quot;&gt;4.1.1.1 系统要求&lt;/h4&gt;
&lt;h5 id=&quot;支持的操作系统平台&quot;&gt;支持的操作系统平台&lt;/h5&gt;
&lt;p&gt;ZooKeeper下有多个组件. 有些组件在各大平台上都能跑, 有些则只能跑在指定的一部分平台上. 这些组件包括:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Client. 指的是ZooKeeper的客户端库, 用于其它应用程序与ZooKeeper ensemble建立连接并使用ZooKeeper的功能&lt;/li&gt;
&lt;li&gt;Server. 指的是ZooKeeper server. 跑在ZooKeeper ensemble中各个机器上的应用程序, 也就是ZooKeeper server进程.&lt;/li&gt;
&lt;li&gt;Native Client. 一个用C语言实现的库, 功能和Client一样, 只不过面向的是C系开发者.&lt;/li&gt;
&lt;li&gt;Contrib. 其它可选的组件.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;下表展示了各个组件在各个操作系统平台上的受支持程度:&lt;/p&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;GNU/Linux&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Solaris&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;FreeBSD&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Windows&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;可用于开发及生产&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Max OS X&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;仅可用于开发&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;仅可用于开发&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;不支持&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;其它没提到的操作系统平台就自求多福吧.&lt;/p&gt;
&lt;h5 id=&quot;需要的软件&quot;&gt;需要的软件&lt;/h5&gt;
&lt;p&gt;ZooKeeper是用Java写的, 所以需要一个版本在1.6或更高的JDK. 对于多实例模式的部署建议使用多台机器.&lt;/p&gt;
&lt;h4 id=&quot;多实例模式&quot;&gt;4.1.1.2 多实例模式&lt;/h4&gt;
&lt;p&gt;我们在第一章的快速上手指南中提到过, 生产环境建议使用多实例模式部署ZooKeeper, 并且建议单个实例独占一台机器, 且建议实例的个数为奇数. 个中缘由这里不再重复.&lt;/p&gt;
&lt;p&gt;下面是如何部署多实例模式中的一个实例的步骤. 在多台机器上重复以上步骤, 就能搭起一个多实例模式的ZooKeeper服务.&lt;/p&gt;
&lt;ol readability=&quot;0&quot;&gt;&lt;li&gt;安装JDK&lt;/li&gt;
&lt;li&gt;设置Java运行时的&quot;heap size&quot;(堆容量). 额外设置这个是由于当内存不足时, swapping操作会严重拖慢zookeeper的性能(wtf? 2018年了好吧!). 一般情况下, 如果机器是zookeeper独占的, 那么内存多大就设置多大就可以了.&lt;/li&gt;
&lt;li&gt;下载ZooKeeper, 点&lt;a href=&quot;http://zookeeper.apache.org/releases.html&quot;&gt;这里&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;解压下载好的压缩包&lt;/li&gt;
&lt;li&gt;写一个配置文件, 配置文件的路径和文件名随便啥都行. 内容如下. 配置文件中各个配置项的具体含义在 &lt;code&gt;4.1.2.10 配置参数&lt;/code&gt;中有详细说明. 如下的配置文件对应的使用要求是:
&lt;ol readability=&quot;-0.5&quot;&gt;&lt;li&gt;三台机器, 每个实例独占一台机器. 实例的编号分别为&lt;code&gt;1&lt;/code&gt;, &lt;code&gt;2&lt;/code&gt;, &lt;code&gt;3&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;机器的2888端口用于儿子和爹通信, 3888端口用于爹的选举&lt;/li&gt;
&lt;li readability=&quot;2&quot;&gt;
&lt;p&gt;对外提供服务的端口号为2181&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;tickTime=2000
dataDir=/var/lib/zookeeper/
clientPort=2181
initLimit=5
syncLimit=2
server.1=zoo1:2888:3888
server.2=zoo2:2888:3888
server.3=zoo3:2888:3888&lt;/code&gt;
&lt;/pre&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;在配置文件指定的&lt;code&gt;dataDir&lt;/code&gt;路径下创建一个名为&lt;code&gt;myid&lt;/code&gt;的文件, 这是一个文本文件, 文件内容只有一个数字: 实例的编号&lt;/li&gt;
&lt;li readability=&quot;0.5&quot;&gt;
&lt;p&gt;使用类似于下面的命令行启动实例:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;kw&quot;&gt;java&lt;/span&gt; -cp zookeeper.jar:lib/log4j-1.2.15.jar:conf org.apache.zookeeper.server.quorum.QuorumPeerMain zoo.cfg&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;ol&gt;&lt;li&gt;ZooKeeper server是Java程序, 所以用&lt;code&gt;java&lt;/code&gt;命令启动&lt;/li&gt;
&lt;li&gt;-cp 参数指示JVM虚拟机去哪里找需要的class文件. 这里指定了两个jar包文件, 和一个目录地址. 用分号&lt;code&gt;:&lt;/code&gt;隔开
&lt;ol&gt;&lt;li&gt;zookeeper.jar. 这个jar包里存着ZooKeeper server的主要class文件&lt;/li&gt;
&lt;li&gt;lib/log4j-1.2.15.jar. 这个jar包里存着ZooKeeper输出运行日志所需要的&lt;code&gt;log4j&lt;/code&gt;的class文件&lt;/li&gt;
&lt;li&gt;conf. 这个目录里的jar包存着其它启动ZooKeeper所需要的class文件&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;org.apache.zookeeper.server.quorum.QuorumPeerMain&lt;/code&gt;是main函数所在的类路径&lt;/li&gt;
&lt;li&gt;&lt;code&gt;zoo.cfg&lt;/code&gt;是配置文件路径&lt;/li&gt;
&lt;li&gt;简单点, 你可以把配置文件放在&lt;code&gt;zookeeper/conf/zoo.cfg&lt;/code&gt;中, 然后直接运行&lt;code&gt;zookeeper/bin/zkServer.sh&lt;/code&gt;脚本来启动. 这个脚本中的内容更丰富. 但核心命令和上面那行基本一样. 这样的好处是很无脑, 很方便.&lt;/li&gt;
&lt;/ol&gt;&lt;/li&gt;
&lt;li readability=&quot;2&quot;&gt;
&lt;p&gt;要测试当前ZooKeeper Server实例进程是否正确运行, 可以使用下面的脚本进行测试:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;$ &lt;span class=&quot;kw&quot;&gt;bin/zkCli.sh&lt;/span&gt; -server 127.0.0.1:2181&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;单实例模式-1&quot;&gt;4.1.1.3 单实例模式&lt;/h4&gt;
&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;单实例模式一般仅用于开发自测使用, 具体的部署步骤在&lt;code&gt;1.2.3 单实例模式&lt;/code&gt;章节有描述, 请翻回去看.&lt;/p&gt;
&lt;h3 id=&quot;系统管理&quot;&gt;4.1.2 系统管理&lt;/h3&gt;
&lt;h4 id=&quot;部署设计&quot;&gt;4.1.2.1 部署设计&lt;/h4&gt;
&lt;p&gt;ZooKeeper的可靠性依赖于两个假设&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;假设你的ZooKeeper以多实例模式部署, 且每个实例占用一台机器. 这些机器在运行过程中, 不可能出现在同一时间有超过二分之一的机器宕机的可能.&lt;/li&gt;
&lt;li&gt;每台机器有网络状况与磁盘状况良好, 多实例进程启动时运行的jar包代码是一致的.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;要使第一个假设尽可能的成立, 你可以做如下的事情:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;预估你的机器宕机的频率与持续时间, 恢复时间, 算出基本不可能同时宕机的机器台数. 比如你根据去年的运维记录, 查一下去年的宕机概率, 然后根据这个概率估算出整个机房同时有指定的1台机器宕机的概率, 同时有指定的两台机器宕机的概率. 把这个概率降低到你能接受的程度, 比如你估算出你的机房中, 同时有指定的5台机器同时宕机的概率不足千万分之一, 这个你可以接受, 那么将ZooKeeper多实例的规则设置为 2*5 + 1 == 11个, 即在11台机器上部署ZooKeeper, 这样保证在估算正确的情况下, 即便有千万分之一的概率发生了同时有五台机器宕机, ZooKeeper服务依然能正常工作.&lt;/li&gt;
&lt;li&gt;尽可能的保证uklfZooKeeper的机器之间的宕机没有关联性. 比如如果你使用云主机, 尽量保证所有vm都分属不同的host, 使用实体机, 尽可能的将机器分散至多个IDC之类的.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;要使第二个假设尽可能的成立, 你可以做如下的事情:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;如果有条件, 尽可能的使部署的机器上只有一个ZooKeeper server进程.&lt;/li&gt;
&lt;li&gt;如果没有条件做到上面一条, 那么尽量避免ZooKeeper server进程与其它进程争用网络资源或存储资源. 即预留给ZooKeeper server进程足够的带宽或独占网卡, 为ZooKeeper预留足够的IO资源以及内存空间&lt;/li&gt;
&lt;li&gt;ZooKeeper里很拖性能的两个点就是写&lt;code&gt;事务日志&lt;/code&gt;与&lt;code&gt;内在数据库快照&lt;/code&gt;, 尽量将这两部分日志写向不同的物理磁盘. 即是在启动配置中, 独立配置&lt;code&gt;dataDir&lt;/code&gt;与&lt;code&gt;dataLogDir&lt;/code&gt;, 并将两个配置的路径指向不同的物理磁盘.&lt;/li&gt;
&lt;li&gt;运行时为JVM分配合理的heap size, 以防止发生swapping拖慢进程.&lt;/li&gt;
&lt;/ol&gt;&lt;h4 id=&quot;provisioning&quot;&gt;4.1.2.2 Provisioning&lt;/h4&gt;
&lt;p&gt;// TODO, 官方文档这里留空了&lt;/p&gt;
&lt;h4 id=&quot;things-to-consider-zookeeper-strengths-and-limitations&quot;&gt;4.1.2.3 Things to Consider: ZooKeeper Strengths and Limitations&lt;/h4&gt;
&lt;p&gt;// TODO, 官方文档这里留空了&lt;/p&gt;
&lt;h4 id=&quot;administering&quot;&gt;4.1.2.4 Administering&lt;/h4&gt;
&lt;p&gt;// TODO, 官方文档这里留空了&lt;/p&gt;
&lt;h4 id=&quot;运维&quot;&gt;4.1.2.5 运维&lt;/h4&gt;
&lt;p&gt;对于长期运行的ZooKeeper ensemble来说, 运维工作是必须做的, 运维人员需要注意以下几点:&lt;/p&gt;
&lt;h5 id=&quot;清理磁盘文件&quot;&gt;清理磁盘文件&lt;/h5&gt;
&lt;p&gt;ZooKeeper中有两处使用到了磁盘: &lt;code&gt;事务日志&lt;/code&gt;与&lt;code&gt;内存数据库快照&lt;/code&gt;. ZooKeeper名称空间里的节点发生变更的时候, 就会有内容写入事务日志. 通常情况下, 当单个事务日志文件变的越来越大的时候, 事务日志就需要创建一个新的文件. 但在创建新的事务日志文件之前, ZooKeeper会先把当前的内存数据库的状态写入磁盘先做快照, 然后再生成一个新的事务日志文件. 这样就保证了快照文件和事务日志文件是一一对应的. 但快照落地需要时间, 在快照落地期间如果还有事务来临, 那么这部分事务的日志依然会写向旧的事务日志文件里. 这就导致, 快照文件对应的那个事务日志文件里, 存储的事务日志可能要比当前快照文件要&lt;strong&gt;新&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;ZooKeeper server进程在默认启动的情况下, 是不会自动删除事务日志文件和快照文件的. 当然这是可配置的, 配置项分别是&lt;code&gt;autopurge.snapRetainCount&lt;/code&gt;和&lt;code&gt;autopurge.purgeInterval&lt;/code&gt;. 这两个配置项的具体含义在&lt;code&gt;4.1.2.10&lt;/code&gt;章节有详细描述. 但需要注意: 如果你要这样做, 那么最好为每台部署的机器提供不同的配置值, 除非这些机器的规格是完全一毛一样的!&lt;/p&gt;
&lt;p&gt;除过在配置文件中设定, 还有一种方法就是调用一个ZooKeeper提供的小工具, 大致如下:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;&lt;span class=&quot;kw&quot;&gt;java&lt;/span&gt; -cp zookeeper.jar:lib/log4j-1.2.15.jar:conf org.apache.zookeeper.server.PurgeTxnLog &lt;span class=&quot;kw&quot;&gt;&amp;lt;&lt;/span&gt;dataDir&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;&amp;lt;&lt;/span&gt;snapDir&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt; -n &lt;span class=&quot;kw&quot;&gt;&amp;lt;&lt;/span&gt;count&lt;span class=&quot;kw&quot;&gt;&amp;gt;&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;其中&lt;code&gt;&amp;lt;dataDir&amp;gt;&lt;/code&gt;是事务日志的保存目录, &lt;code&gt;&amp;lt;snapDir&amp;gt;&lt;/code&gt;是快照文件的保存目录, &lt;code&gt;&amp;lt;count&amp;gt;&lt;/code&gt;是要保留的个数. 建议大于3. 运行该命令后, 除过最近的&lt;code&gt;&amp;lt;count&amp;gt;&lt;/code&gt;对事务日志文件与快照文件, 其它文件都将被删除. 这是一个一次性命令. 如果你想定期清理, 那么只能自己写个脚本咯.&lt;/p&gt;
&lt;p&gt;注意两点:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;strong&gt;永远&lt;/strong&gt;不建议手动删除事务日志文件与快照文件&lt;/li&gt;
&lt;li&gt;通过配置项使ZooKeeper server自动删除, 只有在ZooKeeper版本大于3.4后才可用&lt;/li&gt;
&lt;li&gt;PrugeTxnLog工具是一个一次性工具, 如果需要定期清理, 你需要自己写一个脚本.&lt;/li&gt;
&lt;li&gt;当机器规格不同的时候, 建议按照不同规格定制不同的清楚阈值&lt;/li&gt;
&lt;/ol&gt;&lt;h5 id=&quot;清理运行日志&quot;&gt;清理运行日志&lt;/h5&gt;
&lt;p&gt;ZooKeeper用&lt;code&gt;log4j&lt;/code&gt;来输出运行日志. 如果要更改运行日志的相关配置, 你需要独立为&lt;code&gt;log4j&lt;/code&gt;提供配置文件. 建议使用&lt;code&gt;log4j&lt;/code&gt;提供的滚动日志特性, 这样就免去了清理运行日志的问题. 更多详细信息请参阅&lt;code&gt;4.1.2.8 运行日志&lt;/code&gt;&lt;/p&gt;
&lt;h4 id=&quot;监控zookeeper-server进程的死活&quot;&gt;4.1.2.6 监控ZooKeeper server进程的死活&lt;/h4&gt;
&lt;p&gt;ZooKeeper的server进程在错误发生的时候会立即自杀, ZooKeeper的设计哲学是这样的:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;单个实例挂掉, 或少量实例挂掉不影响整体服务&lt;/li&gt;
&lt;li&gt;当单个实例遇到错误的时候, 实例会立即挂掉&lt;/li&gt;
&lt;li&gt;实例被重启后会自动加入ensemble&lt;/li&gt;
&lt;li&gt;但实例不会自动重启&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;所以搞一个监控进程, 在实例进程挂掉之后将其立即拉起是一个很好的做法. 比如&lt;a href=&quot;http://cr.yp.to/daemontools.html&quot;&gt;daemontools&lt;/a&gt;或&lt;a href=&quot;https://en.wikipedia.org/wiki/Service_Management_Facility&quot;&gt;SMF&lt;/a&gt;. 还比如我们亲爱的织云.&lt;/p&gt;
&lt;h4 id=&quot;监控zookeeper-server服务的状态&quot;&gt;4.1.2.7 监控ZooKeeper server服务的状态&lt;/h4&gt;
&lt;p&gt;要监控ZooKeeper服务的状态, 有两个选择&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;用4字命令去检查. 这个在&lt;code&gt;4.1.2.11 ZooKeeper4字命令&lt;/code&gt;中有详情&lt;/li&gt;
&lt;li&gt;JMX. 这个在&lt;code&gt;4.3 JMX&lt;/code&gt;中有详情&lt;/li&gt;
&lt;/ol&gt;&lt;h4 id=&quot;运行日志&quot;&gt;4.1.2.8 运行日志&lt;/h4&gt;
&lt;p&gt;ZooKeeper使用&lt;code&gt;log4j 1.2&lt;/code&gt;来输出运行日志. 默认的配置文件在&lt;code&gt;zookeeper/conf/log4j.properties&lt;/code&gt;中. log4j的配置文件要求要么放在工作目录里, 要么放在类路径里.&lt;/p&gt;
&lt;p&gt;详情请查看&lt;code&gt;log4j&lt;/code&gt;的官方手册&lt;/p&gt;
&lt;h4 id=&quot;问题定位&quot;&gt;4.1.2.9 问题定位&lt;/h4&gt;
&lt;h5 id=&quot;由于文件损坏导致实例不能启动&quot;&gt;由于文件损坏导致实例不能启动&lt;/h5&gt;
&lt;p&gt;ZooKeeper的server进程在事务日志文件被损坏的情况下是起不来的. 这时运行日志会说在载入ZooKeeper database时出现&lt;code&gt;IOException&lt;/code&gt;. 这种情况下, 你需要做的是:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;通过四字命令&lt;code&gt;stat&lt;/code&gt;检查ensemble中的其它实例是否正常工作&lt;/li&gt;
&lt;li&gt;如果其它实例正常, 那么把当前实例&lt;code&gt;dataDir&lt;/code&gt;目录下的&lt;code&gt;version-2&lt;/code&gt;子目录中的所有文件删除, 再把&lt;code&gt;dataLogDir&lt;/code&gt;下的&lt;code&gt;version-2&lt;/code&gt;子目录下的所有文件删除, 然后重启就可以了.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;这种情况是当前实例的事务文件损坏, 不能重建内存数据库, 删除掉事务日志和数据库快照后, 当前的实例在重启后会通过其它实例拉取内在数据库, 重建事务日志和快照文件.&lt;/p&gt;
&lt;h4 id=&quot;配置参数&quot;&gt;4.1.2.10 配置参数&lt;/h4&gt;
&lt;p&gt;ZooKeeper的行为受配置文件影响. 所有同一个ensemble中的实例建议使用完全相同的配置文件. 但使用完全相同的配置文件有一个前提条件: 就是所有实例所属的机器上的磁盘布局是相同的. 磁盘布局不同意味着不同的机器下的实例在配置&lt;code&gt;dataDir&lt;/code&gt;和&lt;code&gt;dataLogDir&lt;/code&gt;的时候配置值可能有差异, 但除此之外, 一个ensemble中的所有实例的配置文件必须保证&lt;code&gt;server.x=xxxx&lt;/code&gt;这些配置值是完全一致的.&lt;/p&gt;
&lt;h5 id=&quot;最小配置&quot;&gt;最小配置&lt;/h5&gt;
&lt;p&gt;下面列出来的是要让ensemble正常工作, 每个实例都需要配置的配置项&lt;/p&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;4.5&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;clientPort&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;当前实例对外提供服务的端口号. 即是client通过该端口号连接到该实例上. 建议所有实例都配置为相同的值.&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;4&quot;&gt;&lt;td align=&quot;left&quot;&gt;dataDir&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;内在数据库快照的存储地址. 如果没有配置&lt;code&gt;dataLogDir&lt;/code&gt;的话, 该目录还会存储事务日志&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;tickTime&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;ZooKeeper中计量时间的最基本单位. 配置值的单位是毫秒&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h5 id=&quot;高级可选配置&quot;&gt;高级可选配置&lt;/h5&gt;
&lt;p&gt;下面列出来的是一此可选配置, 属于高级选项. 你可以用这些配置项进一步个性化ZooKeeper server的行为. 其中一些配置项的值可以通过在启动server进程的时候写入Java 系统属性来设置.&lt;/p&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;49.5&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;dataLogDir&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;事务日志的写入地址&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;13&quot;&gt;&lt;td align=&quot;left&quot;&gt;globalOutstandingLimit&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.globalOutstandingLimit&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;client向ZooKeeper server递交请求的速度可以比ZooKeeper server处理请求的速度快, 特别是有多个client访问同一个ZooKeeper server的时候. 通常情况下对于不能及时处理的请求, server都会将其缓存到队列中. 但这个队列也不是无限长的, 这个配置项就是在设置这个队列的长度, 默认值是1000, 超过队列长度后, 再发请求请求就会被丢弃&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;5&quot;&gt;&lt;td align=&quot;left&quot;&gt;preAllocSize&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.preAllocSize&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;为了避免频繁的seek操作, ZooKeeper的事务日志文件默认是以64M为基本单位的. 设置这个值就可以改写这个默认的块大小, 这个配置项的单位是kb&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;12&quot;&gt;&lt;td align=&quot;left&quot;&gt;snapCount&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.snapCount&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;默认值是100000, 这是指每向事务日志里记录十万个事务, 内存数据库就会被快照一次, 同时事务日志会开新文件. 但为了避免所有的ZooKeeper server在同一时刻落地快照更换事务日志文件, 为了把这个操作错开, 所以真实的值是 位于区间 [50001, 100000] 区间的一个随机数. 即是 [snapCount/2 + 1, snapCount]区间&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;9&quot;&gt;&lt;td align=&quot;left&quot;&gt;maxClientCnxns&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;同一个个client是可以和同一个ZooKeeper ensemble之间建立多个连接的, 这个配置项就是在限制同一个client与ZooKeeper ensemble之间建立的连接数. 这可以有效预防DoS攻击, 还可以预防ZooKeeper server所在的机器文件描述符耗尽. 这个值默认是60, 当这个值被设置为0时, 是取消掉这个限制的意思&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;10&quot;&gt;&lt;td align=&quot;left&quot;&gt;clientPortAddress&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;这是一个3.3版本后的新配置项, 这是一个IP地址, 当配置了之后, ZooKeeper server在监听端口的时候, 就会绑定到这个地址上. 而默认情况下, 在监听clientPort端口的时候, 绑定的是ANYADDR&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;7&quot;&gt;&lt;td align=&quot;left&quot;&gt;minSessionTimeout&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;这也是一个3.3版本后的新配置项, 这个配置项的单位是毫秒, 而不是tickTime. 指的是会话超时r的最小时间, 默认的会话超时时间是2个tickTime. 这个值可以和client协商.&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;4&quot;&gt;&lt;td align=&quot;left&quot;&gt;maxSessionTimeout&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;这依然是一个3.3版本后的新配置项. 和minSessionTimeout类似, 但这是会话超时的最大时间. 默认是20个tickTime&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;10&quot;&gt;&lt;td align=&quot;left&quot;&gt;fsync.warningthresholdms&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.fsync.warningthresholdms&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3.4版本后的一个新配置项. 这是一个时间量, 单位是毫秒, 默认是1000, 也就是一秒. 这指的是当fsync 事务日志的耗时大于1秒时, 就会向运行日志里输出一条warning日志. &lt;strong&gt;注意这个配置项只能通过Java系统属性设置&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;10&quot;&gt;&lt;td align=&quot;left&quot;&gt;autopurge.snapRetainCount&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.4版本后的一个新配置项, 当设置了该配置项后, ZooKeeper将会自动清理快照文件和对应的事务日志文件. 仅保留最近的autopurge.snapRetainCount个. 默认值是3, 最小值是3, 不能设置比3更小的值&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;8&quot;&gt;&lt;td align=&quot;left&quot;&gt;autopurge.purgeInterval&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;这是一个开关配置项, 也是一个时间配置项. 当设置为0的时候, 是关闭自动清理快照和事务日志文件的功能的意思. 当设置为1或更高的值时, 是指每隔autopurge.purgeInterval个小时, 就执行一次自动清理任务&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;9&quot;&gt;&lt;td align=&quot;left&quot;&gt;syncEnabled&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.observer.syncEnabled&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.4.6有这个配置项, 3.5.0和更高的版本有. observer在默认情况下会和participants一样记录事务日志, 落地快照. 将这个值设置为false就是关掉了observer记录事务日志落地快照的行为, 默认是true. observer和participants的概念会在&lt;code&gt;4.4&lt;/code&gt;章节介绍&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h5 id=&quot;多实例模式下的配置项&quot;&gt;多实例模式下的配置项&lt;/h5&gt;
&lt;p&gt;下面列出来的配置项是多实例模式下的一些配置项. 有一些配置项可以通过在启动server进程的时候写入Java系统属性来设置.&lt;/p&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;56.137239165329&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;13&quot;&gt;&lt;td align=&quot;left&quot;&gt;electionAlg&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;选爹算法. 0 - 原始的基于UDP的选爹算法. 1 - 不带身份认证的, 基于UDP的快速选爹算法. 2 - 带身份认证的, 基于UDP的快速选爹算法. 3 - 基于TCP的快速选爹算法. 默认值是3. 其中, 0, 1, 2被官方文档标记为了&lt;strong&gt;deprecated&lt;/strong&gt;, 也就是说, 除非有特殊需求, 不要动手配置这个配置项&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;8&quot;&gt;&lt;td align=&quot;left&quot;&gt;initLimit&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;时间值, 单位是tickTime, 指的是儿子与爹建立连接并同步数据的超时时限. 当ZooKeeper管理的数据特别多特别大的话, 建议适当增加这个配置值. 这个配置项没有默认值, 所以配置文件里必写&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;6&quot;&gt;&lt;td align=&quot;left&quot;&gt;leaderServes&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.leaderServes&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;控制爹是否也向client提供服务, 默认是允许的. 如果client的业务比较复杂的话, 建议关闭这个功能, 让爹专心管儿子&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;9&quot;&gt;&lt;td align=&quot;left&quot;&gt;server.x=[hostname]:nnnn[:nnnn]&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;ensemble中的每一个实例都要这样登记在配置文件里. x是&lt;code&gt;dataLog&lt;/code&gt;目录下的&lt;code&gt;myid&lt;/code&gt;文件里的数字, 即是实例的编号. &lt;code&gt;hostname&lt;/code&gt;是对应的实例所在的机器名, 或者直接写成IP地址, 前一个&lt;code&gt;nnnn&lt;/code&gt;是用于爹和儿子通信用的. 第二个&lt;code&gt;nnnn&lt;/code&gt; 是用于选举爹用的.&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;9.4658753709199&quot;&gt;&lt;td align=&quot;left&quot;&gt;syncLimit&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;时间值, 单位是tickTime, 儿子向爹报平安的时限, 如果儿子在超过这个时间值后没有给爹报平安, 爹就认为儿子死了. 关于initLimit和syncLimit这两个配置项之间的不同, 请参考&lt;a href=&quot;http://user.zookeeper.apache.narkive.com/Tg2s5EG3/about-initlimit-and-synclimit&quot;&gt;这个邮件列表&lt;/a&gt;里的解释. 官方文档里写的简直让人怀疑是不是复制粘贴过来的.&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;8.8504155124654&quot;&gt;&lt;td align=&quot;left&quot;&gt;group.x=nnnn[:nnnn]&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;给server实例分组. x是组编号. nnnn则是实例编号. 注意如果你给ensemble中的实例分组的话, 各个组之间不能有交集, 并且要保证所有组的并集就是整个ZooKeeper ensemble. (换句话说你不能单独为其中某一些实例分组, 所有的实例都必须从属于一个组), &lt;a href=&quot;http://zookeeper.apache.org/doc/current/zookeeperHierarchicalQuorums.html&quot;&gt;这里&lt;/a&gt;有一个例子&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;8&quot;&gt;&lt;td align=&quot;left&quot;&gt;weight.x=nnnn&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;为一个组设置权重. ZooKeeper只有在少量的一些场合才需要考虑权重, 已知的两个场合, 一个是选爹的时候, 权重影响实例投票的影响力, 另外一个是atomic broadcast protocol. 默认情况下权重值是1&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;10&quot;&gt;&lt;td align=&quot;left&quot;&gt;cnxTimeout&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.cnxTimeout&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;时间值, 单位是秒. 爹选出来后, 所有人都需要知道爹是谁, 这个时间就是选爹时每个机器都会把选爹端口打开的时间, 在这个时间内应当有一个结果, 并且结果将通知到每个实例的选爹端口上. 这个配置项仅在electionAlg的值为3时才有用. 默认值是5秒&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;16&quot;&gt;&lt;td align=&quot;left&quot;&gt;4lw.commands.whitelist&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.4lw.commands.whitelist&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;四字命令白名单, 未出现在名单上的四字命令, ZooKeeper将不处理. 默认值包括除过&lt;code&gt;wchp&lt;/code&gt;和&lt;code&gt;wchc&lt;/code&gt;两个之外的所有四字命令. 如果要设置这个配置项的值, 注意各个四字命令之间要以逗号区分, 比如: &lt;code&gt;r4lw.commands.whitelist=stat, ruok, conf, isro&lt;/code&gt;, 如果你需要开启所有四字命令, 可以简单的使用通配符&lt;code&gt;4lw.commands.whitelist=*&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;19&quot;&gt;&lt;td align=&quot;left&quot;&gt;ipReachableTimeout&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.ipReachableTimeout&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.4.11版本后的新配置项, 时间值, 单位是毫秒. 当一个server的hostname不是IP地址时, 并且恰巧DNS服务或者hosts表里这个名字后面挂着多个ip地址时, 这个值就有用了. 默认情况下, ZooKeeper会默认使用名字解析出来的第一个IP地址, 而不检查这个IP是否可达, 而如果这个值设置成了一个大于0的值, 那么ZooKeeper就会使用&lt;code&gt;InetAddress.isReachable(ipReachableTimeout)&lt;/code&gt;来判断这个IP是否可达, 如果不可达, 就换下一个, 如果全都不可达, 那么就会绝望的使用第一个IP地址&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;5&quot;&gt;&lt;td align=&quot;left&quot;&gt;tcpKeepAlive&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.tcpKeepAlive&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.4.11版本后的新配置项. 如果这个配置项被设置为true, 那么server之间用来选举的TCP连接就会被置为长连接, 默认情况下这个值是false&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h5 id=&quot;身份认证与授权相关的配置项&quot;&gt;身份认证与授权相关的配置项&lt;/h5&gt;
&lt;p&gt;下面这些配置项与身份认证授权相关.&lt;/p&gt;
&lt;p&gt;为了避免看不懂下面的配置项都在干嘛, 先大致说一下Zookeeper里的认证与授权&lt;/p&gt;
&lt;p&gt;在ZooKeeper server端, 每个znode存储两部分内容: 数据和状态. 状态中包含ACL信息. 创建一个znode会产生一个ACL表, 每个ACL记录有以下内容:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;验证模式(scheme)&lt;/li&gt;
&lt;li&gt;具体内容(id). 比如当scheme==&quot;digest&quot;的时候, id为是用户名和密码, 比如&quot;root：J0sTy9BCUKubtK1y8pkbL7qoxSw=&quot;&lt;/li&gt;
&lt;li&gt;这个ACL拥有的权限&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;ZooKeeper提供了如下几种验证模式(scheme)&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;digest. 就是用户名+密码.&lt;/li&gt;
&lt;li&gt;auth. 不使用任何id, 表示任何已确认用户&lt;/li&gt;
&lt;li&gt;ip. 用client连接至server时使用的IP地址进行验证&lt;/li&gt;
&lt;li&gt;world. 固定ID为&quot;anyone&quot;, 为所有client端开放权限&lt;/li&gt;
&lt;li&gt;super. 在这种scheme下, 对应的id拥有超级权限.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;注意的是, exists操作的getAcl操作不受ACL控制, 任何client都可以执行这两个操作.&lt;/p&gt;
&lt;p&gt;znode的权限主要有以下几种:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;create&lt;/li&gt;
&lt;li&gt;read&lt;/li&gt;
&lt;li&gt;write&lt;/li&gt;
&lt;li&gt;delete&lt;/li&gt;
&lt;li&gt;admin. 允许对本节点执行setAcl操作&lt;/li&gt;
&lt;/ol&gt;&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;7&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;14&quot;&gt;&lt;td align=&quot;left&quot;&gt;zookeeper.DigestAuthenticationProvider.superDigest&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;仅能通过Java系统属性设置&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.2版本中的新配置项. 允许管理员以超级用户的身份来访问ZooKeeper中的层级名称空间. 当以超级用户访问时, znode的ACL完全放行. 以参数&lt;code&gt;&quot;super:&amp;lt;password&amp;gt;&quot;&lt;/code&gt;来调用&lt;code&gt;org.apache.zookeeper.server.auth.DigestAuthenticationProvider&lt;/code&gt;可以生成一个超级用户. 然后用前面命令生成的&lt;code&gt;&quot;super:&amp;lt;data&amp;gt;&quot;作为Java系统属性, 在启动各个server的时候传递给进程, 就开启了这个功能. 注意当一个client通过scheme=digest的方式来认证, 并且提供的认证数据是超级用户的认证数据, 也就是前面提到的&lt;/code&gt;&quot;super:&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h5 id=&quot;实验性的配置项&quot;&gt;实验性的配置项&lt;/h5&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;2&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;4&quot;&gt;&lt;td align=&quot;left&quot;&gt;Read Only Mode Server&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;readonlymode.enabled&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;显然这个值只能有过Java系统属性来设置. 将其设置为true, 配置ZooKeeper为只读模式. 具体细节参见ZOOKEEPER-784&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h5 id=&quot;不安全的配置项&quot;&gt;不安全的配置项&lt;/h5&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;13&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;8&quot;&gt;&lt;td align=&quot;left&quot;&gt;forceSync&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.forceSync&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;默认情况下, ZooKeeper强制要求在有数据变更请求时, 先写事务日志, 再执行变更. 如果将这个配置设置为no, ZooKeeper在执行数据变更时就不会等事务日志写完再执行了.&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;8&quot;&gt;&lt;td align=&quot;left&quot;&gt;jute.maxbuffer&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;jute.maxbuffer&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;这个配置项仅能通过 Java系统属性设置. 这设置的是一个znode中能存储的数据的容量. 默认值是0xfffff, 也就是1M. 注意如果要更改这个值, 所有server都要同步更改. 注意如果你要改这个值, 请先反思一下你使用ZooKeeper的姿势是不是有点不正确&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;4&quot;&gt;&lt;td align=&quot;left&quot;&gt;skipACL&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;zookeeper.skipACL&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;跳过ACL检查, 这能带来极大的性能提升, 但很不安全&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;6&quot;&gt;&lt;td align=&quot;left&quot;&gt;quorumListenOnAllIPs&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;无&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;如果设置为true, server在监听端口的时候, 将尝试监听所有本地可用的IP+端口的组合. 默认情况下这个配置是false, 这个行为是关闭的&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h5 id=&quot;使用netty框架进行通信&quot;&gt;使用Netty框架进行通信&lt;/h5&gt;
&lt;p&gt;这是3.4版本后的一个特性. &lt;a href=&quot;http://netty.io/&quot;&gt;Netty&lt;/a&gt;是一个基于NIO的客户端-服务器通信框架, 这个框架简化了Java在网络通信层上的很多繁操作, 并且内置支持SSL和认证授权, 当然SSL和认证授权是额外的可选功能.&lt;/p&gt;
&lt;p&gt;3.4之前, ZooKeeper是直接用NIO的, 在3.4之后, NIO只是一个可选项, 但依然是默认选项, 如果要使用Netty的话, 需要把&lt;code&gt;zookeeper.serverCnxnFactory&lt;/code&gt;替换为&lt;code&gt;org.apache.zookeeper.server.NettyServerCnxnFactory&lt;/code&gt;. 你可以只在client上使用Netty, 也可以在server上使用Netty, 但通常情况下, 建议要改一起改.&lt;/p&gt;
&lt;p&gt;蛋疼的是相关的文档官方还没有写.&lt;/p&gt;
&lt;h4 id=&quot;四字命令&quot;&gt;4.1.2.11 四字命令&lt;/h4&gt;
&lt;p&gt;ZooKeeper支持一系列的四字命令, 你可以在client上通过telnte或nc直接向server发送这些四字命令.&lt;/p&gt;
&lt;p&gt;使用一个四字命令如下所示, 下面使用echo和nc将四字命令&lt;code&gt;ruok&lt;/code&gt;发送给本机的server&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;$ &lt;span class=&quot;kw&quot;&gt;echo&lt;/span&gt; ruok &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;nc&lt;/span&gt; 127.0.0.1 5111&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;下表是所有支持的四字命令, 注意有些命令仅在特定版本之后才受支持:&lt;/p&gt;
&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;27.5&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;conf&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3版本后支持. 打印出server的配置信息&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;cons&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3版本后支持. 打印出server上的所有连接/会话&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;crst&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3版本后支持. 重置有关连接/会话的统计数据&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;dump&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;这个命令只有发给ensemble中的爹有才效. 列出所有重要的会话和生命周期随会话的znode&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;envi&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;打印出server运行环境&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;9&quot;&gt;&lt;td align=&quot;left&quot;&gt;ruok&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;are you ok, 如果回复 &lt;code&gt;imok&lt;/code&gt;, 则说明这个server很健康. 如果server有问题, 则不会收到回复. 需要注意的是, 一个server回复了ruok不代表这个server在ensemble中的状态是正常的, 这仅代表server进程正常启动了. 要查看ensemble的概况需要用&lt;code&gt;stat&lt;/code&gt;命令&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;srst&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;重置server上的所有统计数据&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;srvr&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3后的新命令. 列出server的全部信息&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;stat&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;列出server的细节信息和与之相连的clients&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;wchs&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3后的新命令, 列出对该server的所有监控(watch)&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;7&quot;&gt;&lt;td align=&quot;left&quot;&gt;wchc&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3后的新命令, 列出监控这个server的所有会话, 并列出每个会话监控的名称空间路径. 注意, 在会话较多的server上, 这个命令可能会相当耗时&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;6&quot;&gt;&lt;td align=&quot;left&quot;&gt;wchp&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.3后的新命令, 列出被监控的所有层级名称空间路径, 以及相关的会话. 注意同上, 这个命令也可能会相当耗时&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;mntr&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.4后的新命令. 列出有关ensemble的一系列状态值. 通过这些状态值可以查看整个ensemble是不是正常&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;5&quot;&gt;&lt;td align=&quot;left&quot;&gt;isro&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;3.4后的新命令. 检查server是否运行在只读状态, 回复&lt;code&gt;ro&lt;/code&gt;代表server在只读状态, 回复&lt;code&gt;rw&lt;/code&gt;代表server在可读可写状态&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;5&quot;&gt;&lt;td align=&quot;left&quot;&gt;gtmk&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;获取当前的trace mask值, 以10进制64位有符号数值形式返回, 具体trace mask的含义下面会讲&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;stmk&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;设置trace mask&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;这里需要注意的有:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;mntr命令的输出大致长下面这样. 输出格式符合java属性格式, 如果你要写个脚本定时发送这个命令以监控ensemble的运行状态, 注意输出的字段的数量可能会有变化, 写脚本的时候注意这一点. 另外有一些字段是与操作系统平台相关的, 有些字段则只有爹才会回复. 输出每一行的格式是&lt;code&gt;key \t value&lt;/code&gt;, 下面是一个示例&lt;/li&gt;
&lt;/ol&gt;&lt;div class=&quot;sourceCode&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;$ &lt;span class=&quot;kw&quot;&gt;echo&lt;/span&gt; mntr &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;nc&lt;/span&gt; localhost 2185

&lt;span class=&quot;kw&quot;&gt;zk_version&lt;/span&gt;  3.4.0
&lt;span class=&quot;kw&quot;&gt;zk_avg_latency&lt;/span&gt;  0
&lt;span class=&quot;kw&quot;&gt;zk_max_latency&lt;/span&gt;  0
&lt;span class=&quot;kw&quot;&gt;zk_min_latency&lt;/span&gt;  0
&lt;span class=&quot;kw&quot;&gt;zk_packets_received&lt;/span&gt; 70
&lt;span class=&quot;kw&quot;&gt;zk_packets_sent&lt;/span&gt; 69
&lt;span class=&quot;kw&quot;&gt;zk_outstanding_requests&lt;/span&gt; 0
&lt;span class=&quot;kw&quot;&gt;zk_server_state&lt;/span&gt; leader
&lt;span class=&quot;kw&quot;&gt;zk_znode_count&lt;/span&gt;   4
&lt;span class=&quot;kw&quot;&gt;zk_watch_count&lt;/span&gt;  0
&lt;span class=&quot;kw&quot;&gt;zk_ephemerals_count&lt;/span&gt; 0
&lt;span class=&quot;kw&quot;&gt;zk_approximate_data_size&lt;/span&gt;    27
&lt;span class=&quot;kw&quot;&gt;zk_followers&lt;/span&gt;    4                   - only exposed by the Leader
&lt;span class=&quot;kw&quot;&gt;zk_synced_followers&lt;/span&gt; 4               - only exposed by the Leader
&lt;span class=&quot;kw&quot;&gt;zk_pending_syncs&lt;/span&gt;    0               - only exposed by the Leader
&lt;span class=&quot;kw&quot;&gt;zk_open_file_descriptor_count&lt;/span&gt; 23    - only available on Unix platforms
&lt;span class=&quot;kw&quot;&gt;zk_max_file_descriptor_count&lt;/span&gt; 1024   - only available on Unix platforms&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;ol&gt;&lt;li&gt;trace mask是一个64位的数值, 按位设flag表示一些运行日志开关. 另外log4j必须设置运行日志级别为&lt;code&gt;TRACE&lt;/code&gt;才能看到trace日志信息. trace mask中各位的含义如下:&lt;/li&gt;
&lt;/ol&gt;&lt;table&gt;&lt;thead/&gt;&lt;tbody readability=&quot;6.5&quot;&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0000000001&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;保留位&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0000000010&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;记录client的请求, 不包括ping&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0000000100&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;保留位&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0000001000&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;记录client的ping请求&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0000010000&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;记录来自爹的信息, 不包括ping&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0000100000&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;记录会话的创建, 销毁和核实&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;2&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0001000000&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;记录监控事件发生时向client报告的日志&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0010000000&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;记录来自爹的ping&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b0100000000&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;保留位&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;0b1000000000&lt;/td&gt;
&lt;td align=&quot;left&quot;&gt;保留位&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;默认的trace mask是&lt;code&gt;0b0100110010&lt;/code&gt;. 另外stmk的用法也稍微复杂一点, 还要注意将trace mask的值通过stmk命令传递给server的时候, 要使用大端字节序, 也就是网络序. 下面是一个使用perl调用stmk命令的例子:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;$ &lt;span class=&quot;kw&quot;&gt;perl&lt;/span&gt; -e &lt;span class=&quot;st&quot;&gt;&quot;print 'stmk', pack('q&amp;gt;', 0b0011111010)&quot;&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;nc&lt;/span&gt; localhost 2181
&lt;span class=&quot;kw&quot;&gt;250&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;调用stmk命令时, server会将设置后的trace mask以十进制数值的形式返回回来.&lt;/p&gt;
&lt;h4 id=&quot;数据文件管理&quot;&gt;4.1.2.12 数据文件管理&lt;/h4&gt;
&lt;p&gt;将事务日志文件和快照文件存储在不同的物理磁盘上, 可以提升系统性能.&lt;/p&gt;
&lt;h5 id=&quot;快照存储目录&quot;&gt;快照存储目录&lt;/h5&gt;
&lt;p&gt;配置项&lt;code&gt;dataDir&lt;/code&gt;指向的目录路径中主要存储两种文件:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;code&gt;myid&lt;/code&gt;: 这个文件里写着当前server实例的编号&lt;/li&gt;
&lt;li&gt;&lt;code&gt;snapshot.&amp;lt;zxid&amp;gt;&lt;/code&gt;: 这里存储着内存数据库的快照&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;server实例的编号用在两个场合: &lt;code&gt;myid&lt;/code&gt;文件里, 以及配置文件里的&lt;code&gt;server.X&lt;/code&gt;配置项中. 当前server实例在启动的时候, 先去配置文件里看&lt;code&gt;dataDir&lt;/code&gt;的值, 然后去找&lt;code&gt;dataDir/myid&lt;/code&gt;这个文件, 查看文件内容, 得知自己的编号, 然后在配置文件里再找对应的&lt;code&gt;server.x&lt;/code&gt;查看要开的端口号.&lt;/p&gt;
&lt;p&gt;快照文件的后缀, &lt;code&gt;&amp;lt;zxid&amp;gt;&lt;/code&gt;, 是一个事务ID. 这是在落地内存数据库这个过程开始时, 成功执行的最后一个事务的ID号, 但蛋疼的是, 在落地快照的过程中, server还在接受请求, 执行事务, 也就是在落地的过程中, 内存数据库中的数据还处于一个变动的过程中, 这就导致落地后的快照文件像是一个扭曲的文件. 像是你在用手机拍摄全景照片的过程中, 有一只猫随着你的镜头走, 然后最终拍摄出来的照片里有一只长度为17米的猫. 最终落地生成的快照文件里的数据状态可能和任何一个时刻内存数据库的状态都对不上, 就是因为这个原因. 但ZooKeeper依然可以用这种扭曲的快照文件重建内存数据库, 这是因为ZooKeeper中的update操作是幂等的, 这就保证了在扭曲的快照文件之上重放事务日志里的日志, 就可以将进程的内存状态恢复到日志结束时的那个时刻.&lt;/p&gt;
&lt;h5 id=&quot;事务日志目录&quot;&gt;事务日志目录&lt;/h5&gt;
&lt;p&gt;在有update请求的时候, server的默认行为是先写事务日志, 再执行update操作. 单个事务日志里存储的事务个数超过一个阈值的时候, 就会导致事务日志新开一个文件, 同时会导致内在数据库落地快照, 这个阈值在上面的配置项中有提. 日志文件的后缀是日志文件里第一个日志的ID&lt;/p&gt;
&lt;h5 id=&quot;文件管理&quot;&gt;文件管理&lt;/h5&gt;
&lt;p&gt;快照文件的格式和事务日志文件的格式是死的, 这就允许你从现网的server机器上将事务日志和内存快照拷贝至你的开发机, 在你的开发环境重现现网的情景, 从而进行一些调试或问题定位操作.&lt;/p&gt;
&lt;p&gt;使用旧的事务日志文件和快照文件还能重建过去某个指定时刻server的状态, &lt;code&gt;LogFormatter&lt;/code&gt;类可以用来访问事务日志文件, 以获取可读的信息. 当然使用的时候需要有管理员权限, 因为数据是加密的.&lt;/p&gt;
&lt;p&gt;server进程本来是没有删除事务日志和快照文件的能力的, 但这在3.4版本中也随着新的配置项&lt;code&gt;autopurge.snapRetainCount&lt;/code&gt;和&lt;code&gt;autopurge.purgeInterval&lt;/code&gt;添加上了.&lt;/p&gt;
&lt;h4 id=&quot;要避免的事情&quot;&gt;4.1.2.13 要避免的事情&lt;/h4&gt;
&lt;p&gt;下面是几个你应当在部署运维的时候极力避免的事情:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;ensemble中各个server使用的配置文件中, &lt;code&gt;server.X&lt;/code&gt;配置表不一致. 所有的配置文件中, 都要以&lt;code&gt;server.X&lt;/code&gt;配置项的形式列出当前ensemble中的所有server, 包括自己. 如果这个东西不一致, 会炸.&lt;/li&gt;
&lt;li&gt;事务日志目录设置不合理. 将事务日志目录指向一个IO繁忙的磁盘, 会导致server始终处于一个半死不活的状态.&lt;/li&gt;
&lt;li&gt;不正确的java heap size. 频繁的swap操作会严重拖慢性能. 保守起见, 如果你的机器有4G内存, 把java heap size设置为3G就好了.&lt;/li&gt;
&lt;li&gt;部署的时候不考虑安全性. 建议在生产环境中合理配置防火墙.&lt;/li&gt;
&lt;/ol&gt;</description>
<pubDate>Tue, 26 Jun 2018 12:01:00 +0000</pubDate>
<dc:creator>张浮生</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/neooelric/p/9230967.html</dc:identifier>
</item>
<item>
<title>Kafka: GroupCoordinator - FangJinuo</title>
<link>http://www.cnblogs.com/f1194361820/p/9230876.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/f1194361820/p/9230876.html</guid>
<description>
&lt;h2&gt;1、Kafka GroupCoordinator的核心功能及其由来&lt;/h2&gt;
&lt;p&gt;Kafka Consumer消费topic消息时，分配策略是将topic中的partition分配给Consumer，其中Consumer又是以组的方式进行管理的。一个Consumer Group订阅一个topic，最终是Group中的每一个Consumer去订阅部分的partition，Group中整个Group订阅所有的partition。&lt;/p&gt;
&lt;p&gt;       在Kafka里，用于管理Group与成员关系、协调重分配的过程，是一个被称为Coordinator的组件来完成的。并且在0.9版本之前，该协调是由ZooKeeper来完成的，从0.9开始，这个事情由Kafka Broker来完成了。&lt;/p&gt;
&lt;p&gt;       此外，每一个分区，其实是4个offset:&lt;/p&gt;
&lt;p&gt; &lt;img src=&quot;https://images2018.cnblogs.com/blog/512650/201806/512650-20180626193056065-834962108.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Leo：代表了producer提交的message set的最后一个offset&lt;/p&gt;
&lt;p&gt;HW：代表了最大可以供Consumer消费的message set的offset&lt;/p&gt;
&lt;p&gt;Current Position：代表了某个Consumer Group消费到的位置&lt;/p&gt;
&lt;p&gt;Last Committed Offset：代表了某个Consumer Group Commit的offset。&lt;/p&gt;
&lt;p&gt;其中leo，hw都不必说了，他们是存在于recovery-point-offset-checkpoint, replication-checkpoint 两个文件中的它两个都是针对于分区来说的。&lt;/p&gt;
&lt;p&gt;Current position 是有Consumer自身知道的。&lt;/p&gt;
&lt;p&gt;Last Committed Offset则是记录了Partition在某个Consumer Group的消费情况。&lt;/p&gt;

&lt;p&gt;       在0.9之前，这两个offset也是记录在zookeeper，则改为记录到内置topic __consumer_offset中了 ，这样的改变的一个重要原因是每一次消费consumer都要往zk上写一次commited offset，而kafka也要向zookeeper记录一次current position。这样给zk带来了沉重的负担，降低了消费性能。&lt;/p&gt;

&lt;p&gt;也就说，在0.9之后版本中，Kafka Broker又承担了两个角色：1）管理consumer group offset commit， 2）对Group进行协调。&lt;/p&gt;

&lt;p&gt;这两个新的特性，都是由Kafka GroupCoordinator来完成的。对于第2）个特性，Group协调工作，并不是只针对与Consumer Group，而是可以对于任何组。在Kafka 中，目前已经有两种组了： ConsumerGroup、WorkerGroup。&lt;/p&gt;
&lt;h2&gt;2、Group协调&lt;/h2&gt;
&lt;p&gt;具体来讲，是针对具备订阅关系的组进行协调。例如Consumer Group要订阅topic，那就将topic 中的partition按照某种策略分配给Group内的各个Consumer；Worker Group要订阅各个connector，那就把connector内的各个task分配给Group内的各个Worker。&lt;/p&gt;

&lt;h3&gt;2.1 Rebalance&lt;/h3&gt;
&lt;p&gt;GroupCoordinator提供了4个API来进行组协调工作：&lt;/p&gt;
&lt;p&gt;join group, sync group，leave group, heartbeat。&lt;/p&gt;
&lt;p&gt;也就是说GroupCoordinator是维持了动态的Group，然而因为这个Group是为了订阅到某种资源，所以，一旦成员数量发生了变更、或者资源数目发生了变更，需要进行资源重新分配（reblance）。此外为了跟踪各个member的状态，需要各个成员与Group Coordinator保持心跳，一旦心跳超时，也会认为该member离开了Group。&lt;/p&gt;

&lt;p&gt;为了更好的协调Group，对Group划分了状态：&lt;/p&gt;
&lt;p&gt;Dead：死了，该组将不再服务&lt;/p&gt;
&lt;p&gt;AwaitingSync：等待Member Leader进行分配状态&lt;/p&gt;
&lt;p&gt;Stable：稳定状态&lt;/p&gt;
&lt;p&gt;PreparingRebalance：等待重分配状态&lt;/p&gt;

&lt;p&gt;1）  一旦有member join group、leave group、 heartbeat timeout时，group变为PreparingRebalance状态&lt;/p&gt;
&lt;p&gt;2）  在PreparingRebalance状态下，GroupCoordinator会通知所有的Member进行rebalance。此时该group变为AwaitingSync状态。&lt;/p&gt;
&lt;p&gt;3）  在Member接收到需要rebalance时，一旦发现自己是group内所有member的leader，就开始调度assign过程。&lt;/p&gt;
&lt;p&gt;4）  所有的member在执行完rebalance请求后，发起sync group的请求给Group Coordinator。非leader的member发的数据是空，而leader member发的是分配的结果。（例如ConsumerCoordinator 回发的是每一个consumer分配到了哪些partition，WorkerCoordinator回发的是每一个work分配到了哪些task。）&lt;/p&gt;
&lt;p&gt;5）  GroupCoordinator只对leader member的响应做处理，具体说是将该分配请求的数据（bytes）发给每一个member。此时该group变为Stable状态。&lt;/p&gt;
&lt;p&gt;6）各个memebr拿到新的分配情况后，应用该分配，并进行heartbeat。&lt;/p&gt;

&lt;h3&gt;2.2 Group 内member的leader选择&lt;/h3&gt;
&lt;p&gt;member的leader选择不会频繁的发生，只会出现在两个情况：1) group是empty的组时，会在第一个member加入组是将其选为leader。2）当leader失败或者离开组时，才会重新选择leader，选择的办法很简单，只将第一个member选择leader即可。&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
&lt;span&gt;def add(memberId: String, member: MemberMetadata) {
  &lt;/span&gt;&lt;span&gt;assert&lt;/span&gt;&lt;span&gt;(supportsProtocols(member.protocols))

  &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (leaderId == &lt;span&gt;null&lt;/span&gt;&lt;span&gt;)
    leaderId &lt;/span&gt;=&lt;span&gt; memberId
  members.put(memberId, member)
}

&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; members是一个hashmap&lt;/span&gt;
&lt;span&gt;def remove(memberId: String) {
  members.remove(memberId)
  &lt;/span&gt;&lt;span&gt;if&lt;/span&gt; (memberId ==&lt;span&gt; leaderId) {
    leaderId &lt;/span&gt;= &lt;span&gt;if&lt;/span&gt;&lt;span&gt; (members.isEmpty) {
      &lt;/span&gt;&lt;span&gt;null&lt;/span&gt;&lt;span&gt;
    } &lt;/span&gt;&lt;span&gt;else&lt;/span&gt;&lt;span&gt; {
      members.keys.head
    }
  }
}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;&lt;br/&gt;  &lt;/p&gt;

&lt;h2&gt;3、Consumer commit offset存储&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;__consumer_offsets&lt;/code&gt; 是 Kafka 内部使用的一个 topic，专门用来存储 group 消费的情况，默认情况下有50个 partition，每个 partition 三个副本。&lt;/p&gt;
&lt;p&gt;具体 group 的消费情况要存储到哪一个 partition 上，是根据 Math.&lt;code&gt;abs(groupId.hashCode()) % partitionCount&lt;/code&gt;来计算（其中，&lt;code&gt;parititionCount&lt;/code&gt; 是&lt;code&gt;__consumer_offsets&lt;/code&gt;的 partition 数，默认是50个）的。&lt;/p&gt;

&lt;p&gt;对于offset commit提供了 两个api：&lt;/p&gt;
&lt;p&gt;1）   commit offset 发生在consumer消费完一次数据后进行commit时，将其存到__consumer_offsets中&lt;/p&gt;
&lt;p&gt;2）   fetch offset 任何一个客户端都可以随时的调用该请求来获取到last committed offset&lt;/p&gt;

&lt;p&gt;此外，每一个group的消费情况也不会是永久的存储到__consumer_offsets里了，也会被定期的清理掉的。&lt;/p&gt;

&lt;h2&gt;4、如何选择GroupCoordinator？&lt;/h2&gt;
&lt;p&gt;       在一个Kafka集群里，有那么多的Broker的，一旦Consumer 消费了一次数据，还得给GroupCoordinator发一个commit offset的请求，也就是说这个GroupCoordinator处理的最多的是1）接收commit offset请求，2）写offset到__consumer_offsets。所以选择哪个Broker作为Group Coordinator就比较重要了，主要依赖于第2）项了，毕竟对于1）来讲，哪一个Broker都是无可厚非的，但对于2）就不同了，如果作为GroupCoordinator的Broker与group所以对应的parition的leader不在一台机器上，又增加了各个Broker之间的网络负载。&lt;/p&gt;

&lt;p&gt;所以GroupCoordinator是选择的group在__consumer_offsets所对应的partition的leader所在的Broker上。&lt;/p&gt;

&lt;h2&gt;5、Configuration&lt;/h2&gt;
&lt;p&gt;1)     offsets.commit.required.acks, offsets.commit.timeout.ms&lt;/p&gt;
&lt;p&gt;GroupCoordinator在处理commit offset请求时，会将消费情况写到__consumer_offsets中，实际上调用的是replicaManager.appendMessage(timeout, requiredAcks,messageSet)方法。&lt;/p&gt;

&lt;p&gt;offsets.commit.required.acks,这个配置项，其实就是这个requeiredAcks参数，也就是说，这个配置项和一个producer发送数据是设置的ack是同样的作用，要求在写数据前确认ISR中有足够的replica。它的默认值是-1。&lt;/p&gt;

&lt;p&gt;offsets.commit.timeout.ms 就是这个timeout参数，默认值是 5000&lt;/p&gt;

&lt;p&gt;2）offsets.load.buffer.size&lt;/p&gt;
&lt;p&gt;读取offset segment时的batch size&lt;/p&gt;

&lt;p&gt;3）offsets在磁盘上保留多久：offsets.retention.check.interval.ms, offset.retention.minutes&lt;/p&gt;
&lt;p&gt;4）offsets.topic.num.parititons, offsets.topic.replication.factor, offsets.topic.segment.bytes，offsets.topic.compression.codec&lt;/p&gt;
&lt;p&gt;__consumer_offset Topic的分区数，复制因子，段大小，压缩方式&lt;/p&gt;

&lt;p&gt;5) Group成员到GroupCoordinator的session的时间配置：group.max.session.timeout.ms, group.min.session.timeout.ms&lt;/p&gt;
&lt;p&gt;Broker中执行heartbeat检查是基于member 的sessiontimeout + member.lastheartbeat作为heartbeat的deadline的。也就是说完全由member自身来控制的。&lt;/p&gt;

&lt;p&gt;那么这两个配置项有啥用呢？只是划定一个范围，用于规范member的sesssion timeout配置的，怎么理解呢？&lt;/p&gt;
&lt;p&gt;在handleJoinGroup请求时，基于这两个配置，来验证member的session timeout是否在这两个值的范围内，没有其他的作用。&lt;/p&gt;
</description>
<pubDate>Tue, 26 Jun 2018 11:35:00 +0000</pubDate>
<dc:creator>FangJinuo</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/f1194361820/p/9230876.html</dc:identifier>
</item>
<item>
<title>【java提高】---java反射机制 - 雨点的名字</title>
<link>http://www.cnblogs.com/qdhxhz/p/9230805.html</link>
<guid isPermaLink="true" >http://www.cnblogs.com/qdhxhz/p/9230805.html</guid>
<description>
&lt;h2&gt;&lt;span&gt;一、概述&lt;/span&gt;&lt;/h2&gt;
&lt;h4&gt;&lt;span&gt;1、什么是反射机制&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;       反射机制是&lt;span&gt;在运行状态&lt;/span&gt;中&lt;span&gt;，对于任意一个类，都能够知道这个类的所有属性和方法&lt;/span&gt;；&lt;span&gt;对于任意一个对象，都能够调用它的任意一个方法和属性&lt;/span&gt;；这种动态获取的信息以及动态调用对象的方法的功能称为java语言的反射机制。&lt;/p&gt;
&lt;h4&gt;&lt;span&gt;2、反射机制能做什么&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;反射机制主要提供了以下功能：&lt;/p&gt;
&lt;p&gt;        1) 在运行时判断任意一个对象所属的类；&lt;/p&gt;
&lt;p&gt;        2) 在运行时构造任意一个类的对象；&lt;/p&gt;
&lt;p&gt;        3) 在运行时判断任意一个类所具有的成员变量和方法；&lt;/p&gt;
&lt;p&gt;        4) 在运行时调用任意一个对象的方法；&lt;/p&gt;
&lt;p&gt;        5) 生成动态代理。&lt;/p&gt;
&lt;h4&gt;&lt;span&gt;3、反射的优点和缺点&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;为什么要用反射机制？直接创建对象不就可以了吗，这就涉及到了动态与静态的概念：&lt;/p&gt;
&lt;p&gt;        &lt;strong&gt;静态编译&lt;/strong&gt;：在编译时确定类型，绑定对象,即通过。&lt;/p&gt;
&lt;p&gt;        &lt;strong&gt;动态编译&lt;/strong&gt;：运行时确定类型，绑定对象。动态编译最大限度发挥了java的灵活性，体现了多态的应用，有以降低类之间的藕合性。&lt;/p&gt;
&lt;p&gt;一句话，&lt;span&gt;反射机制的优点就是可以实现动态创建对象和编译，体现出很大的灵活性&lt;/span&gt;，特别是在J2EE的开发中它的灵活性就表现的十分明显。&lt;/p&gt;
&lt;p&gt;比如，一个大型的软件，不可能一次就把把它设计的很完美，当这个程序编译后，发布了，当发现需要更新某些功能时，我们不可能要用户把以前的卸载，再重新安装新的版本，假如 这样的话，这个软件肯定是没有多少人用的。采用静态的话，需要把整个程序重新编译一次才可以实现功能的更新，&lt;/p&gt;
&lt;p&gt;而采用反射机制的话，它就可以不用卸载，只需要在运行时才动态的创建和编译，就可以实现该功 能。 &lt;/p&gt;
&lt;p&gt;它的&lt;span&gt;缺点是对性能有影响&lt;/span&gt;。使用反射基本上是一种&lt;span&gt;解释操作&lt;/span&gt;，&lt;span&gt;我们可以告诉JVM，我们希望做什么并且它 满足我们的要求。这类操作总是慢于只直接执行相同的操作。&lt;/span&gt; &lt;/p&gt;
&lt;h4&gt;&lt;span&gt;4、反射的原理&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;        JAVA语言编译之后会生成一个.class文件，这些 Class 对象承载了这个类型的父类、接口、构造函数、方法、属性等原始信息，这些 class 文件在程序运行时会被 ClassLoader 加载到虚拟机中。&lt;/p&gt;
&lt;p&gt;&lt;span&gt;反射就是通过字节码文件找到某一个类、类中的方法以及属性等&lt;/span&gt;。&lt;/p&gt;
&lt;h4&gt;&lt;span&gt;5、反射的应用场景&lt;/span&gt;&lt;/h4&gt;
&lt;p&gt;个人觉得使用反射机制的一些地方：&lt;/p&gt;
&lt;p&gt;      1) 工厂模式：Factory类中用反射的话，添加了一个新的类之后，就不需要再修改工厂类Factory了&lt;/p&gt;
&lt;p&gt;      2) 动态代理模式&lt;/p&gt;
&lt;p&gt;      3) 数据库JDBC中通过Class.forName(Driver).来获得数据库连接驱动&lt;/p&gt;
&lt;p&gt;      4) 分析类文件：毕竟能得到类中的方法等等&lt;/p&gt;

&lt;h2&gt;&lt;span&gt;二、反射常用方法&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;利用反射机制能获得类的所有信息 ，类中有什么信息，它就可以获得什么信息。&lt;/p&gt;
&lt;p&gt;反射的实现主要借助以下四个类&lt;/p&gt;
&lt;p&gt;       &lt;strong&gt;Class&lt;/strong&gt;：类的对象&lt;/p&gt;
&lt;p&gt;       &lt;strong&gt;Constructor&lt;/strong&gt;：类的构造方法&lt;/p&gt;
&lt;p&gt;       &lt;strong&gt;Field&lt;/strong&gt;：类中的属性对象&lt;/p&gt;
&lt;p&gt;       &lt;strong&gt;Method&lt;/strong&gt;：类中的方法对象&lt;/p&gt;
&lt;p&gt;我们知道所有类的对象其实都是Class的实例，所以要获得对象，首先要获得class实例&lt;/p&gt;
&lt;h4&gt;&lt;span&gt;1、获得class实例三种方法&lt;/span&gt;&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
Class&amp;lt;?&amp;gt; demo1=Class.forName(&quot;com.jincou.study.Demo&quot;); &lt;span&gt;//&lt;/span&gt;&lt;span&gt;一般推荐这种&lt;/span&gt;
Class&amp;lt;?&amp;gt; demo2=&lt;span&gt;new&lt;/span&gt;&lt;span&gt; Demo().getClass();
Class&lt;/span&gt;&amp;lt;?&amp;gt; demo3=Demo.&lt;span&gt;class&lt;/span&gt;;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;获得class对象后，我们就可以通过class对象获得实际对象&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;33&quot;&gt;
&lt;pre&gt;
Demo obj=(Demo)demo1.newInstance();&lt;span&gt;//&lt;/span&gt;&lt;span&gt;创建对象的实例，这里需要一个无参的构造函数 &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;OK，有了对象就什么都好办了，想要什么信息就有什么信息了。&lt;/p&gt;
&lt;h4&gt;&lt;span&gt;2、获得构造函数&lt;/span&gt;&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;35&quot;&gt;
&lt;pre&gt;
Constructor getConstructor(Class[] params)&lt;span&gt;//&lt;/span&gt;&lt;span&gt;根据指定参数获得public构造器&lt;/span&gt;
Constructor[] getConstructors()           &lt;span&gt;//&lt;/span&gt;&lt;span&gt;获得public的所有构造器&lt;/span&gt;
Constructor getDeclaredConstructor(Class[] params)&lt;span&gt;//&lt;/span&gt;&lt;span&gt;根据指定参数获得public和非public的构造器&lt;/span&gt;
Constructor[] getDeclaredConstructors()   &lt;span&gt;//&lt;/span&gt;&lt;span&gt;获得public的所有构造器&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;&lt;span&gt;3、获得类方法&lt;/span&gt;&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;37&quot;&gt;
&lt;pre&gt;
Method getMethod(String name, Class[] params)         &lt;span&gt;//&lt;/span&gt;&lt;span&gt;根据方法名，参数类型获得方法&lt;/span&gt;
Method[] getMethods()         &lt;span&gt;//&lt;/span&gt;&lt;span&gt;获得所有的public方法&lt;/span&gt;
Method getDeclaredMethod(String name, Class[] params) &lt;span&gt;//&lt;/span&gt;&lt;span&gt;根据方法名和参数类型，获得public和非public的方法&lt;/span&gt;
Method[] getDeclaredMethods() &lt;span&gt;//&lt;/span&gt;&lt;span&gt;获得所以的public和非public方法 &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4&gt;&lt;span&gt;4、获得类中属性&lt;/span&gt;&lt;/h4&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;34&quot;&gt;
&lt;pre&gt;
Field getField(String name)  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;根据变量名得到相应的public变量&lt;/span&gt;
Field[] getFields()          &lt;span&gt;//&lt;/span&gt;&lt;span&gt;获得类中所以public的方法&lt;/span&gt;
Field getDeclaredField(String name)&lt;span&gt;//&lt;/span&gt;&lt;span&gt;根据方法名获得public和非public变量&lt;/span&gt;
Field[] getDeclaredFields()  &lt;span&gt;//&lt;/span&gt;&lt;span&gt;获得类中所有的public和非public方法&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;h2&gt;&lt;span&gt;三、综合小案例&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;上面的都是讲解理论，主要是日后可以当做自己的查找的API来用，下面来一个综合小案例来加深对它的理解：&lt;/p&gt;
&lt;div class=&quot;cnblogs_code&quot; readability=&quot;47&quot;&gt;
&lt;pre&gt;
&lt;span&gt;package&lt;/span&gt;&lt;span&gt; com.jincou.study;

&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; java.lang.reflect.Constructor;  
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; java.lang.reflect.Field;  
&lt;/span&gt;&lt;span&gt;import&lt;/span&gt;&lt;span&gt; java.lang.reflect.Method;  

&lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;class&lt;/span&gt;&lt;span&gt; Main {  
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * 为了看清楚Java反射部分代码，所有异常我都最后抛出来给虚拟机处理！ 
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; main(String[] args) &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception {  

        System.out.println(&lt;/span&gt;&quot;Demo1===============================================&quot;&lt;span&gt;);    
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo1.  通过Java反射机制得到类的包名和类名  &lt;/span&gt;
&lt;span&gt;        Demo1();  
        
        System.out.println(&lt;/span&gt;&quot;Demo2===============================================&quot;&lt;span&gt;);  
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo2.  验证所有的类都是Class类的实例对象  &lt;/span&gt;
&lt;span&gt;        Demo2();  
       
        System.out.println(&lt;/span&gt;&quot;Demo3===============================================&quot;&lt;span&gt;);     
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo3.  通过Java反射机制，用Class 创建类对象[这也就是反射存在的意义所在]，无参构造  &lt;/span&gt;
&lt;span&gt;        Demo3();  
       
        System.out.println(&lt;/span&gt;&quot;Demo4===============================================&quot;&lt;span&gt;);  
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo4:  通过Java反射机制得到一个类的构造函数，并实现构造带参实例对象  &lt;/span&gt;
&lt;span&gt;        Demo4();  
          
        System.out.println(&lt;/span&gt;&quot;Demo5===============================================&quot;&lt;span&gt;);    
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo5:  通过Java反射机制操作成员变量, set 和 get  &lt;/span&gt;
&lt;span&gt;        Demo5();  
        
        System.out.println(&lt;/span&gt;&quot;Demo6===============================================&quot;&lt;span&gt;);     
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo6: 通过Java反射机制得到类的一些属性： 继承的接口，父类，函数信息，成员信息，类型等  &lt;/span&gt;
&lt;span&gt;        Demo6();  
        
        System.out.println(&lt;/span&gt;&quot;Demo7===============================================&quot;&lt;span&gt;);    
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo7: 通过Java反射机制调用类中方法  &lt;/span&gt;
&lt;span&gt;        Demo7();  
       
        System.out.println(&lt;/span&gt;&quot;Demo8===============================================&quot;&lt;span&gt;);   
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;Demo8: 通过Java反射机制获得类加载器  &lt;/span&gt;
&lt;span&gt;        Demo8();  
                    
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo1: 通过Java反射机制得到类的包名和类名 
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; Demo1()  
    {  
        Person person &lt;/span&gt;= &lt;span&gt;new&lt;/span&gt;&lt;span&gt; Person();  
        System.out.println(&lt;/span&gt;&quot;包名:&quot; +&lt;span&gt; person.getClass().getPackage().getName());  
        System.out.println(&lt;/span&gt;&quot;完整类名:&quot; +&lt;span&gt; person.getClass().getName()); 
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo2: 验证所有的类都是Class类的实例对象 
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Demo2() &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; ClassNotFoundException  
    {  
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;定义两个类型都未知的Class , 设置初值为null, 看看如何给它们赋值成Person类  &lt;/span&gt;
        Class&amp;lt;?&amp;gt; class1 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        Class&lt;/span&gt;&amp;lt;?&amp;gt; class2 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
          
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;写法1, 可能抛出 ClassNotFoundException [多用这个写法]  &lt;/span&gt;
        class1 = Class.forName(&quot;com.jincou.study.Person&quot;&lt;span&gt;);  
        System.out.println(&lt;/span&gt;&quot;(写法1) 包名: &quot; + class1.getPackage().getName() + &quot;，&quot;   
                + &quot;完整类名: &quot; +&lt;span&gt; class1.getName());  
          
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;写法2  &lt;/span&gt;
        class2 = Person.&lt;span&gt;class&lt;/span&gt;&lt;span&gt;;  
        System.out.println(&lt;/span&gt;&quot;(写法2) 包名: &quot; + class2.getPackage().getName() + &quot;，&quot;   
                + &quot;完整类名: &quot; +&lt;span&gt; class2.getName());  
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo3: 通过Java反射机制，用Class 创建类对象[这也就是反射存在的意义所在]   
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Demo3() &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception 
    {  
        Class&lt;/span&gt;&amp;lt;?&amp;gt; class1 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        class1 &lt;/span&gt;= Class.forName(&quot;com.jincou.study.Person&quot;&lt;span&gt;);  
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;由于这里不能带参数，所以你要实例化的这个类Person，一定要有无参构造函数哈～  &lt;/span&gt;
        Person person =&lt;span&gt; (Person) class1.newInstance();  
        person.setAge(&lt;/span&gt;20&lt;span&gt;);  
        person.setName(&lt;/span&gt;&quot;张三&quot;&lt;span&gt;);  
        System.out.println(&lt;/span&gt;&quot;name: &quot; + person.getName() + &quot; age: &quot; +&lt;span&gt; person.getAge());  
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo4: 通过Java反射机制得到一个类的构造函数，并实现创建带参实例对象  
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Demo4() &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception  
    {  
        Class&lt;/span&gt;&amp;lt;?&amp;gt; class1 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        Person person1 &lt;/span&gt;= &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        Person person2 &lt;/span&gt;= &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
          
        class1 &lt;/span&gt;= Class.forName(&quot;com.jincou.study.Person&quot;&lt;span&gt;);  
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;得到一系列构造函数集合  &lt;/span&gt;
        Constructor&amp;lt;?&amp;gt;[] constructors =&lt;span&gt; class1.getConstructors();           
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;无参构造函数&lt;/span&gt;
        person1 = (Person) constructors[0&lt;span&gt;].newInstance();  
        person1.setAge(&lt;/span&gt;30&lt;span&gt;);  
        person1.setName(&lt;/span&gt;&quot;李四&quot;&lt;span&gt;);
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;有参构造函数&lt;/span&gt;
        person2 = (Person) constructors[1].newInstance(20,&quot;王五&quot;&lt;span&gt;);  
          
        System.out.println(&lt;/span&gt;&quot;name: &quot; + person1.getName() + &quot; age: &quot; +&lt;span&gt; person1.getAge() );  
        System.out.println(&lt;/span&gt;&quot;name: &quot; + person2.getName() + &quot; age: &quot; +&lt;span&gt; person2.getAge() );     
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo5: 通过Java反射机制操作成员变量, set 和 get 
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Demo5() &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception
    {  
        Class&lt;/span&gt;&amp;lt;?&amp;gt; class1 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        class1 &lt;/span&gt;= Class.forName(&quot;com.jincou.study.Person&quot;&lt;span&gt;);  
        Object obj &lt;/span&gt;=&lt;span&gt; class1.newInstance();  
        
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;获取com.jincou.study.Person.name的属性名&lt;/span&gt;
        Field personNameField = class1.getDeclaredField(&quot;name&quot;&lt;span&gt;);  
        personNameField.setAccessible(&lt;/span&gt;&lt;span&gt;true&lt;/span&gt;&lt;span&gt;);  
        personNameField.set(obj, &lt;/span&gt;&quot;张三&quot;&lt;span&gt;);  
                   
        System.out.println(&lt;/span&gt;&quot;修改属性之后得到属性变量的值：&quot; +&lt;span&gt; personNameField.get(obj));        
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo6: 通过Java反射机制得到类的一些属性： 继承的接口，父类，函数信息，成员信息，类型等  
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Demo6() &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; ClassNotFoundException  
    {  
        Class&lt;/span&gt;&amp;lt;?&amp;gt; class1 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        class1 &lt;/span&gt;= Class.forName(&quot;com.jincou.study.SuperMan&quot;&lt;span&gt;);  
          
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;取得父类名称  &lt;/span&gt;
        Class&amp;lt;?&amp;gt;  superClass =&lt;span&gt; class1.getSuperclass();  
        System.out.println(&lt;/span&gt;&quot;SuperMan类的父类名: &quot; +&lt;span&gt; superClass.getName());  
          
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;取得属性信息         &lt;/span&gt;
        Field[] fields =&lt;span&gt; class1.getDeclaredFields();  
        &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; (&lt;span&gt;int&lt;/span&gt; i = 0; i &amp;lt; fields.length; i++&lt;span&gt;) {  
            System.out.println(&lt;/span&gt;&quot;类中的成员: &quot; +&lt;span&gt; fields[i]);  
        }  
            
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;取得类方法  &lt;/span&gt;
        Method[] methods =&lt;span&gt; class1.getDeclaredMethods();  
       
       &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt; 取得SuperMan类的方法&lt;/span&gt;
            System.out.println(&quot;函数名：&quot; + methods[0&lt;span&gt;].getName());   
            System.out.println(&lt;/span&gt;&quot;函数代码写法： &quot; + methods[0&lt;span&gt;]);  
                      
        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;取得类实现的接口,因为接口类也属于Class,所以得到接口中的方法也是一样的方法得到哈  &lt;/span&gt;
        Class&amp;lt;?&amp;gt; interfaces[] =&lt;span&gt; class1.getInterfaces();  
        &lt;/span&gt;&lt;span&gt;for&lt;/span&gt; (&lt;span&gt;int&lt;/span&gt; i = 0; i &amp;lt; interfaces.length; i++&lt;span&gt;) {  
            System.out.println(&lt;/span&gt;&quot;实现的接口类名: &quot; +&lt;span&gt; interfaces[i].getName() );  
        }  
          
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo7: 通过Java反射机制调用类方法 
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Demo7() &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; Exception  
    {  
        Class&lt;/span&gt;&amp;lt;?&amp;gt; class1 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        class1 &lt;/span&gt;= Class.forName(&quot;com.jincou.study.SuperMan&quot;&lt;span&gt;);  
          
       &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;调用fly()方法&lt;/span&gt;
        Method method = class1.getMethod(&quot;fly&quot;&lt;span&gt;);  
        method.invoke(class1.newInstance());  

        &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;调用walk(int m)方法  &lt;/span&gt;
        method = class1.getMethod(&quot;walk&quot;,&lt;span&gt;int&lt;/span&gt;.&lt;span&gt;class&lt;/span&gt;&lt;span&gt;);  
        method.invoke(class1.newInstance(),&lt;/span&gt;100&lt;span&gt;);  
    }  
      
    &lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt; 
     * Demo8: 通过Java反射机制得到类加载器信息 
     &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
    &lt;span&gt;public&lt;/span&gt; &lt;span&gt;static&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; Demo8() &lt;span&gt;throws&lt;/span&gt;&lt;span&gt; ClassNotFoundException  
    {  
        Class&lt;/span&gt;&amp;lt;?&amp;gt; class1 = &lt;span&gt;null&lt;/span&gt;&lt;span&gt;;  
        class1 &lt;/span&gt;= Class.forName(&quot;com.jincou.study.SuperMan&quot;&lt;span&gt;);  
        String nameString &lt;/span&gt;=&lt;span&gt; class1.getClassLoader().getClass().getName();  
          
        System.out.println(&lt;/span&gt;&quot;类加载器类名: &quot; +&lt;span&gt; nameString);  
    }  
                
}  
&lt;/span&gt;&lt;span&gt;/**&lt;/span&gt;&lt;span&gt;
 * Person类 
 &lt;/span&gt;&lt;span&gt;*/&lt;/span&gt;  
&lt;span&gt;class&lt;/span&gt;&lt;span&gt;  Person{  
    &lt;/span&gt;&lt;span&gt;private&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; age;  
    &lt;/span&gt;&lt;span&gt;private&lt;/span&gt;&lt;span&gt; String name;  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; Person(){  
          
    }  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; Person(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; age, String name){  
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.age =&lt;span&gt; age;  
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.name =&lt;span&gt; name;  
    }  
  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;int&lt;/span&gt;&lt;span&gt; getAge() {  
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; age;  
    }  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setAge(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; age) {  
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.age =&lt;span&gt; age;  
    }  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt;&lt;span&gt; String getName() {  
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; name;  
    }  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; setName(String name) {  
        &lt;/span&gt;&lt;span&gt;this&lt;/span&gt;.name =&lt;span&gt; name;  
    }  
}  
 
 &lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;SuperMan类&lt;/span&gt;
&lt;span&gt;class&lt;/span&gt; SuperMan &lt;span&gt;extends&lt;/span&gt; Person &lt;span&gt;implements&lt;/span&gt;&lt;span&gt; ActionInterface  
{  
    &lt;/span&gt;&lt;span&gt;private&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt;&lt;span&gt; BlueBriefs;  
      
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt;&lt;span&gt; fly()  
    {  
        System.out.println(&lt;/span&gt;&quot;我是fly方法......&quot;&lt;span&gt;);  
    }  
      
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;boolean&lt;/span&gt;&lt;span&gt; isBlueBriefs() {  
        &lt;/span&gt;&lt;span&gt;return&lt;/span&gt;&lt;span&gt; BlueBriefs;  
    }  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; setBlueBriefs(&lt;span&gt;boolean&lt;/span&gt;&lt;span&gt; blueBriefs) {  
        BlueBriefs &lt;/span&gt;=&lt;span&gt; blueBriefs;  
    }  
  
    @Override  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; walk(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; m) {  
        System.out.println(&lt;/span&gt;&quot;我是walk方法，我的int值为：&quot; +&lt;span&gt; m );  
    }  
} 
&lt;/span&gt;&lt;span&gt;//&lt;/span&gt;&lt;span&gt;ActionInterface接口&lt;/span&gt;
&lt;span&gt;interface&lt;/span&gt;&lt;span&gt; ActionInterface{  
    &lt;/span&gt;&lt;span&gt;public&lt;/span&gt; &lt;span&gt;void&lt;/span&gt; walk(&lt;span&gt;int&lt;/span&gt;&lt;span&gt; m);  
}  &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;查看运行结果：&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://images2018.cnblogs.com/blog/1090617/201806/1090617-20180626191246157-1405665499.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;  &lt;strong&gt;想太多，做太少，中间的落差就是烦恼。想没有烦恼，要么别想，要么多做。中校【2】&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt;

</description>
<pubDate>Tue, 26 Jun 2018 11:19:00 +0000</pubDate>
<dc:creator>雨点的名字</dc:creator>
<dc:language>zh-cn</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.cnblogs.com/qdhxhz/p/9230805.html</dc:identifier>
</item>
</channel>
</rss>