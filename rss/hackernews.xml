<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=hnrss.org%2Fnewest%3Fpoints%3D200&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://hnrss.org/newest?points=200" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>Hacker News: Newest</title>
<link>https://news.ycombinator.com/newest</link>
<description>Hacker News RSS</description>
<item>
<title>Fewer toys at once may help toddlers to focus better and play more creatively</title>
<link>http://www.sciencedirect.com/science/article/pii/S0163638317301613</link>
<guid isPermaLink="true" >http://www.sciencedirect.com/science/article/pii/S0163638317301613</guid>
<description>&lt;div readability=&quot;13.971830985915&quot;&gt;


&lt;div class=&quot;publicationCover cover2&quot;&gt;&lt;a querystr=&quot;?zone=publicationLogo&quot; class=&quot;cLink&quot; href=&quot;http://www.sciencedirect.com/science/journal/01636383/50/supp/C&quot;&gt;&lt;img alt=&quot;Cover image&quot; src=&quot;https://ars.els-cdn.com/content/image/S01636383.gif&quot; class=&quot;toprightlogo&quot;/&gt;&lt;noscript&gt;
&lt;p&gt;&lt;img alt=&quot;Cover image&quot; src=&quot;https://ars.els-cdn.com/content/image/S01636383.gif&quot; class=&quot;toprightlogo&quot;/&gt;&lt;/p&gt;
&lt;/noscript&gt;&lt;/a&gt;&lt;/div&gt;
&lt;/div&gt;&lt;div id=&quot;frag_2&quot; data-fid=&quot;2&quot; readability=&quot;41&quot;&gt;&lt;div class=&quot;abstract svAbstract   abstractHighlights&quot; data-etype=&quot;ab&quot;&gt;
&lt;h2 class=&quot;secHeading&quot; id=&quot;author-highlightsabs00051&quot;&gt;Highlights&lt;/h2&gt;

&lt;dl class=&quot;listitem&quot; id=&quot;list_lis0005&quot; readability=&quot;0&quot;&gt;&lt;dt class=&quot;label&quot;&gt;•&lt;/dt&gt;
&lt;dd readability=&quot;-1&quot;&gt;
&lt;p id=&quot;par0005&quot;&gt;An abundance of toys present reduced quality of toddlers’ play.&lt;/p&gt;
&lt;/dd&gt;
&lt;dt class=&quot;label&quot;&gt;•&lt;/dt&gt;
&lt;dd readability=&quot;-1&quot;&gt;
&lt;p id=&quot;par0010&quot;&gt;Fewer toys at once may help toddlers to focus better and play more creatively.&lt;/p&gt;
&lt;/dd&gt;
&lt;dt class=&quot;label&quot;&gt;•&lt;/dt&gt;
&lt;dd readability=&quot;-1&quot;&gt;
&lt;p id=&quot;par0015&quot;&gt;This can done in many settings to support development and promote healthy play.&lt;/p&gt;
&lt;/dd&gt;
&lt;/dl&gt;&lt;/div&gt;
&lt;div class=&quot;abstract svAbstract&quot; data-etype=&quot;ab&quot; readability=&quot;23&quot;&gt;
&lt;h2 class=&quot;secHeading&quot; id=&quot;authorabs00101&quot;&gt;Abstract&lt;/h2&gt;
&lt;p id=&quot;spar0040&quot;&gt;We tested the hypothesis that an environment with fewer toys will lead to higher quality of play for toddlers. Each participant (n = 36) engaged in supervised, individual free play sessions under two conditions: &lt;em&gt;Four Toy&lt;/em&gt; and &lt;em&gt;Sixteen To&lt;/em&gt;y. With fewer toys, participants had fewer incidences of toy play, longer durations of toy play, and played with toys in a greater variety of ways (&lt;em&gt;Z&lt;/em&gt; = −4.448, &lt;em&gt;p &amp;lt;&lt;/em&gt; 0.001, &lt;em&gt;r&lt;/em&gt; = −0.524; &lt;em&gt;Z&lt;/em&gt; = 2.828, &lt;em&gt;p &lt;/em&gt;= 0.005, &lt;em&gt;r &lt;/em&gt;= 0.333; and &lt;em&gt;Z&lt;/em&gt; = 4.676, &lt;em&gt;p &amp;lt;&lt;/em&gt; 0.001, &lt;em&gt;r &lt;/em&gt;= 0.55, respectively). This suggests that when provided with fewer toys in the environment, toddlers engage in longer periods of play with a single toy, allowing better focus to explore and play more creatively. This can be offered as a recommendation in many natural environments to support children’s development and promote healthy play.&lt;/p&gt;
&lt;/div&gt;




&lt;p class=&quot;copyright&quot;&gt;© 2017 Elsevier Inc. All rights reserved.&lt;/p&gt;

&lt;/div&gt;</description>
<pubDate>Mon, 04 Dec 2017 18:45:24 +0000</pubDate>
<dc:creator>antman</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.sciencedirect.com/science/article/pii/S0163638317301613</dc:identifier>
</item>
<item>
<title>Using Rust in Mercurial</title>
<link>https://www.mercurial-scm.org/wiki/OxidationPlan#</link>
<guid isPermaLink="true" >https://www.mercurial-scm.org/wiki/OxidationPlan#</guid>
<description>&lt;span class=&quot;anchor&quot; id=&quot;top&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-1&quot;&gt;&lt;/span&gt;


&lt;span class=&quot;anchor&quot; id=&quot;line-2&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;This page describes the plan and status for leveraging the Rust programming language in Mercurial. &lt;span class=&quot;anchor&quot; id=&quot;line-3&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-4&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h2 id=&quot;Why_use_Rust.3F&quot;&gt;Why use Rust?&lt;/h2&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-5&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-6&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;Today, Mercurial is a Python application. It uses Python C extensions in various places to achieve better performance. &lt;span class=&quot;anchor&quot; id=&quot;line-7&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-8&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;There are many advantages to being a Python application. But, there are significant disadvantages. &lt;span class=&quot;anchor&quot; id=&quot;line-9&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-10&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;Performance is a significant pain point with Python. There are multiple facets to the performance problem: &lt;span class=&quot;anchor&quot; id=&quot;line-11&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-12&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Startup overhead &lt;span class=&quot;anchor&quot; id=&quot;line-13&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;General performance overhead compared to *native* code &lt;span class=&quot;anchor&quot; id=&quot;line-14&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;GIL interfering with parallel execution &lt;span class=&quot;anchor&quot; id=&quot;line-15&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-16&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p class=&quot;line862&quot;&gt;It takes several dozen milliseconds to start a Python interpreter and load the Mercurial Python modules. If you have many extensions loaded, it could take well over 100ms just to effectively get to a Mercurial command's main function. Reports of over 250ms are known. While the command itself may complete in mere milliseconds, Python overhead has already made &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; seem non-instantaneous to end-users. &lt;span class=&quot;anchor&quot; id=&quot;line-17&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-18&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;A few years ago, we measured that CPython interpreter startup overhead amounted to &lt;a class=&quot;https&quot; href=&quot;https://mail.python.org/pipermail/python-dev/2014-May/134528.html&quot;&gt;10-18% of the run time of Mercurial's test harness&lt;/a&gt;. 100ms may not sound like a lot. But it is enough to give the perception that Mercurial is slower than tools like Git (which can run commands in under 10ms). &lt;span class=&quot;anchor&quot; id=&quot;line-19&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-20&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;There are also situations like querying &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; for shell prompts that require near-instantaneous execution. &lt;span class=&quot;anchor&quot; id=&quot;line-21&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-22&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Mercurial is also heavily scripted by tools like IDEs. We want these tools to provide results near instantaneously. If people are waiting over 100ms for results from &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt;, it makes these other tools feel sluggish. &lt;span class=&quot;anchor&quot; id=&quot;line-23&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-24&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;There are workarounds for startup overhead problems: the &lt;a href=&quot;https://www.mercurial-scm.org/wiki/CommandServer&quot;&gt;CommandServer&lt;/a&gt; (start a persistent process and issue multiple commands to it) and CHg (a C binary that speaks with a Mercurial command server and enables &lt;tt class=&quot;backtick&quot;&gt;chg&lt;/tt&gt; commands to execute without Python startup overhead). &lt;tt class=&quot;backtick&quot;&gt;chg&lt;/tt&gt;'s very existence is because we need &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; to be a native binary in order to avoid Python startup overhead. If &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; weren't a Python script, we wouldn't need &lt;tt class=&quot;backtick&quot;&gt;chg&lt;/tt&gt; to be a separate program. &lt;span class=&quot;anchor&quot; id=&quot;line-25&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-26&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Python is also substantially slower than native code. &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyPy&quot;&gt;PyPy&lt;/a&gt; can deliver substantially better performance than CPython. And some workloads with &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyPy&quot;&gt;PyPy&lt;/a&gt; might even be faster than native code due to JIT. But overall, Python is slower than native code. &lt;span class=&quot;anchor&quot; id=&quot;line-27&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-28&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;But even with &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyPy&quot;&gt;PyPy&lt;/a&gt;'s magical performance, we still have the GIL. Python doesn't allow you to execute CPU-bound Python code on multiple threads. If you are CPU bound, you need to offload that work to an extension (which releases the GIL when it executes hot code) or you spawn multiple processes. Since Mercurial needs to run on Windows (where new process overhead is ~10x worse than POSIX and is a platform optimized for spawning threads - not processes), many of the potential speedups we can realize via concurrency are offset on Windows by new process overhead and Python startup overhead. We need thread-level concurrency on Windows to help with shorter-lived CPU-bound workloads. This includes things like revlog reading (which happens on nearly every Mercurial operation). &lt;span class=&quot;anchor&quot; id=&quot;line-29&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-30&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;In addition to performance concerns, Python is also hindering us because it is a dynamic programming language. Mercurial is a large project by Python standards. Large projects are harder to maintain. Using a statically typed programming language that finds bugs at compile time will enable us to make wide-sweeping changes more fearlessly. This will improve Mercurial's development velocity. &lt;span class=&quot;anchor&quot; id=&quot;line-31&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-32&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;Today, when performance is an issue, Mercurial developers currently turn to C. But we treat C as a measure of last resort because it is just too brittle. It is too easy to introduce security vulnerabilities, memory leaks, etc. On top of vanilla C, the Python C API is somewhat complicated. It takes significantly longer to develop C components because the barrier to writing bug-free C is much higher. &lt;span class=&quot;anchor&quot; id=&quot;line-33&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-34&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Furthermore, Mercurial needs to run on multiple platforms, including Windows. The &lt;em&gt;nice things&lt;/em&gt; we want to do in native code are complicated to implement in C because cross-platform C is hard. The standard library is inadequate compared to modern languages. While modern versions of C++ are nice, we still support Python 2.7 and thus need to build with MSVC 2008 on Windows. It doesn't have any of the nice features that modern versions of C++ have. Things like introducing a thread pool in our current C code would be hard. But with Rust, that support is in the standard library and &quot;just works.&quot; Having Rust's standard library is a pretty compelling advantage over C/C++ for any project, not just Mercurial. &lt;span class=&quot;anchor&quot; id=&quot;line-35&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-36&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;For Mercurial, Rust is all around a better C. It is much safer, about the same speed, and has a usable standard library and &lt;em&gt;modules&lt;/em&gt; system for easily pulling in 3rd party code. &lt;span class=&quot;anchor&quot; id=&quot;line-37&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-38&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h2 id=&quot;Desired_End_State&quot;&gt;Desired End State&lt;/h2&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-39&quot;&gt;&lt;/span&gt;
&lt;ul readability=&quot;-0.5&quot;&gt;&lt;li readability=&quot;0&quot;&gt;
&lt;p class=&quot;line891&quot;&gt;&lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; is a Rust binary that embeds and uses a Python interpreter when appropriate (&lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; is a Python script today) &lt;span class=&quot;anchor&quot; id=&quot;line-40&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;Python code seemlessly calls out to functionality implemented in Rust &lt;span class=&quot;anchor&quot; id=&quot;line-41&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Fully self-contained Mercurial distributions are available (Python is an implementation detail / Mercurial sufficiently independent from other Python presence on system) &lt;span class=&quot;anchor&quot; id=&quot;line-42&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;The customizability and extensibility of Mercurial through extensions is not significantly weakened. &lt;span class=&quot;anchor&quot; id=&quot;line-43&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li readability=&quot;-1&quot;&gt;
&lt;p class=&quot;line891&quot;&gt;&lt;tt class=&quot;backtick&quot;&gt;chg&lt;/tt&gt; functionality is rolled into &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; &lt;span class=&quot;anchor&quot; id=&quot;line-44&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-45&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;Current_Status&quot;&gt;Current Status&lt;/h2&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-46&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-47&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line867&quot;&gt;&lt;em&gt;(last updated December 4 2017)&lt;/em&gt; &lt;span class=&quot;anchor&quot; id=&quot;line-48&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-49&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h2 id=&quot;Priorities_for_Oxidation&quot;&gt;Priorities for Oxidation&lt;/h2&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-55&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-56&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;All existing C code is a priority for oxidation because we don't like maintaining C code for safety and compatibility reasons. Existing C code includes: &lt;span class=&quot;anchor&quot; id=&quot;line-57&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-58&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;In addition, the following would be good candidates for oxidation: &lt;span class=&quot;anchor&quot; id=&quot;line-67&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-68&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;All revlog I/O (reading is more important than writing) &lt;span class=&quot;anchor&quot; id=&quot;line-69&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Working directory I/O (extracting content from revlogs/store and writing to filesystem) &lt;span class=&quot;anchor&quot; id=&quot;line-70&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;bundle2 reading and writing &lt;span class=&quot;anchor&quot; id=&quot;line-71&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;changelog reading &lt;span class=&quot;anchor&quot; id=&quot;line-72&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;revsets &lt;span class=&quot;anchor&quot; id=&quot;line-73&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;All filesystem I/O (allows us to use Windows APIs and properly handle filenames on Windows) &lt;span class=&quot;anchor&quot; id=&quot;line-74&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-75&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;Problems&quot;&gt;Problems&lt;/h2&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-76&quot;&gt;&lt;/span&gt;

&lt;h3 id=&quot;CRT_Mismatch_on_Windows&quot;&gt;CRT Mismatch on Windows&lt;/h3&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-77&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;Mercurial still uses Python 2.7. Python 2.7 is officially compiled with MSVC 2008 and links against vcruntime90.dll. Rust and its standard library don't support MSVC 2008. They are likely linked with something newer, like MSVC 2015 or 2017. &lt;span class=&quot;anchor&quot; id=&quot;line-78&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-79&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;If we want compatibility with other binary Python extensions, we need to use a Python built with MSVC 2008 and linked against msvcr90.dll. &lt;span class=&quot;anchor&quot; id=&quot;line-80&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-81&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;So, our options are: &lt;span class=&quot;anchor&quot; id=&quot;line-82&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-83&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;&lt;li&gt;Build a custom Python 2.7 distribution with modern MSVC and drop support for 3rd party binary Python 2.7 extensions. &lt;span class=&quot;anchor&quot; id=&quot;line-84&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Switch Mercurial to Python 3 and build Rust code with same toolchain as Python we target. &lt;span class=&quot;anchor&quot; id=&quot;line-85&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Mix the CRTs. &lt;span class=&quot;anchor&quot; id=&quot;line-86&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-87&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;p class=&quot;line874&quot;&gt;#1 significantly undermines Mercurial's extensibility. Plus, Python 2.7 built for !MSVC 2008 isn't officially supported. &lt;span class=&quot;anchor&quot; id=&quot;line-88&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-89&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;#2 is in progress. However, the timeline for officially supporting Python 3 to the point where we can transition the official distribution for it is likely too far out (2H 2018) and would hinder Rust adoption efforts. &lt;span class=&quot;anchor&quot; id=&quot;line-90&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-91&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;That leaves mixing the CRTs. This would work by having the Rust components statically link a modern CRT while having Python dynamically load msvcr90.dll. &lt;span class=&quot;anchor&quot; id=&quot;line-92&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-93&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Mixing CRTs is dangerous because if you attempt to perform a multipart operation with multiple CRTs, things could blow up. e.g. if you &lt;tt class=&quot;backtick&quot;&gt;malloc()&lt;/tt&gt; in CRT A and &lt;tt class=&quot;backtick&quot;&gt;free()&lt;/tt&gt; in CRT B. Or attempt to operate on &lt;tt class=&quot;backtick&quot;&gt;FILE&lt;/tt&gt; instances across CRTs. More info at &lt;a class=&quot;https&quot; href=&quot;https://docs.microsoft.com/en-us/cpp/c-runtime-library/potential-errors-passing-crt-objects-across-dll-boundaries&quot;&gt;https://docs.microsoft.com/en-us/cpp/c-runtime-library/potential-errors-passing-crt-objects-across-dll-boundaries&lt;/a&gt;. See also &lt;a class=&quot;https&quot; href=&quot;https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/crt-alphabetical-function-reference&quot;&gt;https://docs.microsoft.com/en-us/cpp/c-runtime-library/reference/crt-alphabetical-function-reference&lt;/a&gt; for a full list of CRT functions. &lt;span class=&quot;anchor&quot; id=&quot;line-94&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-95&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;Fortunately, our exposure to the multiple CRT problem is significantly reduced because: &lt;span class=&quot;anchor&quot; id=&quot;line-96&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-97&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul readability=&quot;1.9561643835616&quot;&gt;&lt;li&gt;Rust and its standard library doesn't make heavy use of CRT primitives. &lt;span class=&quot;anchor&quot; id=&quot;line-98&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li readability=&quot;2.8963282937365&quot;&gt;
&lt;p class=&quot;line862&quot;&gt;Memory managed by Rust and Python is already being kept separate by the Python API. In Rust speak, we won't be transferring ownership of raw pointers between Rust and Python. Python's refcounting mechanism ensures all &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyObject&quot;&gt;PyObject&lt;/a&gt; are destroyed by Python. The only time ownership of memory crosses the bridge is when we create something in Rust and pass it to Python. But that object will be a &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyObject&quot;&gt;PyObject&lt;/a&gt; and backing memory would have been managed with the Python APIs. &lt;span class=&quot;anchor&quot; id=&quot;line-99&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;1&quot;&gt;
&lt;p class=&quot;line862&quot;&gt;We shouldn't be using &lt;tt class=&quot;backtick&quot;&gt;FILE&lt;/tt&gt; anywhere. And I/O on an open file descriptor would likely be limited to its created context. e.g. if we open a file from Rust, we're likely not reading it from Python. &lt;span class=&quot;anchor&quot; id=&quot;line-100&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-101&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;&lt;p class=&quot;line874&quot;&gt;We would have to keep a close eye out for CRT objects spanning multiple CRTs. We can mitigate exposure for bad patterns by establishing static analysis rules on source code. We can also examine the produced Rust binaries for symbol references and raise warnings when unwanted CRT functions are used by Rust code. &lt;span class=&quot;anchor&quot; id=&quot;line-102&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-103&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h3 id=&quot;Rust_Support&quot;&gt;Rust Support&lt;/h3&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-104&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;Mercurial relies on other entities (like Linux distros) to package and distribute Mercurial. This means we have to consider their support for packaging programs that use Rust or else we risk losing packagers. This means we need to consider: &lt;span class=&quot;anchor&quot; id=&quot;line-105&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-106&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;The minimum version of Rust to require &lt;span class=&quot;anchor&quot; id=&quot;line-107&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;Whether we can use beta or nightly Rust features &lt;span class=&quot;anchor&quot; id=&quot;line-108&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-109&quot;&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p class=&quot;line874&quot;&gt;For official Mercurial distributions, these considerations don't exist, as we'll be giving a binary to end-users. So this topic is all about our relationship with downstream packagers. &lt;span class=&quot;anchor&quot; id=&quot;line-110&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-111&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h3 id=&quot;Packaging_Overhaul_Needed&quot;&gt;Packaging Overhaul Needed&lt;/h3&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-112&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line862&quot;&gt;If &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; becomes a Rust binary and we want Mercurial to be a self-contained application, we'll need to overhaul our packaging mechanisms on all operating systems. &lt;span class=&quot;anchor&quot; id=&quot;line-113&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-114&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h4 id=&quot;Distributing_Python&quot;&gt;Distributing Python&lt;/h4&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-115&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;Mercurial would need to distribute a copy of Python. &lt;span class=&quot;anchor&quot; id=&quot;line-116&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-117&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Python insists that embedded Python load a &lt;tt class=&quot;backtick&quot;&gt;pythonXX&lt;/tt&gt; shared library. e.g. &lt;tt class=&quot;backtick&quot;&gt;python27.dll&lt;/tt&gt; or &lt;tt class=&quot;backtick&quot;&gt;libpython27.so&lt;/tt&gt;. &lt;span class=&quot;anchor&quot; id=&quot;line-118&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-119&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;We would also need to distribute a copy of the Python standard library (&lt;tt class=&quot;backtick&quot;&gt;.py&lt;/tt&gt;, &lt;tt class=&quot;backtick&quot;&gt;.pyc&lt;/tt&gt;, etc files). These could be distributed in flat form (hundreds of &lt;tt class=&quot;backtick&quot;&gt;.py&lt;/tt&gt; files) or in a zip file. (Python supports importing modules from zip files.) If we wanted to get creative, we could invent our own archive format / module loading mechanism (but this feels like unnecessary work). &lt;span class=&quot;anchor&quot; id=&quot;line-120&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-121&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;We can't prune the Python standard library of &lt;em&gt;unused&lt;/em&gt; modules because Mercurial extensions may make use of any feature in the standard library. So we'll be distributing the entire Python standard library. &lt;span class=&quot;anchor&quot; id=&quot;line-122&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-123&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;But the distribution of Python is not required: various packagers (like operating systems) would want Mercurial to use a Python provided to it. So our Rust &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; needs to support loading a &lt;em&gt;bundled&lt;/em&gt; Python and a Python provided to it. This can likely be controlled with build-time flags. &lt;span class=&quot;anchor&quot; id=&quot;line-124&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-125&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h4 id=&quot;Windows&quot;&gt;Windows&lt;/h4&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-126&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line862&quot;&gt;Mercurial could conceptually be distributed as a .zip file. That archive would contain pre-built &lt;tt class=&quot;backtick&quot;&gt;hg.exe&lt;/tt&gt;, &lt;tt class=&quot;backtick&quot;&gt;pythonXX.dll&lt;/tt&gt;, any other shared library dependencies, a copy of the Python standard library, Mercurial Python files, and any support files. &lt;span class=&quot;anchor&quot; id=&quot;line-127&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-128&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;Because zip files aren't user friendly, we'd likely provide a standalone .exe or .msi installer (like we do today). &lt;span class=&quot;anchor&quot; id=&quot;line-129&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-130&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h4 id=&quot;Linux&quot;&gt;Linux&lt;/h4&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-131&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line862&quot;&gt;We could provide a self-contained archive file containing &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; binary, &lt;tt class=&quot;backtick&quot;&gt;libpython27.so&lt;/tt&gt;, and any other dependencies. We could also provide rpm, deb, etc packages for popular distributions. These would be self-contained and not dependent any many (any?) other packages. Our biggest concern here is libc compatibility. That can be solved by static linking, compiling against a sufficiently old (and compatible) libc, or providing distro-specific packages. &lt;span class=&quot;anchor&quot; id=&quot;line-132&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-133&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;Of course, many distros will want to provide their own Mercurial package. And they will likely want Mercurial to make use of the system Python. We can and must support this. &lt;span class=&quot;anchor&quot; id=&quot;line-134&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-135&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;An issue with a self-contained distribution is loading of shared libraries. Not all operating systems and loaders may support loading of binary-relative shared libraries. We may need to hack something together that uses &lt;tt class=&quot;backtick&quot;&gt;dlopen()&lt;/tt&gt; to explicitly specify which &lt;tt class=&quot;backtick&quot;&gt;libpython27.so&lt;/tt&gt;, etc to load. &lt;span class=&quot;anchor&quot; id=&quot;line-136&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-137&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h4 id=&quot;MacOS&quot;&gt;MacOS&lt;/h4&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-138&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line862&quot;&gt;This is very similar to Linux. We may support the native application / installer mechanism to make things more user friendly. We don't have good support for this today. So it is likely most users will rely on Homebrew or &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/MacPorts&quot;&gt;MacPorts&lt;/a&gt; for installation. &lt;span class=&quot;anchor&quot; id=&quot;line-139&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-140&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h4 id=&quot;BSDs_.2F_Solaris_.2F_Etc&quot;&gt;BSDs / Solaris / Etc&lt;/h4&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-141&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;Basically the same strategy as Linux. &lt;span class=&quot;anchor&quot; id=&quot;line-142&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-143&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h4 id=&quot;PyPI_.2F_pip&quot;&gt;PyPI / pip&lt;/h4&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-144&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line862&quot;&gt;We support installing Mercurial via &lt;tt class=&quot;backtick&quot;&gt;pip&lt;/tt&gt; today. We upload a source distribution to PyPI and anyone can &lt;tt class=&quot;backtick&quot;&gt;pip install Mercurial&lt;/tt&gt; to install Mercurial in their Python environment. On Windows (where users can't easily compile binary Python extensions), we provide Python wheels with pre-built Mercurial binaries. &lt;span class=&quot;anchor&quot; id=&quot;line-145&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-146&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;The future of &lt;tt class=&quot;backtick&quot;&gt;pip install Mercurial&lt;/tt&gt; with an oxidized Mercurial is less clear. &lt;span class=&quot;anchor&quot; id=&quot;line-147&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-148&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line867&quot;&gt;&lt;tt class=&quot;backtick&quot;&gt;pip&lt;/tt&gt; is tailored towards Python applications. If Mercurial is a Rust application and Python is an implementation detail, does it make sense to use &lt;tt class=&quot;backtick&quot;&gt;pip&lt;/tt&gt; and PyPI as a distribution channel? &lt;span class=&quot;anchor&quot; id=&quot;line-149&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-150&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line867&quot;&gt;&lt;tt class=&quot;backtick&quot;&gt;pip install Mercurial&lt;/tt&gt; is very convenient (at least for the people that have &lt;tt class=&quot;backtick&quot;&gt;pip&lt;/tt&gt; installed and can run it). It is certainly easier than downloading and running an installer. So unless we bake an upgrade facility into Mercurial itself, &lt;tt class=&quot;backtick&quot;&gt;pip install Mercurial&lt;/tt&gt; is the next best thing for upgrading after the system package manager (&lt;tt class=&quot;backtick&quot;&gt;apt&lt;/tt&gt;, &lt;tt class=&quot;backtick&quot;&gt;yum&lt;/tt&gt;, &lt;tt class=&quot;backtick&quot;&gt;brew&lt;/tt&gt;, &lt;tt class=&quot;backtick&quot;&gt;port&lt;/tt&gt;, etc). &lt;span class=&quot;anchor&quot; id=&quot;line-151&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-152&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line867&quot;&gt;&lt;tt class=&quot;backtick&quot;&gt;pip install Mercurial&lt;/tt&gt; goes through a well-defined mechanism to take the artifact it downloaded from PyPI to install it. This mechanism could be abused to facilitate the use of PyPI/pip for distributing a self-contained Mercurial distribution. e.g. the user would end up with a Rust binary in &lt;tt class=&quot;backtick&quot;&gt;PYTHONHOME/bin/hg&lt;/tt&gt; that loads a custom version of Python and is fully self-contained and isolated from the Python it was &lt;tt class=&quot;backtick&quot;&gt;pip install&lt;/tt&gt;ed into. This would be super hacky. It may not even be allowed by PyPI's hosting terms of service? But we could certainly abuse &lt;tt class=&quot;backtick&quot;&gt;pip install&lt;/tt&gt; if we needed to. &lt;span class=&quot;anchor&quot; id=&quot;line-153&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-154&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h3 id=&quot;Support_for_PyPy_.2F_non-CPython_Pythons&quot;&gt;Support for PyPy / non-CPython Pythons&lt;/h3&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-155&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line862&quot;&gt;There exist Python distributions beyond the official CPython distribution. &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyPy&quot;&gt;PyPy&lt;/a&gt; likely being the one of the most interest to us because of its performance advantages. &lt;span class=&quot;anchor&quot; id=&quot;line-156&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-157&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;The cost to supporting non-CPython Pythons when &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; is a Rust binary could be very high. That would likely significantly curtail the use of the CPython API. Instead, we'd have to do interop via &lt;tt class=&quot;backtick&quot;&gt;ctypes&lt;/tt&gt; or &lt;tt class=&quot;backtick&quot;&gt;cffi&lt;/tt&gt; or provide N ways to do interop. &lt;span class=&quot;anchor&quot; id=&quot;line-158&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-159&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;It's worth noting that if Mercurial is a self-contained application, we could potentially swap out CPython for &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyPy&quot;&gt;PyPy&lt;/a&gt;. We could go as far as to unsupport CPython completely. &lt;span class=&quot;anchor&quot; id=&quot;line-160&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-161&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h3 id=&quot;Rust_.3C.3D.3E_Python_Interop&quot;&gt;Rust &amp;lt;=&amp;gt; Python Interop&lt;/h3&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-162&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;Rust and Python code will need to call into each other. (Although it is anticipated that the bulk of the calling will be from Python into Rust code - at least initially.) &lt;span class=&quot;anchor&quot; id=&quot;line-163&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-164&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;There are many options for us here. &lt;span class=&quot;anchor&quot; id=&quot;line-165&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-166&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line867&quot;&gt;&lt;tt class=&quot;backtick&quot;&gt;python27-sys&lt;/tt&gt; and &lt;tt class=&quot;backtick&quot;&gt;python3-sys&lt;/tt&gt; are low-level Rust bindings to the CPython API. Lots of &lt;tt class=&quot;backtick&quot;&gt;unsafe {}&lt;/tt&gt; code here. &lt;span class=&quot;anchor&quot; id=&quot;line-173&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-174&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line867&quot;&gt;&lt;tt class=&quot;backtick&quot;&gt;rust-cpython&lt;/tt&gt; and &lt;tt class=&quot;backtick&quot;&gt;PyO3&lt;/tt&gt; are higher-level bindings to &lt;tt class=&quot;backtick&quot;&gt;python27-sys&lt;/tt&gt; and &lt;tt class=&quot;backtick&quot;&gt;python3-sys&lt;/tt&gt;. They are what you want to use for day-to-day Rust programming. &lt;span class=&quot;anchor&quot; id=&quot;line-175&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-176&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line867&quot;&gt;&lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyO3&quot;&gt;PyO3&lt;/a&gt; is a fork of rust-cpython. It seems to be a bit nicer. But it requires Nightly Rust features. &lt;span class=&quot;anchor&quot; id=&quot;line-177&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-178&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Milksnake uses Rust's &lt;tt class=&quot;backtick&quot;&gt;cbindgen&lt;/tt&gt; crate to automatically generate Python &lt;tt class=&quot;backtick&quot;&gt;cffi&lt;/tt&gt; bindings to Rust libraries. Essentially, you write a Rust library that exports symbols and milksnake can generate a Python binding to it. There's a lot going on. But it is definitely an interesting approach. And some of the components are useful without the rest of milksnake. e.g. the idea of using &lt;tt class=&quot;backtick&quot;&gt;cbindgen&lt;/tt&gt; + &lt;tt class=&quot;backtick&quot;&gt;cffi&lt;/tt&gt; to generate low-level Python bindings. Because Milksnake uses &lt;tt class=&quot;backtick&quot;&gt;cffi&lt;/tt&gt;, the approach should work with both CPython and &lt;a class=&quot;nonexistent&quot; href=&quot;https://www.mercurial-scm.org/wiki/PyPy&quot;&gt;PyPy&lt;/a&gt;. &lt;span class=&quot;anchor&quot; id=&quot;line-179&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-180&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;A major reason for adopting Rust (and C before that) is performance. We know from Mercurial's C extensions that native code is often vasly undermined by a) crossing the Python&amp;lt;-&amp;gt;native boundary b) excessive use of Python API from native code. For example, obsolescence marker parsing is ~100x faster in C. However, once you construct &lt;tt class=&quot;backtick&quot;&gt;PyObject&lt;/tt&gt; for all the parsed markers, it is only 2-4x faster. &lt;span class=&quot;anchor&quot; id=&quot;line-181&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-182&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;We know that using &lt;tt class=&quot;backtick&quot;&gt;ctypes&lt;/tt&gt; to call from Python into native code is significantly slower than binary Python extensions. Although if the number of function calls and data being transferred across the boundary is small, this difference isn't as pronounced. Rust will enable us to write more functionality in native code (we try to avoid writing C today for maintainability and security reasons). So the performance of the Python&amp;lt;-&amp;gt;native bridge will be more important over time. Therefore, it seems prudent to rule out &lt;tt class=&quot;backtick&quot;&gt;ctypes&lt;/tt&gt;. That leaves us with extensions or CFFI. &lt;span class=&quot;anchor&quot; id=&quot;line-183&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-184&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h3 id=&quot;Reconciling_.60hg.60_with_Rust_extensions&quot;&gt;Reconciling `hg` with Rust extensions&lt;/h3&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-185&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-186&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line862&quot;&gt;Initially, &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; will be a minimal Rust binary that embeds a Python interpreter. It simply tells the interpreter to invoke Mercurial's &lt;tt class=&quot;backtick&quot;&gt;main()&lt;/tt&gt; function. In this world, other Rust functionality is likely loaded via shared libraries or Python extensions. In other words, we have multiple Rust &lt;em&gt;contexts&lt;/em&gt; running from different binaries (an executable and a shared library). The executable handles very early process activity. The shared library handles business logic. &lt;span class=&quot;anchor&quot; id=&quot;line-187&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-188&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Over time, we'll likely want to expand the role of Rust for early process activity. For example, we'll need to implement some command line processing in Rust for &lt;tt class=&quot;backtick&quot;&gt;chg&lt;/tt&gt; functionality. We may also want to implement config file loading (we need to rewrite the config parser anyway to facilitate writing back config changes). And, if we could load a repo from disk and maybe even implement performance critical commands (like &lt;tt class=&quot;backtick&quot;&gt;hg status&lt;/tt&gt;) from pure Rust, this would likely be a massive performance win. (Although we have to consider how this will interact with extensibility.) &lt;span class=&quot;anchor&quot; id=&quot;line-189&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-190&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;What this means is that we'll have multiple Rust binaries holding Mercurial state. This feels brittle. Ideally we'd have a single Rust binary. If Python needed to call into native/Rust code, it would get those symbols from the parent &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; binary instead of from a shared library. It is unclear how this would work. It is obviously possible to resolve the address of a symbol in the current binary. But existing &quot;call native code&quot; mechanisms in Python seem to assume that symbols are coming from loaded libraries, not the current executable. This may require modifications to &lt;tt class=&quot;backtick&quot;&gt;cffi&lt;/tt&gt; or some custom code to generate the Python &lt;em&gt;bindings&lt;/em&gt; to executable-local symbols. &lt;span class=&quot;anchor&quot; id=&quot;line-191&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-192&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h3 id=&quot;Preserving_Support_for_Extensions&quot;&gt;Preserving Support for Extensions&lt;/h3&gt;
&lt;span class=&quot;anchor&quot; id=&quot;line-193&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-194&quot;&gt;&lt;/span&gt;
&lt;p class=&quot;line874&quot;&gt;Mercurial implemented in Python is good for extensibility because it means extensions can customize nearly every part of Mercurial - often via monkeypatching. &lt;span class=&quot;anchor&quot; id=&quot;line-195&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-196&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line874&quot;&gt;As we use more Rust, we no longer have the dynamic nature of Python and extensions will lose some of their power. &lt;span class=&quot;anchor&quot; id=&quot;line-197&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-198&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;As more of &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; is implemented in Rust before any Python is called, we could lose the ability for Python extensions to influence low-level and core operations. e.g. if we want to implement &lt;tt class=&quot;backtick&quot;&gt;hg status&lt;/tt&gt; such that it doesn't invoke Python and incur Python startup overhead, how do we enable extensions to still influence the behavior of &lt;tt class=&quot;backtick&quot;&gt;hg status&lt;/tt&gt;? &lt;span class=&quot;anchor&quot; id=&quot;line-199&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-200&quot;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;line862&quot;&gt;Presumably, &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; will eventually implement config file loading and command line processing. So, Rust will be able to see which extensions are being loaded. Assuming &lt;tt class=&quot;backtick&quot;&gt;hg&lt;/tt&gt; can resolve the paths to loaded extensions, we could add a syntax to the main extensions file to declare their influence on various behavior. For example, if an extension influences behavior of &lt;tt class=&quot;backtick&quot;&gt;hg status&lt;/tt&gt;, its source code could contain something like: &lt;tt class=&quot;backtick&quot;&gt;# hgext-influences: cmd-status&lt;/tt&gt;. Rust would see this special syntax and know it needs to instantiate a Python interpreter in order to load the extension for the current &lt;tt class=&quot;backtick&quot;&gt;hg status&lt;/tt&gt; command. We could also imagine doing something similar for other functionality implemented in Rust, such as the core store interface. &lt;span class=&quot;anchor&quot; id=&quot;line-201&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-202&quot;&gt;&lt;/span&gt;&lt;/p&gt;

&lt;hr /&gt;&lt;p class=&quot;line874&quot;&gt;&lt;span class=&quot;anchor&quot; id=&quot;line-203&quot;&gt;&lt;/span&gt;&lt;a href=&quot;https://www.mercurial-scm.org/wiki/CategoryNewFeatures&quot;&gt;CategoryNewFeatures&lt;/a&gt; &lt;a href=&quot;https://www.mercurial-scm.org/wiki/CategoryNewFeatures&quot;&gt;CategoryNewFeatures&lt;/a&gt; &lt;span class=&quot;anchor&quot; id=&quot;line-204&quot;&gt;&lt;/span&gt;&lt;span class=&quot;anchor&quot; id=&quot;bottom&quot;&gt;&lt;/span&gt;&lt;/p&gt;
</description>
<pubDate>Mon, 04 Dec 2017 17:08:20 +0000</pubDate>
<dc:creator>oblio</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.mercurial-scm.org/wiki/OxidationPlan</dc:identifier>
</item>
<item>
<title>Apple is sharing your facial wireframe with apps</title>
<link>https://www.washingtonpost.com/news/the-switch/wp/2017/11/30/apple-is-sharing-your-face-with-apps-thats-a-new-privacy-worry/</link>
<guid isPermaLink="true" >https://www.washingtonpost.com/news/the-switch/wp/2017/11/30/apple-is-sharing-your-face-with-apps-thats-a-new-privacy-worry/</guid>
<description>&lt;div class=&quot;inline-content inline-photo inline-photo-normal&quot;&gt; &lt;img class=&quot;unprocessed placeholder&quot; data-hi-res-src=&quot;https://img.washingtonpost.com/wp-apps/imrs.php?src=https://img.washingtonpost.com/rf/image_960w/2010-2019/WashingtonPost/2017/11/30/Others/Images/2017-11-30/fowler1203002.JPG&amp;amp;w=1484&quot; data-low-res-src=&quot;https://img.washingtonpost.com/wp-apps/imrs.php?src=https://img.washingtonpost.com/rf/image_960w/2010-2019/WashingtonPost/2017/11/30/Others/Images/2017-11-30/fowler1203002.JPG&amp;amp;w=480&quot; data-raw-src=&quot;https://img.washingtonpost.com/rf/image_960w/2010-2019/WashingtonPost/2017/11/30/Others/Images/2017-11-30/fowler1203002.JPG&quot; src=&quot;https://img.washingtonpost.com/wp-apps/imrs.php?src=https://img.washingtonpost.com/rf/image_960w/2010-2019/WashingtonPost/2017/11/30/Others/Images/2017-11-30/fowler1203002.JPG&amp;amp;w=60&quot;/&gt;&lt;br/&gt;&lt;span class=&quot;pb-caption&quot;&gt;The app MeasureKit shows the wireframe model and other face data that the iPhone X opens to developers. (Photo by Jhaan Elker/The Washington Post)&lt;/span&gt;&lt;/div&gt;&lt;p&gt;Poop that mimics your facial expressions was just the beginning.&lt;/p&gt;
&lt;p&gt;It’s going to hit the fan when the face-mapping tech that powers the iPhone X’s cutesy “Animoji” starts being used for creepier purposes. And Apple just started sharing your face with lots of apps.&lt;/p&gt;
&lt;p&gt;Beyond a photo, the iPhone X’s front sensors scan 30,000 points to make a 3D model of your face. That’s how the iPhone X unlocks and makes animations that might have once required a Hollywood studio.&lt;/p&gt;
&lt;div class=&quot;inline-content inline-photo-left&quot;&gt; &lt;img alt=&quot;&quot; class=&quot;unprocessed is-gif&quot; data-hi-res-src=&quot;https://img.washingtonpost.com/pbox.php?url=https://www.washingtonpost.com/blogs/the-switch/files/2017/11/205opx.gif&amp;amp;op=noop&quot; data-low-res-src=&quot;https://img.washingtonpost.com/wp-apps/imrs.php?src=https://img.washingtonpost.com/blogs/the-switch/files/2017/11/205opx.gif&amp;amp;w=339&quot; data-raw-src=&quot;https://img.washingtonpost.com/blogs/the-switch/files/2017/11/205opx.gif&quot; src=&quot;https://img.washingtonpost.com/wp-apps/imrs.php?src=https://img.washingtonpost.com/blogs/the-switch/files/2017/11/205opx.gif&amp;amp;w=339&quot;/&gt;&lt;span class=&quot;pb-caption&quot;&gt;A poop Animoji made possible by the face-mapping tech in the iPhone X that's now available to apps.&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;Now that a phone can scan your mug, what else might apps want to do with it? They could track your expressions to judge if you’re depressed. They could guess your gender, race and even sexuality. They might combine your face with other data to observe you in stores—or walking down the street.&lt;/p&gt;
&lt;p&gt;Apps aren’t doing most of these things, yet. But is Apple doing enough to stop it? After I pressed executives this week, Apple made at least one change—retroactively requiring an app tapping into face data to publish a privacy policy.&lt;/p&gt;
&lt;p&gt;“We take privacy and security very seriously,” Apple spokesman Tom Neumayr said. “This commitment is reflected in the strong protections we have built around Face ID data—protecting it with the Secure Enclave in iPhone X—as well as many other technical safeguards we have built into iOS.”&lt;/p&gt;
&lt;p channel=&quot;wp.com&quot; class=&quot;interstitial-link&quot;&gt;&lt;em&gt;[&lt;a href=&quot;https://www.washingtonpost.com/news/the-switch/wp/2017/10/31/iphone-x-review-apple-is-asking-you-to-break-up-with-the-home-button/?utm_term=.bd5735c07919&quot;&gt;With the iPhone X, Apple is asking you to break up with the home button&lt;/a&gt;]&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Indeed, Apple—which makes most of its money from selling us hardware, not selling our data—may be our best defense against a coming explosion in facial recognition. But I also think Apple rushed into sharing face maps with app makers that may not share its commitment, and it isn’t being paranoid enough about the minefield it just entered.&lt;/p&gt;
&lt;p&gt;“I think we should be quite worried,” said &lt;a href=&quot;https://www.aclu.org/bio/jay-stanley&quot;&gt;Jay Stanley, a senior policy analyst at the American Civil Liberties Union&lt;/a&gt;. “The chances we are going to see mischief around facial data is pretty high—if not today, then soon—if not on Apple then on Android.”&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Your face is open for business&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Apple’s face tech sets some good precedents—and some bad ones. It won praise for storing the face data it uses to unlock the iPhone X securely on the phone, instead of sending it to its servers over the Internet.&lt;/p&gt;
&lt;p&gt;Less noticed was how the iPhone lets other apps now tap into two eerie views from the so-called TrueDepth camera. There’s a wireframe representation of your face and a live read-out of 52 unique micro-movements in your eyelids, mouth and other features. Apps can store that data on their own computers.&lt;/p&gt;
&lt;p&gt;To see for yourself, use an iPhone X to &lt;a href=&quot;https://measurekit.com/&quot;&gt;download an app called MeasureKit&lt;/a&gt;. It exposes the face data Apple makes available. The app’s maker, Rinat Khanov, tells me he’s already planning to add a feature that lets you export a model of your face so you can 3D print a mini-me.&lt;/p&gt;
&lt;div class=&quot;inline-content inline-video&quot;&gt;

&lt;div class=&quot;inline-video-caption&quot;&gt;&lt;span class=&quot;pb-caption&quot;&gt;The Post's Geoffrey A. Fowler shows MotionKit, an app that shows users what facial data is being sent to other apps. (The Washington Post)&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;“Holy cow, why is this data available to any developer that just agrees to a bunch of contracts?” said &lt;a href=&quot;https://www.forrester.com/Fatemeh-Khatibloo&quot;&gt;Fatemeh Khatibloo, an analyst at Forrester Research.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Being careful is in Apple’s DNA—it has been slow in opening home and health data with outsiders. But it also views the face camera as a differentiator, helping position Apple as &lt;a href=&quot;https://www.washingtonpost.com/news/the-switch/wp/2017/06/05/why-apple-is-struggling-to-become-an-artificial-intelligence-powerhouse/?utm_term=.3fbe94e91afe&quot;&gt;a leader in artificial intelligence&lt;/a&gt; and augmented reality.&lt;/p&gt;
&lt;p&gt;Apple put some important &lt;a href=&quot;http://www.appstorereviewguidelineshistory.com/articles/2017-09-15-face-id-arkit-privacy-policies/&quot;&gt;limits on apps&lt;/a&gt;. It requires “that developers ask a user’s permission before accessing the camera, and that apps must explain how and where this data will be used,” Apple's Neumayr said.&lt;/p&gt;
&lt;p&gt;And Apple’s rules say developers can’t sell face data, use it to identify anonymous people or use it for advertising. They’re also required to have privacy policies.&lt;/p&gt;
&lt;p&gt;“These are all very positive steps,” said Clare Garvey, an associate at &lt;a href=&quot;https://www.law.georgetown.edu/academics/centers-institutes/privacy-technology/people.cfm&quot;&gt;Georgetown University’s Center on Privacy &amp;amp; Technology.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Privacy holes&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Still, it wasn’t hard for me to find holes in Apple’s protections.&lt;/p&gt;
&lt;p&gt;The MeasureKit app’s maker told me he wasn’t sensing much extra scrutiny from Apple for accessing face data.&lt;/p&gt;
&lt;p&gt;“There were no additional terms or contracts. The app review process is quite regular as well—or at least it appears to be, on our end,” Khanov said. When I noticed his app didn’t have a privacy policy, Khanov said Apple didn’t require it because he wasn’t taking face data off the phone.&lt;/p&gt;
&lt;p&gt;After I asked Apple about this, it called Khanov and told him to post a privacy policy.&lt;/p&gt;
&lt;p&gt;“They said they noticed a mistake and this should be fixed immediately,” Khanov said. “I wish Apple were more specific in their &lt;a href=&quot;https://developer.apple.com/app-store/review/guidelines/#privacy&quot;&gt;App Review Guidelines&lt;/a&gt;.&quot;&lt;/p&gt;
&lt;p&gt;The bigger concern: “How realistic is it to expect Apple to adequately police this data?” Georgetown’s Garvey told me. Apple might spot violations from big apps like Facebook, but what about gazillions of smaller ones?&lt;/p&gt;
&lt;p&gt;Apple hasn’t said how many apps it has kicked out of its store for privacy issues.&lt;/p&gt;
&lt;p&gt;Then there’s a permission problem. Apps are supposed to make clear why they’re accessing your face and seek “conspicuous consent,” according to Apple’s policies. But when it comes time for you to tap OK, you get a pop-up that asks to “access the camera.” It doesn’t say, “HEY, I’M NOW GOING TO MAP YOUR EVERY TWITCH.”&lt;/p&gt;
&lt;p&gt;The iPhone’s settings don’t differentiate between the back camera and all those front face-mapping sensors. Once you give it permission, an active app keeps on having access to your face until you delete it or dig into advanced settings. There’s no option that says, “Just for the next five minutes.”&lt;/p&gt;
&lt;p&gt;Overwhelming people with notifications and choices is a concern, but the face seems like a sufficiently new and sensitive data source that it warrants special permission. Unlike a laptop webcam, it’s hard to put a privacy sticker over the front of the iPhone X—without a fingerprint reader, it’s the main mechanism to unlock the thing.&lt;/p&gt;
&lt;p&gt;Android phones have had face-unlock features for years, but most haven’t offered 3D face mapping like the iPhone. Like iOS, Android doesn’t make a distinction between front and back cameras. Google’s Play Store doesn’t prohibit apps from using the face camera for marketing or building databases, so long as &lt;a href=&quot;https://play.google.com/about/privacy-security-deception/permissions/&quot;&gt;they ask permission&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;The value of your face&lt;/strong&gt;&lt;/p&gt;
&lt;div class=&quot;inline-content inline-photo-left&quot;&gt; &lt;img alt=&quot;&quot; src=&quot;https://img.washingtonpost.com/blogs/the-switch/files/2017/11/squarewarby-300x300.jpg&quot;/&gt;&lt;span class=&quot;pb-caption&quot;&gt;This screen grab shows the Warby Parker app using iPhone X face data to measure the face of The Post’s Geoffrey A. Fowler. (Geoffrey A. Fowler/TWP)&lt;/span&gt;&lt;/div&gt;
&lt;p&gt;Facial detection can, of course, be used for good and for bad. Warby Parker, the online glasses purveyor, uses it to fit frames to faces, and a Snapchat demo uses it to virtually paint on your face. Companies have touted face tech as a solution to distracted driving, or a way to detect pain in children who have trouble expressing how they’re feeling.&lt;/p&gt;
&lt;p&gt;It’s not clear how Apple’s TrueDepth data might change the kinds of conclusions software can draw about people. But from years of covering tech, I’ve learned this much: Given the opportunity to be creepy, someone will take it.&lt;/p&gt;
&lt;p&gt;Using artificial intelligence, face data “may tell an app developer an awful lot more than the human eye can see,” said Forrester’s Khatibloo. For example, she notes researchers recently used AI to &lt;a href=&quot;https://www.economist.com/news/science-and-technology/21728614-machines-read-faces-are-coming-advances-ai-are-used-spot-signs&quot;&gt;more-accurately determine people’s sexuality&lt;/a&gt; just from regular photographs. That study had limitations, but still “the tech is going to leapfrog way faster than consumers and regulators are going to realize,” said Khatibloo.&lt;/p&gt;
&lt;p&gt;Our faces are already valuable. &lt;a href=&quot;https://www.washingtonpost.com/business/economy/face-recognition-tech/2016/10/17/986929ea-41f0-44a2-b2b9-90b495230dce_story.html?utm_term=.914fdf26b518&quot;&gt;Half of all American adults&lt;/a&gt; have their images stored in at least one database that police can search, typically with few restrictions.&lt;/p&gt;
&lt;p&gt;Facebook and Google use AI to identify faces in pictures we upload to their photo services. (They’re being sued in Illinois, one of the few states with laws that protect biometric data.) Facebook has a patent for &lt;a href=&quot;https://www.google.com/patents/US20150242679&quot;&gt;delivering content based on emotion&lt;/a&gt;, and in 2016, Apple &lt;a href=&quot;https://www.wsj.com/articles/apple-buys-artificial-intelligence-startup-emotient-1452188715&quot;&gt;bought a startup called Emotient&lt;/a&gt; that specializes in detecting emotions.&lt;/p&gt;
&lt;p&gt;Using regular cameras, companies such as &lt;a href=&quot;https://www.kairos.com/&quot;&gt;Kairos&lt;/a&gt; make software to identify gender, ethnicity and age as well as the sentiment of people. In the last 12 months, Kairos said it has read 250 million faces for clients looking to improve commercials and products.&lt;/p&gt;
&lt;p&gt;Apple’s iPhone X launch was “the primal scream of this new industry, because it democratized the idea that facial recognition exists and works,” said Kairos CEO Brian Brackeen. His company gets consent from volunteers whose faces it reads, and sometimes even pays them—but he said the field is wide open. “What rights do people have? Are they being somehow compensated for the valuable data they are sharing?” he said.&lt;/p&gt;
&lt;p&gt;What keeps privacy advocates up at night is that the iPhone X will make face scanning seem normal. Will makers of other phones, security cameras or drones be as careful as Apple? We don’t want to build a future where we become numb to a form of surveillance that goes far beyond anything we’ve known before.&lt;/p&gt;
&lt;p&gt;You’ve only got one face, so we’d better not screw this up.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Read more about the iPhone X: &lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.washingtonpost.com/news/the-switch/wp/2017/11/03/the-iphone-x-factor-dont-buy-a-phone-you-dont-need/?utm_term=.2db9f5720ae3&quot;&gt;The iPhone X-factor: Don’t buy a phone you don’t need&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.washingtonpost.com/news/the-switch/wp/2017/09/13/what-happens-if-a-cop-forces-you-to-unlock-your-iphone-x-with-your-face/?tid=a_inl&amp;amp;utm_term=.4f84f11a0064&quot;&gt;What happens if a cop forces you to unlock your iPhone X with your face?&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.washingtonpost.com/news/the-switch/wp/2017/10/25/if-you-want-an-iphone-x-for-the-holidays-start-planning-now/?tid=a_inl&amp;amp;utm_term=.59991561a3e1&quot;&gt;If you want an iPhone X for the holidays, start planning now&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Mon, 04 Dec 2017 17:06:14 +0000</pubDate>
<dc:creator>lisper</dc:creator>
<og:type>article</og:type>
<og:url>https://www.washingtonpost.com/news/the-switch/wp/2017/11/30/apple-is-sharing-your-face-with-apps-thats-a-new-privacy-worry/</og:url>
<og:image>https://www.washingtonpost.com/rf/image_1484w/2010-2019/WashingtonPost/2017/11/30/Others/Images/2017-11-30/fowler1203002.JPG?t=20170517</og:image>
<og:title>Analysis | Apple is sharing your face with apps. That’s a new privacy worry.</og:title>
<og:description>Is Apple doing enough to protect your face?</og:description>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.washingtonpost.com/news/the-switch/wp/2017/11/30/apple-is-sharing-your-face-with-apps-thats-a-new-privacy-worry/</dc:identifier>
</item>
<item>
<title>Debugging an evil Go runtime bug</title>
<link>https://marcan.st/2017/12/debugging-an-evil-go-runtime-bug/</link>
<guid isPermaLink="true" >https://marcan.st/2017/12/debugging-an-evil-go-runtime-bug/</guid>
<description>&lt;h2 id=&quot;preface&quot;&gt;Preface&lt;/h2&gt;
&lt;p&gt;I’m a big fan of &lt;a href=&quot;https://prometheus.io/&quot;&gt;Prometheus&lt;/a&gt; and &lt;a href=&quot;https://grafana.com/&quot;&gt;Grafana&lt;/a&gt;. As a former SRE at Google I’ve learned to appreciate good monitoring, and this combination has been a winner for me over the past year. I’m using them for monitoring my personal servers (both black-box and white-box monitoring), for the &lt;a href=&quot;https://encounter.eus&quot;&gt;Euskal Encounter&lt;/a&gt; external and internal event infra, for work I do professionally for clients, and more. Prometheus makes it very easy to write custom exporters to monitor your own data, and there’s a good chance you’ll find an exporter that already works for you outside of the box. For example, we use &lt;a href=&quot;https://github.com/justwatchcom/sql_exporter&quot;&gt;sql_exporter&lt;/a&gt; to make a pretty dashboard of attendee metrics for the Encounter events.&lt;/p&gt;
&lt;a href=&quot;https://marcan.st/posts/go_debug/euskalstats.png&quot;&gt;&lt;img src=&quot;https://marcan.st/posts/go_debug/euskalstats.png&quot; width=&quot;640&quot;/&gt;&lt;/a&gt;
&lt;h4&gt;Event dashboard for Euskal Encounter (fake staging data)&lt;/h4&gt;
&lt;p&gt;Since it’s so easy to throw &lt;a href=&quot;https://github.com/prometheus/node_exporter&quot;&gt;&lt;code&gt;node_exporter&lt;/code&gt;&lt;/a&gt; onto any random machine and have a Prometheus instance scrape it for basic system-level metrics (CPU, memory, network, disk, filesystem usage, etc), I figured, why not also monitor my laptop? I have a Clevo “gaming” laptop that serves as my primary workstation, mostly pretending to be a desktop at home but also traveling with me to big events like the Chaos Communication Congress. Since I already have a VPN between it and one of my servers where I run Prometheus, I can just &lt;code&gt;emerge prometheus-node_exporter&lt;/code&gt;, bring up the service, and point my Prometheus instance at it. This automatically configures alerts for it, which means my phone will make a loud noise whenever I open way too many Chrome tabs and run out of my 32GB of RAM. Perfect.&lt;/p&gt;
&lt;h2 id=&quot;trouble-on-the-horizon&quot;&gt;Trouble on the horizon&lt;/h2&gt;
&lt;p&gt;Barely an hour after setting this up, though, my phone did get a page: my newly-added target was inaccessible. Alas, I could SSH into the laptop fine, so it was definitely up, but &lt;code&gt;node_exporter&lt;/code&gt; had crashed.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;fatal error: unexpected signal during runtime execution
[signal SIGSEGV: segmentation violation code=0x1 addr=0xc41ffc7fff pc=0x41439e]

goroutine 2395 [running]:
runtime.throw(0xae6fb8, 0x2a)
        /usr/lib64/go/src/runtime/panic.go:605 +0x95 fp=0xc4203e8be8 sp=0xc4203e8bc8 pc=0x42c815
runtime.sigpanic()
        /usr/lib64/go/src/runtime/signal_unix.go:351 +0x2b8 fp=0xc4203e8c38 sp=0xc4203e8be8 pc=0x443318
runtime.heapBitsSetType(0xc4204b6fc0, 0x30, 0x30, 0xc420304058)
        /usr/lib64/go/src/runtime/mbitmap.go:1224 +0x26e fp=0xc4203e8c90 sp=0xc4203e8c38 pc=0x41439e
runtime.mallocgc(0x30, 0xc420304058, 0x1, 0x1)
        /usr/lib64/go/src/runtime/malloc.go:741 +0x546 fp=0xc4203e8d38 sp=0xc4203e8c90 pc=0x411876
runtime.newobject(0xa717e0, 0xc42032f430)
        /usr/lib64/go/src/runtime/malloc.go:840 +0x38 fp=0xc4203e8d68 sp=0xc4203e8d38 pc=0x411d68
github.com/prometheus/node_exporter/vendor/github.com/prometheus/client_golang/prometheus.NewConstMetric(0xc42018e460, 0x2, 0x3ff0000000000000, 0xc42032f430, 0x1, 0x1, 0x10, 0x9f9dc0, 0x8a0601, 0xc42032f430)
        /var/tmp/portage/net-analyzer/prometheus-node_exporter-0.15.0/work/prometheus-node_exporter-0.15.0/src/github.com/prometheus/node_exporter/vendor/github.com/prometheus/client_golang/prometheus/value.go:165 +0xd0 fp=0xc4203e8dd0 sp=0xc4203e8d68 pc=0x77a980
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;node_exporter&lt;/code&gt;, like many Prometheus components, is written in Go. Go is a relatively safe language: while it allows you to shoot yourself in the foot if you so wish, and it doesn’t have nearly as strong safety guarantees as, say, Rust does, it is still not too easy to accidentally cause a segfault in Go. More so, &lt;code&gt;node_exporter&lt;/code&gt; is a relatively simple Go app with mostly pure-Go dependencies. Therefore, this was an interesting crash to get. Especially since the crash was inside &lt;code&gt;mallocgc&lt;/code&gt;, which should never crash under normal circumstances.&lt;/p&gt;
&lt;p&gt;Things got more interesting after I restarted it a few times:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;2017/11/07 06:32:49 http: panic serving 172.20.0.1:38504: runtime error: growslice: cap out of range
goroutine 41 [running]:
net/http.(*conn).serve.func1(0xc4201cdd60)
        /usr/lib64/go/src/net/http/server.go:1697 +0xd0
panic(0xa24f20, 0xb41190)
        /usr/lib64/go/src/runtime/panic.go:491 +0x283
fmt.(*buffer).WriteString(...)
        /usr/lib64/go/src/fmt/print.go:82
fmt.(*fmt).padString(0xc42053a040, 0xc4204e6800, 0xc4204e6850)
        /usr/lib64/go/src/fmt/format.go:110 +0x110
fmt.(*fmt).fmt_s(0xc42053a040, 0xc4204e6800, 0xc4204e6850)
        /usr/lib64/go/src/fmt/format.go:328 +0x61
fmt.(*pp).fmtString(0xc42053a000, 0xc4204e6800, 0xc4204e6850, 0xc400000073)
        /usr/lib64/go/src/fmt/print.go:433 +0x197
fmt.(*pp).printArg(0xc42053a000, 0x9f4700, 0xc42041c290, 0x73)
        /usr/lib64/go/src/fmt/print.go:664 +0x7b5
fmt.(*pp).doPrintf(0xc42053a000, 0xae7c2d, 0x2c, 0xc420475670, 0x2, 0x2)
        /usr/lib64/go/src/fmt/print.go:996 +0x15a
fmt.Sprintf(0xae7c2d, 0x2c, 0xc420475670, 0x2, 0x2, 0x10, 0x9f4700)
        /usr/lib64/go/src/fmt/print.go:196 +0x66
fmt.Errorf(0xae7c2d, 0x2c, 0xc420475670, 0x2, 0x2, 0xc420410301, 0xc420410300)
        /usr/lib64/go/src/fmt/print.go:205 +0x5a
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Well that’s interesting. A crash in &lt;code&gt;Sprintf&lt;/code&gt; this time. What?&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;runtime: pointer 0xc4203e2fb0 to unallocated span idx=0x1f1 span.base()=0xc4203dc000 span.limit=0xc4203e6000 span.state=3
runtime: found in object at *(0xc420382a80+0x80)
object=0xc420382a80 k=0x62101c1 s.base()=0xc420382000 s.limit=0xc420383f80 s.spanclass=42 s.elemsize=384 s.state=_MSpanInUse
 &amp;lt;snip&amp;gt;
fatal error: found bad pointer in Go heap (incorrect use of unsafe or cgo?)

runtime stack:
runtime.throw(0xaee4fe, 0x3e)
        /usr/lib64/go/src/runtime/panic.go:605 +0x95 fp=0x7f0f19ffab90 sp=0x7f0f19ffab70 pc=0x42c815
runtime.heapBitsForObject(0xc4203e2fb0, 0xc420382a80, 0x80, 0xc41ffd8a33, 0xc400000000, 0x7f0f400ac560, 0xc420031260, 0x11)
        /usr/lib64/go/src/runtime/mbitmap.go:425 +0x489 fp=0x7f0f19ffabe8 sp=0x7f0f19ffab90 pc=0x4137c9
runtime.scanobject(0xc420382a80, 0xc420031260)
        /usr/lib64/go/src/runtime/mgcmark.go:1187 +0x25d fp=0x7f0f19ffac90 sp=0x7f0f19ffabe8 pc=0x41ebed
runtime.gcDrain(0xc420031260, 0x5)
        /usr/lib64/go/src/runtime/mgcmark.go:943 +0x1ea fp=0x7f0f19fface0 sp=0x7f0f19ffac90 pc=0x41e42a
runtime.gcBgMarkWorker.func2()
        /usr/lib64/go/src/runtime/mgc.go:1773 +0x80 fp=0x7f0f19ffad20 sp=0x7f0f19fface0 pc=0x4580b0
runtime.systemstack(0xc420436ab8)
        /usr/lib64/go/src/runtime/asm_amd64.s:344 +0x79 fp=0x7f0f19ffad28 sp=0x7f0f19ffad20 pc=0x45a469
runtime.mstart()
        /usr/lib64/go/src/runtime/proc.go:1125 fp=0x7f0f19ffad30 sp=0x7f0f19ffad28 pc=0x430fe0
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;And now the garbage collector stumbled upon a problem. Yet a different crash.&lt;/p&gt;
&lt;p&gt;At this point, there are two natural conclusions: either I have a severe hardware issue, or there is a wild memory corruption bug in the binary. I initially considered the former unlikely, as this machine has a very heavily mixed workload and no signs of instability that can be traced back to hardware (I have my fair share of crashing software, but it’s never &lt;em&gt;random&lt;/em&gt;). Since Go binaries like &lt;code&gt;node_exporter&lt;/code&gt; are statically linked and do not depend on any other libraries, I can download the official release binary and try that, which would eliminate most of the rest of my system as a variable. Yet, when I did so, I still got a crash.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;unexpected fault address 0x0
fatal error: fault
[signal SIGSEGV: segmentation violation code=0x80 addr=0x0 pc=0x76b998]

goroutine 13 [running]:
runtime.throw(0xabfb11, 0x5)
        /usr/local/go/src/runtime/panic.go:605 +0x95 fp=0xc420060c40 sp=0xc420060c20 pc=0x42c725
runtime.sigpanic()
        /usr/local/go/src/runtime/signal_unix.go:374 +0x227 fp=0xc420060c90 sp=0xc420060c40 pc=0x443197
github.com/prometheus/node_exporter/vendor/github.com/prometheus/client_model/go.(*LabelPair).GetName(...)
        /go/src/github.com/prometheus/node_exporter/vendor/github.com/prometheus/client_model/go/metrics.pb.go:85
github.com/prometheus/node_exporter/vendor/github.com/prometheus/client_golang/prometheus.(*Desc).String(0xc4203ae010, 0xaea9d0, 0xc42045c000)
        /go/src/github.com/prometheus/node_exporter/vendor/github.com/prometheus/client_golang/prometheus/desc.go:179 +0xc8 fp=0xc420060dc8 sp=0xc420060c90 pc=0x76b998
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Yet another completely different crash. At this point there was a decent chance that there was truly an upstream problem with &lt;code&gt;node_exporter&lt;/code&gt; or one of its dependencies, so I filed an &lt;a href=&quot;https://github.com/prometheus/node_exporter/issues/730&quot;&gt;issue&lt;/a&gt; on GitHub. Perhaps the developers had seen this before? It’s worth bringing this kind of issue to their attention and seeing if they have any ideas.&lt;/p&gt;

&lt;p&gt;Unsurprisingly, upstream’s first guess was that it was a hardware issue. This isn’t unreasonable: after all, I’m only hitting the problem on one specific machine. All my other machines are happily running &lt;code&gt;node_exporter&lt;/code&gt;. While I had no other evidence of hardware-linked instability on this host, I also had no other explanation as to what was so particular about this machine that would make &lt;code&gt;node_exporter&lt;/code&gt; crash. A &lt;a href=&quot;http://www.memtest.org/&quot;&gt;Memtest86+&lt;/a&gt; run never hurt anyone, so I gave it a go.&lt;/p&gt;
&lt;p&gt;And then this happened:&lt;/p&gt;
&lt;a href=&quot;https://marcan.st/posts/go_debug/memtest.png&quot;&gt;&lt;img src=&quot;https://marcan.st/posts/go_debug/memtest.png&quot; width=&quot;640&quot;/&gt;&lt;/a&gt;
&lt;h4&gt;This is what I get for using consumer hardware&lt;/h4&gt;
&lt;p&gt;Whoops! Bad RAM. Well, to be more specific, &lt;em&gt;one bit&lt;/em&gt; of bad RAM. After letting the test run for a full pass, all I got was that single bad bit, plus a few false positives in test 7 (which moves blocks around and so can amplify a single error).&lt;/p&gt;
&lt;p&gt;Further testing showed that Memtest86+ test #5 in SMP mode would quickly detect the error, but usually not on the first pass. The error was always the same bit at the same address. This suggests that the problem is a weak or leaky RAM cell. In particular, one which gets worse with temperature. This is quite logical: a higher temperature increases leakage in the RAM cells and thus makes it more likely that a somewhat marginal cell will actually cause a bit flip.&lt;/p&gt;
&lt;p&gt;To put this into perspective, this is one bad bit out of 274,877,906,944. That’s actually a very good error rate! Hard disks and Flash memory have much higher error rates - it’s just that those devices have bad blocks marked at the factory that are transparently swapped out without the user knowing, and can transparently mark newly discovered weak blocks as bad and relocate them to a spare area. RAM has no such luxury, so a bad bit sticks forever.&lt;/p&gt;
&lt;p&gt;Alas, this is vanishingly unlikely to be the cause of my &lt;code&gt;node_exporter&lt;/code&gt; woes. That app uses very little RAM, and so the chances of it hitting the bad bit (repeatedly, at that) are extremely low. This kind of problem would be largely unnoticeable, perhaps causing a pixel error in some graphics, a single letter to flip in some text, an instruction to be corrupted that probably won’t ever be run, and perhaps the rare segfault when something actually important does land on the bad bit. Nonetheless, it does cause long-term reliability issues, and this is why servers and other devices intended to be reliable must use ECC RAM, which can correct this kind of error.&lt;/p&gt;
&lt;p&gt;I don’t have the luxury of ECC RAM on this laptop. What I do have, though, is the ability to mark the bad block of RAM as bad and tell the OS not to use it. There is a little-known &lt;a href=&quot;https://www.gnu.org/software/grub/manual/grub/html_node/badram.html&quot;&gt;feature&lt;/a&gt; of GRUB 2 which allows you to do just that, by changing the memory map that is passed to the booted kernel. It’s not worth buying new RAM just for a single bad bit (especially since DDR3 is already obsolete, and there’s a good chance new RAM would have weak cells anyway), so this is a good option.&lt;/p&gt;
&lt;p&gt;However, there’s one more thing I can do. Since the problem gets worse with temperature, what happens if I heat up the RAM?&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://marcan.st/posts/go_debug/badram.jpg&quot;&gt;&lt;img src=&quot;https://marcan.st/posts/go_debug/badram_s.jpg&quot; width=&quot;400&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h4&gt;🔥🔥🔥memtest86+🔥🔥🔥&lt;/h4&gt;
&lt;a href=&quot;https://marcan.st/posts/go_debug/badram_t.jpg&quot;&gt;&lt;img src=&quot;https://marcan.st/posts/go_debug/badram_ts.jpg&quot; width=&quot;400&quot;/&gt;&lt;/a&gt;
&lt;h4&gt;A cozy 100°C&lt;/h4&gt;
&lt;p&gt;Using a heat gun set at a fairly low temperature (130°C) I warmed up two modules at a time (the other two modules are under the rear cover, as my laptop has four SODIMM slots total). Playing around with module order, I found three additional weak bits only detectable at elevated temperature, and they were spread around three of my RAM sticks.&lt;/p&gt;
&lt;p&gt;I also found that the location of the errors stayed roughly consistent even as I swapped modules around: the top bits of the address remained the same. This is because the RAM is interleaved: data is spread over all four sticks, instead of each stick being assigned a contiguous quarter of the available address space. This is convenient, because I can just mask a region of RAM large enough to cover all possible addresses for each error bit, and not have to worry that I might swap sticks in the future and mess up the masking. I found that masking a contiguous 128KiB area should cover all possible permutations of addresses for each given bad bit, but, for good measure, I rounded up to 1MiB. This gave me three 1MiB aligned blocks to mask out (one of them covers two of the bad bits, for a total of four bad bits I wanted masked):&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code&gt;0x36a700000&lt;/code&gt; – &lt;code&gt;0x36a7fffff&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;0x460e00000&lt;/code&gt; – &lt;code&gt;0x460efffff&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;0x4ea000000&lt;/code&gt; – &lt;code&gt;0x4ea0fffff&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;This can be specified using the address/mask syntax required by GRUB as follows, in &lt;code&gt;/etc/default/grub&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;GRUB_BADRAM=&quot;0x36a700000,0xfffffffffff00000,0x460e00000,0xfffffffffff00000,0x4ea000000,0xfffffffffff00000&quot;
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;One quick &lt;code&gt;grub-mkconfig&lt;/code&gt; later, I am down 3MiB of RAM and four dodgy bits with it. It’s not ECC RAM, but this should increase the effective reliability of my consumer-grade RAM, since now I know the rest of the memory is fine up to at least 100°C.&lt;/p&gt;
&lt;p&gt;Needless to say, &lt;code&gt;node_exporter&lt;/code&gt; still crashed, but we knew this wasn’t the real problem, didn’t we.&lt;/p&gt;
&lt;h2 id=&quot;digging-deeper&quot;&gt;Digging deeper&lt;/h2&gt;
&lt;p&gt;The annoying thing about this kind of bug is that it clearly is caused by some kind of memory corruption that breaks code that runs later. This makes it very hard to debug, because we can’t predict what will be corrupted (it varies), and we can’t catch the bad code in the act of doing so.&lt;/p&gt;
&lt;p&gt;First I tried some basic bisecting of available &lt;code&gt;node_exporter&lt;/code&gt; releases and enabling/disabling different collectors, but that went nowhere. I also tried running an instance under &lt;code&gt;strace&lt;/code&gt;. This seemed to stop the crashes, which strongly points to a race-condition kind of problem. &lt;code&gt;strace&lt;/code&gt; will usually wind up serializing execution of apps to some extent, by intercepting all system calls run by all threads. I would later find that the &lt;code&gt;strace&lt;/code&gt; instance crashed too, but it took much longer to do so. Since this seemed to be related to concurrency, I tried setting &lt;code&gt;GOMAXPROCS=1&lt;/code&gt;, which tells Go to only use a single OS-level thread to run Go code. This also stopped the crashes, again pointing strongly to a concurrency issue.&lt;/p&gt;
&lt;p&gt;By now I had gathered quite a considerable number of crash logs, and I was starting to notice some patterns. While there was a lot of variation in the parts that were crashing and how, ultimately the error messages could be categorized into different types and the same kind of error showed up more than once. So I started Googling these errors, and this is how I stumbled upon &lt;a href=&quot;https://github.com/golang/go/issues/20427&quot;&gt;Go issue #20427&lt;/a&gt;. This was an issue in seemingly an unrelated part of Go, but one that had caused similar segfaults and random issues. The issue was closed with no diagnosis after it couldn’t be reproduced with Go 1.9. Nobody knew what the root cause was, just that it had stopped happening.&lt;/p&gt;
&lt;p&gt;So I grabbed &lt;a href=&quot;https://github.com/golang/go/issues/20427#issuecomment-306346724&quot;&gt;this&lt;/a&gt; sample code from the issue, which claimed to reproduce the problem, and ran it on my machine. Lo and behold, it crashed within seconds. Bingo. This is a lot better than waiting hours for &lt;code&gt;node_exporter&lt;/code&gt; to crash.&lt;/p&gt;
&lt;p&gt;That doesn’t get me any closer to debugging the issue from the Go side, but it gives me a much faster way to test for it. So let’s try another angle.&lt;/p&gt;
&lt;h2 id=&quot;bisecting-machines&quot;&gt;Bisecting machines&lt;/h2&gt;
&lt;p&gt;I know the problem happens on my laptop, but doesn’t happen on any other of my machines. I tried the reproducer on every other machine I have easy access to, and couldn’t get it to crash on any of them. This tells me there’s something special about my laptop. Since Go statically links binaries, the rest of userspace doesn’t matter. This leaves two relevant parts: the hardware, and the kernel.&lt;/p&gt;
&lt;p&gt;I don’t have any easy way to test with various hardware other than the machines I own, but I can play with kernels. So let’s try that. First order of business: will it crash in a VM?&lt;/p&gt;
&lt;p&gt;To test for this, I built a minimal initramfs that will allow me to very quickly launch the reproducer in a QEMU VM without having to actually install a distro or boot a full Linux system. My initramfs was built with Linux’s &lt;code&gt;scripts/gen_initramfs_list.sh&lt;/code&gt; and contained the following files:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;dir /dev 755 0 0
nod /dev/console 0600 0 0 c 5 1
nod /dev/null 0666 0 0 c 1 3
dir /bin 755 0 0
file /bin/busybox busybox 755 0 0
slink /bin/sh busybox 755 0 0
slink /bin/true busybox 755 0 0
file /init init.sh 755 0 0
file /reproducer reproducer 755 0 0
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;/init&lt;/code&gt; is the entry point of a Linux initramfs, and in my case was a simple shellscript to start the test and measure time:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;#!/bin/sh
export PATH=/bin

start=$(busybox date +%s)

echo &quot;Starting test now...&quot;
/reproducer
ret=$?
end=$(busybox date +%s)
echo &quot;Test exited with status $ret after $((end-start)) seconds&quot;
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;/bin/busybox&lt;/code&gt; is a statically linked version of BusyBox, often used in minimal systems like this to provide all basic Linux shell utilities (including a shell itself).&lt;/p&gt;
&lt;p&gt;The initramfs can be built like this (from a Linux kernel source tree), where list.txt is the file list above:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;scripts/gen_initramfs_list.sh -o initramfs.gz list.txt
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;And QEMU can boot the kernel and initramfs directly:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;qemu-system-x86_64 -kernel /boot/vmlinuz-4.13.9-gentoo -initrd initramfs.gz -append 'console=ttyS0' -smp 8 -nographic -serial mon:stdio -cpu host -enable-kvm
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;This resulted in no output at all to the console… and then I realized I hadn’t even compiled 8250 serial port support into my laptop’s kernel. D’oh. I mean, it doesn’t have a physical serial port, right? Anyway, a quick detour to rebuild the kernel with serial support (and crossing my fingers that didn’t change anything important), I tried again and it successfully booted and ran the reproducer.&lt;/p&gt;
&lt;p&gt;Did it crash? Yup. Good, this means the problem is reproducible on a VM on the same machine. I tried the same QEMU command on my home server, with its own kernel, and… nothing. Then I copied the kernel from my laptop and booted that and… it crashed. The kernel is what matters. It’s not a hardware issue.&lt;/p&gt;
&lt;h2 id=&quot;juggling-kernels&quot;&gt;Juggling kernels&lt;/h2&gt;
&lt;p&gt;At this point, I knew I was going to be compiling lots of kernels to try to narrow this down. So I decided to move to the most powerful machine I had lying around: a somewhat old 12-core, 24-thread Xeon (now defunct, sadly). I copied the known-bad kernel source to that machine, built it, and tested it.&lt;/p&gt;
&lt;p&gt;It didn’t crash.&lt;/p&gt;
&lt;p&gt;What?&lt;/p&gt;
&lt;p&gt;Some head-scratching later, I made sure the original bad kernel binary crashed (it did). Are we back to hardware? Does it matter which machine I &lt;em&gt;build&lt;/em&gt; the kernel on? So I tried building the kernel on my home server, and that one promptly triggered the crash. Building the same kernel on two machines yields crashes, a third machine doesn’t. What’s the difference?&lt;/p&gt;
&lt;p&gt;Well, these are all Gentoo boxes, and all Gentoo Hardened at that. But my laptop and my home server are both &lt;code&gt;~amd64&lt;/code&gt; (unstable), while my Xeon server is &lt;code&gt;amd64&lt;/code&gt; (stable). That means GCC is different. My laptop and home server were both on &lt;code&gt;gcc (Gentoo Hardened 6.4.0 p1.0) 6.4.0&lt;/code&gt;, while my Xeon was on &lt;code&gt;gcc (Gentoo Hardened 5.4.0-r3 p1.3, pie-0.6.5) 5.4.0&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;But my home server’s kernel, which was nearly the same version as my laptop (though not exactly), built with the same GCC, did not reproduce the crashes. So now we have to conclude that &lt;em&gt;both&lt;/em&gt; the compiler used to build the kernel &lt;em&gt;and&lt;/em&gt; the kernel itself (or its config?) matter.&lt;/p&gt;
&lt;p&gt;To narrow things down further, I compiled the exact kernel tree from my laptop on my home server (linux-4.13.9-gentoo), and confirmed that it indeed crashed. Then I copied over the &lt;code&gt;.config&lt;/code&gt; from my home server and compiled that, and found that it didn’t. This means we’re looking at a kernel config difference &lt;em&gt;and&lt;/em&gt; a compiler difference:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;linux-4.13.9-gentoo + gcc 5.4.0-r3 p1.3 + laptop .config - no crash&lt;/li&gt;
&lt;li&gt;linux-4.13.9-gentoo + gcc 6.4.0 p1.0 + laptop .config - &lt;em&gt;crash&lt;/em&gt;&lt;/li&gt;
&lt;li&gt;linux-4.13.9-gentoo + gcc 6.4.0 p1.0 + server .config - no crash&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Two &lt;code&gt;.config&lt;/code&gt;s, one good, and one bad. Time to diff them. Of course, the two configs were vastly different (since I tend to tailor my kernel config to only include the drivers I need on any particular machine), so I had to repeatedly rebuild the kernel while narrowing down the differences.&lt;/p&gt;
&lt;p&gt;I decided to start with the “known bad” &lt;code&gt;.config&lt;/code&gt; and start removing things. Since the reproducer takes a variable amount of time to crash, it’s easier to test for “still crashes” (just wait for it to crash) than for “doesn’t crash” (how long do I have to wait to convince myself that it doesn’t?). Over the course of 22 kernel builds, I managed to simplify the &lt;a href=&quot;https://marcan.st/posts/go_debug/config&quot;&gt;config&lt;/a&gt; so much that the kernel had no networking support, no filesystems, no block device core, and didn’t even support PCI (still works fine on a VM though!). My kernel builds now took less than 60 seconds and the kernel was about 1/4th the size of my regular one.&lt;/p&gt;
&lt;p&gt;Then I moved on to the “known good” &lt;code&gt;.config&lt;/code&gt; and removed all the unnecessary junk while making sure it still didn’t crash the reproducer (which was trickier and slower than the previous test). I had a few false branches, where I changed something that made the reproducer start crashing (but I didn’t know what), yet I misidentified them as “no crash”, so when I got a crash I had to walk back up the previous kernels I’d built and make sure I knew exactly where the crash was introduced. I ended up doing 7 kernel builds.&lt;/p&gt;
&lt;p&gt;Eventually, I narrowed it down to a small handful of different .config options. A few of them stood out, in particular &lt;code&gt;CONFIG_OPTIMIZE_INLINING&lt;/code&gt;. After carefully testing them I concluded that, indeed, that option was the culprit. Turning it &lt;em&gt;off&lt;/em&gt; produced kernels that crash the reproducer testcase, while turning it &lt;em&gt;on&lt;/em&gt; produced kernels that didn’t. This option, when turned on, allows GCC to better determine which &lt;code&gt;inline&lt;/code&gt; functions really must be inlined, instead of forcing it to inline them unconditionally. This also explains the GCC connection: inlining behavior is likely to change between GCC versions.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;/*
 * Force always-inline if the user requests it so via the .config,
 * or if gcc is too old.
 * GCC does not warn about unused static inline functions for
 * -Wunused-function.  This turns out to avoid the need for complex #ifdef
 * directives.  Suppress the warning in clang as well by using &quot;unused&quot;
 * function attribute, which is redundant but not harmful for gcc.
 */
#if !defined(CONFIG_ARCH_SUPPORTS_OPTIMIZED_INLINING) ||                \
    !defined(CONFIG_OPTIMIZE_INLINING) || (__GNUC__ &amp;lt; 4)
#define inline inline           __attribute__((always_inline,unused)) notrace
#define __inline__ __inline__   __attribute__((always_inline,unused)) notrace
#define __inline __inline       __attribute__((always_inline,unused)) notrace
#else
/* A lot of inline functions can cause havoc with function tracing */
#define inline inline           __attribute__((unused)) notrace
#define __inline__ __inline__   __attribute__((unused)) notrace
#define __inline __inline       __attribute__((unused)) notrace
#endif
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;So what next? We know that &lt;code&gt;CONFIG_OPTIMIZE_INLINING&lt;/code&gt; makes the difference, but that potentially changes the behavior of every single &lt;code&gt;inline&lt;/code&gt; function across the whole kernel. How to pinpoint the problem?&lt;/p&gt;
&lt;p&gt;I had an idea.&lt;/p&gt;
&lt;h2 id=&quot;hash-based-differential-compilation&quot;&gt;Hash-based differential compilation&lt;/h2&gt;
&lt;p&gt;The basic premise is to compile &lt;em&gt;part&lt;/em&gt; of the kernel with the option turned on, and &lt;em&gt;part&lt;/em&gt; of the kernel with the option turned off. By testing the resulting kernel and checking whether the problem appears or not, we can deduce which subset of the kernel compilation units contains the problem code.&lt;/p&gt;
&lt;p&gt;Instead of trying to enumerate all object files and doing some kind of binary search, I decided to go with a hash-based approach. I wrote this wrapper script for GCC:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;#!/bin/bash
args=(&quot;$@&quot;)

doit=
while [ $# -gt 0 ]; do
        case &quot;$1&quot; in
                -c)
                        doit=1
                        ;;
                -o)
                        shift
                        objfile=&quot;$1&quot;
                        ;;
        esac
        shift
done

extra=
if [ ! -z &quot;$doit&quot; ]; then
        sha=&quot;$(echo -n &quot;$objfile&quot; | sha1sum - | cut -d&quot; &quot; -f1)&quot;
        echo &quot;${sha:0:8} $objfile&quot; &amp;gt;&amp;gt; objs.txt
        if [ $((0x${sha:0:8} &amp;amp; (0x80000000 &amp;gt;&amp;gt; $BIT))) = 0 ]; then
                echo &quot;[n]&quot; &quot;$objfile&quot; 1&amp;gt;&amp;amp;2
        else
                extra=-DCONFIG_OPTIMIZE_INLINING
                echo &quot;[y]&quot; &quot;$objfile&quot; 1&amp;gt;&amp;amp;2
        fi
fi

exec gcc $extra &quot;${args[@]}&quot;
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;This hashes the object file name with SHA-1, then checks a given bit of the hash out of the first 32 bits (identified by the &lt;code&gt;$BIT&lt;/code&gt; environment variable). If the bit is 0, it builds without &lt;code&gt;CONFIG_OPTIMIZE_INLINING&lt;/code&gt;. If it is 1, it builds with &lt;code&gt;CONFIG_OPTIMIZE_INLINING&lt;/code&gt;. I found that the kernel had around 685 object files at this point (my minimization effort had paid off), which requires about 10 bits for a unique identification. This hash-based approach also has one neat property: I can choose to only worry about crashing outcomes (where the bit is 0), since it is much harder to prove that a given kernel build does not crash (as the crashes are probabilistic and can take quite a while sometimes).&lt;/p&gt;
&lt;p&gt;I built 32 kernels, one for each bit of the SHA-1 prefix, which only took 29 minutes. Then I started testing them, and every time I got a crash, I narrowed down a regular expression of possible SHA-1 hashes to only those with zero bits at those specific positions. At 8 crashes (and thus zero bits), I was down to 4 object files, and a couple were looking promising. Once I hit the 10th crash, there was a single match.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;$ grep '^[0246][012389ab][0189][014589cd][028a][012389ab][014589cd]' objs_0.txt
6b9cab4f arch/x86/entry/vdso/vclock_gettime.o
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;vDSO code. Of course.&lt;/p&gt;
&lt;h2 id=&quot;vdso-shenanigans&quot;&gt;vDSO shenanigans&lt;/h2&gt;
&lt;p&gt;The kernel’s vDSO is not actually kernel code. vDSO is a small shared library that the kernel places in the address space of every process, and which allows apps to perform certain special system calls without ever leaving user mode. This increases performance significantly, while still allowing the kernel to change the implementation details of those system calls as needed.&lt;/p&gt;
&lt;p&gt;In other words, vDSO is GCC-compiled code, built with the kernel, that ends up being linked with every userspace app. It’s userspace code. This explains why the kernel and its compiler mattered: it wasn’t about the kernel itself, but about a shared library provided by the kernel! And Go uses the vDSO for performance. Go also happens to have a (rather insane, in my opinion) policy of reinventing its own standard library, so it does not use any of the standard Linux glibc code to call vDSO, but rather rolls its own calls (and syscalls too).&lt;/p&gt;
&lt;p&gt;So what does flipping &lt;code&gt;CONFIG_OPTIMIZE_INLINING&lt;/code&gt; do to the vDSO? Let’s look at the assembly.&lt;/p&gt;
&lt;p&gt;With &lt;code&gt;CONFIG_OPTIMIZE_INLINING=n&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;arch/x86/entry/vdso/vclock_gettime.o.no_inline_opt:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &amp;lt;vread_tsc&amp;gt;:
   0:   55                      push   %rbp
   1:   48 89 e5                mov    %rsp,%rbp
   4:   90                      nop
   5:   90                      nop
   6:   90                      nop
   7:   0f 31                   rdtsc  
   9:   48 c1 e2 20             shl    $0x20,%rdx
   d:   48 09 d0                or     %rdx,%rax
  10:   48 8b 15 00 00 00 00    mov    0x0(%rip),%rdx        # 17 &amp;lt;vread_tsc+0x17&amp;gt;
  17:   48 39 c2                cmp    %rax,%rdx
  1a:   77 02                   ja     1e &amp;lt;vread_tsc+0x1e&amp;gt;
  1c:   5d                      pop    %rbp
  1d:   c3                      retq   
  1e:   48 89 d0                mov    %rdx,%rax
  21:   5d                      pop    %rbp
  22:   c3                      retq   
  23:   0f 1f 00                nopl   (%rax)
  26:   66 2e 0f 1f 84 00 00    nopw   %cs:0x0(%rax,%rax,1)
  2d:   00 00 00 

0000000000000030 &amp;lt;__vdso_clock_gettime&amp;gt;:
  30:   55                      push   %rbp
  31:   48 89 e5                mov    %rsp,%rbp
  34:   48 81 ec 20 10 00 00    sub    $0x1020,%rsp
  3b:   48 83 0c 24 00          orq    $0x0,(%rsp)
  40:   48 81 c4 20 10 00 00    add    $0x1020,%rsp
  47:   4c 8d 0d 00 00 00 00    lea    0x0(%rip),%r9        # 4e &amp;lt;__vdso_clock_gettime+0x1e&amp;gt;
  4e:   83 ff 01                cmp    $0x1,%edi
  51:   74 66                   je     b9 &amp;lt;__vdso_clock_gettime+0x89&amp;gt;
  53:   0f 8e dc 00 00 00       jle    135 &amp;lt;__vdso_clock_gettime+0x105&amp;gt;
  59:   83 ff 05                cmp    $0x5,%edi
  5c:   74 34                   je     92 &amp;lt;__vdso_clock_gettime+0x62&amp;gt;
  5e:   83 ff 06                cmp    $0x6,%edi
  61:   0f 85 c2 00 00 00       jne    129 &amp;lt;__vdso_clock_gettime+0xf9&amp;gt;
[...]
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;With &lt;code&gt;CONFIG_OPTIMIZE_INLINING=y&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;arch/x86/entry/vdso/vclock_gettime.o.inline_opt:     file format elf64-x86-64


Disassembly of section .text:

0000000000000000 &amp;lt;__vdso_clock_gettime&amp;gt;:
   0:   55                      push   %rbp
   1:   4c 8d 0d 00 00 00 00    lea    0x0(%rip),%r9        # 8 &amp;lt;__vdso_clock_gettime+0x8&amp;gt;
   8:   83 ff 01                cmp    $0x1,%edi
   b:   48 89 e5                mov    %rsp,%rbp
   e:   74 66                   je     76 &amp;lt;__vdso_clock_gettime+0x76&amp;gt;
  10:   0f 8e dc 00 00 00       jle    f2 &amp;lt;__vdso_clock_gettime+0xf2&amp;gt;
  16:   83 ff 05                cmp    $0x5,%edi
  19:   74 34                   je     4f &amp;lt;__vdso_clock_gettime+0x4f&amp;gt;
  1b:   83 ff 06                cmp    $0x6,%edi
  1e:   0f 85 c2 00 00 00       jne    e6 &amp;lt;__vdso_clock_gettime+0xe6&amp;gt;
[...]
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Interestingly, &lt;code&gt;CONFIG_OPTIMIZE_INLINING=y&lt;/code&gt;, which is supposed to allow GCC to inline &lt;em&gt;less&lt;/em&gt;, actually resulted in it inlining &lt;em&gt;more&lt;/em&gt;: &lt;code&gt;vread_tsc&lt;/code&gt; is inlined in that version, while not in the &lt;code&gt;CONFIG_OPTIMIZE_INLINING=n&lt;/code&gt; version. But &lt;code&gt;vread_tsc&lt;/code&gt; isn’t marked inline at all, so GCC is perfectly within its right to behave like this, as counterintuitive as it may be.&lt;/p&gt;
&lt;p&gt;But who cares if a function is inlined? Where’s the actual problem? Well, looking closer at the non-inline version…&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  30:        55                      push   %rbp
  31:   48 89 e5                mov    %rsp,%rbp
  34:   48 81 ec 20 10 00 00    sub    $0x1020,%rsp
  3b:   48 83 0c 24 00          orq    $0x0,(%rsp)
  40:   48 81 c4 20 10 00 00    add    $0x1020,%rsp
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Why is GCC allocating over 4KiB of stack? That’s not a stack allocation, that’s a &lt;em&gt;stack probe&lt;/em&gt;, or more specifically, the result of the &lt;code&gt;-fstack-check&lt;/code&gt; GCC &lt;a href=&quot;https://gcc.gnu.org/onlinedocs/gccint/Stack-Checking.html&quot;&gt;feature&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Gentoo Linux enables &lt;nobr&gt;&lt;code&gt;-fstack-check&lt;/code&gt;&lt;/nobr&gt; by default on its hardened profile. This is a mitigation for the &lt;a href=&quot;https://www.qualys.com/2017/06/19/stack-clash/stack-clash.txt&quot;&gt;Stack Clash&lt;/a&gt; vulnerability. While &lt;nobr&gt;&lt;code&gt;-fstack-check&lt;/code&gt;&lt;/nobr&gt; is an old GCC feature and not intended for this, it turns out it effectively mitigates the issue (I’m told proper Stack Clash protection will be in GCC 8). As a side-effect, it causes some fairly silly behavior, where every non-leaf function (that is, a function that makes function calls) ends up probing the stack 4 KiB ahead of the stack pointer. In other words, code compiled with &lt;nobr&gt;&lt;code&gt;-fstack-check&lt;/code&gt;&lt;/nobr&gt; potentially needs at least 4 KiB of stack space, unless it is a leaf function (or a function where every call was inlined).&lt;/p&gt;
&lt;p&gt;Go loves small stacks.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;TEXT runtime·walltime(SB),NOSPLIT,$16
        // Be careful. We're calling a function with gcc calling convention here.
        // We're guaranteed 128 bytes on entry, and we've taken 16, and the
        // call uses another 8.
        // That leaves 104 for the gettime code to use. Hope that's enough!
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Turns out 104 bytes aren’t enough for everybody. Certainly not for my kernel.&lt;/p&gt;
&lt;p&gt;It’s worth pointing out that the vDSO specification makes no mention of maximum stack usage guarantees, so this is squarely Go’s fault for making invalid assumptions.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;This perfectly explains the symptoms. The stack probe is an &lt;code&gt;orq&lt;/code&gt;, which is a logical OR with 0. This is a no-op, but effectively probes the target address (if it is unmapped, it will segfault). But we weren’t seeing segfaults in vDSO code, so how was this breaking Go? Well, OR with 0 isn’t really a no-op. Since &lt;code&gt;orq&lt;/code&gt; is not an atomic instruction, what really happens is the CPU reads the memory address and then writes it back. This creates a race condition. If other threads are running in parallel on other CPUs, &lt;code&gt;orq&lt;/code&gt; might effectively wind up undoing a memory write that occurs simultaneously. Since the write was out of the stack bounds, it was likely intruding on other threads’ stacks or random data, and, when the stars line up, undoing a memory write. This is also why &lt;code&gt;GOMAXPROCS=1&lt;/code&gt; works around the issue, since that prevents two threads from effectively running Go code at the same time.&lt;/p&gt;
&lt;p&gt;What’s the fix? I left that up to the Go devs. Their solution ultimately was to &lt;a href=&quot;https://github.com/golang/go/commit/a158382b1c9c0b95a7d41865a405736be6bc585f&quot;&gt;pivot to a larger stack&lt;/a&gt; before calling vDSO functions. This introduces a small speed penalty (nanoseconds), but it’s acceptable. After building &lt;code&gt;node_exporter&lt;/code&gt; with the fixed Go toolchain, the crashes went away.&lt;/p&gt;
&lt;p&gt;2017-12-05 01:20&lt;/p&gt;

</description>
<pubDate>Mon, 04 Dec 2017 16:34:50 +0000</pubDate>
<dc:creator>cmsimike</dc:creator>
<og:image>https://marcan.st/posts/go_debug/hotram.png</og:image>
<og:title>Debugging an evil Go runtime bug</og:title>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://marcan.st/2017/12/debugging-an-evil-go-runtime-bug/</dc:identifier>
</item>
<item>
<title>Books I read this year</title>
<link>https://www.gatesnotes.com/About-Bill-Gates/Best-Books-2017</link>
<guid isPermaLink="true" >https://www.gatesnotes.com/About-Bill-Gates/Best-Books-2017</guid>
<description>&lt;div id=&quot;content_0_articlePanel&quot; readability=&quot;119.82282110092&quot;&gt;
&lt;p&gt;Reading is my favorite way to indulge my curiosity. Although I’m lucky that I get to meet with a lot of interesting people and visit fascinating places through my work, I still think books are the best way to explore new topics that interest you.&lt;/p&gt;
&lt;p&gt;This year I picked up books on a bunch of diverse subjects. I really enjoyed &lt;em&gt;Black Flags: The Rise of ISIS&lt;/em&gt; by Joby Warrick. I recommend it to anyone who wants a compelling history lesson on how ISIS managed to seize power in Iraq.&lt;/p&gt;
&lt;p&gt;On the other end of the spectrum, I loved John Green’s new novel, &lt;em&gt;Turtles All the Way Down&lt;/em&gt;, which tells the story of a young woman who tracks down a missing billionaire. It deals with serious themes like mental illness, but John’s stories are always entertaining and full of great literary references.&lt;/p&gt;
&lt;p&gt;Another good book I read recently is &lt;em&gt;The Color of Law&lt;/em&gt; by Richard Rothstein. I’ve been trying to learn more about the forces preventing economic mobility in the U.S., and it helped me understand the role federal policies have played in creating racial segregation in American cities.&lt;/p&gt;
&lt;p&gt;I’ve written longer reviews about some of the best books I read this year. They include a memoir by one of my favorite comedians, a heartbreaking tale of poverty in America, a deep dive into the history of energy, and not one but two stories about the Vietnam War. If you’re looking to curl up by the fireplace with a great read this holiday season, you can’t go wrong with one of these.&lt;/p&gt;
&lt;p&gt;&lt;iframe width=&quot;800&quot; height=&quot;450&quot; frameborder=&quot;0&quot; src=&quot;https://www.youtube.com/embed/69pwVFbJIaY?rel=0&quot;&gt;[embedded content]&lt;/iframe&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://www.gatesnotes.com/Books/The-Best-We-Could-Do&quot; target=&quot;_blank&quot;&gt;The Best We Could Do&lt;/a&gt;,&lt;/em&gt; by Thi Bui. This gorgeous graphic novel is a deeply personal memoir that explores what it means to be a parent and a refugee. The author’s family fled Vietnam in 1978. After giving birth to her own child, she decides to learn more about her parents’ experiences growing up in a country torn apart by foreign occupiers.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://www.gatesnotes.com/Books/Evicted&quot; target=&quot;_blank&quot;&gt;Evicted: Poverty and Profit in the American City&lt;/a&gt;,&lt;/em&gt; by Matthew Desmond. If you want a good understanding of how the issues that cause poverty are intertwined, you should read this book about the eviction crisis in Milwaukee. Desmond has written a brilliant portrait of Americans living in poverty. He gave me a better sense of what it is like to be poor in this country than anything else I have read.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://www.gatesnotes.com/Books/Believe-Me&quot; target=&quot;_blank&quot;&gt;Believe Me: A Memoir of Love, Death, and Jazz Chickens&lt;/a&gt;,&lt;/em&gt; by Eddie Izzard. Izzard’s personal story is fascinating: he survived a difficult childhood and worked relentlessly to overcome his lack of natural talent and become an international star. If you’re a huge fan of him like I am, you’ll love this book. His written voice is very similar to his stage voice, and I found myself laughing out loud several times while reading it.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://www.gatesnotes.com/Books/The-Sympathizer&quot; target=&quot;_blank&quot;&gt;The Sympathizer&lt;/a&gt;,&lt;/em&gt; by Viet Thanh Nguyen. Most of the books I’ve read and movies I’ve seen about the Vietnam War focused on the American perspective. Nguyen’s award-winning novel offers much-needed insight into what it was like to be Vietnamese and caught between both sides. Despite how dark it is, &lt;em&gt;The Sympathizer&lt;/em&gt; is a gripping story about a double agent and the trouble he gets himself into.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://www.gatesnotes.com/Books/Energy-and-Civilization&quot; target=&quot;_blank&quot;&gt;Energy and Civilization: A History&lt;/a&gt;,&lt;/em&gt; by Vaclav Smil. Smil is one of my favorite authors, and this is his masterpiece. He lays out how our need for energy has shaped human history—from the era of donkey-powered mills to today’s quest for renewable energy. It’s not the easiest book to read, but at the end you’ll feel smarter and better informed about how energy innovation alters the course of civilizations.&lt;/p&gt;
&lt;div id=&quot;PrevNextTabsHolder&quot; class=&quot;PrevNextTabsHolder&quot;&gt;
&lt;div id=&quot;PrevNextTabs_PrevTab&quot;&gt;

&lt;p&gt;Previous Article&lt;/p&gt;
&lt;/div&gt;

&lt;div id=&quot;PrevNextTabs_NextTab&quot;&gt;
&lt;p&gt;Next Article&lt;/p&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;div id=&quot;content_0_articlePrevNextCont&quot; readability=&quot;57&quot;&gt; 
&lt;p&gt;NEXT&lt;br/&gt;&lt;span class=&quot;nextPrevText&quot;&gt;A searing portrait of American poverty&lt;/span&gt;&lt;/p&gt;

&lt;/div&gt;</description>
<pubDate>Mon, 04 Dec 2017 16:12:19 +0000</pubDate>
<dc:creator>borisjabes</dc:creator>
<og:description>Bill Gates shares five amazing books he read in 2017 including “The Best We Could Do” by Thi Bui, “Evicted” by Matthew Desmond, “Believe Me” by Eddie Izzard, “The Sympathizer” by Viet Thanh Nguyen, and “Energy and Civilization” by Vaclav Smil.</og:description>
<og:image>https://www.gatesnotes.com/-/media/Images/Articles/About-Bill-Gates/Best-Books-2017/end-of-year-books_2017_article_v1.jpg</og:image>
<og:title>5 amazing books I read this year</og:title>
<og:type>article</og:type>
<og:url>https://www.gatesnotes.com/About-Bill-Gates/Best-Books-2017</og:url>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.gatesnotes.com/About-Bill-Gates/Best-Books-2017</dc:identifier>
</item>
<item>
<title>Integrating “safe” languages into OpenBSD?</title>
<link>https://marc.info/?l=openbsd-misc&amp;m=151233345723889&amp;w=2</link>
<guid isPermaLink="true" >https://marc.info/?l=openbsd-misc&amp;m=151233345723889&amp;w=2</guid>
<description>&lt;head&gt;&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html&quot; /&gt;&lt;title&gt;'Re: Integrating &quot;safe&quot; languages into OpenBSD?' - MARC&lt;/title&gt;&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;/style.css&quot; /&gt;&lt;/head&gt;&lt;body bgcolor=&quot;#FFFFFF&quot; text=&quot;#000000&quot; link=&quot;#0000C0&quot; vlink=&quot;#800080&quot; id=&quot;readabilityBody&quot; readability=&quot;43.445974576271&quot;&gt;
&lt;pre&gt;
&lt;strong&gt;[&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233148023559&amp;amp;w=2&quot;&gt;prev in list&lt;/a&gt;] [&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233412624041&amp;amp;w=2&quot;&gt;next in list&lt;/a&gt;] [&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233210523661&amp;amp;w=2&quot;&gt;prev in thread&lt;/a&gt;] [&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233451224088&amp;amp;w=2&quot;&gt;next in thread&lt;/a&gt;] &lt;/strong&gt;
&lt;strong&gt;&lt;span&gt;
List:       &lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;r=1&amp;amp;w=2&quot;&gt;openbsd-misc&lt;/a&gt;
Subject:    &lt;a href=&quot;https://marc.info/?t=151233221700001&amp;amp;r=1&amp;amp;w=2&quot;&gt;Re: Integrating &quot;safe&quot; languages into OpenBSD?&lt;/a&gt;
From:       &lt;a href=&quot;https://marc.info/?a=146809448200002&amp;amp;r=1&amp;amp;w=2&quot;&gt;&quot;Theo de Raadt&quot; &amp;lt;deraadt () openbsd ! org&amp;gt;&lt;/a&gt;
Date:       &lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;r=1&amp;amp;w=2&amp;amp;b=201712&quot;&gt;2017-12-03 20:37:07&lt;/a&gt;
Message-ID: &lt;a href=&quot;https://marc.info/?i=81638.1512333427%20()%20cvs%20!%20openbsd%20!%20org&quot;&gt;81638.1512333427 () cvs ! openbsd ! org&lt;/a&gt;&lt;/span&gt;
[&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233345723889&amp;amp;q=raw&quot;&gt;Download message RAW&lt;/a&gt;]&lt;/strong&gt;

&amp;gt; As a response to this, Theo asked rhetorically &quot;Where's ls, where's cat,
&amp;gt; where's grep, and where's sort?&quot;, implying that noone so far bothered to
&amp;gt; write implementations of even the basic unix utilities in such a
&amp;gt; language.

I wasn't implying.  I was stating a fact.  There has been no attempt
to move the smallest parts of the ecosystem, to provide replacements
for base POSIX utilities.

As a general trend the only things being written in these new
languages are new web-facing applications, quite often proprietory or
customized to narrow roles.  Not Unix parts.

Right now, there are zero usage cases in the source tree to require
those compiler tools.  We won't put a horse into the source tree when
society lacks cart builders.

&amp;gt; This brings me to the question, what if someone actually bothered?

So rather than bothering to begin, you wrote an email.

Awesome.

Yes, now I am implying something: you won't bother to rewrite the
utilities.

And I understand, why would anyone bother?  It took about 10 years for
gnu grep to be replaced sufficiently well in our tree.  This stuff
doesn't happen overnight.

However there is a rampant fiction that if you supply a new safer
method everyone will use it.  For gods sake, the simplest of concepts
like the stack protector took nearly 10 years for adoption, let people
should switch languages?  DELUSION.

&amp;gt; Under what conditions would you consider replacing one of the
&amp;gt; current C implementations with an implementation written in another,
&amp;gt; &quot;safer&quot; language?

In OpenBSD there is a strict requirement that base builds base.

So we cannot replace any base utility, unless the toolchain to build
it is in the base.  Adding such a toolchain would take make build time
from 40 minutes to hours.  I don't see how that would happen.

&amp;gt; Note that with Cgrep and haskell-ls, there do in fact exist
&amp;gt; implementations/analogues of two of the mentioned utilities in a
&amp;gt; memory safe language (Haskell).

Are they POSIX compliant?  No.  They are completely different programs
that have borrowed the names.

By the way, this is how long it takes to compile our grep:

    0m00.62s real     0m00.63s user     0m00.53s system

Does Cgrep compile in less than 10 minutes?

Such ecosystems come with incredible costs.  For instance, rust cannot
even compile itself on i386 at present time because it exhausts the
address space.

Consider me a skeptic -- I think these compiler ecosystems face a grim
bloaty future.

&lt;strong&gt;[&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233148023559&amp;amp;w=2&quot;&gt;prev in list&lt;/a&gt;] [&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233412624041&amp;amp;w=2&quot;&gt;next in list&lt;/a&gt;] [&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233210523661&amp;amp;w=2&quot;&gt;prev in thread&lt;/a&gt;] [&lt;a href=&quot;https://marc.info/?l=openbsd-misc&amp;amp;m=151233451224088&amp;amp;w=2&quot;&gt;next in thread&lt;/a&gt;] &lt;/strong&gt;
&lt;/pre&gt;

&lt;center&gt;&lt;a href=&quot;https://marc.info/?q=configure&quot;&gt;Configure&lt;/a&gt; | &lt;a href=&quot;https://marc.info/?q=about&quot;&gt;About&lt;/a&gt; | &lt;a href=&quot;https://marc.info/?q=news&quot;&gt;News&lt;/a&gt; | &lt;a href=&quot;mailto:webguy@marc.info?subject=Add%20a%20list%20to%20MARC&quot;&gt;Add a list&lt;/a&gt; | Sponsored by &lt;a href=&quot;http://www.korelogic.com/&quot;&gt;KoreLogic&lt;/a&gt;&lt;/center&gt;
&lt;/body&gt;</description>
<pubDate>Mon, 04 Dec 2017 13:35:05 +0000</pubDate>
<dc:creator>dmm</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://marc.info/?l=openbsd-misc&amp;m=151233345723889&amp;w=2</dc:identifier>
</item>
<item>
<title>Rocket – A Rust game running on WASM</title>
<link>https://aochagavia.github.io/blog/rocket---a-rust-game-running-on-wasm/</link>
<guid isPermaLink="true" >https://aochagavia.github.io/blog/rocket---a-rust-game-running-on-wasm/</guid>
<description>&lt;p&gt;Two weeks ago, Alex Crichton’s &lt;a href=&quot;https://github.com/rust-lang/rust/pull/45905&quot;&gt;PR&lt;/a&gt; adding a target for WebAssembly to the Rust compiler was merged. There are many differences between this target and the Emscripten one, but the important one for me is that it doesn’t depend on external stuff like the Emscripten SDK (which IIRC used to be a pain to get working on Windows, but seems to be better now).&lt;/p&gt;
&lt;p&gt;After seeing the examples on &lt;a href=&quot;https://www.hellorust.com&quot;&gt;hellorust.com&lt;/a&gt;, I thought it would be interesting to try to adapt my game &lt;a href=&quot;https://github.com/aochagavia/rocket&quot;&gt;Rocket&lt;/a&gt; to work on the browser through the &lt;code&gt;wasm32-unknown-unknown&lt;/code&gt; target. The project was a great way to figure out how far you can go when porting a project that is a bit more complex than a hello world. I was pleasantly surprised by the fact that most of the code could be reused. Particularly, the game logic code was barely touched at all.&lt;/p&gt;
&lt;h3 id=&quot;tldr&quot;&gt;TLDR&lt;/h3&gt;
&lt;p&gt;Here is the &lt;a href=&quot;https://github.com/aochagavia/rocket_wasm&quot;&gt;source code&lt;/a&gt;. Also, you can play the game in the canvas below or &lt;a href=&quot;https://aochagavia.github.io/rocket_wasm/&quot;&gt;on a dedicated tab&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The controls are:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Left and right arrows: turn left and right&lt;/li&gt;
&lt;li&gt;Up arrow: boost&lt;/li&gt;
&lt;li&gt;Space: shoot&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;an-mvp&quot;&gt;An MVP&lt;/h2&gt;
&lt;h3 id=&quot;getting-things-to-compile-removing-piston&quot;&gt;Getting things to compile: removing Piston&lt;/h3&gt;
&lt;p&gt;Before I started, the little I knew about WebAssembly was that it doesn’t allow you to interface with the OS, graphics card or other stuff like that. Using Emscripten seems to be a way around this problem, but I guess you still need to adapt your programs to some extent… I have never used it, though, so take my words with a grain of salt.&lt;/p&gt;
&lt;p&gt;After cloning the Rocket repository I started removing stuff. The first thing to go was the dependency on Piston. I didn’t even try to compile Rocket to wasm before this step, as it is obvious that Piston requires OS support.&lt;/p&gt;
&lt;p&gt;At this point, we were left with:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;No game loop&lt;/li&gt;
&lt;li&gt;No rendering&lt;/li&gt;
&lt;li&gt;No player input&lt;/li&gt;
&lt;/ol&gt;&lt;h3 id=&quot;rebuilding-the-game-laying-down-the-basic-structure&quot;&gt;Rebuilding the game: laying down the basic structure&lt;/h3&gt;
&lt;p&gt;So here we are without even a main function. This means that the game loop should be implemented in Javascript and call into our Rust functions. Therefore we need a set of basic functions that are enough to drive the execution of the game, draw something to the screen and process user input.&lt;/p&gt;
&lt;p&gt;Since rendering and processing player input are more involved than just updating the game state, I chose the latter as a first function to implement. I was able to reuse the code for the game logic without any change, so the function ended up looking as follows:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;11&quot;&gt;
&lt;pre&gt;
&lt;span&gt;#[no_mangle]&lt;/span&gt;
&lt;span&gt;pub&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;extern&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;C&quot;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; update(time&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double) {&lt;/span&gt;
&lt;span&gt;  &lt;/span&gt;&lt;span&gt;let&lt;/span&gt;&lt;span&gt; data&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; GameData &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; DATA.lock().unwrap();&lt;/span&gt;
&lt;span&gt;  data.time_controller.update_seconds(time, &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;data.actions, &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; data.state);&lt;/span&gt;
&lt;span&gt;  CollisionsController&lt;/span&gt;&lt;span&gt;::&lt;/span&gt;&lt;span&gt;handle_collisions(&lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; data.state);&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Surprisingly, the &lt;a href=&quot;https://github.com/aochagavia/rocket/blob/c13232b074da14662cc24ee075f7ef66521e5d27/src/main.rs#L71-L74&quot;&gt;update function on the original game&lt;/a&gt; is &lt;em&gt;exactly the same&lt;/em&gt;, with the exception of the use of &lt;code&gt;DATA&lt;/code&gt;. By the way, we use &lt;code&gt;DATA&lt;/code&gt; to store state instead of passing it between Javascript and Rust every time we call a function. The definition is quite simple:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;8&quot;&gt;
&lt;pre&gt;
&lt;span&gt;lazy_static&lt;/span&gt;&lt;span&gt;!&lt;/span&gt;&lt;span&gt; {&lt;/span&gt;
&lt;span&gt;  &lt;/span&gt;&lt;span&gt;static&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;ref&lt;/span&gt;&lt;span&gt; DATA&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; Mutex&lt;/span&gt;&lt;span&gt;&amp;lt;&lt;/span&gt;&lt;span&gt;GameData&lt;/span&gt;&lt;span&gt;&amp;gt;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; Mutex&lt;/span&gt;&lt;span&gt;::&lt;/span&gt;&lt;span&gt;new(new_game_data(&lt;/span&gt;&lt;span&gt;1024.0&lt;/span&gt;&lt;span&gt;, &lt;/span&gt;&lt;span&gt;600.0&lt;/span&gt;&lt;span&gt;));&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Since &lt;code&gt;DATA&lt;/code&gt; is accessible from anywhere in the program, Rust forces us to use a &lt;code&gt;Mutex&lt;/code&gt; to ensure thread safety. Technically, this isn’t necessary in the case of Javascript, since there will only be one thread. Still, the type system knows nothing about that… Hence the mutex.&lt;/p&gt;
&lt;h3 id=&quot;getting-things-to-compile-take-two&quot;&gt;Getting things to compile, take two&lt;/h3&gt;
&lt;p&gt;With Piston out of the way, I set out to get the rest of the code to compile and to run it in the browser as a simulation without any visual output. This is the moment where difficulties started to pop out.&lt;/p&gt;
&lt;p&gt;The first problem I encountered was caused by the dependency on &lt;code&gt;rand&lt;/code&gt;. Generating random numbers doesn’t necessarily require OS support, but you need to generate a seed some way or another. For this reason, &lt;code&gt;rand&lt;/code&gt; relies on an &lt;code&gt;OsRng&lt;/code&gt; struct that is platform-dependent. Guess what… WebAssembly didn’t had such a struct, so the crate could not be compiled.&lt;/p&gt;
&lt;p&gt;Fortunately, the problem was easily solved by &lt;a href=&quot;https://github.com/rust-lang-nursery/rand/pull/197&quot;&gt;adding such a struct&lt;/a&gt;. After patching the crate, the code finally compiled… but it didn’t run in the browser.&lt;/p&gt;
&lt;p&gt;By the way, you are probably wondering about the seeding problem. If there is no way to communicate with the outside world from your WebAssembly programs, how can you get a seed? Below I will describe how you can call Javascript functions from Rust, which could be a solution to the problem. However, I decided to use a constant seed, which is clearly not optimal, but is good enough for a playable demo.&lt;/p&gt;
&lt;h3 id=&quot;getting-things-to-run-link-errors&quot;&gt;Getting things to run: link errors&lt;/h3&gt;
&lt;p&gt;I mentioned in the paragraph above that the resulting program didn’t run on the browser. Concretely, after following the instructions on &lt;a href=&quot;https://www.hellorust.com&quot;&gt;hellorust.com&lt;/a&gt;, I got the following error:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;TypeError: import object field 'env' is not an Object
&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;After looking around for a while, this turned out to be a linking problem. In other words, the generated Rust code contained calls to functions that didn’t exist. Therefore, the browser expected me to pass an import object containing said functions. It seems that some &lt;code&gt;f64&lt;/code&gt; functions I used in the physics part of the game have no analogous on WebAssembly, so I had to pass them explicitly from Javascript through the following object:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre&gt;
&lt;span&gt;let&lt;/span&gt; &lt;span&gt;imports&lt;/span&gt; &lt;span&gt;=&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;
  &lt;span&gt;env&lt;/span&gt;&lt;span&gt;:&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;
    &lt;span&gt;Math_atan&lt;/span&gt;&lt;span&gt;:&lt;/span&gt; &lt;span&gt;Math.&lt;/span&gt;&lt;span&gt;atan&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;
    &lt;span&gt;sin&lt;/span&gt;&lt;span&gt;:&lt;/span&gt; &lt;span&gt;Math.&lt;/span&gt;&lt;span&gt;sin&lt;/span&gt;&lt;span&gt;,&lt;/span&gt;
    &lt;span&gt;cos&lt;/span&gt;&lt;span&gt;:&lt;/span&gt; &lt;span&gt;Math.&lt;/span&gt;&lt;span&gt;cos&lt;/span&gt;
  &lt;span&gt;}&lt;/span&gt;
&lt;span&gt;};&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After this, the code compiled and could be loaded on the browser, though without any kind of visual feedback. Rust running on the browser! Finally.&lt;/p&gt;
&lt;h2 id=&quot;making-the-game-actually-playable&quot;&gt;Making the game actually playable&lt;/h2&gt;
&lt;h3 id=&quot;rendering&quot;&gt;Rendering&lt;/h3&gt;
&lt;p&gt;At this point I discovered that you could call Javascript functions from within the Rust program. This follows the same principle as using C functions from a library. On the Rust side, you need to declare the function as &lt;code&gt;extern&lt;/code&gt;. On the Javascript side, you need to add the function to the imports, so it can be linked.&lt;/p&gt;
&lt;p&gt;This means we can define drawing functions on the Javascript side and call them from Rust. Even though WebAssembly itself cannot interact with the outside world, it can still call Javascript functions you explicitly pass through the &lt;code&gt;imports&lt;/code&gt; object. This will be our escape hatch to render the game to a canvas&lt;/p&gt;
&lt;p&gt;Rendering things to the screen was as easy as adding a bunch of functions to my program:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre&gt;
&lt;span&gt;extern&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;C&quot;&lt;/span&gt;&lt;span&gt; {&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; clear_screen();&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; draw_player(_&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double, _&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double, _&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double);&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; draw_enemy(_&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double, _&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double);&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; draw_bullet(_&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double, _&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double);&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; draw_particle(_&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double, _&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double, _&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double);&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; draw_score(_&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; c_double);&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Of course, these functions had to be implemented on the Javascript side. You can find them on the source code of the demo. You won’t find any surprises there, as the only thing they do is drawing to a canvas.&lt;/p&gt;
&lt;p&gt;With these extern functions in place, I could implement the rest of the drawing code in Rust as shown below:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;17&quot;&gt;
&lt;pre&gt;
&lt;span&gt;#[no_mangle]&lt;/span&gt;
&lt;span&gt;pub&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;unsafe&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;extern&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;C&quot;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; draw() {&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;use&lt;/span&gt;&lt;span&gt; geometry&lt;/span&gt;&lt;span&gt;::&lt;/span&gt;&lt;span&gt;{Advance, Position};&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;let&lt;/span&gt;&lt;span&gt; data &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; DATA.lock().unwrap();&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;let&lt;/span&gt;&lt;span&gt; world &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;data.state.world;&lt;/span&gt;

&lt;span&gt;    clear_screen();&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt;&lt;span&gt; particle &lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;world.particles {&lt;/span&gt;
&lt;span&gt;        draw_particle(particle.x(), particle.y(), &lt;/span&gt;&lt;span&gt;5.0&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;*&lt;/span&gt;&lt;span&gt; particle.ttl);&lt;/span&gt;
&lt;span&gt;    }&lt;/span&gt;

&lt;span&gt;    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt;&lt;span&gt; bullet &lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;world.bullets {&lt;/span&gt;
&lt;span&gt;        draw_bullet(bullet.x(), bullet.y());&lt;/span&gt;
&lt;span&gt;    }&lt;/span&gt;

&lt;span&gt;    &lt;/span&gt;&lt;span&gt;for&lt;/span&gt;&lt;span&gt; enemy &lt;/span&gt;&lt;span&gt;in&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;world.enemies {&lt;/span&gt;
&lt;span&gt;        draw_enemy(enemy.x(), enemy.y());&lt;/span&gt;
&lt;span&gt;    }&lt;/span&gt;

&lt;span&gt;    draw_player(world.player.x(), world.player.y(), world.player.direction());&lt;/span&gt;
&lt;span&gt;    draw_score(data.state.score &lt;/span&gt;&lt;span&gt;as&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;f64&lt;/span&gt;&lt;span&gt;);&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Again, if you compare this code to the &lt;a href=&quot;https://github.com/aochagavia/rocket/blob/c13232b074da14662cc24ee075f7ef66521e5d27/src/view.rs#L31-L45&quot;&gt;original version&lt;/a&gt;, you will see that they are strikingly similar.&lt;/p&gt;
&lt;h3 id=&quot;processing-user-input&quot;&gt;Processing user input&lt;/h3&gt;
&lt;p&gt;With simulation and rendering in place, enabling user input was almost trivial. First of all, I added a bunch of functions to toggle user actions on and off. Note that I am using a Rust type as a parameter of each function. This is technically incorrect, but I am not sure about which type I should use instead. If you do, please open a PR so it can be fixed.&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;10&quot;&gt;
&lt;pre&gt;
&lt;span&gt;#[no_mangle]&lt;/span&gt;
&lt;span&gt;pub&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;extern&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;C&quot;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; toggle_shoot(b&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;bool&lt;/span&gt;&lt;span&gt;) {&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;let&lt;/span&gt;&lt;span&gt; data &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; DATA.lock().unwrap();&lt;/span&gt;
&lt;span&gt;    data.actions.shoot &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; b;&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;

&lt;span&gt;#[no_mangle]&lt;/span&gt;
&lt;span&gt;pub&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;extern&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;C&quot;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; toggle_boost(b&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;bool&lt;/span&gt;&lt;span&gt;) {&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;let&lt;/span&gt;&lt;span&gt; data &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; DATA.lock().unwrap();&lt;/span&gt;
&lt;span&gt;    data.actions.boost &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; b;&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;

&lt;span&gt;#[no_mangle]&lt;/span&gt;
&lt;span&gt;pub&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;extern&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;C&quot;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; toggle_turn_left(b&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;bool&lt;/span&gt;&lt;span&gt;) {&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;let&lt;/span&gt;&lt;span&gt; data &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; DATA.lock().unwrap();&lt;/span&gt;
&lt;span&gt;    data.actions.rotate_left &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; b;&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;

&lt;span&gt;#[no_mangle]&lt;/span&gt;
&lt;span&gt;pub&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;extern&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&quot;C&quot;&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;fn&lt;/span&gt;&lt;span&gt; toggle_turn_right(b&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;bool&lt;/span&gt;&lt;span&gt;) {&lt;/span&gt;
&lt;span&gt;    &lt;/span&gt;&lt;span&gt;let&lt;/span&gt;&lt;span&gt; data &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; &lt;/span&gt;&lt;span&gt;&amp;amp;&lt;/span&gt;&lt;span&gt;mut&lt;/span&gt;&lt;span&gt; DATA.lock().unwrap();&lt;/span&gt;
&lt;span&gt;    data.actions.rotate_right &lt;/span&gt;&lt;span&gt;=&lt;/span&gt;&lt;span&gt; b;&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In this case, the code did differ considerably from the &lt;a href=&quot;https://github.com/aochagavia/rocket/blob/c13232b074da14662cc24ee075f7ef66521e5d27/src/controllers/input.rs#L39-L47&quot;&gt;original version&lt;/a&gt;, since the latter relies on the &lt;code&gt;piston_window::Key&lt;/code&gt; struct, which no longer exists. In the wasm version, I moved the key matching logic to Javascript, since I didn’t want to pass strings between Javascript and Rust. The resulting code is straightforward:&lt;/p&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre&gt;
&lt;span&gt;// Input processing&lt;/span&gt;
&lt;span&gt;function&lt;/span&gt; &lt;span&gt;processKey&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;b&lt;/span&gt;&lt;span&gt;)&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;
  &lt;span&gt;switch&lt;/span&gt; &lt;span&gt;(&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;span&gt;)&lt;/span&gt; &lt;span&gt;{&lt;/span&gt;
    &lt;span&gt;case&lt;/span&gt; &lt;span&gt;&quot;ArrowLeft&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;
      &lt;span&gt;module&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;toggle_turn_left&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;b&lt;/span&gt;&lt;span&gt;);&lt;/span&gt;
      &lt;span&gt;break&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;
    &lt;span&gt;case&lt;/span&gt; &lt;span&gt;&quot;ArrowRight&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;
      &lt;span&gt;module&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;toggle_turn_right&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;b&lt;/span&gt;&lt;span&gt;);&lt;/span&gt;
      &lt;span&gt;break&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;
    &lt;span&gt;case&lt;/span&gt; &lt;span&gt;&quot;ArrowUp&quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;
      &lt;span&gt;module&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;toggle_boost&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;b&lt;/span&gt;&lt;span&gt;);&lt;/span&gt;
      &lt;span&gt;break&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;
    &lt;span&gt;case&lt;/span&gt; &lt;span&gt;&quot; &quot;&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;
      &lt;span&gt;module&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;toggle_shoot&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;b&lt;/span&gt;&lt;span&gt;);&lt;/span&gt;
      &lt;span&gt;break&lt;/span&gt;&lt;span&gt;;&lt;/span&gt;
  &lt;span&gt;}&lt;/span&gt;
&lt;span&gt;}&lt;/span&gt;
&lt;span&gt;document.&lt;/span&gt;&lt;span&gt;addEventListener&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;'keydown'&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;e&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;processKey&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;e&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;true&lt;/span&gt;&lt;span&gt;));&lt;/span&gt;
&lt;span&gt;document.&lt;/span&gt;&lt;span&gt;addEventListener&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;'keyup'&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;e&lt;/span&gt; &lt;span&gt;=&amp;gt;&lt;/span&gt; &lt;span&gt;processKey&lt;/span&gt;&lt;span&gt;(&lt;/span&gt;&lt;span&gt;e&lt;/span&gt;&lt;span&gt;.&lt;/span&gt;&lt;span&gt;key&lt;/span&gt;&lt;span&gt;,&lt;/span&gt; &lt;span&gt;false&lt;/span&gt;&lt;span&gt;));&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Even though the &lt;code&gt;wasm32-unknown-unknown&lt;/code&gt; target is quite new, it clearly has a lot of potential. I am impressed by the fact that I was able to port Rocket with almost no modifications to the game logic code. In the end, I ended up spending most of the time dealing with rendering and figuring out how to correctly set up the integration between Javascript and Rust.&lt;/p&gt;

&lt;p&gt;Comment on &lt;a href=&quot;https://www.reddit.com/r/rust/comments/7ha3gj/rocket_a_rust_game_running_on_wasm/&quot;&gt;reddit&lt;/a&gt; or &lt;a href=&quot;https://news.ycombinator.com/item?id=15843064&quot;&gt;HN&lt;/a&gt;!&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://aochagavia.github.io/&quot;&gt;Back to posts&lt;/a&gt;&lt;/p&gt;
</description>
<pubDate>Mon, 04 Dec 2017 11:10:43 +0000</pubDate>
<dc:creator>wofo</dc:creator>
<dc:language>en-us</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://aochagavia.github.io/blog/rocket---a-rust-game-running-on-wasm/</dc:identifier>
</item>
<item>
<title>I tried emailing like a CEO and it made my life better</title>
<link>https://www.buzzfeed.com/katienotopoulos/i-tried-emailing-like-your-boss?utm_term=.akmXrGr77w#.reA9OXO33o</link>
<guid isPermaLink="true" >https://www.buzzfeed.com/katienotopoulos/i-tried-emailing-like-your-boss?utm_term=.akmXrGr77w#.reA9OXO33o</guid>
<description>&lt;div class=&quot;subbuzz subbuzz-image xs-mb4 xs-relative xs-mb4&quot; data-module=&quot;subbuzz-image&quot;&gt;


&lt;div class=&quot;flex xs-flex-column&quot; readability=&quot;3.8161290322581&quot;&gt;&lt;span class=&quot;subbuzz__attribution js-subbuzz__attribution subbuzz__attribution--compact xs-text-6 xs-block&quot;&gt;Ethan Miller / Getty Images&lt;/span&gt;
&lt;div class=&quot;subbuzz__description subbuzz__description--compact&quot; readability=&quot;8&quot;&gt;
&lt;p&gt;Mark Cuban, a man unburdened by guilt over unanswered emails.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;subbuzz subbuzz-text xs-mb4 xs-relative&quot; data-module=&quot;subbuzz-text&quot; readability=&quot;68.765120967742&quot;&gt;&lt;p&gt;Like any good member of the proletariat who wants nothing more than to serve capitalism, I am always looking for ways to be more productive at work. And one area where I have more than a lot of room for improvement is keeping up with email.&lt;/p&gt;
&lt;p&gt;Look, I could be worse. I’m fairly organized — I use the tabbed Gmail inbox with a healthy number of colored labels and filters. At one point, I even maintained inbox zero, but those days are long gone. My problem is I still let emails slip through the cracks unanswered, occasionally causing problems. I recently searched my sent emails for the term “sorry” and found more than I wish to admit in which I said some version of “sorry for the late reply.”&lt;/p&gt;
&lt;p&gt;What trips me up most is my habit of scanning my inbox, often on my phone, opening an email, reading it, and thinking, “I’ll reply to that later when I’m at my computer and/or not in the middle of this other project and can give a full reply.” Then I leave it marked as “read” and forget about it. I check my inbox constantly, but I only actually deal with my emails in a deliberate way during a few dedicated chunks of my day.&lt;/p&gt;
&lt;p&gt;My email situation isn’t the worst. I’ve seen people with &lt;a href=&quot;https://www.buzzfeed.com/iexplorer/inbox-zero-inbox-schmero?utm_term=.cuo0nx454#.nnRYvwK8K&quot; data-skimlinks-tracking=&quot;4686548&quot;&gt;HORRIFYING numbers of unread emails&lt;/a&gt;. I typically only hover around 1,000, but it causes me stress and it’s not helping me do my best work. I would like to live my best life. I would like to live a life where I’m “good” at email and also shower every day and floss and stop biting my cuticles and am kinder to dogs. However, I know that I only have any hope of accomplishing the first item on that list.&lt;/p&gt;
&lt;p&gt;My actual exposure to people who are extremely quick with email replies is somewhat limited. But my main inspo came from two unseemly places: the Sony email hack and the DNC leak that revealed Hillary Clinton’s emails. In the Sony hack, I was fascinated by executives like Amy Pascal’s quick, terse messages. How did people communicate like this?! I was agog.&lt;/p&gt;
&lt;/div&gt;

&lt;div class=&quot;subbuzz subbuzz-text xs-mb4 xs-relative&quot; data-module=&quot;subbuzz-text&quot; readability=&quot;39&quot;&gt;&lt;p&gt;Seeing Clinton’s emails was a whole new can of worms — quick emails to her staff, as well as longer, formal emails to other people. She had both a mastery of email and a complete bumbling lack of understanding of it. It was a hypnotic train wreck, and I wanted in. I want to be the kind of person who just replies with a single word, or forwards an email to my assistant to have them take care of it — how amazing would THAT be?&lt;/p&gt;
&lt;/div&gt;


&lt;div class=&quot;subbuzz subbuzz-text xs-mb4 xs-relative&quot; data-module=&quot;subbuzz-text&quot; readability=&quot;57&quot;&gt;&lt;p&gt;Look, I know: Having my takeaway about Hillary Clinton from the DNC email hack be “I’d like to emulate her email style” is supremely fucked up, but that’s where my priorities lie. I’m like a dumb dog who only cares about what’s in front of my face, and that isn’t who’s president. It’s what the red number on my mail app is.&lt;/p&gt;
&lt;p&gt;Let’s call this “boss email.” It’s defined by nearly immediate — but short and terse — replies. The classic two-word email. For underlings, it can be inscrutable. Is that an angry “thanks” or a grateful “thanks”? Does “please update me” imply impatience with you? Boss email can be the workplace equivalent of getting a “k” text reply from a Tinder date.&lt;/p&gt;
&lt;p&gt;One of the features of this is that it would feel wholly inappropriate for an underling to reply to their boss using the same fast terseness. So is the boss email also a power move, a way of asserting dominance? I doubt many bosses sit staring at their employees’ emails trying to figure out what “ok” &lt;em&gt;really&lt;/em&gt; meant.&lt;/p&gt;
&lt;p&gt;Ben Smith, the boss here at BuzzFeed News, has a very specific boss email style that we here have gotten used to. He’s a practitioner of the classic put-the-whole-email-in-the-subject-line method. This is often just a few words, with maybe just a word or two in the body of the email.&lt;/p&gt;
&lt;/div&gt;

&lt;div class=&quot;subbuzz subbuzz-text xs-mb4 xs-relative&quot; data-module=&quot;subbuzz-text&quot; readability=&quot;56&quot;&gt;&lt;p&gt;I emailed Mark Cuban, owner of the Dallas Mavericks and star of TV’s &lt;em&gt;Shark Tank&lt;/em&gt;, because he is known for responding right away to anyone who emails him, and because now I can give this story the headline, “Mark Cuban’s Advice About Email” for LinkedIn. I wanted to know, &lt;em&gt;did you always email this way, or did you only start once you became the boss&lt;/em&gt;? His answer (over email): “Yes.” I’m going to assume the &lt;em&gt;yes&lt;/em&gt; was to the first part of the question and he skimmed over part two.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;He also says he doesn’t worry about coming off as rude. Of all the things I envy Mark Cuban for — his millions, getting to hang with sports players — not worrying about being rude over email is probably the thing I envy most. Imagine being so free from social anxiety! Good lord.&lt;br/&gt;&lt;/p&gt;

&lt;p&gt;On a Monday morning, I began my experiment. I opened my email, deleted a few purely mailing list items, and got to work. For all the PR pitches I wasn’t interested in, I fired off a quick, “Thanks, but this is a pass for me.” It felt empowering.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;subbuzz subbuzz-image xs-mb4 xs-relative xs-mb4&quot; data-module=&quot;subbuzz-image&quot;&gt;

&lt;h3 class=&quot;subbuzz__title xs-mb1 bold&quot;&gt;&lt;span class=&quot;js-subbuzz__title-text&quot;&gt;My new, useful quick reply:&lt;/span&gt;&lt;/h3&gt;


&lt;/div&gt;
&lt;div class=&quot;subbuzz subbuzz-text xs-mb4 xs-relative&quot; data-module=&quot;subbuzz-text&quot; readability=&quot;57&quot;&gt;&lt;p&gt;The week before the experiment, I sent 21 emails total.&lt;/p&gt;
&lt;p&gt;The week I started the experiment, I sent 84. (To be fair, about 25 of those were replies to people who emailed me specifically after I tweeted out that I was doing this experiment. I got a bunch of jokey emails, which I dutifully replied to.)&lt;/p&gt;
&lt;p&gt;The other key part of boss-style email is doing a lot of email on the phone. This meant goodbye to my old crutch of “I’ll reply when I get to a computer.” I would fire off emails from my phone on the subway, walking around at lunch, on the toilet at the office. For the first time, I actually started using the suggested Gmail replies, which are actually pretty useful in the sense of purely transmitting information.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;That first Monday, as I fired off a bunch of not-super-important emails, something strange happened. I felt…extremely good. I was high on the fumes of efficiency. No longer did a little cloud hang over me, the nagging feeling you get when you know you’re supposed to do something and can’t remember what.&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;subbuzz subbuzz-image xs-mb4 xs-relative col xs-col-12 xs-z1 md-col-6 xs-mb4 md-mb2 md-pr3&quot; data-module=&quot;subbuzz-image&quot;&gt;


&lt;div class=&quot;flex xs-flex-column&quot; readability=&quot;2.7731092436975&quot;&gt;
&lt;div class=&quot;subbuzz__description subbuzz__description--compact&quot; readability=&quot;7&quot;&gt;
&lt;p&gt;The suggested Gmail app replies were kind of helpful.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;subbuzz subbuzz-text xs-mb4 xs-relative&quot; data-module=&quot;subbuzz-text&quot; readability=&quot;88&quot;&gt;&lt;p&gt;The high didn’t wear off after that first day. It lasted all week. I applied the method to my personal email as well, and although I don’t get as many personal emails, I found it worked even better there. Personal emails are more likely to be the kind that need a longer response, and you feel even worse guilt for delaying a response. An email from a college friend’s cousin about career advice? I replied immediately and didn’t have to worry about it. Done! On to the next thing!&lt;/p&gt;
&lt;p&gt;For that whole week, I felt extremely productive at work. And I was! I ended up publishing more articles than usual. There was an extra, unexpected effect — I felt less like I needed to check my email in the evening after work. Previously, at night I’d often catch up on email, especially personal emails that I had put off during the workday. No more! At night I was able to relax and watch &lt;em&gt;Stranger Things&lt;/em&gt; without being glued to my phone. I even started going to the gym more regularly! I am literally not joking when I say that I think it made me a better person!&lt;/p&gt;
&lt;p&gt;Although I was delighted that my work-life balance had improved, this did not fit well with my “email like a CEO” plan. The boss does not turn off her phone at 8 p.m.! No! One of the key factors of boss email is 24-hour vigilance. Well, thankfully I just don’t get THAT much important email late at night. No matter how I email, I’m still not actually, ya know, a CEO.&lt;/p&gt;
&lt;p&gt;But for the next two weeks, the high didn’t go away. I made sure I had taken care of all important, recent emails, then hit “mark all as read,” and inbox zeroed myself — a status I lost the ability to keep a few years ago. It felt great.&lt;br/&gt;&lt;/p&gt;
&lt;p&gt;Here’s what I learned: Of all the types of technology that make us feel bad, there’s been a lot of focus on social media — Twitter blasting you with bad news, Facebook or Instagram giving you a warped sense of envy. Email has always sucked, but it's gotten a free pass in our recent examinations of our digital anxiety. Email is a given, it’s old, it’s a thing you need, not a thing you choose. Complaining about email is like a Jay Leno bit from 2002. Perhaps that’s why you fall into a rut with it; you’re not thinking about it too much.&lt;/p&gt;
&lt;p&gt;From now on, I am my own CEO and I am the boss of my inbox. I am going to keep this up.&lt;/p&gt;
&lt;p&gt;My friends, allow me to recommend you give it a try. It has made me unspeakably happy to not stress as about emails anymore by being slightly impolite and quick in my replies. I encourage you all to try it. And if not, feel free to email me (katie@buzzfeed.com), “thanks, that’s a pass for me.”&lt;/p&gt;
&lt;/div&gt;
&lt;div class=&quot;text-gray-lighter fill-gray-lighter xs-mb4&quot; readability=&quot;30.270114942529&quot;&gt;
&lt;div class=&quot;user-bio xs-pt2 xs-px2&quot; readability=&quot;9.1855203619909&quot;&gt;
&lt;p class=&quot;xs-text-5 xs-mb0&quot;&gt;Katie Notopoulos is a senior editor for BuzzFeed News and is based in New York. Notopoulos writes about tech and internet culture is cohost of the Internet Explorer podcast.&lt;/p&gt;
&lt;p class=&quot;xs-text-5 xs-mb0&quot;&gt;Contact Katie Notopoulos at &lt;a href=&quot;mailto:katie@buzzfeed.com&quot;&gt;katie@buzzfeed.com&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;p class=&quot;xs-text-5 xs-p2 text-gray-lighter fill-gray-lighter xs-mb3&quot;&gt;Got a confidential tip? &lt;a href=&quot;https://contact.buzzfeed.com&quot;&gt;Submit it here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;



&lt;div data-module=&quot;ad-bpage-story&quot; id=&quot;BF_WIDGET_9&quot; class=&quot;ad--bpage-story ad-fadedown xs-hide md-block&quot; data-bfa=&quot;@l:Story-Bpage;&quot;&gt;&lt;div id=&quot;bf-item-9-1&quot; class=&quot;xs-mb4 clearfix xs-flex flex card&quot;&gt;

&lt;a href=&quot;https://www.buzzfeed.com/katienotopoulos/i-tried-emailing-like-your-boss?utm_term=.akmXrGr77w#&quot; class=&quot;ad__main-image bf-image-big bf-url bf-bfa js-bfa-impression xs-col-5 md-col-4&quot;&gt;&lt;img class=&quot;&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&quot; role=&quot;presentation&quot;/&gt;&lt;/a&gt;
&lt;div class=&quot;xs-col-7 md-col-8 xs-p1 sm-p2&quot;&gt;
&lt;h3 class=&quot;xs-text-4 sm-text-2 xs-mb2 bold bf-name&quot;/&gt;

&lt;div class=&quot;f-ad-disclosure xs-flex xs-flex-justify-start&quot;&gt;&lt;a href=&quot;https://www.buzzfeed.com/katienotopoulos/i-tried-emailing-like-your-boss?utm_term=.akmXrGr77w#&quot; class=&quot;bf-user-url bf-bfa ad-user--link-image xs-mr1&quot;&gt;&lt;img class=&quot;bf-user_image_large ad-user--image rounded&quot; src=&quot;data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7&quot;/&gt;&lt;/a&gt;
&lt;p&gt;&lt;span class=&quot;bf-byline_prefix text-promoted-orange xs-block xs-text-6&quot;&gt;Promoted by&lt;/span&gt; &lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;xs-mb4&quot; readability=&quot;6&quot;&gt;
&lt;div data-buzzblock=&quot;newsletter-signup&quot; data-module=&quot;newsletter-signup&quot; class=&quot;newsletter fill-blue rounded xs-relative xs-p2 xs-mb3 clearfix&quot; data-bfa-impressions=&quot;true&quot; data-bfa=&quot;@l:NewsletterPromo; @d:b-page-bottom;&quot; readability=&quot;8&quot;&gt;&lt;p&gt;News moves fast. Keep up with the BuzzFeed News daily email!&lt;/p&gt;

&lt;div class=&quot;js-newsletter__success-message xs-mx1 text-white js-hidden&quot; readability=&quot;32&quot;&gt;
&lt;p class=&quot;success-message-title xs-mb1 bold&quot;&gt;Great!&lt;/p&gt;
&lt;p class=&quot;js-newsletter__success-text success-message-text&quot;&gt;You're almost there! Check your inbox and confirm your subscription now!&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;section class=&quot;contributions js-unsupported xs-mb4&quot; data-module=&quot;contributions&quot; data-bfa=&quot;@l:Contributions;&quot;&gt;&lt;button class=&quot;js-contributions__button contributions__button button--facebook js-contributions__button--facebook button button--icon xs-block xs-col-12 js-hidden&quot; data-type=&quot;show&quot; data-bfa=&quot;@a:Show-Responses;&quot;&gt;&lt;span class=&quot;js-contributions__button-text&quot;&gt;View Comments&lt;/span&gt;&lt;/button&gt;

&lt;/section&gt;
</description>
<pubDate>Mon, 04 Dec 2017 06:19:59 +0000</pubDate>
<dc:creator>ajoy</dc:creator>
<og:url>https://www.buzzfeed.com/katienotopoulos/i-tried-emailing-like-your-boss</og:url>
<og:image>https://img.buzzfeed.com/buzzfeed-static/static/2017-12/2/14/campaign_images/buzzfeed-prod-fastlane-02/i-tried-emailing-like-a-ceo-and-quite-frankly-it--2-14270-1512243363-0_dblbig.jpg</og:image>
<og:title>I Tried Emailing Like A CEO And Quite Frankly, It Made My Life Better</og:title>
<og:description>Replying immediately and with two words to all emails is actually heaven.</og:description>
<og:type>article</og:type>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.buzzfeed.com/katienotopoulos/i-tried-emailing-like-your-boss</dc:identifier>
</item>
<item>
<title>Reflecting on Haskell in 2017</title>
<link>http://www.stephendiehl.com/posts/haskell_2018.html</link>
<guid isPermaLink="true" >http://www.stephendiehl.com/posts/haskell_2018.html</guid>
<description>&lt;p&gt;Alas, another year has come and gone. It feels like just yesterday I was writing the last reflection blog post on my flight back to Boston for Christmas. I’ve spent most of the last year traveling and working in Europe, meeting a lot of new Haskellers and putting a lot of faces to names.&lt;/p&gt;
&lt;p&gt;Haskell has had a great year and 2017 was defined by vast quantities of new code, including 14,000 new &lt;a href=&quot;https://github.com/search?utf8=%E2%9C%93&amp;amp;q=language%3Ahaskell+created%3A%3E2017-01-01&amp;amp;type=&quot;&gt;Haskell projects&lt;/a&gt; on Github . The amount of writing this year was voluminous and my list of interesting work is eight times as large as last year. At least seven new companies came into existence and many existing firms unexpectedly dropped large open source Haskell projects into the public sphere. Driven by a lot of software catastrophes, the intersection of security, software correctness and formal methods have been become quite an active area of investment and research across both industry and academia. It’s really never been an easier and more exciting time to be programming professionally in the world’s most advanced (yet usable) statically typed language.&lt;/p&gt;
&lt;p&gt;Per what I guess is now a tradition, I will write my end of year retrospective on my highlights of what happened in the Haskell scene in retrospect.&lt;/p&gt;
&lt;h4 id=&quot;writing&quot;&gt;Writing&lt;/h4&gt;
&lt;p&gt;The amount of Haskell writing this year was vast and it’s impossible to enumerate all of the excellent writing that occurred. Some of the truly exceptional bits that were drafted in 2017 included:&lt;/p&gt;
&lt;h4 id=&quot;books-courses&quot;&gt;Books &amp;amp; Courses&lt;/h4&gt;
&lt;p&gt;Vladislav Zavialov and Artyom Kazak set out to write a book on the netherlands of Intermediate Haskell development, a mythical place that we all seemingly pass through but never speak of again. The project is intuitively called &lt;a href=&quot;https://intermediatehaskell.com/&quot;&gt;Intermediate Haskell&lt;/a&gt; and is slated to be released in 2018&lt;/p&gt;
&lt;p&gt;Bartosz Milewski finished writing &lt;a href=&quot;https://bartoszmilewski.com/2014/10/28/category-theory-for-programmers-the-preface/&quot;&gt;Category Theory for Programmers&lt;/a&gt; which is freely available and also generated as &lt;a href=&quot;https://github.com/hmemcpy/milewski-ctfp-pdf/releases/download/v0.4/category-theory-for-programmers.pdf&quot;&gt;PDF&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Brent Yorgey drafted a new course for teaching introduction to Computer Science using Haskell at &lt;a href=&quot;http://ozark.hendrix.edu/~yorgey/360/f16/&quot;&gt;Hendrix University&lt;/a&gt;. Dmitry Kovanikov and Arseniy Seroka also drafted a course for a wide variety of &lt;a href=&quot;https://github.com/jagajaga/FP-Course-ITMO&quot;&gt;intermediate to advanced Haskell topics&lt;/a&gt; at ITMO university. Some of which are in Russian but nevertheless большое спасибо!&lt;/p&gt;
&lt;h4 id=&quot;ghc&quot;&gt;GHC&lt;/h4&gt;
&lt;p&gt;The Glorious Glasgow Haskell Compiler had it’s 8.2 release, and landed to much rejoicing. Major features such as unboxed sum types landed as planned in GHC 8.2. There were many longstanding issues that were closed and many miscellaneous fixes contributed in 2017. For instance GHC now uses alternative linkers such as &lt;code&gt;ld.gold&lt;/code&gt; or &lt;code&gt;ld.lld&lt;/code&gt; instead of the system default ld.&lt;/p&gt;
&lt;p&gt;Semigroup is now a &lt;a href=&quot;https://prime.haskell.org/wiki/Libraries/Proposals/SemigroupMonoid&quot;&gt;superclass of Monoid&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There was quite a bit of work on GHC &lt;a href=&quot;https://medium.com/@zw3rk&quot;&gt;cross compilation&lt;/a&gt; to ARM. The new build system &lt;a href=&quot;https://github.com/snowleopard/hadrian&quot;&gt;Hadrian&lt;/a&gt; has been in work for the past three years, has was finally been merged into the GHC tree.&lt;/p&gt;
&lt;p&gt;The DevOps Group has officially started and is being funded to help maintain the infrastructure used to host Haskell packages and build GHC. The general push of the group has been toward using hosted CI services, Appveyor and CircleCI and a greater use of more transparent platforms such as Github for GHC development.&lt;/p&gt;
&lt;p&gt;There is work on a major refactor of the AST types to use the new &lt;a href=&quot;https://ghc.haskell.org/trac/ghc/wiki/ImplementingTreesThatGrow&quot;&gt;Trees that Grow&lt;/a&gt; research to allow GHC API user to extend the AST for their own purposes. Eventually this may allow the split of the AST types out of the ghc package, allowing tooling authors, Template Haskell users, and the compiler itself to use the same AST representation.&lt;/p&gt;
&lt;p&gt;GHC is partially accepting pull requests on &lt;a href=&quot;https://github.com/ghc/ghc/pull/14&quot;&gt;Github&lt;/a&gt; although most of the development still occurs on the mailing list and Phabricator.&lt;/p&gt;
&lt;p&gt;There was significant engineering effort to allow GHC to produce &lt;a href=&quot;https://ghc.haskell.org/trac/ghc/wiki/DeterministicBuilds&quot;&gt;deterministic build artifacts&lt;/a&gt; to play nicely with caching reproducible build systems such as Buck and Bazel. Previously the emitted &lt;code&gt;.hi&lt;/code&gt; files would contain non-deterministic data such as hashes, timestamps and unique name supply counts.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Errors&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;GHC 8.2 added wonderful new colorful error messages with caret diagnostics for syntax and type errors:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://www.stephendiehl.com/images/ghc_errors.jpg&quot; alt=&quot;Colorful errors GHC 8.2&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Compact Regions&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Support for ‘Compact Regions’ landed in GHC 8.2. Compact regions are manually allocated regions where the data allocated inside it are compacted and not traversed by the GC. This is amenable for long-lived data structures that are resident in memory without mutation frequently occurring.&lt;/p&gt;
&lt;p&gt;The interface can be accessed through the &lt;a href=&quot;https://hackage.haskell.org/package/ghc-compact&quot;&gt;ghc-compact&lt;/a&gt; modules and used to create compact malloc’d memory.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;&lt;span class=&quot;kw&quot;&gt;import &lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Control.DeepSeq&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;import &lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Control.Exception&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;import qualified&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Data.ByteString.Char8&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;B&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;import &lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Data.Compact&lt;/span&gt;

main &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; compact (B.pack [&lt;span class=&quot;ch&quot;&gt;'a'&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;..&lt;/span&gt;&lt;span class=&quot;ch&quot;&gt;'c'&lt;/span&gt;])&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/shlevy/ghc/tree/f1dfce1cb2a823696d6d3a9ea41c2bc73d949f12/libraries/compact/tests&quot;&gt;test suite&lt;/a&gt; inside GHC maintains the best illustrations of its use for complex non-traditional data structures.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Type.Reflection&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;GHC added a new more expressive Typeable mechanism using the &lt;a href=&quot;https://downloads.haskell.org/~ghc/master/libraries/base/base/Type-Reflection.html&quot;&gt;&lt;code&gt;Type.Reflection&lt;/code&gt;&lt;/a&gt; module. &lt;code&gt;typeRep&lt;/code&gt; can be applied with explicit type applications to arrows and functions can checked for type-level equality after application.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;λ&lt;span class=&quot;fu&quot;&gt;&amp;gt;&lt;/span&gt; typeRep &lt;span class=&quot;fu&quot;&gt;@&lt;/span&gt;(&lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;)
(&lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;) &lt;span class=&quot;ch&quot;&gt;'LiftedRep '&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;LiftedRep&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;λ&lt;span class=&quot;fu&quot;&gt;&amp;gt;&lt;/span&gt; typeRep &lt;span class=&quot;fu&quot;&gt;@&lt;/span&gt;(&lt;span class=&quot;dt&quot;&gt;Maybe&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;) &lt;span class=&quot;fu&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;App&lt;/span&gt; (typeRep &lt;span class=&quot;fu&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Maybe&lt;/span&gt;) (typeRep &lt;span class=&quot;fu&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;)
&lt;span class=&quot;dt&quot;&gt;True&lt;/span&gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;Coercible&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Not new to GHC 8.2 although the base library now exposes the &lt;code&gt;Coercible&lt;/code&gt; constraints allowing polymorphism over types which have the same runtime representations to be safely coerced at runtime. This can also be extended to polymorphic functions which take a compile-time proof of the equivalence of two runtime data layouts.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;&lt;span class=&quot;kw&quot;&gt;import &lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Data.Coerce&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;newtype&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Meters&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Meters&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Integer&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;deriving&lt;/span&gt; (&lt;span class=&quot;dt&quot;&gt;Num&lt;/span&gt;)
&lt;span class=&quot;kw&quot;&gt;newtype&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Feet&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Feet&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Integer&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;deriving&lt;/span&gt; (&lt;span class=&quot;dt&quot;&gt;Num&lt;/span&gt;)

&lt;span class=&quot;ot&quot;&gt;f ::&lt;/span&gt; (&lt;span class=&quot;dt&quot;&gt;Coercible&lt;/span&gt; a b, &lt;span class=&quot;dt&quot;&gt;Num&lt;/span&gt; b) &lt;span class=&quot;ot&quot;&gt;=&amp;gt;&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; b &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; b
f x y &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; coerce x &lt;span class=&quot;fu&quot;&gt;+&lt;/span&gt; y&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;λ&lt;span class=&quot;fu&quot;&gt;&amp;gt;&lt;/span&gt; f (&lt;span class=&quot;dt&quot;&gt;Meters&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;) &lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;
λ&lt;span class=&quot;fu&quot;&gt;&amp;gt;&lt;/span&gt; f (&lt;span class=&quot;dt&quot;&gt;Feet&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;) &lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt;
λ&lt;span class=&quot;fu&quot;&gt;&amp;gt;&lt;/span&gt; f &lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt; (&lt;span class=&quot;dt&quot;&gt;Feet&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;)
&lt;span class=&quot;dt&quot;&gt;Feet&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;7&lt;/span&gt; &lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;GHC tracks the usage (i.e. role) of type variables used as parameters as either &lt;code&gt;nominal&lt;/code&gt; &lt;code&gt;representational&lt;/code&gt; or &lt;code&gt;phantom&lt;/code&gt; allowing types that differ only in a phantom type of nominal parameters to be safely coerced.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Join Points&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Luke Maurer and Simon Peyton Jones merged new work on &lt;a href=&quot;https://ghc.haskell.org/trac/ghc/wiki/SequentCore&quot;&gt;join points&lt;/a&gt; which modifies GHC Core to optimize for join points in code. In Core, a &lt;em&gt;join point&lt;/em&gt; is a specially tagged function whose only occurrences are saturated tail calls. In the actual GHC Core AST, a join point is simple bit of metadata indicated by &lt;code&gt;IdDetails&lt;/code&gt; of the binder.&lt;/p&gt;
&lt;p&gt;Simon Peyton Jones presented the keynote at Haskell Exchange on his collaboration on &lt;a href=&quot;https://skillsmatter.com/skillscasts/9182-keynote-compiling-without-continuations&quot;&gt;Compiling without Continuation&lt;/a&gt; which present the ideas and core optimizations that are allowed by the new join points.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Deriving Strategies&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In GHC 8.0 there were two alternative methods for automatic deriving of typeclass instances, using &lt;code&gt;GeneralizedNewtypeDeriving&lt;/code&gt; and &lt;code&gt;DeriveAnyClass&lt;/code&gt;. In addition there was also the wired-in deriving mechanisms for &lt;code&gt;Show&lt;/code&gt;, &lt;code&gt;Read&lt;/code&gt;, etc that were hardcoded into the compiler. These all used the same syntax and would conflict if multiple pragmas were enabled in a module.&lt;/p&gt;
&lt;p&gt;The addition of &lt;code&gt;DerivingStrategies&lt;/code&gt; allows us to disambiguate which deriving mechanism to use for a specific instance generation.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;&lt;span class=&quot;kw&quot;&gt;newtype&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Meters&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Meters&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;
  &lt;span class=&quot;kw&quot;&gt;deriving&lt;/span&gt; stock    (&lt;span class=&quot;dt&quot;&gt;Read&lt;/span&gt;, &lt;span class=&quot;dt&quot;&gt;Show&lt;/span&gt;)
  &lt;span class=&quot;kw&quot;&gt;deriving&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;newtype&lt;/span&gt;  (&lt;span class=&quot;dt&quot;&gt;Num&lt;/span&gt;)
  &lt;span class=&quot;kw&quot;&gt;deriving&lt;/span&gt; anyclass (&lt;span class=&quot;dt&quot;&gt;ToJSON&lt;/span&gt;, &lt;span class=&quot;dt&quot;&gt;FromJSON&lt;/span&gt;)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;backpack&quot;&gt;Backpack&lt;/h4&gt;
&lt;p&gt;Edward Yang finished his PhD thesis on Backpack which was integrated in the GHC tree. The new branch adds support &lt;code&gt;.bkp files&lt;/code&gt;, which specify abstract interfaces which can be instantiated in modules and used to construct Haskell modules which work polymorphically across multiple module instantiations.&lt;/p&gt;
&lt;p&gt;For example an abstract string type can be written which operates over a module parameter `Str``:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;unit abstract&lt;span class=&quot;fu&quot;&gt;-&lt;/span&gt;str &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
    signature &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;        len ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;

    &lt;span class=&quot;kw&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;AStr&lt;/span&gt; (alen) &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;import &lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt;

&lt;span class=&quot;ot&quot;&gt;        alen ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;
        alen &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; len&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can create (contrived) instantiations of this module for lists of ints and chars which expose a polymorphic length function over both.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;unit str&lt;span class=&quot;fu&quot;&gt;-&lt;/span&gt;string &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;String&lt;/span&gt;

&lt;span class=&quot;ot&quot;&gt;        len ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;
        len &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; length

unit str&lt;span class=&quot;fu&quot;&gt;-&lt;/span&gt;list &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
    &lt;span class=&quot;kw&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; [&lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;]

&lt;span class=&quot;ot&quot;&gt;        len ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt; &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;
        len &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; length&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The modules can then be opened as speific namespaces with the exported functions able to be called over both module types.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;12&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;unit main &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
    dependency abstract&lt;span class=&quot;fu&quot;&gt;-&lt;/span&gt;str[&lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt;str&lt;span class=&quot;fu&quot;&gt;-&lt;/span&gt;string&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt;] (&lt;span class=&quot;dt&quot;&gt;AStr&lt;/span&gt; as &lt;span class=&quot;dt&quot;&gt;AStr.Int&lt;/span&gt;)
    dependency abstract&lt;span class=&quot;fu&quot;&gt;-&lt;/span&gt;str[&lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt;str&lt;span class=&quot;fu&quot;&gt;-&lt;/span&gt;list&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Str&lt;/span&gt;] (&lt;span class=&quot;dt&quot;&gt;AStr&lt;/span&gt; as &lt;span class=&quot;dt&quot;&gt;AStr.String&lt;/span&gt;)

    &lt;span class=&quot;kw&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Main&lt;/span&gt; (main) &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;import qualified&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;AStr.Int&lt;/span&gt;
        &lt;span class=&quot;kw&quot;&gt;import qualified&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;AStr.String&lt;/span&gt;

&lt;span class=&quot;ot&quot;&gt;        main ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;IO&lt;/span&gt; ()
        main &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;do&lt;/span&gt;
            print &lt;span class=&quot;fu&quot;&gt;$&lt;/span&gt; AbstractStr.String.alen &lt;span class=&quot;st&quot;&gt;&quot;Hello world&quot;&lt;/span&gt;
            print &lt;span class=&quot;fu&quot;&gt;$&lt;/span&gt; AbstractStr.Int.alen [&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;, &lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;]&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With the latest GHC this can be compiled with the &lt;code&gt;--backpack&lt;/code&gt; which generates the sum of all the &lt;code&gt;hi&lt;/code&gt; files specified in the &lt;code&gt;.bkp&lt;/code&gt; file and resolves values at link-time.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;7&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;$ &lt;span class=&quot;kw&quot;&gt;stack&lt;/span&gt; exec -- ghc --backpack example.bkp&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;While the functionality exists today, I’m not aware of any large projects using Backpack. Bolting this functionality onto an ecosystem that has spent a decade routing around many of the problems this system aims to solve, poses a huge engineering cost and may take a while to crystallize.&lt;/p&gt;
&lt;h4 id=&quot;summer-of-haskell&quot;&gt;Summer of Haskell&lt;/h4&gt;
&lt;p&gt;Google lacked vision this year and did not sponsor the Haskell Organization for Summer of Code. But the program proceeded regardless with private sponsorship from industrial users. Fifteen students were paired with mentors and many successful projects and &lt;a href=&quot;https://summer.haskell.org/news/2017-09-15-final-results.html&quot;&gt;collaborations resulted&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&quot;llvm&quot;&gt;LLVM&lt;/h4&gt;
&lt;p&gt;The LLVM bindings for Haskell saw quite a bit of work this year and were forked into a new organization &lt;a href=&quot;https://www.github.com/llvm-hs&quot;&gt;llvm-hs&lt;/a&gt; and added support for LLVM 4.0 - 5.1:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/llvm-hs/llvm-hs/tree/llvm-5/llvm-hs&quot;&gt;llvm-hs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/llvm-hs/llvm-hs/tree/llvm-5/llvm-hs-pure&quot;&gt;llvm-hs-pure&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/llvm-hs/llvm-hs-pretty/&quot;&gt;llvm-hs-pretty&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;In a collaboration with Joachim Breitner and myself at Zurihac a type-safe LLVM library which embeds the semantics of LLVM instructions into the Haskell &lt;a href=&quot;https://github.com/llvm-hs/llvm-hs-typed&quot;&gt;type-system&lt;/a&gt; was written.&lt;/p&gt;
&lt;p&gt;Siddharth Bhat started work on an STG to LLVM backend &lt;a href=&quot;https://pixel-druid.com/blog/announcing-simplexhc/&quot;&gt;simplehxc&lt;/a&gt; before doing a rewrite in C++.&lt;/p&gt;
&lt;p&gt;Moritz Angermann has been continuing to develop a Haskell library for emitting and reading &lt;a href=&quot;https://github.com/angerman/data-bitcode-llvm&quot;&gt;LLVM Bitcode format&lt;/a&gt; as well as work on the &lt;a href=&quot;https://ghc.haskell.org/trac/ghc/ticket/10074&quot;&gt;llvm-ng&lt;/a&gt; backend which is a major rewrite of the GHC LLVM code generator.&lt;/p&gt;
&lt;h4 id=&quot;linear-types&quot;&gt;Linear Types&lt;/h4&gt;
&lt;p&gt;Arnaud Spiwack prototyped a &lt;a href=&quot;https://github.com/tweag/linear-types&quot;&gt;extension of GHC&lt;/a&gt; which augments the type system with linear types. &lt;a href=&quot;http://edsko.net/2017/01/08/linearity-in-haskell/&quot;&gt;Edsko de Vries&lt;/a&gt; wrote a detailed blog post about the nature of linearity and it’s uses.&lt;/p&gt;
&lt;p&gt;The proposal extends the typing of functions to include linearity constraints on arrows, enforcing that variables or references are created and consumed with constrained reference counts. This allows us to statically enforce reference borrowing and allocations in the typechecker potentially allowing us to enforce lifetime constraints on closures and eliminating long-lived memory from being used with constructed unbounded lifetimes, thereby eliminating garbage collection for some Haskell functions.&lt;/p&gt;
&lt;p&gt;For instance use of the linear arrow &lt;code&gt;(a -&amp;gt;. b)&lt;/code&gt; can enrich the existing raw memory access functions enforcing the matching of allocation and free commands statically. The multiplicity of usage is either &lt;code&gt;0&lt;/code&gt;, &lt;code&gt;1&lt;/code&gt; or &lt;code&gt;ω&lt;/code&gt; and the linear arrow is syntatic sugar for unit multiplicity are aliases for &lt;code&gt;(:'1 -&amp;gt;)&lt;/code&gt;.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;&lt;span class=&quot;ot&quot;&gt;malloc ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Storable&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;=&amp;gt;&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; (&lt;span class=&quot;dt&quot;&gt;Ptr&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Unrestricted&lt;/span&gt; b) &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Unrestricted&lt;/span&gt; b
read&lt;span class=&quot;ot&quot;&gt; ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Storable&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Ptr&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; (&lt;span class=&quot;dt&quot;&gt;Ptr&lt;/span&gt; a, a)
&lt;span class=&quot;ot&quot;&gt;free ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Ptr&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; ()&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;New abstractions such as movable, consumable and dupable references can be constructed out of existing class hierarchies and enriched with static linearity checks:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;18&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Consumable&lt;/span&gt; a &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;  consume ::&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; ()

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Consumable&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Dupable&lt;/span&gt; a &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;  dup ::&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; (a, a)

&lt;span class=&quot;kw&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Dupable&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Movable&lt;/span&gt; a &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;  move ::&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Unrestricted&lt;/span&gt; a

&lt;span class=&quot;kw&quot;&gt;instance&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Dupable&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Dupable&lt;/span&gt; [a] &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
  dup [] &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; ([], [])
  dup (a&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;l) &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; shuffle (dup a) (dup l)
    &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;      shuffle ::&lt;/span&gt; (a, a) &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; ([a], [a]) &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; ([a], [a])
      shuffle (a, a') (l, l') &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; (a&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;l, a'&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;l')

&lt;span class=&quot;kw&quot;&gt;instance&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Consumable&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Consumable&lt;/span&gt; [a] &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;
  consume [] &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; ()
  consume (a&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;l) &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; consume a &lt;span class=&quot;ot&quot;&gt;`lseq`&lt;/span&gt; consume l&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As part of the Summer of Haskell Edvard Hübinette used linear types to construct a safer stream processing library which can enforce resource consumption statically &lt;a href=&quot;https://github.com/m0ar/safe-streaming&quot;&gt;using linearity&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There is considerable debate &lt;a href=&quot;https://github.com/ghc-proposals/ghc-proposals/pull/91&quot;&gt;about the proposal&lt;/a&gt; and the nature of integration of linear types into GHC. With some community involvement these patches could be integrated quite quickly in GHC.&lt;/p&gt;
&lt;h4 id=&quot;liquidhaskell&quot;&gt;LiquidHaskell&lt;/h4&gt;
&lt;p&gt;&lt;a href=&quot;https://ucsd-progsys.github.io/liquidhaskell-blog/&quot;&gt;LiquidHaskell&lt;/a&gt; the large suite of tools for adding refinement types to GHC Haskell continued development and became considerably more polished. At HaskellExchange several companies were using it in anger in production. For example, we can enforce statically the lists given at compile-time statically cannot contain certain values by constructing a proposition function in a (subset) of Haskell which can refine other definitions:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;15&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;measure&lt;span class=&quot;ot&quot;&gt; hasZero ::&lt;/span&gt; [&lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;] &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Prop&lt;/span&gt;
hasZero [] &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; false
hasZero (x&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;xs) &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; x &lt;span class=&quot;fu&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;||&lt;/span&gt; (hasZero xs)

&lt;span class=&quot;kw&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;HasZero&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; {v &lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt; [&lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;] &lt;span class=&quot;fu&quot;&gt;|&lt;/span&gt; (hasZero v)}

&lt;span class=&quot;co&quot;&gt;-- Accepted&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;xs ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;HasZero&lt;/span&gt;
xs &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; [&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;4&lt;/span&gt;]

&lt;span class=&quot;co&quot;&gt;-- Rejected&lt;/span&gt;
&lt;span class=&quot;ot&quot;&gt;ys ::&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;HasZero&lt;/span&gt;
ys &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; [&lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;2&lt;/span&gt;,&lt;span class=&quot;dv&quot;&gt;3&lt;/span&gt;]&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This can be used to &lt;a href=&quot;https://github.com/ucsd-progsys/liquidhaskell/blob/develop/include/Data/Maybe.spec&quot;&gt;statically enforce&lt;/a&gt; that logic that consumes only a Just value can provably only be called with a &lt;code&gt;Just&lt;/code&gt; with a &lt;code&gt;isJust&lt;/code&gt; measure:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;measure&lt;span class=&quot;ot&quot;&gt; isJust ::&lt;/span&gt; forall a&lt;span class=&quot;fu&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Data.Maybe.Maybe&lt;/span&gt; a &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Bool&lt;/span&gt;
isJust (&lt;span class=&quot;dt&quot;&gt;Data.Maybe.Just&lt;/span&gt; x)  &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; true 
isJust (&lt;span class=&quot;dt&quot;&gt;Data.Maybe.Nothing&lt;/span&gt;) &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; false &lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This year saw the addition of inductive predicates allowing more complex properties about non-arithmetic refinements to be checked. Including properties about lists&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;10&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;measure&lt;span class=&quot;ot&quot;&gt; len ::&lt;/span&gt; [a] &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Int&lt;/span&gt;
len [] &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;
len (x&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;xs) &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;+&lt;/span&gt; (len xs)

&lt;span class=&quot;co&quot;&gt;-- Spec for Data.List exports refined types which can be statically refined with&lt;/span&gt;
&lt;span class=&quot;co&quot;&gt;-- length constraints.&lt;/span&gt;
[]&lt;span class=&quot;ot&quot;&gt; ::&lt;/span&gt; {v&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;[a]&lt;span class=&quot;fu&quot;&gt;|&lt;/span&gt; len v &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;0&lt;/span&gt;}
&lt;span class=&quot;ot&quot;&gt;(:) ::&lt;/span&gt; _ &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; xs&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;_ &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; {v&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;[a]&lt;span class=&quot;fu&quot;&gt;|&lt;/span&gt; len v &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;dv&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;fu&quot;&gt;+&lt;/span&gt; len xs}

&lt;span class=&quot;ot&quot;&gt;append ::&lt;/span&gt; xs&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;[a] &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; ys&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;[a] &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; {v&lt;span class=&quot;fu&quot;&gt;:&lt;/span&gt;[a]&lt;span class=&quot;fu&quot;&gt;|&lt;/span&gt; len v &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; len xs &lt;span class=&quot;fu&quot;&gt;+&lt;/span&gt; len ys}&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The full library of specifications is now quite extensive and adding &lt;a href=&quot;https://github.com/ucsd-progsys/liquidhaskell/blob/develop/include&quot;&gt;LiquidHaskell&lt;/a&gt; to an existing codebase is pretty seamelss&lt;/p&gt;
&lt;h4 id=&quot;foundation&quot;&gt;Foundation&lt;/h4&gt;
&lt;p&gt;Foundation is an alternative Prelude informed by modern design practices and data structures. It ships a much more sensible and efficient packed array of UTF8 points as it’s default &lt;a href=&quot;https://hackage.haskell.org/package/foundation-0.0.17/docs/Foundation-String.html&quot;&gt;&lt;code&gt;String&lt;/code&gt;&lt;/a&gt; type. Rethinks the &lt;code&gt;Num&lt;/code&gt; &lt;a href=&quot;https://hackage.haskell.org/package/foundation-0.0.17/docs/Foundation-Numerical.html&quot;&gt;numerical tower&lt;/a&gt; , and statically distinguishes &lt;a href=&quot;https://hackage.haskell.org/package/foundation-0.0.17/docs/Foundation.html#t:Partial&quot;&gt;partial functions&lt;/a&gt;. Also has fledgling documentation beyond just&lt;/p&gt;
&lt;p&gt;Last year Foundation was a bit early, but this year at Zurihac several companies in London reported using it fully in production as a full industrial focused Prelude.&lt;/p&gt;
&lt;h4 id=&quot;editor-tooling&quot;&gt;Editor Tooling&lt;/h4&gt;
&lt;p&gt;Editor integration improved, adding best in modern tooling to most of the common editors:&lt;/p&gt;
&lt;table&gt;&lt;colgroup&gt;&lt;col width=&quot;24%&quot;/&gt;&lt;col width=&quot;75%&quot;/&gt;&lt;/colgroup&gt;&lt;thead/&gt;&lt;tbody readability=&quot;5&quot;&gt;&lt;tr class=&quot;odd&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;
&lt;p&gt;&lt;strong&gt;Atom&lt;/strong&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td align=&quot;left&quot; readability=&quot;5&quot;&gt;
&lt;p&gt;https://atom.io/packages/ide-haskell&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;
&lt;p&gt;&lt;strong&gt;Emacs&lt;/strong&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td align=&quot;left&quot; readability=&quot;5&quot;&gt;
&lt;p&gt;https://commercialhaskell.github.io/intero/&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;
&lt;p&gt;&lt;strong&gt;IntelliJ&lt;/strong&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td align=&quot;left&quot; readability=&quot;5&quot;&gt;
&lt;p&gt;https://plugins.jetbrains.com/plugin/8258-intellij-haskell&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;
&lt;p&gt;&lt;strong&gt;VSCode&lt;/strong&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td align=&quot;left&quot; readability=&quot;5&quot;&gt;
&lt;p&gt;https://marketplace.visualstudio.com/items?itemName=Vans.haskero&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot; readability=&quot;3&quot;&gt;&lt;td align=&quot;left&quot;&gt;
&lt;p&gt;&lt;strong&gt;Sublime&lt;/strong&gt;&lt;/p&gt;
&lt;/td&gt;
&lt;td align=&quot;left&quot; readability=&quot;5&quot;&gt;
&lt;p&gt;https://packagecontrol.io/packages/SublimeHaskell&lt;/p&gt;
&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;Monica Lent wrote a lovely post on the state of art in &lt;a href=&quot;http://monicalent.com/blog/2017/11/19/haskell-in-vim/&quot;&gt;Vim and Haskell integration&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Rik van der Kleij has done an impressive amount of work adapting the IntellJ IDE to &lt;a href=&quot;https://github.com/rikvdkleij/intellij-haskell&quot;&gt;work with Haskell&lt;/a&gt;. Including a custom parser handling all of the syntax extensions, name lookup, Intero integration and integration with haskell-tools refactoring framework.&lt;/p&gt;
&lt;p&gt;Development on the &lt;a href=&quot;https://github.com/haskell/haskell-ide-engine&quot;&gt;haskell-ide-engine&lt;/a&gt; has picked up again in the last few months.&lt;/p&gt;
&lt;h4 id=&quot;formal-methods&quot;&gt;Formal Methods&lt;/h4&gt;
&lt;p&gt;The &lt;a href=&quot;https://deepspec.org/page/Research/&quot;&gt;DeepSpec&lt;/a&gt;, a collaboration between MIT, UPenn, Princeton and Yale, is working on a network of specification that span many compilers, languages and intermediate representations with the goal of achieving full functional correctness of software and hardware. Both Haskell and LLVM are part of this network of specifications. The group has successfully written a new formal calculus describing the GHC core language and proved it type sound in Coq. The project is called &lt;a href=&quot;https://github.com/sweirich/corespec&quot;&gt;corespec&lt;/a&gt; and is described in the paper “A Specification for Dependent Types in Haskell”.&lt;/p&gt;
&lt;p&gt;In addition the group also published a paper “Total Haskell is Reasonable Coq” and provided a utlity &lt;a href=&quot;https://github.com/antalsz/hs-to-coq&quot;&gt;hs-to-coq&lt;/a&gt; which converts haskell code to equivalent Coq code.&lt;/p&gt;
&lt;p&gt;The Galois group started &lt;a href=&quot;https://github.com/GaloisInc/cryptol-semantics&quot;&gt;formalizing the semantics&lt;/a&gt; of Cryptol, a compiler for high-assurance cryptographic protocols which is itself written in Haskell.&lt;/p&gt;
&lt;p&gt;Michael Burge wrote a cheeky article about extracting a specification for a &lt;a href=&quot;http://www.michaelburge.us/2017/08/25/writing-a-formally-verified-porn-browser-in-coq.html&quot;&gt;“domain specific” browser&lt;/a&gt; from Coq into Haskell.&lt;/p&gt;
&lt;h4 id=&quot;pragma-proliferation-prelude&quot;&gt;Pragma Proliferation &amp;amp; Prelude&lt;/h4&gt;
&lt;p&gt;Writing Haskell is almost trivial in practice. You just start with the magic fifty line &lt;code&gt;{-# LANGUAGE ... #-}&lt;/code&gt; incantation to fast-forward to 2017, then add 150 libraries that you’ve blessed by trial and error to your cabal file, and then just write down a single type signature whose inhabitant is &lt;code&gt;Refl&lt;/code&gt; to your program. In fact if your program is longer than your import list you’re clearly doing Haskell all wrong.&lt;/p&gt;
&lt;p&gt;In all seriousness, Haskell is not the small language it once was in 1998, it’s reach spans many industries, hobbyists, academia and many classes of people with different incentives and whose ideas about the future of the language are mutually incompatible. Realistically the reason why the Prelude and extension situation aren’t going to change anytime soon is that no one person or company has the economic means to champion such a change. It would be enormously expensive and any solution will never satisfy everyone’s concerns and desires. &lt;em&gt;Consensus is expensive&lt;/em&gt;, while making everything opt-in is relatively cheap. This is ultimately the equilibrium we’ve converged on and barring some large sea change the language is going to remain in this equilibrium.&lt;/p&gt;
&lt;h4 id=&quot;haskell-survey&quot;&gt;Haskell Survey&lt;/h4&gt;
&lt;p&gt;Taylor Fausak conducted an &lt;a href=&quot;http://taylor.fausak.me/2017/11/15/2017-state-of-haskell-survey-results/&quot;&gt;unofficial survey&lt;/a&gt; of Haskell users with some surprising results about widespread use of Haskell. Surprisingly there are reportedly 100 or more people who maintain 100,000 or more lines of Haskell code. Not so surprisingly most people have migrated to Stack while vim and emacs are the editors of choice.&lt;/p&gt;
&lt;p&gt;While the majority of respondents are satisfied with Haskell the language the response are somewhat mixed the quality of libraries and the bulk of respondents reported Haskell libraries being &lt;em&gt;undocumented&lt;/em&gt; , &lt;em&gt;hard to use&lt;/em&gt; &lt;em&gt;hard to find&lt;/em&gt;, and don’t &lt;em&gt;integrate well&lt;/em&gt;.&lt;/p&gt;
&lt;h4 id=&quot;projects&quot;&gt;Projects&lt;/h4&gt;
&lt;p&gt;Idris, the experimental dependently typed language, reached 1.0 release and became one of the larger languages which is itself written in Haskell.&lt;/p&gt;
&lt;p&gt;The most prolific Haskell library Pandoc released its version 2.0.&lt;/p&gt;
&lt;p&gt;Several other groups published new compilers in the Haksell-family of languages. Intel finally open sourced the &lt;a href=&quot;https://github.com/IntelLabs/flrc&quot;&gt;Intell Haskell compiler&lt;/a&gt; which was a research project in more optimal compilation techniques. Morgan Stanley also released &lt;a href=&quot;http://lambda-the-ultimate.org/node/5452&quot;&gt;Hobbes&lt;/a&gt; a Haskell-like language used internally at the bank featuring several novel extensions to row-types and C++ FFI integration. A prototype Haskell compiler was also written in &lt;a href=&quot;https://github.com/Marwes/haskell-compiler&quot;&gt;Rust&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The SMT solver integration library SBV saw a major rewrite of it’s internal and it’s old &lt;a href=&quot;https://hackage.haskell.org/package/sbv-7.3/docs/Data-SBV-Control.html&quot;&gt;tactics system&lt;/a&gt;. The library is heavily used in various projects as an interface to Z3 and CVC4 solvers.&lt;/p&gt;
&lt;p&gt;Uber released a library for parsing and analysis of Vertica, Hive, and Presto &lt;a href=&quot;https://github.com/uber/queryparser&quot;&gt;SQL queries&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Wire released the &lt;a href=&quot;https://github.com/wireapp/wire-server&quot;&gt;backend service&lt;/a&gt; to their commercial offering.&lt;/p&gt;
&lt;p&gt;The Advanced Telematic Systems group in Berlin released a Quickcheck family library for doing for property testing of models about &lt;a href=&quot;https://github.com/advancedtelematic/quickcheck-state-machine&quot;&gt;state machines&lt;/a&gt;. Bose also released Smudge a tool for doing developemtn and &lt;a href=&quot;https://github.com/Bose/Smudge&quot;&gt;analysis of large state machines&lt;/a&gt; for hardware testing.&lt;/p&gt;
&lt;p&gt;Florian Knupfer released a new high-performance HTML &lt;a href=&quot;https://github.com/knupfer/type-of-html&quot;&gt;combinator library&lt;/a&gt; for templating.&lt;/p&gt;
&lt;p&gt;Galois continued with HalVM unikernel continued development this year, and several &lt;a href=&quot;https://github.com/GaloisInc/HaLVM/wiki/Using-Docker-and-the-HaLVM&quot;&gt;HalVM Docker Imagaes&lt;/a&gt; were published allowing a very convenient way to write and test code against HalVM.&lt;/p&gt;
&lt;p&gt;Facebook released a Haskell string parsing library &lt;a href=&quot;https://github.com/facebook/duckling&quot;&gt;duckling&lt;/a&gt; which parses human input into a restricted set of semantically tagged data. Facebook also prototyped a technique for hot-swapping &lt;a href=&quot;https://simonmar.github.io/posts/2017-10-17-hotswapping-haskell.html&quot;&gt;Haskell code at runtime&lt;/a&gt; using clever GHC API trickery.&lt;/p&gt;
&lt;p&gt;Adjoint released &lt;a href=&quot;https://github.com/adjoint-io/uplink&quot;&gt;Uplink&lt;/a&gt;, a distributed ledger for secure multiparty workflows in financial markets.&lt;/p&gt;
&lt;p&gt;Chris Done released &lt;a href=&quot;https://github.com/chrisdone/vado&quot;&gt;vado&lt;/a&gt; a browser engine written in Haskell.&lt;/p&gt;
&lt;p&gt;Jonas Carpay released &lt;a href=&quot;https://github.com/jonascarpay/apecs&quot;&gt;apecs&lt;/a&gt; an entity component system for game development in Haskell.&lt;/p&gt;
&lt;p&gt;Csaba Hruska continued work on a &lt;a href=&quot;https://github.com/csabahruska/grin&quot;&gt;GRIN compiler&lt;/a&gt; and code generator, an alternative core language for compiling lazy functional languages based on the work by Urban Boquist.&lt;/p&gt;
&lt;p&gt;Dima Szamozvancev released &lt;a href=&quot;https://github.com/DimaSamoz&quot;&gt;mezzo&lt;/a&gt; a library and embedded domain-specific language for music description that can enforce rules of compositionality of music statically and prevent bad music from being unleashed on the world.&lt;/p&gt;
&lt;p&gt;Conal Elliot and John Wiegley advanced a novel set of ideas on &lt;a href=&quot;https://github.com/conal/concat&quot;&gt;Compiling with Categories&lt;/a&gt; which allows the bidirectional representation of Haskell functions as categorical structures. Although currently implemented as a GHC typechecker extension it is a promising research area.&lt;/p&gt;
&lt;p&gt;Harry Clarke published a paper on &lt;a href=&quot;https://www.cs.kent.ac.uk/people/staff/dao7/publ/reprinter2017.pdf&quot;&gt;Generics Layout-Preserving Refactoring&lt;/a&gt; using a &lt;a href=&quot;https://github.com/camfort/reprinter&quot;&gt;reprinter&lt;/a&gt;. i.e. a tool which takes a syntax tree, the original source file, and produces an updated source file which preserves secondary notation. This can be used to build tools like haskell-tools for arbitrary languages and write complicated refactoring suites.&lt;/p&gt;
&lt;p&gt;Joachim Breitner contributed a prolific amount of open source projects including a new technique (ghc-proofs) for proving the equivalence of Haskell programs using a GHC plugin, (veggies) a verified simple LLVM code generator for GHC, and (inspection-testing) new technique for verifying properties of Core.&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/nomeata/veggies&quot;&gt;veggies&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/nomeata/ghc-proofs&quot;&gt;ghc-proofs&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/nomeata/inspection-testing&quot;&gt;inspecction-testing&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;The &lt;a href=&quot;https://www.youtube.com/watch?v=jcL4bp4FMUw&amp;amp;feature=youtu.be&quot;&gt;ghc-proofs plugin&lt;/a&gt; allows us to embed equation and relations into our Haskell module and potentially allow GHC to prove them correct by doing symbolic evaluation and evaluating them as far as possible and checking the equational relations of the equations sides. Right now it works for contrived and simple examples, but is quite a interesting approach that may yield further fruit.&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;8&quot;&gt;
&lt;pre class=&quot;sourceCode haskell&quot;&gt;
&lt;code class=&quot;sourceCode haskell&quot;&gt;&lt;span class=&quot;ot&quot;&gt;{-# OPTIONS_GHC -O -fplugin GHC.Proof.Plugin #-}&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;dt&quot;&gt;Simple&lt;/span&gt; &lt;span class=&quot;kw&quot;&gt;where&lt;/span&gt;

&lt;span class=&quot;kw&quot;&gt;import &lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;GHC.Proof&lt;/span&gt;
&lt;span class=&quot;kw&quot;&gt;import &lt;/span&gt;&lt;span class=&quot;dt&quot;&gt;Data.Maybe&lt;/span&gt;

my_proof1 &lt;span class=&quot;fu&quot;&gt;=&lt;/span&gt; (\f x &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; isNothing (fmap f x))
        &lt;span class=&quot;fu&quot;&gt;===&lt;/span&gt; (\f x &lt;span class=&quot;ot&quot;&gt;-&amp;gt;&lt;/span&gt; isNothing x)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;sourceCode&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;sourceCode bash&quot;&gt;
&lt;code class=&quot;sourceCode bash&quot;&gt;$ &lt;span class=&quot;kw&quot;&gt;ghc&lt;/span&gt; Simple.hs
[&lt;span class=&quot;kw&quot;&gt;1&lt;/span&gt; of 1] Compiling Simple           ( Simple.hs, Simple.o )
&lt;span class=&quot;kw&quot;&gt;GHC.Proof&lt;/span&gt;: Proving my_proof1 …
&lt;span class=&quot;kw&quot;&gt;GHC.Proof&lt;/span&gt; proved 1 equalities&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;h4 id=&quot;haddock&quot;&gt;Haddock&lt;/h4&gt;
&lt;p&gt;Haddock is creaking at the seams. Most large Haskell projects (GHC, Stack, Agda, Cabal, Idris, etc) no longer use it for documentation. The codebase is dated and long standing issue like dealing with reexported modules are still open.&lt;/p&gt;
&lt;p&gt;There is a large vacuum for a better solution to emerge and compatibility with RestructuredText would allow easy migration of existing documentation.&lt;/p&gt;
&lt;h4 id=&quot;databases&quot;&gt;Databases&lt;/h4&gt;
&lt;p&gt;This year saw two new approaches to Haskell database integration:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/valderman/selda&quot;&gt;Selda&lt;/a&gt; - A library interacting with relational databases inspired by LINQ and Opaleye.&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/morphismtech/squeal&quot;&gt;Squeal&lt;/a&gt; - A deep embedding of PostgreSQL in Haskell using generics-sop.&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;This still remains an area in the ecosystem where many solutions end up needlessly falling back to TemplateHaskell to generate data structures and typically tend to be a pain point. Both these libraries use generics and advanced type system features to statically enforce well-formed SQL query construction.&lt;/p&gt;
&lt;h4 id=&quot;data-science-numerical-computing&quot;&gt;Data Science &amp;amp; Numerical Computing&lt;/h4&gt;
&lt;p&gt;Chris Doran presented a concise interpretation of Geometric Algebra, a generalization of linear algebra in terms of graded algebra &lt;a href=&quot;https://github.com/ga/Haskell/blob/master/GABlade.hs&quot;&gt;written in Haskell&lt;/a&gt;. A talk on this project was presented at the &lt;a href=&quot;https://skillsmatter.com/conferences/8522-haskell-exchange-2017#program&quot;&gt;Haskell Exchange&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;At ZuriHac several people expressed interest in forming a &lt;a href=&quot;https://github.com/DataHaskell/&quot;&gt;Data Haskell&lt;/a&gt; organization to work on advancing the state of Haskell libraries for data science and macing learning. There is considerable interest of the constructing the right abstractions for a well-typed dataframe library.&lt;/p&gt;
&lt;p&gt;Tom Nielson is furiously working on a &lt;a href=&quot;https://github.com/diffusionkinetics/open&quot;&gt;suite&lt;/a&gt; of of projects, mostly related to data science, machine learning and statistics in Haskell.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/Accelerate&quot;&gt;Accelerate project&lt;/a&gt; has been seeing a lot of development work recently and now has support for latest versions of LLVM and CUDA through llvm-hs project.&lt;/p&gt;
&lt;p&gt;A group at the University of Gothenburg released &lt;a href=&quot;https://github.com/GU-CLASP/TypedFlow&quot;&gt;TypedFlow&lt;/a&gt; a statically typed higher-order frontend to TensorFlow.&lt;/p&gt;
&lt;h4 id=&quot;eta&quot;&gt;Eta&lt;/h4&gt;
&lt;p&gt;Typelead continued working on a Java Virtual Machine backend to GHC called &lt;a href=&quot;http://eta-lang.org/&quot;&gt;Eta&lt;/a&gt;. The project has seen considerable amount of person-hours invested in compatibility and the firm has raised capital to pursue the project as a &lt;a href=&quot;https://www.crunchbase.com/organization/typelead&quot;&gt;commercial venture&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The project does seem to be diverging from the Haskell mainline language in both syntax and semantics which raises some interesting questions about viability. Although the Haskell language standard seems to be stuck and not moving forward, so there’s an interesting conundrum faced by those trying to build on top of GHC in the long run.&lt;/p&gt;
&lt;h4 id=&quot;webassembly&quot;&gt;WebAssembly&lt;/h4&gt;
&lt;p&gt;WebAssembly has been released and is supported by all major browsers as of December 2017. This is been piquing the interest of quite a few Haskellers (including myself) who have been looking for a saner way to interact with browsers than the ugly hack of ejecting hundreds of thousands of lines of generated Javascript source. WebAssembly in either standalone projects or as a target from GHC’s intermediate form STG to the browser offers an interesting path forward.&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/haskell-wasm/&quot;&gt;Haskell WASM&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/WebGHC&quot;&gt;WebGHC&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/neuromancer42/ministgwasm&quot;&gt;ministgwasm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/forest-lang/core&quot;&gt;forest-lang&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;h4 id=&quot;industry&quot;&gt;Industry&lt;/h4&gt;
&lt;p&gt;An incomplete list of non-consulting companies who are actively using Haskell or have published Haskell open sources libraries follows:&lt;/p&gt;
&lt;table&gt;&lt;colgroup&gt;&lt;col width=&quot;28%&quot;/&gt;&lt;/colgroup&gt;&lt;thead/&gt;&lt;tbody&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Standard Chartered&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Galois&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Intel&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Target&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Uber&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Vente Privee&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;FrontRow&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;NStack&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Morgan Stanley&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Takt&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Fugue&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Habito&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Asahi Net&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Sentenai&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;IOHK&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Awake Networks&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Facebook&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Adjoint&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;DigitalAsset&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;AlphaSheets&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Channable&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;SlamData&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Wire&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;JP Morgan&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Bose&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;There are four consulting companies also supporting Haskell in industry.&lt;/p&gt;
&lt;table&gt;&lt;colgroup&gt;&lt;col width=&quot;28%&quot;/&gt;&lt;/colgroup&gt;&lt;thead/&gt;&lt;tbody&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;Well-Typed&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Tweag&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;odd&quot;&gt;&lt;td align=&quot;left&quot;&gt;FP Complete&lt;/td&gt;
&lt;/tr&gt;&lt;tr class=&quot;even&quot;&gt;&lt;td align=&quot;left&quot;&gt;Obsidian Systems&lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h4 id=&quot;conferences&quot;&gt;Conferences&lt;/h4&gt;
&lt;p&gt;Both the &lt;a href=&quot;https://www.flickr.com/photos/skillsmatter/sets/72157686979473651/&quot;&gt;Haskell Exchange&lt;/a&gt; and ZuriHac conference had record attendance this year. Haskell was well-represented in many interdisciplinary conferences include StrangeLoop, CurryOn, LambdaDays, LambdaConf, and YOW.&lt;/p&gt;
&lt;p&gt;Most of the videos are freely available online.&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;&lt;a href=&quot;https://skillsmatter.com/conferences/8522-haskell-exchange-2017&quot;&gt;Haskell Exchange Videos&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.youtube.com/channel/UC0pEknZxL7Q1j0Ok8qImWdQ/videos&quot;&gt;ComposeConf Videos&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=KzqNQMpRbac&amp;amp;list=PLOvRW_utVPVkoZ5GuodkejFU8MiH6_SB7&quot;&gt;ZuriHac Videos&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.youtube.com/watch?v=MmbleUgU2Rg&amp;amp;list=PLnqUlCo055hW7kU-SBQEhC_87etA5Gqlq&quot;&gt;ICFP Videos&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;&lt;img src=&quot;http://www.stephendiehl.com/images/zurihac.jpg&quot; alt=&quot;Haskellers by the lake in Rapperswil, Switzerland&quot;/&gt;&lt;/p&gt;
&lt;p&gt;In 2018 I have plans to visit Zurich, Sydney, Budapest, Amsterdam, San Francisco, Paris, Copenhagen and Tokyo this year. Hopefully I get to meet more Haskellers and share some ideas about the future of our beautiful language. Until then, Merry Christmas and Happy New Haskell Year.&lt;/p&gt;
</description>
<pubDate>Mon, 04 Dec 2017 03:29:19 +0000</pubDate>
<dc:creator>setra</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.stephendiehl.com/posts/haskell_2018.html</dc:identifier>
</item>
<item>
<title>Nations agree to ban fishing in Arctic Ocean for at least 16 years</title>
<link>http://www.sciencemag.org/news/2017/12/nations-agree-ban-fishing-arctic-ocean-least-16-years</link>
<guid isPermaLink="true" >http://www.sciencemag.org/news/2017/12/nations-agree-ban-fishing-arctic-ocean-least-16-years</guid>
<description>&lt;div class=&quot;entity entity-paragraphs-item paragraphs-item-image&quot; readability=&quot;6.4473684210526&quot;&gt;&lt;img sizes=&quot;&quot; src=&quot;http://www.sciencemag.org/sites/default/files/styles/inline__450w__no_aspect/public/arctic%20sea%20ice.jpg?itok=ugifr1SJ&quot; srcset=&quot;http://www.sciencemag.org/sites/default/files/styles/inline__450w__no_aspect/public/arctic%20sea%20ice.jpg?itok=ugifr1SJ 1w, http://www.sciencemag.org/sites/default/files/styles/inline__699w__no_aspect/public/arctic%20sea%20ice.jpg?itok=m78RS_6I 700w&quot;/&gt;&lt;div class=&quot;caption&quot; readability=&quot;7&quot;&gt;
&lt;p&gt;Declining summer sea ice could open the Arctic Ocean to commercial fishing.&lt;/p&gt;
&lt;/div&gt;

&lt;/div&gt;
&lt;header class=&quot;article__header article__header--inline&quot; readability=&quot;25.902912621359&quot;&gt;
&lt;p class=&quot;byline byline--article&quot;&gt;By &lt;a href=&quot;http://www.sciencemag.org/author/hannah-hoag&quot;&gt;Hannah Hoag&lt;/a&gt;&lt;time&gt;Dec. 1, 2017 , 1:30 PM&lt;/time&gt;&lt;/p&gt;
&lt;/header&gt;&lt;p&gt;Nine nations and the European Union have reached a deal to place the central Arctic Ocean (CAO) off-limits to commercial fishers for at least the next 16 years. The pact, announced yesterday, will give scientists time to understand the region’s marine ecology—and the potential impacts of climate change—before fishing becomes widespread.&lt;/p&gt;
&lt;p&gt;“There is no other high seas area where we’ve decided to do the science first,” says Scott Highleyman, vice president of conservation policy and programs at the Ocean Conservancy in Washington, D.C., who also served on the U.S. delegation to the negotiations. “It’s a great example of putting the precautionary principle into action.”&lt;/p&gt;
&lt;p&gt;The deal to protect 2.8 million square kilometers of international waters in the Arctic was reached after six meetings spread over 2 years. It includes not just nations with coastal claims in the Arctic, but nations such as China, Japan, and South Korea with fishing fleets interested in operating in the region.&lt;/p&gt;
&lt;p&gt;Thus far, thick ice and uncertain fish stocks have kept commercial fishing vessels out of the CAO, but the region is becoming increasingly accessible because of rapid loss of summer sea ice. In recent summers, as much as 40% of the CAO has been open water, mostly north of Alaska and Russia, over the Chukchi Plateau.&lt;/p&gt;
&lt;p&gt;As the summer sea ice becomes thinner and its edge retreats northward, more sunlight is penetrating the water, increasing production of plankton, the base of the Arctic food web. These sun-fed plankton are gobbled up by Arctic cod, which in turn are hunted by animals higher up the food chain, including seals, polar bears, and humans. Some parts of the Arctic Ocean’s adjacent seas, such as the Barents Sea (off the northern coasts of Russia and Norway), saw steep increases in primary production in 2016, approaching 35% above the 2003–15 average.&lt;/p&gt;
&lt;p&gt;Under international law, these high seas are open to anyone. In the absence of an agreement, fishing there would not be illegal, but it would be unregulated—and some researchers, environmental groups, and policymakers fear it could harm the fragile and rapidly changing marine ecosystem. In the late 1980s, fishing trawlers from Japan, China, and elsewhere crowded the international waters in the Bering Strait between Russia and the United States and removed millions of tons of pollock. By the early 1990s, the pollock population had crashed. It has still not recovered.&lt;/p&gt;
&lt;p&gt;In 2012, approximately 2000 scientists called for a fishing moratorium in the CAO to prevent a similar catastrophe. Their efforts were a success: By 2015, Canada, Denmark (representing Greenland), Norway, Russia, and the United States—the nations with Arctic coastlines—vowed to bar their own fishing vessels from the area.&lt;/p&gt;
&lt;p&gt;But that left the Arctic open to large global fishing fleets. Delegations from Japan, China, South Korea, Iceland, and the European Union joined discussion later that year to negotiate a new agreement. In December 2016, before he left office, then-President Barack Obama and Canadian Prime Minister Justin Trudeau affirmed their commitment to a legally binding agreement to prevent unregulated fishing in the CAO.&lt;/p&gt;
&lt;p&gt;“The delegations saw the wisdom in waiting [to start commercial fishing] until there was enough science and management in place,” says Ambassador David Balton of the U.S. Department of State in Washington, D.C., who has chaired the negotiations since 2015. The deal will stand for 16 years and be automatically renewed every 5 years, unless a country objects or until science-based fisheries quota and rules are put in place.&lt;/p&gt;
&lt;p&gt;In addition to closing the area to fishing, the delegations have agreed to a joint program of scientific research and monitoring to identify species, their abundance, existing predator-prey relationships, and the pressures they face, including climate change.&lt;/p&gt;
&lt;p&gt;For now, accessing the CAO to do research requires significant icebreaking capacity, says Peter Harrison, an Arctic policy and fisheries expert at Queen’s University in Kingston, Canada, and former deputy minister of Canada’s Department of Fisheries and Oceans. Whereas the United States and Canada have struggled to maintain and grow their icebreaking fleet, other signatories, including China, have that capacity.&lt;/p&gt;
&lt;p&gt;Harrison argues for the creation of a new multinational science organization focused on the CAO. It would determine the science priorities, share and analyze the data collected, and provide advice on the state of the CAO fish stocks. “If you say commercial fishing will not take place until the there is sufficient science, going forward, the science will play a very significant role,” he says.&lt;/p&gt;
</description>
<pubDate>Mon, 04 Dec 2017 02:15:56 +0000</pubDate>
<dc:creator>jonbaer</dc:creator>
<og:type>article</og:type>
<og:url>http://www.sciencemag.org/news/2017/12/nations-agree-ban-fishing-arctic-ocean-least-16-years</og:url>
<og:title>Nations agree to ban fishing in Arctic Ocean for at least 16 years</og:title>
<og:description>Landmark pact designed to allow time to develop science-based management</og:description>
<og:image>http://www.sciencemag.org/sites/default/files/styles/article_main_large/public/arctic%20sea%20ice.jpg?itok=VQv5ihVi</og:image>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.sciencemag.org/news/2017/12/nations-agree-ban-fishing-arctic-ocean-least-16-years</dc:identifier>
</item>
</channel>
</rss>