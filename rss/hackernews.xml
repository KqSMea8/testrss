<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=hnrss.org%2Fnewest%3Fpoints%3D200&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://hnrss.org/newest?points=200" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>Hacker News: Newest</title>
<link>https://news.ycombinator.com/newest</link>
<description>Hacker News RSS</description>
<item>
<title>How I Learned to Stop Worrying and Love the State Machine</title>
<link>http://raganwald.com/2018/02/23/forde.html</link>
<guid isPermaLink="true" >http://raganwald.com/2018/02/23/forde.html</guid>
<description>&lt;blockquote readability=&quot;9&quot;&gt;
&lt;p&gt;“Any sufficiently complicated model class contains an ad-hoc, informally-specified, bug-ridden, slow implementation of half of a state machine.”–Pete Forde&lt;sup id=&quot;fnref:forde&quot;/&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Domain_model&quot;&gt;Domain models&lt;/a&gt; are representations of meaningful real-world concepts pertinent to sphere of knowledge, influence or activity (the “domain”) that need to be modelled in software. Doman models can represent concrete real-word objects, or more abstract things like meetings and incidents.&lt;/p&gt;
&lt;p&gt;Forde’s insight was that most domain models end up having a representation of various states. Over time, they build up a lot of logic around how and when they transition between these states, and that logic is smeared across various methods where it becomes difficult to understand and modify.&lt;/p&gt;
&lt;p&gt;By recognizing when domain models should be represented first and foremost as state machines–or recognizing when to refactor domain models into state machines–we keep our models understandable and workable. We tame their complexity.&lt;/p&gt;
&lt;p&gt;So, what are state machines? And how do they help?&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;hhttps://www.flickr.com/photos/ideonexus/3321308066&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/goldberg.jpg&quot; alt=&quot;A rube goldberg machine&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;finite-state-machines&quot;&gt;finite state machines&lt;/h3&gt;
&lt;blockquote readability=&quot;13.12688172043&quot;&gt;
&lt;p&gt;A &lt;a href=&quot;https://en.wikipedia.org/wiki/Finite-state_machine&quot;&gt;finite state machine&lt;/a&gt;, or simply a &lt;em&gt;state machine&lt;/em&gt;, is a mathematical model of computation. It is an abstract machine that can be in exactly one of a finite number of states at any given time.&lt;/p&gt;
&lt;p&gt;A state machine can change from one state to another in response to some external inputs; the change from one state to another is called a transition. A state machine is defined by a list of its states, its initial state, and the conditions for each transition.–&lt;a href=&quot;https://en.wikipedia.org/wiki/Finite-state_machine&quot;&gt;Wikipedia&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Well, that’s a mouthful. To put it in context from a programming (as opposed to idealized model of computation) point of view, when we program with objects, we build little machines. They have internal state and respond to messages or events from the rest of the program via the mechanism of their methods. (JavaScript also permits direct access to properties, but let’s consider the subset of programs that only interact with objects via methods.)&lt;/p&gt;
&lt;p&gt;Most objects are designed to encapsulate some kind of state. Stateless objects are certainly a thing, but let’s put them aside and consider only objects that have state. Some such objects can be considered State Machines, some cannot. What distinguishes them?&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;First, a state machine has a notion of a &lt;em&gt;state&lt;/em&gt;.&lt;/strong&gt; All stateful objects have some kind of “state,” but a state machine reifies this and gives it a name. Furthermore, there are a finite number of possible states that a state machine can be in, and it is always in exactly one of these states.&lt;/p&gt;
&lt;p&gt;For example let’s say that a bank account has a balance and it can be be one of &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;closed&lt;/code&gt;, or &lt;code class=&quot;highlighter-rouge&quot;&gt;frozen&lt;/code&gt;. Its balance certainly is stateful, but it’s “state” from the perspective of a state machine is &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;closed&lt;/code&gt;, or &lt;code class=&quot;highlighter-rouge&quot;&gt;frozen&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Second, a state machine formally defines a starting state, and allowable transitions between states&lt;/strong&gt;. The aforementioned bank account starts in &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; state. It can transition from &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;closed&lt;/code&gt;, and from time to time, from &lt;code class=&quot;highlighter-rouge&quot;&gt;closed&lt;/code&gt; back to &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt;. Sometimes, it transitions from a state back to itself, which we see in an arrow from &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; back to &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt;. This can be displayed with a diagram, and such diagrams are a helpful way to document or brainstorm behaviour:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/account-transitions.jpg&quot; alt=&quot;Bank account with Open and Closed states&quot;/&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Third, a state machine transitions between states in response to events&lt;/strong&gt;. Our bank account starts in &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; state. When &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt;, a bank account responds to a &lt;code class=&quot;highlighter-rouge&quot;&gt;close&lt;/code&gt; event by transitioning to the &lt;code class=&quot;highlighter-rouge&quot;&gt;closed&lt;/code&gt; state. When &lt;code class=&quot;highlighter-rouge&quot;&gt;closed&lt;/code&gt;, a bank account responds to the &lt;code class=&quot;highlighter-rouge&quot;&gt;reopen&lt;/code&gt; event by transitioning to the &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; state. As noted, some transitions do not involve changes in state. When &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt;, a bank account responds to &lt;code class=&quot;highlighter-rouge&quot;&gt;deposit&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;withdraw&lt;/code&gt; events, and it transitions back to &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; state.&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/mikecogh/8752869937&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/tracks.jpg&quot; alt=&quot;Strathfield Bends&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;transitions&quot;&gt;transitions&lt;/h3&gt;
&lt;p&gt;The events that trigger transitions are noted by labeling the transitions on the diagram:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/account-events-withself.jpg&quot; alt=&quot;Bank account with events&quot;/&gt;&lt;/p&gt;
&lt;p&gt;We now have enough to create a naïve JavaScript object to represent what we know so far about a bank account. We will make each event a method, and the state will be a string:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;10&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;//=&amp;gt; open&lt;/span&gt;

&lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;//=&amp;gt; closed&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;The first thing we observe is that our bank account handles different events in different states. In the &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; state, it handles the &lt;code class=&quot;highlighter-rouge&quot;&gt;deposit&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;withdraw&lt;/code&gt;, and &lt;code class=&quot;highlighter-rouge&quot;&gt;close&lt;/code&gt; event. In the &lt;code class=&quot;highlighter-rouge&quot;&gt;closed&lt;/code&gt; state, it only handles the &lt;code class=&quot;highlighter-rouge&quot;&gt;reopen&lt;/code&gt; event. The natural way of implementing events is as methods on the object, but now we are imbedding in each method a responsibility for knowing what state the account is in and whether that transition can be allowed or not.&lt;/p&gt;
&lt;p&gt;It’s also not clear from the code alone what all the possible states are, or how we transition. What is clear is what each method does, in isolation. This is one of the “affordances” of a typical object-with-methods design: It makes it very easy to see what an individual method does, but not to get a higher view of how the methods are elated to each other.&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;Let’s add a little functionality: A “hold” can be placed on accounts. Held accounts can accept deposits, but not withdrawals. And naturally, the hold can be removed. The new diagram looks like this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/account-events-withself-held.jpg&quot; alt=&quot;Bank account with events and self and hold&quot;/&gt;&lt;/p&gt;
&lt;p&gt;And the code we end up with looks like this:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;11&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;17&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;||&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;To accomodate the new state, we had to update a number of different methods. This is not difficult when the requirements are in front of us, and it’s often a mistake to overemphasize whether it is easy or difficult to implement something when the requirements and the code are both well-understood.&lt;/p&gt;
&lt;p&gt;However, we can see that the code does not do a very good job of documenting what is or isn’t possible for a &lt;code class=&quot;highlighter-rouge&quot;&gt;held&lt;/code&gt; account. This organization makes it easy to see exactly what a &lt;code class=&quot;highlighter-rouge&quot;&gt;deposit&lt;/code&gt; or &lt;code class=&quot;highlighter-rouge&quot;&gt;withdraw&lt;/code&gt; does, at the expense of making it easy to see how &lt;code class=&quot;highlighter-rouge&quot;&gt;held&lt;/code&gt; accounts work or the overall flow of accounts from state to state.&lt;/p&gt;
&lt;p&gt;If we wanted to emphasize states, what could we do?&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/teegardin/5912231439&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/balance.jpg&quot; alt=&quot;A bank balance&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;executable-state-descriptions&quot;&gt;executable state descriptions&lt;/h3&gt;
&lt;p&gt;Directly compiling diagrams has been–so far–highly unproductive for programming. But there’s another representation of a state machine that can prove helpful: A &lt;strong&gt;transition table&lt;/strong&gt;. Here’s our transition table for the naïve bank account:&lt;/p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt; &lt;/th&gt;
&lt;th&gt;open&lt;/th&gt;
&lt;th&gt;held&lt;/th&gt;
&lt;th&gt;closed&lt;/th&gt;
&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;open&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;deposit, withdraw&lt;/td&gt;
&lt;td&gt;place-hold&lt;/td&gt;
&lt;td&gt;close&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;held&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;remove-hold&lt;/td&gt;
&lt;td&gt;deposit&lt;/td&gt;
&lt;td&gt;close&lt;/td&gt;
&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;strong&gt;closed&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;reopen&lt;/td&gt;
&lt;td&gt; &lt;/td&gt;
&lt;td&gt; &lt;/td&gt;
&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;In the leftmost column, we have the current state of the account. Each subsequent column is a destination state. At the intersection of the current state and a destination state, we have the event or events that transition the object from current to destination state. Thus, &lt;code class=&quot;highlighter-rouge&quot;&gt;deposit&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;withdraw&lt;/code&gt; transition from &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt;, while &lt;code class=&quot;highlighter-rouge&quot;&gt;place-hold&lt;/code&gt; transitions the object from &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;held&lt;/code&gt;. The start state is arbitrarily taken as the first state listed.&lt;/p&gt;
&lt;p&gt;Like the state diagram, the transition table shows clearly which events are handled by which state, and the transitions between them. We can take this idea to our executable code: Here’s a version of our account that uses objects to represent table rows and columns.&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;12.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;20&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;states&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STARTING_STATE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;starting-state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;STARTING_STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;closed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

    &lt;span class=&quot;na&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;closed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

    &lt;span class=&quot;na&quot;&gt;closed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This description isn’t executable, but it doesn’t take much to write an implementation organized along the same lines:&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/christiaancolen/21133307556&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/rootkit.jpg&quot; alt=&quot;Code&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;implementing-a-state-machine-that-matches-our-description&quot;&gt;implementing a state machine that matches our description&lt;/h3&gt;
&lt;p&gt;In &lt;a href=&quot;http://raganwald.com/2014/04/10/mixins-forwarding-delegation.html&quot;&gt;Mixins, Forwarding, and Delegation in JavaScript&lt;/a&gt;, we briefly touched on using late-bound delegation to create state machines. The principle is that instead of using strings for state, we’ll use objects that contain the methods we’re interested in. First, we’ll write out what those objects will look like:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;10&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;states&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;closed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;held&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;closed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;closed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Now our actual account object stores a state object rather than a state string, and delegates all methods to it. When an event is invalid, we’ll get an exception. That can be “fixed,” but let’s not worry about it now:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;15.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;26&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;closed&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Unfortunately, this regresses: We’re littering the methods with state assignments. One of the benefits of transition tables and state diagrams is that they communicate both the &lt;em&gt;from_and _to&lt;/em&gt; states of each transition. Assigning state within methods does not make this clear, and introduces an opportunity for error.&lt;/p&gt;
&lt;p&gt;To fix this, we’ll write a &lt;code class=&quot;highlighter-rouge&quot;&gt;transitionsTo&lt;/code&gt; &lt;a href=&quot;https://tc39.github.io/proposal-decorators/&quot;&gt;decorator&lt;/a&gt; to handle the state changes.&lt;sup id=&quot;fnref:not-yet&quot;/&gt;&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;21.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;38&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;states&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;stateName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;returnValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;stateName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;returnValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;placeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;held&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;removeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;closed&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;reopen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;closed&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Now we have made it quite clear which methods belong to which states, and which states they transition to.&lt;/p&gt;
&lt;p&gt;We could stop right here if we wanted to: This is a pattern that is remarkably easy to write by hand, and for many cases, it is far easier to read and maintain than having various &lt;code class=&quot;highlighter-rouge&quot;&gt;if&lt;/code&gt; and/or &lt;code class=&quot;highlighter-rouge&quot;&gt;switch&lt;/code&gt; statements littering every method. But since we’re enjoying ourselves, what would it take to automate the process of implementing this naïve state machine pattern from descriptions?&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/mlupo/6813365139&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/typewriter.jpg&quot; alt=&quot;A machine that types on a typewriter&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;compiling-descriptions-into-state-machines&quot;&gt;compiling descriptions into state machines&lt;/h3&gt;
&lt;p&gt;Code that writes code does add a certain complexity, but it also enables us to arrange our code such that it is organized more appropriately for our problem domain. Managing stateful entities is one of the hardest problems in programming&lt;sup id=&quot;fnref:hardest&quot;/&gt;, so it’s often worth a investing in a little infrastructure work to arrive at an easier to understand and extend program.&lt;/p&gt;
&lt;p&gt;The first thing we’ll do is “begin with the end in mind.” We wish to be able to write something like this:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;15.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;26&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;states&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STARTING_STATE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Symbol&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;starting-state&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;stateName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;returnValue&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;fn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;stateName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;returnValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;StateMachine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STARTING_STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;placeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;removeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;closed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;reopen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;What does &lt;code class=&quot;highlighter-rouge&quot;&gt;StateMachine&lt;/code&gt; do?&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;10&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;15&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;RESERVED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STARTING_STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

&lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;StateMachine&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;machine&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{};&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// Handle all the initial states and/or methods&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;propertiesAndMethods&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;filter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;property&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;RESERVED&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;includes&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;property&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;property&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;propertiesAndMethods&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;machine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;property&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;property&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// now its states&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;machine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// what event handlers does it have?&lt;/span&gt;
  &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eventNames&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;entries&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;reduce&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;eventNames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;stateDescription&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eventNamesForThisState&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Object&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;keys&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;stateDescription&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eventName&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eventNamesForThisState&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nx&quot;&gt;eventNames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;eventName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eventNames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// define the delegating methods&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eventName&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;eventNames&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;machine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;eventName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(...&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;handler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;eventName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;handler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'function'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;eventName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;].&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;apply&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;args&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;`invalid event &lt;/span&gt;&lt;span class=&quot;p&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;eventName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// set the starting state&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;machine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;][&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;description&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STARTING_STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]];&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// we're done&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;machine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/see-through-the-eye-of-g/4278744230&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/clock.jpg&quot; alt=&quot;A clock mechanism&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;lets-summarize&quot;&gt;let’s summarize&lt;/h3&gt;
&lt;p&gt;We began with this simple code for a bank account that behaved like a state machine:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;8.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;12&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Encumbering this simple example with meta-programming to declare a state machine may not have been worthwhile, so we won’t jump to the conclusion that we ought to have written it differently. However, code being code, requirements were discovered, and we ended up writing:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;11&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;17&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;state&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;placeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;removeHold&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;close&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;reopen&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid event'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Faced with more complexity, and the dawning realization that things are going to inexorably become more complex over time, we refactored our code from an ad-hoc, informally-specified, bug-ridden, slow implementation of half of a state machine &lt;strong&gt;to&lt;/strong&gt; this example:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;14.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;24&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;StateMachine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STARTING_STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;withdraw&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;placeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;removeHold&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;kc&quot;&gt;undefined&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
      &lt;span class=&quot;nx&quot;&gt;deposit&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'closed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
          &lt;span class=&quot;c1&quot;&gt;// ...transfer balance to suspension account&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;closed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;na&quot;&gt;reopen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;transitionsTo&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;c1&quot;&gt;// ...restore balance if applicable&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/usbr/6983725258&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/shasta.jpg&quot; alt=&quot;Shasta Dam. Trashracks as seen from a boat on reservoir&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;how-does-this-help&quot;&gt;how does this help?&lt;/h3&gt;
&lt;p&gt;Let’s finish our examination of state machines with a small change. We wish to add an &lt;code class=&quot;highlighter-rouge&quot;&gt;availableForWithdrawal&lt;/code&gt; method. It returns the balance (if positive and for accounts that are open and not on hold). The old way would be to write a single method with an &lt;code class=&quot;highlighter-rouge&quot;&gt;if&lt;/code&gt; statement:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;9&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;

  &lt;span class=&quot;nx&quot;&gt;availableForWithdrawal&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;state&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'held'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'invalid method'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;As discussed, this optimizes for understanding &lt;code class=&quot;highlighter-rouge&quot;&gt;availableForWithdrawal&lt;/code&gt;, but makes it harder to understand how &lt;code class=&quot;highlighter-rouge&quot;&gt;open&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;held&lt;/code&gt; accounts differ from each other. It combines multiple responsibilities in the &lt;code class=&quot;highlighter-rouge&quot;&gt;availableForWithdrawal&lt;/code&gt; method: Understanding everything about account states, and implementing the functionality for each of the applicable states.&lt;/p&gt;
&lt;p&gt;The “state machine way” is to write:&lt;/p&gt;
&lt;div class=&quot;language-javascript highlighter-rouge&quot; readability=&quot;8.5&quot;&gt;
&lt;div class=&quot;highlight&quot; readability=&quot;12&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;account&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;StateMachine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;balance&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;

  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STARTING_STATE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'open'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;STATES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;

      &lt;span class=&quot;nx&quot;&gt;availableForWithdrawal&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;?&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;this&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;balance&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;na&quot;&gt;held&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;// ...&lt;/span&gt;

      &lt;span class=&quot;nx&quot;&gt;availableForWithdrawal&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;This emphasizes the different states and the characteristics of an account in each state, and it separates the responsibilities: States and transitions are handled by our “state machine” organization, and each of the two functions handles just the mechanics of reporting the correct amount available for withdrawal.&lt;/p&gt;
&lt;blockquote readability=&quot;6&quot;&gt;
&lt;p&gt;“So much complexity in software comes from trying to make one thing do two things.”–Ryan Singer&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;We can obviously extend our code to generate ES20165 classes, incorporate before- and after- method decorations, tackle validating models in general and transitions in particular, and so forth. Our code here was written to illustrate the basic idea, not to power the next Startup Unicorn.&lt;/p&gt;
&lt;p&gt;But for now, our lessons are:&lt;/p&gt;
&lt;ol readability=&quot;3&quot;&gt;&lt;li readability=&quot;4&quot;&gt;
&lt;p&gt;It isn’t always necessary to build architecture to handle every possible future requirement. But it is a good idea to recognize that as the code grows and evolves, we may wish to refactor to the correct choice in the future. While we don’t want to do it too early, we also don’t want to do it too late.&lt;/p&gt;
&lt;/li&gt;
&lt;li readability=&quot;2&quot;&gt;
&lt;p&gt;Organizing things that behave like state machines along state machine lines separates responsibilities and decomposes methods into smaller pieces, each of which is focused on implementing the correct behaviour for a single state.&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;(discuss on &lt;a href=&quot;https://news.ycombinator.com/item?id=16468280&quot;&gt;hacker news&lt;/a&gt;, &lt;a href=&quot;https://www.reddit.com/r/javascript/comments/80el19/fordes_tenth_rule_or_how_i_learned_to_stop/&quot;&gt;reddit&lt;/a&gt;, or &lt;a href=&quot;https://github.com/raganwald/raganwald.github.com/edit/master/_posts/2018-02-23-forde.md&quot;&gt;edit this page&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;p.s. &lt;a href=&quot;https://en.wikipedia.org/wiki/State_pattern&quot;&gt;State&lt;/a&gt; was popularized as one of the twenty-three design patterns articulated by the “Gang of Four.” The implementation examples tend to be somewhat specific to a certain style of OOP language, but it is well-worth a review.&lt;/p&gt;
&lt;hr/&gt;&lt;p&gt;&lt;a href=&quot;https://www.flickr.com/photos/migreenberg/7155283115&quot;&gt;&lt;img src=&quot;http://raganwald.com/assets/images/state-machine/field-notes.jpg&quot; alt=&quot;A clock mechanism&quot;/&gt;&lt;/a&gt;&lt;/p&gt;


</description>
<pubDate>Mon, 26 Feb 2018 19:40:13 +0000</pubDate>
<dc:creator>gregorymichael</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>http://raganwald.com/2018/02/23/forde.html</dc:identifier>
</item>
<item>
<title>Show HN: Six Degrees of Wikipedia</title>
<link>https://www.sixdegreesofwikipedia.com</link>
<guid isPermaLink="true" >https://www.sixdegreesofwikipedia.com</guid>
<description>[unable to retrieve full-text content]&lt;p&gt;Article URL: &lt;a href=&quot;https://www.sixdegreesofwikipedia.com&quot;&gt;https://www.sixdegreesofwikipedia.com&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Comments URL: &lt;a href=&quot;https://news.ycombinator.com/item?id=16468196&quot;&gt;https://news.ycombinator.com/item?id=16468196&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Points: 454&lt;/p&gt;&lt;p&gt;# Comments: 200&lt;/p&gt;
&lt;hr&gt;&lt;p&gt;hnrss is a labor of love, but if the project has made your job
or hobby project easier and you want to show some gratitude, &lt;a
href=&quot;https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&amp;amp;hosted_button_id=ZP9Q7QUNS3QYY&quot;&gt;donations are very much
appreciated&lt;/a&gt;. Thanks!&lt;/p&gt;
        </description>
<pubDate>Mon, 26 Feb 2018 19:29:44 +0000</pubDate>
<dc:creator>jwngr</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.sixdegreesofwikipedia.com/</dc:identifier>
</item>
<item>
<title>Launch HN: Pagedraw (YC W18) – Compile UI Mockups to React Code</title>
<link>https://news.ycombinator.com/item?id=16467387</link>
<guid isPermaLink="true" >https://news.ycombinator.com/item?id=16467387</guid>
<description>&lt;td colspan=&quot;2&quot;/&gt;&lt;td readability=&quot;68.261728395062&quot;&gt;Hi HN! We're Jared and Gabe (YC W18), the founders of Pagedraw (&lt;a href=&quot;https://pagedraw.io&quot; rel=&quot;nofollow&quot;&gt;https://pagedraw.io&lt;/a&gt;). Pagedraw is a UI builder that turns mockups into React code.
&lt;p&gt;Pagedraw lets you annotate mockups with extra information (like how to connect to the backend, resize for different screens, etc.) to get full, presentational, React Components. They’re React Components just like any others, so they can be interleaved freely with handwritten ones. They don’t require any new dependencies and work well with any existing JSX build system.&lt;/p&gt;
&lt;p&gt;You can import the mockups from Sketch or Figma, or draw them from scratch in Pagedraw.&lt;/p&gt;
&lt;p&gt;Working as full stack devs, we constantly had to do this translation by hand. It was our least favorite part of our jobs, since the creative work had already been done by the mockup designer. It's so repetitive and mechanical that we decided to stop hand-coding divs and css and write a program to do it instead.&lt;/p&gt;
&lt;p&gt;There have been many attempts to automate this stuff in the past. For 20 years, people have been trying to solve the problem with tools like Dreamweaver, Frontpage, and so on. Broadly speaking, they tended to fall into one of two buckets, each with their own problems. In one corner are tools like Dreamweaver, which can produce correct code but have to expose some of the underlying HTML model, making their users play a puzzle game to do something as simple as move an object around. In the other corner are freeform design tools that generate position:absolute code. That doesn’t work if you care about working on different screen sizes, or reflowing the layout around variable-length content as simple as “hello &amp;lt;username&amp;gt;”.&lt;/p&gt;
&lt;p&gt;We think the problem is that you have to look at it like a compiler. Past tools never fully worked because they tried to unify two fundamentally different mental models: the designer’s mental model of a free form canvas like Sketch or Photoshop, and the DOM’s mental model of &amp;lt;div&amp;gt; followed by a &amp;lt;p&amp;gt; followed by an &amp;lt;img&amp;gt; and so on. What always happens is one of two things: either the computer’s mental model is imposed on the designer, or the designer’s mental model is imposed on the computer. The former results in a clunky design tool, and the latter results in position:absolute.&lt;/p&gt;
&lt;p&gt;What we do instead is recognize that these are two fundamentally different models. Designers work with Sketch by saying “put this button at this pixel”. We can let them do that and still generate flexbox code without positon:absolute, and let everything resize and reflow correctly. Pagedraw does it by inferring constraints from the relative geometries in the mockup. For example, if object A is to the right of object B, we infer it should always remain to the right, regardless of resizing or content reflowing. Sometimes, the developer does have to ask the designer about their intent regarding resizing, which is why Pagedraw also needs you to annotate that information. We then compile those constraints, inferred and annotated, into HTML layout mechanisms like inline-block and flexbox.&lt;/p&gt;
&lt;p&gt;It turns out that a lot of other nice things follow from a compiler-like architecture. For one, we separate codegen correctness from codegen prettiness by cleaning up the generated code in discrete optimization passes. Another is the ability to easily retarget for AngularJS, Backbone, React Native, and so on by just swapping the compiler backend. We even have some nice editor features that fell out from hacking a Lispy interpreter onto our internal representation.&lt;/p&gt;
&lt;p&gt;We’re excited to see what you all think and hear about your experiences in this area! You can try it at &lt;a href=&quot;https://pagedraw.io/&quot; rel=&quot;nofollow&quot;&gt;https://pagedraw.io/&lt;/a&gt;&lt;/p&gt;
&lt;/td&gt;
</description>
<pubDate>Mon, 26 Feb 2018 18:02:02 +0000</pubDate>
<dc:creator>jpochtar</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://news.ycombinator.com/item?id=16467387</dc:identifier>
</item>
<item>
<title>Ask HN: I&amp;#039;m writing a book about white-collar drug use, including tech sector</title>
<link>https://news.ycombinator.com/item?id=16465762</link>
<guid isPermaLink="true" >https://news.ycombinator.com/item?id=16465762</guid>
<description>&lt;td colspan=&quot;2&quot;/&gt;&lt;td readability=&quot;31&quot;&gt;Hi HN. I’m a journalist who wrote ‘The Lawyer, The Addict’, a story that ran in the New York Times in July. The story was about my ex-husband, Peter, who was a high-flying powerful partner in Wilson Sonsini (the prestigious, Palo Alto-based law firm) and who died in July 2015, a drug addict. Almost everyone in his life missed the signs. The story wound up with enormous traction and was the 55th most read story in the entire paper in 2017. It also generated several threads of commentary on HN, including https://news.ycombinator.com/item?id=14776864, https://news.ycombinator.com/item?id=14931209 and https://news.ycombinator.com/item?id=14777919.
&lt;p&gt;I’m now writing a book based on that story for Random House. Although it is about what happened to Peter, the broader story is about the problem of substance use (and often abuse) in white-collar professions, where the users are well-off, well-educated, working long hours, often with all the outward trappings of success.&lt;/p&gt;
&lt;p&gt;What can you tell me about drug use as a professional or in your profession?&lt;/p&gt;
&lt;p&gt;I know there is drug use in law, finance, medicine and technology, and am hoping that some of you will be open to discussing with me what you see and what you've experienced in your profession and professional environment. I’d like to use some of your comments in the book and will not know or need to know your names, so I hope you’ll feel comfortable being as candid as possible. I’m not here to make judgements, all I’m looking for is the truth about what’s going on.&lt;/p&gt;
&lt;p&gt;I'm interested in whatever you can tell me about drugs you are using or observe being used in your field: which drugs, what effects you see, any stories you have, any details you can share. Thanks.&lt;/p&gt;
&lt;/td&gt;
</description>
<pubDate>Mon, 26 Feb 2018 15:07:03 +0000</pubDate>
<dc:creator>Eilene</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://news.ycombinator.com/item?id=16465762</dc:identifier>
</item>
<item>
<title>Apple confirms it uses Google cloud for some of iCloud</title>
<link>https://www.cnbc.com/2018/02/26/apple-confirms-it-uses-google-cloud-for-icloud.html</link>
<guid isPermaLink="true" >https://www.cnbc.com/2018/02/26/apple-confirms-it-uses-google-cloud-for-icloud.html</guid>
<description>&lt;p&gt;A file that &lt;a class=&quot;inline_quotes&quot; data-gdsid=&quot;8016&quot; data-inline-quote-symbol=&quot;AAPL&quot; href=&quot;https://www.cnbc.com/quotes/?symbol=AAPL&quot;&gt;Apple&lt;/a&gt; updated on its website last month provides the first acknowledgment that it's relying on &lt;a class=&quot;inline_quotes&quot; data-gdsid=&quot;19004&quot; data-inline-quote-symbol=&quot;GOOGL&quot; href=&quot;https://www.cnbc.com/quotes/?symbol=GOOGL&quot;&gt;Google&lt;/a&gt;'s public cloud for data storage for its iCloud services.&lt;/p&gt;
&lt;p&gt;The disclosure is fresh evidence that Google's cloud has been picking up usage as it looks to catch up with &lt;a class=&quot;inline_quotes&quot; data-gdsid=&quot;9399&quot; data-inline-quote-symbol=&quot;AMZN&quot; href=&quot;https://www.cnbc.com/quotes/?symbol=AMZN&quot;&gt;Amazon&lt;/a&gt; and &lt;a class=&quot;inline_quotes&quot; data-gdsid=&quot;25619&quot; data-inline-quote-symbol=&quot;MSFT&quot; href=&quot;https://www.cnbc.com/quotes/?symbol=MSFT&quot;&gt;Microsoft&lt;/a&gt; in the cloud infrastructure business.&lt;/p&gt;
&lt;p&gt;Some &lt;a class=&quot;inline_asset&quot; href=&quot;https://www.crn.com/news/cloud/300080062/cloud-makes-for-strange-bedfellows-apple-signs-on-with-google-cuts-spending-with-aws.htm?itc=refresh&quot; title=&quot;https://www.crn.com/news/cloud/300080062/cloud-makes-for-strange-bedfellows-apple-signs-on-with-google-cuts-spending-with-aws.htm?itc=refresh&quot;&gt;media outlets&lt;/a&gt; reported on Google's iCloud win in 2016, but Apple never provided confirmation.&lt;/p&gt;

&lt;p&gt;Apple periodically publishes new versions of a PDF called the &lt;a class=&quot;inline_asset&quot; href=&quot;https://images.apple.com/business/docs/iOS_Security_Guide.pdf&quot; title=&quot;https://images.apple.com/business/docs/iOS_Security_Guide.pdf&quot;&gt;iOS Security Guide&lt;/a&gt;. For years the document contained language indicating that iCloud services were relying on remote data storage systems from Amazon Web Services, as well as Microsoft's Azure.&lt;/p&gt;
&lt;p&gt;But in the latest version, the Microsoft Azure reference is gone, and in its place is Google Cloud Platform. Before the January update, Apple most recently updated the iOS Security Guide in March.&lt;/p&gt;
&lt;p&gt;The latest update doesn't indicate whether Apple is using any Google cloud services other than core storage of &quot;objects&quot; like photos and videos. The document also doesn't make it clear when Apple started storing data in Google's cloud. Microsoft declined to comment. Apple didn't respond to a request for comment.&lt;/p&gt;
&lt;p&gt;Earlier this month &lt;a href=&quot;https://www.cnbc.com/2018/02/01/google-cloud-revenue-passes-1-billion-per-quarter.html&quot;&gt;Google said&lt;/a&gt; its public cloud and its G Suite line of cloud-based productivity apps contribute $1 billion in revenue per quarter. In the fourth quarter, market leader Amazon Web Services brought in &lt;a href=&quot;https://www.cnbc.com/2018/02/01/aws-earnings-q4-2017.html&quot;&gt;$5.11 billion in revenue&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In addition to Apple, other Google public cloud customers include &lt;a class=&quot;inline_quotes&quot; data-gdsid=&quot;23000&quot; data-inline-quote-symbol=&quot;KR&quot; href=&quot;https://www.cnbc.com/quotes/?symbol=KR&quot;&gt;Kroger&lt;/a&gt;, &lt;a class=&quot;inline_quotes&quot; data-gdsid=&quot;155961&quot; data-inline-quote-symbol=&quot;PYPL&quot; href=&quot;https://www.cnbc.com/quotes/?symbol=PYPL&quot;&gt;PayPal&lt;/a&gt;, &lt;a class=&quot;inline_quotes&quot; data-gdsid=&quot;163704&quot; data-inline-quote-symbol=&quot;SNAP&quot; href=&quot;https://www.cnbc.com/quotes/?symbol=SNAP&quot;&gt;Snap&lt;/a&gt; and Spotify.&lt;/p&gt;
</description>
<pubDate>Mon, 26 Feb 2018 14:10:48 +0000</pubDate>
<dc:creator>uptown</dc:creator>
<og:type>article</og:type>
<og:url>https://www.cnbc.com/2018/02/26/apple-confirms-it-uses-google-cloud-for-icloud.html</og:url>
<og:image>https://fm.cnbc.com/applications/cnbc.com/resources/img/editorial/2013/04/23/100664627-151868537r.1910x1000.jpg</og:image>
<og:title>Apple confirms it uses Google's cloud for iCloud</og:title>
<og:description>A document contains Apple's first public acknowledgment that it is storing data for its iCloud services in Google's data centers.</og:description>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.cnbc.com/2018/02/26/apple-confirms-it-uses-google-cloud-for-icloud.html</dc:identifier>
</item>
<item>
<title>Lost Art of Bending Over: How Other Cultures Spare Their Spines</title>
<link>https://www.npr.org/sections/health-shots/2018/02/26/587735283/lost-art-of-bending-over-how-other-cultures-spare-their-spines</link>
<guid isPermaLink="true" >https://www.npr.org/sections/health-shots/2018/02/26/587735283/lost-art-of-bending-over-how-other-cultures-spare-their-spines</guid>
<description>&lt;div id=&quot;res588281421&quot; class=&quot;bucketwrap image large&quot;&gt;
&lt;div class=&quot;imagewrap&quot; data-crop-type=&quot;&quot;&gt;&lt;img src=&quot;https://media.npr.org/assets/img/2018/02/23/bending-1_wide-a8283841e4a815126daa6e661a501fa66961f244-s1100-c15.jpg&quot; data-original=&quot;https://media.npr.org/assets/img/2018/02/23/bending-1_wide-a8283841e4a815126daa6e661a501fa66961f244-s1100.jpg&quot; class=&quot;img lazyOnLoad&quot; alt=&quot;&quot;/&gt;
&lt;/div&gt;
&lt;div class=&quot;credit-caption&quot;&gt;
&lt;div class=&quot;caption-wrap&quot; readability=&quot;7&quot;&gt;
&lt;div class=&quot;caption&quot; aria-label=&quot;Image caption&quot; readability=&quot;9&quot;&gt;
&lt;p&gt;A man bends with a beautiful hip hinge in Puerta Vallarta, Mexico. &lt;strong class=&quot;credit&quot; aria-label=&quot;Image credit&quot;&gt;Courtesy of Jean Couch&lt;/strong&gt; &lt;strong class=&quot;hide-caption&quot;&gt;hide caption&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;strong class=&quot;toggle-caption&quot;&gt;toggle caption&lt;/strong&gt;&lt;/div&gt;
&lt;span class=&quot;credit&quot; aria-label=&quot;Image credit&quot;&gt;Courtesy of Jean Couch&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;enlarge_measure&quot;&gt;
&lt;div class=&quot;img_wrap&quot;&gt;&lt;img data-original=&quot;https://media.npr.org/assets/img/2018/02/23/bending-1_wide-a8283841e4a815126daa6e661a501fa66961f244-s1200.jpg&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;enlarge_html&quot; readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;image_data&quot; readability=&quot;8&quot;&gt;
&lt;p class=&quot;caption&quot;&gt;A man bends with a beautiful hip hinge in Puerta Vallarta, Mexico.&lt;/p&gt;
&lt;span class=&quot;credit&quot; aria-label=&quot;Image credit&quot;&gt;Courtesy of Jean Couch&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;To see if you're bending correctly, try a simple experiment.&lt;/p&gt;
&lt;p&gt;&quot;Stand up and put your hands on your waist,&quot; says &lt;a href=&quot;http://www.balancecenter.com/staff.htm&quot;&gt;Jean Couch&lt;/a&gt;, who has been helping people get out of back pain for 25 years at her studio in Palo Alto, Calif.&lt;/p&gt;
&lt;p&gt;&quot;Now imagine I've dropped a feather in front of your feet and asked to pick it up,&quot; Couch says. &quot;Usually everybody immediately moves their heads and looks down.&quot;&lt;/p&gt;
&lt;p&gt;That little look down bends your spine and triggers your stomach to do a little crunch. &quot;You've already started to bend incorrectly — at your waist,&quot; Couch says. &quot;Almost everyone in the U.S. bends at the stomach.&quot;&lt;/p&gt;
&lt;div id=&quot;res588273776&quot; class=&quot;bucketwrap internallink insettwocolumn inset2col&quot;&gt;
&lt;div class=&quot;bucket img&quot;&gt;&lt;a id=&quot;featuredStackSquareImage412314701&quot; href=&quot;https://www.npr.org/sections/goatsandsoda/2015/06/08/412314701/lost-posture-why-indigenous-cultures-dont-have-back-pain&quot; data-metrics=&quot;{&amp;quot;category&amp;quot;:&amp;quot;Story to Story&amp;quot;,&amp;quot;action&amp;quot;:&amp;quot;Click Internal Link&amp;quot;,&amp;quot;label&amp;quot;:&amp;quot;https:\/\/www.npr.org\/sections\/goatsandsoda\/2015\/06\/08\/412314701\/lost-posture-why-indigenous-cultures-dont-have-back-pain&amp;quot;}&quot;&gt;&lt;img src=&quot;https://media.npr.org/assets/img/2015/06/05/back-pain-promo2_sq-b630079c5dcb5b7917de40ffc6019bcb7aa493ce-s100-c15.jpg&quot; data-original=&quot;https://media.npr.org/assets/img/2015/06/05/back-pain-promo2_sq-b630079c5dcb5b7917de40ffc6019bcb7aa493ce-s100.jpg&quot; class=&quot;img lazyOnLoad&quot; alt=&quot;Lost Posture: Why Some Indigenous Cultures May Not Have Back Pain&quot;/&gt;&lt;/a&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;In the process, our backs curve into the letter &quot;C&quot; — or, as Couch says, &quot;We all look like really folded cashews.&quot;&lt;/p&gt;
&lt;p&gt;In other words, when we bend over in the U.S., most of us look like nuts!&lt;/p&gt;
&lt;p&gt;But in many parts of the world, people don't look like cashews when they bend over. Instead, you see something very different.&lt;/p&gt;
&lt;p&gt;I first noticed this mysterious bending style in 2014 while covering the Ebola outbreak. We were driving on a back road in the rain forest of Liberia and every now and then, we would pass women working in their gardens. The women had striking silhouettes: They were bent over with their backs nearly straight. But they weren't squatting with a vertical back. Instead, their backs were parallel to the ground. They looked like tables.&lt;/p&gt;
&lt;p&gt;After returning home, I started seeing this &quot;table&quot; bending in photos all around the world — an older woman planting rice in &lt;a href=&quot;https://www.npr.org/sections/parallels/2017/08/06/541462387/erratic-weather-threatens-livelihood-of-rice-farmers-in-madagascar&quot;&gt;Madagascar&lt;/a&gt;, a Mayan woman bending over at a market in Guatemala and women farming grass in northern &lt;a href=&quot;https://www.npr.org/sections/parallels/2017/08/20/543881831/as-indias-climate-changes-farmers-in-the-north-experiment-with-new-crops&quot;&gt;India&lt;/a&gt;. This bending seemed to be common in many places, except in Western societies.&lt;/p&gt;
&lt;aside id=&quot;ad-backstage-wrap&quot; aria-label=&quot;advertisement&quot;&gt;
&lt;/aside&gt;&lt;aside id=&quot;ad-mobilebackfill-wrap&quot; aria-label=&quot;advertisement&quot;&gt;
&lt;/aside&gt;&lt;p&gt;&quot;The anthropologists have noted exactly what you're saying for years,&quot; says &lt;a href=&quot;https://uwaterloo.ca/kinesiology/people-profiles/stuart-mcgill&quot;&gt;Stuart McGill&lt;/a&gt;, at the University of Waterloo in Ontario, Canada, who has been studying the biomechanics of the spine for more than three decades.&lt;/p&gt;
&lt;p&gt;&quot;It's called hip hinging,&quot; McGill says. &quot;And I've spent my career trying to prove it's a better way of bending than what we do.&quot;&lt;/p&gt;
&lt;div class=&quot;container large btmbar&quot; id=&quot;con588336698&quot; previewtitle=&quot;rice farmers&quot; readability=&quot;11.530434782609&quot;&gt;

&lt;p class=&quot;conintrotext&quot;&gt;When you hip hinge (left), your spine can stay in a neutral position, while the hips and upper legs support your body weight. When you bend at the waist, the back curves, putting stress on the spine.&lt;/p&gt;
&lt;div id=&quot;res588335955&quot; class=&quot;bucketwrap image large&quot;&gt;
&lt;div class=&quot;imagewrap&quot; data-crop-type=&quot;&quot;&gt;&lt;img src=&quot;https://media.npr.org/assets/img/2018/02/23/ricefarming-2_custom-387238c753ce750bc79e2a79e272739442ebf4de-s1100-c15.jpg&quot; data-original=&quot;https://media.npr.org/assets/img/2018/02/23/ricefarming-2_custom-387238c753ce750bc79e2a79e272739442ebf4de-s1100.jpg&quot; class=&quot;img lazyOnLoad&quot; alt=&quot;&quot;/&gt;
&lt;/div&gt;
&lt;div class=&quot;credit-caption&quot;&gt;
&lt;div class=&quot;caption-wrap&quot; readability=&quot;6.5&quot;&gt;
&lt;div class=&quot;caption&quot; aria-label=&quot;Image caption&quot; readability=&quot;8&quot;&gt;
&lt;p&gt;Rice farmers in Madagascar pan for gold to supplement their income. &lt;strong class=&quot;credit&quot; aria-label=&quot;Image credit&quot;&gt;Samantha Reinders for NPR&lt;/strong&gt; &lt;strong class=&quot;hide-caption&quot;&gt;hide caption&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;strong class=&quot;toggle-caption&quot;&gt;toggle caption&lt;/strong&gt;&lt;/div&gt;
&lt;span class=&quot;credit&quot; aria-label=&quot;Image credit&quot;&gt;Samantha Reinders for NPR&lt;/span&gt;&lt;/div&gt;
&lt;div class=&quot;enlarge_measure&quot;&gt;
&lt;div class=&quot;img_wrap&quot;&gt;&lt;img data-original=&quot;https://media.npr.org/assets/img/2018/02/23/ricefarming-2_enl-387238c753ce750bc79e2a79e272739442ebf4de-s1200.jpg&quot; alt=&quot;&quot;/&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;enlarge_html&quot; readability=&quot;6&quot;&gt;
&lt;div class=&quot;image_data&quot; readability=&quot;7&quot;&gt;
&lt;p class=&quot;caption&quot;&gt;Rice farmers in Madagascar pan for gold to supplement their income.&lt;/p&gt;
&lt;span class=&quot;credit&quot; aria-label=&quot;Image credit&quot;&gt;Samantha Reinders for NPR&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;For starters, McGill says, it's &quot;spine-sparing.&quot;&lt;/p&gt;
&lt;p&gt;When people bend with the cashew shape in their back — like we often do — they're bending their spine. &quot;That puts more stress on the spinal disks,&quot; McGill says.&lt;/p&gt;
&lt;p&gt;Disks are little rings of collagen found between each vertebra, which form a joint. But they aren't made for tons of motion. &quot;They have the mechanical characteristics of more like a fabric,&quot; McGill says.&lt;/p&gt;
&lt;p&gt;&quot;If you took a cloth, and you kept bending and stressing it, over and over again, the fibers of the weave of the cloth start to loosen up and delaminate,&quot; he says.&lt;/p&gt;
&lt;div class=&quot;container medium btmbar&quot; id=&quot;con588358188&quot; previewtitle=&quot;GIF&quot; readability=&quot;11&quot;&gt;

&lt;p class=&quot;conintrotext&quot;&gt;To hip hinge:&lt;br/&gt;1. Place your feet about 12 inches apart.&lt;br/&gt;2. Keep your back straight.&lt;br/&gt;3. As you bend your knees, allow your pubic bone to move backward.&lt;br/&gt;4. Fold over by allowing your pubic bone to slide through your legs, down and back.&lt;/p&gt;
&lt;div id=&quot;res588357327&quot; class=&quot;bucketwrap graphic medium&quot;&gt;
&lt;div class=&quot;bucket&quot;&gt;
&lt;div class=&quot;graphicwrapper&quot;&gt;&lt;img src=&quot;https://www.npr.org/assets/img/2018/02/23/Bending-motion.gif&quot; alt=&quot;Bending motion GIF&quot;/&gt;&lt;/div&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Eventually, over time, this fabric can fray, which puts you at risk of slipping a disk or having back pain.&lt;/p&gt;
&lt;p&gt;On the other hand, when you hip hinge, your spine stays in a neutral position. The bending occurs at the hip joint — which is the king of motion.&lt;/p&gt;
&lt;p&gt;&quot;Hips are a ball and socket joints,&quot; McGill says. &quot;They are designed to have maximum movement lots of muscle force.&quot;&lt;/p&gt;
&lt;p&gt;In other words, your boots may be made for walking, but your hips are made for bending.&lt;/p&gt;
&lt;p&gt;&quot;Bending at the hip takes the pressure off the back muscles,&quot; says &lt;a href=&quot;http://sites.utexas.edu/lizashapiro/&quot;&gt;Liza Shapiro&lt;/a&gt;, who studies primate locomotion at the University of Texas, Austin. &quot;Instead, you engage your hamstring muscles.&quot;&lt;/p&gt;
&lt;p&gt;And by &quot;engage the hamstrings,&quot; she also means &lt;em&gt;stretching&lt;/em&gt; them.&lt;/p&gt;
&lt;p&gt;&quot;Oh yes! In order to hip hinge properly, your hamstrings have to lengthen,&quot; Shapiro says. &quot;If you have tight hamstrings, they prevent you from bending over easily in that way.&quot;&lt;/p&gt;
&lt;p&gt;Tight hamstrings are extremely common in the U.S., Kennedy says. They may be one reason why hip hinging has faded from our culture: Stiff hamstrings are literally hamstringing our ability to bend properly.&lt;/p&gt;
&lt;p&gt;But hip hinging isn't totally lost from our culture, Shapiro says. &quot;I just saw a website on gardening that recommended it, and many yoga websites recommend bending at the hips, too.&quot;&lt;/p&gt;
&lt;p&gt;And the hip hinging is sprinkled throughout sports. Weightlifters use it when they do what's called a deadlift. Baseball players use it when they bat. Tennis star Rafael Nadal does it when he sets up a forehand. And in football, players kneel at the line of scrimmage with beautiful hip hinging.&lt;/p&gt;
&lt;p&gt;Toddlers younger than 3 years old are great hip hingers. They haven't learned yet from their parents to bend like a cashew.&lt;/p&gt;
&lt;p&gt;Whether or not hip hinging will prevent back pain or injuries, doctors don't know yet, says &lt;a href=&quot;https://profiles.stanford.edu/david-kennedy&quot;&gt;Dr. D.J. Kennedy&lt;/a&gt;, a spine specialist at Stanford University and a former weightlifter.&lt;/p&gt;
&lt;p&gt;&quot;We don't have these randomized trials, where we have people lifting things hundreds of times and see how their body responds to hip hinging,&quot; Kennedy says.&lt;/p&gt;
&lt;p&gt;Still, though, Kennedy says he tries to hip hinge as much as possible.&lt;/p&gt;
&lt;p&gt;&quot;I think hip hinging intuitively makes sense, just given how the spine functions,&quot; he says. &quot;So I try very hard to do it.&quot;&lt;/p&gt;
&lt;p&gt;So how in the world do you do this mysterious bending? Back in Palo Alto at Jean Couch's &lt;a href=&quot;http://www.balancecenter.com/staff.htm&quot;&gt;Balance Center&lt;/a&gt;, she tells me the trick: Find your fig leaf.&lt;/p&gt;
&lt;p&gt;&quot;Stand up and spread your heels about 12 inches apart, with your toes 14 inches apart,&quot; she says. &quot;Now, if you are Adam in the Bible, where would you put a fig leaf?&quot;&lt;/p&gt;
&lt;p&gt;&quot;Uh, on my pubic bone?&quot; I answer shyly.&lt;/p&gt;
&lt;p&gt;&quot;Exactly,&quot; Couch says. &quot;Now put your hand right there, on your fig leaf. When you bend, you want to let this fig leaf — your pubic bone — move through your legs. It moves down and back.&quot;&lt;/p&gt;
&lt;p&gt;So I try it. I put my hand on my pubic bone as a pretend fig leaf. Then as I bend my knees a bit, I allow my fig leaf to move through my legs. A little crevice forms right at the top of my legs and my back starts to fold over, like a flat table.&lt;/p&gt;
&lt;p&gt;&quot;Now you're using the large muscles of your hips, such as the glutes, to support the whole weight of your body, instead of the tiny muscles of your back,&quot; says &lt;a href=&quot;http://www.balancecenter.com/staff.htm&quot;&gt;Jenn Sherer&lt;/a&gt;, who co-owns the Balance Center with Couch.&lt;/p&gt;
&lt;p&gt;And she's right. My back relaxes, while my hamstrings start to stretch. And boy are they tight!&lt;/p&gt;
&lt;p&gt;&quot;Wow! My hamstrings are stretching like crazy,&quot; I yell out, while I'm bent over like a table.&lt;/p&gt;
&lt;p&gt;&quot;Yes,&quot; Couch says, chuckling. &quot;That's why we call it the world's best hamstring stretch. We find that the bend feels so good for some people, they never want to get back up.&quot;&lt;/p&gt;
</description>
<pubDate>Mon, 26 Feb 2018 14:07:49 +0000</pubDate>
<dc:creator>happy-go-lucky</dc:creator>
<og:title>Lost Art Of Bending Over: How Other Cultures Spare Their Spines</og:title>
<og:url>https://www.npr.org/sections/health-shots/2018/02/26/587735283/lost-art-of-bending-over-how-other-cultures-spare-their-spines</og:url>
<og:type>article</og:type>
<og:description>No, we're not talking about squatting. We're talking about a way to bend over that has nearly disappeared in our culture. And it could be one reason why back pain is so common in the U.S.</og:description>
<og:image>https://media.npr.org/assets/img/2018/02/23/bending-1_wide-a8283841e4a815126daa6e661a501fa66961f244.jpg?s=1400</og:image>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.npr.org/sections/health-shots/2018/02/26/587735283/lost-art-of-bending-over-how-other-cultures-spare-their-spines</dc:identifier>
</item>
<item>
<title>Propel – Machine learning for Javascript</title>
<link>http://propelml.org/</link>
<guid isPermaLink="true" >http://propelml.org/</guid>
<description>[unable to retrieve full-text content]&lt;p&gt;Article URL: &lt;a href=&quot;http://propelml.org/&quot;&gt;http://propelml.org/&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Comments URL: &lt;a href=&quot;https://news.ycombinator.com/item?id=16465105&quot;&gt;https://news.ycombinator.com/item?id=16465105&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Points: 209&lt;/p&gt;&lt;p&gt;# Comments: 43&lt;/p&gt;</description>
<pubDate>Mon, 26 Feb 2018 13:33:54 +0000</pubDate>
<dc:creator>namanyayg</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://propelml.org/</dc:identifier>
</item>
<item>
<title>Wolfenstein&amp;#039;s original rendering engine as 450 line shader with no external data</title>
<link>https://www.shadertoy.com/view/4sfGWX</link>
<guid isPermaLink="true" >https://www.shadertoy.com/view/4sfGWX</guid>
<description>&lt;td valign=&quot;top&quot;&gt;
&lt;ul&gt;&lt;li&gt;type radians (type degrees)&lt;/li&gt;
&lt;li&gt;type degrees (type radians)&lt;/li&gt;
&lt;li&gt;type sin (type angle)&lt;/li&gt;
&lt;li&gt;type cos (type angle)&lt;/li&gt;
&lt;li&gt;type tan (type angle)&lt;/li&gt;
&lt;li&gt;type asin (type x)&lt;/li&gt;
&lt;li&gt;type acos (type x)&lt;/li&gt;
&lt;li&gt;type atan (type y, type x)&lt;/li&gt;
&lt;li&gt;type atan (type y_over_x)&lt;/li&gt;
&lt;li&gt;type sinh (type x)&lt;/li&gt;
&lt;li&gt;type cosh (type x)&lt;/li&gt;
&lt;li&gt;type tanh (type x)&lt;/li&gt;
&lt;li&gt;type asinh (type x)&lt;/li&gt;
&lt;li&gt;type acosh (type x)&lt;/li&gt;
&lt;li&gt;type atanh (type x)&lt;/li&gt;
&lt;/ul&gt;&lt;ul&gt;&lt;li&gt;type pow (type x, type y)&lt;/li&gt;
&lt;li&gt;type exp (type x)&lt;/li&gt;
&lt;li&gt;type log (type x)&lt;/li&gt;
&lt;li&gt;type exp2 (type x)&lt;/li&gt;
&lt;li&gt;type log2 (type x)&lt;/li&gt;
&lt;li&gt;type sqrt (type x)&lt;/li&gt;
&lt;li&gt;type inversesqrt (type x)&lt;/li&gt;
&lt;/ul&gt;&lt;ul&gt;&lt;li&gt;type abs (type x)&lt;/li&gt;
&lt;li&gt;type sign (type x)&lt;/li&gt;
&lt;li&gt;type floor (type x)&lt;/li&gt;
&lt;li&gt;type ceil (type x)&lt;/li&gt;
&lt;li&gt;type trunc (type x)&lt;/li&gt;
&lt;li&gt;type fract (type x)&lt;/li&gt;
&lt;li&gt;type mod (type x, float y)&lt;/li&gt;
&lt;li&gt;type modf (type x, out type i)&lt;/li&gt;
&lt;li&gt;type min (type x, type y)&lt;/li&gt;
&lt;li&gt;type max (type x, type y)&lt;/li&gt;
&lt;li&gt;type clamp (type x, type minV, type maxV)&lt;/li&gt;
&lt;li&gt;type mix (type x, type y, type a)&lt;/li&gt;
&lt;li&gt;type step (type edge, type x)&lt;/li&gt;
&lt;li&gt;type smoothstep (type a, type b, type x)&lt;/li&gt;
&lt;/ul&gt;&lt;ul&gt;&lt;li&gt;float length (type x)&lt;/li&gt;
&lt;li&gt;float distance (type p0, type p1)&lt;/li&gt;
&lt;li&gt;float dot (type x, type y)&lt;/li&gt;
&lt;li&gt;vec3 cross (vec3 x, vec3 y)&lt;/li&gt;
&lt;li&gt;type normalize (type x)&lt;/li&gt;
&lt;li&gt;type faceforward (type N, type I, type Nref)&lt;/li&gt;
&lt;li&gt;type reflect (type I, type N)&lt;/li&gt;
&lt;li&gt;type refract (type I, type N,float eta)&lt;/li&gt;
&lt;li&gt;float determinant(mat? m)&lt;/li&gt;
&lt;li&gt;mat?x? outerProduct(vec? c, vec? r)&lt;/li&gt;
&lt;li&gt;type matrixCompMult (type x, type y)&lt;/li&gt;
&lt;li&gt;type inverse (type inverse)&lt;/li&gt;
&lt;li&gt;type transpose (type inverse)&lt;/li&gt;
&lt;/ul&gt;&lt;/td&gt;&lt;td valign=&quot;top&quot;&gt;
&lt;ul&gt;&lt;li&gt;vec4 texture( sampler? , vec? coord [, float bias])&lt;/li&gt;
&lt;li&gt;vec4 textureLod( sampler, vec? coord, float lod)&lt;/li&gt;
&lt;li&gt;vec4 textureLodOffset( sampler? sampler, vec? coord, float lod, ivec? offset)&lt;/li&gt;
&lt;li&gt;vec4 textureGrad( sampler? , vec? coord, vec2 dPdx, vec2 dPdy)&lt;/li&gt;
&lt;li&gt;vec4 textureGradOffset sampler? , vec? coord, vec? dPdx, vec? dPdy, vec? offset)&lt;/li&gt;
&lt;li&gt;vec4 textureProj( sampler? , vec? coord [, float bias])&lt;/li&gt;
&lt;li&gt;vec4 textureProjLod( sampler? , vec? coord, float lod)&lt;/li&gt;
&lt;li&gt;vec4 textureProjLodOffset( sampler? , vec? coord, float lod, vec? offset)&lt;/li&gt;
&lt;li&gt;vec4 textureProjGrad( sampler? , vec? coord, vec2 dPdx, vec2 dPdy)&lt;/li&gt;
&lt;li&gt;vec4 texelFetch( sampler? , ivec? coord, int lod)&lt;/li&gt;
&lt;li&gt;vec4 texelFetchOffset( sampler?, ivec? coord, int lod, ivec? offset )&lt;/li&gt;
&lt;li&gt;vec? textureSize( sampler? , int lod)&lt;/li&gt;
&lt;/ul&gt;&lt;ul&gt;&lt;li&gt;type dFdx (type x)&lt;/li&gt;
&lt;li&gt;type dFdy (type x)&lt;/li&gt;
&lt;li&gt;type fwidth (type p)&lt;/li&gt;
&lt;/ul&gt;&lt;ul&gt;&lt;li&gt;type isnan (type x)&lt;/li&gt;
&lt;li&gt;type isinf (type x)&lt;/li&gt;
&lt;li&gt;float intBitsToFloat (int v)&lt;/li&gt;
&lt;li&gt;uint uintBitsToFloat (uint v)&lt;/li&gt;
&lt;li&gt;int floatBitsToInt (float v)&lt;/li&gt;
&lt;li&gt;uint floatBitsToUint (float v)&lt;/li&gt;
&lt;li&gt;uint packSnorm2x16 (vec2 v)&lt;/li&gt;
&lt;li&gt;uint packUnorm2x16 (vec2 v)&lt;/li&gt;
&lt;li&gt;vec2 unpackSnorm2x16 (uint p)&lt;/li&gt;
&lt;li&gt;vec2 unpackUnorm2x16 (uint p)&lt;/li&gt;
&lt;/ul&gt;&lt;ul&gt;&lt;li&gt;bvec lessThan (type x, type y)&lt;/li&gt;
&lt;li&gt;bvec lessThanEqual (type x, type y)&lt;/li&gt;
&lt;li&gt;bvec greaterThan (type x, type y)&lt;/li&gt;
&lt;li&gt;bvec greaterThanEqual (type x, type y)&lt;/li&gt;
&lt;li&gt;bvec equal (type x, type y)&lt;/li&gt;
&lt;li&gt;bvec notEqual (type x, type y)&lt;/li&gt;
&lt;li&gt;bool any (bvec x)&lt;/li&gt;
&lt;li&gt;bool all (bvec x)&lt;/li&gt;
&lt;li&gt;bvec not (bvec x)&lt;/li&gt;
&lt;/ul&gt;&lt;/td&gt;
</description>
<pubDate>Mon, 26 Feb 2018 13:25:52 +0000</pubDate>
<dc:creator>ingve</dc:creator>
<og:image>https://www.shadertoy.com/media/shaders/4sfGWX.jpg</og:image>
<og:title>Shadertoy</og:title>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.shadertoy.com/view/4sfGWX</dc:identifier>
</item>
<item>
<title>Compiler bug? Linker bug? Windows Kernel bug</title>
<link>https://randomascii.wordpress.com/2018/02/25/compiler-bug-linker-bug-windows-kernel-bug/</link>
<guid isPermaLink="true" >https://randomascii.wordpress.com/2018/02/25/compiler-bug-linker-bug-windows-kernel-bug/</guid>
<description>&lt;p&gt;&lt;a href=&quot;https://randomascii.files.wordpress.com/2018/02/image9.png&quot;&gt;&lt;img title=&quot;image&quot; border=&quot;0&quot; alt=&quot;image&quot; src=&quot;https://randomascii.files.wordpress.com/2018/02/image_thumb9.png?w=185&amp;amp;h=315&quot; width=&quot;185&quot; align=&quot;right&quot; height=&quot;315&quot;/&gt;&lt;/a&gt;Flaky failures are the worst. In this particular investigation, which spanned twenty months, we suspected hardware failure, compiler bugs, linker bugs, and other possibilities. Jumping too quickly to blaming hardware or build tools is a classic mistake, but in this case the mistake was that we weren’t thinking big enough. Yes, there was a linker bug, but we were also lucky enough to have hit a Windows kernel bug which is triggered by linkers!&lt;/p&gt;

&lt;p&gt;In September of 2016 we started noticing &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525&quot;&gt;random failures when building Chrome&lt;/a&gt; – 3 out of 200 builds of Chrome failed when protoc.exe, one of the executables that is part of the build, crashed with an access violation. That is, we would build protoc.exe, and then run it to generate header files for the next build stage, but it would crash instead.&lt;/p&gt;
&lt;p&gt;The developers who investigated knew immediately that something weird was happening but they couldn’t reproduce the bug locally so they were forced to make guesses. A couple of speculative fixes (&lt;a href=&quot;https://codereview.chromium.org/2324823002&quot;&gt;reordering the tool’s arguments&lt;/a&gt; and &lt;a href=&quot;https://chromiumcodereview.appspot.com/2427943002&quot;&gt;adding explicit dependencies&lt;/a&gt;) were made, and the second fix seemed to work. The bug went away for a year.&lt;/p&gt;
&lt;p&gt;And then, a few days shy of its first birthday, the bug started happening again. A steady drumbeat of reports came in – ten separate bugs were merged into the &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525&quot;&gt;master bug&lt;/a&gt; over the next few months, representing just a fraction of the crashes.&lt;/p&gt;
&lt;h2&gt;Local repros&lt;/h2&gt;
&lt;p&gt;I joined the investigation when I hit the bug on my workstation. I ran the bad binary under a debugger and saw &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525#c33&quot;&gt;this assembly language&lt;/a&gt; in the debugger:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span&gt;…&lt;br/&gt;00000001400010A1 00 00  add byte ptr [rax],al&lt;br/&gt;00000001400010A3 00 00  add byte ptr [rax],al&lt;br/&gt;mainCRTStartup:&lt;br/&gt;00000001400010A5 00 00  add byte ptr [rax],al&lt;br/&gt;00000001400010A7 00 00  add byte ptr [rax],al&lt;br/&gt;…&lt;br/&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Now we have a problem statement that we can reason about: why are large chunks of our code segment filled with zeroes?&lt;/p&gt;
&lt;p&gt;I deleted the binary and relinked it and found that the zeroes were replaced with a series of five-byte jmp instructions. The long array of zeroes was in an array of thunks, used by VC++’s incremental linker so that it can more easily move functions around. It seemed quite obvious that we were hitting a bug in incremental linking. Incremental linking is an important build-time optimization for huge binaries like chrome.dll, but for tiny binaries like protoc.exe it is irrelevant, so the fix was obvious: &lt;a href=&quot;https://chromium-review.googlesource.com/777764&quot;&gt;disable incremental linking for the tiny binaries used in the build&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It turned out that this fix did work around an incremental linking bug, but it was &lt;em&gt;not&lt;/em&gt; the bug we were looking for.&lt;/p&gt;
&lt;p&gt;I then ignored the bug until I hit it on my workstation two weeks later. My fix had not worked. And, this time the array of zeroes was in a function, instead of in the incremental linking jump table.&lt;/p&gt;
&lt;p&gt;I was still assuming that we were dealing with a linker bug so when another two weeks later I hit the problem again I was confused. I was confused because I was not using Microsoft’s linker anymore. I had switched to using lld-link (use_lld=true in my gn args). In fact, when the bug first hit we had been using the VC++ compiler and linker and I’d just hit it with the clang compiler and linker. If switching out your entire toolchain doesn’t fix a bug then it’s clearly not a toolchain bug – &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525#c52&quot;&gt;mass hysteria&lt;/a&gt; was starting to seem like the best explanation.&lt;/p&gt;
&lt;h2&gt;Science!&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;https://randomascii.files.wordpress.com/2018/02/image10.png&quot;&gt;&lt;img title=&quot;Stand Back! I'm going to try SCIENCE&quot; border=&quot;0&quot; alt=&quot;Stand Back! I'm going to try SCIENCE&quot; src=&quot;https://randomascii.files.wordpress.com/2018/02/image_thumb10.png?w=299&amp;amp;h=276&quot; width=&quot;299&quot; align=&quot;right&quot; height=&quot;276&quot;/&gt;&lt;/a&gt;Up to this point I had been hitting this bug randomly. I was doing a lot of builds because I was doing build-speed investigations and these crashes were interfering with my ability to do measurements. It’s frustrating to leave your computer running tests overnight only to have crashes pollute the results. I decided it was time &lt;a href=&quot;https://store.xkcd.com/products/try-science&quot;&gt;to try science&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Instead of doing a dozen builds in a night to test a new build optimization I changed my script to just build Chrome in a loop until it failed. With &lt;a href=&quot;https://cs.chromium.org/chromium/src/docs/jumbo.md?q=jumbo&amp;amp;sq=package:chromium&amp;amp;dr=C&amp;amp;l=1&quot;&gt;jumbo&lt;/a&gt; &lt;a href=&quot;https://cs.chromium.org/chromium/src/build/toolchain/goma.gni?type=cs&amp;amp;l=8&quot;&gt;distributed&lt;/a&gt; builds and a &lt;a href=&quot;https://cs.chromium.org/chromium/src/build/config/compiler/BUILD.gn?type=cs&amp;amp;q=minimal_symbols&amp;amp;l=2040&quot;&gt;minimal level of symbols&lt;/a&gt; I can, on a good day, build Chrome a dozen times in an hour. Even a rare and flaky bug like this one starts happening &lt;em&gt;every single night&lt;/em&gt; when you do that. So do other bugs (&lt;a href=&quot;https://randomascii.wordpress.com/2018/02/11/zombie-processes-are-eating-your-memory/&quot;&gt;zombies!&lt;/a&gt;) but that’s a different story.&lt;/p&gt;
&lt;p&gt;And then, I got lucky. I logged on to my computer in the morning, saw that genmodule.exe had crashed overnight (the crashing binary varied), and decided to run it again, to get a live crash instead of looking at crash dumps. And it didn’t crash.&lt;/p&gt;
&lt;p&gt;The crash dump (I have Windows Error Reporting &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/windows/desktop/bb787181%28v=vs.85%29.aspx?f=255&amp;amp;MSPPError=-2147217396&quot;&gt;configured to save local crash dumps&lt;/a&gt;, all Windows developers should do this) showed lots of all-zero instructions in the critical path. It was not possible for this binary to run correctly. I ran genmodule.exe under the debugger and halted on the function that had previously crashed – that had previously been all zeroes – and it was fine.&lt;/p&gt;
&lt;p&gt;Apologies for the strong language, and those of a more sensitive nature (and karate fans) might want to skip the rest of this paragraph, but &lt;a href=&quot;https://en.wikipedia.org/wiki/World_Taekwondo&quot;&gt;WTF&lt;/a&gt;?!?&lt;/p&gt;
&lt;p&gt;I then loaded the crash dump into windbg and typed “!chkimg”. This command compares the code bytes in the crash dump (some of them are saved in the crash dump, just in case) against those on disk. This is helpful when a crash is caused by bad RAM or bad patching and it will sometimes report that a few dozen bytes have been changed. In this case it said that &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525#c55&quot;&gt;9322 bytes&lt;/a&gt; in the code in the crash dump were wrong. Huh!&lt;/p&gt;
&lt;p&gt;Now we have a &lt;em&gt;new&lt;/em&gt; problem statement: why are we not running the code that the linker wrote to the file?&lt;/p&gt;
&lt;p&gt;This was starting to look like a Windows file cache bug. It looked like the Windows loader was pulling in pages full of zeroes instead of the pages that we had just written. Maybe something to do with multi-socket coherency of the disk and cache or ???&lt;/p&gt;
&lt;p&gt;My coworker Zach made the vital suggestion that I &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525#c56&quot;&gt;run the sysinternals sync command&lt;/a&gt; after linking binaries. I resisted at first because the &lt;a href=&quot;https://docs.microsoft.com/en-us/sysinternals/downloads/sync&quot;&gt;sync command&lt;/a&gt; is quite heavyweight and requires administrative privileges, but eventually I ran a weekend long test where I built Chrome from scratch over 1,000 times, as admin, with &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525#c62&quot;&gt;various mitigations&lt;/a&gt; after running the linker:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Normal build: 3.5% failure rate&lt;/li&gt;
&lt;li&gt;7-second sleep after linking exes: 2% failure rate&lt;/li&gt;
&lt;li&gt;sync.exe after linking exes: 0% failure rate&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Huzzah! Running sync.exe was not a feasible fix, but it was a proof of concept. The next step was a custom C++ program that opened the just-linked exe and called &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/windows/desktop/aa364439%28v=vs.85%29.aspx?f=255&amp;amp;MSPPError=-2147217396&quot;&gt;FlushFileBuffers&lt;/a&gt; on it. This is much lighter weight and doesn’t require administrative privileges and this also stopped the bug from happening. The final step was to convert this into Python, &lt;a href=&quot;https://chromium-review.googlesource.com/876683&quot;&gt;land the change&lt;/a&gt;, and then make my favorite under-appreciated tweet:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://twitter.com/BruceDawson0xB/status/958517353435680768&quot;&gt;&lt;img title=&quot;image&quot; border=&quot;0&quot; alt=&quot;image&quot; src=&quot;https://randomascii.files.wordpress.com/2018/02/image11.png?w=591&amp;amp;h=433&quot; width=&quot;591&quot; height=&quot;433&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Later that day – before I’d had a chance to file an official bug report – I got an email from Mehmet, an ex-coworker at Microsoft, basically saying “Hey, how’s things? What’s this I hear about a kernel bug?”&lt;/p&gt;
&lt;p&gt;I shared my results (the crash dumps are quite convincing) and my methodology. They were unable to reproduce the bug – probably due to not being able to build Chrome as many times per hour as I can. But, they helped me enable circular-buffer ETW tracing, rigged to save the trace buffers on a build failure. After some back-and-forth I managed to record a trace which contained enough information for them to understand the bug.&lt;/p&gt;
&lt;p&gt;The underlying bug is that &lt;em&gt;if&lt;/em&gt; a program writes a PE file (EXE or DLL) using memory mapped file I/O and &lt;em&gt;if&lt;/em&gt; that program is then immediately executed (or loaded with LoadLibrary or LoadLibraryEx), and &lt;em&gt;if&lt;/em&gt; the system is under very heavy disk I/O load, then a necessary file-buffer flush may fail. This is very rare and can realistically only happen on build machines, and even then only on monster &lt;a href=&quot;https://randomascii.wordpress.com/2017/07/09/24-core-cpu-and-i-cant-move-my-mouse/&quot;&gt;24-core machines&lt;/a&gt; like I use. They confirmed that my fix should mitigate the bug (I’d already noted that it had allowed ~600 clean builds in a row), and promised to create a proper fix in Windows.&lt;/p&gt;
&lt;h2&gt;Play along at home&lt;/h2&gt;
&lt;p&gt;You probably won’t be able to reproduce this bug but if you want to see an example crash dump you can find one (and the .exe and .pdb files) &lt;a href=&quot;https://github.com/randomascii/blogstuff/tree/master/kernelbug_644525&quot;&gt;on github&lt;/a&gt;. You can load them into Visual Studio and see all the zero bytes in the disassembly, or load them into windbg to run !chkimg and see the !chkimg errors:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span&gt;&lt;span&gt;&lt;span&gt;0:000&amp;gt; .symp&lt;/span&gt;&lt;span&gt;ath .&lt;/span&gt;&lt;br/&gt;&lt;/span&gt;Symbol search path is: .&lt;br/&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;0:000&amp;gt; .ecxr&lt;br/&gt;&lt;/span&gt;eax=cbb75f7e …&lt;br/&gt;re2c!mainCRTStartup:&lt;br/&gt;00412d40 0000  add  byte ptr [eax],al  ds:002b:cbb75f7e=??&lt;br/&gt;&lt;span&gt;0:000&amp;gt; !chkimg&lt;/span&gt;&lt;br/&gt;9658 errors : @$ip (00408000-00415815)&lt;br/&gt;&lt;/span&gt;&lt;span&gt;&lt;span&gt;0:000&amp;gt; uf eip&lt;br/&gt;&lt;/span&gt;re2c+0x12d40:&lt;br/&gt;00412d40 0000  add byte ptr [eax],al&lt;br/&gt;00412d42 0000  add byte ptr [eax],al&lt;br/&gt;00412d44 0000  add byte ptr [eax],al&lt;br/&gt;00412d46 0000  add byte ptr [eax],al&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2&gt;Investigation complications&lt;/h2&gt;
&lt;p&gt;1) Building Chrome very quickly causes CcmExec.exe to leak process handles. Each build can leak up to 1,600 process handles and about 100 MB. That becomes a problem when you do 300+ builds in a weekend – bye bye to ~32 GB of RAM, &lt;a href=&quot;https://randomascii.wordpress.com/2018/02/11/zombie-processes-are-eating-your-memory/&quot;&gt;consumed by zombies&lt;/a&gt;. I now run a loop that periodically kills CcmExec.exe to mitigate this, and Microsoft is working on a fix.&lt;/p&gt;
&lt;p&gt;2) Most Windows developers have seen 0xC0000005 enough times to remember that it means Access Violation – it means that your program dereferenced memory that it should not have, or in a way that it should not have. But how many Windows programmers recognize the error codes 3221225477 or -1073741819? It turns out that these are the same value, printed as unsigned or signed decimal. But, not surprisingly, when developers see a number around negative one billion their eyes glaze over and the numbers all start to look the same. So when some of the crashes returned error code -1073740791 the difference was either not noticed, or &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=782128#c3&quot;&gt;was ignored&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;3) That’s a shame because it turns out that there were &lt;em&gt;two&lt;/em&gt; bugs. &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=644525&quot;&gt;crbug.com/644525&lt;/a&gt; is the Chromium bug for investigating what turned out to be this kernel bug. But, once I landed a workaround for that bug and reenabled incremental linking we started hitting different crashes – &lt;a href=&quot;https://bugs.chromium.org/p/chromium/issues/detail?id=812421&quot;&gt;crbug.com/812421&lt;/a&gt;. Some developers were hitting error code –1073740791 which is 0xC0000409 which is STATUS_STACK_BUFFER_OVERRUN. I never saw this crash myself but I asked for a crash dump (I was terrified that crbug.com/644525 had returned) from a coworker and saw that ntdll.dll!RtlpHandleInvalidUserCallTarget was calling RtlFailFast2. I recognized this signature and knew that it had nothing to do with buffer overruns. It’s a &lt;a href=&quot;https://msdn.microsoft.com/en-us/library/windows/desktop/mt637065%28v=vs.85%29.aspx?f=255&amp;amp;MSPPError=-2147217396&quot;&gt;Control Flow Guard&lt;/a&gt; violation, meaning that the OS thinks that your program is being exploited by bad people to do an illegal indirect function call.&lt;/p&gt;
&lt;p&gt;It appears that if you use /incremental with /cfg then the Control Flow Guard information isn’t always updated during incremental linking. The simple fix was to update our build configurations to &lt;a href=&quot;https://chromium-review.googlesource.com/920761&quot;&gt;never use /incremental and /cfg at the same time&lt;/a&gt; – they aren’t a useful combination anyway.&lt;/p&gt;
&lt;p&gt;And, for my own sanity, I landed a few changes that get us to &lt;a href=&quot;https://chromium-review.googlesource.com/917101&quot;&gt;print Windows error codes in hex&lt;/a&gt;. So much better.&lt;/p&gt;
&lt;h2&gt;Epilogue&lt;/h2&gt;
&lt;p&gt;We still don’t know what caused this bug to start showing up in the first place – maybe our switch to &lt;a href=&quot;https://chromium.googlesource.com/chromium/src/tools/gn/&quot;&gt;gn&lt;/a&gt; changed the ordering of build steps to make us more vulnerable?&lt;/p&gt;
&lt;p&gt;We also don’t know why the bug disappeared for a year. Was the original bug something unrelated that was &lt;a href=&quot;https://chromiumcodereview.appspot.com/2427943002&quot;&gt;fixed by this change&lt;/a&gt;? Or did we just get lucky or oblivious?&lt;/p&gt;
&lt;p&gt;Either way, whether we fixed two or three separate bugs, Chrome’s builds are much more reliable now and I can go back to doing build-performance testing without hitting failures.&lt;/p&gt;
&lt;p&gt;The Chrome workaround is 100% reliable, and both lld-link.exe and Microsoft’s link.exe will be adding &lt;a href=&quot;https://github.com/llvm-mirror/llvm/commit/8b2a3e8b203a332bbd71cb9a5708f870dec3ae74&quot;&gt;FlushFileBuffers calls&lt;/a&gt; as &lt;a href=&quot;https://developercommunity.visualstudio.com/content/problem/191590/linker-needs-workaround-for-windows-kernel-bug.html&quot;&gt;mitigations&lt;/a&gt;. If you work on a tool that creates binaries (Rust? I filed an internal bug for Go) using memory mapped files you should consider adding a FlushFileBuffers call just before closing the file. This bug shows up from Server 2008 R2 (Windows 7) up to the latest stable build of Windows 10 and OS fixes will take a while to propagate so you might as well be careful.&lt;/p&gt;
&lt;p&gt;Twitter announcement is &lt;a href=&quot;https://twitter.com/BruceDawson0xB/status/968008355259195392&quot;&gt;here&lt;/a&gt;, hacker news discussion is &lt;a href=&quot;https://news.ycombinator.com/item?id=16463572&quot;&gt;here&lt;/a&gt;, and reddit discussion is &lt;a href=&quot;https://www.reddit.com/r/programming/comments/80b6a3/compiler_bug_linker_bug_windows_kernel_bug/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;A twitter user shared a &lt;a href=&quot;https://twitter.com/jcalsbeek/status/968039765827248129&quot;&gt;report of them hitting the bug in 2015&lt;/a&gt;, which is not hugely shocking since this bug appears to be 8+ years old.&lt;/p&gt;
&lt;div class=&quot;wpcnt&quot;&gt;
&lt;div class=&quot;wpa wpmrec&quot;&gt;&lt;span class=&quot;wpa-about&quot;&gt;Advertisements&lt;/span&gt;



&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&quot;jp-post-flair&quot; class=&quot;sharedaddy sd-like-enabled sd-sharing-enabled&quot;&gt;
&lt;div class=&quot;sharedaddy sd-sharing-enabled&quot;&gt;
&lt;div class=&quot;robots-nocontent sd-block sd-social sd-social-icon-text sd-sharing&quot;&gt;
&lt;h3 class=&quot;sd-title&quot;&gt;Share this:&lt;/h3&gt;

&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;sharedaddy sd-block sd-like jetpack-likes-widget-wrapper jetpack-likes-widget-unloaded&quot; id=&quot;like-post-wrapper-18565082-2747-5a949f889c130&quot; data-src=&quot;//widgets.wp.com/likes/index.html?ver=20180221#blog_id=18565082&amp;amp;post_id=2747&amp;amp;origin=randomascii.wordpress.com&amp;amp;obj_id=18565082-2747-5a949f889c130&quot; data-name=&quot;like-post-frame-18565082-2747-5a949f889c130&quot;&gt;
&lt;h3 class=&quot;sd-title&quot;&gt;Like this:&lt;/h3&gt;
&lt;div class=&quot;likes-widget-placeholder post-likes-widget-placeholder&quot;&gt;&lt;span class=&quot;button&quot;&gt;&lt;span&gt;Like&lt;/span&gt;&lt;/span&gt; &lt;span class=&quot;loading&quot;&gt;Loading...&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;/div&gt;
</description>
<pubDate>Mon, 26 Feb 2018 06:34:08 +0000</pubDate>
<dc:creator>janvdberg</dc:creator>
<og:type>article</og:type>
<og:title>Compiler bug? Linker bug? Windows Kernel bug.</og:title>
<og:url>https://randomascii.wordpress.com/2018/02/25/compiler-bug-linker-bug-windows-kernel-bug/</og:url>
<og:description>Flaky failures are the worst. In this particular investigation, which spanned twenty months, we suspected hardware failure, compiler bugs, linker bugs, and other possibilities. Jumping too quickly …</og:description>
<og:image>https://randomascii.files.wordpress.com/2018/02/image11.png</og:image>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://randomascii.wordpress.com/2018/02/25/compiler-bug-linker-bug-windows-kernel-bug/</dc:identifier>
</item>
<item>
<title>Why can’t women get pregnant without the menstrual cycle? (2016)</title>
<link>https://www.quora.com/Why-do-women-have-periods-What-is-the-evolutionary-benefit-or-purpose-of-having-periods-Why-can%E2%80%99t-women-just-get-pregnant-without-the-menstrual-cycle/answers/4625918?share=1</link>
<guid isPermaLink="true" >https://www.quora.com/Why-do-women-have-periods-What-is-the-evolutionary-benefit-or-purpose-of-having-periods-Why-can%E2%80%99t-women-just-get-pregnant-without-the-menstrual-cycle/answers/4625918?share=1</guid>
<description>&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;I'm &lt;em&gt;so&lt;/em&gt; glad you asked. Seriously. The answer to this question is one of the most illuminating and disturbing stories in human evolutionary biology, and almost nobody knows about it. And so, O my friends, gather close, and hear the extraordinary tale of:&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;HOW THE WOMAN GOT HER PERIOD&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;Contrary to popular belief, most mammals do not menstruate. In fact, it's a feature exclusive to the higher primates and certain bats*. What's more, modern women menstruate vastly more than any other animal. And it's bloody stupid (sorry). A shameful waste of nutrients, disabling, and a dead giveaway to any nearby predators. To understand why we do it, you must first understand that you have been lied to, throughout your life, about the most intimate relationship you will ever experience: the mother-fetus bond.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;Isn't pregnancy beautiful? Look at any book about it. There's the future mother, one hand resting gently on her belly. Her eyes misty with love and wonder. You sense she will do anything to nurture and protect this baby. And when you flip open the book, you read more about this glorious symbiosis, the absolute altruism of female physiology designing a perfect environment for the growth of her child.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;If you've actually &lt;em&gt;been&lt;/em&gt; pregnant, you might know that the real story has some wrinkles. Those moments of sheer unadulterated altruism exist, but they're interspersed with weeks or months of overwhelming nausea, exhaustion, crippling backache, incontinence, blood pressure issues and anxiety that you'll be among the 15% of women who experience &lt;em&gt;life-threatening&lt;/em&gt; complications.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;From the perspective of most mammals, this is just crazy. Most mammals sail through pregnancy quite cheerfully, dodging predators and catching prey, even if they're delivering litters of 12. So what makes us so special? The answer lies in our bizarre placenta. In most mammals, the placenta, which is part of the fetus, just interfaces with the surface of the mother's blood vessels, allowing nutrients to cross to the little darling. Marsupials don't even let their fetuses get to the blood: they merely secrete a sort of milk through the uterine wall. Only a few mammalian groups, including primates and mice, have evolved what is known as a “hemochorial” placenta, and ours is possibly the nastiest of all.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;Inside the uterus we have a thick layer of endometrial tissue, which contains only tiny blood vessels. The endometrium seals off our main blood supply from the newly implanted embryo. The growing placenta literally burrows through this layer, rips into arterial walls and re-wires them to channel blood straight to the hungry embryo. It delves deep into the surrounding tissues, razes them and pumps the arteries full of hormones so they expand into the space created. It paralyzes these arteries so the mother cannot even constrict them.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;What this means is that the growing fetus now has direct, unrestricted access to its mother's blood supply. It can manufacture hormones and use them to manipulate her. It can, for instance, increase her blood sugar, dilate her arteries, and inflate her blood pressure to provide itself with more nutrients. And it does. Some fetal cells find their way through the placenta and into the mother's bloodstream. They will grow in her blood and organs, and even in her brain, for the rest of her life, making her a genetic chimera**.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;This might seem rather disrespectful. In fact, it's sibling rivalry at its evolutionary best. You see, mother and fetus have quite distinct evolutionary interests. The mother 'wants' to dedicate approximately equal resources to all her surviving children, including possible future children, and none to those who will die. The fetus 'wants' to survive, and take as much as it can get. (The quotes are to indicate that this isn't about what they consciously want, but about what evolution tends to optimize.)&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;There's also a third player here – the father, whose interests align still less with the mother's because her other offspring may not be his. Through a process called genomic imprinting, certain fetal genes inherited from the father can activate in the placenta. These genes ruthlessly promote the welfare of the offspring at the mother's expense.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;How did we come to acquire this ravenous hemochorial placenta which gives our fetuses and their fathers such unusual power? Whilst we can see some trend toward increasingly invasive placentae within primates, the full answer is lost in the mists of time. Uteri do not fossilize well.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;The consequences, however, are clear. Normal mammalian pregnancy is a well-ordered affair because the mother is a despot. Her offspring live or die at her will; she controls their nutrient supply, and she can expel or reabsorb them any time. Human pregnancy, on the other hand, is run by committee – and not just any committee, but one whose members often have very different, competing interests and share only partial information. It's a tug-of-war that not infrequently deteriorates to a tussle and, occasionally, to outright warfare. Many potentially lethal disorders, such as ectopic pregnancy, gestational diabetes, and pre-eclampsia can be traced to mis-steps in this intimate game.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;What does all this have to do with menstruation? We're getting there.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;From a female perspective, pregnancy is always a huge investment. Even more so if her species has a hemochorial placenta. Once that placenta is in place, she not only loses full control of her own hormones, she also risks hemorrhage when it comes out. So it makes sense that females want to screen embryos very, very carefully. Going through pregnancy with a weak, inviable or even sub-par fetus isn't worth it.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;That's where the endometrium comes in. You've probably read about how the endometrium is this snuggly, welcoming environment just waiting to enfold the delicate young embryo in its nurturing embrace. In fact, it's quite the reverse. Researchers, bless their curious little hearts, have tried to implant embryos all over the bodies of mice. The single most difficult place for them to grow was – the endometrium.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;Far from offering a nurturing embrace, the endometrium is a lethal testing-ground which only the toughest embryos survive. The longer the female can delay that placenta reaching her bloodstream, the longer she has to decide if she wants to dispose of this embryo without significant cost. The embryo, in contrast, wants to implant its placenta as quickly as possible, both to obtain access to its mother's rich blood, and to increase her stake in its survival. For this reason, the endometrium got thicker and tougher – and the fetal placenta got correspondingly more aggressive.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;But this development posed a further problem: what to do when the embryo died or was stuck half-alive in the uterus? The blood supply to the endometrial surface must be restricted, or the embryo would simply attach the placenta there. But restricting the blood supply makes the tissue weakly responsive to hormonal signals from the mother – and potentially more responsive to signals from nearby embryos, who naturally would like to persuade the endometrium to be more friendly. In addition, this makes it vulnerable to infection, especially when it already contains dead and dying tissues.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;The solution, for higher primates, was to slough off the whole superficial endometrium – dying embryos and all – after every ovulation that &lt;em&gt;didn't&lt;/em&gt; result in a healthy pregnancy. It's not exactly brilliant, but it works, and most importantly, it's easily achieved by making some alterations to a chemical pathway normally used by the fetus during pregnancy. In other words, it's just the kind of effect natural selection is renowned for: odd, hackish solutions that work to solve proximate problems. It's not quite as bad as it seems, because in nature, women would experience periods quite rarely – probably no more than a few tens of times in their lives between lactational amenorrhea and pregnancies***.&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;We don't really know how our hyper-aggressive placenta is linked to the other traits that combine to make humanity unique. But these traits did emerge together somehow, and that means in some sense the ancients were perhaps right. When we metaphorically 'ate the fruit of knowledge' – when we began our journey toward science and technology that would separate us from innocent animals and also lead to our peculiar sense of sexual morality – perhaps that was the same time the unique suffering of menstruation, pregnancy and childbirth was inflicted on women. All thanks to the evolution of the hemochorial placenta.&lt;/span&gt;&lt;/p&gt;
&lt;hr class=&quot;qtext_hr&quot;/&gt;&lt;p class=&quot;ui_qtext_para&quot;&gt;&lt;span class=&quot;ui_qtext_rendered_qtext&quot;&gt;Links / References:&lt;br/&gt;&lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3528014/&quot; rel=&quot;noopener nofollow&quot; target=&quot;_blank&quot; onclick=&quot;return Q.openUrl(this, 4625918);&quot; class=&quot;external_link&quot; data-qt-tooltip=&quot;nih.gov&quot;&gt;The evolution of menstruation: A new model for genetic assimilation&lt;/a&gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;http://www.ncbi.nlm.nih.gov/pubmed/8115596&quot; rel=&quot;noopener nofollow&quot; target=&quot;_blank&quot; onclick=&quot;return Q.openUrl(this, 4625918);&quot; class=&quot;external_link&quot; data-qt-tooltip=&quot;nih.gov&quot;&gt;Genetic conflicts in human pregnancy.&lt;/a&gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;http://www.ncbi.nlm.nih.gov/pubmed/9618925&quot; rel=&quot;noopener nofollow&quot; target=&quot;_blank&quot; onclick=&quot;return Q.openUrl(this, 4625918);&quot; class=&quot;external_link&quot; data-qt-tooltip=&quot;nih.gov&quot;&gt;Menstruation: a nonadaptive consequence of uterin... [Q Rev Biol. 1998]&lt;/a&gt;&lt;/span&gt;&lt;br/&gt;&lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2858159/&quot; rel=&quot;noopener nofollow&quot; target=&quot;_blank&quot; onclick=&quot;return Q.openUrl(this, 4625918);&quot; class=&quot;external_link&quot; data-qt-tooltip=&quot;nih.gov&quot;&gt;Natural Selection of Human Embryos: Decidualizing Endometrial Stromal Cells Serve as Sensors of Embryo Quality upon Implantation&lt;/a&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;References for the mouse implantation studies:&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;Runner, M. N. (1947) Development of mouse eggs in the anterior chamber of the eye. Anatomical Record 98: 1-17.&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;Kirby, D. R. S. (1965) The &quot;invasiveness&quot; of the trophoblast. Pages 68-73, in W. W. Park (ed.), The early conceptus, normal and abnormal. University of St. Andrews, St. Andrews.&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;* mouse blastocysts implanted in kidney, spleen, testis, brain, liver&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;McLaren, A. (1965) Maternal factors in nidation. Pages 27-33, in W. W. Park (ed.), The early conceptus, normal and abnormal. University of St. Andrews, St. Andrews.&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&quot;The fact that successful implantation and subsequent development can occur in the testis emphasises the most striking and, to me, unexpected feature of implantation outside the uterus, namely, that it is entirely independent of the sex or hormonal status of the host. Pregnant females, non-pregnant females and males all provided an apparently equally good substrate for implantation in Kirby's experiments …&quot;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;&quot;What a contrast this makes to the situation inside the uterus! The experiments so far might lead one to think that the rodent blastocyst's capacity to implant and develop was so strong that only the most unfavourable of circumstances could stop it. Yet the uterus, which one might picture as especially welcoming and receptive, is in fact so inimical to implantation that there is only a brief period of time during which a blastocyst placed within it can hope to survive.&quot;&lt;/p&gt;
&lt;hr class=&quot;qtext_hr&quot;/&gt;&lt;p class=&quot;ui_qtext_para&quot;&gt;Credits: During my pregnancy I was privileged to audit a class at Harvard University by the eminent Professor David Haig, whose insight underlies much of this research. Thanks also to &lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;https://www.quora.com/profile/Edgar-A-Duenez-Guzman&quot;&gt;Edgar A. Duenez-Guzman&lt;/a&gt;&lt;/span&gt;, who reminded me of crucial details. All errors are mine alone.&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;*Dogs undergo vaginal bleeding, but do not menstruate. Elephant shrews were previously thought to menstruate, but it's now believed that these events were most likely spontaneous abortions.&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;** &lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;http://www.scientificamerican.com/article/scientists-discover-childrens-cells-living-in-mothers-brain/&quot; rel=&quot;noopener nofollow&quot; target=&quot;_blank&quot; onclick=&quot;return Q.openUrl(this, 4625918);&quot; class=&quot;external_link&quot; data-qt-tooltip=&quot;scientificamerican.com&quot;&gt;Scientists Discover Children’s Cells Living in Mothers’ Brains&lt;/a&gt;&lt;/span&gt; (Thanks to &lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;https://www.quora.com/profile/Robyn-Adair&quot;&gt;Robyn Adair&lt;/a&gt;&lt;/span&gt; for the link).&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;***One older published estimate for hunter gatherers was around 50, but this relied on several assumptions, including 3 whole years of menstruation before reproduction (36 periods) for no obvious reason.&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;A study of the Dogon of Mali based on 57 women in natural-fertility cycles estimates the median number of life-time menses at 109: &lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;http://www.jstor.org/stable/2744446&quot; rel=&quot;noopener nofollow&quot; target=&quot;_blank&quot; onclick=&quot;return Q.openUrl(this, 4625918);&quot; class=&quot;external_link&quot;&gt;http://www.jstor.org/stable/2744446&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p class=&quot;ui_qtext_para&quot;&gt;To get a feel for life history parameters, we can look at data from the Hadza of Tanzania, who reach puberty around 18, bear an average of 6.2 children in their lives (plus 2-3 noticeable miscarriages) starting at 19, and go through menopause at about 43 if they survive that long (about 50% don't). Around 20% of babies die in their first year; the remainder breastfeed for about 4 years. So this is 25 years of reproductive life, of which about 20 are spent lactating, and 4.5 pregnant. That would leave only about 6 periods, but amenorrhoea would cease during the last year of lactation for each child, so this figure is too low. On the other hand, this calculation ignores the ~50% of women who died before menopause, miscarriages, months spent breastfeeding infants who would die, and periods of food scarcity, all of which would further reduce lifetime menstruation. Stats from: &lt;span class=&quot;qlink_container&quot;&gt;&lt;a href=&quot;http://www.fas.harvard.edu/%7Ehbe-lab/acrobatfiles/who%20tends%20hadza%20children.pdf&quot; rel=&quot;noopener nofollow&quot; target=&quot;_blank&quot; onclick=&quot;return Q.openUrl(this, 4625918);&quot; class=&quot;external_link&quot; data-qt-tooltip=&quot;harvard.edu&quot;&gt;http://www.fas.harvard.edu/%7Ehb...&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;
</description>
<pubDate>Mon, 26 Feb 2018 04:13:49 +0000</pubDate>
<dc:creator>johnny313</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.quora.com/Why-do-women-have-periods-What-is-the-evolutionary-benefit-or-purpose-of-having-periods-Why-can%E2%80%99t-women-just-get-pregnant-without-the-menstrual-cycle/answers/4625918?share=1</dc:identifier>
</item>
</channel>
</rss>