<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet type="text/xsl" href="css/feed.xsl"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:og="http://ogp.me/ns#">
<channel>
<atom:link rel="self" href="http://192.168.1.4/fivefilters/makefulltextfeed.php?url=hnrss.org%2Fnewest%3Fpoints%3D200&amp;max=10&amp;links=preserve&amp;exc=" />
<atom:link rel="alternate" title="Source URL" href="http://hnrss.org/newest?points=200" />
<atom:link rel="related" title="Subscribe to feed" href="http://www.subtome.com/#/subscribe?feeds=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D&amp;back=http%3A%2F%2F192.168.1.4%2Ffivefilters%2Fmakefulltextfeed.php%3Furl%3Dhnrss.org%252Fnewest%253Fpoints%253D200%26max%3D10%26links%3Dpreserve%26exc%3D" />
<title>Hacker News: Newest</title>
<link>https://news.ycombinator.com/newest</link>
<description>Hacker News RSS</description>
<item>
<title>82-Year-Old Japanese Woman Finds Success in Coding</title>
<link>https://www.aarp.org/work/working-at-50-plus/info-2018/worlds-oldest-app-developer-fd.html</link>
<guid isPermaLink="true" >https://www.aarp.org/work/working-at-50-plus/info-2018/worlds-oldest-app-developer-fd.html</guid>
<description>&lt;div class=&quot;aarpe-image img-responsive full-width&quot; readability=&quot;11&quot;&gt;&lt;img itemprop=&quot;image&quot; data-src=&quot;https://cdn.aarp.net/content/dam/aarp/work/working_retirement/2018/02/1140-82-year-old-programmer-masako-wakamiya.imgcache.revb1513d0bd11318c0698969e7455b397a.jpg&quot; alt=&quot;82-year-old programmer Masako Wakamiya &quot; title=&quot;82-year-old programmer Masako Wakamiya &quot; class=&quot;img-responsive lazyload&quot;/&gt;&lt;p class=&quot;credit&quot;&gt;KAZUHIRO NOGI/AFP/Getty Images&lt;/p&gt;
&lt;p class=&quot;caption&quot;&gt;When software developers weren't interested in her idea about mobile games for older adults, 82-year-old Masako Wakamiya took matters into her own hands.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;http://www.aarp.org/espanol/trabajo/exito-laboral/info-2018/mujer-japonesa-programadora-a-los-82.html?intcmp=AE-WORK-TOSPA-TOGL-ES&quot;&gt;En español&lt;/a&gt; |  Looking for a new hobby? Maybe it’s time to try &lt;a href=&quot;https://www.aarp.org/entertainment/books/bookstore/technology-innovation/&quot;&gt;coding&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;That’s what 82-year-old Masako Wakamiya of Japan decided to do this past year. Since learning to write code in early 2017, the retired bank clerk has gone on to author a free iOS game, &lt;a href=&quot;https://itunes.apple.com/us/app/hinadan/id1199778491?mt=8&quot; target=&quot;_blank&quot; data-default-element-msg=&quot;AARP.Everywhere.LeavingModal.drawOverlay(this.getAttribute('href'), '_blank', '');return false;&quot;&gt;Hinadan&lt;/a&gt;, specifically geared toward an older, Japanese audience. The app has garnered nearly 5 stars on the Apple App Store, and roughly 53,000 downloads worldwide, since its debut a year ago; Wakamiya is now busy planning future versions in English, Chinese and possibly French.&lt;/p&gt;
&lt;p&gt;Just as Facebook and Apple see a median employee age of 29 and 31, respectively, Wakamiya is busy leaving ageist naysayers in the dust. In the months since Apple CEO Tim Cook called Wakamiya the “world’s oldest app developer” in attendance at the tech giant’s annual Worldwide Developers Conference in San Jose, Calif., the Tokyo native’s spotlight has only grown — no small feat in an industry where &lt;a href=&quot;https://www.aarp.org/work/working-at-50-plus/info-2017/ageism-technology-industry-fd.html&quot;&gt;tech workers over 40&lt;/a&gt; are often deemed “old.” This past year, Japan’s government appointed her to a special committee on aging; and just last month, Wakamiya was a keynote speaker at an event at the United Nations’ New York City headquarters, titled Why Are Digital Skills Critical for Older Persons?&lt;/p&gt;
&lt;p&gt;For Wakamiya, the answer comes down to motivation. She’s unflinching in her assessment of the challenges facing Japan’s aging population (age 65 and above), which is projected to grow to 40 percent by 2055.&lt;/p&gt;
&lt;p&gt;“Seniors tend to be depressed as they age, because they lose … family members,” said Wakamiya, in a recent interview with the millennial publication Refinery29. “By teaching them to do new things, it gives them an excitement, a motivation — I really like that feeling and being able to share that.”&lt;/p&gt;
&lt;p&gt;After noticing a lack of mobile games for older people in her country — in the United States, &lt;a href=&quot;http://games.aarp.org/&quot;&gt;AARP Games&lt;/a&gt; offers many options — Wakamiya asked software developers to step in. Uninterested, they suggested she make a game herself. She took them up on the suggestion. Wakamiya soon bought programming books and learned Apple’s Swift programming language through lessons with a programmer, nearly 200 miles away from her home in Japan's Kanagawa Prefecture, via Facebook Messenger and Skype.&lt;/p&gt;
&lt;p&gt;This wasn’t the first time that Wakamiya took on a challenge. She’s been dabbling in the tech field since the age of 60.&lt;/p&gt;
&lt;p&gt;Upon retiring from a 43-year career as a bank clerk (she began at age 18), Wakamiya spent long hours &lt;a href=&quot;https://www.aarp.org/caregiving/&quot;&gt;caregiving&lt;/a&gt; for her then-90-year-old mother. Feeling isolated, and seeking connection with the outside world, Wakamiya bought her first computer, then moved on to a Microsoft PC, and later a Mac and iPhones. In between learning the piano, at age 75, Wakamiya eventually joined a computer club for seniors, Mellow Club, learning to create Excel art along the way. Then, this past year came Wakamiya’s focus on creating the game Hinadan.&lt;/p&gt;
&lt;p&gt;The app, based on the annual Japanese doll festival of Hina Matsuri, invites players to arrange 12 ornamental dolls — representing the country’s emperor, family and guests — in a specific order. The game requires in-depth memorization of various arrangements, and has become especially popular with older women, who enjoy playing it with their grandchildren, Wakamiya said.&lt;/p&gt;
&lt;p&gt;“They found an app they can actually relate to,” Wakamiya told Refinery29.&lt;/p&gt;
&lt;p&gt;As improbable as her story may sound, Wakamiya isn’t a total outlier on the “silver” tech front. In 2015, then-98-year-old Australian grandmother Millie Browne created a word app, “&lt;a href=&quot;http://www.milliesgame.com/&quot; target=&quot;_blank&quot; data-default-element-msg=&quot;AARP.Everywhere.LeavingModal.drawOverlay(this.getAttribute('href'), '_blank', '');return false;&quot;&gt;Millie’s Game&lt;/a&gt;.” And this past fall, the New York Times reported that roughly 1 million of the 45 million global users of the free online coding platform &lt;a href=&quot;https://www.codecademy.com/&quot; target=&quot;_blank&quot; data-default-element-msg=&quot;AARP.Everywhere.LeavingModal.drawOverlay(this.getAttribute('href'), '_blank', '');return false;&quot;&gt;Codeacademy&lt;/a&gt; are 55 or older. Yet Wakamiya’s rise from retired bank clerk to tech celeb still surprises her.&lt;/p&gt;
&lt;p&gt;“I didn’t expect such a huge response to my childish app,” Wakamiya recently told Channel NewsAsia. She’s now eager to develop more game apps, adding, “I have many things I want to try.”&lt;/p&gt;
</description>
<pubDate>Mon, 21 May 2018 18:16:34 +0000</pubDate>
<dc:creator>joering2</dc:creator>
<og:title>82-Year-Old Japanese Woman Finds Success in Coding</og:title>
<og:description>Masako Wakamiya learned to code only last year, but has already created the popular iOS mobile game Hinadan and spoke to the UN about her experience</og:description>
<og:url>http://www.aarp.org/work/working-at-50-plus/info-2018/worlds-oldest-app-developer-fd.html</og:url>
<og:type>article</og:type>
<og:image>https://cdn.aarp.net/content/dam/aarp/work/working_retirement/2018/02/1140-82-year-old-programmer-masako-wakamiya.imgcache.revb1513d0bd11318c0698969e7455b397a.jpg</og:image>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.aarp.org/work/working-at-50-plus/info-2018/worlds-oldest-app-developer-fd.html</dc:identifier>
</item>
<item>
<title>PostgreSQL 11 Partitioning Improvements</title>
<link>https://pgdash.io/blog/partition-postgres-11.html</link>
<guid isPermaLink="true" >https://pgdash.io/blog/partition-postgres-11.html</guid>
<description>&lt;p&gt;PostgreSQL 11, due to be released later this year, comes with a bunch of improvements for the &lt;em&gt;declarative partitioning&lt;/em&gt; feature that was introduced in version 10. Here’s a quick look at what’s on the menu.&lt;/p&gt;
&lt;h3 id=&quot;partitioned-tables-in-postgres&quot;&gt;Partitioned Tables in Postgres&lt;/h3&gt;
&lt;p&gt;Postgres 10 introduced natively partitioned tables in core PostgreSQL. With this feature, you can shard a table into multiple child tables. The parent table itself contains no rows, but serves as a “virtual” table into which you can insert rows and query from. Combining this with other PostgreSQL features, you can have child tables on separate disks (&lt;a href=&quot;https://pgdash.io/blog/tablespaces-postgres.html&quot;&gt;tablespaces&lt;/a&gt;) or even other servers (&lt;a href=&quot;https://www.postgresql.org/docs/10/static/postgres-fdw.html&quot;&gt;FDW&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;Checkout the Postgres &lt;a href=&quot;https://www.postgresql.org/docs/10/static/ddl-partitioning.html&quot;&gt;docs&lt;/a&gt; for more on partitioned tables.&lt;/p&gt;
&lt;p&gt;PostgreSQL 11 brings all around improvements to partitioning functionality. You can get your hands dirty with the new features on the first beta which should be coming out in a few weeks. Or compile it from the latest snapshot, like we did.&lt;/p&gt;
&lt;p&gt;So without further ado, here is the list you came here for:&lt;/p&gt;
&lt;h3 id=&quot;1-update-moves-rows-across-partitions&quot;&gt;1. Update Moves Rows Across Partitions&lt;/h3&gt;
&lt;p&gt;PostgreSQL 10 did not let you perform updates to rows that would result in the row ending up in a different partition. For example, if you had a table with 2 partitions, and 1 row in the first one:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;CREATE TABLE measurement (
    logdate         date not null,
    peaktemp        int,
    unitsales       int
) PARTITION BY RANGE (logdate);

CREATE TABLE measurement_y2016 PARTITION OF measurement 
FOR VALUES FROM ('2016-01-01') TO ('2017-01-01');

CREATE TABLE measurement_y2017 PARTITION OF measurement
FOR VALUES FROM ('2017-01-01') TO ('2018-01-01');

INSERT INTO measurement (logdate, peaktemp, unitsales)
    VALUES ('2016-07-10', 66, 100); -- goes into measurement_y2016 table&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;..and you tried to update the row such that as per the partition range it should end up in the other child table (&lt;code class=&quot;highlighter-rouge&quot;&gt;measurement_y2017&lt;/code&gt;), this is what happens:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg10=&amp;gt; UPDATE measurement SET logdate='2017-07-10';
ERROR:  new row for relation &quot;measurement_y2016&quot; violates partition constraint
DETAIL:  Failing row contains (2017-07-10, 66, 100).&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;But the same statement in Postgres 11 will move the row to the correct partition:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# UPDATE measurement SET logdate='2017-07-10';
UPDATE 1
pg11=# select * from measurement_y2016;
 logdate | peaktemp | unitsales
---------+----------+-----------
(0 rows)

pg11=# select * from measurement_y2017;
  logdate   | peaktemp | unitsales
------------+----------+-----------
 2017-07-10 |       66 |       100
(1 row)&lt;/code&gt;
&lt;/pre&gt;
&lt;h3 id=&quot;2-create-default-partitions&quot;&gt;2. Create Default Partitions&lt;/h3&gt;
&lt;p&gt;With v11 it is now possible to create a “default” partition, which can store rows that do not fall into any existing partition’s range or list.&lt;/p&gt;
&lt;p&gt;In v10, trying to insert such a row fails:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg10=&amp;gt; INSERT INTO measurement (logdate, peaktemp, unitsales)
    VALUES ('2018-07-10', 66, 100);
ERROR:  no partition of relation &quot;measurement&quot; found for row
DETAIL:  Partition key of the failing row contains (logdate) = (2018-07-10).&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;But in v11 we can first create a default partition:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# CREATE TABLE measurement_default PARTITION OF measurement DEFAULT;
CREATE TABLE&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Note the new syntax that says “DEFAULT” instead of “FOR VALUES …”. With the default partition in place, we can insert rows that do not fall in any existing partition’s range/list:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# INSERT INTO measurement (logdate, peaktemp, unitsales)
    VALUES ('2018-07-10', 66, 100);
INSERT 0 1
pg11=# SELECT * FROM measurement_default;
  logdate   | peaktemp | unitsales
------------+----------+-----------
 2018-07-10 |       66 |       100
(1 row)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The unclaimed row ends up in the table marked as the default partition.&lt;/p&gt;
&lt;p&gt;A word of warning though: after adding a default partition, it becomes impossible to directly add another partition to cover a new range. You’ll need to detach the default partition, create the new partition, “manually” move the matching rows from the default partition to the new partition and then reattach the default partition.&lt;/p&gt;
&lt;h3 id=&quot;3-automatic-index-creation&quot;&gt;3. Automatic Index Creation&lt;/h3&gt;
&lt;p&gt;Indexes had to be created manually for each partition in v10. Trying to create a partition on the parent table fails:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg10=&amp;gt; CREATE INDEX ixsales ON measurement(unitsales);
ERROR:  cannot create index on partitioned table &quot;measurement&quot;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;In v11, if you create an index on the parent table, Postgres will automatically create indexes on all the child tables:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# CREATE INDEX ixsales ON measurement(unitsales);
CREATE INDEX
pg11=# \d measurement_y2016
           Table &quot;public.measurement_y2016&quot;
  Column   |  Type   | Collation | Nullable | Default
-----------+---------+-----------+----------+---------
 logdate   | date    |           | not null |
 peaktemp  | integer |           |          |
 unitsales | integer |           |          |
Partition of: measurement FOR VALUES FROM ('2016-01-01') TO ('2017-01-01')
Indexes:
    &quot;measurement_y2016_unitsales_idx&quot; btree (unitsales)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Any new partitions created after the index was created, will also automagically get an index added to it.&lt;/p&gt;
&lt;h3 id=&quot;4-foreign-key-support&quot;&gt;4. Foreign Key Support&lt;/h3&gt;
&lt;p&gt;It was not possible to have a column in a partitioned table be a foreign key. This is what you got in v10:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg10=&amp;gt; CREATE TABLE invoices ( invoice_id integer PRIMARY KEY );
CREATE TABLE
pg10=&amp;gt;
pg10=&amp;gt; CREATE TABLE sale_amounts_1 (
pg10(&amp;gt;     saledate   date    NOT NULL,
pg10(&amp;gt;     invoiceid  integer REFERENCES invoices(invoice_id)
pg10(&amp;gt; ) PARTITION BY RANGE (saledate);
ERROR:  foreign key constraints are not supported on partitioned tables
LINE 3:     invoiceid  integer REFERENCES invoices(invoice_id)
                               ^&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;But in v11, foreign keys are allowed:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# CREATE TABLE invoices ( invoice_id integer PRIMARY KEY );
CREATE TABLE
pg11=#
pg11=# CREATE TABLE sale_amounts_1 (
pg11(#     saledate   date    NOT NULL,
pg11(#     invoiceid  integer REFERENCES invoices(invoice_id)
pg11(# ) PARTITION BY RANGE (saledate);
CREATE TABLE&lt;/code&gt;
&lt;/pre&gt;
&lt;h3 id=&quot;5-unique-indexes&quot;&gt;5. Unique Indexes&lt;/h3&gt;
&lt;p&gt;In Postgres 10, you had to enforce unique constraints at child tables. It was not possible to create a unique index on the master:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg10=&amp;gt; CREATE TABLE sale_amounts_2 (
pg10(&amp;gt;     saledate   date NOT NULL,
pg10(&amp;gt;     invoiceid  INTEGER,
pg10(&amp;gt;     UNIQUE (saledate, invoiceid)
pg10(&amp;gt; ) PARTITION BY RANGE (saledate);
ERROR:  unique constraints are not supported on partitioned tables
LINE 4:     UNIQUE (saledate, invoiceid)
            ^&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;With Postgres 11, you can create a unique index on the master:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# CREATE TABLE sale_amounts_2 (
pg11(#     saledate   date NOT NULL,
pg11(#     invoiceid  INTEGER,
pg11(#     UNIQUE (saledate, invoiceid)
pg11(# ) PARTITION BY RANGE (saledate);
CREATE TABLE&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;..and Postgres will take care of creating indexes on all existing and future child tables:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# CREATE TABLE sale_amounts_2_y2016 PARTITION OF sale_amounts_2
pg11-# FOR VALUES FROM ('2016-01-01') TO ('2017-01-01');
CREATE TABLE
pg11=# \d sale_amounts_2_y2016
         Table &quot;public.sale_amounts_2_y2016&quot;
  Column   |  Type   | Collation | Nullable | Default
-----------+---------+-----------+----------+---------
 saledate  | date    |           | not null |
 invoiceid | integer |           |          |
Partition of: sale_amounts_2 FOR VALUES FROM ('2016-01-01') TO ('2017-01-01')
Indexes:
    &quot;sale_amounts_2_y2016_saledate_invoiceid_key&quot; UNIQUE CONSTRAINT, btree (saledate, invoiceid)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The columns in the index definition should be a superset of the partition key columns. This means that the uniqueness is enforced locally to each partition, and you can’t use this to enforce uniqueness of alternate-primary-key columns.&lt;/p&gt;
&lt;h3 id=&quot;6-partition-level-aggregation&quot;&gt;6. Partition-level Aggregation&lt;/h3&gt;
&lt;p&gt;PostgreSQL 11 comes with a new option, called &lt;em&gt;enable_partitionwise_aggregate&lt;/em&gt;, which you can turn on to make the query planner to push aggregation down to the partition level. By default, this option is off, and you get plans as before:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# EXPLAIN SELECT logdate, count(*) FROM measurement GROUP BY logdate;
                                   QUERY PLAN
---------------------------------------------------------------------------------
 HashAggregate  (cost=27.98..38.96 rows=1098 width=12)
   Group Key: measurement_y2016.logdate
   -&amp;gt;  Append  (cost=0.00..22.49 rows=1099 width=4)
         -&amp;gt;  Seq Scan on measurement_y2016  (cost=0.00..5.66 rows=366 width=4)
         -&amp;gt;  Seq Scan on measurement_y2017  (cost=0.00..5.66 rows=366 width=4)
         -&amp;gt;  Seq Scan on measurement_default  (cost=0.00..5.67 rows=367 width=4)
(6 rows)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;This says the grouping happens over a superset of all the individual, per-partition scans. Let’s turn on the new option and see the updated plan:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# SET enable_partitionwise_aggregate=on;
SET
pg11=# EXPLAIN SELECT logdate, count(*) FROM measurement GROUP BY logdate;
                                   QUERY PLAN
---------------------------------------------------------------------------------
 Append  (cost=7.49..38.96 rows=1098 width=12)
   -&amp;gt;  HashAggregate  (cost=7.49..11.15 rows=366 width=12)
         Group Key: measurement_y2016.logdate
         -&amp;gt;  Seq Scan on measurement_y2016  (cost=0.00..5.66 rows=366 width=4)
   -&amp;gt;  HashAggregate  (cost=7.49..11.14 rows=365 width=12)
         Group Key: measurement_y2017.logdate
         -&amp;gt;  Seq Scan on measurement_y2017  (cost=0.00..5.66 rows=366 width=4)
   -&amp;gt;  HashAggregate  (cost=7.51..11.18 rows=367 width=12)
         Group Key: measurement_default.logdate
         -&amp;gt;  Seq Scan on measurement_default  (cost=0.00..5.67 rows=367 width=4)
(10 rows)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Now the grouping happens once per partition, and the results are just concatenated (we’re grouping by the partition key here).&lt;/p&gt;
&lt;p&gt;Pushing down the aggregation should result in faster queries because of better parallelism and improved lock handling.&lt;/p&gt;
&lt;h3 id=&quot;7-partition-by-hash&quot;&gt;7. Partition by Hash&lt;/h3&gt;
&lt;p&gt;Postgres 10 came with RANGE and LIST type partitions. In 11, we have HASH type partitions also. Hash type partitions distribute the rows based on the hash value of the partition key. The reminder of the hash value when divided by a specified integer is used to calculate which partition the row goes into (or can be found in).&lt;/p&gt;
&lt;p&gt;Here is how to create a hash partition, in this case over a partition key of type text:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# CREATE TABLE hp ( foo text ) PARTITION BY HASH (foo);
CREATE TABLE
pg11=# CREATE TABLE hp_0 PARTITION OF hp FOR VALUES WITH (MODULUS 3, REMAINDER 0);
CREATE TABLE
pg11=# CREATE TABLE hp_1 PARTITION OF hp FOR VALUES WITH (MODULUS 3, REMAINDER 1);
CREATE TABLE
pg11=# CREATE TABLE hp_2 PARTITION OF hp FOR VALUES WITH (MODULUS 3, REMAINDER 2);
CREATE TABLE&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;We expect each partition to contain about a third of all the rows – let’s try it out:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;language-text&quot; data-lang=&quot;text&quot;&gt;pg11=# INSERT INTO hp SELECT md5(v::text) FROM generate_series(0,10000) v;
INSERT 0 10001
pg11=# SELECT count(*) FROM hp_0;
 count
-------
  3402
(1 row)

pg11=# SELECT count(*) FROM hp_1;
 count
-------
  3335
(1 row)

pg11=# SELECT count(*) FROM hp_2;
 count
-------
  3264
(1 row)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;You can read more about hash partition &lt;a href=&quot;https://www.postgresql.org/docs/devel/static/ddl-partitioning.html&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h3 id=&quot;8-faster-queries&quot;&gt;8. Faster Queries&lt;/h3&gt;
&lt;p&gt;Apart from these features, several improvments to the query planner and executor and partition pruning algorithms make for faster queries on partitoned tables in PostgreSQL 11. It is too early in the v11 release cycle to benchmark any results though.&lt;/p&gt;
&lt;h3 id=&quot;about-pgdash&quot;&gt;About pgDash&lt;/h3&gt;
&lt;p&gt;&lt;a href=&quot;https://pgdash.io&quot;&gt;pgDash&lt;/a&gt; is an in-depth monitoring solution designed specifically for PostgreSQL deployments. pgDash shows you information and metrics about every aspect of your PostgreSQL database server, collected using the open-source tool &lt;a href=&quot;https://pgmetrics.io&quot;&gt;pgmetrics&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://pgdash.io/blog/images/pgdash-repl-primary.png&quot;&gt;&lt;img src=&quot;https://pgdash.io/blog/images/pgdash-repl-primary.png&quot; alt=&quot;Monitoring with pgDash&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;pgDash is currently in Beta and provides core reporting and visualization functionality, including collecting and displaying PostgreSQL information and providing time-series graphs and detailed reports. We’re actively working to enhance and expand pgDash to include alerting, baselines, teams, and more.&lt;/p&gt;
</description>
<pubDate>Mon, 21 May 2018 16:51:40 +0000</pubDate>
<dc:creator>craigkerstiens</dc:creator>
<dc:language>en-US</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://pgdash.io/blog/partition-postgres-11.html</dc:identifier>
</item>
<item>
<title>$36k Google App Engine RCE</title>
<link>https://sites.google.com/site/testsitehacking/-36k-google-app-engine-rce</link>
<guid isPermaLink="true" >https://sites.google.com/site/testsitehacking/-36k-google-app-engine-rce</guid>
<description>&lt;p&gt;In early 2018 I got access to a non-production Google App Engine deployment environment, where I could use internal APIs and it was considered as Remote Code Execution due to the way Google works. Thanks to this I got a reward of $36,337 as part of Google Vulnerability Rewards Program.&lt;br/&gt;&lt;/p&gt;&lt;div readability=&quot;54.299964751498&quot;&gt;Some time ago, I noticed every &lt;a href=&quot;https://cloud.google.com/appengine/&quot;&gt;Google App Engine&lt;/a&gt; (GAE) application replied to every HTTP request with a &quot;&lt;code&gt;X-Cloud-Trace-Context&lt;/code&gt;&quot; header, so I assumed any website returning that header is probably running on GAE.&lt;br/&gt;Thanks to that, I learned &quot;&lt;a href=&quot;http://appengine.google.com&quot;&gt;appengine.google.com&lt;/a&gt;&quot; itself runs on GAE, but it can perform some actions that cannot be done anywhere else and common user applications cannot perform, so I tried to discover how was it able to do those actions.&lt;br/&gt;Obviously, it has to make use of some API, interface or something only available to applications ran by Google itself, but maybe there was a way to access them, and I looked for that.&lt;p&gt;First, I began learning how GAE apps perform internal actions (Such as writing logs or &lt;a href=&quot;https://cloud.google.com/appengine/docs/standard/java/appidentity#asserting_identity_to_google_apis&quot;&gt;getting an OAuth token&lt;/a&gt;), and I discovered that, in the Java 8 environment, it did so by sending &lt;a href=&quot;https://developers.google.com/protocol-buffers/&quot;&gt;Protocol Buffer&lt;/a&gt; (PB) messages (&lt;a href=&quot;https://developers.google.com/protocol-buffers/docs/encoding#structure&quot;&gt;In binary wire format&lt;/a&gt;) to an internal HTTP endpoint located in &lt;code&gt;http://169.254.169.253:10001/rpc_http&lt;/code&gt;.&lt;br/&gt;The HTTP request would look like this:&lt;br/&gt;&lt;/p&gt;&lt;div class=&quot;sites-codeblock sites-codesnippet-block&quot;&gt;&lt;code&gt;POST /rpc_http HTTP/1.1&lt;/code&gt;&lt;br/&gt;&lt;code&gt;Host: 169.254.169.253:10001&lt;/code&gt;&lt;br/&gt;&lt;code&gt;X-Google-RPC-Service-Endpoint: app-engine-apis&lt;/code&gt;&lt;br/&gt;&lt;code&gt;X-Google-RPC-Service-Method: /VMRemoteAPI.CallRemoteAPI&lt;/code&gt;&lt;br/&gt;&lt;code&gt;Content-Type: application/octet-stream&lt;/code&gt;&lt;br/&gt;&lt;code&gt;Content-Length: &amp;lt;LENGTH&amp;gt;&lt;/code&gt;&lt;p&gt;&lt;code&gt;&amp;lt;PROTO_MESSAGE&amp;gt;&lt;/code&gt;&lt;/p&gt;&lt;/div&gt;
&lt;br/&gt;And the PB message would be an &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/ext/remote_api/remote_api.proto#L11&quot; rel=&quot;nofollow&quot;&gt;apphosting.ext.remote_api.Request&lt;/a&gt;&quot; message with:&lt;br/&gt;&lt;code&gt;  service_name&lt;/code&gt; = Name of the API to call&lt;br/&gt;&lt;code&gt;  method&lt;/code&gt; = Name of the API's method to invoke&lt;br/&gt;&lt;code&gt;  request&lt;/code&gt; = Bytes of the inner PB request (Encoded in binary wire format)&lt;br/&gt;&lt;code&gt;  request_id&lt;/code&gt; = Security ticket (Given to the app with every GAE request), this is required even though it is marked as optional&lt;p&gt;The response from the HTTP request would be the corresponding PB message that represents the reply from the API, or an error message.&lt;/p&gt;&lt;p&gt;The security ticket can be obtained (In the Java 8 runtime) with these lines of code:&lt;br/&gt;&lt;/p&gt;&lt;div class=&quot;sites-codeblock sites-codesnippet-block&quot; readability=&quot;7&quot;&gt;&lt;code readability=&quot;4&quot;&gt;import com.google.apphosting.api.ApiProxy;&lt;br/&gt;import java.lang.reflect.Method;&lt;p&gt;Method getSecurityTicket = ApiProxy.getCurrentEnvironment().getClass().getDeclaredMethod(&quot;getSecurityTicket&quot;);&lt;br/&gt;getSecurityTicket.setAccessible(true);&lt;br/&gt;String security_ticket = (String) getSecurityTicket.invoke(ApiProxy.getCurrentEnvironment());&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;&lt;/div&gt;
&lt;br/&gt;An example of this process: If I want to get a Google OAuth token with the &quot;https://www.googleapis.com/auth/xapi.zoo&quot; scope (A test scope without real use), I would follow these steps:&lt;br/&gt;&lt;ol&gt;&lt;li&gt;Generate a &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/api/app_identity/app_identity_service.proto#L51&quot; rel=&quot;nofollow&quot;&gt;apphosting.GetAccessTokenRequest&lt;/a&gt;&quot; message with:&lt;br/&gt;&lt;code&gt;scope&lt;/code&gt; = &lt;code&gt;[&quot;https://www.googleapis.com/auth/xapi.zoo&quot;]&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Generate a &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/ext/remote_api/remote_api.proto#L11&quot; rel=&quot;nofollow&quot;&gt;apphosting.ext.remote_api.Request&lt;/a&gt;&quot; message with:&lt;br/&gt;&lt;code&gt;service_name&lt;/code&gt; = &lt;code&gt;&quot;app_identity_service&quot;&lt;/code&gt; (The API that provide access to the GAE Service Account)&lt;br/&gt;&lt;code&gt;method&lt;/code&gt; = &lt;code&gt;&quot;GetAccessTokenRequest&quot;&lt;/code&gt;&lt;br/&gt;&lt;code&gt;request&lt;/code&gt; = The bytes of the PB message generated in the previous step, encoded in binary wire format&lt;br/&gt;&lt;code&gt;request_id&lt;/code&gt; = Security ticket&lt;/li&gt;
&lt;li&gt;Send the HTTP request&lt;/li&gt;
&lt;li&gt;Decode the response, which should be a &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/api/app_identity/app_identity_service.proto#L57&quot; rel=&quot;nofollow&quot;&gt;apphosting.GetAccessTokenResponse&lt;/a&gt;&quot; message&lt;/li&gt;
&lt;/ol&gt;&lt;/div&gt;&lt;div readability=&quot;36.896629213483&quot;&gt;Since this endpoint has access to some internal stuff, I was sure this must be related to whatever &quot;&lt;a href=&quot;http://appengine.google.com&quot;&gt;appengine.google.com&lt;/a&gt;&quot; uses for performing internal actions, but I could not find anything in the HTTP endpoint.&lt;br/&gt;At first I guessed it might be using some other endpoint located in the same server (&lt;code&gt;169.254.169.253&lt;/code&gt;), so I uploaded a statically linked version of Nmap to GAE and ran it against the server (For running binaries in GAE I upload them with the app, then during runtime I copy them to &lt;code&gt;/tmp&lt;/code&gt; and give them execution permission, since the rest of the file-system is read-only). &lt;a href=&quot;http://save-the-expanse.appspot.com/nmap&quot;&gt;Here is a live example&lt;/a&gt;.&lt;br/&gt;I found that the port 4 was open, so I sent stuff to it. It replied with a weird mess of data, but it had some legible strings and after looking them up on-line I found it was a &lt;a href=&quot;https://grpc.io/about/&quot;&gt;gRPC service&lt;/a&gt;.&lt;p&gt;I tried to build a Java gRPC client that runs on GAE, but I was having troubles since the built-in gRPC library seemed to be incomplete and whenever I uploaded a complete one it still tried to use the built-in library.&lt;br/&gt;So I built a C++ client instead and ran it on GAE.&lt;/p&gt;&lt;p&gt;After some trial and error I discovered the gRPC service was just like the HTTP endpoint, running a &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/runtime.proto#L219&quot; rel=&quot;nofollow&quot;&gt;apphosting.APIHost&lt;/a&gt;&quot; API. There was a difference though, it had the option for JSON encoding of the PB messages instead of just binary, so it made testing much easier.&lt;/p&gt;&lt;/div&gt;&lt;div readability=&quot;157.75983973604&quot;&gt;&lt;br/&gt;Since I did not find anything else in the server, I assumed the actions &quot;&lt;a href=&quot;http://appengine.google.com&quot;&gt;appengine.google.com&lt;/a&gt;&quot; does internally either contact a different server, or use the RPC services (HTTP/gRPC) for invoking some hidden APIs/methods.&lt;br/&gt;I tried finding any other server with Nmap, but I only found the &lt;a href=&quot;https://cloud.google.com/compute/docs/storing-retrieving-metadata&quot;&gt;Metadata server&lt;/a&gt;, which was not useful, so I went with the idea that it must use hidden APIs, but, how to find them?&lt;p&gt;First, I collected every Protocol Buffer definition I could find (Extracting them from .CLASS files found in .JAR files, and from binaries found in the runtime) and searched in them anything that could point to some hidden API (If you are curious, all the PB definition files I extracted can be found &lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/tree/master/protos&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;).&lt;br/&gt;I found promising the &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/appmaster.proto&quot; rel=&quot;nofollow&quot;&gt;apphosting/base/appmaster.proto&lt;/a&gt;&quot; file, it had several PB messages that seemed like internal methods for modifying internal settings of App Engine, and an API called &quot;AppMaster&quot; with some methods defined in it, but after several trials I could not find the way to perform any call to those methods.&lt;/p&gt;&lt;p&gt;Since I did not find any of the hidden APIs/methods in the PB definitions, I had to look somewhere else.&lt;br/&gt;I tried looking in the binaries, they were huge and full of stuff that was either useless or I did not understand (Also, I was exploring them using a combination of &lt;code&gt;strings&lt;/code&gt; + &lt;code&gt;grep&lt;/code&gt;, I do not know much about reverse engineering), but after noticing the main binary, &quot;&lt;code&gt;java_runtime_launcher_ex&lt;/code&gt;&quot;, had a lot of command line parameters, I had the idea of looking at what parameters did it receive when running in the GAE environment.&lt;/p&gt;&lt;p&gt;Getting the parameters was quite difficult at first because I tried to connect every Java variable I could find to its corresponding parameter, it was impossible.&lt;br/&gt;Then I tried something smarter: Creating a Java library in C++ with a method that reads the arguments passed to the launcher and returned them.&lt;br/&gt;Doing so was easy to do, thanks to &lt;a href=&quot;https://stackoverflow.com/a/37358751&quot; rel=&quot;nofollow&quot;&gt;this Stack Overflow post&lt;/a&gt;, retrieving the information with these lines of code:&lt;br/&gt;&lt;/p&gt;&lt;div class=&quot;sites-codeblock sites-codesnippet-block&quot; readability=&quot;7&quot;&gt;&lt;code readability=&quot;4&quot;&gt;int argc = -1;&lt;br/&gt;char **argv = NULL;&lt;p&gt;static void getArgs(int _argc, char **_argv, char **_env) {&lt;br/&gt;  argc = _argc;&lt;br/&gt;  argv = _argv;&lt;br/&gt;}&lt;br/&gt;&lt;/p&gt;&lt;/code&gt;&lt;br/&gt;&lt;code&gt;__attribute__((section(&quot;.init_array&quot;))) static void *ctr = (void*) getArgs;&lt;/code&gt;&lt;/div&gt;
And then a simple method that converted the arguments to a Java array. &lt;a href=&quot;http://save-the-expanse.appspot.com/args&quot;&gt;Here is a live example&lt;/a&gt;.&lt;p&gt;After running the code, I got lots of arguments, among them was this one (I divided it into multiple lines for readability):&lt;/p&gt;
&lt;p&gt;&lt;code&gt;--api_call_deadline_map=&lt;br/&gt;  app_config_service:60.0,&lt;br/&gt;  blobstore:15.0,&lt;br/&gt;  datastore_v3:60.0,&lt;br/&gt;  datastore_v4:60.0,&lt;br/&gt;  file:30.0,&lt;br/&gt;  images:30.0,&lt;br/&gt;  logservice:60.0,&lt;br/&gt;  modules:60.0,&lt;br/&gt;  rdbms:60.0,&lt;br/&gt;  remote_socket:60.0,&lt;br/&gt;  search:10.0,&lt;br/&gt;  stubby:10.0&lt;/code&gt;&lt;/p&gt;
&lt;br/&gt;I quickly noticed the APIs I had already used, like &quot;&lt;code&gt;logservice&lt;/code&gt;&quot; (For writing logs), so I deduced that these were APIs available through the internal HTTP endpoint.&lt;br/&gt;I also noticed &quot;&lt;code&gt;stubby&lt;/code&gt;&quot;, which I had already seen mentioned before in error messages from some Google products (While bug-hunting) and I had read about it in the &lt;a href=&quot;https://landing.google.com/sre/book/chapters/production-environment.html&quot;&gt;SRE&lt;/a&gt;, so I knew it was a RPC infrastructure, and it might be a way for &quot;&lt;a href=&quot;http://appengine.google.com&quot;&gt;appengine.google.com&lt;/a&gt;&quot; to perform internal actions.&lt;p&gt;Great, now I know the name of an internal API, but, what methods does it have?&lt;br/&gt;I tried several method names with my C++ gRPC client, but all of them returned an error saying they do not exist, so instead I looked up in Google.&lt;br/&gt;I somehow found &lt;a href=&quot;https://groups.google.com/d/msg/techos/6koJkAuuVVk/6QJNbjRIy40J&quot;&gt;this 2010 post&lt;/a&gt; with an error message reading:&lt;br/&gt;&lt;code&gt;  The API call stubby.Send() took too long to respond and was cancelled.&lt;/code&gt;&lt;br/&gt;So, I tried the &quot;&lt;code&gt;Send&lt;/code&gt;&quot; method. It did not exist.&lt;/p&gt;&lt;p&gt;I was sure it must exist, so the error message was probably just hiding the fact that it does exists but I do not have access to it.&lt;br/&gt;I tried to verify it by finding any difference between a real &quot;not-exist&quot; error (&lt;a href=&quot;http://save-the-expanse.appspot.com/grpc?api=app_identity_service&amp;amp;method=SaveTheExpanse&quot;&gt;Example&lt;/a&gt;) and a fake one (&lt;a href=&quot;http://save-the-expanse.appspot.com/grpc?api=stubby&amp;amp;method=Send&quot;&gt;Example&lt;/a&gt;), and I found it: If in my gRPC client I made a request without setting the &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/runtime.proto#L176&quot; rel=&quot;nofollow&quot;&gt;apphosting.APIRequest.pb&lt;/a&gt;&quot; field (Which is marked optional but I always set it to at least an empty string or &quot;&lt;code&gt;{}&lt;/code&gt;&quot; in JSON), it would return a &quot;not-exist&quot; error for a non-existent method (&lt;a href=&quot;http://save-the-expanse.appspot.com/grpc?api=app_identity_service&amp;amp;method=SaveTheExpanse&amp;amp;setPb=0&quot;&gt;Example&lt;/a&gt;), and a &quot;incomplete request&quot; error to a real method (&lt;a href=&quot;http://save-the-expanse.appspot.com/grpc?api=stubby&amp;amp;method=Send&amp;amp;setPb=0&quot;&gt;Example&lt;/a&gt;)  (Even if it supposedly did not exist). Therefore, &quot;&lt;code&gt;stubby.Send&lt;/code&gt;&quot; does in fact exist.&lt;/p&gt;&lt;p&gt;Now, how to access it?&lt;br/&gt;I could not come up with a way for accessing it in the production GAE &lt;a href=&quot;https://en.wikipedia.org/wiki/Deployment_environment&quot; rel=&quot;nofollow&quot;&gt;deployment environment&lt;/a&gt;, but then I remembered I had gotten access to the staging (&lt;a href=&quot;http://staging-appengine.sandbox.googleapis.com&quot;&gt;staging-appengine.sandbox.googleapis.com&lt;/a&gt;) and the test (&lt;a href=&quot;http://test-appengine.sandbox.googleapis.com&quot;&gt;test-appengine.sandbox.googleapis.com&lt;/a&gt;) GAE deployment environments thanks to &lt;a href=&quot;https://sites.google.com/site/testsitehacking/-5k-service-dependencies&quot;&gt;this bug&lt;/a&gt; (Normally, common Google users should not have access to non-production deployment environments).&lt;br/&gt;Thanks to some little research in those deployment environments, I knew how to perform a call to an app that runs in them:&lt;br/&gt;&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Upload a version with &lt;a href=&quot;https://cloud.google.com/appengine/docs/standard/python/how-instances-are-managed#instance_scaling&quot;&gt;manual scaling&lt;/a&gt; (It did not work otherwise, for some weird reason, returning &lt;code&gt;403 Forbidden&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;Perform a request to &quot;&lt;a href=&quot;http://www.appspot.com&quot;&gt;www.appspot.com&lt;/a&gt;&quot; but change the &lt;code&gt;Host&lt;/code&gt; header to &quot;&lt;code&gt;&amp;lt;PROJECT-NAME&amp;gt;.prom-&amp;lt;qa/nightly&amp;gt;.sandbox.google.com&lt;/code&gt;&quot;&lt;br/&gt;If your app would normally run on &quot;&lt;a href=&quot;http://save-the-expanse.appspot.com/&quot;&gt;save-the-expanse.appspot.com&lt;/a&gt;&quot;, you should replace &quot;&lt;code&gt;&amp;lt;PROJECT-NAME&amp;gt;&lt;/code&gt;&quot; with &quot;&lt;code&gt;save-the-expanse&lt;/code&gt;&quot;, and if you uploaded your app to the staging GAE environment, you should replace &quot;&lt;code&gt;&amp;lt;qa/nightly&amp;gt;&lt;/code&gt;&quot; with just &quot;&lt;code&gt;qa&lt;/code&gt;&quot;, if you uploaded it to the test GAE environment instead, you should replace it with &quot;&lt;code&gt;nightly&lt;/code&gt;&quot;.&lt;br/&gt;For example: I tested on &quot;&lt;code&gt;the-expanse.prom-nightly.sandbox.google.com&lt;/code&gt;&quot; (Without the &quot;save&quot;, since &lt;a href=&quot;https://www.imdb.com/title/tt3230854/&quot; rel=&quot;nofollow&quot;&gt;The Expanse&lt;/a&gt; had not been &lt;a href=&quot;http://www.newsweek.com/expanse-save-amazon-syfy-season-4-renew-fans-934620&quot; rel=&quot;nofollow&quot;&gt;canceled&lt;/a&gt; back then).&lt;/li&gt;
&lt;/ol&gt;&lt;p&gt;&lt;span&gt;&lt;strong&gt;&lt;u&gt;The bug&lt;/u&gt;&lt;/strong&gt;&lt;/span&gt;&lt;br/&gt;&lt;/p&gt;

Once I uploaded my application with the gRPC client, I quickly discovered that, in the non-production (staging/test) GAE environments, I had access to &quot;&lt;code&gt;stubby.Send&lt;/code&gt;&quot;!&lt;br/&gt;After some quick testing (Mostly reading error messages and guessing how to fix them), I found how to perform a simple Stubby call:&lt;br/&gt;&lt;ol readability=&quot;-0.9384236453202&quot;&gt;&lt;li&gt;Call &quot;&lt;code&gt;stubby.GetStubId&lt;/code&gt;&quot; with the following JSON PB message:&lt;p&gt;&lt;code&gt;{&lt;/code&gt;&lt;br/&gt;&lt;code&gt;  &quot;host&quot;: &quot;&amp;lt;HOST&amp;gt;&quot;&lt;/code&gt;&lt;br/&gt;&lt;code&gt;}&lt;/code&gt;&lt;/p&gt;
With &lt;code&gt;&amp;lt;HOST&amp;gt;&lt;/code&gt; set to where the method you want to call is hosted (For instance, &quot;&lt;code&gt;google.com:80&lt;/code&gt;&quot;, &quot;&lt;code&gt;pantheon.corp.google.com:80&lt;/code&gt;&quot;, &quot;&lt;code&gt;blade:monarch-cloud_prod-streamz&lt;/code&gt;&quot;).&lt;br/&gt;&quot;&lt;code&gt;blade:&amp;lt;SERVICE&amp;gt;&lt;/code&gt;&quot; seems to be like an internal DNS system Google uses, for instance, &quot;&lt;code&gt;blade:cloudresourcemanager-project&lt;/code&gt;&quot; internally is &quot;&lt;a href=&quot;http://cloudresourcemanager.googleapis.com/&quot;&gt;cloudresourcemanager.googleapis.com&lt;/a&gt;&quot; externally (Some, like &quot;&lt;code&gt;blade:monarch-cloud_prod-streamz&lt;/code&gt;&quot;, do not have an external counterpart).&lt;/li&gt;
&lt;li&gt;The previous request will return a JSON PB message with &quot;stub_id&quot; as its only field, store its value&lt;/li&gt;
&lt;li readability=&quot;0.90909090909091&quot;&gt;Call &quot;&lt;code&gt;stubby.Send&lt;/code&gt;&quot; with the following JSON PB message:&lt;p&gt;&lt;code&gt;{&lt;/code&gt;&lt;br/&gt;&lt;code&gt;  &quot;stubby_method&quot;: &quot;/&amp;lt;SERVICE&amp;gt;.&amp;lt;METHOD&amp;gt;&quot;,&lt;/code&gt;&lt;br/&gt;&lt;code&gt;  &quot;stubby_request&quot;: &quot;&amp;lt;PB&amp;gt;&quot;,&lt;/code&gt;&lt;br/&gt;&lt;code&gt;  &quot;stub_id&quot;: &quot;&amp;lt;STUB_ID&amp;gt;&quot;&lt;/code&gt;&lt;br/&gt;&lt;code&gt;}&lt;/code&gt;&lt;/p&gt;
For finding what values can &quot;stubby_method&quot; be, you can set it to &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/net/rpc/serverstatus.proto#L155&quot; rel=&quot;nofollow&quot;&gt;/ServerStatus.GetServices&lt;/a&gt;&quot; with an empty &quot;&lt;code&gt;stubby_request&lt;/code&gt;&quot; and it will return a nice &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/net/rpc/serverstatus.proto#L13&quot; rel=&quot;nofollow&quot;&gt;rpc.ServiceList&lt;/a&gt;&quot; listing all the services (And their methods) the target supports.&lt;br/&gt;&lt;code&gt;&amp;lt;PB&amp;gt;&lt;/code&gt; are the PB message bytes (In binary wire format).&lt;/li&gt;
&lt;li&gt;If successful, the call will return a JSON PB message with &quot;&lt;code&gt;stubby_response&lt;/code&gt;&quot; as its only field, it'll have the response PB message bytes (In binary wire format).&lt;/li&gt;
&lt;/ol&gt;
After discovering this, I did some testing, but I was not able to find any Stubby call that I considered dangerous.&lt;br/&gt;Nevertheless, I reported this to Google and it got a P1 priority.&lt;p&gt;After the initial report, I looked over everything I've done again, trying to find some variation that could be successfully used for an attack, and I noticed that, besides &quot;&lt;code&gt;stubby&lt;/code&gt;&quot;, there was &quot;&lt;code&gt;app_config_service&lt;/code&gt;&quot; in the arguments I got from the Java launcher binary, it was another hidden API.&lt;br/&gt;Looking in the PB definitions I had gotten before, I couldn't find its methods directly, nor on Google Search, but I later found them mentioned in &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/quotas.proto&quot; rel=&quot;nofollow&quot;&gt;apphosting/base/quotas.proto&lt;/a&gt;&quot;.&lt;br/&gt;For example, it says &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/quotas.proto#L417&quot; rel=&quot;nofollow&quot;&gt;APP_CONFIG_SERVICE_GET_APP_CONFIG&lt;/a&gt;&quot;, and a little testing revealed &quot;&lt;code&gt;app_config_service.GetAppConfig&lt;/code&gt;&quot; is a real hidden method.&lt;/p&gt;&lt;p&gt;The &quot;&lt;code&gt;app_config_service&lt;/code&gt;&quot; has several interesting methods, but the most interesting methods for me were the &quot;&lt;code&gt;app_config_service.ConfigApp&lt;/code&gt;&quot; and the &quot;&lt;code&gt;app_config_service.SetAdminConfig&lt;/code&gt;&quot; methods, because they allowed me to set internal settings such as the allowed email senders, the app's Service Account ID, ignore quota restrictions, and set my app as a &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/appmaster.proto#L106&quot; rel=&quot;nofollow&quot;&gt;SuperApp&lt;/a&gt;&quot; (I don't know what that means, but sounds super) and give it &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/appmaster.proto#L204&quot; rel=&quot;nofollow&quot;&gt;FILE_GOOGLE3_ACCESS&lt;/a&gt;&quot; (I think Google3 is a part of &lt;a href=&quot;https://cacm.acm.org/magazines/2016/7/204032-why-google-stores-billions-of-lines-of-code-in-a-single-repository/fulltext&quot; rel=&quot;nofollow&quot;&gt;Piper&lt;/a&gt;, with files related to Google's APIs and services).&lt;br/&gt;The &quot;&lt;code&gt;app_config_service.SetAdminConfig&lt;/code&gt;&quot; method has &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/appmaster.proto#L657&quot; rel=&quot;nofollow&quot;&gt;apphosting.SetAdminConfigRequest&lt;/a&gt;&quot; as its request message, and &quot;&lt;code&gt;app_config_service.ConfigApp&lt;/code&gt;&quot; has &quot;&lt;a href=&quot;https://github.com/ezequielpereira/GAE-RCE/blob/c58ccd52d9204a0e5b8c7cf9b82b8e6e06d524a8/protos/apphosting/base/appmaster.proto#L85&quot; rel=&quot;nofollow&quot;&gt;apphosting.GlobalConfig&lt;/a&gt;&quot; as its request message.&lt;br/&gt;&lt;/p&gt;&lt;/div&gt;&lt;p&gt;&lt;br/&gt;After discovering this, I reported the new findings to Google and they bumped the priority of the internal ticket and said:&lt;br/&gt;   &lt;em&gt;&lt;code&gt;Please stop exploring this further, as it seems that you could easily break something using these internal APIs&lt;/code&gt;&lt;/em&gt;&lt;code&gt;.&lt;/code&gt;&lt;br/&gt;&lt;/p&gt;</description>
<pubDate>Mon, 21 May 2018 13:49:18 +0000</pubDate>
<dc:creator>Artemis2</dc:creator>
<og:title>$36k Google App Engine RCE - Ezequiel Pereira</og:title>
<og:description>Testing</og:description>
<og:image>https://sites.google.com/site/testsitehacking/_/rsrc/1526777524464/-36k-google-app-engine-rce/MSG_CCs.png</og:image>
<dc:format>text/html</dc:format>
<dc:identifier>https://sites.google.com/site/testsitehacking/-36k-google-app-engine-rce</dc:identifier>
</item>
<item>
<title>Predatory Behavior Runs Rampant in Facebook’s Addiction Support Groups</title>
<link>https://www.theverge.com/2018/5/21/17370066/facebook-addiction-support-groups-rehab-patient-brokering</link>
<guid isPermaLink="true" >https://www.theverge.com/2018/5/21/17370066/facebook-addiction-support-groups-rehab-patient-brokering</guid>
<description>&lt;p class=&quot;p-dropcap has-dropcap p-large-text&quot; id=&quot;QkoEOD&quot;&gt;When Laurie Couch first joined the Affected by Addiction Support Group, a closed Facebook group with 70,000 members, she felt a sense of belonging. Here were people who understood her struggle to care for a son addicted to drugs, and they were there to support her, any time of the day or night. She began regularly responding to people who were dealing with cravings and comforting parents devastated by their children’s addictions.&lt;/p&gt;
&lt;p id=&quot;y5fUxe&quot;&gt;Private addiction support groups are abundant on Facebook, and Affected by Addiction is one of the most high-profile. Last June, the group’s owner Matt Mendoza spoke at the &lt;a href=&quot;https://newsroom.fb.com/news/2017/06/our-first-communities-summit-and-new-tools-for-group-admins/&quot;&gt;Facebook Communities Summit&lt;/a&gt;, where Mark Zuckerberg unveiled his plan to get a total of 1 billion people into “meaningful groups.” In July, Zuckerberg posted a glowing review of the support group on his Facebook page. The group was &lt;a href=&quot;http://abcnews.go.com/GMA/Living/addicts-loved-find-strength-online-community/story?id=52917061&quot;&gt;profiled by &lt;em&gt;Good Morning America&lt;/em&gt;&lt;/a&gt; in February, sparking a flood of new members. In the segment, Mendoza told the hosts that “there have been hundreds, if not thousands, of people that have gotten treatment as a result of this community.” He didn’t expand on the process.&lt;/p&gt;
&lt;p id=&quot;KRq2SP&quot;&gt;In March, Couch’s son almost overdosed. They live together in rural Kansas, where she doesn’t have access to much in-person support, which is part of what made Affected by Addiction attractive to begin with. In the wake of his near-overdose, she reached out to the group for comfort and encouragement while she panicked and figured out what to do.&lt;/p&gt;
&lt;p id=&quot;69X9eq&quot;&gt;Shortly after that, a stranger named Garrett Hall sent Couch a Facebook message.&lt;/p&gt;
&lt;p id=&quot;ocTylv&quot;&gt;“Hey Lauri [sic], I saw your name on the Affected By Addiction support group, and I had this weird/strong impulse to just reach out,” Hall wrote to Couch. “[A]re you doing ok?”&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;lvFgpJ&quot;&gt;&lt;q&gt;“Are you doing ok?”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;MMakzq&quot;&gt;Though there’s no indication of it on his Facebook page, and he never mentioned it to Couch, Hall had a professional connection to Affected by Addiction. Between 2015 and 2016, he’d worked for Mendoza’s blog company, Addiction Unscripted, which owns Affected by Addiction.&lt;/p&gt;
&lt;p id=&quot;4EgNi5&quot;&gt;Hall never disclosed to Couch that he had professional ties to Affected by Addiction. He simply offered to put her in touch with “someone who I have come to love over the last 12 months.”&lt;/p&gt;
&lt;p id=&quot;3Xi0ol&quot;&gt;“She is the woman who helped me get sober and my life back on track and she has helped so many people and families,” he continued. “I honestly believe she is a miracle worker. She is my hero.”&lt;/p&gt;
&lt;p id=&quot;EAthCN&quot;&gt;Couch soon got a call from Meghan Calvert, a paid marketer for a treatment center called Pillars Recovery. It’s owned by Darren Orloff, who is part of Affected by Addiction’s volunteer leadership team. Couch, who has a background in sales, knew a sales pitch when she heard it. She told Calvert off for taking advantage of desperate people.&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;6M4Fpt&quot;&gt;&lt;q&gt;She warned her son to be careful about support groups&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;5jSdCh&quot;&gt;“I reached out to Laurie to see how I could help,” Calvert responded when I reached out to her. “I have a large list of free resources and offer assistance to anyone looking for options free or private...Garrett has never asked me for anything in return.”&lt;/p&gt;
&lt;p id=&quot;XFoLOk&quot;&gt;After the call, Couch was surprised to find that she could not log back in to Affected by Addiction. In fact, she came to realize, she’d been banned. The experience left her feeling paranoid, like she couldn’t trust anyone. She warned her son to be careful about support groups.&lt;/p&gt;
&lt;hr class=&quot;p-entry-hr&quot; id=&quot;YKblTj&quot;/&gt;&lt;p class=&quot;p-dropcap has-dropcap&quot; id=&quot;VAA0JH&quot;&gt;The combination of the opioid crisis and Obamacare, which made it easy to get insurance that covered addiction treatment, has driven a boom in the rehab market. Centers that manage to attract clients with the right insurance policies stand to earn massive profits, and some spend millions of dollars on marketing to do so, often wooing addicts from around the country to rehab hubs in Florida and Southern California.&lt;/p&gt;
&lt;p id=&quot;uVZmbG&quot;&gt;It’s not uncommon for rehabs to use deceptive advertising or offer inducements like plane tickets to people with lucrative policies. Marketers often contract with treatment centers that pay them to bring in clients, whether per head or through a monthly contract. Individual patients are so valuable that the system has spawned a “patient brokering” market, where centers — sometimes illegally — buy and sell the right to treat an individual person.&lt;/p&gt;
&lt;p id=&quot;aIaXM2&quot;&gt;It’s hard to put together a consistent set of ethical norms in treatment center marketing. Every one of the dozens of treatment center owners and operators I spoke to in the course of this reporting was swift to condemn patient brokering, but they also complained that it’s hard for them to stay open without buying clients like everyone else does. Some people say it’s okay to pay marketers monthly contracts but not bonuses; others say it’s okay to pay performance bonuses as long as they’re not strictly tied to the number of patients. But there are two general rules that come up every time: 1) don’t be deceptive about who you are, and 2) don’t blatantly pay per-head for patients.&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;rFB5kE&quot;&gt;&lt;q&gt;The system has spawned a “patient brokering” market&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;eJJ3Rb&quot;&gt;“Outside of pay per head, it becomes a real grey, ambiguous area that people are walking in,” said David Skonezny, a consultant in the industry and the founder of It’s Time for Ethics in Addiction Treatment, a Facebook group where industry professionals discuss both general principles and specific treatment centers. He says people may be engaging in brokering while thinking they’re doing the right thing: helping people get sober and getting paid to boot. But he urges addicts to be extremely wary, especially online.&lt;/p&gt;
&lt;p id=&quot;iCLLQ1&quot;&gt;A few months ago, Skonezny posted a warning in his group, encouraging members to spread it around Facebook: “CAUTION: Often times people in social media groups are solicited or respond to posts that on the surface appear to be an offer of help when these posters actually represent unscrupulous centers and are getting compensated...for referring you or your loved one to a treatment center or sober living.”&lt;/p&gt;
&lt;p id=&quot;Q9TeWs&quot;&gt;Rehab marketers have embraced the internet, where tech companies have made it easier and easier for them to pick the most desperate targets out of a crowd. Last year, after I reported on &lt;a href=&quot;https://www.theverge.com/2017/9/7/16257412/rehabs-near-me-google-search-scam-florida-treatment-centers&quot;&gt;misleading rehab ads on Google&lt;/a&gt;, the company temporarily banned ads from treatment centers. Google has announced it will allow them again, provided the centers and their operators &lt;a href=&quot;https://www.reuters.com/article/us-alphabet-google-ads-exclusive/exclusive-google-unveils-vetting-process-for-drug-rehab-ads-idUSKBN1HN28X&quot;&gt;pass a background check&lt;/a&gt; and license verification. Few stakeholders I’ve talked to have faith in that solution.&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;NL0Pke&quot;&gt;&lt;q&gt;“CAUTION: Often times people in social media groups are solicited or respond to posts that on the surface appear to be an offer of help.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;rZCDJt&quot;&gt;On Facebook, rehab marketers are even harder to pin down. Some publicly announce themselves as representatives of a given center and offer their assistance to people who are struggling. Others run community support groups without disclosing their financial interests, creating a pool of help-seeking people to fish for leads or hang out in groups that already exist, waiting for prospects.&lt;/p&gt;
&lt;p id=&quot;IE3Urw&quot;&gt;Brandon Bergman, research scientist and associate director of the Recovery Research Institute at Massachusetts General Hospital, studies addiction and recovery in young adults, and he is particularly interested in the role &lt;a href=&quot;http://psycnet.apa.org/buy/2017-06960-001&quot;&gt;online communities&lt;/a&gt; might play in outcomes. He cautioned that there’s no empirical evidence that online communities have benefits for people in recovery, but he says it’s reasonable to assume they have some of the same benefits as in-person support groups — and some of the same risks.&lt;/p&gt;
&lt;p id=&quot;YeWrN5&quot;&gt;“There’s a very long history of people going to [12-step] meetings and being taken advantage of by drug dealers, for example,” he told me. Early recovery is a very vulnerable time, and people are desperate for help. It’s easy to use that for profit, including by convincing somebody to go to a specific treatment center. “It doesn’t surprise me this is going on online because there’s nothing special about the online space.”&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;NCRrbG&quot;&gt;&lt;q&gt;On Facebook, rehab marketers are even harder to pin down&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;pYd52W&quot;&gt;In November, &lt;a href=&quot;https://www.theverge.com/2017/11/3/16601668/rehab-center-review-sites-top-rated-bias-rehabreviews-thefix&quot;&gt;I wrote about Affected by Addiction&lt;/a&gt;, the Facebook group where Couch was pitched by a marketer, and its ties to rehab marketing companies. At the time, Mendoza, the group’s founder, was working as a marketer at a California treatment center called Windward Way, and Affected by Addiction was part of the rehab’s marketing arm, though that wasn’t disclosed in the group.&lt;/p&gt;
&lt;p id=&quot;iurEMB&quot;&gt;When I reached out to Facebook for that story, a spokesperson sent a bizarre response, saying they knew about the undisclosed conflict of interest, but they thought it was a good thing.&lt;/p&gt;
&lt;p id=&quot;1Mp9Jc&quot;&gt;“We know that managing communities like Affected By Addiction Support Group can require a huge time commitment...We believe in sustainable business models to create positive impact in the world,” the Facebook spokesperson wrote, linking to other community groups, such as a rock collection fan page run by a store selling rocks.&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;WF3MjC&quot;&gt;&lt;q&gt;Zuckerberg has called out Affected by Addiction on his own page&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;T5aJeb&quot;&gt;Selling rehab isn’t exactly like hawking rocks and mugs. The consumers are desperate for help in their darkest hour. Laurie Couch, for instance, described herself as isolated and panicking when Garrett Hall approached her. “I wanted to hear a miracle at that point,” she said.&lt;/p&gt;
&lt;p id=&quot;i1NdFh&quot;&gt;Hall didn’t return requests for comment.&lt;/p&gt;
&lt;p id=&quot;ITIT5E&quot;&gt;Facebook continues to be a big fan of Affected by Addiction. Mendoza has been part of its &lt;a href=&quot;https://communities.fb.com/&quot;&gt;community leadership program&lt;/a&gt;, Zuckerberg has called out Affected by Addiction on his own page, and multiple Facebook employees posted the &lt;em&gt;Good Morning America&lt;/em&gt; story on their walls, including Deepti Doshi, director of community partnerships.&lt;/p&gt;
&lt;p id=&quot;IuaFyj&quot;&gt;“Few people I have met in the last few months have inspired me as much as Matt Mendoza,” Doshi wrote. “I am so excited that leadership and courage are featured here.”&lt;/p&gt;
&lt;div class=&quot;p-fullbleed-block&quot;&gt;&lt;span class=&quot;e-image__inner&quot;&gt;&lt;span class=&quot;e-image__image&quot; data-original=&quot;https://cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg&quot;&gt; &lt;img srcset=&quot;https://cdn.vox-cdn.com/thumbor/kk7n_-WNrO1rbGBv9zD7OWXraV4=/0x0:3000x2000/320x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 320w, https://cdn.vox-cdn.com/thumbor/MvmGG12NlERLfsGhohEgqROz5iM=/0x0:3000x2000/520x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 520w, https://cdn.vox-cdn.com/thumbor/0ojZCcFLJFtX5JYw-oMqqzD6iuw=/0x0:3000x2000/720x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 720w, https://cdn.vox-cdn.com/thumbor/LeqAM1Iq2yh5IAHxS3d6irIGPEg=/0x0:3000x2000/920x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 920w, https://cdn.vox-cdn.com/thumbor/4wfAwMTb653RsKHbYMIgAzsGGWE=/0x0:3000x2000/1120x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 1120w, https://cdn.vox-cdn.com/thumbor/GC9T9zVikRfd8B-s3ypfnUW_ksY=/0x0:3000x2000/1320x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 1320w, https://cdn.vox-cdn.com/thumbor/FCEtLNhl166croPvmdCv2EV57Ik=/0x0:3000x2000/1520x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 1520w, https://cdn.vox-cdn.com/thumbor/Wz0Q3_Re06SwnluT4lzD4anD3jU=/0x0:3000x2000/1720x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 1720w, https://cdn.vox-cdn.com/thumbor/rqhjbaf1nWGVSj3tB-1VUd64Ru4=/0x0:3000x2000/1920x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg 1920w&quot; sizes=&quot;100vw&quot; src=&quot;https://cdn.vox-cdn.com/thumbor/bck5XnFpSOu4PaG0jhN0tZ0j8FE=/0x0:3000x2000/1200x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881045/vergefacebookspot1final.jpg&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;
&lt;p class=&quot;p-dropcap has-dropcap&quot; id=&quot;fOVDIb&quot;&gt;The connection between Windward Way and Affected by Addiction wouldn’t have been obvious to people in the group, but the ties weren’t particularly hidden, either. Mendoza operated Addiction Unscripted, the company that runs the Facebook group, out of Windward’s office. There was an 800 number at the top of the Facebook group that appeared to be a general helpline, but it rang directly to the rehab’s admissions department. The first time Mendoza went to Facebook HQ, he brought his boss, Windward’s owner.&lt;/p&gt;
&lt;p id=&quot;aRHB69&quot;&gt;Marketers from the treatment center had to approve every post in the group, which gave them the first opportunity to privately message good candidates for their rehab and try to talk them into going to Windward in California. They needed that edge, Mendoza explained to me a few weeks ago, because they knew a Facebook group that big would be full of other marketers, waiting to swoop in as soon as a juicy message was public.&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;HNJ7K9&quot;&gt;&lt;q&gt;A Facebook group that big would be full of other marketers&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;WR5VCo&quot;&gt;Initially, after my article ran in November, Mendoza put up a disclaimer about the relationship with Windward Way. Then they broke ties entirely. At the end of March this year, Affected by Addiction added a set of rules, including:&lt;/p&gt;
&lt;blockquote readability=&quot;13&quot;&gt;
&lt;p id=&quot;T9QZV5&quot;&gt;“One of the common marketing scams used by unethical treatment centers is to PM people within support groups like these in an attempt to get a client to their treatment center, without any care for clinical assessment, for that reason . . .No recommendations of treatment centers, treatment programs, or other treatment options are allowed either publicly or privately between group members. If you are contacted privately by someone offering a place of treatment, you are required to immediately contact at least two moderators or admins.”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p id=&quot;JS00KQ&quot;&gt;“I’ve explained the entire scam to people, that people will go out there, and they’ll do what I did,” Mendoza told me when I asked him if marketers were still using the group to find patients. “Obviously, I’ve made mistakes. You wrote about my mistakes. I own up to those mistakes.”&lt;/p&gt;
&lt;p id=&quot;qh1aon&quot;&gt;He said he’s removed himself from the treatment marketing industry entirely, and he didn’t make any money off of Affected by Addiction or Addiction Unscripted in 2017. He said repeatedly that he has no idea how to vet treatment centers anymore, which is why he doesn’t want to be part of the rehab industry. Instead, he wants to be part of the recovery community.&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;3V9W5Y&quot;&gt;&lt;q&gt;“I’ve explained the entire scam to people.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;QFnXNU&quot;&gt;He told me that three things pushed him to change how Affected by Addiction runs. First, my article made him realize disclosure was important. Second, he had conversations with industry leaders that changed his understanding the moral ramifications. But by far the most significant catalyst came at the end of December: his father, who’d been struggling with addiction, was once again ready to get help, a decision Mendoza supported. In one of the last texts his father ever sent Mendoza, he told his son that the treatment center he had ended up at cared more about money than patient care. Shortly before the new year, his father committed suicide.&lt;/p&gt;
&lt;p id=&quot;YfUUUe&quot;&gt;“All of these things led up to it, but it was my dad that was a huge turning point,” he told me. “I think the treatment industry is so tainted that I don’t want to be recognized as a part of the treatment industry.”&lt;/p&gt;
&lt;p id=&quot;ULCijR&quot;&gt;Earlier this month, Mendoza announced he’s backing away from his leadership role in the group. In a recent Facebook Live post, Mendoza said he needs to take time for himself, and he has turned power over to a team of volunteers that includes legacy moderators, people Mendoza found by posting a survey in the group, and the partner he hooked up with after leaving Windward Way: treatment center owner Darren Orloff.&lt;/p&gt;
&lt;p id=&quot;kUajfV&quot;&gt;Orloff owns Pillars Recovery, where Meghan Calvert, who approached Laurie Couch, works as a marketer.&lt;/p&gt;
&lt;p id=&quot;GkcA3j&quot;&gt;Mendoza denied knowing Hall had been messaging people in the group. Calvert admitted to calling Couch, but she said there had been no money involved when she got her number. Orloff denied using the group to recruit patients for Pillars.&lt;/p&gt;
&lt;div class=&quot;c-float-left c-float-hang&quot;&gt;
&lt;aside id=&quot;dRoCEt&quot;&gt;&lt;q&gt;“I don’t want to be recognized as a part of the treatment industry.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;j6Znei&quot;&gt;“I know Darren very well, and I know Darren would have no intention of setting us off-course. He’s been instrumental in what we’ve been doing as a leadership group,” Mendoza said.&lt;/p&gt;
&lt;p id=&quot;7zug6a&quot;&gt;On its face, the relationship between Mendoza and Orloff seems similar to the one he had with Windward Way. As he did with Windward Way’s owner, Mendoza took Orloff to Facebook HQ when he was invited in March, shortly after Couch spoke to Calvert and Hall. Mendoza made Orloff an administrator on Affected by Addiction and posted an Instagram video referring to Orloff as his “nonprofit partner.” The two share an office together on the Newport Beach waterfront.&lt;/p&gt;
&lt;p id=&quot;GgvqC4&quot;&gt;Mendoza and Orloff maintain that the relationship is very different, and Orloff is volunteering his time without financial gain. When I first told Mendoza about what happened to Couch, he seemed horrified. “I don’t know anything about this. This is new news to me, and this would go against any of our rules, stated values,” he said. “I have absolutely no interest in trying to monetize this anymore, so &lt;em&gt;I’d&lt;/em&gt; like to get to the bottom of that.”&lt;/p&gt;
&lt;p id=&quot;MmGS0a&quot;&gt;After I began asking questions about Couch, I was invited into the secret Facebook leadership group where the two dozen volunteers discuss how to run the 70,000-person community.&lt;/p&gt;
&lt;p id=&quot;BjKOUI&quot;&gt;Because Facebook relies on users to flag bad behavior, rather than actively policing groups like Affected by Addiction, it’s up to group owners to assemble their own moderation teams and train them to recognize and solve problems. In big groups, those moderators have a huge workload and enormous responsibility, dealing with everything from suicidal members to predatory marketers. It’s a lot to ask of any volunteers, especially ones who don’t have any training or experience in handling these life-or-death questions.&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;KJKM7L&quot;&gt;&lt;q&gt;Everything from suicidal members to predatory marketers&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;UC28hT&quot;&gt;That’s not acceptable, according to Jesse Heffernan, a consultant who helps advocacy groups develop programs and services, branding, and outreach efforts. The Affected by Addiction moderator group invited him as an adviser while developing their rules and leadership structure. He’s no longer actively involved with the group.&lt;/p&gt;
&lt;p id=&quot;2CYDdm&quot;&gt;“People are seeking help on these digital platforms, which makes them so vulnerable and so easy to get at if you have ill-intended purposes,” he told me. “If you’re [going to] claim to be a 70,000-person support group, you need to have more than just 20 volunteer moderators... That’s a full-time job that someone with some paraprofessional experience needs to be navigating.”&lt;/p&gt;
&lt;p id=&quot;0NPYyh&quot;&gt;Since Mendoza is stepping back, Orloff is one of the few recovery professionals in a leadership team tasked with keeping patient brokers out of the group. Orloff admits to working with patient brokers in the past, although he says he no longer does so.&lt;/p&gt;
&lt;div class=&quot;c-float-left c-float-hang&quot;&gt;
&lt;aside id=&quot;Phu3LC&quot;&gt;&lt;q&gt;“People are seeking help on these digital platforms.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;u27okI&quot;&gt;Until late 2017, according to Orloff, Pillars often paid third-party marketers to fill its beds, including a company called Sober Services, which is owned by marketer Shane Earn. Earn originally introduced Mendoza and Orloff. According to Mendoza, Sober Services also referred patients to Windward Way, Mendoza’s initial partner in Affected by Addiction.&lt;/p&gt;
&lt;p id=&quot;SbZNVB&quot;&gt;Earn has stated in public records that, during the time Orloff was getting patients from him, Earn’s business practices included trading clients for per-head fees and getting kickbacks from insurance claims. Last fall, he filed a lawsuit claiming he’d been stiffed by the owner of a different rehab, who owed him $7,000 for every patient Earn had brought in, plus a cut of the money a drug-testing lab was paying the treatment center for referrals. In total, according to the claim, Earn was owed over $700,000 in fees and kickbacks for around a year and a half of referrals to that one rehab and its related businesses.&lt;/p&gt;
&lt;p id=&quot;g45Jte&quot;&gt;“Two years ago, people didn’t look at client brokering in a bad light,” Orloff told me when I asked about his dealings with Sober Services. “I look at it in a bad light now, but at the time, everybody thought it was okay and that there was nothing wrong with it.” Earn’s claim was filed in September 2017. Orloff told me he stopped getting patients from Sober Services in “late 2017,” but said he couldn’t pinpoint an exact date.&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;Zo9FTE&quot;&gt;&lt;q&gt;According to the claim, Earn was owed over $700,000 in fees and kickbacks&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;1ZjQQV&quot;&gt;The connections between Sober Services and Pillars went beyond patient referrals during 2016 and 2017. Orloff ran Pillars out of Earn’s office in Irvine, California, between August and December 2017, at which point he says they parted ways. In the mid-2016, Orloff and Earn registered a corporation called Sober Services LLC, which Orloff maintains never did business but was intended to capitalize on the marketing company’s good reputation while providing other treatment-related services.&lt;/p&gt;
&lt;p id=&quot;BGsi6M&quot;&gt;During much of 2017, Sober Services’ phone number was listed on the Pillars website. In October 2017, the Sober Services Facebook page posted, “Sober Services presents Pillars Recovery: Powerful and affordable addiction treatment,” with a link to the site and an 800 number for Sober Services.&lt;/p&gt;
&lt;p id=&quot;o3k5oj&quot;&gt;This period of overlap came to an end, Orloff claims, when he discovered Earn was siphoning off potential Pillars clients to send to other rehabs using the Pillars website. Once Orloff realized what was going on, he severed ties with Earn, and moved into his own office.&lt;/p&gt;
&lt;p id=&quot;xNBYnJ&quot;&gt;&lt;em&gt;The Verge&lt;/em&gt; tried to reach Earn for comment on multiple occasions, but he never responded.&lt;/p&gt;
&lt;p id=&quot;JzAvqH&quot;&gt;Meghan Calvert, the marketer who called Laurie Couch, had been working for both Sober Services and Pillars in 2016 and 2017, according to Orloff and her LinkedIn. When Orloff left the Sober Services office, she went with him, Orloff said. Calvert confirmed she began a full-time job at Pillars in November 2017. When I asked about Sober Services, she cited a nondisclosure agreement.&lt;/p&gt;
&lt;p id=&quot;s8eHnM&quot;&gt;When I asked Calvert if she’d ever received money from or referred patients to Mendoza’s old partner, Windward Way, she responded, “Since my full time employment with Pillars no I have not.” When I asked about whether she was involved in patient brokering, she told me at the job she held before Pillars, she had “only received a paycheck from my employer.”&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;iKUbb0&quot;&gt;&lt;q&gt;Scratching the surface of these organizations reveals the need for a referee&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;k8Bmzb&quot;&gt;Despite the breakup, Earn still seemed to be entangled in Pillars’ digital presence until I started asking questions about the relationship at the end of April. At that point, there were two Facebook pages for Pillars. One of them listed Shane Earn at Sober Services as the contact. There was nothing on either Pillars page to suggest the two pages were run by separate people. After I asked Orloff specifically about the two Facebook pages, the one connected to Earn was taken down.&lt;/p&gt;
&lt;p id=&quot;fDo3zz&quot;&gt;The other Pillars page, run by Orloff, is an administrator on Facebook’s star community group, the 600,000-member health care provider gathering place called Show Me Your Stethoscope, which Facebook used as an example of “leaders inspiring change” in an &lt;a href=&quot;https://newsroom.fb.com/news/2017/10/new-features-for-groups-to-build-communities/&quot;&gt;October press release&lt;/a&gt;. In an effort to do transparent outreach, as advised by Mendoza, Pillars now publically runs a treatment center referral hotline for the group.&lt;/p&gt;
&lt;p id=&quot;IGsP8j&quot;&gt;Facebook has spent a year acting as a cheerleader for community support groups, especially those focused on addiction recovery. But scratching the surface of these organizations reveals the need for a referee, instead. Without that, there’s nothing to protect the most vulnerable people on the platform from this impenetrable tangle of altruism and e-commerce.&lt;/p&gt;
&lt;hr class=&quot;p-entry-hr&quot; id=&quot;XYEDOP&quot;/&gt;&lt;p class=&quot;p-dropcap has-dropcap&quot; id=&quot;k4LWkk&quot;&gt;It’s not just Affected by Addiction. There are enormous numbers of Facebook groups and pages targeting addicts and their families, and it seems like every one, big or small, is a potential hunting ground for marketers, whether the admins intend for them to be or not.&lt;/p&gt;
&lt;p id=&quot;hE1SHy&quot;&gt;Last month, a woman posted in another closed group, Addiction Recovery Support Group, complaining that a member had given her phone number to a marketer.&lt;/p&gt;
&lt;p id=&quot;4BFuND&quot;&gt;“[W]hen I told them I wasn’t interested in going that far away they got very rude to me. He kept asking for my insurance info and even told me how wrong it was for me to keep hurting my family by not coming to [their] rehab center,” she wrote.&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;Pbaruv&quot;&gt;&lt;q&gt;“He kept asking for my insurance info.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;f1haKH&quot;&gt;When contacted by &lt;em&gt;The Verge&lt;/em&gt;, the woman said she’d been contacted by six different treatment center marketers since joining the group. “Most messages start out kind and supportive but I’ve had several that get right to asking about my insurance and address.”&lt;/p&gt;
&lt;p id=&quot;xVxDSs&quot;&gt;She stayed in the group, despite the marketing. “If it wasn’t for a few people in the group I interact with, I’d leave.”&lt;/p&gt;
&lt;p id=&quot;RXY6Jg&quot;&gt;In his post about community groups, Zuckerberg wrote, “Online communities are a bright spot, and we can strengthen existing physical communities by helping people come together online as well as offline.” Savvy marketers understand the value of a local connection, too.&lt;/p&gt;
&lt;p id=&quot;wcN2kW&quot;&gt;In Maryland, for instance, a group of moms associated with a nonprofit advocacy group, Maryland Heroin Awareness Advocates (MHAA), use Facebook extensively to promote their fundraisers and events, both through official groups and pages and on ones run by individual members of the group. They also use those channels to advertise treatment center “scholarships,” free stays at rehabs for those who can’t afford the often-steep costs.&lt;/p&gt;
&lt;div class=&quot;c-float-left c-float-hang&quot;&gt;
&lt;aside id=&quot;vxIT20&quot;&gt;&lt;q&gt;“Most messages start out kind and supportive.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;N1Mk2R&quot;&gt;Several people who are or have been associated with MHAA are paid marketers for rehabs. The son of board member Lynn Fowler, rehab marketer and convicted patient broker Howard James Fowler Jr., for instance, has used Facebook groups to approach potential clients, often with his mother’s help. They’re both administrators on a Facebook group, Recovery Resource, that’s no longer particularly active. In 2016, though, the group was full of regular posters. Both Lynn and James used it to connect with people who were looking for treatment; Lynn would suggest that people contact James, and James would offer his help by finding treatment centers and sober homes in Florida.&lt;/p&gt;
&lt;p id=&quot;Mq33PZ&quot;&gt;Neither of the Fowlers responded to detailed questions about this story.&lt;/p&gt;
&lt;p id=&quot;ijueVb&quot;&gt;In November 2016, &lt;a href=&quot;https://www.mypalmbeachpost.com/news/crime--law/4th-sober-home-arrest-days-man-faces-patient-brokering-charges/H94fzeyKNkzRMe1Cr17ChJ/&quot;&gt;James was arrested&lt;/a&gt; in Florida on 14 counts of aiding patient brokering. He’d been running a sober home in Delray Beach, taking kickbacks to send residents to an outpatient rehab. The owner of that center was arrested on 95 counts of patient brokering. In February 2017, &lt;a href=&quot;https://www.mypalmbeachpost.com/news/sober-home-task-force-score-one-fourth-already-have-pleaded-guilty/m7ckMuhrILeauu53zK6q5I/&quot;&gt;James pled guilty&lt;/a&gt; to seven of the charges.&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;l9TWGI&quot;&gt;&lt;q&gt;Savvy marketers understand the value of a local connection, too&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;4q076R&quot;&gt;The conviction didn’t stop him from being involved in MHAA or referring people to rehabs. In September 2017, Fowler was the special guest at Save Our Children Family Peer Support, an in-person group &lt;a href=&quot;https://www.mdheroinawareness.org/&quot;&gt;run by MHAA&lt;/a&gt;. The next month, a mom from Maryland posted a thank you to James for negotiating a scholarship at a rehab in Delray Beach that James has claimed to be the admissions director of elsewhere on Facebook. An admissions director generally is in charge of “patient acquisition” efforts.&lt;/p&gt;
&lt;p id=&quot;MlvDDv&quot;&gt;Though Lynn Fowler initially agreed to an interview, she stopped responding to messages after I told her more details about the story. After sending both the Fowlers detailed questions, both blocked me on Facebook rather than responding. I was also blocked from the groups and pages for Recovery Resources, Save Our Children, and MHAA.&lt;/p&gt;
&lt;p id=&quot;giIGo9&quot;&gt;Pamela Knight, a former MHAA representative, has worked as a professional marketer for several rehabs, mostly in Florida. She’s in recovery herself, as well as being the mom of a son who struggles with addiction. She sometimes hangs out in groups targeted toward parents of people with addiction in Maryland. One poster in the Maryland chapter of The Addict’s Mom, an enormous Facebook community with dozens of spinoff groups, wrote that her daughter wanted to stay in state for rehab. Knight responded that her son had tried staying in Maryland for rehab. “He came home and relapsed,” she wrote.&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;R4nJY2&quot;&gt;&lt;q&gt;“She will hound the hell out of you.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;nYxLVm&quot;&gt;But for the most part, rather than directly reaching out to prospective clients, she would speak at community events and use Facebook to spread the word about her services. She has a Facebook page, Stigma KILLS, with 2,500 followers, which she uses to post inspirational images and warnings about the dangers of addiction, often with her phone number attached.&lt;/p&gt;
&lt;p id=&quot;7zIw49&quot;&gt;“At one time, I was just a regular mom navigating through parenthood just like everyone else.....and then BAM, I had to figure out how to become a Mom of a child suffering with substance abuse,” one post from April 4 reads. “There are many resources out there to achieve wellness. Recovery is possible!! Please reach out! Message me❤️”&lt;/p&gt;
&lt;p id=&quot;ulZU3p&quot;&gt;&lt;em&gt;The Verge&lt;/em&gt; interviewed three women who spoke with Knight about a referral for a loved one. All of them described Knight as pushy, even aggressive, in her sales tactics for rehab in Florida. One said Knight told her that treatment would cost over $20,000, suggesting she take out a home equity loan to pay. The woman declined. Another mom &lt;em&gt;did&lt;/em&gt; let Knight place her son, scraping together over $10,000 for inpatient rehab in Florida by digging into savings and borrowing from family.&lt;/p&gt;
&lt;p id=&quot;gLcZue&quot;&gt;“[Knight] was trying to place guilt on me, saying, ‘You’ve got to do this now, your son could die,’” she said. “At first, she was very nice. But she’s a salesman – she will hound the hell out of you.”&lt;/p&gt;
&lt;p id=&quot;vcuZ9v&quot;&gt;The third mother I spoke to, Karen Mackey, asked Knight for help at the end of 2016. One of her sons had died of an overdose in July, and another one of her sons was spiraling.&lt;/p&gt;
&lt;p id=&quot;QH1w35&quot;&gt;“I was sure he was going to go too. I was sure of it,” Mackey told me. She’d gotten Knight’s card at an event where Knight spoke. “So I called Pam, and told her how I’d met her, and she met me within an hour at the local Waffle House, and you know, I’ll never forget that. It was a life preserver.”&lt;/p&gt;
&lt;div class=&quot;c-float-left c-float-hang&quot;&gt;
&lt;aside id=&quot;YqPS5T&quot;&gt;&lt;q&gt;Knight failed to mention she was a paid recruiter for the center&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;D3s7OT&quot;&gt;Knight got her son into one treatment center in Maryland, but it was a bad fit. That’s when Knight told Mackey the best way to keep her son alive was send him to a treatment center she knew in Florida. Knight failed to mention she was a paid recruiter for the center, instead saying it was where both she and her son had gotten clean. (When I spoke with Knight, she told me her son had gotten clean at a different center, Recovery Unplugged, where she was working when I first called.)&lt;/p&gt;
&lt;p id=&quot;EZPlwo&quot;&gt;“I had just lost my son seven months before,” Mackey told me. “The fear I had of losing [my other son], too – she could have said, ‘Send him to the Moon,’ and I would have done everything in my power to get him there.”&lt;/p&gt;
&lt;p id=&quot;oEZBhe&quot;&gt;She sold her tractor and her snowblower, but she still couldn’t come up with the amount Knight said she needed to send her son to the Florida rehab. Knight texted her every day asking whether she’d come up with the cash yet.&lt;/p&gt;
&lt;p id=&quot;mUWWtL&quot;&gt;“I said, ‘Pam, I don’t have the money raised,’” Mackey told me. “And she said, ‘Isn’t your son worth $10,000?’”&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;1aVyrf&quot;&gt;&lt;q&gt;“She could have said, ‘Send him to the Moon,’ and I would have done everything in my power to get him there.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;GTk9Fz&quot;&gt;“I never said, ‘Isn’t your son worth it?’ I’m not that kind of person,” Knight told me when I reached out. “I feel awful about doing cash pay. I don’t like having to say, ‘Well, you know, do you have credit cards, or can anybody help you with money?’ And I will make the comment, ‘We should never have to put a price tag on someone’s life.’ And I do believe that because I feel sorry for the people who don’t have good insurance.”&lt;/p&gt;
&lt;p id=&quot;MjFK88&quot;&gt;Mackey eventually raised $7,500. Knight called her and gave her some thrilling news: the treatment center was willing to take that instead. “She goes, ‘Karen, get him on a plane. He may not live through the night.’”&lt;/p&gt;
&lt;p id=&quot;AxuY2H&quot;&gt;When her son got to the rehab, it was nothing like Knight (or the center’s website) had promised, a common theme among the mothers I spoke with. He was in a house with a roommate. Similarly, another mother I spoke with told me Knight promised her son would be in a residential treatment setting. When he got there, he was told there was no more room at the inpatient center, and he was put in a halfway house where he could come and go freely while attending an outpatient program.&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;NGQd9P&quot;&gt;&lt;q&gt;It was nothing like Knight (or the center’s website) had promised&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;7f7Wjf&quot;&gt;A clinician had initially recommended he stay for 30 to 45 days, which Mackey believed was covered by the $7,500. After 21 days, though, Mackey was told she would have to start paying a “reduced rate” of $1,500 a week if her son was going to stay at the treatment center. Upset, Mackey emailed her son’s case manager.&lt;/p&gt;
&lt;p id=&quot;mwCuim&quot;&gt;“I was so hopeful based on Pam Knight’s recommendation and determination to get him in and quick that I bought into it,” she wrote. “I sold our snow blower for a hundred less than it was worth because I was being so pressured to raise 10,000 and get him in today.”&lt;/p&gt;
&lt;p id=&quot;Va7inT&quot;&gt;She never got a reply. Instead, according to Mackey, the head of the rehab called her and told her she was forbidden to talk to anyone at the treatment center. She’d begun to suspect Knight had financial ties to the center and asked if she wasn’t allowed to talk to her, either. He didn’t give her a direct answer, Mackey remembers. Instead, he told her she could do what she wanted. Later, she realized the email Knight listed on her Facebook page, Stigma KILLS, was a company address for the rehab.&lt;/p&gt;
&lt;p id=&quot;uUZNra&quot;&gt;Mackey’s son came home. The next day, she says, he went to Baltimore, bought heroin, and overdosed at her house. EMTs came and revived him, but a few hours later, Mackey found him overdosed again. Some opioids used to adulterate heroin last longer than Narcan, the drug used to stop overdoses, which means users may need multiple Narcan injections to survive one bad dose. Mackey’s son had to be revived three times over the next few days, and had a brief stint in the hospital, but stayed alive.&lt;/p&gt;
&lt;p id=&quot;0H4sYE&quot;&gt;A week later, he was again admitted to the hospital, unrelated to the overdose. Knight visited him there, but wouldn’t discuss what happened in Florida. Mackey’s son has since gotten clean through a methadone program.&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;47s97v&quot;&gt;&lt;q&gt;He went to Baltimore, bought heroin, and overdosed&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;RCgr3u&quot;&gt;When I spoke with her, Knight expressed shock that anyone would speak badly about her services. She insisted she would never lie to a parent or suggest they mortgage their house. Rather, she said she was very passionate about getting kids into treatment in the slim window when they’re willing to get help.&lt;/p&gt;
&lt;p id=&quot;aG54NC&quot;&gt;“You have to act on it, because come the next day, they’re going to use again,” she said. “I’m not the bad guy.”&lt;/p&gt;
&lt;p id=&quot;R9AoiQ&quot;&gt;I hadn’t talked to Mackey at that point, but Knight, guessing I might have, told me, “What happened with Karen was wrong. They were begging for help, he had Medicaid, I was begging the treatment center to take him for hardly any money.”&lt;/p&gt;
&lt;p id=&quot;FvDRGv&quot;&gt;She said parents criticizing her might be looking for people to blame when their kids couldn’t stay off drugs, or the kid might not have wanted to get clean, so they’d “talked smack” about the rehab they went to. “Statistically speaking, I mean, so many people don’t make it, right? But they don’t want it. You have to want it,” she told me.&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;mmhfZx&quot;&gt;&lt;q&gt;“What happened with Karen was wrong.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;xzx9KT&quot;&gt;Knight told me she’d been an employee at the treatment center Mackey’s son had gone to, and that she was now an employee at a different treatment center, Recovery Unplugged. I asked Knight what her policy was around disclosing those relationships.&lt;/p&gt;
&lt;p id=&quot;ex0VSK&quot;&gt;“Just recently, I think there’s been a real push that you do need to put on your Facebook page who you’re working for, otherwise you could get in trouble,” she told me. “I have had negative feedback, like, ‘Oh, you’re just a patient broker, you send everybody to Florida.’ Well no, actually, I don’t. A patient broker is somebody who gets paid per-head.”&lt;/p&gt;
&lt;p id=&quot;o4ppKm&quot;&gt;The next day, I called Recovery Unplugged to confirm Knight’s role, and I was told she’d been let go. After being bounced around to different departments, I ended up on the phone with co-founder and CEO Andrew Sossin. He told me Knight had worked with his marketing team.&lt;/p&gt;
&lt;p id=&quot;3v0b1T&quot;&gt;He was vague about why she’d been cut loose. Somebody had told someone that Knight “may or may not have done something that I would consider probably legal...but not the way we do things. And then the decision was made that I can’t be associated with that.”&lt;/p&gt;
&lt;p id=&quot;4ZR92u&quot;&gt;He wished her well, and said he hopes she “can continue to help people” while working “for other people that don’t have the same standards we do.”&lt;/p&gt;
&lt;p id=&quot;Mzo47M&quot;&gt;Later, I asked Knight what had happened. She said she’d told them there was an article coming out, and they’d immediately fired her. “They said, you know, they’re a national company, and they can’t have bad press.”&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;wwekeT&quot;&gt;&lt;q&gt;“It’s the craziest business I’ve ever been in.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;0NLYTd&quot;&gt;She started to cry. “I never intended to hurt anybody,” she said, explaining that she’d left treatment centers in the past that she didn’t feel were doing the right thing.&lt;/p&gt;
&lt;p id=&quot;IdfViv&quot;&gt;“It’s the craziest business I’ve ever been in. One person tells you, ‘Do this.’ The other person says, ‘No no, you can’t do that.’”&lt;/p&gt;
&lt;p id=&quot;qBMIEz&quot;&gt;Knight sent me her texts with Barry Reiman, the vice president of business development at Recovery Unplugged, who someone in the outreach department had told me made the decision to let Knight go. “I am not taking any sides whatsoever. This is not my preference,” he wrote. “I am well aware that people run their mouths. Unfortunately this is being printed.” (When contacted, Reiman said to speak with Sossin.)&lt;/p&gt;
&lt;p id=&quot;dwlvPl&quot;&gt;In the texts, Knight protested, saying the story wasn’t even running until a week later. “I know in my heart that I do good work and I go above and beyond with clients and families,” she texted him.&lt;/p&gt;
&lt;p id=&quot;20ZvEU&quot;&gt;“I guess we’ll need to say what the article says,” he responded.&lt;/p&gt;
&lt;div class=&quot;p-fullbleed-block&quot;&gt;&lt;span class=&quot;e-image__inner&quot;&gt;&lt;span class=&quot;e-image__image&quot; data-original=&quot;https://cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg&quot;&gt; &lt;img srcset=&quot;https://cdn.vox-cdn.com/thumbor/bB1G_qV_sAECDs6qQKwQ3NQW3gQ=/0x0:3000x2000/320x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 320w, https://cdn.vox-cdn.com/thumbor/EPQ0uReEivy7jj6Pm0tHtep9B4o=/0x0:3000x2000/520x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 520w, https://cdn.vox-cdn.com/thumbor/VugEiTLy1i4aAtu7g9XUR2h_hqg=/0x0:3000x2000/720x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 720w, https://cdn.vox-cdn.com/thumbor/-hSvLZQoyUTlnduJymx3mRWvbfs=/0x0:3000x2000/920x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 920w, https://cdn.vox-cdn.com/thumbor/YXv2YLIY2dxz7_iPte-V06PqZaQ=/0x0:3000x2000/1120x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 1120w, https://cdn.vox-cdn.com/thumbor/2K_EYX3LaMOioJGzZ20rtkBEscU=/0x0:3000x2000/1320x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 1320w, https://cdn.vox-cdn.com/thumbor/I6dI3ONajMGC8_jYnIhCVh2eK1E=/0x0:3000x2000/1520x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 1520w, https://cdn.vox-cdn.com/thumbor/d0HoIDresZT0-3JBf7F5zLBnkHs=/0x0:3000x2000/1720x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 1720w, https://cdn.vox-cdn.com/thumbor/vIyJjLvHUmJ3jDXcPskuWphqlp8=/0x0:3000x2000/1920x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg 1920w&quot; sizes=&quot;100vw&quot; src=&quot;https://cdn.vox-cdn.com/thumbor/cBqkCdia0ee0jV70QXOlqrmWq7A=/0x0:3000x2000/1200x0/filters:focal(0x0:3000x2000)/cdn.vox-cdn.com/uploads/chorus_asset/file/10881057/vergefacebookspot2final.jpg&quot;/&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;
&lt;p class=&quot;p-dropcap has-dropcap&quot; id=&quot;nPCs0M&quot;&gt;Many of the problems in rehab marketing are due to the fact that addiction treatment is largely unregulated. For all that pharmaceutical marketers may skirt regulations, there &lt;em&gt;are&lt;/em&gt; clear regulations to follow, many of them federal. But, as Bergman of Recovery Research Institute at Massachusetts General Hospital pointed out to me, addiction wasn’t considered a medical problem until recently, long after patient protection standards were developed.&lt;/p&gt;
&lt;p id=&quot;BrNXwl&quot;&gt;“Right now, treatment programs can say whatever they want. ‘Our success rates are 85%’ – those things don’t even &lt;em&gt;mean&lt;/em&gt; anything,” he said. “For most of these treatment programs, if their goal is to keep patients coming in and be able to make money, it’s probably not in their best interest to measure outcomes over time, you know what I mean?”&lt;/p&gt;
&lt;div class=&quot;c-float-right c-float-hang&quot;&gt;
&lt;aside id=&quot;bOBxLP&quot;&gt;&lt;q&gt;“Treatment programs can say whatever they want.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;yPm42q&quot;&gt;Facebook, by making desperation so easily searchable, has exacerbated the worst qualities the treatment industry. A word-of-mouth industry with a constant supply of vulnerable and naive targets who feel stigmatized and alone is a scammer’s paradise. Facebook does have tools to report groups that are abusive, but given the murky definition of patient brokering, Facebook’s legendary lack of transparency, and the fact that it already went to a lot of effort to promote the earlier incarnation of Affected by Addiction, which Mendoza himself admits was a deceptive marketing scheme, Facebook hardly seems like a good arbiter.&lt;/p&gt;
&lt;p id=&quot;eTEo90&quot;&gt;“We have seen that Facebook products and tools, including Groups, can complement work on prevention, education, de-stigmatization, addiction support and awareness, and we continue to support community leaders that use our platform for good,” a Facebook spokesperson told me when I asked about this story. “Most of what we see in Groups is positive and meaningful to people and their communities, and we are committed to increasing the good and minimizing the bad across Facebook.” They declined to answer any specific questions about addiction-related groups, patient brokering, or Facebook’s relationship with Affected by Addiction.&lt;/p&gt;
&lt;div class=&quot;c-float-left c-float-hang&quot;&gt;
&lt;aside id=&quot;YTYmyO&quot;&gt;&lt;q&gt;It’s a scammer’s paradise&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;v2nfdw&quot;&gt;When Garrett Hall reached out to Laurie Couch on Facebook, she had nothing but good things to say about the group. “I have received so many levels of healing from this group,” she told him.&lt;/p&gt;
&lt;p id=&quot;Yt4lLu&quot;&gt;But Hall wasn’t just reaching out to offer a hand; he was there to deliver her to a salesperson. And when Couch cut off the call, she was banned from the group, losing a significant support network in the process.&lt;/p&gt;
&lt;p id=&quot;ndofjT&quot;&gt;“It has affected my ability to share openly, because you feel a level of paranoia when you’ve been duped like this. It spreads into every aspect of my daily living,” Couch told &lt;em&gt;The Verge&lt;/em&gt;. “Why couldn’t he just have said, ‘You’re probably familiar with Matt; we saw some posts of yours, and we’re concerned you might need some help’? I would have had no problem with that. But the backhanded, backdoor way this happened was just not right.”&lt;/p&gt;
&lt;div&gt;
&lt;aside id=&quot;KPXwz8&quot;&gt;&lt;q&gt;“You feel a level of paranoia when you’ve been duped like this.”&lt;/q&gt;&lt;/aside&gt;&lt;/div&gt;
&lt;p id=&quot;AUDFf3&quot;&gt;Heffernan, the consultant who worked with Affected by Addiction, is deeply concerned by how exposed families are to predators in these groups, and he thinks it’s time for Facebook to take an active role.&lt;/p&gt;
&lt;p class=&quot;c-end-para&quot; id=&quot;oUVsfd&quot;&gt;“You’re basically operating a non-therapeutic support group with volunteers and no liability and no training,” he told me. “You’re at the point where you have to invite in some real [professionals] to sit down and say, ‘What should we do? How can we do this better before it gets out of hand?’”&lt;/p&gt;

</description>
<pubDate>Mon, 21 May 2018 13:13:21 +0000</pubDate>
<dc:creator>DmenshunlAnlsis</dc:creator>
<og:description>Facebook support groups leave addicts and their families exposed to predatory marketers.</og:description>
<og:image>https://cdn.vox-cdn.com/thumbor/JOmF9m1Fe-Yj0Pb4qyexCfkSiUU=/0x287:4000x2381/fit-in/1200x630/cdn.vox-cdn.com/uploads/chorus_asset/file/10881027/vergefacebookgroupfinal.jpg</og:image>
<og:title>Predatory behavior runs rampant in Facebook’s addiction support groups</og:title>
<og:type>article</og:type>
<og:url>https://www.theverge.com/2018/5/21/17370066/facebook-addiction-support-groups-rehab-patient-brokering</og:url>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.theverge.com/2018/5/21/17370066/facebook-addiction-support-groups-rehab-patient-brokering</dc:identifier>
</item>
<item>
<title>Playing battleships over BGP</title>
<link>https://blog.benjojo.co.uk/post/bgp-battleships</link>
<guid isPermaLink="true" >https://blog.benjojo.co.uk/post/bgp-battleships</guid>
<description>&lt;p&gt;BGP is the glue of the internet. For a protocol that was produced on &lt;a href=&quot;http://www.computerhistory.org/atchm/the-two-napkin-protocol/&quot;&gt;two napkins in 1989&lt;/a&gt; it is both amazing and horrifying that it runs almost all of the ISP to ISP interactions and is now a very fundemental part of the internet.&lt;/p&gt;
&lt;p&gt;BGP normally gets a bad rep, mainly because of its default trusting nature of peers, and the hard task of verifying a routes legitimacy. This is why we hear about BGP hijackings of varying severity from the &lt;a href=&quot;https://dyn.com/blog/pakistan-hijacks-youtube-1/&quot;&gt;whole of youtube&lt;/a&gt; to &lt;a href=&quot;https://web.archive.org/web/20180427153929/https://arstechnica.com/information-technology/2018/04/suspicious-event-hijacks-amazon-traffic-for-2-hours-steals-cryptocurrency/&quot;&gt;a section of all AWS Route 53 requests&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;However to understand this, you also have to understand how the topology of the internet works. In this case, we start with a lonely router:&lt;/p&gt;
&lt;center&gt;&lt;img src=&quot;https://blog.benjojo.co.uk/asset/G6UBP4lorY&quot; /&gt;&lt;/center&gt;
&lt;p&gt;A router isn’t much use if it cannot route anything, so we connect it to another router on a physical layer (this can be anything from copper ethernet, to undersea fibre, to 802.11 “wifi” links)&lt;/p&gt;
&lt;p&gt;After that, the two connected routers (in our case, the red and blue router) need to know what they can route for each other. After all the point of routers is to route traffic from one destination to another.&lt;/p&gt;
&lt;p&gt;As mentioned above, the globally accepted way to do this between ISPs is to setup BGP on both sides, and let the sides “announce” to each other what they can route:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.benjojo.co.uk/asset/DAx3gjDP6n&quot; alt=&quot;two routers BGP to eachother&quot; /&gt;&lt;/p&gt;
&lt;p&gt;However it’s not much use if they can only talk to each other, and what if red and blue are not directly connected? The more routers we connect to, and those other routers connect to, we form a topology of routing information. This is possible because BGP shares routing information with its other peers it’s connected to:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.benjojo.co.uk/asset/Pg5SLNNHVl&quot; alt=&quot;the propergation of a route announcement&quot; /&gt;&lt;/p&gt;
&lt;p&gt;How routers share information between each other is dependent on the configuration policy, and that is normally dictated by the real world relationship two routers have in common. Different setups exist for customers, traffic exchange agreements, or upstream providers.&lt;/p&gt;
&lt;p&gt;Because of this, routers should have sets of instructions programmed into them to filter out things they are not expecting to give or to take from another peer. However from time to time someone with malicious intentions obtains access to a router that is connected to a router that does not have these filters. Fixing this programatically is &lt;em&gt;incredibly hard&lt;/em&gt; because it would require every ISP to change how their routers work, and previous attempts to fix this have proven to &lt;a href=&quot;https://web.archive.org/web/20180409193946/https://rpki-monitor.antd.nist.gov/&quot;&gt;not be widely adopted&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;BGP also has a way to encode information with a route called communities. Defined in &lt;a href=&quot;https://tools.ietf.org/html/rfc1997&quot;&gt;RFC1997&lt;/a&gt; (sadly written in 1996, so. close.) a community can be attached to a route announcement, and consists of a 32bit number. That in practice is split into two 16 bit numbers (one for a ASN and one for a signal related to/for that ASN):&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.benjojo.co.uk/asset/sKrZ1ZL51f&quot; alt=&quot;bgp communities&quot; /&gt;&lt;/p&gt;
&lt;p&gt;These are used to signal extra information about the route, for example where a provider picked up a route:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.benjojo.co.uk/asset/PC5S6crK5L&quot; alt=&quot;an example route from NTT&quot; /&gt;&lt;/p&gt;
&lt;p&gt;This is useful in terms of filtering. For example if you have many providers and you want to try and ensure traffic stays local to your country, you can use these communities to give a better preference to those routes.&lt;/p&gt;
&lt;p&gt;This had me thinking though. What else could we signal? And how far do communities go?&lt;/p&gt;
&lt;p&gt;After some testing, it appears that every &lt;a href=&quot;https://en.wikipedia.org/wiki/Tier_1_network&quot;&gt;tier 1&lt;/a&gt; network strips communities except &lt;a href=&quot;https://en.wikipedia.org/wiki/Level_3_Communications&quot;&gt;former Level 3&lt;/a&gt; who carry communties from origin router to customer router. This also means that a router could send information to other routers without ever actually talking directly to each other.&lt;/p&gt;
&lt;h2&gt;Battleships&lt;/h2&gt;
&lt;p&gt;Knowing that I could do “indirect communication” over BGP now, I wanted to somehow use this to conduct some &lt;em&gt;non conventional&lt;/em&gt; communication. I picked Battleships as a medium to test this in, since the communication required to play a battleship game is tiny (X and Y coordinates and if the last shot was a hit or a miss)&lt;/p&gt;
&lt;p&gt;Two communities were produced that would allow me run a game of battleships over BGP&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.benjojo.co.uk/asset/mtghHpSyRc&quot; alt=&quot;The bit format of the two communities&quot; /&gt;&lt;/p&gt;
&lt;p&gt;This fits a entire game setup into two 16 bit numbers, allowing the game move to be reliably communicated with two communities.&lt;/p&gt;
&lt;p&gt;Since battleships is a 2 player game, I recruited &lt;a href=&quot;https://bgp.he.net/AS203729&quot;&gt;AS203729&lt;/a&gt; to play with me. Since they had BGP sessions in New York while I had my own BGP connections setup in London.&lt;/p&gt;
&lt;p&gt;While planning out the game, we foresaw we could trigger &lt;a href=&quot;https://tools.ietf.org/html/rfc2439&quot;&gt;BGP Route Flap Damping&lt;/a&gt; while playing the game due to the frequency we would both be updating our routes. Since we were both supporting real production traffic through the prefixes we were using to play the game, we agreed to a 30 second cooldown timer on every move we made, since triggering route flap damping would cause prefixes to be blackholed, and thus cause an outage for either of us.&lt;/p&gt;
&lt;p&gt;As we were running other traffic through these routers, we had to keep our normal routing demon online rather than a custom BGP demon. To work around this the battleship game binary live generated and reloaded BIRD configuration and used the demons control socket to poll for route changes.&lt;/p&gt;
&lt;p&gt;With that all setup, on May 16th 2018 myself &lt;a href=&quot;https://bgp.he.net/AS206924&quot;&gt;AS206924&lt;/a&gt; and &lt;a href=&quot;https://bgp.he.net/AS203729&quot;&gt;AS203729&lt;/a&gt; played what is likely the first board game ever conducted purely over BGP.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://blog.benjojo.co.uk/asset/wzfZYQZJ7E&quot; alt=&quot;a gif of the first battleships game over bgp&quot; /&gt;&lt;/p&gt;
&lt;p&gt;The game went smoothly, apart from a 45 minute period where no moves were exchanged due to causing the previously mentioned route flap damping to activate. This happened on my side and caused Level 3 to have a less optimal route for my traffic in the 45 minute period. To mitigate this from happening again later on the game, we decided to move to a 90 second cooldown period on every move.&lt;/p&gt;
&lt;p&gt;Despite this, the final blow to my friend &lt;a href=&quot;https://bgp.he.net/AS203729&quot;&gt;AS203729&lt;/a&gt; was dealt on the 68th move. Making me the first winner of a board game conducted done over a public internet routing protocol.&lt;/p&gt;
&lt;p&gt;Was this a logical thing to do? Probably not. Was this a fun to do? &lt;strong&gt;Hell yes.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I’ve open sourced the code that we both ran, though I really would not suggest repeating this experiment.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://github.com/benjojo/bgp-battleships&quot;&gt;https://github.com/benjojo/bgp-battleships&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;And if you enjoyed this, you will be glad to know that I am going to be at Recurse Center in NY for the next 5 weeks! Meaning you can follow my &lt;a href=&quot;https://twitter.com/benjojo12&quot;&gt;Twitter&lt;/a&gt; or &lt;a href=&quot;https://blog.benjojo.co.uk/rss.xml&quot;&gt;RSS&lt;/a&gt; to keep up with the other silly (or sometimes sensible) things I will do!&lt;/p&gt;
&lt;p&gt;Until next time!&lt;/p&gt;
</description>
<pubDate>Mon, 21 May 2018 12:32:45 +0000</pubDate>
<dc:creator>benjojo12</dc:creator>
<dc:format>text/html</dc:format>
<dc:identifier>https://blog.benjojo.co.uk/post/bgp-battleships</dc:identifier>
</item>
<item>
<title>Japan&amp;#039;s secret spy agency</title>
<link>https://theintercept.com/2018/05/19/japan-dfs-surveillance-agency/</link>
<guid isPermaLink="true" >https://theintercept.com/2018/05/19/japan-dfs-surveillance-agency/</guid>
<description>&lt;div data-reactid=&quot;198&quot; readability=&quot;82.832174776564&quot;&gt;
&lt;p&gt;Now, a &lt;a href=&quot;http://www6.nhk.or.jp/special/detail/index.html?aid=20180519&quot;&gt;new investigation&lt;/a&gt; by the Japanese broadcaster NHK — produced in collaboration with The Intercept — reveals, for the first time, details about the inner workings of Japan’s opaque spy community. Based on classified documents and interviews with current and former officials familiar with the agency’s intelligence work, the investigation shines light on a previously undisclosed internet surveillance program and a spy hub in the south of Japan that is used to monitor phone calls and emails passing across communications satellites.&lt;/p&gt;
&lt;div class=&quot;img-wrap align-center width-fixed&quot; readability=&quot;8&quot;&gt;&lt;a href=&quot;https://theintercept.imgix.net/wp-uploads/sites/1/2018/05/C1-2-1526654625.jpg?auto=compress%2Cformat&amp;amp;q=90&quot;&gt;&lt;img class=&quot;aligncenter size-large wp-image-188678&quot; src=&quot;https://theintercept.imgix.net/wp-uploads/sites/1/2018/05/C1-2-1526654625.jpg?auto=compress%2Cformat&amp;amp;q=90&amp;amp;w=1024&amp;amp;h=576&quot; alt=&quot;C1-2-1526654625&quot;/&gt;&lt;/a&gt;
&lt;p class=&quot;caption&quot;&gt;Night view of the C1 building, inside Japan’s Ministry of Defense compound in Ichigaya.&lt;/p&gt;
&lt;p class=&quot;caption source&quot;&gt;Photo: NHK&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;According to the current and former officials, the Directorate for Signals Intelligence, or DFS, employs about 1,700 people and has at least six surveillance facilities that eavesdrop around the clock on phone calls, emails, and other communications. (The NSA, in comparison, has said it has a workforce of more than 30,000 and Britain’s signals intelligence agency claims more than 6,000 staff.) The communications collected at the spy facilities are sent back to analysts who work inside the C1 building, which has four underground floors and eight above ground.&lt;/p&gt;
&lt;p&gt;“Very few people know what the DFS is doing and can enter the building,” according to an active-duty official with knowledge of the directorate’s operations, who spoke on condition of anonymity because they were not authorized to talk to the media. The official agreed to share details about the directorate after The Intercept and NHK &lt;a href=&quot;https://theintercept.com/2017/04/24/japans-secret-deals-with-the-nsa-that-expand-global-surveillance/&quot;&gt;last year revealed&lt;/a&gt; that the spy agency had &lt;a href=&quot;https://theintercept.com/document/2017/04/24/japan-provided-with-xkeyscore/&quot;&gt;obtained&lt;/a&gt; a mass surveillance system called XKEYSCORE, which is used to sift through copies of people’s emails, online chats, internet browsing histories, and information about social media activity. The official said that they believed the directorate’s use of XKEYSCORE was “not permissible” under the Japanese Constitution, which protects people’s right to privacy.&lt;/p&gt;
&lt;blockquote class=&quot;stylized pull-right&quot; data-shortcode-type=&quot;pullquote&quot; data-pull=&quot;right&quot; readability=&quot;6&quot;&gt;
&lt;p&gt;The official believed the directorate’s use of XKEYSCORE was “not permissible” under the Japanese Constitution.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The directorate – known in Japanese as the “Denpa-Bu,” meaning “electromagnetic wave section” – currently has 11 different departments, each focused on a different subject, such as information analysis, public safety and security, and cryptography. However, the departments are kept separate from each other and there is limited communication between them, the active-duty official said. Each department in the C1 building has a different lock installed on the rooms it uses, and these can only be accessed by a select group of people who have the appropriate security clearance, access codes, and identification. The directorate operates as the largest arm of Japan’s Defense Intelligence Agency, which has other divisions focused on, for example, analyzing satellite imagery, sources said.&lt;/p&gt;
&lt;p&gt;Atsushi Miyata, who between 1987 and 2005 worked with the directorate and the Ministry of Defense, said that his work for the spy agency had involved monitoring neighboring countries, such as North Korea, and their military activities. But the agency’s culture of intense secrecy meant that it was reluctant to share information it collected with other elements of the Japanese government. “They did not share the data inside of [the] Defense Ministry properly,” said Miyata. “Even inside of the Defense Ministry, the report was not put on the table. So the people did not understand what we were doing.”&lt;/p&gt;
&lt;p&gt;The directorate is accomplished at conducting surveillance, but has a tendency to be excessively secretive about its work, according to classified documents The Intercept disclosed last year. A &lt;a href=&quot;https://theintercept.com/document/2017/04/24/what-are-the-japanese-like-as-siginters&quot;&gt;2008 NSA memo&lt;/a&gt; described its Japanese counterparts as being “still caught in a Cold War way of doing business” and “rather stove-piped.” The U.S. continues to work closely with Japan’s intelligence community, however, and collaborates with the country to monitor the communications of countries across Asia.&lt;/p&gt;
&lt;/div&gt;&lt;div data-reactid=&quot;217&quot; readability=&quot;169.18819991705&quot;&gt;
&lt;p&gt;&lt;u&gt;About 700 miles&lt;/u&gt; southwest of Tokyo, there are two small towns called Tachiarai and Chikuzen, which have a combined population of about 44,000 people. Japan’s military, known as the Self-Defense Forces, has a base situated on a patch of grassy farmland in between the towns. But the base is not used to train soldiers. It is one of the country’s most important spy hubs.&lt;/p&gt;
&lt;p&gt;For years, the large antennae inside the secure compound, which are concealed underneath what look like giant golf balls, attracted concerns from local residents who were worried that the powerful radio waves they emitted might damage their health or interfere with their televisions. The Japanese government sent senior officials to reassure the locals that there would be no problems, and the government began paying the Chikuzen council an annual fee of about $100,000 as compensation for the disturbance caused by the base. But the function of the antennae was never revealed.&lt;/p&gt;
&lt;p&gt;A top-secret document from the directorate offers unprecedented insight into some of the Tachiarai base’s activities. The document – an &lt;a href=&quot;https://theintercept.com/document/2018/05/19/dfs-briefing-feb-2013/&quot;&gt;English-language PowerPoint presentation&lt;/a&gt; – appears to have been shared with the NSA during a meeting in February 2013, at which the Japanese spy agency’s then-deputy director was scheduled to discuss intelligence-gathering issues with his American counterparts. The presentation was contained in the archive of classified files provided to The Intercept by Edward Snowden. No internal documents from Japan’s surveillance agency have ever been publicly disclosed before.&lt;/p&gt;
&lt;p&gt;According to the presentation, Japan has used Tachiarai for a covert internet surveillance program code-named MALLARD. As of mid-2012, the base was using its antennae to monitor communications passing across satellites. Each week, it collected records about some 200,000 internet sessions, which were then being stored and analyzed for a period of two months. Between December 2012 and January 2013, Tachiarai began using the surveillance technology to collect information about potential cyberattacks. As a result, its data collection rapidly increased, and it began sweeping up information about 500,000 internet sessions every hour – 12 million every day. Despite this, the directorate indicated that it was only able to detect a single email that was linked to an apparent cyberattack. It struggled to cope with the amount of data it was harvesting and asked the NSA for help. “We would like to see processing procedure which the U.S. side employs in order not to affect traditional SIGINT collection,” the directorate told the NSA, “and would appreciate your technical assistance.”&lt;/p&gt;
&lt;blockquote class=&quot;stylized pull-left&quot; data-shortcode-type=&quot;pullquote&quot; data-pull=&quot;left&quot; readability=&quot;6&quot;&gt;
&lt;p&gt;“Even inside of the Defense Ministry, the people did not understand what we were doing.”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Chris Augustine, a spokesperson for the NSA, declined to answer questions about the agency’s cooperation with Japan, saying in a statement that he would “neither confirm nor deny information concerning potential relationships with foreign intelligence services.” He added: “Any cooperation among intelligence services is conducted lawfully, in a manner that mutually strengthens national security.”&lt;/p&gt;
&lt;p&gt;The directorate’s work at Tachiarai appears to focus on monitoring the activities of foreign countries in the region. It is unclear whether it collects Japanese citizens’ communications, either deliberately or incidentally, through dragnet programs like MALLARD. The law in Japan prohibits wiretapping landlines without a court order, but monitoring communications as they are being transmitted wirelessly across satellites is a gray area, Japanese legal experts say, because there are no legal precedents in the country that place limitations upon that kind of surveillance, though there is a general right to privacy outlined in the constitution.&lt;/p&gt;
&lt;p&gt;According to Richard Tanter, a professor at the University of Melbourne who specializes in researching government surveillance capabilities, more than 200 satellites are “visible” from Tachiarai, meaning the base can intercept communications and data passing between them using its surveillance systems. Of the 200-plus satellites, said Tanter, at least 30 are Chinese and potential targets for ongoing surveillance. Moreover, he added, “satellites owned or operated by Russia, South Korea, Taiwan, and even the United States or European states may be targeted” by the Tachiarai facility.&lt;/p&gt;
&lt;p&gt;Snowden, who worked at a U.S. military base in Japan as an NSA contractor between 2009 and 2012, told The Intercept that Japanese spies appeared to have targeted “entire internet service providers, not just any one customer.” Referencing the MALLARD program, he said that there were not “500,000 terrorist communications happening in one year, much less one hour. … Is this authorized in law in a way that’s well-understood, that’s well-regulated, to make sure they are only targeting bad guys and not simply everything that they see?”&lt;/p&gt;
&lt;p&gt;A spokesperson for Japan’s Ministry of Defense refused to discuss MALLARD, but said that the country’s “information-gathering activities” are necessary for national security and “done in compliance with laws and regulations.” The spokesperson acknowledged that Japan has “offices throughout the country” that are intercepting communications; however, he insisted that the surveillance is focused on military activities and “cyberthreats” and is “not collecting the general public’s information.” When pressed to explain how the country’s spy systems distinguish ordinary people’s communications from those related to threats, the spokesperson would not provide details on the grounds that doing so “may be a hindrance to effective future information activities.”&lt;/p&gt;
&lt;div class=&quot;img-wrap align-center width-fixed&quot; readability=&quot;13&quot;&gt;&lt;a href=&quot;https://theintercept.imgix.net/wp-uploads/sites/1/2018/05/GettyImages-939576462-1526654747.jpg?auto=compress%2Cformat&amp;amp;q=90&quot;&gt;&lt;img class=&quot;aligncenter size-large wp-image-188683&quot; src=&quot;https://theintercept.imgix.net/wp-uploads/sites/1/2018/05/GettyImages-939576462-1526654747.jpg?auto=compress%2Cformat&amp;amp;q=90&amp;amp;w=1024&amp;amp;h=683&quot; alt=&quot;TOKYO, JAPAN - MARCH 29: A cafe employee works on her laptop on the viewing platform of the Tokyo Skytree on March 29, 2018 in Tokyo, Japan. The tower was opened to the public in May 2012 and is the tallest tower in the world and the second tallest structure in the world after the Burj Khalifa in Dubai. It is primarily a television and radio broadcast site for Japan's Kanto region but is also a popular tourist site attracting thousands of visitors each month. (Photo by Carl Court/Getty Images)&quot;/&gt;&lt;/a&gt;
&lt;p class=&quot;caption&quot;&gt;A woman works on her laptop on the viewing platform of the Tokyo Skytree on March 29, 2018, in Tokyo, Japan.&lt;/p&gt;
&lt;p class=&quot;caption source&quot;&gt;Photo: Carl Court/Getty Images&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;&lt;u&gt;In October 2013,&lt;/u&gt; the Directorate for Signals Intelligence was planning to launch an operation aimed at what it described as the “Anonymous internet,” according to the &lt;a href=&quot;https://theintercept.com/document/2018/05/19/dfs-briefing-feb-2013/&quot;&gt;2013 presentation&lt;/a&gt;. This suggests that the directorate wanted to collect data about people’s usage of privacy tools such as Tor, which allows people to mask their computer’s IP address while they browse the internet. Tor is often used by journalists and dissidents to evade government surveillance; however, it is also used by child abusers and other criminals to plan or carry out illegal acts. In April 2013, it was &lt;a href=&quot;http://www.bbc.com/news/technology-22248692&quot;&gt;reported&lt;/a&gt; that Japanese police were urging internet service providers to find ways to block people who were using Tor to commit crimes. In 2012, the country’s police investigators were repeatedly thwarted by a hacker known as the “Demon Killer,” who posted a series of death threats online. The hacker used Tor to successfully evade detection for seven months, which was a major source of embarrassment for Japanese police — and likely fueled demand for new surveillance capabilities.&lt;/p&gt;
&lt;blockquote class=&quot;stylized pull-right&quot; data-shortcode-type=&quot;pullquote&quot; data-pull=&quot;right&quot; readability=&quot;7&quot;&gt;
&lt;p&gt;Snowden told The Intercept that Japanese spies appeared have targeted “entire internet service providers, not just any one customer.”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The directorate’s activities at Tachiarai and elsewhere are aided by an organization called J6, which is a specialist technical unit connected to Japan’s Ministry of Defense, according to sources familiar with its operations. However, the cooperation between the directorate and J6 has been inhibited by the extreme secrecy that is pervasive within the Japanese government, with each agency apparently reluctant to open up to the other about its respective capabilities. In the 2013 presentation, Japanese officials from the directorate described J6’s role to the NSA, but admitted that they had relied on “assumptions” to do so, because “J6 function is not disclosed to us.”&lt;/p&gt;
&lt;p&gt;According to the presentation, the directorate’s role is to carry out surveillance and analyze intelligence. The role of J6 includes analyzing malware and developing countermeasures – such as firewalls – to prevent hacks of Japanese computer systems. A third organization, called the Cabinet Intelligence and Research Organization, or CIRO, is the ultimate beneficiary of intelligence that is collected. Headed by a powerful figure named Shigeru Kitamura, it oversees the work of both the directorate and J6 and is connected to the prime minister’s office, based out of a building known as “H20,” a short walk from the prime minister’s official residence in Tokyo’s Chiyoda district.&lt;/p&gt;
&lt;p&gt;Between 2000 and 2005, prior to development of the MALLARD internet surveillance program, expansion work took place at the Tachiarai facility. At that time, the then-town council chair, Hitoshi Miyahara, was shown a map of the construction plans, which revealed that a tunnel was being built below the base. Miyahara was allowed to visit the construction site, he said, but was prevented from entering the underground area. The current town council chair, Tsutomu Yano, had a similar experience. He visited the facility about four years ago and was shown around a gymnasium, a cafeteria, and a conference room. He was prevented from accessing the underground tunnel and a space he was told was used for “communications.” Yano said he repeatedly questioned the Self-Defense Forces about the Tachiarai facility’s function. But he never received any answers.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Ed Noguchi contributed reporting and translation.&lt;/em&gt;&lt;/p&gt;
&lt;h3&gt;Documents&lt;/h3&gt;
&lt;p&gt;Documents published with this article:&lt;/p&gt;
&lt;p class=&quot;caption&quot;&gt;Top photo: The large antennae inside the secure compound at the Tachiarai surveillance facility.&lt;/p&gt;
&lt;/div&gt;</description>
<pubDate>Mon, 21 May 2018 08:45:28 +0000</pubDate>
<dc:creator>tjomk</dc:creator>
<og:url>https://theintercept.com/2018/05/19/japan-dfs-surveillance-agency/</og:url>
<og:description>Sources reveal a hidden spy center in Tokyo and an internet surveillance program that sweeps up data from satellites.</og:description>
<og:image>https://theintercept.imgix.net/wp-uploads/sites/1/2018/05/tachiarai-feature-1526654534.jpg?auto=compress%2Cformat&amp;q=90&amp;fit=crop&amp;w=1200&amp;h=800</og:image>
<og:type>article</og:type>
<og:title>The Untold Story of Japan’s Secret Spy Agency</og:title>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://theintercept.com/2018/05/19/japan-dfs-surveillance-agency/</dc:identifier>
</item>
<item>
<title>CBS “60 Minutes” piece on Google’s abuse of dominance</title>
<link>https://www.yelpblog.com/2018/05/cbs-60-minutes-piece-on-googles-abuse-of-dominance</link>
<guid isPermaLink="true" >https://www.yelpblog.com/2018/05/cbs-60-minutes-piece-on-googles-abuse-of-dominance</guid>
<description>
&lt;div class=&quot;post-content col-md-8 col-md-offset-2&quot;&gt;
&lt;header&gt;
&lt;div class=&quot;entry-meta vcard small&quot;&gt;&lt;img src=&quot;https://www.yelpblog.com/wp-content/uploads/2016/02/04_04_2011_Yelp_-5634-72x72.jpg&quot; alt=&quot;Luther Lowe&quot; class=&quot;img-responsive img-rounded pull-left photo&quot; width=&quot;36&quot; height=&quot;36&quot;/&gt;&lt;/div&gt;
&lt;/header&gt;&lt;div class=&quot;entry-content&quot; itemprop=&quot;articleBody&quot;&gt;
&lt;p&gt;&lt;strong&gt;Tonight, CBS “60 Minutes” ran a segment about the size and power of Google. The piece speaks for itself and you should watch it:&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;span&gt;Google chose not to participate in the piece, instead offering the following written statement: “Our responsibility is to deliver the best results possible to our users, not specific placements for sites within our results. We understand that those sites whose ranking falls will be unhappy and may complain publicly.”&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span&gt;Yelp did participate in the piece because Google is doing the opposite of “delivering the&lt;/span&gt; &lt;strong&gt;best results possible,&lt;/strong&gt;&lt;span&gt;” and instead is giving its own content an unlawful advantage. We’ve made a video to explain exactly how Google puts its own interests ahead of consumers in local search, which you can watch here:&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;iframe src=&quot;https://www.youtube.com/embed/k9UqqmIJW4g&quot; width=&quot;560&quot; height=&quot;315&quot; frameborder=&quot;0&quot; allowfullscreen=&quot;allowfullscreen&quot;&gt;[embedded content]&lt;/iframe&gt;&lt;/p&gt;
&lt;/div&gt;

&lt;/div&gt;
</description>
<pubDate>Mon, 21 May 2018 05:06:36 +0000</pubDate>
<dc:creator>ericzawo</dc:creator>
<og:type>article</og:type>
<og:title>CBS “60 Minutes” piece on Google's abuse of dominance - Yelp</og:title>
<og:description>Tonight, CBS “60 Minutes” ran a segment about the size and power of Google. The piece speaks for itself and you should watch it: Google chose not to participate in the piece, instead offering the following written statement: “Our responsibility is to deliver the best results possible to our users, not specific placements for sites... Read more</og:description>
<og:url>https://www.yelpblog.com/2018/05/cbs-60-minutes-piece-on-googles-abuse-of-dominance</og:url>
<dc:language>en-US</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.yelpblog.com/2018/05/cbs-60-minutes-piece-on-googles-abuse-of-dominance</dc:identifier>
</item>
<item>
<title>How a Kalman filter works, in pictures (2015)</title>
<link>http://www.bzarg.com/p/how-a-kalman-filter-works-in-pictures/</link>
<guid isPermaLink="true" >http://www.bzarg.com/p/how-a-kalman-filter-works-in-pictures/</guid>
<description>&lt;p&gt;I have to tell you about the Kalman filter, because what it does is pretty damn amazing.&lt;/p&gt;
&lt;p&gt;Surprisingly few software engineers and scientists seem to know about it, and that makes me sad because it is such a general and powerful tool for &lt;strong&gt;combining information&lt;/strong&gt; in the presence of uncertainty. At times its ability to extract accurate information seems almost magical— and if it sounds like I’m talking this up too much, then take a look at &lt;a href=&quot;http://www.bzarg.com/p/improving-imu-attitude-estimates-with-velocity-data&quot;&gt;this previously posted video&lt;/a&gt; where I demonstrate a Kalman filter figuring out the &lt;em&gt;orientation&lt;/em&gt; of a free-floating body by looking at its &lt;em&gt;velocity&lt;/em&gt;. Totally neat!&lt;/p&gt;

&lt;p&gt;You can use a Kalman filter in any place where you have &lt;strong&gt;uncertain information&lt;/strong&gt; about some dynamic system, and you can make an &lt;strong&gt;educated guess&lt;/strong&gt; about what the system is going to do next. Even if messy reality comes along and interferes with the clean motion you guessed about, the Kalman filter will often do a very good job of figuring out what actually happened. And it can take advantage of correlations between crazy phenomena that you maybe wouldn’t have thought to exploit!&lt;/p&gt;
&lt;p&gt;Kalman filters are ideal for systems which are &lt;strong&gt;continuously changing&lt;/strong&gt;. They have the &lt;span id=&quot;more-491&quot;/&gt;advantage that they are light on memory (they don’t need to keep any history other than the previous state), and they are very fast, making them well suited for real time problems and embedded systems.&lt;/p&gt;
&lt;p&gt;The math for implementing the Kalman filter appears pretty scary and opaque in most places you find on Google. That’s a bad state of affairs, because the Kalman filter is actually super simple and easy to understand if you look at it in the right way. Thus it makes a great article topic, and I will attempt to illuminate it with lots of clear, pretty pictures and colors. The prerequisites are simple; all you need is a basic understanding of probability and matrices.&lt;/p&gt;
&lt;p&gt;I’ll start with a loose example of the kind of thing a Kalman filter can solve, but if you want to get right to the shiny pictures and math, feel free to &lt;a href=&quot;http://www.bzarg.com/p/how-a-kalman-filter-works-in-pictures/#mathybits&quot;&gt;jump ahead&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Let’s make a toy example: You’ve built a little robot that can wander around in the woods, and the robot needs to know exactly where it is so that it can navigate.&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-492 size-medium&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/robot_forest-300x160.png&quot; alt=&quot;Your little robot&quot; width=&quot;300&quot; height=&quot;160&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/robot_forest-300x160.png 300w, http://www.bzarg.com/wp-content/uploads/2015/08/robot_forest.png 553w&quot; sizes=&quot;(max-width: 300px) 100vw, 300px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;We’ll say our robot has a state \( \vec{x_k} \), which is just a position and a velocity:&lt;/p&gt;
&lt;p&gt;\(\vec{x_k} = (\vec{p}, \vec{v})\)&lt;/p&gt;
&lt;p&gt;Note that the state is just a list of numbers about the underlying configuration of your system; it could be anything. In our example it’s position and velocity, but it could be data about the amount of fluid in a tank, the temperature of a car engine, the position of a user’s finger on a touchpad, or any number of things you need to keep track of.&lt;/p&gt;
&lt;p&gt;Our robot also has a GPS sensor, which is accurate to about 10 meters, which is good, but it needs to know its location more precisely than 10 meters. There are lots of gullies and cliffs in these woods, and if the robot is wrong by more than a few feet, it could fall off a cliff. So GPS by itself is not good enough.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/robot_ohnoes.png&quot;&gt;&lt;img class=&quot;aligncenter size-medium wp-image-493&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/robot_ohnoes-300x283.png&quot; alt=&quot;Oh no.&quot; width=&quot;300&quot; height=&quot;283&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/robot_ohnoes-300x283.png 300w, http://www.bzarg.com/wp-content/uploads/2015/08/robot_ohnoes.png 403w&quot; sizes=&quot;(max-width: 300px) 100vw, 300px&quot;/&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;We might also know something about how the robot moves: It knows the commands sent to the wheel motors, and its knows that if it’s headed in one direction and nothing interferes, at the next instant it will likely be further along that same direction. But of course it doesn’t know everything about its motion: It might be buffeted by the wind, the wheels might slip a little bit, or roll over bumpy terrain; so the amount the wheels have turned might not exactly represent how far the robot has actually traveled, and the prediction won’t be perfect.&lt;/p&gt;
&lt;p&gt;The GPS &lt;strong&gt;sensor&lt;/strong&gt; tells us something about the state, but only indirectly, and with some uncertainty or inaccuracy. Our &lt;strong&gt;prediction&lt;/strong&gt; tells us something about how the robot is moving, but only indirectly, and with some uncertainty or inaccuracy.&lt;/p&gt;
&lt;p&gt;But if we use all the information available to us, can we get a better answer than &lt;strong&gt;either estimate would give us by itself&lt;/strong&gt;? Of course the answer is yes, and that’s what a Kalman filter is for.&lt;/p&gt;


&lt;p&gt;Let’s look at the landscape we’re trying to interpret. We’ll continue with a simple state having only position and velocity. $$&lt;br/&gt;\vec{x} = \begin{bmatrix}&lt;br/&gt;p\\&lt;br/&gt;v&lt;br/&gt;\end{bmatrix}$$&lt;/p&gt;
&lt;p&gt;We don’t know what the &lt;em&gt;actual&lt;/em&gt; position and velocity are; there are a whole range of possible combinations of position and velocity that might be true, but some of them are more likely than others:&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-504 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_0.png&quot; alt=&quot;gauss_0&quot; width=&quot;310&quot; height=&quot;325&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_0.png 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_0-287x300.png 287w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;The Kalman filter assumes that both variables (postion and velocity, in our case) are random and &lt;em&gt;Gaussian distributed.&lt;/em&gt; Each variable has a &lt;strong&gt;mean&lt;/strong&gt; value \(\mu\), which is the center of the random distribution (and its most likely state), and a &lt;strong&gt;variance&lt;/strong&gt; \(\sigma^2\), which is the uncertainty:&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-503 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_1.png&quot; alt=&quot;gauss_1&quot; width=&quot;310&quot; height=&quot;276&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_1.png 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_1-300x267.png 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;In the above picture, position and velocity are &lt;strong&gt;uncorrelated&lt;/strong&gt;, which means that the state of one variable tells you nothing about what the other might be.&lt;/p&gt;
&lt;p&gt;The example below shows something more interesting: Position and velocity are &lt;strong&gt;correlated&lt;/strong&gt;. The likelihood of observing a particular position depends on what velocity you have:&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-501 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_3.png&quot; alt=&quot;gauss_3&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_3.png 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_3-300x276.png 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;This kind of situation might arise if, for example, we are estimating a new position based on an old one. If our velocity was high, we probably moved farther, so our position will be more distant. If we’re moving slowly, we didn’t get as far.&lt;/p&gt;
&lt;p&gt;This kind of relationship is really important to keep track of, because it gives us &lt;strong&gt;more information:&lt;/strong&gt; One measurement tells us something about what the others could be. And that’s the goal of the Kalman filter, we want to squeeze as much information from our uncertain measurements as we possibly can!&lt;/p&gt;
&lt;p&gt;This correlation is captured by something called a &lt;a href=&quot;https://en.wikipedia.org/wiki/Covariance_matrix&quot;&gt;covariance matrix&lt;/a&gt;. In short, each element of the matrix \(\Sigma_{ij}\) is the degree of correlation between the &lt;em&gt;ith&lt;/em&gt; state variable and the &lt;em&gt;jth&lt;/em&gt; state variable. (You might be able to guess that the covariance matrix is &lt;a href=&quot;https://en.wikipedia.org/wiki/Symmetric_matrix&quot;&gt;symmetric&lt;/a&gt;, which means that it doesn’t matter if you swap &lt;em&gt;i&lt;/em&gt; and &lt;em&gt;j&lt;/em&gt;). Covariance matrices are often labelled “\(\mathbf{\Sigma}\)”, so we call their elements “\(\Sigma_{ij}\)”.&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-502 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_2.png&quot; alt=&quot;gauss_2&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_2.png 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_2-300x276.png 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;

&lt;p&gt;We’re modeling our knowledge about the state as a Gaussian blob, so we need two pieces of information at time \(k\): We’ll call our best estimate \(\mathbf{\hat{x}_k}\) (the mean, elsewhere named \(\mu\) ), and its covariance matrix \(\mathbf{P_k}\). $$&lt;br/&gt;\begin{equation} \label{eq:statevars}&lt;br/&gt;\begin{aligned}&lt;br/&gt;\mathbf{\hat{x}}_k &amp;amp;= \begin{bmatrix}&lt;br/&gt;\text{position}\\&lt;br/&gt;\text{velocity}&lt;br/&gt;\end{bmatrix}\\&lt;br/&gt;\mathbf{P}_k &amp;amp;=&lt;br/&gt;\begin{bmatrix}&lt;br/&gt;\Sigma_{pp} &amp;amp; \Sigma_{pv} \\&lt;br/&gt;\Sigma_{vp} &amp;amp; \Sigma_{vv} \\&lt;br/&gt;\end{bmatrix}&lt;br/&gt;\end{aligned}&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;(Of course we are using only position and velocity here, but it’s useful to remember that the state can contain any number of variables, and represent anything you want).&lt;/p&gt;
&lt;p&gt;Next, we need some way to look at the &lt;span&gt;&lt;strong&gt;current state&lt;/strong&gt;&lt;/span&gt; (at time &lt;span&gt;&lt;strong&gt;k-1&lt;/strong&gt;&lt;/span&gt;) and &lt;strong&gt;predict the &lt;span&gt;next state&lt;/span&gt;&lt;/strong&gt; at time &lt;span&gt;&lt;strong&gt;k&lt;/strong&gt;&lt;/span&gt;. Remember, we don’t know which state is the “real” one, but our prediction function doesn’t care. It just works on &lt;em&gt;all of them&lt;/em&gt;, and gives us a new distribution:&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-590 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_7.jpg&quot; alt=&quot;gauss_7&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_7.jpg 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_7-300x276.jpg 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;We can represent this prediction step with a matrix, \(\mathbf{F_k}\):&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-589 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_8.jpg&quot; alt=&quot;gauss_8&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_8.jpg 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_8-300x276.jpg 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;It takes &lt;em&gt;every point&lt;/em&gt; in our original estimate and moves it to a new predicted location, which is where the system would move if that original estimate was the right one.&lt;/p&gt;
&lt;p&gt;Let’s apply this. How would we use a matrix to predict the position and velocity at the next moment in the future? We’ll use a really basic kinematic formula:$$&lt;br/&gt;\begin{split}&lt;br/&gt;\color{deeppink}{p_k} &amp;amp;= \color{royalblue}{p_{k-1}} + \Delta t &amp;amp;\color{royalblue}{v_{k-1}} \\&lt;br/&gt;\color{deeppink}{v_k} &amp;amp;= &amp;amp;\color{royalblue}{v_{k-1}}&lt;br/&gt;\end{split}&lt;br/&gt;$$ In other words: $$&lt;br/&gt;\begin{align}&lt;br/&gt;\color{deeppink}{\mathbf{\hat{x}}_k} &amp;amp;= \begin{bmatrix}&lt;br/&gt;1 &amp;amp; \Delta t \\&lt;br/&gt;0 &amp;amp; 1&lt;br/&gt;\end{bmatrix} \color{royalblue}{\mathbf{\hat{x}}_{k-1}} \\&lt;br/&gt;&amp;amp;= \mathbf{F}_k \color{royalblue}{\mathbf{\hat{x}}_{k-1}} \label{statevars}&lt;br/&gt;\end{align}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;We now have a &lt;strong&gt;prediction matrix&lt;/strong&gt; which gives us our next state, but we still don’t know how to update the covariance matrix.&lt;/p&gt;
&lt;p&gt;This is where we need another formula. If we multiply every point in a distribution by a matrix \(\color{firebrick}{\mathbf{A}}\), then what happens to its covariance matrix \(\Sigma\)?&lt;/p&gt;
&lt;p&gt;Well, it’s easy. I’ll just give you the identity:$$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{split}&lt;br/&gt;Cov(x) &amp;amp;= \Sigma\\&lt;br/&gt;Cov(\color{firebrick}{\mathbf{A}}x) &amp;amp;= \color{firebrick}{\mathbf{A}} \Sigma \color{firebrick}{\mathbf{A}}^T&lt;br/&gt;\end{split} \label{covident}&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;So combining \(\eqref{covident}\) with equation \(\eqref{statevars}\):$$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{split}&lt;br/&gt;\color{deeppink}{\mathbf{\hat{x}}_k} &amp;amp;= \mathbf{F}_k \color{royalblue}{\mathbf{\hat{x}}_{k-1}} \\&lt;br/&gt;\color{deeppink}{\mathbf{P}_k} &amp;amp;= \mathbf{F_k} \color{royalblue}{\mathbf{P}_{k-1}} \mathbf{F}_k^T&lt;br/&gt;\end{split}&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;h2&gt;External influence&lt;/h2&gt;
&lt;p&gt;We haven’t captured everything, though. There might be some changes that &lt;strong&gt;aren’t related to the state&lt;/strong&gt; itself— the outside world could be affecting the system.&lt;/p&gt;
&lt;p&gt;For example, if the state models the motion of a train, the train operator might push on the throttle, causing the train to accelerate. Similarly, in our robot example, the navigation software might issue a command to turn the wheels or stop. If we know this additional information about what’s going on in the world, we could stuff it into a vector called \(\color{darkorange}{\vec{\mathbf{u}_k}}\), do something with it, and add it to our prediction as a correction.&lt;/p&gt;
&lt;p&gt;Let’s say we know the expected acceleration \(\color{darkorange}{a}\) due to the throttle setting or control commands. From basic kinematics we get: $$&lt;br/&gt;\begin{split}&lt;br/&gt;\color{deeppink}{p_k} &amp;amp;= \color{royalblue}{p_{k-1}} + {\Delta t} &amp;amp;\color{royalblue}{v_{k-1}} + &amp;amp;\frac{1}{2} \color{darkorange}{a} {\Delta t}^2 \\&lt;br/&gt;\color{deeppink}{v_k} &amp;amp;= &amp;amp;\color{royalblue}{v_{k-1}} + &amp;amp; \color{darkorange}{a} {\Delta t}&lt;br/&gt;\end{split}&lt;br/&gt;$$ In matrix form: $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{split}&lt;br/&gt;\color{deeppink}{\mathbf{\hat{x}}_k} &amp;amp;= \mathbf{F}_k \color{royalblue}{\mathbf{\hat{x}}_{k-1}} + \begin{bmatrix}&lt;br/&gt;\frac{\Delta t^2}{2} \\&lt;br/&gt;\Delta t&lt;br/&gt;\end{bmatrix} \color{darkorange}{a} \\&lt;br/&gt;&amp;amp;= \mathbf{F}_k \color{royalblue}{\mathbf{\hat{x}}_{k-1}} + \mathbf{B}_k \color{darkorange}{\vec{\mathbf{u}_k}}&lt;br/&gt;\end{split}&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;\(\mathbf{B}_k\) is called the &lt;strong&gt;control matrix&lt;/strong&gt; and \(\color{darkorange}{\vec{\mathbf{u}_k}}\) the &lt;strong&gt;control vector.&lt;/strong&gt; (For very simple systems with no external influence, you could omit these).&lt;/p&gt;
&lt;p&gt;Let’s add one more detail. What happens if our prediction is not a 100% accurate model of what’s actually going on?&lt;/p&gt;
&lt;h2&gt;External uncertainty&lt;/h2&gt;
&lt;p&gt;Everything is fine if the state evolves based on its own properties. Everything is &lt;em&gt;still&lt;/em&gt; fine if the state evolves based on external forces, so long as we know what those external forces are.&lt;/p&gt;
&lt;p&gt;But what about forces that we &lt;em&gt;don’t&lt;/em&gt; know about? If we’re tracking a quadcopter, for example, it could be buffeted around by wind. If we’re tracking a wheeled robot, the wheels could slip, or bumps on the ground could slow it down. We can’t keep track of these things, and if any of this happens, our prediction could be off because we didn’t account for those extra forces.&lt;/p&gt;
&lt;p&gt;We can model the uncertainty associated with the “world” (i.e. things we aren’t keeping track of) by adding some new uncertainty after every prediction step:&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter size-full wp-image-631&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_9.jpg&quot; alt=&quot;gauss_9&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_9.jpg 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_9-300x276.jpg 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Every state in our original estimate could have moved to a &lt;em&gt;range&lt;/em&gt; of states. Because we like Gaussian blobs so much, we’ll say that each point in \(\color{royalblue}{\mathbf{\hat{x}}_{k-1}}\) is moved to somewhere inside a Gaussian blob with covariance \(\color{mediumaquamarine}{\mathbf{Q}_k}\). Another way to say this is that we are treating the untracked influences as &lt;strong&gt;noise&lt;/strong&gt; with covariance \(\color{mediumaquamarine}{\mathbf{Q}_k}\).&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_10a.jpg&quot;&gt;&lt;img class=&quot;aligncenter size-full wp-image-639&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_10a.jpg&quot; alt=&quot;gauss_10a&quot; width=&quot;310&quot; height=&quot;310&quot;/&gt;&lt;/a&gt;This produces a new Gaussian blob, with a different covariance (but the same mean):&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter size-full wp-image-638&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_10b.jpg&quot; alt=&quot;gauss_10b&quot; width=&quot;310&quot; height=&quot;310&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_10b.jpg 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_10b-150x150.jpg 150w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_10b-300x300.jpg 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;We get the expanded covariance by simply &lt;strong&gt;adding&lt;/strong&gt; \({\color{mediumaquamarine}{\mathbf{Q}_k}}\), giving our complete expression for the &lt;strong&gt;prediction step&lt;/strong&gt;: $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{split}&lt;br/&gt;\color{deeppink}{\mathbf{\hat{x}}_k} &amp;amp;= \mathbf{F}_k \color{royalblue}{\mathbf{\hat{x}}_{k-1}} + \mathbf{B}_k \color{darkorange}{\vec{\mathbf{u}_k}} \\&lt;br/&gt;\color{deeppink}{\mathbf{P}_k} &amp;amp;= \mathbf{F_k} \color{royalblue}{\mathbf{P}_{k-1}} \mathbf{F}_k^T + \color{mediumaquamarine}{\mathbf{Q}_k}&lt;br/&gt;\end{split}&lt;br/&gt;\label{kalpredictfull}&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;In other words, the &lt;span&gt;&lt;strong&gt;new best estimate&lt;/strong&gt;&lt;/span&gt; is a &lt;strong&gt;prediction&lt;/strong&gt; made from &lt;span&gt;&lt;strong&gt;previous best estimate&lt;/strong&gt;&lt;/span&gt;, plus a &lt;strong&gt;correction&lt;/strong&gt; for &lt;span&gt;&lt;strong&gt;known external influences&lt;/strong&gt;&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;And the &lt;span&gt;&lt;strong&gt;new uncertainty&lt;/strong&gt;&lt;/span&gt; is &lt;strong&gt;predicted&lt;/strong&gt; from the &lt;span&gt;&lt;strong&gt;old uncertainty&lt;/strong&gt;&lt;/span&gt;, with some &lt;span&gt;&lt;strong&gt;additional uncertainty from the environment&lt;/strong&gt;&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;All right, so that’s easy enough. We have a fuzzy estimate of where our system might be, given by \(\color{deeppink}{\mathbf{\hat{x}}_k}\) and \(\color{deeppink}{\mathbf{P}_k}\). What happens when we get some data from our sensors?&lt;/p&gt;

&lt;p&gt;We might have several sensors which give us information about the state of our system. For the time being it doesn’t matter what they measure; perhaps one reads position and the other reads velocity. Each sensor tells us something &lt;strong&gt;indirect&lt;/strong&gt; about the state— in other words, the sensors operate on a state and produce a set of &lt;strong&gt;readings&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter size-full wp-image-652&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_12.jpg&quot; alt=&quot;gauss_12&quot; width=&quot;621&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_12.jpg 1242w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_12-300x138.jpg 300w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_12-1024x472.jpg 1024w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_12-624x287.jpg 624w&quot; sizes=&quot;(max-width: 621px) 100vw, 621px&quot;/&gt;Notice that the units and scale of the reading might not be the same as the units and scale of the state we’re keeping track of. You might be able to guess where this is going: We’ll model the sensors with a matrix, \(\mathbf{H}_k\).&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter size-full wp-image-652&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_13.jpg&quot; alt=&quot;gauss_12&quot; width=&quot;621&quot; height=&quot;286&quot;/&gt;&lt;/p&gt;
&lt;p&gt;We can figure out the distribution of sensor readings we’d expect to see in the usual way: $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{aligned}&lt;br/&gt;\vec{\mu}_{\text{expected}} &amp;amp;= \mathbf{H}_k \color{deeppink}{\mathbf{\hat{x}}_k} \\&lt;br/&gt;\mathbf{\Sigma}_{\text{expected}} &amp;amp;= \mathbf{H}_k \color{deeppink}{\mathbf{P}_k} \mathbf{H}_k^T&lt;br/&gt;\end{aligned}&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;One thing that Kalman filters are great for is dealing with &lt;em&gt;sensor noise&lt;/em&gt;. In other words, our sensors are at least somewhat unreliable, and every state in our original estimate might result in a &lt;em&gt;range&lt;/em&gt; of sensor readings. &lt;img class=&quot;aligncenter size-full wp-image-652&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_14.jpg&quot; alt=&quot;gauss_12&quot; width=&quot;621&quot; height=&quot;286&quot;/&gt;&lt;/p&gt;
&lt;p&gt;From each reading we observe, we might guess that our system was in a particular state. But because there is uncertainty, &lt;strong&gt;some states are more likely than others&lt;/strong&gt; to have have produced the reading we saw:&lt;img class=&quot;aligncenter size-full wp-image-651&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_11.jpg&quot; alt=&quot;gauss_11&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_11.jpg 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_11-300x276.jpg 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;We’ll call the &lt;strong&gt;covariance&lt;/strong&gt; of this uncertainty (i.e. of the sensor noise) \(\color{mediumaquamarine}{\mathbf{R}_k}\). The distribution has a &lt;strong&gt;mean&lt;/strong&gt; equal to the reading we observed, which we’ll call \(\color{yellowgreen}{\vec{\mathbf{z}_k}}\).&lt;/p&gt;
&lt;p&gt;So now we have two Gaussian blobs: One surrounding the mean of our transformed prediction, and one surrounding the actual sensor reading we got.&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-500 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_4.jpg&quot; alt=&quot;gauss_4&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_4.jpg 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_4-300x276.jpg 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;We must try to reconcile our guess about the readings we’d see based on the &lt;strong&gt;predicted state&lt;/strong&gt; (&lt;span&gt;&lt;strong&gt;pink&lt;/strong&gt;&lt;/span&gt;) with a &lt;em&gt;different&lt;/em&gt; guess based on our &lt;strong&gt;sensor readings&lt;/strong&gt; (&lt;span&gt;&lt;strong&gt;green&lt;/strong&gt;&lt;/span&gt;) that we actually observed.&lt;/p&gt;
&lt;p&gt;So what’s our new most likely state? For any possible reading \((z_1,z_2)\), we have two associated probabilities: &lt;span&gt;(1)&lt;/span&gt; The probability that our sensor reading \(\color{yellowgreen}{\vec{\mathbf{z}_k}}\) is a (mis-)measurement of \((z_1,z_2)\), and &lt;span&gt;(2)&lt;/span&gt; the probability that our previous estimate thinks \((z_1,z_2)\) is the reading we should see.&lt;/p&gt;
&lt;p&gt;If we have two probabilities and we want to know the chance that &lt;em&gt;both&lt;/em&gt; are true, we just multiply them together. So, we take the two Gaussian blobs and multiply them:&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter wp-image-499 size-full&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_6a.png&quot; alt=&quot;gauss_5&quot; width=&quot;310&quot; height=&quot;286&quot;/&gt;&lt;/p&gt;
&lt;p&gt;What we’re left with is the &lt;strong&gt;overlap&lt;/strong&gt;, the region where &lt;em&gt;both&lt;/em&gt; blobs are bright/likely. And it’s a lot more precise than either of our previous estimates. The mean of this distribution is the configuration for which &lt;strong&gt;both estimates are most likely&lt;/strong&gt;, and is therefore the &lt;strong&gt;best guess&lt;/strong&gt; of the true configuration given all the information we have.&lt;/p&gt;
&lt;p&gt;Hmm. This looks like another Gaussian blob.&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter size-full wp-image-498&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_6.png&quot; alt=&quot;gauss_6&quot; width=&quot;310&quot; height=&quot;286&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_6.png 621w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_6-300x276.png 300w&quot; sizes=&quot;(max-width: 310px) 100vw, 310px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;As it turns out, when you multiply two Gaussian blobs with separate means and covariance matrices, you get a &lt;em&gt;new&lt;/em&gt; Gaussian blob with its &lt;strong&gt;own&lt;/strong&gt; mean and covariance matrix! Maybe you can see where this is going: There’s got to be a formula to get those new parameters from the old ones!&lt;/p&gt;

&lt;p&gt;Let’s find that formula. It’s easiest to look at this first in &lt;strong&gt;one dimension&lt;/strong&gt;. A 1D Gaussian bell curve with variance \(\sigma^2\) and mean \(\mu\) is defined as: $$&lt;br/&gt;\begin{equation} \label{gaussformula}&lt;br/&gt;\mathcal{N}(x, \mu,\sigma) = \frac{1}{ \sigma \sqrt{ 2\pi } } e^{ -\frac{ (x – \mu)^2 }{ 2\sigma^2 } }&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;We want to know what happens when you multiply two Gaussian curves together. The blue curve below represents the (unnormalized) intersection of the two Gaussian populations:&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;aligncenter size-full wp-image-525&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_joint.png&quot; alt=&quot;Multiplying Gaussians&quot; width=&quot;589&quot; height=&quot;381&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/gauss_joint.png 589w, http://www.bzarg.com/wp-content/uploads/2015/08/gauss_joint-300x194.png 300w&quot; sizes=&quot;(max-width: 589px) 100vw, 589px&quot;/&gt;&lt;/p&gt;
&lt;p&gt;$$\begin{equation} \label{gaussequiv}&lt;br/&gt;\mathcal{N}(x, \color{fuchsia}{\mu_0}, \color{deeppink}{\sigma_0}) \cdot \mathcal{N}(x, \color{yellowgreen}{\mu_1}, \color{mediumaquamarine}{\sigma_1}) \stackrel{?}{=} \mathcal{N}(x, \color{royalblue}{\mu’}, \color{mediumblue}{\sigma’})&lt;br/&gt;\end{equation}$$&lt;/p&gt;
&lt;p&gt;You can substitute equation \(\eqref{gaussformula}\) into equation \(\eqref{gaussequiv}\) and do some algebra (being careful to renormalize, so that the total probability is 1) to obtain: $$&lt;br/&gt;\begin{equation} \label{fusionformula}&lt;br/&gt;\begin{aligned}&lt;br/&gt;\color{royalblue}{\mu’} &amp;amp;= \mu_0 + \frac{\sigma_0^2 (\mu_1 – \mu_0)} {\sigma_0^2 + \sigma_1^2}\\&lt;br/&gt;\color{mediumblue}{\sigma’}^2 &amp;amp;= \sigma_0^2 – \frac{\sigma_0^4} {\sigma_0^2 + \sigma_1^2}&lt;br/&gt;\end{aligned}&lt;br/&gt;\end{equation}$$&lt;/p&gt;
&lt;p&gt;We can simplify by factoring out a little piece and calling it \(\color{purple}{\mathbf{k}}\): $$&lt;br/&gt;\begin{equation} \label{gainformula}&lt;br/&gt;\color{purple}{\mathbf{k}} = \frac{\sigma_0^2}{\sigma_0^2 + \sigma_1^2}&lt;br/&gt;\end{equation} $$ $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{split}&lt;br/&gt;\color{royalblue}{\mu’} &amp;amp;= \mu_0 + &amp;amp;\color{purple}{\mathbf{k}} (\mu_1 – \mu_0)\\&lt;br/&gt;\color{mediumblue}{\sigma’}^2 &amp;amp;= \sigma_0^2 – &amp;amp;\color{purple}{\mathbf{k}} \sigma_0^2&lt;br/&gt;\end{split} \label{update}&lt;br/&gt;\end{equation} $$&lt;/p&gt;
&lt;p&gt;Take note of how you can take your previous estimate and &lt;strong&gt;add something&lt;/strong&gt; to make a new estimate. And look at how simple that formula is!&lt;/p&gt;
&lt;p&gt;But what about a matrix version? Well, let’s just re-write equations \(\eqref{gainformula}\) and \(\eqref{update}\) in matrix form. If \(\Sigma\) is the covariance matrix of a Gaussian blob, and \(\vec{\mu}\) its mean along each axis, then: $$&lt;br/&gt;\begin{equation} \label{matrixgain}&lt;br/&gt;\color{purple}{\mathbf{K}} = \Sigma_0 (\Sigma_0 + \Sigma_1)^{-1}&lt;br/&gt;\end{equation} $$ $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{split}&lt;br/&gt;\color{royalblue}{\vec{\mu}’} &amp;amp;= \vec{\mu_0} + &amp;amp;\color{purple}{\mathbf{K}} (\vec{\mu_1} – \vec{\mu_0})\\&lt;br/&gt;\color{mediumblue}{\Sigma’} &amp;amp;= \Sigma_0 – &amp;amp;\color{purple}{\mathbf{K}} \Sigma_0&lt;br/&gt;\end{split} \label{matrixupdate}&lt;br/&gt;\end{equation}&lt;br/&gt;$$&lt;/p&gt;
&lt;p&gt;\(\color{purple}{\mathbf{K}}\) is a matrix called the &lt;strong&gt;Kalman gain&lt;/strong&gt;, and we’ll use it in just a moment.&lt;/p&gt;
&lt;p&gt;Easy! We’re almost finished!&lt;/p&gt;

&lt;p&gt;We have two distributions: The predicted measurement with \( (\color{fuchsia}{\mu_0}, \color{deeppink}{\Sigma_0}) = (\color{fuchsia}{\mathbf{H}_k \mathbf{\hat{x}}_k}, \color{deeppink}{\mathbf{H}_k \mathbf{P}_k \mathbf{H}_k^T}) \), and the observed measurement with \( (\color{yellowgreen}{\mu_1}, \color{mediumaquamarine}{\Sigma_1}) = (\color{yellowgreen}{\vec{\mathbf{z}_k}}, \color{mediumaquamarine}{\mathbf{R}_k})\). We can just plug these into equation \(\eqref{matrixupdate}\) to find their overlap: $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{aligned}&lt;br/&gt;\mathbf{H}_k \color{royalblue}{\mathbf{\hat{x}}_k’} &amp;amp;= \color{fuchsia}{\mathbf{H}_k \mathbf{\hat{x}}_k} &amp;amp; + &amp;amp; \color{purple}{\mathbf{K}} ( \color{yellowgreen}{\vec{\mathbf{z}_k}} – \color{fuchsia}{\mathbf{H}_k \mathbf{\hat{x}}_k} ) \\&lt;br/&gt;\mathbf{H}_k \color{royalblue}{\mathbf{P}_k’} \mathbf{H}_k^T &amp;amp;= \color{deeppink}{\mathbf{H}_k \mathbf{P}_k \mathbf{H}_k^T} &amp;amp; – &amp;amp; \color{purple}{\mathbf{K}} \color{deeppink}{\mathbf{H}_k \mathbf{P}_k \mathbf{H}_k^T}&lt;br/&gt;\end{aligned} \label {kalunsimplified}&lt;br/&gt;\end{equation}&lt;br/&gt;$$ And from \(\eqref{matrixgain}\), the Kalman gain is: $$&lt;br/&gt;\begin{equation} \label{eq:kalgainunsimplified}&lt;br/&gt;\color{purple}{\mathbf{K}} = \color{deeppink}{\mathbf{H}_k \mathbf{P}_k \mathbf{H}_k^T} ( \color{deeppink}{\mathbf{H}_k \mathbf{P}_k \mathbf{H}_k^T} + \color{mediumaquamarine}{\mathbf{R}_k})^{-1}&lt;br/&gt;\end{equation}&lt;br/&gt;$$ We can knock an \(\mathbf{H}_k\) off the front of every term in \(\eqref{kalunsimplified}\) and \(\eqref{eq:kalgainunsimplified}\) (note that one is hiding inside \(\color{purple}{\mathbf{K}}\) ), and an \(\mathbf{H}_k^T\) off the end of all terms in the equation for \(\color{royalblue}{\mathbf{P}_k’}\). $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\begin{split}&lt;br/&gt;\color{royalblue}{\mathbf{\hat{x}}_k’} &amp;amp;= \color{fuchsia}{\mathbf{\hat{x}}_k} &amp;amp; + &amp;amp; \color{purple}{\mathbf{K}’} ( \color{yellowgreen}{\vec{\mathbf{z}_k}} – \color{fuchsia}{\mathbf{H}_k \mathbf{\hat{x}}_k} ) \\&lt;br/&gt;\color{royalblue}{\mathbf{P}_k’} &amp;amp;= \color{deeppink}{\mathbf{P}_k} &amp;amp; – &amp;amp; \color{purple}{\mathbf{K}’} \color{deeppink}{\mathbf{H}_k \mathbf{P}_k}&lt;br/&gt;\end{split}&lt;br/&gt;\label{kalupdatefull}&lt;br/&gt;\end{equation} $$ $$&lt;br/&gt;\begin{equation}&lt;br/&gt;\color{purple}{\mathbf{K}’} = \color{deeppink}{\mathbf{P}_k \mathbf{H}_k^T} ( \color{deeppink}{\mathbf{H}_k \mathbf{P}_k \mathbf{H}_k^T} + \color{mediumaquamarine}{\mathbf{R}_k})^{-1}&lt;br/&gt;\label{kalgainfull}&lt;br/&gt;\end{equation}&lt;br/&gt;$$ …giving us the complete equations for the &lt;strong&gt;update step.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;And that’s it! \(\color{royalblue}{\mathbf{\hat{x}}_k’}\) is our new best estimate, and we can go on and feed it (along with \( \color{royalblue}{\mathbf{P}_k’} \) ) back into another round of &lt;strong&gt;predict&lt;/strong&gt; or &lt;strong&gt;update&lt;/strong&gt; as many times as we like.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/kalflow.png&quot;&gt;&lt;img class=&quot;aligncenter size-full wp-image-721&quot; src=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/kalflow.png&quot; alt=&quot;Kalman filter information flow diagram&quot; width=&quot;850&quot; height=&quot;1100&quot; srcset=&quot;http://www.bzarg.com/wp-content/uploads/2015/08/kalflow.png 850w, http://www.bzarg.com/wp-content/uploads/2015/08/kalflow-232x300.png 232w, http://www.bzarg.com/wp-content/uploads/2015/08/kalflow-791x1024.png 791w, http://www.bzarg.com/wp-content/uploads/2015/08/kalflow-624x808.png 624w&quot; sizes=&quot;(max-width: 850px) 100vw, 850px&quot;/&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Of all the math above, all you need to implement are equations \(\eqref{kalpredictfull}, \eqref{kalupdatefull}\), and \(\eqref{kalgainfull}\). (Or if you forget those, you could re-derive everything from equations \(\eqref{covident}\) and \(\eqref{matrixupdate}\).)&lt;/p&gt;
&lt;p&gt;This will allow you to model any linear system accurately. For nonlinear systems, we use the &lt;strong&gt;extended Kalman filter&lt;/strong&gt;, which works by simply linearizing the predictions and measurements about their mean. (I may do a second write-up on the EKF in the future).&lt;/p&gt;
&lt;p&gt;If I’ve done my job well, hopefully someone else out there will realize how cool these things are and come up with an unexpected new place to put them into action.&lt;/p&gt;
&lt;hr/&gt;
&lt;p&gt;Some credit and referral should be given to &lt;a href=&quot;http://www.cl.cam.ac.uk/~rmf25/papers/Understanding%20the%20Basis%20of%20the%20Kalman%20Filter.pdf&quot;&gt;this fine document&lt;/a&gt;, which uses a similar approach involving overlapping Gaussians. More in-depth derivations can be found there, for the curious.&lt;/p&gt;
&lt;p/&gt;

</description>
<pubDate>Mon, 21 May 2018 04:32:14 +0000</pubDate>
<dc:creator>sytelus</dc:creator>
<dc:language>en-US</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>http://www.bzarg.com/p/how-a-kalman-filter-works-in-pictures/</dc:identifier>
</item>
<item>
<title>Apps for which macOS applies compatibillity fixes</title>
<link>https://worthdoingbadly.com/appkitcompat/</link>
<guid isPermaLink="true" >https://worthdoingbadly.com/appkitcompat/</guid>
<description>&lt;p&gt;What do Photoshop, Matlab, Panic Transmit, and Eclipse have in common? They are among the 299 apps for which macOS applies compatibillity fixes.&lt;/p&gt;
&lt;p&gt;Here’s the &lt;a href=&quot;https://worthdoingbadly.com/assets/blog/appkitcompat/appkit_processed.html&quot;&gt;full list of bundle IDs&lt;/a&gt;, along with the functions that checks for them, and the first caller to those functions. It’s also available in &lt;a href=&quot;https://worthdoingbadly.com/assets/blog/appkitcompat/appkit.csv&quot;&gt;CSV format&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Note that this is just a list of apps Apple has developed compatibility tweaks to make them run on newer macOS versions. As the list demonstrates, even the best apps often needs some tweaks on newer macOS. In addition, most of these patches are only applied to older versions of apps.&lt;/p&gt;
&lt;p&gt;Here’s how I extracted the list, and some interesting things I found in it.&lt;/p&gt;
&lt;h2 id=&quot;how-i-learned-about-this&quot;&gt;How I learned about this&lt;/h2&gt;
&lt;p&gt;While browsing &lt;a href=&quot;https://twitter.com/stroughtonsmith&quot;&gt;@stroughtonsmith&lt;/a&gt;’s Twitter feed, I saw this tweet from &lt;a href=&quot;https://twitter.com/b3ll&quot;&gt;@b3ll&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;You know you’ve really made it when NSImage explicitly checks for your bundle&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://worthdoingbadly.com/assets/blog/appkitcompat/b3ll_tweet.jpg&quot; width=&quot;560&quot;/&gt;&lt;/p&gt;
&lt;p&gt;Adam Bell (@b3ll), &lt;a href=&quot;https://twitter.com/b3ll/status/994665524448583682&quot;&gt;May 10, 2018&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;This was interesting: I always thought that Apple was not as thorough about compatibility as Microsoft. But a later reply dropped an even crazier tidbit:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;AppKit has hundreds of bundle ID checks for various reasons&lt;/p&gt;
&lt;p&gt;Guilherme Rambo (@_inside), &lt;a href=&quot;https://twitter.com/_inside/status/994669723731275777&quot;&gt;May 10, 2018&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Hundreds? I gotta take a look at this.&lt;/p&gt;
&lt;p&gt;Others, such as &lt;a href=&quot;https://twitter.com/0xced&quot;&gt;0xced&lt;/a&gt; had &lt;a href=&quot;https://twitter.com/0xced/status/429727057594290176&quot;&gt;asked about this&lt;/a&gt; before: it turns out Apple calls them &lt;a href=&quot;https://twitter.com/LegNeato/status/429885180275208192&quot;&gt;“checkfixes”&lt;/a&gt; internally.&lt;/p&gt;
&lt;h2 id=&quot;which-apps&quot;&gt;Which apps?&lt;/h2&gt;
&lt;p&gt;Compatibility fixes are applied by checking the&lt;/p&gt;
&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;bool __CFAppVersionCheckLessThan(CFStringRef, CFSystemVersion)&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;function, which returns true if the current app matches the specified bundle ID and is linked on or prior to the macOS version. Thus, older versions of the app would have the fix applied, while newer versions built with a newer SDK would not.&lt;/p&gt;
&lt;p&gt;I found 299 unique app IDs passed into &lt;code class=&quot;highlighter-rouge&quot;&gt;__CFAppVersionCheckLessThan&lt;/code&gt; by statically analyzing AppKit, Foundation, and CoreFoundation on macOS 10.13.4.&lt;/p&gt;
&lt;p&gt;Apple itself tops the list with 64 unique app IDs: this is expected, since Apple likely used tricks and private APIs third parties couldn’t use, causing compatibility issues down the line.&lt;/p&gt;
&lt;p&gt;Adobe, of course, is second place with 31 bundle IDs.&lt;/p&gt;
&lt;p&gt;Looking through the list of apps tells a lot about what apps Apple considers essential to the Mac platform: after all, they put special effort to make them work on newer system versions. So what apps do Apple consider important?&lt;/p&gt;
&lt;p&gt;Productivity apps from large companies:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;most of the Adobe suite&lt;/li&gt;
&lt;li&gt;the Microsoft Office suite&lt;/li&gt;
&lt;li&gt;Autodesk’s AutoCAD and Maya&lt;/li&gt;
&lt;li&gt;Matlab&lt;/li&gt;
&lt;li&gt;Ableton Live&lt;/li&gt;
&lt;li&gt;Intuit Quicken/QuickBooks&lt;/li&gt;
&lt;li&gt;TurboCAD&lt;/li&gt;
&lt;li&gt;VMWare Fusion&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Communication apps:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Google Chrome&lt;/li&gt;
&lt;li&gt;Opera Browser&lt;/li&gt;
&lt;li&gt;Twitter for Mac&lt;/li&gt;
&lt;li&gt;Tencent QQ, WeChat&lt;/li&gt;
&lt;li&gt;AOL Messenger&lt;/li&gt;
&lt;li&gt;Citrix GoToMeeting&lt;/li&gt;
&lt;li&gt;Cisco Spark&lt;/li&gt;
&lt;li&gt;HipChat&lt;/li&gt;
&lt;li&gt;Sketch&lt;/li&gt;
&lt;li&gt;Spotify&lt;/li&gt;
&lt;li&gt;Evernote&lt;/li&gt;
&lt;li&gt;Dropbox&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Surprisingly high number of games. I suspect there are even more IDs in game-specific libraries such as OpenGL.&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Blizzard’s games: installer, Diablo 3, Heroes of the Storm, Starcraft 2, World of Warcraft, Hearthstone, and Battle.NET&lt;/li&gt;
&lt;li&gt;Grid 2 Reloaded&lt;/li&gt;
&lt;li&gt;Dragon Age 2 (of course)&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Open-source apps:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Firefox&lt;/li&gt;
&lt;li&gt;VLC&lt;/li&gt;
&lt;li&gt;Blender&lt;/li&gt;
&lt;li&gt;Eclipse&lt;/li&gt;
&lt;li&gt;AquaMacs (an Emacs port)&lt;/li&gt;
&lt;li&gt;OpenJDK&lt;/li&gt;
&lt;li&gt;Textual IRC&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Indie favorites:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Panic’s Coda and Transmit&lt;/li&gt;
&lt;li&gt;Omni Group’s OmniFocus, OmniGraffle, OmniPlan, and OmniWeb&lt;/li&gt;
&lt;li&gt;Sketch&lt;/li&gt;
&lt;li&gt;1Password&lt;/li&gt;
&lt;li&gt;BBEdit/TextWrangler&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Device drivers, because the manufacturers ain’t gonna fix ‘em&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Garmin TrainingCenter&lt;/li&gt;
&lt;li&gt;Epson xp640&lt;/li&gt;
&lt;li&gt;HP Installer&lt;/li&gt;
&lt;li&gt;Fujitsu ScanSnap&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Apple Internal apps:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;com.apple.ist.Merlin&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;com.apple.ist.Radar7&lt;/code&gt; (probably the most ironic)&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;com.apple.ist.SoftwareDepot.Checker&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;com.apple.ist.appledirectory4&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;com.apple.ist.hr.Merlin&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;and many other apps I haven’t heard of.&lt;/p&gt;
&lt;p&gt;The breadth of software is staggering, and shows how much testing Apple must do to discover these bugs. (instead of testing for, say, the click-to-root bug in High Sierra ;) )&lt;/p&gt;
&lt;h2 id=&quot;what-a-patch-looks-like&quot;&gt;What a patch looks like&lt;/h2&gt;
&lt;p&gt;The patches don’t change behaviour drastically. They aren’t as crazy as the Windows backward compatibility patches &lt;a href=&quot;https://blogs.msdn.microsoft.com/oldnewthing/&quot;&gt;Raymond Chen&lt;/a&gt; writes about. The patch to &lt;code class=&quot;highlighter-rouge&quot;&gt;NSOpenGLContext.currentContext()&lt;/code&gt;, for example, is very simple: here’s the IDA graph view of the function.&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://worthdoingbadly.com/assets/blog/appkitcompat/nsopenglcontext.png&quot; width=&quot;797&quot;/&gt;&lt;/p&gt;
&lt;p&gt;My attempt at translating it to pseudocode makes it clear that the only compatibility change is adding an &lt;code class=&quot;highlighter-rouge&quot;&gt;autoreleasepool&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;class NSOpenGLContext {
    class func currentContext() -&amp;gt; NSOpenGLContext {
        if __CFAppVersionCheckLessThan(&quot;com.microsoft.Powerpoint&quot;, CFSystemVersionYosemite) {
            autoreleasepool {
                let cglContext = _CGLGetCurrentContext();
                pthread_mutex_lock(__NSOpenGLContextToCGLContextObjMapLock)
                let context = __NSOpenGLContextToCGLContextObjMap[cglContext]
                pthread_mutex_unlock(__NSOpenGLContextToCGLContextObjMapLock)
                return context
            }
        } else {
            // no autorelease pool!
            let cglContext = _CGLGetCurrentContext();
            pthread_mutex_lock(__NSOpenGLContextToCGLContextObjMapLock)
            let context = __NSOpenGLContextToCGLContextObjMap[cglContext]
            pthread_mutex_unlock(__NSOpenGLContextToCGLContextObjMapLock)
            return context
        }
    }
}
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;Other patches are similarily small: the Dragon Age 2 patch @b3ll found makes &lt;a href=&quot;https://developer.apple.com/documentation/foundation/bundle/1519901-image&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;-[NSBundle imageForResource:]&lt;/code&gt;&lt;/a&gt; call &lt;code class=&quot;highlighter-rouge&quot;&gt;-[Bundle pathForImageResource:&lt;/code&gt; instead of &lt;code class=&quot;highlighter-rouge&quot;&gt;Bundle URLsForImageResource:]&lt;/code&gt;, and creates the image using the file instead of the URLs.&lt;/p&gt;
&lt;h2 id=&quot;stuff-i-noticed-in-the-list-of-apps&quot;&gt;Stuff I noticed in the list of apps&lt;/h2&gt;
&lt;p&gt;Microsoft Excel/PowerPoint/Word have a patch in &lt;code class=&quot;highlighter-rouge&quot;&gt;_CFArraySortValues&lt;/code&gt; to change the sorting algorithm slightly. How do you break sorting?!&lt;/p&gt;
&lt;p&gt;25 apps had &lt;a href=&quot;https://indiestack.com/2016/10/window-tabbing-pox/&quot;&gt;automatic tabbing&lt;/a&gt; (introduced in Sierra) disabled using the compatibility feature.&lt;/p&gt;
&lt;p&gt;Some compatiblity patches only affects apps from one company: for example, &lt;code class=&quot;highlighter-rouge&quot;&gt;_NSSavePanelUseLocalhostURLsDefaultValueFunction&lt;/code&gt; fixes the save panel for a bunch of Adobe apps.&lt;/p&gt;
&lt;p&gt;Other compatibility patches affect apps from many different developers: for example, &lt;code class=&quot;highlighter-rouge&quot;&gt;NSTableView&lt;/code&gt; related patches affected apps from HP Installer to Sketch to TeamViewer, demonstrating that Tables Are Hard&lt;sup&gt;TM&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Photoshop and VectorWorks CAD have Touch Bar API patches: The Touch Bar API is so new that I’m surposed there’s already compatibility issues.&lt;/p&gt;
&lt;p&gt;Most of the preference methods are named after the behaviours they change, but Eclipse, VMWare, Dragon Age 2, Apple Keynote, Apple Motion, and the Microsoft Office suite have the dubious honour of getting patch methods specifically named after them.&lt;/p&gt;
&lt;p&gt;On the list, there are system apps such as &lt;code class=&quot;highlighter-rouge&quot;&gt;com.apple.loginwindow&lt;/code&gt;: why would they need compatibility patches?! I guess Apple’s using the compatibility system to patch other things/change behaviour for specific system apps. Shouldn’t that be done via, say, method swizzling by the app itself, instead of in the framework?&lt;/p&gt;
&lt;p&gt;Some patches seems to turn on slower code paths: for example, 12 apps are checked in &lt;code class=&quot;highlighter-rouge&quot;&gt;_NSCGSIsSynchronousM7DefaultValueFunction&lt;/code&gt;, which likely slows down Core Graphics by using a synchronous method. This is a great use of backwards compatibility: it allows almost every app to run faster on a newer OS, but still prevent issues in a few applications.&lt;/p&gt;
&lt;h2 id=&quot;what-if-my-app-is-on-the-list&quot;&gt;What if my app is on the list?&lt;/h2&gt;
&lt;p&gt;There are two reactions when someone finds their own app was fixed by Apple:&lt;/p&gt;
&lt;p&gt;Reaction 1: from the developer of Comic Life&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;@0xced Not sure if I should feel honored or ashamed to be on that list&lt;/p&gt;
&lt;p&gt;Airy (@aa10), &lt;a href=&quot;https://twitter.com/aa10/status/429902613526904832&quot;&gt;February 2, 2014&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Reaction 2: from the developer of Textual IRC&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Fuck NSBundle&lt;/p&gt;
&lt;p&gt;emsquared committed on &lt;a href=&quot;https://github.com/Codeux-Software/Textual/commit/f218b6444cefae56576c3cef0ca40b977713604a#diff-6b21bb57b24f0261b8af06bac36a52af&quot;&gt;Jul 7, 2014&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The Textual IRC example is actually very interesting, because I was able to find the commit that fixed the bug just by looking at the patch:&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://worthdoingbadly.com/assets/blog/appkitcompat/nsbundle_unload.png&quot; width=&quot;594&quot;/&gt;&lt;/p&gt;
&lt;p&gt;This patch disables &lt;code class=&quot;highlighter-rouge&quot;&gt;NSBundle.unload()&lt;/code&gt; entirely, so that code wouldn’t get unloaded. I simply searched for NSBundle in Textual’s source, and actually found the &lt;a href=&quot;https://github.com/Codeux-Software/Textual/commit/f218b6444cefae56576c3cef0ca40b977713604a#diff-6b21bb57b24f0261b8af06bac36a52af&quot;&gt;commit&lt;/a&gt; that fixed the issue.&lt;/p&gt;
&lt;p&gt;Textual’s plugin system deactivated plugins by first unloading the plugin bundle, then calling an unload handler on the plugin. Of course, with the new NSBundle implementation, the unload handler’s code would be gone after the bundle unload, and calling the handler would crash the app. The fix, of course, was to call the unload handler before deallocating the bundle.&lt;/p&gt;
&lt;p&gt;It’s fascinating to see both sides of the application compat patch: how the bug manifested in the app, how it’s worked around by Apple, and finally how it’s fixed properly by the developer (after much cursing).&lt;/p&gt;
&lt;h2 id=&quot;what-about-ios&quot;&gt;What about iOS?&lt;/h2&gt;
&lt;p&gt;Surprisingly, iOS’s UIKit has &lt;em&gt;zero&lt;/em&gt; bundle ID checks! Fixes are applied to all apps linked with old SDKs. However, 0xced found three bundle IDs in Foundation: I confirmed with&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;strings -a &quot;/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/Foundation.framework/Foundation&quot; |grep &quot;^com\.&quot;|sort
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;and found:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;com.popcap.* - &lt;a href=&quot;https://twitter.com/0xced/status/429725803858128897&quot;&gt;0xced examined this:&lt;/a&gt; it returns a random resource from &lt;code class=&quot;highlighter-rouge&quot;&gt;-[NSBundle pathForResource:ofType]&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;com.ea.realracing3&lt;/li&gt;
&lt;li&gt;com.mackiev.&lt;/li&gt;
&lt;li&gt;com.stuckpixelinc.funnypictures (&lt;a href=&quot;https://twitter.com/SlaunchaMan/status/429756162100051968&quot;&gt;@SlaunchaMan&lt;/a&gt; found that this app was the most popular app on the App Store… in 2009.)&lt;/li&gt;
&lt;/ul&gt;&lt;h2 id=&quot;how-i-extracted-the-data&quot;&gt;How I extracted the data&lt;/h2&gt;
&lt;p&gt;Extracting this data wasn’t hard: you can do this in an hour, without spending a dime.&lt;/p&gt;
&lt;p&gt;I pulled this list using static analysis, since dynamic analysis (by putting a breakpoint on &lt;code class=&quot;highlighter-rouge&quot;&gt;__CFAppVersionCheckLessThan&lt;/code&gt;) would require me to trigger every method containing a patch, which is impossible.&lt;/p&gt;
&lt;p&gt;To conduct static analysis, I needed a scriptable disassembler.&lt;/p&gt;
&lt;p&gt;I chose &lt;a href=&quot;https://www.hex-rays.com/products/ida/support/download_freeware.shtml&quot;&gt;IDA Free 7.0&lt;/a&gt;, since IDA’s the industry standard for reverse engineering, and the free version supports disassembling macOS frameworks.&lt;/p&gt;
&lt;p&gt;First, I loaded &lt;code class=&quot;highlighter-rouge&quot;&gt;/System/Library/Frameworks/AppKit.framework/Appkit&lt;/code&gt;, Foundation, and CoreFoundation into IDA Free.&lt;/p&gt;
&lt;p&gt;Next, I needed a script that:&lt;/p&gt;
&lt;ul&gt;&lt;li&gt;Looked for code that invokes &lt;code class=&quot;highlighter-rouge&quot;&gt;__CFAppVersionCheckLessThan&lt;/code&gt;. These are called “xrefs” (cross-references) in IDA.&lt;/li&gt;
&lt;li&gt;for each xref:
&lt;ul&gt;&lt;li&gt;find the argument passed into the function&lt;/li&gt;
&lt;li&gt;find one function that calls this function
&lt;ul&gt;&lt;li&gt;since we want to know, for example, what function actually uses &lt;code class=&quot;highlighter-rouge&quot;&gt;_NSBundleRunningDragonAge2Inf104DefaultValueFunction&lt;/code&gt;.&lt;/li&gt;
&lt;li&gt;(It’s &lt;code class=&quot;highlighter-rouge&quot;&gt;-[NSBundle _newImageForResourceWithProspectiveName:imageClass:]&lt;/code&gt;, by the way)&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;dump this information to IDA’s output window&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;IDA is usually scripted using IDAPython, but the free version only supports IDC, a C-like scripting language. I’ve only written one IDC script before, so I had to consult other IDC scripts, such as &lt;a href=&quot;https://github.com/gdbinit/idc-scripts/blob/master/create_and_label_sysent_entries.idc&quot;&gt;this script that also looks for xrefs&lt;/a&gt;. In addition, IDA renamed all IDC methods in IDA 6; while the older function names are still present in IDA 7, I decided to update to the newer names by checking IDA’s &lt;code class=&quot;highlighter-rouge&quot;&gt;idc.idc&lt;/code&gt; header file for the name mappings.&lt;/p&gt;
&lt;p&gt;The resulting script &lt;a href=&quot;https://github.com/zhuowei/worthdoingbadly.com/blob/master/assets/blog/appkitcompat/appkit_xrefs.idc&quot;&gt;can be found here&lt;/a&gt;. I loaded it via File-&amp;gt;Script File in IDA, and it printed out the calling functions and … most … of the bundle IDs. A few didn’t extract properly, so I fixed them by hand.&lt;/p&gt;
&lt;p&gt;I then copied the lists, and generated &lt;a href=&quot;https://github.com/zhuowei/worthdoingbadly.com/blob/master/assets/blog/appkitcompat/appkit_process.py&quot;&gt;HTML&lt;/a&gt; and &lt;a href=&quot;https://github.com/zhuowei/worthdoingbadly.com/blob/master/assets/blog/appkitcompat/appkit_processCSV.py&quot;&gt;CSV&lt;/a&gt; versions with Python scripts.&lt;/p&gt;
&lt;p&gt;Finally, to count the number of apps, I just took the CSV and&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;
&lt;div class=&quot;highlight&quot;&gt;
&lt;pre class=&quot;highlight&quot;&gt;
&lt;code&gt;cut -d , -f 1 appkit.csv|sort|uniq|wc
     299     305    7080
&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Apple &lt;a href=&quot;https://www.quora.com/Why-is-Apple-so-bad-at-making-their-operating-systems-backwards-compatible&quot;&gt;gets a bad reputation&lt;/a&gt; for their supposed lack of backwards compatibility. Nothing is further from the truth: macOS includes tweaks for specific important apps to keep them working on new OS versions. The list of 299 apps macOS checks is fascinating, and shows what Apple believes to be essential applications for the platform.&lt;/p&gt;
&lt;h2 id=&quot;what-i-learned&quot;&gt;What I learned&lt;/h2&gt;
&lt;ul&gt;&lt;li&gt;Backwards compatbility is hard.&lt;/li&gt;
&lt;li&gt;Complicated user interface elements are hard. (See: the many, many NSTableView patches, and the wide list of apps affected)&lt;/li&gt;
&lt;li&gt;It’s sometimes better to special-case some apps than to reduce performance for all apps - see the &lt;code class=&quot;highlighter-rouge&quot;&gt;_NSCGSIsSynchronousM7DefaultValueFunction&lt;/code&gt; patch above&lt;/li&gt;
&lt;li&gt;IDA Free’s scripting language, IDC, isn’t that bad, compared to IDAPython. (IDASwift wen &lt;a href=&quot;https://www.google.com/search?q=wen+eta&quot;&gt;η&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;&lt;p&gt;Thanks to @theslinker for &lt;a href=&quot;https://twitter.com/theslinker/status/995505415394750465&quot;&gt;advice on this post&lt;/a&gt;.&lt;/p&gt;
</description>
<pubDate>Mon, 21 May 2018 04:17:08 +0000</pubDate>
<dc:creator>ebcase</dc:creator>
<og:title>These 299 macOS apps are so buggy, Apple had to fix them in AppKit</og:title>
<og:description>What do Photoshop, Matlab, Panic Transmit, and Eclipse have in common? They are among the 299 apps for which macOS applies compatibillity fixes.</og:description>
<og:url>https://worthdoingbadly.com/appkitcompat/</og:url>
<og:type>article</og:type>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://worthdoingbadly.com/appkitcompat/</dc:identifier>
</item>
<item>
<title>Getting Google to ban our entire company</title>
<link>https://www.reddit.com/r/tifu/comments/8kvias/tifu_by_getting_google_to_ban_our_entire_company/</link>
<guid isPermaLink="true" >https://www.reddit.com/r/tifu/comments/8kvias/tifu_by_getting_google_to_ban_our_entire_company/</guid>
<description>&lt;h2 class=&quot;desktop-onboarding__title&quot;&gt;Sign up to get your own personalized Reddit experience!&lt;/h2&gt;&lt;p class=&quot;desktop-onboarding__description&quot;&gt;By having a Reddit account, you can subscribe, vote, and comment on all your favorite Reddit content. Sign up in just seconds.&lt;/p&gt;&lt;div class=&quot;desktop-onboarding-sign-up__form-container c-is-create&quot;&gt;&lt;div class=&quot;desktop-onboarding-sign-up__form desktop-onboarding-sign-up__form_create&quot; readability=&quot;5.2847682119205&quot;&gt;&lt;h3 class=&quot;desktop-onboarding-sign-up__form-title&quot;&gt;Enter email&lt;/h3&gt;&lt;form class=&quot;sign-up-form&quot; id=&quot;desktop-onboarding-sign-up-form&quot; autocomplete=&quot;off&quot; readability=&quot;0.43571428571429&quot;&gt;&lt;button type=&quot;submit&quot; class=&quot;c-btn c-btn-primary desktop-onboarding__next-button&quot;&gt;Next&lt;/button&gt;&lt;p class=&quot;desktop-onboarding-sign-up__form-note google-experiment&quot;&gt;or&lt;/p&gt;&lt;div class=&quot;google-button google-experiment&quot;&gt;&lt;p&gt;Sign up with Google&lt;/p&gt;&lt;/div&gt;&lt;div class=&quot;google-button__error&quot; readability=&quot;8&quot;&gt;&lt;p&gt;Sorry, we can't connect to Google right now.&lt;/p&gt;&lt;p&gt;Please try again later.&lt;/p&gt;&lt;/div&gt;&lt;p class=&quot;desktop-onboarding-sign-up__form-note&quot;&gt;&lt;span&gt;Already have an account?&lt;/span&gt;&lt;a href=&quot;https://www.reddit.com/&quot; class=&quot;desktop-onboarding-sign-up__form-toggler&quot; data-form=&quot;login&quot;&gt;Log In&lt;/a&gt;&lt;a href=&quot;javascript:%20void%200;&quot; class=&quot;skip-for-now&quot;&gt;Skip for now&lt;/a&gt;&lt;/p&gt;&lt;/form&gt;&lt;/div&gt;&lt;/div&gt;&lt;footer&gt;By signing up, you agree to our &lt;a href=&quot;https://www.reddit.com/help/useragreement/&quot;&gt;Terms&lt;/a&gt; and that you have read our &lt;a href=&quot;https://www.reddit.com/help/privacypolicy/&quot;&gt;Privacy Policy&lt;/a&gt; and &lt;a href=&quot;https://www.reddit.com/help/contentpolicy/&quot;&gt;Content Policy&lt;/a&gt;.&lt;/footer&gt;</description>
<pubDate>Mon, 21 May 2018 01:25:06 +0000</pubDate>
<dc:creator>highace</dc:creator>
<dc:language>en</dc:language>
<dc:format>text/html</dc:format>
<dc:identifier>https://www.reddit.com/over18?dest=https%3A%2F%2Fwww.reddit.com%2Fr%2Ftifu%2Fcomments%2F8kvias%2Ftifu_by_getting_google_to_ban_our_entire_company%2F</dc:identifier>
</item>
</channel>
</rss>